<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-FMD1PV6QZV"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-FMD1PV6QZV');
    </script>

    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Âà∑Âç°ÂõûÈ•ãÁÆ°ÂÆ∂">
    <meta name="theme-color" content="#F0F2F5">
        
    <meta property="og:title" content="Âà∑Âç°ÂõûÈ•ãÁÆ°ÂÆ∂ - ÊÇ®ÁöÑ‰ø°Áî®Âç°ÊúÄ‰Ω≥Âπ´Êâã">
    <meta property="og:description" content="Ëá™ÂãïË®àÁÆóÂõûÈ•ã„ÄÅÂç≥ÊôÇÈ°ØÁ§∫‰∏äÈôê„ÄÅÊîØÊè¥Êà∞Á∏æÂúñÂàÜ‰∫´„ÄÇÂø´‰æÜÁúãÁúã‰Ω†Êú¨ÊúàË≥∫‰∫ÜÂ§öÂ∞ëÂõûÈ•ãÔºÅ">
    <meta property="og:image" content="https://shawn2026-oss.github.io/shawn-2026-creditcard/icon-192.png">
    <meta property="og:url" content="https://shawn2026-oss.github.io/shawn-2026-creditcard/">
    <meta property="og:type" content="website">

    <title>Âà∑Âç°ÂõûÈ•ãÁÆ°ÂÆ∂ (V126.4 )</title>
        
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" sizes="192x192" href="icon-192.png">
    <link rel="icon" type="image/png" sizes="48x48" href="icon-48.png">
    <link rel="shortcut icon" href="icon-48.png">

    <style>
        :root { --bg-color: #F0F2F5; --text-primary: #1C1C1E; --text-secondary: #8E8E93; }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif; 
            background-color: #E0E5EC; 
            color: var(--text-primary); 
            margin: 0; 
            display: flex; 
            justify-content: center; 
            min-height: 100vh; 
            -webkit-font-smoothing: antialiased; 
            position: relative; 
        }

        .app-container { 
            width: 100%; 
            max-width: 480px; 
            background-color: var(--bg-color); 
            min-height: 100vh; 
            padding: 16px 12px; 
            padding-top: env(safe-area-inset-top, 20px); 
            padding-bottom: env(safe-area-inset-bottom, 20px); 
            box-shadow: 0 0 40px rgba(0,0,0,0.05); 
            display: flex; 
            flex-direction: column; 
            box-sizing: border-box; 
            z-index: 1; 
        }

       @media (max-width: 480px) { 
            body { background-color: var(--bg-color); } 
            .app-container { box-shadow: none; width: 100%; max-width: 100%; } 
        }

        @media (max-width: 380px) {
            .card-tile { aspect-ratio: auto; min-height: 135px; }
        }

        .detail-progress-area {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 12px;
            padding: 10px;
            margin-bottom: 12px;
            display: none; 
        }
        .dp-row { margin-bottom: 8px; }
        .dp-row:last-child { margin-bottom: 0; }
        .dp-header {
            display: flex;
            justify-content: space-between;
            font-size: 11px;
            font-weight: 700;
            color: #555;
            margin-bottom: 3px;
        }
        .dp-track {
            height: 6px;
            background: #e0e0e0;
            border-radius: 3px;
            overflow: hidden;
        }
        .dp-fill {
            height: 100%;
            background: #007AFF; 
            width: 0%;
            transition: width 0.3s;
        }
        .dp-fill.green { background: #34C759; }
        .dp-fill.orange { background: #FF9500; }
        .dp-fill.red { background: #FF3B30; }
        .dp-fill.purple { background: #AF52DE; }
        
        .threshold-warning {
            color: #FF3B30;
            font-size: 11px;
            font-weight: 700;
            margin-top: 4px;
            display: none; 
        }

        .header-top-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2px; width: 100%; }
        .author-top { font-size: 12px; font-weight: 800; color: #007AFF; letter-spacing: 0.5px; }
        .version-tag { font-size: 10px; color: #888; font-weight: 600; background: rgba(0,0,0,0.05); padding: 2px 8px; border-radius: 4px; white-space: nowrap; flex-shrink: 0; display: inline-block; min-width: 36px; text-align: center; }
        
        .location-selector {
            display: flex;
            align-items: center;
            gap: 6px;
            background: rgba(0,122,255,0.1);
            padding: 6px 12px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid rgba(0,122,255,0.2);
        }
        .location-selector:active {
            transform: scale(0.95);
            background: rgba(0,122,255,0.15);
        }
        .location-icon { font-size: 16px; }
        .location-text { font-size: 12px; font-weight: 700; color: #007AFF; }
        .location-arrow { font-size: 10px; color: #007AFF; }
        
        .exchange-rate-row {
            display: none;
            align-items: center;
            justify-content: space-between;
            margin-top: 8px;
            padding: 6px 10px;
            background: rgba(255,255,255,0.6);
            border: 1px solid rgba(0,0,0,0.05);
            border-radius: 12px;
            backdrop-filter: blur(5px);
        }
        .exchange-rate-label { font-size: 11px; font-weight: 600; color: #666; display: flex; align-items: center; gap:4px; }
        .rate-input-group { display: flex; align-items: center; gap: 6px; }
        
        .exchange-rate-input {
            width: 58px;
            padding: 2px 4px;
            border: none;
            background: transparent;
            border-bottom: 1px dashed #ccc;
            border-radius: 0;
            font-size: 12px;
            font-weight: 700;
            text-align: right;
            color: #333;
            outline: none;
        }
        .exchange-rate-input:focus { border-bottom-color: #007AFF; color: #007AFF; }
        .exchange-rate-edit-btn { background: none; border: none; color: #007AFF; font-size: 11px; cursor: pointer; padding: 0 2px; opacity: 0.7; }
        .exchange-rate-edit-btn:active { opacity: 1; transform: scale(0.95); }
        
        .header-section { margin-bottom: 12px; display: flex; justify-content: space-between; align-items: flex-end; }
        h1 { font-size: 22px; font-weight: 800; margin: 0; color: #333; letter-spacing: -0.5px; line-height: 1.2;}
        .subtitle { font-size: 11px; color: var(--text-secondary); font-weight: 500; }
        .today-date { background: rgba(0,0,0,0.05); padding: 2px 6px; border-radius: 4px; font-size: 11px; font-weight: 600; color: #555; margin-left: 5px;}
        .news-ticker { background: #FFF9C4; color: #856404; border-radius: 8px; margin-bottom: 12px; height: 36px; display: block; overflow: hidden; white-space: nowrap; position: relative; box-shadow: 0 2px 5px rgba(0,0,0,0.05); width: 100%; transform: translate3d(0,0,0); }
        .ticker-content { display: inline-block; height: 36px; line-height: 36px; padding-left: 100%; min-width: 100%; box-sizing: content-box; animation: scroll-left 15s linear infinite; will-change: transform; transform: translate3d(0, 0, 0); }
        @keyframes scroll-left { 0% { transform: translate3d(0, 0, 0); } 100% { transform: translate3d(-100%, 0, 0); } }
        
        .total-reward-card { background: #2c3e50; color: white; border-radius: 16px; padding: 16px 20px; margin-bottom: 16px; display: flex; justify-content: space-between; align-items: center; position: relative; overflow: hidden; box-shadow: 0 4px 10px rgba(44, 62, 80, 0.2); }
        .total-reward-card::after { content: ''; position: absolute; top: -50%; right: -50%; width: 150px; height: 150px; background: rgba(255,255,255,0.1); border-radius: 50%; pointer-events: none; }
        .reward-dot { width:6px; height:6px; border-radius:50%; background:rgba(255,255,255,0.35); cursor:pointer; transition:all 0.2s; }
        .reward-dot.active { width:8px; height:8px; background:rgba(255,255,255,0.9); }
        .total-info { display: flex; flex-direction: column; gap: 2px; }
        .total-reward-label { font-size: 13px; font-weight: 600; opacity: 0.9; }
        .total-reward-amount { font-size: 32px; font-weight: 800; letter-spacing: -0.5px; }
        .total-reward-breakdown { font-size: 11px; opacity: 0.8; margin-top: 4px; }
        .btn-share-result { background: rgba(255,255,255,0.2); backdrop-filter: blur(5px); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 8px 16px; border-radius: 20px; font-size: 13px; font-weight: 700; cursor: pointer; display: flex; align-items: center; gap: 6px; transition: all 0.2s; z-index: 2; }
        .btn-share-result:active { transform: scale(0.95); background: rgba(255,255,255,0.3); }
        
        #urgent-alert-area { display: none; margin-bottom: 12px; }
        .urgent-card { background: linear-gradient(135deg, #FF3B30, #FF2D55); color: white; border-radius: 12px; padding: 10px 14px; box-shadow: 0 4px 10px rgba(255, 59, 48, 0.25); animation: pulse 2s infinite; }
        .urgent-title { font-size: 13px; font-weight: 800; display: flex; align-items: center; gap: 6px; }
        .urgent-item { background: rgba(255,255,255,0.25); border-radius: 8px; padding: 6px 10px; margin-top: 6px; font-size: 12px; font-weight: 600; line-height: 1.3; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.01); } 100% { transform: scale(1); } }
        
        #card-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 20px; flex: 1; align-content: start;}
        .card-tile { border-radius: 16px; padding: 8px 12px 12px;aspect-ratio: 8.56 / 5.4; min-height: auto;display: flex; flex-direction: column; justify-content: space-between; box-shadow: 0 4px 12px rgba(0,0,0,0.1); position: relative; transition: transform 0.1s; cursor: pointer; color: white; overflow: hidden; user-select: none; -webkit-user-select: none; touch-action: pan-y; }
        .card-tile:active { transform: scale(0.97); }
        .sortable-ghost { opacity: 0.4; transform: scale(0.95); }
        .sortable-drag { cursor: grabbing; }
        
        .tile-header { display: flex; justify-content: space-between; align-items: flex-start; z-index: 2; margin-bottom: 2px;}
        .tile-name { font-size: 13px; font-weight: 800; line-height: 1.2; text-shadow: 0 1px 2px rgba(0,0,0,0.15); }
        .tile-nickname-badge { display: inline-block; font-size: 10px; font-weight: 800; background: rgba(0,0,0,0.2); color: #FFD700; padding: 2px 6px; border-radius: 4px; margin-bottom: 4px; z-index: 2; width: fit-content; }
        .tile-nickname-badge.placeholder { background: rgba(0,0,0,0.1); color: #aaa; }
        .tile-note { font-size: 10px; font-weight: 500; opacity: 0.65; margin-bottom: 4px; display: block; line-height: 1.2; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; z-index: 2; letter-spacing: -0.2px; }
        .tile-rule { font-size: 10px; font-weight: 700; background: rgba(0,0,0,0.25); padding: 2px 6px; border-radius: 4px; display: inline-block; margin-bottom: 6px; color: #FFD700; z-index: 2; }
        .rate-badge { background: rgba(255,255,255,0.3); font-size: 10px; font-weight: 800; padding: 2px 5px; border-radius: 5px; white-space: nowrap; backdrop-filter: blur(4px); margin-left: 2px; flex-shrink: 0; }
        
        .tile-body { z-index: 2; flex:1; display:flex; flex-direction:column; justify-content:center; }
        .tile-stat-group { display: flex; flex-direction: column; align-items: flex-start; justify-content: center; margin-bottom: 2px; }
        .tile-stat-main { font-size: 17px; font-weight: 800; letter-spacing: -0.5px; line-height: 1.1; }
        .tile-stat-sub { font-size: 9px; color: rgba(255,255,255,0.8); font-weight: 600; margin-top: 0; letter-spacing: 0.2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; line-height: 1.2; }
        
        .tile-stat { font-size: 20px; font-weight: 700; letter-spacing: -0.5px; margin-bottom: 2px;}
        
        .tile-earned { font-size: 11px; font-weight: 600; color: rgba(255,255,255,0.7);display: flex; align-items: center; gap: 3px;}
        .tile-earned::before { content: 'Ë≥∫'; font-size: 9px; opacity: 0.8; border: 1px solid rgba(255,255,255,0.7); padding: 0 2px; border-radius: 3px;}
        
        .tile-footer { z-index: 2; margin-top: 2px; position: relative; }
        .progress-track { background: rgba(0,0,0,0.2); height: 4px; border-radius: 2px; overflow: hidden; margin-bottom: 4px; }
        .progress-fill { height: 100%; background: rgba(255,255,255,0.95); transition: width 0.5s ease; }
        .tile-msg { font-size: 10px; font-weight: 700; opacity: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; line-height: 1.3; }
        .tile-msg.multiline { white-space: pre-line; overflow: visible; text-overflow: unset; }
       .tile-cycle-hint { font-size: 9px; color: #fff; opacity: 0.6; text-shadow: 0 1px 2px rgba(0,0,0,0.5); font-weight: 700; letter-spacing: 0.3px; position: absolute; bottom: 26px; right: 12px;}
        .tile-cycle-hint.dark-text { color: rgba(0,0,0,0.6); text-shadow: none; }
        .tile-overseas-warning { font-size: 10px; color: #FFD700; background: rgba(0,0,0,0.3); padding: 2px 6px; border-radius: 4px; margin-top: 4px; display: none; }
        
        .history-section { flex: 1; display: flex; flex-direction: column; }
        .history-title { font-size: 14px; font-weight: 700; margin-bottom: 8px; color: #555; }
        
        .settings-area { margin-top: auto; display: flex; gap: 8px; flex-direction: column; padding-top: 20px;}
        .settings-row { display: flex; gap: 8px; }
        .btn-tool { flex: 1; padding: 10px; border-radius: 10px; font-size: 12px; font-weight: 600; border: 1px solid #eee; background: white; color: #555; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 4px; box-shadow: 0 1px 3px rgba(0,0,0,0.05);}
        .btn-manage { background: #333; color: white; border: none; box-shadow: 0 2px 8px rgba(0,0,0,0.2); }
        .btn-reset-visible { width: 100%; padding: 12px; background-color: #fff5f5; border: 1px solid #ffdede; color: #FF3B30; border-radius: 12px; font-weight: 600; font-size: 12px; cursor: pointer; margin-top: 10px;}
        .btn-ig { width: 100%; padding: 12px; background: linear-gradient(45deg, #f09433 0%, #e6683c 25%, #dc2743 50%, #cc2366 75%, #bc1888 100%); color: white; border: none; border-radius: 12px; font-weight: 600; font-size: 14px; cursor: pointer; margin-top: 10px; box-shadow: 0 4px 12px rgba(220, 39, 67, 0.3); display: flex; align-items: center; justify-content: center; gap: 6px; }
        .btn-ig:active { transform: scale(0.98); }
        .details-content { display: none; background: #fff; border: 1px solid #eee; border-radius: 8px; padding: 10px; margin-top: 6px; font-size: 11px; color: #666; line-height: 1.6; }
        
        .modal { display: none; position: fixed !important; top: 0 !important; left: 0 !important; width: 100%; height: 100%; background: rgba(0,0,0,0.5); backdrop-filter: blur(3px); z-index: 10000; align-items: center; justify-content: center; }
        .modal-content { background: white; width: 85%; max-width: 320px; border-radius: 20px; padding: 20px; box-shadow: 0 25px 50px rgba(0,0,0,0.25); animation: modalPop 0.2s; display: flex; flex-direction: column; max-height: 85vh; overflow-y: auto; overflow-x: hidden; position: relative; z-index: 10001; box-sizing: border-box; }
        .modal-body-input { flex-shrink: 0; }
        
        .location-modal-content { background: white; width: 85%; max-width: 300px; border-radius: 20px; padding: 20px; box-shadow: 0 25px 50px rgba(0,0,0,0.25); animation: modalPop 0.2s; }
        .location-modal-title { font-size: 18px; font-weight: 800; color: #333; margin-bottom: 16px; text-align: center; }
        .location-option { display: flex; align-items: center; gap: 12px; padding: 14px; background: #f9f9f9; border-radius: 12px; margin-bottom: 8px; cursor: pointer; transition: all 0.2s; border: 2px solid transparent; }
        .location-option:active { transform: scale(0.98); }
        .location-option.active { background: #E3F2FD; border-color: #007AFF; }
        .location-flag { font-size: 24px; }
        .location-info { flex: 1; }
        .location-name { font-size: 15px; font-weight: 700; color: #333; }
        .location-currency { font-size: 11px; color: #888; margin-top: 2px; }
        .location-check { font-size: 18px; color: #007AFF; display: none; }
        .location-option.active .location-check { display: block; }
        
        .welcome-overlay { position: fixed !important; top: 0 !important; left: 0 !important; width: 100vw; height: 100vh; background: rgba(0,0,0,0.85); z-index: 20000; display: none; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        .welcome-content { background: white; width: 85%; max-width: 340px; border-radius: 24px; padding: 24px; text-align: center; box-shadow: 0 10px 40px rgba(0,0,0,0.5); animation: modalPop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .welcome-title { font-size: 22px; font-weight: 800; color: #333; margin-bottom: 10px; }
        .welcome-desc { font-size: 14px; color: #666; margin-bottom: 20px; line-height: 1.5; }
        .welcome-list { text-align: left; max-height: 300px; overflow-y: auto; margin-bottom: 20px; border: 1px solid #eee; border-radius: 12px; padding: 10px; }
        .welcome-item { display: flex; align-items: center; padding: 10px; border-bottom: 1px solid #f9f9f9; }
        .welcome-item:last-child { border-bottom: none; }
        .welcome-item input { width: 20px; height: 20px; margin-right: 12px; margin-bottom: 0; padding: 0;}
        .welcome-item label { margin: 0; font-size: 15px; font-weight: 600; color: #333; flex: 1; }
        .welcome-btn { background: #007AFF; color: white; border: none; padding: 14px; width: 100%; border-radius: 12px; font-size: 16px; font-weight: 700; cursor: pointer; box-shadow: 0 4px 12px rgba(0,122,255,0.3); }
        .welcome-btn:active { transform: scale(0.98); }
        
        #captureArea { position: fixed; top: -9999px; left: -9999px; z-index: -1; }
        .share-card-node { width: 320px; height: auto; background: linear-gradient(135deg, #1C1C1E, #2c3e50); color: white; border-radius: 20px; padding: 24px; box-sizing: border-box; font-family: -apple-system, sans-serif; text-align: center; box-shadow: 0 20px 40px rgba(0,0,0,0.3); margin-bottom: 20px; }
        .share-header { font-size: 14px; opacity: 0.8; letter-spacing: 1px; margin-bottom: 4px; text-transform: uppercase; }
        .share-month { font-size: 18px; font-weight: 700; margin-bottom: 20px; }
        .share-amount { font-size: 48px; font-weight: 800; margin-bottom: 20px; text-shadow: 0 2px 10px rgba(0,0,0,0.2); }
        .share-divider { height: 1px; background: rgba(255,255,255,0.1); margin: 15px 0; }
        .share-footer { font-size: 11px; opacity: 0.8; margin-top: 15px; background: rgba(255,255,255,0.1); padding: 8px; border-radius: 8px; font-weight: 600; }
        .share-list { text-align: left; margin-top: 10px; }
        .share-item { display: flex; justify-content: space-between; font-size: 13px; margin-bottom: 8px; font-weight: 500; }
        .share-item span:last-child { font-weight: 700; color: #FFD700; }
        .social-btn-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; width: 100%; margin-top: 10px; }
        .social-btn { display: flex; align-items: center; justify-content: center; gap: 6px; padding: 12px; border-radius: 12px; border: none; font-size: 13px; font-weight: 700; color: white; cursor: pointer; transition: transform 0.1s; }
        .social-btn:active { transform: scale(0.97); }
        .social-btn.instagram { background: linear-gradient(45deg, #f09433 0%, #e6683c 25%, #dc2743 50%, #cc2366 75%, #bc1888 100%); }
        .social-btn.threads { background: #000000; border: 1px solid #333; }
        .social-btn.facebook { background: #1877F2; }
        .social-btn.line { background: #06C755; }
        .social-btn.download { background: #555; grid-column: span 2; }
        
        .input-group label { display: block; font-size: 12px; font-weight: 600; color: #888; margin-bottom: 6px; margin-top: 10px; }
        input { width: 100%; padding: 10px; border: 2px solid #f0f0f0; background: #fff; border-radius: 12px; font-size: 18px; box-sizing: border-box; outline: none; font-weight: 600; color: #333; }
        .btn-group { display: flex; gap: 8px; margin-top: 20px; flex-shrink: 0; }
        .btn { flex: 1; padding: 10px; border: none; border-radius: 12px; font-size: 15px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center;}
        .btn-cancel { background: #f5f5f5; color: #333; }
        .btn-confirm { background: #007AFF; color: white; flex: 2; }
        .btn-again { background: #E3F2FD; color: #007AFF; border: 1px solid #b3e5fc; }
        #liveRewardCalc { text-align: center; font-size: 16px; color: #0056b3; font-weight: 700; margin-top: 12px; min-height: 20px; background: #E3F2FD; padding: 8px; border-radius: 8px; display: none; }
        .modal-history-section { margin-top: 15px; border-top: 2px solid #f0f0f0; padding-top: 10px; height: auto; overflow: visible; }
        .modal-history-title { font-size: 12px; font-weight: 700; color: #555; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; }
        .history-item { padding: 10px 0; border-bottom: 1px solid #f9f9f9; display: flex; justify-content: space-between; align-items: center; font-size: 12px; cursor: pointer; }
        .history-item:active { background: #f5f5f5; }
        .history-item:last-child { border-bottom: none; }
        .h-name { font-weight: 600; color: #555; min-height: 15px; }
        .h-date { font-size: 10px; color: #aaa; margin-top: 2px;}
        .h-amount { font-weight: 700; color: #333; font-size: 13px; }
        .btn-delete-single { background: none; border: none; color: #ccc; font-size: 14px; padding: 0 5px; cursor: pointer; margin-left: 8px;}
        .btn-delete-single:hover { color: #FF3B30; }
        
        #pigRichOptions, #greenCardOptions, #uniOptions, #happyOptions, #hsbcOptions, #uniOpenOptions, #richartOptions, #fubonJOptions, #jiheOptions, #kumamonOptions, #sinopacCurrencyOptions, #sinopacMitsuiOptions, #jiangOptions, #dbsEcoOptions, #sinopacJcbOptions, #laiDianOptions, #legendOptions, #cubeOptions { display: none; background: #f9f9f9; padding: 10px; border-radius: 10px; margin-top: 10px; border: 1px dashed #ddd; }
        .option-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 6px; font-size: 13px; font-weight: 600; color: #555; }
        .option-row input[type="checkbox"], .option-row input[type="radio"], .option-row input[type="number"] { margin: 0; }
        .option-row input[type="checkbox"], .option-row input[type="radio"] { width: 20px; height: 20px; }
        .option-row.read-only { opacity: 0.8; pointer-events: none; }
        .option-row.read-only input { opacity: 0.6; }
        .option-row.expired { opacity: 0.5; pointer-events: none; background: #eee; padding: 4px; border-radius: 4px; }
        .option-row.overseas-disabled { opacity: 0.4; pointer-events: none; }
        .option-row.overseas-disabled::after { content: ' (ÂúãÂ§ñÁÑ°Âä†Á¢º)'; color: #FF3B30; font-size: 10px; }
        
        /* UniOpen ÂìÅÁâåÂàÜÈ°ûÊäòÁñäÊ®£Âºè */
        .brand-category { margin-bottom: 10px; }
        .brand-category-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 8px 10px; 
            background: #e8f4fc; 
            border-radius: 8px; 
            cursor: pointer; 
            font-size: 12px; 
            font-weight: 700; 
            color: #007AFF;
            transition: background 0.2s;
        }
        .brand-category-header:active { background: #d0e8f8; }
        .brand-category-header .arrow { transition: transform 0.2s; }
        .brand-category-header.collapsed .arrow { transform: rotate(-90deg); }
        .brand-category-content { display: block; margin-top: 6px; }
        .brand-category-content.collapsed { display: none; }
        
        .brand-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px; margin-top: 6px; }
        .brand-btn { border: 1px solid #ddd; background: white; border-radius: 6px; padding: 6px 2px; font-size: 11px; color: #666; text-align: center; cursor: pointer; transition: 0.2s; font-weight: 600; display: flex; align-items: center; justify-content: center; }
        .brand-btn.active { background: #FF9800; color: white; border-color: #F57C00; box-shadow: 0 2px 4px rgba(255, 152, 0, 0.3); }
        .manage-item { display: flex; align-items: center; justify-content: space-between; padding: 16px 12px; border-bottom: 1px solid #f0f0f0; background: #fff; cursor: pointer; transition: background 0.2s; }
        .manage-item:active { background: #f9f9f9; }
        .manage-info { display: flex; flex-direction: column; gap: 4px; }
        .manage-name { font-size: 15px; font-weight: 700; color: #333; }
        .manage-desc { font-size: 12px; color: #999; }
        .switch { position: relative; display: inline-block; width: 44px; height: 24px; flex-shrink: 0; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 2px; bottom: 2px; background-color: white; transition: .4s; border-radius: 50%; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        input:checked + .slider { background-color: #34C759; }
        input:checked + .slider:before { transform: translateX(20px); }
        .btn-card-setting { background: #f0f0f0; border: none; border-radius: 50%; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; font-size: 16px; cursor: pointer; margin-right: 12px; color: #555; }
        .btn-card-setting:hover { background: #e0e0e0; }
        .happy-dashboard { background: transparent; border: none; padding: 0; margin-top: 10px; display: none; }
        .dash-row { margin-bottom: 8px; }
        .dash-label { font-size: 12px; font-weight: 700; color: #555; display: flex; justify-content: space-between; margin-bottom: 2px;}
        .dash-bar-bg { background: #eee; height: 6px; border-radius: 3px; overflow: hidden; }
        .dash-bar-fill { height: 100%; background: #4cd964; transition: width 0.3s; }
        .dash-bar-fill.danger { background: #ff3b30; }
        .manage-tools { margin-bottom: 12px; padding-bottom: 12px; border-bottom: 1px solid #eee; }
        .tools-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .btn-tool-small { background: #f0f0f0; border: 1px solid #e0e0e0; padding: 6px 12px; border-radius: 8px; font-size: 12px; font-weight: 600; color: #555; cursor: pointer; }
        .btn-tool-small:active { background: #ddd; }
        .scene-container { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 4px; white-space: nowrap; -webkit-overflow-scrolling: touch; }
        .btn-scene { padding: 6px 12px; background: #e8f5e9; color: #2e7d32; border: 1px solid #c8e6c9; border-radius: 20px; font-size: 12px; font-weight: 700; cursor: pointer; display: flex; align-items: center; gap: 4px; flex-shrink: 0;}
        .btn-scene:active { transform: scale(0.95); }
        .btn-scene-del { width: 16px; height: 16px; background: rgba(0,0,0,0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 10px; margin-left: 4px; color: #2e7d32; }
        
        .manage-search-container { position: sticky; top: 0; background: white; z-index: 10; padding-bottom: 12px; margin-bottom: 8px; border-bottom: 1px solid #f0f0f0; }
        .manage-search-wrapper { position: relative; width: 100%; }
        .manage-search-input { width: 100%; padding: 12px 40px 12px 12px; border-radius: 12px; border: 1px solid #e0e0e0; background: #f9f9f9; font-size: 15px; font-weight: 600; color: #333; transition: all 0.2s; box-sizing: border-box; outline: none; }
        .manage-search-input:focus { background: white; border-color: #007AFF; box-shadow: 0 0 0 3px rgba(0,122,255,0.1); }
        .btn-search-clear { position: absolute; right: 10px; top: 50%; transform: translateY(-50%); width: 24px; height: 24px; background: #ccc; color: white; border-radius: 50%; border: none; font-size: 14px; display: none; align-items: center; justify-content: center; cursor: pointer; }
        .manage-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; padding-bottom: 20px; }
        .manage-card-btn { position: relative; border-radius: 16px; padding: 12px; background: #f5f5f5; border: 2px solid transparent; text-align: left; transition: all 0.2s cubic-bezier(0.25, 0.8, 0.25, 1); cursor: pointer; display: flex; flex-direction: column; justify-content: space-between; min-height: 80px; user-select: none; -webkit-tap-highlight-color: transparent; opacity: 0.7; filter: grayscale(100%); }
        .manage-card-btn.active { opacity: 1; filter: grayscale(0%); background: white; border-color: #007AFF; box-shadow: 0 4px 12px rgba(0,0,0,0.08); transform: translateY(-1px); }
        .manage-card-btn:active { transform: scale(0.96); }
        .m-card-name { font-size: 14px; font-weight: 800; color: #333; line-height: 1.3; margin-bottom: 4px; padding-right: 20px; }
        .m-card-nick { font-size: 11px; color: #888; font-weight: 500; }
        .m-check-mark { position: absolute; top: 10px; right: 10px; width: 18px; height: 18px; background: #007AFF; color: white; border-radius: 50%; font-size: 12px; display: none; align-items: center; justify-content: center; font-weight: bold; box-shadow: 0 2px 4px rgba(0,0,0,0.2); z-index: 2; }
        .manage-card-btn.active .m-check-mark { display: flex; }
        .m-setting-btn { position: absolute; bottom: 8px; right: 8px; width: 28px; height: 28px; border-radius: 50%; background: rgba(0,0,0,0.05); color: #666; border: 1px solid rgba(0,0,0,0.05); display: flex; align-items: center; justify-content: center; font-size: 14px; z-index: 3; transition: all 0.2s; }
        .manage-card-btn.active .m-setting-btn { background: rgba(0,0,0,0.03); color: #333; }
        .m-setting-btn:active { background: #e0e0e0; transform: scale(0.9); }
        @keyframes modalPop { 0% { transform: scale(0.9); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
    </style>
</head>
  <body>
    <div id="locationModal" class="modal" onclick="if(event.target===this) document.getElementById('locationModal').style.display='none'">
        <div class="location-modal-content">
            <div class="location-modal-title">ÈÅ∏ÊìáÊâÄÂú®Âú∞</div>
            <div class="location-option active" onclick="selectLocation('TW', 'üáπüáº', 'ÊàëÂú®Âè∞ÁÅ£', 'TWD', 1)">
                <span class="location-flag">üáπüáº</span>
                <div class="location-info">
                    <div class="location-name">ÊàëÂú®Âè∞ÁÅ£</div>
                    <div class="location-currency">TWD (Âè∞Âπ£)</div>
                </div>
                <span class="location-check">‚úì</span>
            </div>
            <div class="location-option" onclick="selectLocation('JP', 'üáØüáµ', 'ÊàëÂú®Êó•Êú¨', 'JPY', null)">
                <span class="location-flag">üáØüáµ</span>
                <div class="location-info">
                    <div class="location-name">ÊàëÂú®Êó•Êú¨</div>
                    <div class="location-currency">JPY (Êó•Âúì)</div>
                </div>
                <span class="location-check">‚úì</span>
            </div>
            <div class="location-option" onclick="selectLocation('KR', 'üá∞üá∑', 'ÊàëÂú®ÈüìÂúã', 'KRW', null)">
                <span class="location-flag">üá∞üá∑</span>
                <div class="location-info">
                    <div class="location-name">ÊàëÂú®ÈüìÂúã</div>
                    <div class="location-currency">KRW (ÈüìÂÖÉ)</div>
                </div>
                <span class="location-check">‚úì</span>
            </div>
            <div class="location-option" onclick="selectLocation('US', 'üá∫üá∏', 'ÊàëÂú®ÁæéÂúã', 'USD', null)">
                <span class="location-flag">üá∫üá∏</span>
                <div class="location-info">
                    <div class="location-name">ÊàëÂú®ÁæéÂúã</div>
                    <div class="location-currency">USD (ÁæéÂÖÉ)</div>
                </div>
                <span class="location-check">‚úì</span>
            </div>
            <div class="location-option" onclick="selectLocation('TH', 'üáπüá≠', 'ÊàëÂú®Ê≥∞Âúã', 'THB', null)">
                <span class="location-flag">üáπüá≠</span>
                <div class="location-info">
                    <div class="location-name">ÊàëÂú®Ê≥∞Âúã</div>
                    <div class="location-currency">THB (Ê≥∞Èäñ)</div>
                </div>
                <span class="location-check">‚úì</span>
            </div>
        </div>
    </div>
    
    <div id="line-tip-bar">
        <span id="line-tip-text">‚ö†Ô∏è ÂÅµÊ∏¨‰∏≠...</span>
        <button onclick="this.parentElement.style.display='none'">‚úï</button>
    </div>

    <div id="safari-install-bubble" onclick="closeBubble()">
        <div class="bubble-content">
            <span class="bubble-text">Ë´ãÈªûÊìä‰∏ãÊñπ„Äå...„ÄçÂæåÈªû„ÄåÂàÜ‰∫´„ÄçÂÜç‰∏ãÊªëÂä†ÂÖ•„Äå‰∏ªÁï´Èù¢„Äçüëá</span>
            <div class="bubble-arrow"></div>
        </div>
        <button class="bubble-close">‚úï</button>
    </div>

    <div id="android-install-bar">
        <div class="install-info">
            <div class="install-icon">üí≥</div>
            <div class="install-text">
                <div style="font-weight:800; font-size:14px;">ÂÆâË£ù„ÄåÂà∑Âç°ÂõûÈ•ãÁÆ°ÂÆ∂„Äç</div>
                <div style="font-size:11px; opacity:0.8;">ÂÖ®Ëû¢ÂπïÂü∑Ë°åÔºåË≥áÊñô‰∏çÈÅ∫Â§±</div>
            </div>
        </div>
        <div style="display:flex; align-items:center; gap:10px;">
            <button class="btn-install-trigger" onclick="triggerAndroidInstall()">üì≤ ÂÆâË£ù</button>
            <button class="btn-close-install" onclick="closeAndroidBar()">‚úï</button>
        </div>
    </div>

    <style>
        #line-tip-bar, #safari-install-bubble, #android-install-bar { display: none; }
        #line-tip-bar {
            background: #FFF9C4; color: #856404;
            padding: 12px 15px; font-size: 13px; font-weight: 600;
            position: fixed; top: 0; left: 0; width: 100%;
            z-index: 99999; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            justify-content: space-between; align-items: center; box-sizing: border-box;
            line-height: 1.4;
        }
        #line-tip-bar strong { color: #d32f2f; text-decoration: underline; }
        #line-tip-bar button { background: none; border: none; font-size: 18px; color: #856404; cursor: pointer; padding: 0 0 0 10px; flex-shrink: 0; }
        #safari-install-bubble {
            position: fixed; 
            bottom: calc(20px + env(safe-area-inset-bottom)); 
            right: 4px;
            left: auto; 
            transform: none;
            max-width: 220px;
            z-index: 10000; animation: bounce 2s infinite;
            cursor: pointer;
            width: fit-content;
        }
        .bubble-content {
            background: #007AFF; color: white; padding: 10px 16px; border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,122,255,0.4); position: relative; text-align: center; 
            min-width: 240px; 
        }
        .bubble-text { font-size: 13px; line-height: 1.4; display: block; pointer-events: none; font-weight: 600; } 
        .bubble-arrow {
            position: absolute; bottom: -8px; 
          right: 24px; left: auto; transform: none;
            width: 0; height: 0; border-left: 8px solid transparent; border-right: 8px solid transparent; border-top: 8px solid #007AFF;
        }
        .bubble-close {
            position: absolute; top: -8px; right: -8px; background: #ccc; color: white; border: 2px solid white;
            border-radius: 50%; width: 20px; height: 20px; font-size: 12px; cursor: pointer; display: flex; align-items: center; justify-content: center;
            pointer-events: auto;
        }
        #android-install-bar {
            position: fixed; bottom: 20px; left: 5%; width: 90%;
            background: #222; color: white; border-radius: 16px;
            padding: 12px 16px; box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            z-index: 10000; display: none; justify-content: space-between; align-items: center;
            box-sizing: border-box; animation: slideUp 0.5s ease-out;
        }
        .install-info { display: flex; align-items: center; gap: 12px; }
        .install-icon { width: 40px; height: 40px; background: linear-gradient(135deg, #00C9FF, #92FE9D); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 20px; }
        .btn-install-trigger {
            background: #007AFF; color: white; border: none; padding: 8px 16px; border-radius: 20px;
            font-weight: 700; font-size: 13px; cursor: pointer; white-space: nowrap;
        }
        .btn-close-install { background: rgba(255,255,255,0.2); border: none; width: 24px; height: 24px; border-radius: 50%; color: #aaa; font-size: 12px; cursor: pointer; display: flex; align-items: center; justify-content: center; }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% {transform: translateX(-50%) translateY(0);}
            40% {transform: translateX(-50%) translateY(-10px);}
            60% {transform: translateX(-50%) translateY(-5px);}
        }
        @keyframes slideUp { from { transform: translateY(100px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    </style>

    <script>
        let deferredPrompt;
        (function() {
            var ua = navigator.userAgent.toLowerCase();
            var isIOS = /iphone|ipad|ipod/.test(ua);
            var isChromeIOS = ua.indexOf('crios') > -1;
            var isFirefoxIOS = ua.indexOf('fxios') > -1;
            var isInAppKeywords = ua.indexOf('line') > -1 || ua.indexOf('fban') > -1 || ua.indexOf('fbav') > -1 || ua.indexOf('instagram') > -1 || ua.indexOf('threads') > -1;
            var isRealSafari = isIOS && ua.indexOf('safari') > -1 && !isChromeIOS && !isFirefoxIOS && !isInAppKeywords;
            var isStandalone = window.navigator.standalone === true || window.matchMedia('(display-mode: standalone)').matches;

            if (isIOS && !isStandalone) {
                if (!isRealSafari) {
                    // Èùû Safari (Line Á≠â)
                    var tipBar = document.getElementById('line-tip-bar');
                    var tipText = document.getElementById('line-tip-text');
                    if(tipBar && tipText) {
                          tipText.innerHTML = isInAppKeywords ? 
                              '‚ö†Ô∏è ÂÖßÂª∫ÁÄèË¶ΩÂô®ÁÑ°Ê≥ïÂ≠òÊ™îÔºåË´ãÈªûÊìä<strong>ËßíËêΩÈÅ∏ÂñÆ„Äå...„Äç</strong>,ÈÅ∏Êìá<strong>„ÄåÂú® Chrome/Safari ÈñãÂïü„Äç</strong>' : 
                              '‚ö†Ô∏è Ë´ãÂãôÂøÖ‰ΩøÁî® <strong>Safari</strong> ÈñãÂïüÊâçÊúâÂ≠òÊ™îÂäüËÉΩ';
                          tipBar.style.display = 'flex';
                          var appContainer = document.querySelector('.app-container');
                          if(appContainer) appContainer.style.marginTop = '45px';
                    }
                } else {
                    // ÊòØ Safari ‰ΩÜÊú™ÂÆâË£ù
                    setTimeout(function() {
                        var bubble = document.getElementById('safari-install-bubble');
                        if(bubble) bubble.style.display = 'block';
                    }, 1500);
                }
            }
        })();

        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            document.getElementById('android-install-bar').style.display = 'flex';
        });

        async function triggerAndroidInstall() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                deferredPrompt = null;
                document.getElementById('android-install-bar').style.display = 'none';
            }
        }
        function closeBubble() { document.getElementById('safari-install-bubble').style.display = 'none'; }
        function closeAndroidBar() { document.getElementById('android-install-bar').style.display = 'none'; }
    </script>

    <div id="welcomeModal" class="welcome-overlay">
        <div class="welcome-content">
            <div class="welcome-title">üëã Ê≠°Ëøé‰ΩøÁî®ÂõûÈ•ãÁÆ°ÂÆ∂</div>
            <div class="welcome-desc">ÁÇ∫‰∫ÜÊèê‰æõÊúÄÁ≤æÊ∫ñÁöÑÊúçÂãô<br>Ë´ãÂãæÈÅ∏ÊÇ®<b>ÁõÆÂâçÊåÅÊúâ</b>ÁöÑÂç°ÁâáÔºö</div>
            <div class="welcome-list" id="welcomeList"></div>
            <button class="welcome-btn" onclick="saveWelcomeSettings()">ÈñãÂßã‰ΩøÁî® üöÄ</button>
        </div>
    </div>
    <div class="app-container">
        <div class="header-top-row">
            <div class="author-top">Designed by Pocket Lab</div>
            <div class="version-tag">V126.4 </div>
        </div>
        <div class="header-section">
            <h1>Âà∑Âç°ÂõûÈ•ãÁÆ°ÂÆ∂</h1>
            <div class="location-selector" onclick="openLocationModal()">
                <span class="location-icon" id="currentLocationFlag">üáπüáº</span>
                <span class="location-text" id="currentLocationName">ÊàëÂú®Âè∞ÁÅ£</span>
                <span class="location-arrow">‚ñº</span>
            </div>
        </div>
        
        <div class="exchange-rate-row" id="exchangeRateRow" style="width: fit-content; margin-left: auto;">
            <span class="exchange-rate-label">üìä ÂåØÁéá <span id="currencySymbolInRate"></span> ‚Üí TWD</span>
            <div class="rate-input-group">
                <input type="number" id="exchangeRateInput" class="exchange-rate-input" step="0.01" oninput="updateTWDPreview()">
                <button class="exchange-rate-edit-btn" onclick="toggleExchangeRateEdit()">‚úèÔ∏è</button>
                <button class="exchange-rate-edit-btn" id="refreshRateBtn" onclick="refreshExchangeRates()" title="ÈáçÊñ∞ÊäìÂèñÂåØÁéá" style="margin-left:-4px;">üîÑ</button>
            </div>
        </div>

        <div class="subtitle"><span class="today-date" id="dateDisplay"></span></div>
        
        <div class="news-ticker">
            <div class="ticker-content" id="news-text">üéâ V126.2‰øÆÂæ©ÔºöÂÇô‰ªΩÈÇÑÂéüÁ¥ÄÈåÑÈÅ∫Â§±„ÄÅUniOpen ÂÆåÊï¥ÂìÅÁâåÊ∏ÖÂñÆ„ÄÅJCB Â∞ÅÈ†ÇË®àÁÆóÔºÅ</div>
        </div>
        
        <div id="urgent-alert-area"><div class="urgent-card"><div class="urgent-title">üö® ‰ªªÂãôÂà∞ÊúüË≠¶Â†±</div><div id="urgent-list"></div></div></div>
        
        <div id="rewardCarouselWrap" style="position:relative; overflow:hidden; touch-action:pan-y; margin-bottom:16px;">
            <div id="rewardCarouselTrack" style="display:flex; transition:transform 0.3s ease; width:300%; transform:translateX(-33.333%);">
                <!-- Â∑¶ÔºöÊ≠∑Âè≤Êúà‰ªΩ -->
                <div class="total-reward-card" style="flex:0 0 33.333%; box-sizing:border-box; min-width:0; margin-bottom:0; justify-content:center;">
                    <div class="total-info" style="align-items:center;">
                        <select id="historyMonthSel" onchange="onMonthSelChange()" style="background:rgba(255,255,255,0.15); color:white; border:1px solid rgba(255,255,255,0.3); border-radius:8px; padding:4px 10px; font-size:14px; font-weight:600; margin-bottom:2px; cursor:pointer; text-align:center;"></select>
                        <span class="total-reward-amount" id="monthRewardDisplay">$0</span>
                        <span id="monthRewardMiles" style="font-size:14px; opacity:0.7;"></span>
                    </div>
                    <span style="position:absolute; right:12px; top:50%; transform:translateY(-50%); font-size:20px; opacity:0.4; cursor:pointer;" onclick="goRewardPage(1)">‚ñ∂</span>
                </div>
                <!-- ‰∏≠ÔºöÁï∂Êúü -->
                <div class="total-reward-card" style="flex:0 0 33.333%; box-sizing:border-box; min-width:0; margin-bottom:0;">
                    <span style="position:absolute; left:12px; top:50%; transform:translateY(-50%); font-size:20px; opacity:0.4; cursor:pointer;" onclick="goRewardPage(0)">‚óÄ</span>
                    <div class="total-info">
                        <span class="total-reward-label">Áï∂ÊúüÁ¥ØÁ©çÂõûÈ•ãÈ†ê‰º∞</span>
                        <span class="total-reward-amount" id="totalRewardDisplay">$0</span>
                        <span class="total-reward-breakdown" id="totalRewardBreakdown"></span>
                    </div>
                    <button class="btn-share-result" onclick="openShareModal()">üì© Êõ¨Êà∞Á∏æ</button>
                    <span style="position:absolute; right:12px; top:50%; transform:translateY(-50%); font-size:20px; opacity:0.4; cursor:pointer;" onclick="goRewardPage(2)">‚ñ∂</span>
                </div>
                <!-- Âè≥ÔºöÂπ¥Â∫¶Á∏ΩÂõûÈ•ã -->
                <div class="total-reward-card" style="flex:0 0 33.333%; box-sizing:border-box; min-width:0; margin-bottom:0; justify-content:center;">
                    <span style="position:absolute; left:12px; top:50%; transform:translateY(-50%); font-size:20px; opacity:0.4; cursor:pointer;" onclick="goRewardPage(1)">‚óÄ</span>
                    <div class="total-info" style="align-items:center;">
                        <select id="historyYearSel" onchange="onYearSelChange()" style="background:rgba(255,255,255,0.15); color:white; border:1px solid rgba(255,255,255,0.3); border-radius:8px; padding:4px 10px; font-size:14px; font-weight:600; margin-bottom:2px; cursor:pointer; text-align:center;"></select>
                        <span class="total-reward-amount" id="yearRewardDisplay">$0</span>
                        <span id="yearRewardMiles" style="font-size:14px; opacity:0.7;"></span>
                    </div>
                </div>
            </div>
            <!-- ÂÖ®Â±ÄÂúìÈªû -->
            <div id="rewardDots" style="position:absolute; bottom:6px; left:0; right:0; display:flex; justify-content:center; gap:6px; z-index:3; pointer-events:none;">
                <span class="reward-dot" onclick="goRewardPage(0)" style="pointer-events:auto;"></span>
                <span class="reward-dot active" onclick="goRewardPage(1)" style="pointer-events:auto;"></span>
                <span class="reward-dot" onclick="goRewardPage(2)" style="pointer-events:auto;"></span>
            </div>
        </div>
        
        <div id="card-grid"></div>
        
        <div style="flex:1;"></div>
        
        <div class="settings-area">
            <div class="settings-row">
                <button class="btn-tool btn-manage" onclick="openManageModal()">üí≥ ÁÆ°ÁêÜÊàëÁöÑÂç°Áâá</button>
            </div>
             <div class="settings-row">
                <button class="btn-tool" onclick="exportData()">üíæ ÂÇô‰ªΩÊ™îÊ°à</button>
                <button class="btn-tool" onclick="triggerImport()">üì• ËÆÄÊ™îÈÇÑÂéü</button>
                <input type="file" id="fileInput" style="display:none" accept=".json, .txt" onchange="importFile(this)">
            </div>
            <button class="btn-ig" onclick="window.open('https://www.instagram.com/pocket_lab_tw', '_blank')">
              üì∏ Ê≠°ËøéËøΩËπ§Âè£Ë¢ãÂØ¶È©óÂÆ§
            </button>
            <button class="btn-reset-visible" onclick="resetAllData()">üóëÔ∏è ÈáçÁΩÆÊâÄÊúâË≥áÊñô</button>
        </div>
    
        <div style="text-align:center; font-size:11px; color:#555; background:#ebebeb; padding:10px; border-radius:8px; margin-top:15px; margin-bottom:10px; line-height:1.4; font-weight:600;">
            ‚ö†Ô∏è Êú¨Â∑•ÂÖ∑ÂÉÖÂçîÂä©Áî®Êà∂Áõ£ÊéßÂà∑Âç°ÈÄ≤Â∫¶<br>ÂØ¶ÈöõÂÖ•Â∏≥ÈúÄ‰ª•ÂêÑÂÆ∂ÈäÄË°åÂà§ÂÆöÁÇ∫‰∏ª
        </div>
        <div style="height:20px;"></div>
    </div>

    <div id="sharePreviewModal" class="modal" onclick="if(event.target===this) document.getElementById('sharePreviewModal').style.display='none'">
        <div class="modal-content" style="background:transparent; box-shadow:none; align-items:center; padding:0; width:100%; max-width:340px;">
            <div id="captureNode" class="share-card-node">
                <div class="share-header">Monthly Rewards</div>
                <div class="share-month" id="shareCardMonth">Êà∞Á∏æÂ†±Âëä</div>
                <div class="share-amount" id="shareCardAmount">$0</div>
                <div class="share-divider"></div>
                <div class="share-list" id="shareCardList"></div>
                <div class="share-footer">
                    <div>Generated by Âà∑Âç°ÂõûÈ•ãÁÆ°ÂÆ∂</div>
                </div>
            </div>

            <div style="background:white; border-radius:20px; padding:15px; width:100%; box-sizing:border-box; box-shadow: 0 10px 30px rgba(0,0,0,0.3); margin-top:10px;">
                <div style="text-align:center; font-size:12px; color:#333; margin-bottom:12px; font-weight:700;">‚ú® Ë´ãÈÅ∏ÊìáÂàÜ‰∫´ÊñπÂºè</div>
                <div class="social-btn-grid">
                    <button class="social-btn instagram" onclick="shareToIG()">üì∏ Instagram</button>
                    <button class="social-btn facebook" onclick="shareToFB()">üìò Facebook</button>
                    <button class="social-btn threads" onclick="shareToThreads()">üßµ Threads</button>
                    <button class="social-btn line" onclick="shareToLine()">üü¢ LINE</button>
                    <button class="social-btn download" onclick="downloadShareImage()">üì• ÂÉÖ‰øùÂ≠òÂúñÁâá</button>
                </div>
                <div style="text-align:center; font-size:10px; color:#999; margin-top:10px; line-height:1.4;">
                    (FB/IG ÁÇ∫ÂÇ≥ÂúñÊ®°ÂºèÔºõLINE/Threads ÁÇ∫ÈÄ£ÁµêÊ®°Âºè)
                </div>
            </div>
            <button style="margin-top:15px; background:none; border:none; color:white; font-size:14px; text-decoration:underline; cursor:pointer;" onclick="document.getElementById('sharePreviewModal').style.display='none'">ÈóúÈñâË¶ñÁ™ó</button>
        </div>
    </div>

    <div id="transactionModal" class="modal" onclick="if(event.target===this) closeModal()">
        <div class="modal-content">
            <div class="modal-body-input">
                <h2 id="modalTitle" style="margin: 0 0 4px 0; font-size: 18px; font-weight: 800; color:#333;"></h2>
                <div style="font-size:12px; color:#888; margin-bottom:10px; font-weight: 500;" id="modalSubtitle"></div>
                
                <div id="modalParkingInfo" style="background:#FFF9C4; color:#856404; padding:10px; border-radius:10px; font-size:12px; margin-bottom:12px; border-left:4px solid #FFC107; display:none; line-height:1.5;"></div>
                
                <div id="detailProgressArea" class="detail-progress-area"></div>
                
                <div id="uniUpSuggestion" style="background:#E3F2FD; color:#0D47A1; padding:10px; border-radius:10px; font-size:12px; margin-bottom:12px; border-left:4px solid #2196F3; display:none; line-height:1.5;"></div>
                
                <input type="hidden" id="cardIdInput"> 
                
                <div id="legendOptions">
                    <div class="option-row read-only"><label>üî∞ ‰∏ÄËà¨Ê∂àË≤ª 1.2% (ÁÑ°‰∏äÈôê)</label><input type="checkbox" checked disabled></div>
                    <div class="option-row" style="flex-direction:column; align-items:flex-start; gap:0;">
                        <div style="display:flex; justify-content:space-between; width:100%; align-items:center;">
                             <label for="checkLegendBonus">üî• Á≤æÈÅ∏ÈÄöË∑Ø +8.8% (Âà∑$11,363Â∞ÅÈ†Ç)</label>
                             <input type="checkbox" id="checkLegendBonus" onchange="updateRewardPreview()">
                        </div>
                        <button onclick="toggleLegendDetails()" style="border:none; background:none; color:#007AFF; font-size:11px; cursor:pointer; padding:2px 0 6px 0;">üîΩ Êü•ÁúãÊåáÂÆöÈÄöË∑Ø (Â®õÊ®Ç/ÂΩ±Èü≥/ÁîüÊ¥ª)</button>
                        <div id="legendDetails" class="details-content">
                            <b>(1) ÊåáÂÆöÂ®õÊ®ÇÂπ≥Âè∞Ôºö</b><br>
                            App Store, Google Play, Garena, GASH, MyCard, Nintendo, PlayStation, Steam, Acer, ASUS, Logitech, NOVA...<br>
                            <b>(2) ÂΩ±Èü≥‰∏≤ÊµÅÂπ≥Âè∞Ôºö</b><br>
                            YouTube Premium, Netflix, Disney+, Spotify, Twitch, ÊÑõÂ•áËóù, Catchplay, KKBOX, KKTV, LiTV...<br>
                            <b>(3) ÁîüÊ¥ªË£úÁµ¶ÈÄöË∑ØÔºö</b><br>
                            LINE Pay, UberEats, foodpanda, È∫•Áï∂Âãû, ËÇØÂæ∑Âü∫, Êë©ÊñØÊº¢Â†°, 21‰∏ñÁ¥Ä, ÁæéÂ¢®ÁÇ∏Èõû, ÊãøÂù°Èáå, Pizzahut, Ëù¶ÁöÆ...
                        </div>
                    </div>
                </div>

                <div id="cubeOptions">
                    <div class="option-row" style="border-bottom:1px solid #eee; padding-bottom:10px; margin-bottom:10px;">
                        <span style="font-weight:700; color:#333;">üí≥ ÈÅ∏ÊìáÁ≠âÁ¥ö (Ëá™ÂãïË®òÊÜ∂)Ôºö</span>
                        <div style="display:flex; gap:15px; margin-top:8px;">
                            <label style="display:flex; align-items:center; font-weight:normal; font-size:13px;"><input type="radio" name="cubeLevel" value="lv1" onchange="saveCubeSettings()"> LV1 2%</label>
                            <label style="display:flex; align-items:center; font-weight:normal; font-size:13px;"><input type="radio" name="cubeLevel" value="lv2" onchange="saveCubeSettings()"> LV2 3%</label>
                            <label style="display:flex; align-items:center; font-weight:normal; font-size:13px;"><input type="radio" name="cubeLevel" value="lv3" onchange="saveCubeSettings()"> LV3 3.3%</label>
                        </div>
                    </div>
                    <div class="option-row"><label for="rbCubeGeneral">üî∞ ‰∏ÄËà¨Ê∂àË≤ª (0.3%)</label><input type="radio" name="cubeMode" id="rbCubeGeneral" value="general" checked onchange="updateRewardPreview()"></div>

                    <div class="option-row" style="flex-direction:column; align-items:flex-start; gap:0; border-top:1px dashed #ddd; padding-top:6px; margin-top:4px;">
                        <div style="display:flex; justify-content:space-between; width:100%; align-items:center;">
                            <label for="rbCubeDigital">üñ•Ô∏è Áé©Êï∏‰Ωç (‰æùÁ≠âÁ¥ö)</label>
                            <input type="radio" name="cubeMode" id="rbCubeDigital" value="digital" onchange="updateRewardPreview()">
                        </div>
                        <button onclick="toggleCubeDetails('cubeDigitalDetails')" style="border:none; background:none; color:#007AFF; font-size:11px; cursor:pointer; padding:2px 0 4px 0;">‚ñ∏ Êü•ÁúãÊåáÂÆöÈÄöË∑Ø</button>
                        <div id="cubeDigitalDetails" class="details-content">
                            <b>Á∂≤Ë≥ºÂπ≥Âè∞Ôºö</b>Ëù¶ÁöÆË≥ºÁâ©„ÄÅmomoË≥ºÁâ©Á∂≤„ÄÅPChome 24hË≥ºÁâ© (‰∏çÂê´ÂÑ≤ÂÄºÂèäÈõªÂ≠êÁ•®Âà∏)„ÄÅÂ∞èÊ®πË≥º (‰∏çÂê´ÈõªÂ≠êÁ•®Âà∏)<br>
                            <b>ÂúãÈöõÈõªÂïÜÔºö</b>CoupangÈÖ∑Êæé(Âè∞ÁÅ£)„ÄÅÊ∑òÂØ∂„ÄÅÂ§©Ë≤ì<br>
                            <b>Êï∏‰Ωç/‰∏≤ÊµÅÂπ≥Âè∞Ôºö</b>Apple Â™íÈ´îÊúçÂãô„ÄÅGoogle Play„ÄÅDisney+„ÄÅNetflix„ÄÅSpotify„ÄÅYouTube Premium„ÄÅMax<br>
                            <b>AIÂ∑•ÂÖ∑Ôºö</b>ChatGPT„ÄÅCanva„ÄÅClaude„ÄÅCursor„ÄÅDuolingo„ÄÅGamma„ÄÅGemini„ÄÅNotion„ÄÅPerplexity„ÄÅSpeak
                        </div>
                    </div>

                    <div class="option-row" style="flex-direction:column; align-items:flex-start; gap:0;">
                        <div style="display:flex; justify-content:space-between; width:100%; align-items:center;">
                            <label for="rbCubeDining">üçΩÔ∏è Ê®ÇÈ•óË≥º (‰æùÁ≠âÁ¥ö)</label>
                            <input type="radio" name="cubeMode" id="rbCubeDining" value="dining" onchange="updateRewardPreview()">
                        </div>
                        <button onclick="toggleCubeDetails('cubeDiningDetails')" style="border:none; background:none; color:#007AFF; font-size:11px; cursor:pointer; padding:2px 0 4px 0;">‚ñ∏ Êü•ÁúãÊåáÂÆöÈÄöË∑Ø</button>
                        <div id="cubeDiningDetails" class="details-content">
                            <b>ÂúãÂÖßÁôæË≤®Ôºö</b>ÈÅ†Êù±SOGOÁôæË≤®„ÄÅÈÅ†Êù±Garden City„ÄÅÊñ∞ÂÖâ‰∏âË∂ä„ÄÅÈÅ†Êù±ÁôæË≤®„ÄÅÂè∞Âåó101„ÄÅBELLAVITA„ÄÅÂæÆÈ¢®Âª£Â†¥„ÄÅÁµ±‰∏ÄÊôÇ‰ª£Âè∞ÂåóÂ∫ó (‰∏çÂê´DREAM PLAZA)„ÄÅË™†ÂìÅÁîüÊ¥ª„ÄÅATT 4 FUN„ÄÅ‰∫¨Á´ô„ÄÅÁæéÈ∫óËèØ„ÄÅNOKEÂø†Ê≥∞Ê®ÇÁîüÊ¥ª„ÄÅÂ§ßËëâÈ´òÂ≥∂Â±ã„ÄÅMitsui Shopping Park LaLaport (ÂçóÊ∏Ø„ÄÅÂè∞‰∏≠)„ÄÅÂÆèÂåØÂª£Â†¥„ÄÅÂè∞ËåÇË≥ºÁâ©‰∏≠ÂøÉ„ÄÅÂ§ßÊ±üÂúãÈöõË≥ºÁâ©‰∏≠ÂøÉ„ÄÅBig CityÈÅ†Êù±Â∑®Âüé„ÄÅ‰∏≠ÂèãÁôæË≤®„ÄÅÂª£‰∏âSOGO„ÄÅÂçóÁ¥°Ë≥ºÁâ©‰∏≠ÂøÉ„ÄÅËÄêÊñØÂª£Â†¥„ÄÅÂ§¢ÊôÇ‰ª£„ÄÅÊº¢Á•ûÁôæË≤®„ÄÅÊº¢Á•ûÂ∑®Ëõã„ÄÅÊñ∞ÊúàÂª£Â†¥„ÄÅCITYLINK„ÄÅÁßÄÊ≥∞ÁîüÊ¥ª„ÄÅÁí∞ÁêÉË≥ºÁâ©‰∏≠ÂøÉ„ÄÅÂ§™Âπ≥Ê¥ãÁôæË≤®„ÄÅËèØÊ≥∞ÂêçÂìÅÂüé„ÄÅSKM Park„ÄÅMITSUI OUTLET PARK (ÊûóÂè£„ÄÅÂè∞‰∏≠Ê∏Ø„ÄÅÂè∞Âçó)<br>
                            <b>Â§ñÈÄÅÔºö</b>Uber Eats„ÄÅfoodpanda<br>
                            <b>È§êÈ£≤Ôºö</b>ÂúãÂÖßÈ§êÈ£≤ (‰∏çÂê´È§êÂà∏ÔºåÂê´Â∞èÈ°çÊîØ‰ªòÂπ≥Âè∞È§êÂª≥)„ÄÅÈÄ£ÈéñÈÄüÈ£ü-È∫•Áï∂Âãû<br>
                            <b>Ëó•Â¶ùÔºö</b>Â∫∑ÊòØÁæé„ÄÅÂ±àËá£Ê∞è
                        </div>
                    </div>

                    <div class="option-row" style="flex-direction:column; align-items:flex-start; gap:0;">
                        <div style="display:flex; justify-content:space-between; width:100%; align-items:center;">
                            <label for="rbCubeTravel">‚úàÔ∏è Ë∂£ÊóÖË°å (‰æùÁ≠âÁ¥ö)</label>
                            <input type="radio" name="cubeMode" id="rbCubeTravel" value="travel" onchange="updateRewardPreview()">
                        </div>
                        <button onclick="toggleCubeDetails('cubeTravelDetails')" style="border:none; background:none; color:#007AFF; font-size:11px; cursor:pointer; padding:2px 0 4px 0;">‚ñ∏ Êü•ÁúãÊåáÂÆöÈÄöË∑Ø</button>
                        <div id="cubeTravelDetails" class="details-content">
                            <b>Êµ∑Â§ñÊ∂àË≤ªÔºö</b>Êµ∑Â§ñÂØ¶È´îÊ∂àË≤ª (Âê´ÂúãÂ§ñÈ§êÈ£≤„ÄÅÈ£ØÂ∫óÂà∞Â∫ó‰ªòÊ¨æÁ≠â)<br>
                            <b>Êó•Êú¨Ê®ÇÂúíÔºö</b>Êù±‰∫¨Ëø™Â£´Â∞ºÊ®ÇÂúí„ÄÅÊù±‰∫¨ËèØÁ¥çÂÖÑÂºüÂìàÂà©Ê≥¢ÁâπÂΩ±Âüé„ÄÅÂ§ßÈò™Áí∞ÁêÉÂΩ±Âüé (USJ)<br>
                            <b>‰∫§ÈÄöÔºö</b>AppleÈå¢ÂåÖ‰∫§ÈÄöÂç° (SUICA/PASMO/ICOCA)„ÄÅUber„ÄÅGrab„ÄÅÂè∞ÁÅ£È´òÈêµ„ÄÅyoxi„ÄÅÂè∞ÁÅ£Â§ßËªäÈöä„ÄÅiRent„ÄÅÂíåÈÅãÁßüËªä„ÄÅÊ†º‰∏äÁßüËªä<br>
                            <b>Ëà™Á©∫Ôºö</b>‰∏≠ËèØËà™Á©∫„ÄÅÈï∑Ê¶ÆËà™Á©∫„ÄÅÊòüÂÆáËà™Á©∫„ÄÅÂè∞ÁÅ£ËôéËà™„ÄÅÂúãÊ≥∞Ëà™Á©∫„ÄÅÊ®ÇÊ°ÉËà™Á©∫„ÄÅÈòøËÅØÈÖãËà™Á©∫„ÄÅÈÖ∑Ëà™„ÄÅÊç∑ÊòüËà™Á©∫„ÄÅÊó•Êú¨Ëà™Á©∫„ÄÅANAÂÖ®Êó•Á©∫„ÄÅ‰∫ûÊ¥≤Ëà™Á©∫„ÄÅËÅØÂêàËà™Á©∫„ÄÅÊñ∞Âä†Âù°Ëà™Á©∫„ÄÅË∂äÊç∑Ëà™Á©∫„ÄÅÂ§ßÈüìËà™Á©∫„ÄÅÈÅîÁæéËà™Á©∫„ÄÅÂúüËÄ≥ÂÖ∂Ëà™Á©∫„ÄÅÂç°ÈÅîËà™Á©∫„ÄÅÊ≥ïÂúãËà™Á©∫<br>
                            <b>È£ØÂ∫óÔºö</b>ÂúãÂÖßÈ£ØÂ∫ó‰ΩèÂÆø„ÄÅÊòüÈáéÈõÜÂúò„ÄÅÂÖ®ÁêÉËø™Â£´Â∞ºÈ£ØÂ∫ó„ÄÅÊù±Ê©´INN<br>
                            <b>Ë®ÇÊàø/Á•®Âà∏Ôºö</b>KKday„ÄÅKlook„ÄÅAgoda„ÄÅAirbnb„ÄÅBooking.com„ÄÅTrip.com<br>
                            <b>ÊóÖË°åÁ§æÔºö</b>ÊòìÈÅäÁ∂≤„ÄÅÈõÑÁçÖ„ÄÅÂèØÊ®Ç„ÄÅÊù±Âçó„ÄÅ‰∫îÁ¶è„ÄÅÁá¶Êòü„ÄÅÂ±±ÂØå„ÄÅÈï∑Ê±éÂÅáÊúü„ÄÅÈ≥≥Âá∞„ÄÅEzflyÊòìÈ£õÁ∂≤„ÄÅÁêÜÊÉ≥ÊóÖÈÅä„ÄÅÊ∞∏Âà©ÊóÖË°åÁ§æ„ÄÅ‰∏âË≥ÄÊóÖË°åÁ§æ
                        </div>
                    </div>

                    <div class="option-row" style="flex-direction:column; align-items:flex-start; gap:0;">
                        <div style="display:flex; justify-content:space-between; width:100%; align-items:center;">
                            <label for="rbCubeSelect">üõí ÈõÜÁ≤æÈÅ∏ (Âõ∫ÂÆö 2%)</label>
                            <input type="radio" name="cubeMode" id="rbCubeSelect" value="select" onchange="updateRewardPreview()">
                        </div>
                        <button onclick="toggleCubeDetails('cubeSelectDetails')" style="border:none; background:none; color:#007AFF; font-size:11px; cursor:pointer; padding:2px 0 4px 0;">‚ñ∏ Êü•ÁúãÊåáÂÆöÈÄöË∑Ø</button>
                        <div id="cubeSelectDetails" class="details-content">
                            <b>Ë∂ÖÂïÜÔºö</b>7-ELEVEN ÂØ¶È´îÈñÄÂ∏Ç„ÄÅÂÖ®ÂÆ∂‰æøÂà©ÂïÜÂ∫ó ÂØ¶È´îÈñÄÂ∏Ç<br>
                            <b>Ë∂ÖÂ∏Ç/ÈáèË≤©Ôºö</b>ÂÖ®ËÅØÁ¶èÂà©‰∏≠ÂøÉ ÂØ¶È´îÈñÄÂ∏Ç (‰∏çÂê´Â§ßÂÖ®ËÅØ)„ÄÅÂÆ∂Ê®ÇÁ¶è„ÄÅLOPIAÂè∞ÁÅ£<br>
                            <b>ÁîüÊ¥ªÂÆ∂Â±ÖÔºö</b>IKEAÂÆúÂÆ∂ÂÆ∂Â±Ö<br>
                            <b>Âä†Ê≤πÔºö</b>Âè∞ÁÅ£‰∏≠Ê≤πÁõ¥ÁáüÁ´ô<br>
                            <b>ÂÖÖÈõª/ÂÅúËªäÔºö</b>U-POWER„ÄÅEVOASIS„ÄÅEVALUE„ÄÅTAIL„ÄÅiCharging„ÄÅËªäÈ∫ªÂêâ (‰∏çÂê´Âä†Ê≤π)„ÄÅuTagGo (‰∏çÂê´ÊúàÁßüÂÅúËªä)<br>
                            <b>‚ö†Ô∏è ‰∏çÈÅ©Áî®Ôºö</b>ÂÖ®ÊîØ‰ªòÁ∂ÅÂç°‰∫§Êòì„ÄÅPX PayÁ∑ö‰∏äË≥ºÁâ©/ÂÑ≤ÂÄº„ÄÅÂÖ®ËÅØÂ∞èÊôÇÈÅî„ÄÅÂÖ®ËÅØÂÖ®ÈõªÂïÜ„ÄÅÂ§ßÂÖ®ËÅØ
                        </div>
                    </div>

                    <div class="option-row" style="flex-direction:column; align-items:flex-start; gap:0; border-top:1px dashed #ddd; padding-top:6px; margin-top:4px;">
                        <div style="display:flex; justify-content:space-between; width:100%; align-items:center;">
                            <label for="rbCubeBdayHigh">üéÇ ÊÖ∂ÁîüÊúà 10% (ÈôêÁï∂ÊúàÂ£ΩÊòü)</label>
                            <input type="radio" name="cubeMode" id="rbCubeBdayHigh" value="birthday_high" onchange="updateRewardPreview()">
                        </div>
                        <button onclick="toggleCubeDetails('cubeBdayHighDetails')" style="border:none; background:none; color:#007AFF; font-size:11px; cursor:pointer; padding:2px 0 4px 0;">‚ñ∏ Êü•Áúã 10% ÈÄöË∑Ø</button>
                        <div id="cubeBdayHighDetails" class="details-content">
                            <b>ÂÆúËä±Êù±ÁæéÈ£üÔºö</b>Á§ÅÊ∫™Â∫ÑÊ´ªÊ°ÉË∞∑„ÄÅÂØåÁæéÊµ∑ÈÆÆÁÅ´Èçã„ÄÅ‰∏ä‰πò‰∏âÂÆ∂Ê∂ÆÊ∂ÆÈçã„ÄÅÁáíËÇâÂêâÂÆ§„ÄÅËå∂ÂÆ¥„ÄÅÊå™‰∫ûÊñπËàüÁæéÈ£üÊóóËâ¶Â∫ó„ÄÅÊπØËí∏ÁÅ´Èçã„ÄÅÊ®πÊá∂È§êÂª≥„ÄÅ‰πùËôüÂíñÂï°„ÄÅËÇâËÇâÈ§êÊ°å„ÄÅÊ≠êÈÑâÁâõÊéíÈ§®„ÄÅËÄÅÊôÇÂÖâÁáíËÇâÈÖíËÇ¥„ÄÅÁÅ´ËªäÈ†≠ÁÉ§ËÇâÂ±ã„ÄÅÂ∞èÂíåÂ±±Ë∞∑„ÄÅÂ±ãË≥ÄÁà∫ÁáíËÇâ<br>
                            <b>ÂæÆÈÜ∫È§êÈ£üÁîúÈªûÔºö</b>BeApeÊ≥ïÂúãÂÇ≥Áµ±È§êÈÖíÈ§®ÔΩúGras French„ÄÅTUTTO BELLO„ÄÅTHE Êò•„ÄÅÈ¶ôËâ≤„ÄÅGalerie Bistro„ÄÅFUGU GASTROPUB„ÄÅcreammm.t„ÄÅMiss V Bakery„ÄÅÁ¥ÖËëâËõãÁ≥ïÊåáÂÆöÁ∂≤Á´ô„ÄÅ‰∏ÉË¶ãÊ´ªÂ†Ç<br>
                            <b>Âú®Âú∞È£üÊùêÈ§êÂª≥Ôºö</b>Plants„ÄÅÈáåÊµ∑ÂíñÂï°„ÄÅÊó•ÂÖâÁßÅÂªöÊ≥ïÂºèÈ§êÂª≥„ÄÅÊñπÊ≠£Ë∞∑Áú∑ÊùëÂë≥„ÄÅFIRNS„ÄÅÊºÅÈááÊôÇ‰ª§ÊñôÁêÜ<br>
                            <b>ÈÄ£ÈéñÈ§êÈ£≤Ôºö</b>UNCLE SHAWN ÁáíËÇâÈ§êÈÖíÈ§®„ÄÅ‰∫åÊú¨ÊùæÊ∂ÆÊ∂ÆÂ±ãÔΩúÊ©ãÂ±±Â£ΩÂñúÁáí„ÄÅPastaioÔΩúPastaio noodle cafe„ÄÅË©πË®òÈ∫ªËæ£ÁÅ´Èçã„ÄÅÁÑ°ËÄÅÈçã„ÄÅÈºéÁéãÈ∫ªËæ£Èçã„ÄÅÂ∞èÊñπËàü‰∏≤ÁáíÈÖíÂ†¥„ÄÅÊØõ‰∏º‰∏ºÈ£ØÂ∞àÈñÄÂ∫ó„ÄÅÊØõÊàøËî•ÊüöÈçã„ÄÅÊØõËî¨‰∫ûÊ¥≤Ëî¨È£ü„ÄÅÊ£ÆÂ∑ù‰∏º‰∏º„ÄÅÂ∞áËªçÂ∫úÁáíÁÉ§Êó•Êú¨ÊñôÁêÜ„ÄÅÂ•ΩÂ§•‰º¥ÂíñÂï°<br>
                            <b>Êó•Êú¨Ê®ÇÂúí+ÈÅäÊà≤Â®õÊ®ÇÔºö</b>Êù±‰∫¨Ëø™Â£´Â∞ºÊ®ÇÂúí„ÄÅÂ§ßÈò™Áí∞ÁêÉÂΩ±Âüé (USJ)„ÄÅPlayStation„ÄÅNintendo„ÄÅÂ∑¥ÂìàÂßÜÁâπÂãïÁï´Áòã<br>
                            <b>KTVÔºö</b>Èå¢Ê´É„ÄÅÂ•ΩÊ®ÇËø™„ÄÅÊòüËÅöÈªû„ÄÅ‰∫´Ê∫´È¶®
                        </div>
                    </div>
                    <div class="option-row" style="flex-direction:column; align-items:flex-start; gap:0;">
                        <div style="display:flex; justify-content:space-between; width:100%; align-items:center;">
                            <label for="rbCubeBdayLow">üéÇ ÊÖ∂ÁîüÊúà 3.5% (ÈôêÁï∂ÊúàÂ£ΩÊòü)</label>
                            <input type="radio" name="cubeMode" id="rbCubeBdayLow" value="birthday_low" onchange="updateRewardPreview()">
                        </div>
                        <div style="font-size:10px; color:#555; padding:2px 0 4px 0;">Êñ∞ÂÖâ‰∏âË∂ä (‰∏çÂê´SKM Park OutletsÈ´òÈõÑËçâË°ô)„ÄÅUber Eats</div>
                    </div>

                    <div id="cubeMegaHighRow" class="option-row" style="flex-direction:column; align-items:flex-start; gap:0; border-top:1px dashed #ddd; padding-top:6px; margin-top:4px;">
                        <div style="display:flex; justify-content:space-between; width:100%; align-items:center;">
                            <label for="rbCubeMegaHigh">üé∏ ÁòãÂ§ßÊ∏Ø 10% (3/21-3/22ÈôêÂÆö)</label>
                            <input type="radio" name="cubeMode" id="rbCubeMegaHigh" value="megaport_high" onchange="updateRewardPreview()">
                        </div>
                        <div style="font-size:10px; color:#555; padding:2px 0 4px 0;">Â§ßÊ∏ØÈñãÂî±ÁèæÂ†¥Âë®ÈÇäÂïÜÂìÅ„ÄÅÊåáÂÆöÊòüÂ∑¥ÂÖã„ÄÅÂ§ßÊ∏ØÂÄâ„ÄÅÊ£ß‰∫åÂ∫´„ÄÅÂ∑¶ËÖ≥Âè≥ËÖ≥ÊåâÊë©ÊúÉÈ§®„ÄÅChargeSPOT</div>
                    </div>
                    <div id="cubeMegaLowRow" class="option-row" style="flex-direction:column; align-items:flex-start; gap:0;">
                        <div style="display:flex; justify-content:space-between; width:100%; align-items:center;">
                            <label for="rbCubeMegaLow">üé∏ ÁòãÂ§ßÊ∏Ø 3.5% (~3/23)</label>
                            <input type="radio" name="cubeMode" id="rbCubeMegaLow" value="megaport_low" onchange="updateRewardPreview()">
                        </div>
                        <button onclick="toggleCubeDetails('cubeMegaDetails')" style="border:none; background:none; color:#007AFF; font-size:11px; cursor:pointer; padding:2px 0 4px 0;">‚ñ∏ Êü•Áúã 3.5% ÈÄöË∑Ø</button>
                        <div id="cubeMegaDetails" class="details-content">
                            <b>ÊåáÂÆöÈ´òÈõÑ‰ΩèÂÆøÔºö</b>ÂüéÂ∏ÇÂïÜÊóÖ (ÁúüÊÑõÈ§®„ÄÅÈßÅ‰∫åÈ§®)„ÄÅÈ∫óÂ∞äÈÖíÂ∫ó„ÄÅÂ∏ïÂèØÈ∫óÈÖíÂ∫ó„ÄÅÂíåÈÄ∏È£ØÂ∫óÈ´òÈõÑ‰∏≠Â±±È§®„ÄÅÊóÖÂ±ÖÊñáÊóÖ (‰∏ÄÂøÉÈ§®„ÄÅ‰∏ÉË≥¢È§®„ÄÅ‰∫ûÁÅ£È§®)„ÄÅÁßùËäØÊóÖÂ∫ó (ÈßÅ‰∫åÈ§®„ÄÅÂÖ≠ÂêàÈ§®)„ÄÅÈàûÊÄ°Â§ßÈ£ØÂ∫ó„ÄÅÂ§èÂÑ™ÊóÖÂ±ÖÈßÅ‰∫åÈ§®„ÄÅËèØÂúíÂ§ßÈ£ØÂ∫óËçâË°ôÈ§®„ÄÅÊç∑Áµ≤ÊóÖÈ´òÈõÑ‰∏≠Ê≠£È§®<br>
                            <b>ÊóÖÈÅäÂπ≥Âè∞Ôºö</b>Klook<br>
                            <b>ÊåáÂÆö‰∫§ÈÄö (2/21Ëµ∑)Ôºö</b>Âè∞ÁÅ£È´òÈêµ„ÄÅÂè∞ÁÅ£ÈêµË∑ØÂ±Ä<br>
                            <b>Âë®ÈÇäÂïÜÂìÅÈ†êË≥ºÔºö</b>Â§ßÊ∏ØÈñãÂî±ÂÆòÊñπÈÄöË∑Ø
                        </div>
                    </div>

                    <div class="option-row" style="border-top:1px dashed #ddd; padding-top:8px; margin-top:6px;">
                        <label for="checkCubeLinePay">üü¢ LINE Pay È†òÂà∏ +1.7% (Êúà‰∏äÈôê100Èªû)</label>
                        <input type="checkbox" id="checkCubeLinePay" onchange="updateRewardPreview()">
                    </div>
                    <div style="font-size:10px; color:#555; margin-top:2px; opacity:0.8;">
                        üí° ÈúÄËá≥ CUBE App È†òÂà∏ÔºåÁï∂Êúà LINE Pay Ê∂àË≤ªÊªø 8 Á≠ÜÊâç‰∫´Âä†Á¢º (Á¥ÑÂà∑$5,882Â∞ÅÈ†Ç)
                    </div>
                </div>
                
                <div id="pigRichOptions">
                    <div class="option-row read-only"><label id="labelBaseRate">üî∞ Âü∫Êú¨ÂõûÈ•ã 1% (ÁÑ°‰∏äÈôê)</label><input type="checkbox" checked disabled></div>
                    <div class="option-row" style="flex-direction:column; align-items:flex-start; gap:0;">
                          <div style="display:flex; justify-content:space-between; width:100%; align-items:center;">
                             <label for="checkBonus10">‚ö° Êñ∞Êà∂Âä†Á¢º +10% (Âà∑$8,000Â∞ÅÈ†Ç)</label>
                             <input type="checkbox" id="checkBonus10" checked onchange="updateRewardPreview()">
                        </div>
                        <button onclick="togglePigRichNewUser()" style="border:none; background:none; color:#007AFF; font-size:11px; cursor:pointer; padding:2px 0 6px 0;">üîΩ ÈªûÊìäÊü•Áúã 10% ÂÆöÁæ©</button>
                        <div id="pigRichNewUserDetails" class="details-content">
                            <b>‚òÖ Ë°åÂãïÊîØ‰ªòÔºö</b><br>LINE Pay„ÄÅË°óÂè£ÊîØ‰ªò„ÄÅicash Pay (Âê´APPÂÖßÁπ≥Ë≤ª)<br>
                            <b>‚òÖ Êµ∑Â§ñÊ∂àË≤ªÔºö</b><br>Âê´ÂØ¶È´îÂèäÁ∑ö‰∏ä‰∫§Êòì (ÈúÄÈùûÂè∞Âπ£/ÈùûÂè∞ÁÅ£)<br>
                            <b>‚òÖ Ê©üÁ•®Ôºö</b><br>ÂúãÂÖßÂ§ñËà™Á©∫ÂÖ¨Âè∏ (ÈôêÈÄèÈÅéËà™Á©∫ÂÖ¨Âè∏ÂÆòÁ∂≤Ë≥ºË≤∑)<br>
                        </div>
                    </div>

                    <div class="option-row" style="flex-direction:column; align-items:flex-start; gap:0; border-top:1px dashed #ddd; padding-top:6px;">
                        <div style="display:flex; justify-content:space-between; width:100%; align-items:center;">
                            <label for="checkBonus25">üåü Á≤æÈÅ∏ÈÄöË∑Ø +2.5% (Âà∑$40Ëê¨Â∞ÅÈ†Ç)</label>
                            <input type="checkbox" id="checkBonus25" checked onchange="toggleSelectedLogic()">
                        </div>
                        <button onclick="togglePigRichSelected()" style="border:none; background:none; color:#007AFF; font-size:11px; cursor:pointer; padding:2px 0 6px 0;">üîΩ ÈªûÊìäÊü•ÁúãÁ≤æÈÅ∏ÈÄöË∑Ø</button>
                        <div id="pigRichSelectedDetails" class="details-content">
                            <b>(1) ÊóÖÈÅä‰∫§ÈÄöÔºö</b><br>Êó•Êú¨PayPay(ÈôêË°óÂè£)„ÄÅÈüìÂúã„ÄÅKlook„ÄÅKKday„ÄÅÊòìÈÅäÁ∂≤„ÄÅAgoda„ÄÅAirbnb„ÄÅDJB„ÄÅÈÖ∑ÈÅäÂç°„ÄÅÈ´òÈêµ„ÄÅUber„ÄÅÂè´ËªäÂêß„ÄÅÂè∞ÁÅ£Âø´Á∂´„ÄÅËÅØÈÄö„ÄÅUSPACE„ÄÅ‰ø•‰∫≠ÂÅúËªä<br>
                            <b>(2) ÁîüÊ¥ªË≥ºÁâ©Ôºö</b><br>Êñ∞ÂÖâ‰∏âË∂ä„ÄÅÈÅ†Êù±ÁôæË≤®„ÄÅÈÅ†Êù±Â∑®Âüé„ÄÅLaLaport„ÄÅ‰∏â‰∫ïOutlet„ÄÅÂ∫∑ÊòØÁæé„ÄÅÁæéÂªâÁ§æ„ÄÅËÅñÂæ∑ÁßëÊñØ<br>
                            <b>(3) Â§ñÈÄÅÁæéÈ£üÔºö</b><br>Uber Eats„ÄÅfoodpanda„ÄÅFoodomo„ÄÅEZTABLE„ÄÅ85Â∫¶C„ÄÅÊ∏ÖÂøÉÁ¶èÂÖ®„ÄÅ‰∏âÂïÜÈ§êÈ£≤<br>
                            <b>(4) ÂΩ±ÂüéKÊ≠åÔºö</b><br>Â®ÅÁßÄ„ÄÅÂúãË≥ì„ÄÅÊñ∞ÂÖâ„ÄÅÂñúÊ®ÇÊôÇ‰ª£„ÄÅÁßÄÊ≥∞„ÄÅÈå¢Ê´É„ÄÅÂ•ΩÊ®ÇËø™„ÄÅ‰∫´Ê∫´È¶®„ÄÅÂá±ÊÇÖ„ÄÅÊòüËÅöÈªû„ÄÅSing Go„ÄÅONCOR<br>
                        </div>
                    </div>

                    <div class="option-row" style="margin-bottom:0; border-top:1px dashed #ddd; padding-top:6px;"><label for="checkIsBill">üßæ APPÁπ≥Ë≤ª (Â∫ï1%‚Üí0.15%)</label><input type="checkbox" id="checkIsBill" onchange="toggleBillLogic()"></div>
                    
                    <div id="pigRichOverseasNote" style="display:none; margin-top:8px; padding:8px; background:#fff3e0; border-radius:6px; font-size:11px; color:#e65100;">
                        ‚ö†Ô∏è Êó•Êú¨ PayPay ÈÄèÈÅéË°óÂè£ÔºöÂÉÖ‰∫´ +1% Á≤æÈÅ∏Âä†Á¢º (Èùû2.5%)
                    </div>
                </div>

                <div id="laiDianOptions" style="display:none; background:#f9f9f9; padding:10px; border-radius:10px; margin-top:10px; border:1px dashed #ddd;">
                    <div class="option-row" style="margin-bottom:8px;">
                        <label for="checkLaiDianNew" style="font-weight:700; color:#007AFF;">üë∂ ÊàëÊòØÊñ∞Êà∂ (Ê†∏Âç°6ÂÄãÊúàÂÖß)</label>
                        <input type="checkbox" id="checkLaiDianNew" onchange="updateRewardPreview()">
                    </div>
                    
                    <div class="option-row" style="flex-direction:column; align-items:flex-start; gap:4px; border-top:1px dashed #ddd; padding-top:8px;">
                        <div style="font-size:12px; font-weight:700; color:#555; margin-bottom:4px;">Ë´ãÈÅ∏ÊìáÊ∂àË≤ªÊ®°ÂºèÔºö</div>
                        
                        <label style="display:flex; align-items:center; width:100%; justify-content:space-between; margin-bottom:6px;">
                            <span>1Ô∏è‚É£ ÂØ¶È´î / ‰∏ÄËà¨ / ÂúãÂ§ñ</span>
                            <input type="radio" name="laiDianMode" value="general" checked onchange="updateRewardPreview()">
                        </label>
                        
                        <label style="display:flex; align-items:center; width:100%; justify-content:space-between; margin-bottom:6px;">
                            <span>2Ô∏è‚É£ LINE Pay ‰∏ÄËà¨ (Âä†Á¢º1%)</span>
                            <input type="radio" name="laiDianMode" value="lp" onchange="updateRewardPreview()">
                        </label>
                        
                        <label style="display:flex; align-items:center; width:100%; justify-content:space-between;">
                            <span>3Ô∏è‚É£ ÂÅ∂Êï∏Êó• + ÊåáÂÆöÈÄöË∑Ø (Âä†Á¢º5%)</span>
                            <input type="radio" name="laiDianMode" value="even" onchange="updateRewardPreview()">
                        </label>
                        
                        <button onclick="toggleLaiDianDetails()" style="border:none; background:none; color:#007AFF; font-size:11px; cursor:pointer; padding:6px 0 0 0; width:100%; text-align:left;">üîΩ Êü•ÁúãÊåáÂÆöÈÄöË∑Ø (ÂÅ∂Êï∏Êó•+5%)</button>
                        <div id="laiDianDetails" class="details-content">
                            <b>ÊåáÂÆöÈÄöË∑Ø (ÈúÄÁ∂ÅÂÆö LINE Pay)Ôºö</b><br>
                            <b>È§êÈ£≤Ôºö</b>ÁéãÂìÅ„ÄÅ‰∏âÂïÜ„ÄÅËºï‰∫ïÊæ§„ÄÅÊº¢‰æÜ„ÄÅÈ•óË≥ì„ÄÅÊµ∑Â∫ïÊíà„ÄÅÁØâÈñì„ÄÅÊò•Ê∞¥Â†Ç„ÄÅÂ£ΩÂè∏ÈÉé„ÄÅÁà≠ÈÆÆ„ÄÅÂÖ´ÊñπÈõ≤ÈõÜ„ÄÅÈ∫•Áï∂Âãû„ÄÅËÇØÂæ∑Âü∫„ÄÅÊë©ÊñØ„ÄÅÊº¢Â†°Áéã„ÄÅÊòüÂ∑¥ÂÖã„ÄÅË∑ØÊòìËéé„ÄÅcama„ÄÅ50Âµê„ÄÅÂæóÊ≠£„ÄÅÈ∫ªÂè§„ÄÅÂèØ‰∏çÂèØ<br>
                            <b>Ëó•Â¶ùÔºö</b>Â±àËá£Ê∞è„ÄÅÂØ∂ÈõÖ„ÄÅÂîêÂêâË®∂Âæ∑„ÄÅÂ§ßÊ®π„ÄÅÊùè‰∏Ä„ÄÅ‰∏Å‰∏Å„ÄÅ‰ΩëÂÖ®„ÄÅË∫çÁçÖ<br>
                            <b>ÂÆ∂Â±ÖÂØµÁâ©Ôºö</b>IKEA„ÄÅHola„ÄÅÂ∞èÂåó„ÄÅÊ±™ÂñµÊòüÁêÉ„ÄÅÊù±Ê£ÆÂØµÁâ©„ÄÅÂíïÂíïG„ÄÅÈ≠ö‰∏≠È≠ö„ÄÅÂØµÁâ©ÂÖ¨Âúí<br>
                            <b>ÈÅãÂãïÔºö</b>NIKE„ÄÅAdidas„ÄÅNewBalance„ÄÅËø™Âç°ÂÑÇ„ÄÅÈûãÂÖ®ÂÆ∂Á¶è„ÄÅÊë©ÊõºÈ†ì
                        </div>
                    </div>
                    
                    <div id="laiDianOverseasWarning" style="display:none; margin-top:8px; padding:8px; background:#ffebee; border-radius:6px; font-size:11px; color:#c62828;">
                        ‚ö†Ô∏è ÂúãÂ§ñÁÑ° LP Âä†Á¢ºÔºåÂõ∫ÂÆö 3% ÂõûÈ•ã (ÁÑ°‰∏äÈôê)
                    </div>
                </div>

                <div id="greenCardOptions">
                    <div class="option-row read-only"><label>üî∞ ÂúãÂÖß 1% / ÂúãÂ§ñ 2%</label><input type="checkbox" checked disabled></div>
                    
                    <div class="option-row" style="flex-direction:column; align-items:flex-start; gap:0;">
                        <div style="display:flex; justify-content:space-between; width:100%; align-items:center;">
                            <label for="checkGreenChannel">üåø Á∂†Ëâ≤ÈÄöË∑Ø +5% (Âà∑$3,000Â∞ÅÈ†Ç)</label>
                            <input type="checkbox" id="checkGreenChannel" onchange="toggleGreenLogic()">
                        </div>
                        <button onclick="toggleGreenDetails()" style="border:none; background:none; color:#007AFF; font-size:11px; cursor:pointer; padding:2px 0 6px 0;">üîΩ ÈªûÊìäÊü•ÁúãÁ∂†Ëâ≤ÈÄöË∑Ø</button>
                        <div id="greenDetails" class="details-content">
                            <b>(1) Á∂†Ëâ≤‰∫§ÈÄöÔºö</b><br>ÁâπÊñØÊãâ„ÄÅGogoro„ÄÅWeMo„ÄÅiRent„ÄÅGoShare„ÄÅUSPACE„ÄÅUbike<br>
                            <b>(2) Á∂†Ëâ≤È£≤È£üÔºö</b><br>ÂØ¨ÂøÉÂúí„ÄÅÈôΩÊòéÊò•Â§©„ÄÅÂ∞èÂ∞èÊ®πÈ£ü„ÄÅÈ§äÂøÉËå∂Ê®ì„ÄÅËçâËî¨ÂÆ¥„ÄÅ‰∏äÂñÑË±ÜÂÆ∂<br>
                            <b>(3) Á∂†Ëâ≤Ë≥º/ÊçêÔºö</b><br>‰∏≠ËèØÈõª‰ø°(ÈõªÂ≠êÂ∏≥ÂñÆ)„ÄÅÂè∞ÁÅ£Â§ßÂì•Â§ß(ÈõªÂ≠êÂ∏≥ÂñÆ)„ÄÅÈÅ†ÂÇ≥(ÈõªÂ≠êÂ∏≥ÂñÆ)„ÄÅTeslaÂÖÖÈõª„ÄÅÊÖàÊøü„ÄÅ‰∏ñÁïåÂ±ïÊúõÊúÉ<br>
                        </div>
                    </div>
                    
                    <div class="option-row" style="flex-direction:column; align-items:flex-start; gap:0; border-top:1px dashed #ddd; padding-top:6px; margin-top:6px;">
                          <button onclick="toggleParkingDetails()" style="border:none; background:none; color:#007AFF; font-size:11px; cursor:pointer; padding:2px 0 6px 0; font-weight:700;">üÖøÔ∏è Êü•ÁúãÂÖçË≤ªÂÅúËªäÈÅ©Áî®ÂêçÂñÆ (ÈúÄ‰∏äÊúàÊªøÈ°ç)</button>
                          <div id="greenParkingDetails" class="details-content">
                            <b>Âè∞ÁÅ£ËÅØÈÄö„ÄÅË©ÆÁáü„ÄÅViVi PARK„ÄÅÂòüÂòüÊàø„ÄÅËªäÈ∫ªÂêâ</b><br>
                            <span style="font-size:10px; color:#555;">(ÊØèÊó•1Ê¨°„ÄÅÊØèÊ¨°2Â∞èÊôÇ„ÄÅÊØèÊúàÊúÄÈ´ò5Ê¨°)</span><br>
                          </div>
                    </div>

                    <div class="option-row" style="margin-top:6px; border-top:1px dashed #ddd; padding-top:6px; margin-bottom:0;"><label for="checkForeign">‚úàÔ∏è ÂúãÂ§ñÊ∂àË≤ª 2% (ÁÑ°‰∏äÈôê)</label><input type="checkbox" id="checkForeign" onchange="toggleForeignLogic()"></div>
                </div>
                
                <div id="uniOptions">
                    <div class="option-row read-only"><label id="labelUniBase">üî∞ ‰ªªÊÑèÈÅ∏ 3.5% (Âà∑$4Ëê¨Â∞ÅÈ†Ç)</label><input type="checkbox" checked disabled></div>
                    <div class="option-row"><label for="checkUniUp">üÜô Ë®ÇÈñ± UP ÈÅ∏ 4.5% (Âà∑$14Ëê¨Â∞ÅÈ†Ç)</label><input type="checkbox" id="checkUniUp" onchange="toggleUniUpLogic()"></div>
                    <div id="uniChannelSection" style="margin-top:6px; border-top:1px dashed #ddd; padding-top:6px;">
                        <div style="display:flex; justify-content:space-between; width:100%; align-items:center; margin-bottom:6px;">
                            <label style="font-size:13px;">üìã ÊàëÁöÑ 8 È†ÖÈÄöË∑Ø <span id="uniChannelCount" style="font-size:11px; color:#999;"></span></label>
                            <button onclick="toggleUniChannelList()" style="border:none; background:#007AFF; color:white; font-size:10px; padding:4px 8px; border-radius:4px; cursor:pointer;" id="btnToggleUniChannel">Â±ïÈñãÈÄöË∑Ø ‚ñº</button>
                        </div>
                       <div id="uniChannelContainer" style="width:100%; display:none;"></div>
                        <div id="uniChannelSummary" style="margin-top:6px; font-size:11px; color:#666; line-height:1.6;"></div>
                    </div>

                    <div class="option-row" style="margin-top:6px; border-top:1px dashed #ddd; padding-top:6px; margin-bottom:0;"><label for="checkUniBonus">üî• Áµ±‰∏ÄÊôÇ‰ª£‰ªªÂãô +3% (Âà∑$1.6Ëê¨Â∞ÅÈ†Ç)</label><input type="checkbox" id="checkUniBonus" onchange="updateRewardPreview()"></div>
                    
                    <div id="uniOverseasWarning" style="display:none; margin-top:8px; padding:8px; background:#ffebee; border-radius:6px; font-size:11px; color:#c62828;">
                        ‚ö†Ô∏è ÂúãÂ§ñÊ∂àË≤ªÁÑ°Âä†Á¢ºÔºåÂÉÖ‰∫´Âü∫Êú¨ 1% ÂõûÈ•ã
                    </div>
                </div>
                
                <div id="uniOpenOptions">
                    <div class="option-row read-only"><label>üî∞ Âü∫Êú¨ÂõûÈ•ã 1% (ÁÑ°‰∏äÈôê)</label><input type="checkbox" checked disabled></div>
                    <div class="option-row"><label for="checkUniGroup">üè™ Áµ±‰∏ÄÈõÜÂúò +2% (Âà∑$2.5Ëê¨Â∞ÅÈ†Ç)</label><input type="checkbox" id="checkUniGroup" onchange="toggleUniGroup()"></div>
                    <div class="option-row"><label for="checkUniIcash">üì± icash Pay +4% (Âà∑$3,750Â∞ÅÈ†Ç)</label><input type="checkbox" id="checkUniIcash" onchange="toggleUniIcash()"></div>
                    
                    <div class="option-row" style="border-top:1px dashed #ddd; padding-top:6px; margin-top:6px; flex-direction:column; align-items:flex-start;">
                        <div style="display:flex; justify-content:space-between; width:100%; align-items:center; margin-bottom:6px;">
                            <label>üèÉ Ë∏©Èªû‰ªªÂãô (2ÂÆ∂Ëµ∑Ë∑≥ÔºåÊúÄÈ´ò+4%)</label>
                            <button onclick="toggleUniBrandList()" style="border:none; background:#007AFF; color:white; font-size:10px; padding:4px 8px; border-radius:4px; cursor:pointer;" id="btnToggleUniBrand">Â±ïÈñãÂìÅÁâå ‚ñº</button>
                        </div>
                        <div id="uniBrandContainer" style="width:100%; display:none;">
                            <!-- ‰æøÂà©ÂïÜÂ∫ó/Ë∂ÖÂ∏Ç -->
                            <div class="brand-category">
                                <div class="brand-category-header" onclick="toggleBrandCategory('cat1')">
                                    <span>üè™ ‰æøÂà©ÂïÜÂ∫ó/Ë∂ÖÂ∏Ç</span>
                                    <span class="arrow" id="arrow-cat1">‚ñº</span>
                                </div>
                                <div class="brand-category-content" id="content-cat1">
                                    <div class="brand-grid" id="uniBrandGrid-cat1"></div>
                                </div>
                            </div>
                            <!-- ÁôæË≤®/Ë≥ºÁâ© -->
                            <div class="brand-category">
                                <div class="brand-category-header" onclick="toggleBrandCategory('cat2')">
                                    <span>üõçÔ∏è ÁôæË≤®/Ë≥ºÁâ©</span>
                                    <span class="arrow" id="arrow-cat2">‚ñº</span>
                                </div>
                                <div class="brand-category-content" id="content-cat2">
                                    <div class="brand-grid" id="uniBrandGrid-cat2"></div>
                                </div>
                            </div>
                            <!-- È§êÈ£≤/ÁîúÈªû -->
                            <div class="brand-category">
                                <div class="brand-category-header" onclick="toggleBrandCategory('cat3')">
                                    <span>üçΩÔ∏è È§êÈ£≤/ÁîúÈªû</span>
                                    <span class="arrow" id="arrow-cat3">‚ñº</span>
                                </div>
                                <div class="brand-category-content" id="content-cat3">
                                    <div class="brand-grid" id="uniBrandGrid-cat3"></div>
                                </div>
                            </div>
                            <!-- ÂÅ•Ë∫´/‰ºëÈñí -->
                            <div class="brand-category">
                                <div class="brand-category-header" onclick="toggleBrandCategory('cat4')">
                                    <span>üí™ ÂÅ•Ë∫´/‰ºëÈñí</span>
                                    <span class="arrow" id="arrow-cat4">‚ñº</span>
                                </div>
                                <div class="brand-category-content" id="content-cat4">
                                    <div class="brand-grid" id="uniBrandGrid-cat4"></div>
                                </div>
                            </div>
                            <!-- ÁîüÊ¥ªÊúçÂãô -->
                            <div class="brand-category">
                                <div class="brand-category-header" onclick="toggleBrandCategory('cat5')">
                                    <span>üè† ÁîüÊ¥ªÊúçÂãô</span>
                                    <span class="arrow" id="arrow-cat5">‚ñº</span>
                                </div>
                                <div class="brand-category-content" id="content-cat5">
                                    <div class="brand-grid" id="uniBrandGrid-cat5"></div>
                                </div>
                            </div>
                            <!-- ÊóÖÈÅä/È£ØÂ∫ó -->
                            <div class="brand-category">
                                <div class="brand-category-header" onclick="toggleBrandCategory('cat6')">
                                    <span>üè® ÊóÖÈÅä/È£ØÂ∫ó</span>
                                    <span class="arrow" id="arrow-cat6">‚ñº</span>
                                </div>
                                <div class="brand-category-content" id="content-cat6">
                                    <div class="brand-grid" id="uniBrandGrid-cat6"></div>
                                </div>
                            </div>
                        </div>
                        <div style="font-size:10px; color:#FF9800; margin-top:6px; font-weight:700;" id="taskBonusDisplay">ÁõÆÂâç 0 ÂÆ∂ (Âä†Á¢º 0%)</div>
                    </div>
                    <div class="option-row" style="margin-top:6px; border-top:1px dashed #ddd; padding-top:6px;">
                        <label for="checkUniOverseas">‚úàÔ∏è Êµ∑Â§ñÂØ¶È´î 11% (Âà∑$6,250Â∞ÅÈ†Ç)</label>
                        <input type="checkbox" id="checkUniOverseas" onchange="toggleUniOverseas()">
                    </div>
                </div>
                
                <div id="jiangOptions">
                    <div class="option-row read-only"><label>üî∞ Âü∫Êú¨ÂõûÈ•ã 0.5% (ÁÑ°‰∏äÈôê)</label><input type="checkbox" checked disabled></div>
                    
                    <div class="option-row" style="flex-direction:column; align-items:flex-start; gap:0px; border-top:1px dashed #ddd; padding-top:8px;">
                        <div style="display:flex; justify-content:space-between; width:100%; align-items:center; margin-bottom:4px;">
                            <label for="checkJiangSelected">üõçÔ∏è ÁîüÊ¥ªÂçáÁ¥ö +4.5% (Âà∑$6,666Â∞ÅÈ†Ç)</label>
                            <input type="checkbox" id="checkJiangSelected" onchange="toggleJiangSelected()">
                        </div>
                        <button onclick="toggleJiangDetails()" style="border:none; background:none; color:#007AFF; font-size:11px; cursor:pointer; padding:0 0 6px 0;">üîΩ ÈªûÊìäÊü•ÁúãÊåáÂÆöÈÄöË∑ØÊ∏ÖÂñÆ</button>
                        <div id="jiangDetails" class="details-content">
                            <b>(1) AiÂ∑•ÂÖ∑ÂèäÊï∏‰ΩçÂ∑•ÂÖ∑Ôºö</b><br>ChatGPT„ÄÅCanva„ÄÅClaude„ÄÅCursor„ÄÅDuolingo„ÄÅGamma„ÄÅGemini„ÄÅNotion„ÄÅPerplexity„ÄÅSpeak„ÄÅApple Â™íÈ´îÊúçÂãô„ÄÅGoogle Play<br>
                            <b>(2) Â≠∏ÁøíÂπ≥Âè∞Ôºö</b><br>Hahow„ÄÅUdemy„ÄÅVoiceTube„ÄÅPressPlay„ÄÅAmazingTalker„ÄÅReadmoo„ÄÅÊô∫Âü∫ÁßëÊäÄ(Â≠∏ÊÄùÈÖ∑)<br>
                            <b>(3) ÂúãÂÖßÂ§ñÈÄÅÂπ≥Âè∞(‰∏çÂê´ÊúÉÂì°Ë≤ªÁî®)Ôºö</b><br>Uber Eats„ÄÅfoodpanda<br>
                            <b>(4) ÁîüÊ¥ªÂÆ∂Â±ÖÔºö</b><br>IKEAÂÆúÂÆ∂ÂÆ∂Â±Ö„ÄÅÁâπÂäõÂ±ã„ÄÅHOLA<br>
                            <b>(5) ÊåáÂÆöË∂ÖÂïÜË∂ÖÂ∏ÇÔºö</b><br>7-ELEVEN ÂØ¶È´îÈñÄÂ∏Ç(icash pay„ÄÅË°óÂè£ÊîØ‰ªò„ÄÅÊ©òÂ≠êÊîØ‰ªò)„ÄÅÂÖ®ÂÆ∂‰æøÂà©ÂïÜÂ∫ó(Ë°óÂè£ÊîØ‰ªò)„ÄÅÂÆ∂Ê®ÇÁ¶è<br>
                            <b>(6) ÈÅãÂãïÂÅ•Ë∫´Ôºö</b><br>World Gym„ÄÅBEING Fit„ÄÅCurves„ÄÅÂÅ•Ë∫´Â∑•Âª†<br>
                            <b>(7) ÂúãÂÖßÈ§êÂª≥Ôºö</b><br>ÂúãÂÖßÈ§êÂª≥(MCC 5811/5812/5814/5462)„ÄÅÈÄ£ÈéñÈÄüÈ£üÔºçÈ∫•Áï∂Âãû<br>
                            <b>(8) Ë°åÂãïÊîØ‰ªòÔºö</b><br>LINE Pay„ÄÅË°óÂè£ÊîØ‰ªò„ÄÅicash Pay„ÄÅÊ©òÂ≠êÊîØ‰ªò„ÄÅÊÇ†ÈÅä‰ªò„ÄÅHami Pay„ÄÅPiÈå¢ÂåÖ„ÄÅTWQR<br>
                            <b>(9) ‰∫§ÈÄöÔºö</b><br>‰∏ÄÂç°ÈÄöËá™ÂãïÂä†ÂÄº„ÄÅÈ´òÈêµ(Âê´È´òÈêµappÁ∑ö‰∏äÂà∑Âç°)<br>
                        </div>
                    </div>
                    
                    <div class="option-row" id="jiangTravelRow" style="border-top:1px dashed #ddd; padding-top:8px; margin-top:4px; flex-direction:column; align-items:flex-start;">
                          <div style="display:flex; justify-content:space-between; width:100%; align-items:center;">
                            <label for="checkJiangTravel">‚úàÔ∏è ÊóÖÈÅäÂä†Á¢º +4.5% (Âà∑$1.1Ëê¨/Â≠£Â∞ÅÈ†Ç)</label>
                            <input type="checkbox" id="checkJiangTravel" onchange="toggleJiangTravel()">
                        </div>
                        <button onclick="toggleJiangTravelDetails()" style="border:none; background:none; color:#007AFF; font-size:11px; cursor:pointer; padding:2px 0 6px 0;">üîΩ ÈªûÊìäÊü•ÁúãÊóÖÈÅä/Ëà™Á©∫/ÊóÖË°åÁ§æ</button>
                        <div id="jiangTravelDetails" class="details-content">
                            <b>(1) Êµ∑Â§ñÂèäËà™Á©∫Ôºö</b><br>Ê∂àË≤ªÂúãÂà•ÈùûÂè∞ÁÅ£ÊàñÂπ£Âà•ÈùûÂè∞Âπ£„ÄÅËà™Á©∫ MCC 3000~3350/4511/4723<br>(ÊòüÂÆá„ÄÅËèØËà™„ÄÅÈï∑Ê¶Æ„ÄÅÂúãÊ≥∞„ÄÅËôéËà™„ÄÅÈòøËÅØÈÖã„ÄÅÈÖ∑Ëà™„ÄÅÊ®ÇÊ°É„ÄÅÊç∑Êòü„ÄÅÊó•Ëà™„ÄÅANA„ÄÅ‰∫ûËà™„ÄÅËÅØÂêà„ÄÅË∂äÊç∑„ÄÅÂ§ßÈüì„ÄÅÈÅîÁæé„ÄÅÂúüËÄ≥ÂÖ∂„ÄÅÂç°ÈÅî„ÄÅÊ≥ïËà™)<br>
                            <b>(2) ÊóÖË°åÁ§æÔºö</b><br>ÊòìÈÅäÁ∂≤„ÄÅÈõÑÁçÖ„ÄÅÂèØÊ®Ç„ÄÅÊù±Âçó„ÄÅ‰∫îÁ¶è„ÄÅÁá¶Êòü„ÄÅÂ±±ÂØå„ÄÅÈï∑Ê±é„ÄÅÈ≥≥Âá∞„ÄÅÊòìÈ£õÁ∂≤„ÄÅÁêÜÊÉ≥„ÄÅÊ∞∏Âà©„ÄÅ‰∏âË≥Ä<br>
                        </div>
                    </div>
                    <div id="jiangTravelExpMsg" style="font-size:10px; color:#d32f2f; margin-top:2px; display:none;">‚ö†Ô∏è Ê¥ªÂãïÂ∑≤Êñº 3/31 ÁµêÊùü</div>
                    
                    <div id="jiangMinSpendWarning" style="display:none; margin-top:8px; padding:8px; background:#fff3e0; border-radius:6px; font-size:11px; color:#e65100;">
                        ‚ö†Ô∏è ÈúÄÁï∂ÊúàÁ¥ØÁ©çÊªø $3,000 Êâç‰∫´Âä†Á¢ºÂõûÈ•ã
                    </div>
                </div>

                <div id="dbsEcoOptions">
                      <div class="option-row read-only"><label>üî∞ ÂúãÂÖßÂ§ñ‰∏ÄËà¨ 1% (ÁÑ°‰∏äÈôê)</label><input type="checkbox" checked disabled></div>
                      
                      <div class="option-row" style="background:#fff3e0; padding:8px; border-radius:6px; margin-top:6px; flex-direction:column; align-items:flex-start;">
                          <div style="display:flex; justify-content:space-between; width:100%; align-items:center;">
                            <label for="checkDbsLinePay">‚ö° Êñ∞Êà∂ LINE Pay +9% (Âà∑$11,111Â∞ÅÈ†Ç)</label>
                            <input type="checkbox" id="checkDbsLinePay" onchange="toggleDbsLogic('linepay')">
                        </div>
                        <div style="font-size:10px; color:#d32f2f; margin-top:4px;">*‰∏äÈôê 1000 Èªû</div>
                      </div>
                      
                      <div class="option-row" style="margin-top:6px; border-top:1px dashed #ddd; padding-top:6px; flex-direction:column; align-items:flex-start;">
                          <div style="display:flex; justify-content:space-between; width:100%; align-items:center;">
                            <label for="checkDbsGreen">üåø Á∂†Ëâ≤/ÁâπÊñØÊãâ +9% (Âà∑$3,333Â∞ÅÈ†Ç)</label>
                            <input type="checkbox" id="checkDbsGreen" onchange="toggleDbsLogic('green')">
                        </div>
                        <button onclick="toggleDbsDetails()" style="border:none; background:none; color:#007AFF; font-size:11px; cursor:pointer; padding:2px 0 6px 0;">üîΩ ÈªûÊìäÊü•ÁúãÂä†Á¢ºË©≥ÊÉÖ</button>
                        <div id="dbsDetails" class="details-content">
                            <b>Á∂†Ëâ≤Ê∂àË≤ª (Âê´ÁâπÊñØÊãâ/Gogoro)Ôºö</b><br>Âä†Á¢º 9% (‰∏äÈôê 300 Èªû)„ÄÇ<br>ÈÄöË∑ØÔºöTeslaÂÖÖÈõª/ÈÖç‰ª∂„ÄÅGogoroÈõªÊ±†Ë≥áË≤ª„ÄÅÊòüÂ∑¥ÂÖã(Èö®Ë°åÂç°ÂÑ≤ÂÄº‰∏çÈÅ©Áî®)„ÄÅÈÆÆ‰π≥Âùä„ÄÅËå∂Á±ΩÂ†Ç„ÄÅÂè∞ÁÅ£Â§ßËªäÈöä„ÄÅiRent„ÄÅWeMo„ÄÅGoShare<br>
                        </div>
                      </div>

                      <div class="option-row" style="margin-top:6px; border-top:1px dashed #ddd; padding-top:6px;">
                          <label for="checkDbsForeign">‚úàÔ∏è ÂúãÂ§ñÂØ¶È´î +4% (Âà∑$1.5Ëê¨Â∞ÅÈ†Ç)</label>
                          <input type="checkbox" id="checkDbsForeign" onchange="toggleDbsLogic('foreign')">
                      </div>
                </div>
                
                <div id="happyOptions">
                      <div class="option-row read-only"><label>üî∞ Âü∫Êú¨ÂõûÈ•ã 0.5% (ÁÑ°‰∏äÈôê)</label><input type="checkbox" checked disabled></div>
                      <div class="option-row" style="flex-direction:column; align-items:flex-start; margin-bottom:10px; margin-top:6px;">
                          <div class="option-row" style="width:100%; justify-content:space-between;">
                              <label>üê∂ ÊåáÂÆöÂØµÁâ© +9.5%  <span id="happyPetRemain" style="font-size:10px;color:#aaa"></span></label>
                             <input type="checkbox" id="checkHappyPet" onchange="handleHappyExclusive('pet')">
                          </div>
                          <button onclick="toggleHappyPetDetails()" style="border:none; background:none; color:#007AFF; font-size:11px; cursor:pointer; padding:0 0 8px 24px; text-align:left;">üîΩ Êü•ÁúãÂØµÁâ©ÈÄöË∑Ø</button>
                          <div id="happyPetDetails" class="details-content" style="margin-left:8px; margin-bottom:8px;">
                            <b>(1) ÊåáÂÆöÂØµÁâ©ÈÄ£ÈéñÔºö</b><br>ÂØµÁâ©ÂÖ¨Âúí„ÄÅÊù±Ê£ÆÂØµÁâ©„ÄÅÈ≠ö‰∏≠È≠ö„ÄÅË≤ìÁãóÈöäÈï∑„ÄÅÊØõÂ≠©Â∏ÇÈõÜ„ÄÅÈáëÂêâÂà©„ÄÅÂ•ΩÁãóÂëΩ„ÄÅÂ•ΩÁãóÈÅã„ÄÅÈáëÁéãÂ≠ê„ÄÅÊÑõË≤ìÂúí„ÄÅÁ¶èÂ£ΩÂØµÁâ©ÊóóËâ¶È§®<br>
                            <b>(2) 2026 Êñ∞Â¢ûÂìÅÁâåÔºö</b><br>Ê±™ÂñµÊòüÁêÉ„ÄÅÊÄ™Áç∏ÈÉ®ËêΩ„ÄÅË∂ÖÂáùÂ∞èÂßê„ÄÅHero Mama<br>
                            <b>(3) ÈÜ´ÁôÇËàáÁæéÂÆπÔºö</b><br>Áç∏ÈÜ´Ë®∫ÊâÄ„ÄÅÂãïÁâ©ÈÜ´Èô¢„ÄÅÂØµÁâ©ÊóÖÈ§®„ÄÅÂØµÁâ©ÁæéÂÆπ (MCC 0742, 5995)<br>
                          </div>
                          
                          <div class="option-row" style="width:100%; justify-content:space-between;">
                              <label>üçΩÔ∏è ÊåáÂÆöÁîüÊ¥ª +3.5%  <span id="happyLifeRemain" style="font-size:10px;color:#aaa"></span></label>
                              <input type="checkbox" id="checkHappyLife" onchange="handleHappyExclusive('life')">
                          </div>
                          <button onclick="toggleHappyLifeDetails()" style="border:none; background:none; color:#007AFF; font-size:11px; cursor:pointer; padding:0 0 8px 24px; text-align:left;">üîΩ Êü•ÁúãÁôæË≤®/ÈáèË≤©/‰∫§ÈÄö</button>
                          <div id="happyLifeDetails" class="details-content" style="margin-left:8px; margin-bottom:8px;">
                            <b>(1) ÁôæË≤®/OutletÔºö</b><br>ÈÅ†Êù±ÁôæË≤®„ÄÅSOGO„ÄÅÂ∑®Âüé„ÄÅÂ§ßÈÅ†Áôæ„ÄÅÂçóÁ¥°„ÄÅÂ§¢ÊôÇ‰ª£„ÄÅskmpark„ÄÅÂ∞öÈ†Ü„ÄÅÂ§ßÈ≠ØÈñ£(Êπ≥ÈõÖ)„ÄÅÊ°ÉÁü•ÈÅì„ÄÅÂ§ßÊ±ü„ÄÅÂè∞ËåÇ„ÄÅÊñ∞Êúà„ÄÅÈÅ†ÈõÑ„ÄÅÂÆèÂåØ„ÄÅCITYLINK„ÄÅÁæéÈ∫óËèØ„ÄÅÂ§ßËëâÈ´òÂ≥∂Â±ã„ÄÅÁµ±‰∏ÄÊôÇ‰ª£„ÄÅÊïÖÂÆÆ„ÄÅÁßÄÊ≥∞„ÄÅÁí∞ÁêÉ„ÄÅIKEA„ÄÅÈ∫óÂØ∂„ÄÅLaLaport<br>
                            <b>(2) Ë∂ÖÂ∏ÇÈáèË≤©/ÁîüÊ©üÔºö</b><br>ÊÑõË≤∑„ÄÅÂÆ∂Ê®ÇÁ¶è„ÄÅÁæéÂªâÁ§æ„ÄÅÂ∞èÂåó„ÄÅÂ§ßË≤∑ÂÆ∂„ÄÅÂñú‰∫íÊÉ†„ÄÅÊ£âËä±Áî∞„ÄÅËÅñÂæ∑ÁßëÊñØ„ÄÅÊ∞∏Ë±êÈ§òÁîüÊäÄ„ÄÅÈáå‰ªÅ„ÄÅÂè∞ÁÅ£‰∏ªÂ©¶ËÅØÁõü„ÄÅÂÅ•Â∫∑È£üÂΩ©„ÄÅÂÆâÈ∫ó„ÄÅËë°Áúæ„ÄÅÁæéÊ®ÇÂÆ∂<br>
                            <b>(3) ‰∫§ÈÄöÈõª‰ø°Ôºö</b><br>ÂúãÂÖßÂä†Ê≤π(‰∏≠Ê≤π/Âè∞‰∫û/Âè∞Â°ë)„ÄÅgogoro„ÄÅTesla„ÄÅÂè∞ÁÅ£Â§ßËªäÈöä„ÄÅyoxi„ÄÅUber(Âè∞ÁÅ£)„ÄÅGoShare„ÄÅiRent„ÄÅWeMo„ÄÅÈÅ†ÂÇ≥/Âè∞Âì•Â§ßÂ∏≥ÂñÆ<br>
                            <b>(4) ÊïôËÇ≤/Êõ∏Â∫óÔºö</b><br>Âè∞ÁÅ£Ëî¶Â±ã„ÄÅË™†ÂìÅ„ÄÅÂçöÂÆ¢‰æÜ„ÄÅÈáëÁü≥Â†Ç„ÄÅÂ∑®Âå†„ÄÅËÅØÊàê„ÄÅÊú±ÂÆóÊÖ∂„ÄÅÈõ≤ÈñÄ<br>
                          </div>
                          
                          <div class="option-row" style="width:100%; justify-content:space-between;">
                              <label>üì° ÊåáÂÆöÂÆâÂøÉ +3.5%  <span id="happyPeaceRemain" style="font-size:10px;color:#aaa"></span></label>
                              <input type="checkbox" id="checkHappyPeace" onchange="handleHappyExclusive('peace')">
                          </div>
                            <button onclick="toggleHappyPeaceDetails()" style="border:none; background:none; color:#007AFF; font-size:11px; cursor:pointer; padding:0 0 8px 24px; text-align:left;">üîΩ Êü•ÁúãÈ§êÂª≥/Ëó•Â±Ä/Â±ÖÂÆ∂</button>
                            <div id="happyPeaceDetails" class="details-content" style="margin-left:8px; margin-bottom:8px;">
                            <b>(1) ÂúãÂÖßÈ§êÂª≥Ôºö</b><br>ÂúãÂÖßÂêÑÂ§ßÊåáÂÆöÈ§êÂª≥ (MCC 5811, 5812, 5813, 5814)<br>
                            <b>(2) Â©¶ÂπºËó•Â±Ä/Â±ÖÂÆ∂Ôºö</b><br>Â§ßÊ®π„ÄÅÊùè‰∏Ä„ÄÅÁ∂≠Â∫∑„ÄÅË∫çÁçÖ„ÄÅÂç°Â§öÊë©„ÄÅÂÆúÂÖíÊ®Ç„ÄÅÁáüÈ§äÈäÄË°å„ÄÅÈ∫óÂÖíÈááÂÆ∂„ÄÅÂ™ΩÂí™Ê®ÇÂ±ÖÂÆ∂ÊúçÂãô„ÄÅÊΩîÂÆ¢Âπ´<br>
                            <b>(3) ÈÅãÂãïÂÅ•Ë∫´Ôºö</b><br>‰ΩêÁôªÂ¶ÆÁµ≤„ÄÅÂÅ•Ë∫´Â∑•Âª†„ÄÅWorld Gym„ÄÅBEING spa„ÄÅBEING sport„ÄÅCurvesÂèØÁàæÂßø<br>
                           </div>

                          <div class="option-row" style="width:100%; justify-content:space-between;">
                              <label>‚úàÔ∏è ÂúãÂ§ñÊ∂àË≤ª +2.0% </label>
                              <input type="checkbox" id="checkHappyForeign" onchange="handleHappyExclusive('foreign')">
                          </div>
                      </div>
                    <div id="happyDashboard" class="happy-dashboard"></div>
                    
                    <div id="happyMinSpendWarning" style="display:none; margin-top:8px; padding:8px; background:#fff3e0; border-radius:6px; font-size:11px; color:#e65100;">
                        ‚ö†Ô∏è ÈúÄÁï∂ÊúàÁ¥ØÁ©çÊªø $3,000 Êâç‰∫´Âä†Á¢ºÔºõÊªø $26,000 È°çÂ§ñÈÄÅ $400
                    </div>
                    
                    <div id="happyOverseasWarning" style="display:none; margin-top:8px; padding:8px; background:#ffebee; border-radius:6px; font-size:11px; color:#c62828;">
                        ‚ö†Ô∏è ÂúãÂ§ñÂÉÖ‰∫´ +2% ÂúãÂ§ñÂä†Á¢ºÔºåÂÖ∂‰ªñÈÄöË∑ØÂä†Á¢º‰∏çÈÅ©Áî®
                    </div>
                </div>

                <div id="hsbcOptions">
                      <div class="option-row" style="border-bottom:1px solid #eee; padding-bottom:10px; margin-bottom:10px;">
                        <span style="font-weight:700; color:#333;">üí≥ ÈÅ∏ÊìáÊÇ®ÁöÑÂç°ÁâáÁ≠âÁ¥ö (Ëá™ÂãïË®òÊÜ∂)Ôºö</span>
                        <div style="display:flex; gap:15px; margin-top:8px;">
                         <label style="display:flex; align-items:center; font-weight:normal; font-size:13px;"><input type="radio" name="hsbcTier" value="light" onchange="saveHsbcTier()"> ËºïÊóÖÂç°</label>
                            <label style="display:flex; align-items:center; font-weight:normal; font-size:13px;"><input type="radio" name="hsbcTier" value="signature" onchange="saveHsbcTier()"> Âæ°ÁíΩÂç°</label>
                            <label style="display:flex; align-items:center; font-weight:normal; font-size:13px;"><input type="radio" name="hsbcTier" value="infinite" onchange="saveHsbcTier()"> ÁÑ°ÈôêÂç°</label>
                        </div>
                    </div>
                    <div class="option-row"><label for="hsbcInitialMiles">üèÅ Â∑≤ÊúâÂì©Á®ã (Ëµ∑ÂßãÂÄº)</label><input type="number" id="hsbcInitialMiles" onchange="saveHsbcInitial()" style="text-align:right; width: 100px; border:1px solid #ccc; border-radius:4px; padding:4px;" placeholder="0"></div>
                    <div class="option-row"><label for="hsbcRedeemedMiles" style="color:#d32f2f;">‚ûñ Â∑≤ÂÖåÊèõÂì©Á®ã</label><input type="number" id="hsbcRedeemedMiles" onchange="saveHsbcSettings()" style="text-align:right; width: 100px; border:1px solid #ffcdd2; color:#d32f2f; border-radius:4px; padding:4px;" placeholder="0"></div>
                      <div class="option-row" style="margin-top:10px; border-top:1px dashed #ddd; padding-top:6px;"><label for="checkHsbcForeign">‚úàÔ∏è ÂúãÂ§ñÊ∂àË≤ª</label><input type="checkbox" id="checkHsbcForeign" onchange="updateRewardPreview()"></div>
                </div>
                
                <div id="richartOptions">
                    <div style="font-size:12px; color:#D32F2F; background:#FFEBEE; padding:8px; border-radius:6px; margin-bottom:10px; font-weight:700; border:1px solid #FFCDD2;">
                        ‚ö†Ô∏è ÈúÄÁ∂ÅÂÆö Richart Â∏≥Êà∂Ëá™ÂãïÊâ£Áπ≥ (Êú™Á∂ÅÂÉÖ0.3%)
                    </div>
                    <div class="option-row"><label for="rbRichartGeneral">üî∞ ‰∏ÄËà¨Ê∂àË≤ª (0.3%)</label><input type="radio" name="richartMode" id="rbRichartGeneral" value="general" checked onchange="toggleRichartLogic()"></div>
                    <div class="option-row"><label for="rbRichartTaishinPay">üì± PayËëóÂà∑ÔºçÂè∞Êñ∞Pay (3.8%)</label><input type="radio" name="richartMode" id="rbRichartTaishinPay" value="taishinpay" onchange="toggleRichartLogic()"></div>
                    <div class="option-row"><label for="rbRichartLinePay">üü¢ PayËëóÂà∑ÔºçLINE Pay (2.3%)</label><input type="radio" name="richartMode" id="rbRichartLinePay" value="linepay" onchange="toggleRichartLogic()"></div>
                    <div class="option-row"><label for="rbRichartPlan33">üìã ÊåáÂÆöÊñπÊ°à (3.3%)</label><input type="radio" name="richartMode" id="rbRichartPlan33" value="plan33" onchange="toggleRichartLogic()"></div>
                    <div id="richartPlan33Sub" style="display:none; margin-left:28px; margin-top:4px; margin-bottom:4px;">
                        <select id="selRichartPlan33" onchange="toggleRichartLogic()" style="width:100%; padding:6px 8px; border-radius:6px; border:1px solid #ccc; font-size:13px;">
                            <option value="tianti">Â§©Â§©Âà∑ (Ë∂ÖÂïÜÈáèË≤©/ÈÄöÂã§‰∫§ÈÄö/Ëó•Â¶ùËó•Â±Ä)</option>
                            <option value="dabi">Â§ßÁ≠ÜÂà∑ (ÊåáÂÆöÁôæË≤®/Outlet/Â±ÖÂÆ∂Ë£ù‰øÆ)</option>
                            <option value="haoxiang">Â•ΩÈ•óÂà∑ (È§êÈ£≤/Â§ñÈÄÅ/Ë®ÇÊàø/Â®õÊ®Ç)</option>
                            <option value="shuqu">Êï∏Ë∂£Âà∑ (Á∂≤Ë≥º/Á∑ö‰∏äË™≤Á®ã/ÈÅäÊà≤ÂΩ±Èü≥)</option>
                            <option value="wanlv">Áé©ÊóÖÂà∑ (Êµ∑Â§ñÊ∂àË≤ª/Ëà™Á©∫/Ë®ÇÊàøÊóÖË°å)</option>
                        </select>
                    </div>
                    <div class="option-row"><label for="rbRichartHoliday">üéâ ÂÅáÊó•Âà∑ (2%)</label><input type="radio" name="richartMode" id="rbRichartHoliday" value="holiday" onchange="toggleRichartLogic()"></div>
                    <div class="option-row" id="rbRichartJpPaypayRow" style="display:none; border-top:1px dashed #ddd; margin-top:6px; padding-top:6px;">
                        <label for="rbRichartJpPaypay">üáØüáµ Âè∞Êñ∞Pay+ Êó•Êú¨PayPay (3.8%+ÂÖç1.5%ÊâãÁ∫åË≤ª)</label>
                        <input type="radio" name="richartMode" id="rbRichartJpPaypay" value="jpPaypay" onchange="toggleRichartLogic()">
                    </div>
                    <div id="richartJpPaypayNote" style="display:none; font-size:10px; color:#555; margin-top:4px; opacity:0.8;">
                        üí° ÈúÄÊê≠ÈÖç PayËëóÂà∑ Ê¨äÁõäÔºåÈÄèÈÅé Richart Life APP ÊéÉÁ¢º‰ªòÊ¨æ
                    </div>
                    <div style="font-size:10px; color:#555; margin-top:8px; opacity:0.8;">
                        üí° Â∞èÊíáÊ≠•ÔºöËã•Á∂≤Ë≥º‰ΩøÁî®Âè∞Êñ∞PayÔºåË´ãÂãæÈÅ∏„ÄåPayËëóÂà∑ÔºçÂè∞Êñ∞Pay (3.8%)„Äç
                    </div>
                </div>

               <div id="fubonJOptions">
                    <div class="option-row read-only"><label id="labelFubonJBase">üî∞ ÂúãÂÖßÊ∂àË≤ª 1% (ÁÑ°‰∏äÈôê)</label><input type="checkbox" checked disabled></div>
                    
                    <!-- Êó•ÈüìÂ∞àÂ±¨ÂçÄÂ°ä -->
                    <div id="fubonJJpkrSection" style="border-top:1px dashed #ddd; padding-top:8px; margin-top:8px;">
                        <div class="option-row">
                            <label for="checkFubonJJpkr">üáØüáµüá∞üá∑ Êó•ÈüìÊ∂àË≤ª (Âü∫Êú¨ 3%)</label>
                            <input type="checkbox" id="checkFubonJJpkr" onchange="toggleFubonJJpkr()">
                        </div>
                        
                        <div class="option-row" id="rowFubonJJpkrBonus" style="margin-top:6px; padding-left:20px;">
                            <label for="checkFubonJJpkrBonus">üõçÔ∏è Êó•ÈüìÂØ¶È´î +3%</label>
                            <input type="checkbox" id="checkFubonJJpkrBonus" onchange="toggleFubonJJpkrBonus()">
                        </div>
                        <div id="fubonJJpkrMinSpend" style="font-size:10px; color:#888; margin-top:2px; padding-left:20px;"></div>
                        
                        <div class="option-row" id="rowFubonJSuica" style="margin-top:6px; padding-left:20px;">
                            <label for="checkFubonJSuica">üçé Êó•Êú¨‰∫§ÈÄöÂç° +7%</label>
                            <input type="checkbox" id="checkFubonJSuica" onchange="toggleFubonJSuica()">
                        </div>
                        <div id="fubonJSuicaMinSpend" style="font-size:10px; color:#888; margin-top:2px; padding-left:20px;"></div>
                    </div>
                    
                    <!-- Ê≥∞ÂúãÂ∞àÂ±¨ÂçÄÂ°ä -->
                    <div id="fubonJThSection" style="border-top:1px dashed #ddd; padding-top:8px; margin-top:8px;">
                        <div class="option-row">
                            <label for="checkFubonJTh">üáπüá≠ Ê≥∞ÂúãÊ∂àË≤ª (Âü∫Êú¨ 1%)</label>
                            <input type="checkbox" id="checkFubonJTh" onchange="toggleFubonJTh()">
                        </div>
                        
                        <div class="option-row" id="rowFubonJThBonus" style="margin-top:6px; padding-left:20px;">
                            <label for="checkFubonJThBonus">üõçÔ∏è Ê≥∞ÂúãÂØ¶È´î +5%</label>
                            <input type="checkbox" id="checkFubonJThBonus" onchange="toggleFubonJThBonus()">
                        </div>
                        <div id="fubonJThMinSpend" style="font-size:10px; color:#888; margin-top:2px; padding-left:20px;"></div>
                    </div>
                    
                    <div id="fubonJMinSpendWarning" style="display:none; margin-top:8px; padding:8px; background:#ffebee; border-radius:6px; font-size:11px; color:#c62828;"></div>
                </div>

                <div id="jiheOptions">
                    <div class="option-row read-only"><label id="labelJiheBase">üî∞ ÂúãÂÖßÊ∂àË≤ª 1% (ÁÑ°‰∏äÈôê)</label><input type="checkbox" checked disabled></div>
                    
                    <!-- ÂúãÂÖßÂ∞àÂ±¨ÔºöÊó•Á≥ªÂêçÂ∫ó -->
                    <div class="option-row" id="rowJiheDomesticJapanese" style="border-top:1px dashed #ddd; padding-top:6px; flex-direction:column; align-items:flex-start;">
                        <div style="display:flex; justify-content:space-between; width:100%; align-items:center;">
                             <label for="checkJiheDomesticJapanese">üáπüáº ÂúãÂÖßÊó•Á≥ªÂêçÂ∫ó +4% (Âà∑$1.25Ëê¨Â∞ÅÈ†Ç)</label>
                             <input type="checkbox" id="checkJiheDomesticJapanese" onchange="toggleJiheDomestic()">
                        </div>
                        <button onclick="toggleJiheDetails()" style="border:none; background:none; color:#007AFF; font-size:11px; cursor:pointer; padding:2px 0 6px 0;">üîΩ ÈªûÊìäÊü•ÁúãÊåáÂÆöÈÄöË∑Ø</button>
                        <div id="jiheDetails" class="details-content">
                            <b>(1) ÊúçÈ£æÔºö</b><br>UNIQLO„ÄÅGU„ÄÅÊÄùÂ§¢Ê®Ç„ÄÅGLOBAL WORK„ÄÅniko and ‚Ä¶„ÄÅLOWRYS FARM„ÄÅLAKOLE„ÄÅstudio CLIP„ÄÅrepipi armario„ÄÅHARE„ÄÅHeather„ÄÅPAGEBOY„ÄÅRAGEBLUE„ÄÅLEPSIM„ÄÅJEANASIS<br>
                            <b>(2) ÁîüÊ¥ª/Ëó•Â¶ùÔºö</b><br>DAISOÂ§ßÂâµ„ÄÅStandard Products„ÄÅTHREEPPY„ÄÅÊó•Ëó•Êú¨Ëàñ„ÄÅÊùæÊú¨Ê∏Ö„ÄÅTomod's„ÄÅÊú≠ÂπåËó•Â¶ù„ÄÅTSUTAYA BOOKSTORE„ÄÅHANDSÂè∞ÈöÜÊâãÂâµÈ§®„ÄÅÂÆúÂæóÂà©ÂÆ∂Â±Ö<br>
                        </div>
 
                    </div>
                    
                    <!-- Êó•Êú¨Â∞àÂ±¨ÂçÄÂ°ä -->
                    <div id="jiheJapanSection" style="border-top:1px dashed #ddd; padding-top:8px; margin-top:8px;">
                        <div class="option-row">
                            <label for="checkJiheJapan">üáØüáµ Êó•Êú¨Ê∂àË≤ª (Âü∫Êú¨ 2.5%)</label>
                            <input type="checkbox" id="checkJiheJapan" onchange="toggleJiheJapan()">
                        </div>
                        
                        <div class="option-row" id="rowJiheApple" style="margin-top:6px; padding-left:20px;">
                            <label for="checkJiheApple">üçé Apple Pay +1.5% (Âà∑$4Ëê¨Â∞ÅÈ†Ç)</label>
                            <input type="checkbox" id="checkJiheApple" onchange="toggleJiheApple()">
                        </div>
                        <div style="font-size:10px; color:#888; margin-top:2px; padding-left:20px;">‚ö†Ô∏è ÈúÄÂñÆÁ≠ÜÁ≠âÂÄºÂè∞Âπ£ $100ÔºåÂãæÈÅ∏Ëá™ÂãïÂàáÊèõÁÇ∫Êó•Êú¨Ê∂àË≤ª</div>
                    </div>
                </div>
                
               <div id="kumamonOptions">
                    <div class="option-row read-only"><label id="labelKumamonBase">üî∞ ÂúãÂÖßÊ∂àË≤ª 0.5% (ÁÑ°‰∏äÈôê)</label><input type="checkbox" checked disabled></div>
                    
                    <!-- Êó•Êú¨Ê∂àË≤ªÂçÄÂ°ä -->
                    <div id="kumamonJapanSection" style="border-top:1px dashed #ddd; padding-top:8px; margin-top:8px;">
                        <div class="option-row"><label for="checkKumamonJapan">üáØüáµ Êó•Êú¨Ê∂àË≤ª (Âü∫Êú¨ 2.5%)</label><input type="checkbox" id="checkKumamonJapan" onchange="toggleKumamonJapan()"></div>
                        
                        <div id="groupKumamonJapan" style="display:none;">
                            <div class="option-row" style="padding-top:6px; padding-left:20px; flex-direction:column; align-items:flex-start;">
                                <div style="display:flex; justify-content:space-between; width:100%; align-items:center;">
                                    <label for="checkKumamonDesignated">üêª ÊåáÂÆöÈÄöË∑Ø +6% (Âà∑$8,333Â∞ÅÈ†Ç)</label>
                                    <input type="checkbox" id="checkKumamonDesignated" onchange="toggleKumamonDesignated()">
                                </div>
                                <button onclick="toggleKumamonDetails()" style="border:none; background:none; color:#007AFF; font-size:11px; cursor:pointer; padding:2px 0 6px 0;">üîΩ ÈªûÊìäÊü•ÁúãÊåáÂÆöÈÄöË∑Ø (ÁÜäÂ•ΩÁ≥ªÂàó)</button>
                                <div id="kumamonDetails" class="details-content">
                                    <b>(1) ÁÜäÂ•ΩÈÅä (‰∫§ÈÄö/‰ΩèÂÆø)Ôºö</b><br>‰∫§ÈÄöICÂç°ÔºöSUICA„ÄÅPASMO„ÄÅICOCA<br>Ëá™ÈßïÁßüËªäÔºöTOYOTA Rent a Car„ÄÅTimes Car Rental„ÄÅNIPPON RENT-A-CAR„ÄÅOTSÁßüËªä„ÄÅORIXÁßüËªä<br>ÈêµË∑Ø/Ëà™Á©∫ÔºöJRÈêµË∑ØÂÖ¨Âè∏„ÄÅÊó•Êú¨Ëà™Á©∫<br>‰ΩèÂÆøÔºöÊ®ÇÂ§©ÊóÖÈÅä„ÄÅÊù±Ê©´INN„ÄÅÊòüÈáéÈõÜÂúò<br>
                                    <b>(2) ÁÜäÂ•ΩÁé© (Ê®ÇÂúí)Ôºö</b><br>Êù±‰∫¨Ëø™Â£´Â∞º„ÄÅËèØÁ¥çÂÖÑÂºüÂìàÂà©Ê≥¢ÁâπÂΩ±Âüé„ÄÅÊó•Êú¨Áí∞ÁêÉÂΩ±Âüé„ÄÅË±™ÊñØÁôªÂ†°„ÄÅ‰πùÂ∑ûÈùûÊ¥≤ÁçÖÊ®ÇÂúí„ÄÅÂêçÂè§Â±ãÊ®ÇÈ´òÊ®ÇÂúí„ÄÅÂêâ‰ºäÂç°ÂìáÊ®ÇÂúí<br>
                                    <b>(3) ÁÜäÂ•ΩÂêÉ (È§êÈ£≤)Ôºö</b><br>ÁáíËÇâÔºöÂãùÁÉà‰∫≠„ÄÅÊïòÊïòËãë„ÄÅÁâõËßí„ÄÅÂäõ‰∏∏ÁáíËÇâ„ÄÅÂÖ≠Ê≠å‰ªô<br>Êº¢Â†°/ÂíñÂï°Ôºöshake shack„ÄÅDOUTOR Coffee„ÄÅFuglen<br>ÂÖ∂‰ªñÔºöÈ≥•Ë≤¥Êóè„ÄÅ‰∏ÄËò≠ÊãâÈ∫µ„ÄÅÊùæÂ±ã„ÄÅSUKIYA„ÄÅÂ£ΩÂè∏ÈÉé„ÄÅËóèÂ£ΩÂè∏<br>
                                    <b>(4) ÁÜäÂ•ΩË≤∑ (Ë≥ºÁâ©)Ôºö</b><br>ÂÆ∂Èõª/Ëó•Â¶ùÔºöBicCamera„ÄÅYodobashi„ÄÅÊùæÊú¨Ê∏Ö„ÄÅÂîêÂêâËªªÂæ∑„ÄÅÂ§ßÂúãËó•Â¶ù<br>ÁîüÊ¥ª/ÂïÜÂüéÔºöÁÑ°Âç∞ËâØÂìÅ„ÄÅÊó•Êú¨MITSUIË≥ºÁâ©ÂúíÂçÄ<br>ÊúçÈ£æÔºöUNIQLO„ÄÅGU
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- PayPay Áç®Á´ãÂçÄÂ°äÔºàËàáÊó•Êú¨Ê∂àË≤ª‰∫íÊñ•Ôºâ -->
                    <div id="kumamonPayPaySection" style="border-top:1px dashed #ddd; padding-top:8px; margin-top:8px;">
                        <div class="option-row" style="flex-direction:column; align-items:flex-start;">
                            <div style="display:flex; justify-content:space-between; width:100%; align-items:center;">
                                <label for="checkKumamonPayPay">üì± Êó•Êú¨ PayPay 5% (Â≠£Âà∑$2,857Â∞ÅÈ†Ç)</label>
                                <input type="checkbox" id="checkKumamonPayPay" onchange="toggleKumamonPayPay()">
                            </div>
                            <div style="font-size:10px; color:#888; margin-top:2px;">Âê´ 3.5% ÂõûÈ•ã + ÂÖç 1.5% Êµ∑Â§ñ‰∫§ÊòìÊâãÁ∫åË≤ª</div>
                        </div>
                    </div>
                </div>
                
                <div id="sinopacCurrencyOptions">
                    <div class="option-row" style="background:#eee; padding:8px; border-radius:6px; margin-bottom:8px; flex-direction:column; align-items:flex-start;">
                          <label style="margin-bottom:4px; color:#555;">üí∞ ÈÅ∏ÊìáË≥áÊ†ºÁ≠âÁ¥ö (Ëá™ÂãïË®òÊÜ∂)</label>
                          <div style="display:flex; gap:10px; width:100%;">
                              <label style="font-weight:normal; font-size:12px; display:flex; align-items:center;"><input type="radio" name="currencyLevel" value="low" onchange="saveCurrencyLevel()" checked> Â§ßÂ§ßÁ≠âÁ¥ö (Level 1)</label>
                              <label style="font-weight:normal; font-size:12px; display:flex; align-items:center;"><input type="radio" name="currencyLevel" value="high" onchange="saveCurrencyLevel()"> Â§ßÊà∂Á≠âÁ¥ö (Level 2)</label>
                          </div>
                          <div style="font-size:10px; color:#999; margin-top:2px;">Â§ßÂ§ß: Ëá™ÂãïÊâ£Áπ≥+ÈõªÂ≠êÂ∏≥ÂñÆ | Â§ßÊà∂: ÂæÄ‰æÜË≥áÁî¢‚â•10Ëê¨</div>
                    </div>
                    
                    <div class="option-row read-only"><label id="labelCurrencyBase">üî∞ ÂúãÂÖß‰∏ÄËà¨ 1%</label><input type="checkbox" checked disabled></div>

                    <div class="option-row"><label>üáπüáº ÂúãÂÖßÊ∂àË≤ª</label><input type="radio" name="currencyType" value="domestic" checked onchange="toggleCurrencyLogic()"></div>

                    <div class="option-row" style="border-top:1px dashed #ddd; padding-top:6px; flex-direction:column; align-items:flex-start;">
                        <div style="display:flex; justify-content:space-between; width:100%; align-items:center;">
                            <label for="rbCurrencySelected">‚úàÔ∏è Êµ∑Â§ñ/Á≤æÈÅ∏ +4% (Ë¶ãÁ≠âÁ¥öÂ∞ÅÈ†Ç)</label>
                            <input type="radio" name="currencyType" id="rbCurrencySelected" value="selected" onchange="toggleCurrencyLogic()">
                        </div>

                        <button onclick="toggleCurrencyDetails()" style="border:none; background:none; color:#007AFF; font-size:11px; cursor:pointer; padding:0 0 6px 0;">üîΩ ÈªûÊìäÊü•ÁúãÁ≤æÈÅ∏ÈÄöË∑Ø</button>
                        <div id="currencyDetails" class="details-content">
                            <b>(1) ÂúãÂ§ñÂØ¶È´îÔºö</b><br>ÈùûÂè∞ÁÅ£Âú∞ÂçÄ‰∏îÈùûÂè∞Âπ£‰πã‰∏ÄËà¨‰∫§Êòì<br>
                            <b>(2) Á∂≤Ë≥ºÊ∂àË≤ªÔºö</b><br>Suica/PASMO/ICOCAÂÑ≤ÂÄº„ÄÅAmazon„ÄÅRakuten„ÄÅÊ∑òÂØ∂„ÄÅeBay„ÄÅGmarket„ÄÅiHerb„ÄÅSelfridge„ÄÅMercari„ÄÅÂ§ßÂúãËó•Â¶ù„ÄÅSugiËó•Â¶ù„ÄÅOlive Young<br>
                            <b>(3) ÊóÖÈÅäÈÄöË∑ØÔºö</b><br>Ëà™Á©∫ÂÖ¨Âè∏„ÄÅÊóÖË°åÁ§æ„ÄÅBooking.com„ÄÅAgoda„ÄÅHotels.com„ÄÅExpedia„ÄÅTrip.com„ÄÅAirbnb„ÄÅKlook„ÄÅKKday„ÄÅTrivago„ÄÅAsiaYo„ÄÅÊ≠êÁâπÂÑÄÊùæÂ±±Ê©üÂ†¥ÂÅúËªä<br>
                        </div>
                    </div>
                </div>

                <div id="sinopacMitsuiOptions">
                    <div class="option-row read-only"><label id="labelMitsuiBase">üî∞ ‰∏ÄËà¨Ê∂àË≤ª 0.3% (È§®Â§ñ/ÂúãÂ§ñ)</label><input type="checkbox" checked disabled></div>
                    
                    <div class="option-row" style="border-top:1px dashed #ddd; padding-top:6px; display:flex; flex-direction:column; align-items:flex-start;">
                        <div style="display:flex; justify-content:space-between; width:100%; align-items:center;">
                            <label for="checkSinopacMitsuiSelected">üçΩÔ∏è ÁâπÈÅ∏È§êÈ£≤ +7% (ÂÖ±7.3%)</label>
                            <input type="checkbox" id="checkSinopacMitsuiSelected" onchange="toggleSinopacMitsui('selected')">
                        </div>

                        <div style="font-size:10px; color:#aaa; margin-top:2px; line-height:1.3;">
                            ÈÄöË∑ØÔºöÈ§®Â§ñÈ§êÈ£≤(MCC 58xx) / ÂÖ®Áõà+PAY<br>
                            <span style="color:#d32f2f; font-weight:bold;">‚ö†Ô∏è ‰∏äÈôêÂÉÖ 100 ÂÖÉ (Á¥ÑÂà∑ $1,428)</span>
                        </div>
                    </div>
                    
                    <div class="option-row" style="background:#fff3e0; padding:8px; border-radius:6px; margin-top:6px;"><label for="checkSinopacMitsuiTarget">üáØüáµ Êó•ÈüìÊ≥∞ÂØ¶È´î (Êªø3Ëê¨ÈÄÅ2000/ÈúÄÁôªÈåÑ)</label><input type="checkbox" id="checkSinopacMitsuiTarget" onchange="toggleSinopacMitsui('target')"></div>
                </div>

                <div id="sinopacJcbOptions">
                    <div class="option-row read-only"><label id="labelJcbBase">üî∞ ÂúãÂÖßÊ∂àË≤ª 1%</label><input type="checkbox" checked disabled></div>
                    
                    <div class="option-row"><label for="checkSinopacJcbForeign">‚úàÔ∏è ÂúãÂ§ñÊ∂àË≤ª (1% ‚Üí 2%)</label><input type="checkbox" id="checkSinopacJcbForeign" onchange="updateRewardPreview()"></div>
                    
                    <div class="option-row" style="flex-direction:column; align-items:flex-start; gap:0; border-top:1px dashed #ddd; padding-top:6px;">
                        <div style="display:flex; justify-content:space-between; width:100%; align-items:center;">
                             <label for="checkSinopacJcbBonus">üáØüáµ Êó•Êú¨ / üõçÔ∏è ÁâπÈÅ∏ +3% (ÊúàÂà∑1Ëê¨Â∞ÅÈ†Ç)</label>
                             <input type="checkbox" id="checkSinopacJcbBonus" onchange="updateRewardPreview()">
                        </div>
                        <button onclick="toggleSinopacJcbDetails()" style="border:none; background:none; color:#007AFF; font-size:11px; cursor:pointer; padding:2px 0 6px 0;">üîΩ ÈªûÊìäÊü•ÁúãÈÄöË∑Ø (Á∂≤Ë≥º/ÁôæË≤®/È§êÂª≥)</button>
                        <div id="sinopacJcbDetails" class="details-content">
                            <b>(1) Á∂≤Ë≥ºÔºö</b><br>Ëù¶ÁöÆ„ÄÅmomo„ÄÅPChome„ÄÅYahoo„ÄÅÊù±Ê£Æ„ÄÅÂçöÂÆ¢‰æÜ...<br>
                            <b>(2) ÁôæË≤®Ôºö</b><br>Êº¢Á•û„ÄÅÈÅ†Êù±„ÄÅSOGO„ÄÅ101...<br>
                            <b>(3) È§êÂª≥Ôºö</b><br>ÁéãÂìÅÈõÜÂúò„ÄÅÈºéÊ≥∞Ë±ê...<br>
                        </div>
                    </div>
                    
                    <div class="option-row" style="background:#fff3e0; padding:8px; border-radius:6px; margin-top:6px; flex-direction:column; align-items:flex-start;">
                          <div style="display:flex; justify-content:space-between; width:100%; align-items:center;">
                             <label for="checkSinopacJcbQuarterly">üî• Êó•ÈüìÊ≥∞ÊªøÈ°ç +5% (Â≠£/ÂÖ±Áî®‰∏äÈôê)</label>
                             <input type="checkbox" id="checkSinopacJcbQuarterly" onchange="updateRewardPreview()">
                            </div>
                            <div style="font-size:10px; color:#d32f2f; margin-top:2px;">ÈúÄÁôªÈåÑÔºåÊªø2Ëê¨ÈÄÅ1000 (‰∏äÈôê1000)</div>
                    </div>
                </div>
                
                <div class="input-group" style="margin-top:15px; border-top:1px solid #eee; padding-top:15px;">
                    <label style="margin-bottom:4px;">üìÖ Ê∂àË≤ªÊó•Êúü</label>
                    <input type="date" id="dateInput" style="font-size:16px; padding:8px; text-align:left;">
                </div>

                <div class="input-group" style="margin-top:10px;">
                    <input type="number" id="amountInput" placeholder="ÈáëÈ°ç" inputmode="numeric" style="font-size:32px; text-align:center; border:2px solid #007AFF; border-radius:12px; background:#f0f8ff; padding:12px; font-weight:800;" oninput="updateRewardPreview()" onkeyup="updateRewardPreview()" onpaste="updateRewardPreview()">
                    <div id="twdConversionDisplay" style="text-align:center; font-size:14px; color:#666; margin-top:6px; display:none;">
                        ‚âà TWD <span id="twdAmount">0</span>
                    </div>
                    <div id="thresholdWarning" class="threshold-warning">‚ö†Ô∏è Êú™Êªø $100ÔºåÂÉÖ‰∫´ 1% ÂõûÈ•ã</div>
                    <div id="liveRewardCalc"></div>
                </div>
                
               <div class="input-group"><input type="text" id="noteInput" placeholder="ÂÇôË®ª (‰æãÂ¶Ç: ÂçàÈ§ê)" style="font-size:14px; color:#666; border:1px solid #ddd;"></div>
                <div class="btn-group">
                    <button class="btn btn-cancel" onclick="document.getElementById('transactionModal').style.display='none'">ÂèñÊ∂à</button>
                    <button class="btn btn-again" onclick="addTransaction(false)">üîÑ ÂÜçË®ò‰∏ÄÁ≠Ü</button>
                    <button class="btn btn-confirm" id="btn-confirm" onclick="addTransaction(true)">Á¢∫Ë™ç</button>
                </div>
            </div>
            <div class="modal-history-section">
               <div class="modal-history-title" id="modalHistoryTitle">
                    <div style="display:flex; align-items:center; gap:6px;">
                        <span onclick="shiftHistoryMonth(-1)" style="cursor:pointer; font-size:16px; padding:2px 6px;">‚óÄ</span>
                        <span id="historyMonthLabel">üìÖ Êú¨ÊúüÊ∂àË≤ªÁ¥ÄÈåÑ</span>
                        <span id="historyNextBtn" onclick="shiftHistoryMonth(1)" style="cursor:pointer; font-size:16px; padding:2px 6px; visibility:hidden;">‚ñ∂</span>
                    </div>
                    <span style="font-weight:normal; font-size:10px; color:#aaa;">(ÈªûÊìä‰øÆÊîπ / ‚úï Âà™Èô§)</span>
                </div>
                <div id="modalHistoryList" style="max-height:40vh; overflow-y:auto;"></div>
            </div>
        </div>
    </div>
    
    <div id="manageModal" class="modal" onclick="if(event.target===this) document.getElementById('manageModal').style.display='none'">
        <div class="modal-content" style="max-height:80vh; overflow-y:auto; padding-top:15px;">
            <h2 style="margin: 0 0 4px 0; font-size: 18px; font-weight: 800; color:#333;">ÁÆ°ÁêÜÊàëÁöÑÂç°Áâá</h2>
            
            <div class="manage-tools">
                 <div class="tools-header">
                     <div style="font-size:12px; color:#888;">ÊÉÖÂ¢ÉÂø´ÁÖßËàáÂ∑•ÂÖ∑</div>
                     <div style="display:flex; gap:8px;">
                         <button class="btn-tool-small" onclick="clearVisibleCards()">üßπ ‰∏ÄÈçµÊ∏ÖÁ©∫</button>
                         <button class="btn-tool-small" style="background:#007AFF; color:white; border:none;" onclick="saveCurrentScene()">üíæ Â≠òÊàêÊÉÖÂ¢É</button>
                     </div>
                 </div>
                 <div id="sceneList" class="scene-container"></div>
            </div>
            
            <div class="manage-search-container">
                 <div class="manage-search-wrapper">
                     <input type="text" id="cardSearchInput" class="manage-search-input" placeholder="ÊêúÂ∞ãÂç°Áâá (Â¶Ç: ÂêâÈ∂¥, ÊóÖ‰∫∫...)" oninput="filterManageCards()">
                     <button id="btnSearchClear" class="btn-search-clear" onclick="clearCardSearch()">‚úï</button>
                </div>
            </div>
        
            <div style="font-size:12px; color:#888; margin-bottom:12px;">ÈªûÊìäÂç°ÁâáÂç≥ÂèØ ÂïüÁî® / Èö±Ëóè</div>
            
            <div id="manageCardList" class="manage-grid"></div>
            
            <div id="customCardSection" style="margin-top:12px; border-top:2px solid #f0f0f0; padding-top:12px;">
                <div style="font-size:12px; color:#888; margin-bottom:8px;">Ëá™Âª∫Âç°Áâá (<span id="customCardCount">0</span>/5)</div>
                <button id="btnAddCustomCard" class="btn" style="width:100%; background:#f0f8ff; color:#007AFF; border:1px dashed #007AFF; font-size:14px;" onclick="openCustomCardModal()">Ôºã Ëá™Âª∫Âç°Áâá</button>
            </div>

            <button class="btn btn-confirm" style="width:100%; margin-top:10px;" onclick="document.getElementById('manageModal').style.display='none'">ÂÆåÊàê</button>
        </div>
    </div>

    <!-- Âç°ÁâáË®≠ÂÆöÂΩàÁ™ó (Êö±Á®± + ÁµêÂ∏≥Êó•) -->
    <div id="cardSettingsModal" class="modal" onclick="if(event.target===this) document.getElementById('cardSettingsModal').style.display='none'">
        <div class="modal-content">
             <h2 id="settingsModalTitle" style="margin: 0 0 12px 0; font-size: 18px; font-weight: 800; color:#333;">Âç°ÁâáË®≠ÂÆö</h2>
             
             <div class="input-group">
                 <label>üè∑Ô∏è Âç°ÁâáÊö±Á®±</label>
                 <input type="text" id="settingNicknameInput" placeholder="Ëá™Ë®ÇÂêçÁ®± (‰æãÂ¶Ç: Ë≤∑ËèúÂç°)">
             </div>
             
             <div class="input-group">
                 <label>üìÖ ÁµêÂ∏≥Êó• (ÊØèÊúàÂπæËôüÁµêÁÆó)</label>
                 <select id="settingCycleDayInput" style="width: 100%; padding: 10px; border: 2px solid #f0f0f0; background: #fff; border-radius: 12px; font-size: 16px; outline: none; font-weight: 600; color: #333;">
                     <option value="">È†êË®≠ (ÊåâËá™ÁÑ∂Êúà)</option>
                     <!-- 1~31 -->
                 </select>
                 <div style="font-size:11px; color:#888; margin-top:6px;">Ë®≠ÂÆöÂæåÔºåËã•Ê∂àË≤ªÊó•Ë∂ÖÈÅéÁµêÂ∏≥Êó•ÔºåÂ∞áËá™ÂãïÊ≠∏ÂÖ•‰∏ãÊúüÂ∏≥ÂñÆ„ÄÇ</div>
             </div>
             
             <input type="hidden" id="settingCardId">

             <div class="btn-group">
                 <button class="btn btn-cancel" onclick="document.getElementById('cardSettingsModal').style.display='none'">ÂèñÊ∂à</button>
                 <button class="btn btn-confirm" onclick="saveCardSetting()">ÂÑ≤Â≠ò</button>
             </div>
        </div>
    </div>
    
   <!-- Ëá™Âª∫Âç°Áâá Modal -->
    <div id="customCardModal" class="modal" onclick="if(event.target===this) document.getElementById('customCardModal').style.display='none'">
        <div class="modal-content">
             <h2 id="customCardTitle" style="margin: 0 0 12px 0; font-size: 18px; font-weight: 800; color:#333;">Ëá™Âª∫Âç°Áâá</h2>
             
             <div class="input-group">
                 <label>üí≥ Âç°ÁâáÂêçÁ®± (ÂøÖÂ°´)</label>
                 <input type="text" id="customCardName" placeholder="‰æãÂ¶ÇÔºöÂúãÊ≥∞ CUBE Âç°" maxlength="20">
             </div>
             
             <div class="input-group">
                 <label>üè∑Ô∏è Êö±Á®± (ÈÅ∏Â°´)</label>
                 <input type="text" id="customCardNickname" placeholder="‰æãÂ¶ÇÔºöÁπ≥Ë≤ªÂ∞àÁî®" maxlength="10">
             </div>

             <div class="input-group">
                 <label>üìä Âä†Á¢ºÂõûÈ•ãÁéá % (ÂøÖÂ°´)</label>
                 <input type="number" id="customCardRate" placeholder="‰æãÂ¶ÇÔºö3" step="0.1" min="0" max="100" style="font-size:16px;">
             </div>

             <div class="input-group">
                 <label>üéÅ ÂõûÈ•ãÂñÆ‰Ωç</label>
                 <div style="display:flex; gap:10px; margin-top:4px;">
                     <label style="font-size:14px; display:flex; align-items:center; gap:4px;"><input type="radio" name="customCardUnit" value="cash" checked style="width:18px; height:18px;"> ÁèæÈáëÂõûÈ•ã</label>
                     <label style="font-size:14px; display:flex; align-items:center; gap:4px;"><input type="radio" name="customCardUnit" value="miles" style="width:18px; height:18px;"> Âì©Á®ã</label>
                 </div>
             </div>
             
             <div class="input-group">
                 <label>üîí ÊØèÊúüÂ∞ÅÈ†ÇÊ∂àË≤ªÈáëÈ°ç (ÈÅ∏Â°´ÔºåÁ©∫=ÁÑ°‰∏äÈôê)</label>
                 <input type="number" id="customCardCap" placeholder="‰æãÂ¶ÇÔºö10000" style="font-size:16px;">
             </div>

             <div class="input-group">
                 <label>üìâ Â∞ÅÈ†ÇÂæåÂõûÈ•ãÁéá % (ÈÅ∏Â°´ÔºåÈ†êË®≠ 0)</label>
                 <input type="number" id="customCardTier2Rate" placeholder="‰æãÂ¶ÇÔºö1" step="0.1" min="0" max="100" style="font-size:16px;">
             </div>

             <div class="input-group">
                 <label>üìÖ ÁµêÂ∏≥Êó• (ÈÅ∏Â°´)</label>
                 <select id="customCardCycleDay" style="width:100%; padding:10px; border:2px solid #f0f0f0; background:#fff; border-radius:12px; font-size:16px; outline:none; font-weight:600; color:#333;">
                     <option value="">È†êË®≠ (ÊåâËá™ÁÑ∂Êúà)</option>
                 </select>
             </div>

             <div class="input-group">
                 <label>üé® Âç°Èù¢È°èËâ≤</label>
                 <div id="customColorPicker" style="display:flex; flex-wrap:wrap; gap:8px; margin-top:6px;"></div>
             </div>
             
             <div class="input-group">
                 <label>üñºÔ∏è Âç°Èù¢ÁÖßÁâá (ÈÅ∏Â°´)</label>
                 <div style="display:flex; gap:8px; align-items:center;">
                     <button class="btn" style="flex:1; background:#f0f8ff; color:#007AFF; border:1px dashed #007AFF; font-size:13px; padding:10px;" onclick="document.getElementById('customCardPhotoInput').click()">üì∑ ÈÅ∏ÊìáÁÖßÁâá</button>
                     <button id="btnRemoveCustomPhoto" class="btn" style="background:#fff0f0; color:#FF3B30; border:1px solid #ffcdd2; font-size:13px; padding:10px; display:none;" onclick="removeCustomCardPhoto()">ÁßªÈô§</button>
                 </div>
                 <input type="file" id="customCardPhotoInput" accept="image/*" style="display:none" onchange="handleCustomCardPhoto(event)">
                 <div id="customPhotoPreviewBox" style="margin-top:8px; display:none; width:100%; height:120px; border-radius:12px; overflow:hidden;">
                     <img id="customPhotoPreviewImg" style="width:100%; height:100%; object-fit:cover;">
                 </div>
                 <div style="font-size:11px; color:#888; margin-top:4px;">ÁÖßÁâáÊúÉË¶ÜËìãÂç°Èù¢È°èËâ≤„ÄÇ</div>
             </div>

             <input type="hidden" id="customCardEditId" value="">

           <div class="btn-group">
                 <button class="btn btn-cancel" onclick="document.getElementById('customCardModal').style.display='none'">ÂèñÊ∂à</button>
                 <button class="btn btn-confirm" onclick="saveCustomCard()">ÂÑ≤Â≠ò</button>
             </div>
             <div id="customCardDeleteArea" style="display:none; margin-top:10px; text-align:center;">
                 <button onclick="deleteCustomCard(document.getElementById('customCardEditId').value)" style="background:none; border:none; color:#FF3B30; font-size:13px; cursor:pointer; padding:8px;">üóëÔ∏è Âà™Èô§Ê≠§Âç°Áâá</button>
             </div>
        </div>
    </div>

   <!-- Á∑®ËºØÊÉÖÂ¢É Modal -->
    <div id="sceneEditModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:10001; justify-content:center; align-items:center;">
        <div style="background:#fff; border-radius:16px; width:90%; max-width:400px; max-height:85vh; overflow-y:auto; padding:20px;">
            <h3 id="sceneEditTitle" style="margin:0 0 16px 0; font-size:18px;">Êñ∞Â¢ûÊÉÖÂ¢É</h3>
            
            <div style="margin-bottom:16px;">
                <label style="font-size:13px; color:#555; display:block; margin-bottom:6px;">ÊÉÖÂ¢ÉÂêçÁ®±</label>
                <input type="text" id="sceneNameInput" placeholder="‰æãÂ¶ÇÔºöüáØüáµ Êó•Êú¨ÊóÖÈÅä" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:8px; font-size:15px; box-sizing:border-box;">
            </div>
            
            <div style="margin-bottom:16px;">
                <label style="font-size:13px; color:#555; display:block; margin-bottom:6px;">ÂàáÊèõÂúãÂÆ∂ÊôÇËá™ÂãïÂ•óÁî®ÔºàÂèØÂ§öÈÅ∏Ôºâ</label>
                <div id="sceneLocationOptions">
                    <div style="display:flex; gap:8px; margin-bottom:8px;">
                        <label style="flex:1; padding:12px; border:1px solid #ddd; border-radius:8px; cursor:pointer; text-align:center;"><input type="checkbox" name="sceneLocation" value="TW" onchange="checkSceneLocationConflict()" style="margin-right:6px;">üáπüáºÂè∞ÁÅ£</label>
                        <label style="flex:1; padding:12px; border:1px solid #ddd; border-radius:8px; cursor:pointer; text-align:center;"><input type="checkbox" name="sceneLocation" value="JP" onchange="checkSceneLocationConflict()" style="margin-right:6px;">üáØüáµÊó•Êú¨</label>
                    </div>
                    <div style="display:flex; gap:8px;">
                        <label style="flex:1; padding:12px; border:1px solid #ddd; border-radius:8px; cursor:pointer; text-align:center;"><input type="checkbox" name="sceneLocation" value="KR" onchange="checkSceneLocationConflict()" style="margin-right:6px;">üá∞üá∑ÈüìÂúã</label>
                        <label style="flex:1; padding:12px; border:1px solid #ddd; border-radius:8px; cursor:pointer; text-align:center;"><input type="checkbox" name="sceneLocation" value="TH" onchange="checkSceneLocationConflict()" style="margin-right:6px;">üáπüá≠Ê≥∞Âúã</label>
                    </div>
                </div>
                <div id="sceneLocationWarning" style="display:none; margin-top:8px; padding:8px; background:#fff3e0; border-radius:6px; font-size:11px; color:#e65100;"></div>
            </div>
            
            <div style="margin-bottom:16px;">
                <label style="font-size:13px; color:#555; display:block; margin-bottom:6px;">ÈÅ∏ÊìáÂç°Áâá</label>
               <div id="sceneCardOptions" style="display:grid; grid-template-columns:1fr 1fr; gap:8px; max-height:250px; overflow-y:auto;"></div>
            </div>
            
            <div style="display:flex; gap:10px; margin-top:20px;">
                <button onclick="closeSceneEditModal()" style="flex:1; padding:12px; border:1px solid #ddd; background:#fff; border-radius:8px; font-size:15px; cursor:pointer;">ÂèñÊ∂à</button>
                <button onclick="saveSceneEdit()" style="flex:1; padding:12px; border:none; background:#007AFF; color:#fff; border-radius:8px; font-size:15px; cursor:pointer;">ÂÑ≤Â≠ò</button>
            </div>
        </div>
    </div>
    
    <script>
    // ==========================================
    // Part 3: Ê†∏ÂøÉË®≠ÂÆö„ÄÅÂåØÁéáËàá UI ÈÇèËºØ (V126.2)
    // ==========================================
    
    const LOCATION_CONFIG = {
        'TW': { flag: 'üáπüáº', name: 'ÊàëÂú®Âè∞ÁÅ£', currency: 'TWD', rate: 1 },
        'JP': { flag: 'üáØüáµ', name: 'ÊàëÂú®Êó•Êú¨', currency: 'JPY', rate: null },
        'KR': { flag: 'üá∞üá∑', name: 'ÊàëÂú®ÈüìÂúã', currency: 'KRW', rate: null },
        'US': { flag: 'üá∫üá∏', name: 'ÊàëÂú®ÁæéÂúã', currency: 'USD', rate: null },
        'TH': { flag: 'üáπüá≠', name: 'ÊàëÂú®Ê≥∞Âúã', currency: 'THB', rate: null }
    };

    let currentLocation = localStorage.getItem('current_location') || 'TW';
    let exchangeRates = JSON.parse(localStorage.getItem('exchange_rates') || '{}');
    let lastRateUpdate = localStorage.getItem('last_rate_update') || '';

    async function fetchExchangeRates() {
        const today = new Date().toISOString().split('T')[0];
        if (lastRateUpdate === today && Object.keys(exchangeRates).length > 0) return;
        try {
            const response = await fetch('https://api.exchangerate-api.com/v4/latest/TWD');
            const data = await response.json();
            exchangeRates = {
                JPY: 1 / data.rates.JPY,
                KRW: 1 / data.rates.KRW,
                USD: 1 / data.rates.USD,
                THB: 1 / data.rates.THB
            };
            localStorage.setItem('exchange_rates', JSON.stringify(exchangeRates));
            localStorage.setItem('last_rate_update', today);
        } catch (error) {
            if (Object.keys(exchangeRates).length === 0) exchangeRates = { JPY: 0.22, KRW: 0.024, USD: 32.5, THB: 0.92 };
        }
    }
    
    // Âº∑Âà∂ÈáçÊñ∞ÊäìÂèñÂåØÁéá
    async function refreshExchangeRates() {
        const btn = document.getElementById('refreshRateBtn');
        const rateInput = document.getElementById('exchangeRateInput');
        
        // È°ØÁ§∫ËºâÂÖ•‰∏≠
        btn.innerText = '‚è≥';
        btn.disabled = true;
        
        try {
            const response = await fetch('https://api.exchangerate-api.com/v4/latest/TWD');
            const data = await response.json();
            const today = new Date().toISOString().split('T')[0];
            
            exchangeRates = {
                JPY: 1 / data.rates.JPY,
                KRW: 1 / data.rates.KRW,
                USD: 1 / data.rates.USD,
                THB: 1 / data.rates.THB
            };
            localStorage.setItem('exchange_rates', JSON.stringify(exchangeRates));
            localStorage.setItem('last_rate_update', today);
            
            // Êõ¥Êñ∞È°ØÁ§∫ÁöÑÂåØÁéá
            if (currentLocation !== 'TW') {
                const currencySymbol = LOCATION_CONFIG[currentLocation].currency;
                rateInput.value = parseFloat(exchangeRates[currencySymbol] || 1).toFixed(4);
            }
            
            // ÊàêÂäüÊèêÁ§∫
            btn.innerText = '‚úÖ';
            setTimeout(() => { btn.innerText = 'üîÑ'; }, 1500);
            
        } catch (error) {
            // Â§±ÊïóÊèêÁ§∫
            btn.innerText = '‚ùå';
            setTimeout(() => { btn.innerText = 'üîÑ'; }, 1500);
            alert('ÂåØÁéáÊõ¥Êñ∞Â§±ÊïóÔºåË´ãÁ®çÂæåÂÜçË©¶');
        }
        
        btn.disabled = false;
    }

    function openLocationModal() {
        document.getElementById('locationModal').style.display = 'flex';
        const options = document.querySelectorAll('.location-option');
        options.forEach(opt => opt.classList.remove('active'));
        const currentOpt = Array.from(options).find(opt => opt.querySelector('.location-flag').innerText === LOCATION_CONFIG[currentLocation].flag);
        if (currentOpt) currentOpt.classList.add('active');
    }

    function selectLocation(code, flag, name, currency, rate) {
        currentLocation = code;
        localStorage.setItem('current_location', code);
        document.getElementById('currentLocationFlag').innerText = flag;
        document.getElementById('currentLocationName').innerText = name;
        document.getElementById('locationModal').style.display = 'none';
        
        const rateRow = document.getElementById('exchangeRateRow');
        const rateInput = document.getElementById('exchangeRateInput');
        const currencySymbol = LOCATION_CONFIG[code].currency;
        
        if (code !== 'TW') {
            rateRow.style.display = 'flex';
            document.getElementById('currencySymbolInRate').innerText = currencySymbol;
            let rateVal = exchangeRates[currencySymbol] || 1;
            rateInput.value = parseFloat(rateVal).toFixed(4);
        } else {
            rateRow.style.display = 'none';
        }
        
        updateAmountPlaceholder();
        
        // ‚òÖ Ëá™ÂãïËºâÂÖ•Ë©≤ÂúãÂÆ∂Á∂ÅÂÆöÁöÑÊÉÖÂ¢É
        const scenes = getScenes();
        const linkedScene = scenes.find(s => s.linkedLocations && s.linkedLocations.includes(code));
        if (linkedScene) {
            visibleCards = [...linkedScene.cards];
            if (!visibleCards.includes('add1') && visibleCards.length < 8) {
                visibleCards.push('add1');
            }
            localStorage.setItem('visibleCards', JSON.stringify(visibleCards));
        }
        
        renderGrid();
        
        // ‚òÖ ÈÄ£ÂãïÂêâÈ∂¥Âç°ÔºöÊ†πÊìöÂú∞ÈªûËá™ÂãïÂàáÊèõÊ®°Âºè
        if (document.getElementById('jiheOptions')?.style.display !== 'none') {
            updateJiheByLocation();
        }
        
       // ‚òÖ ÈÄ£ÂãïÂØåÈÇ¶JÂç°ÔºöÊ†πÊìöÂú∞ÈªûËá™ÂãïÂàáÊèõÊ®°Âºè
        if (document.getElementById('fubonJOptions')?.style.display !== 'none') {
            updateFubonJByLocation();
        }
        
        // ‚òÖ ÈÄ£ÂãïÁÜäÊú¨ÁÜäÂç°ÔºöÊ†πÊìöÂú∞ÈªûËá™ÂãïÂàáÊèõÊ®°Âºè
        if (document.getElementById('kumamonOptions')?.style.display !== 'none') {
            updateKumamonByLocation();
        }
    }
    function updateAmountPlaceholder() {
        const config = LOCATION_CONFIG[currentLocation];
        const input = document.getElementById('amountInput');
        if (input) input.placeholder = `${config.currency} ÈáëÈ°ç`;
    }

    function getCurrentRate() {
        if (currentLocation === 'TW') return 1;
        const inputVal = parseFloat(document.getElementById('exchangeRateInput').value);
        if(inputVal) return inputVal;
        return exchangeRates[LOCATION_CONFIG[currentLocation].currency] || 1;
    }

    function updateTWDPreview() {
        const amount = parseFloat(document.getElementById('amountInput').value);
        const twdDisplay = document.getElementById('twdConversionDisplay');
        const twdAmount = document.getElementById('twdAmount');
        
        if (currentLocation === 'TW' || !amount || amount <= 0) { 
            twdDisplay.style.display = 'none'; 
            return; 
        }
        
        const rate = getCurrentRate();
        twdAmount.innerText = Math.round(amount * rate).toLocaleString();
        twdDisplay.style.display = 'block';
    }

    function toggleExchangeRateEdit() {
        const input = document.getElementById('exchangeRateInput');
        input.readOnly = !input.readOnly;
        if (!input.readOnly) { input.focus(); input.select(); }
    }

    function injectDetails() {
        const petDiv = document.getElementById('happyPetDetails');
        if(petDiv && petDiv.innerHTML.trim() === "") {
            petDiv.innerHTML = `<b>(1) ÊåáÂÆöÂØµÁâ©ÈÄ£ÈéñÔºö</b><br>ÂØµÁâ©ÂÖ¨Âúí„ÄÅÊù±Ê£ÆÂØµÁâ©„ÄÅÈ≠ö‰∏≠È≠ö„ÄÅË≤ìÁãóÈöäÈï∑„ÄÅÊØõÂ≠©Â∏ÇÈõÜ„ÄÅÈáëÂêâÂà©...<br><b>(2) 2026 Êñ∞Â¢ûÔºö</b><br>Ê±™ÂñµÊòüÁêÉ„ÄÅÊÄ™Áç∏ÈÉ®ËêΩ„ÄÅË∂ÖÂáùÂ∞èÂßê...`;
        }
        
        // Â°´ÂÖÖÁµêÂ∏≥Êó•ÈÅ∏ÂñÆ
        const select = document.getElementById('settingCycleDayInput');
        if (select && select.options.length <= 1) {
            for(let i=1; i<=31; i++) {
                const opt = document.createElement('option');
                opt.value = i;
                opt.text = `ÊØèÊúà ${i} Ëôü`;
                select.add(opt);
            }
        }
    }

    // Toggle Functions
    function toggleGreenDetails() { const el = document.getElementById('greenDetails'); el.style.display = (el.style.display === 'block') ? 'none' : 'block'; }
    function toggleParkingDetails() { const el = document.getElementById('greenParkingDetails'); el.style.display = (el.style.display === 'block') ? 'none' : 'block'; }
    function toggleJiheDetails() { const el = document.getElementById('jiheDetails'); el.style.display = (el.style.display === 'block') ? 'none' : 'block'; }
    function toggleKumamonDetails() { const el = document.getElementById('kumamonDetails'); el.style.display = (el.style.display === 'block') ? 'none' : 'block'; }
    function toggleDbsDetails() { const el = document.getElementById('dbsDetails'); el.style.display = (el.style.display === 'block') ? 'none' : 'block'; }
    function toggleJiangDetails() { const el = document.getElementById('jiangDetails'); el.style.display = (el.style.display === 'block') ? 'none' : 'block'; }
    function toggleJiangTravelDetails() { const el = document.getElementById('jiangTravelDetails'); el.style.display = (el.style.display === 'block') ? 'none' : 'block'; }
    function toggleCurrencyDetails() { const el = document.getElementById('currencyDetails'); el.style.display = (el.style.display === 'block') ? 'none' : 'block'; }
    function togglePigRichNewUser() { const el = document.getElementById('pigRichNewUserDetails'); el.style.display = (el.style.display === 'block') ? 'none' : 'block'; }
    function togglePigRichSelected() { const el = document.getElementById('pigRichSelectedDetails'); el.style.display = (el.style.display === 'block') ? 'none' : 'block'; }
    function toggleHappyPetDetails() { const el = document.getElementById('happyPetDetails'); el.style.display = (el.style.display === 'block') ? 'none' : 'block'; }
    function toggleHappyPeaceDetails() { const el = document.getElementById('happyPeaceDetails'); el.style.display = (el.style.display === 'block') ? 'none' : 'block'; }
    function toggleHappyLifeDetails() { const el = document.getElementById('happyLifeDetails'); el.style.display = (el.style.display === 'block') ? 'none' : 'block'; }
    function toggleSinopacJcbDetails() { const el = document.getElementById('sinopacJcbDetails'); el.style.display = (el.style.display === 'block') ? 'none' : 'block'; }
    function toggleLaiDianDetails() { const el = document.getElementById('laiDianDetails'); el.style.display = (el.style.display === 'block') ? 'none' : 'block'; }
    function toggleLegendDetails() { const el = document.getElementById('legendDetails'); el.style.display = (el.style.display === 'block') ? 'none' : 'block'; }
    function toggleCubeDetails(id) { const el = document.getElementById(id); el.style.display = (el.style.display === 'block') ? 'none' : 'block'; }

    // UniOpen ÂìÅÁâåÂàóË°®Â±ïÈñã/Êî∂Âêà
    function toggleUniBrandList() {
        const container = document.getElementById('uniBrandContainer');
        const btn = document.getElementById('btnToggleUniBrand');
        if (container.style.display === 'none') {
            container.style.display = 'block';
            btn.innerText = 'Êî∂ÂêàÂìÅÁâå ‚ñ≤';
        } else {
            container.style.display = 'none';
            btn.innerText = 'Â±ïÈñãÂìÅÁâå ‚ñº';
        }
    }

    // UniOpen ÂìÅÁâåÂàÜÈ°ûÊäòÁñä
    function toggleBrandCategory(catId) {
        const content = document.getElementById('content-' + catId);
        const arrow = document.getElementById('arrow-' + catId);
        const header = arrow.parentElement;
        
        if (content.classList.contains('collapsed')) {
            content.classList.remove('collapsed');
            header.classList.remove('collapsed');
            arrow.innerText = '‚ñº';
        } else {
            content.classList.add('collapsed');
            header.classList.add('collapsed');
            arrow.innerText = '‚ñ∂';
        }
    }

    function toggleSelectedLogic() {
        if(document.getElementById('checkBonus25').checked) {
            document.getElementById('checkIsBill').checked = false;
            document.getElementById('labelBaseRate').innerText = "üî∞ Âü∫Êú¨ÂõûÈ•ã 1% (ÁÑ°‰∏äÈôê)";
        }
        updateRewardPreview();
    }
    function toggleBillLogic() {
        if(document.getElementById('checkIsBill').checked) {
            document.getElementById('checkBonus25').checked = false;
            document.getElementById('labelBaseRate').innerText = "üî∞ Âü∫Êú¨ÂõûÈ•ã 0.15% (ÁÑ°‰∏äÈôê)";
        } else {
            document.getElementById('labelBaseRate').innerText = "üî∞ Âü∫Êú¨ÂõûÈ•ã 1% (ÁÑ°‰∏äÈôê)";
        }
        updateRewardPreview();
    }

    function openShareModal() {
       document.getElementById('shareCardMonth').innerText = `${new Date().getMonth() + 1} ÊúàÂõûÈ•ãÊà∞Á∏æ`;
        let shareCash = 0, shareMiles = 0;
        let cardRewards = [];
        cards.forEach(card => {
            if(card.type === 'placeholder') return;
            const stats = calculateStatsAllLocations(card.id);
            if(stats.reward > 0) {
                if (card.type === 'miles') shareMiles += stats.reward;
                else shareCash += stats.reward;
                cardRewards.push({ name: card.name, reward: stats.reward, isMiles: card.type === 'miles' });
            }
        });
       let shareHtml = '';
        if (shareCash > 0 && shareMiles > 0) {
            shareHtml = `$${shareCash.toLocaleString()}<div style="font-size:50%; opacity:0.8; margin-top:4px;">‚úàÔ∏è ${shareMiles.toLocaleString()} Âì©</div>`;
        } else if (shareMiles > 0) {
            shareHtml = `${shareMiles.toLocaleString()} Âì©`;
        } else {
            shareHtml = `$${shareCash.toLocaleString()}`;
        }
        document.getElementById('shareCardAmount').innerHTML = shareHtml;
        cardRewards.sort((a, b) => b.reward - a.reward);
        const listContainer = document.getElementById('shareCardList');
        listContainer.innerHTML = '';
        if(cardRewards.length === 0) listContainer.innerHTML = '<div style="text-align:center; opacity:0.6; padding:10px;">Êú¨ÊúàÂ∞öÁÑ°ÂõûÈ•ãÁ¥ÄÈåÑ</div>';
        else {
            cardRewards.forEach(c => {
               let unit = c.isMiles ? 'Âì©' : 'ÂÖÉ';
                listContainer.innerHTML += `<div class="share-item"><span>${c.name}</span><span>+${c.reward.toLocaleString()} ${unit}</span></div>`;
            });
        }
        document.getElementById('sharePreviewModal').style.display = 'flex';
    }

    function shareToIG() { shareImageNative(); }
    function shareToFB() { shareImageNative(); }
    function shareToLine() { window.open(`https://line.me/R/msg/text/?${encodeURIComponent(getShareText())}`, '_blank'); }
    function shareToThreads() { window.open(`https://www.threads.net/intent/post?text=${encodeURIComponent(getShareText())}`, '_blank'); }

    function shareImageNative() {
        const node = document.getElementById('captureNode');
        const originalTransform = node.style.transform;
        node.style.transform = 'none';
        const btns = document.querySelectorAll('.social-btn');
        btns.forEach(b => b.style.opacity = '0.5');
        html2canvas(node, { backgroundColor: null, scale: 2 }).then(canvas => {
            node.style.transform = originalTransform; 
            btns.forEach(b => b.style.opacity = '1'); 
            canvas.toBlob(async (blob) => {
                const file = new File([blob], `Reward.png`, { type: "image/png" });
                if (navigator.share && navigator.canShare && navigator.canShare({ files: [file] })) {
                    try { await navigator.share({ files: [file], title: 'My Rewards', text: getShareText() }); } catch (err) {}
                } else { downloadShareImage(); }
            });
        });
    }

    function downloadShareImage() {
        const node = document.getElementById('captureNode');
        const originalTransform = node.style.transform;
        node.style.transform = 'none'; 
        html2canvas(node, { backgroundColor: null, scale: 2 }).then(canvas => {
            node.style.transform = originalTransform; 
            const link = document.createElement('a');
            link.download = `Reward_${Date.now()}.png`;
            link.href = canvas.toDataURL();
            link.click();
        });
    }

    function getShareText() { return `üí∞ ÁãÇÔºÅÊú¨ÊúàÂõûÈ•ã ${document.getElementById('totalRewardDisplay').innerText}ÔºÅ\nÂø´‰æÜË©¶ÁÆó üëâ https://lihi.cc/nelWa`; }

    fetch('config.json?t=' + Date.now()).then(response => response.json()).then(data => { if(data.news) document.getElementById('news-text').innerHTML = data.news; }).catch(error => {});
    let cardSettings = JSON.parse(localStorage.getItem('cardSettings')) || {};
let editingTxId = null; // ËøΩËπ§Ê≠£Âú®Á∑®ËºØÁöÑ‰∫§Êòì ID
let historyMonth = null; // null = Áï∂Êúü, {year, month} = Ê≠∑Âè≤Êúà‰ªΩ
let historyMonthOffset = 0; // Ê≠∑Âè≤Êúà‰ªΩÂÅèÁßª (0=Êú¨Êúü, -1=‰∏äÊúü...)

    window.addEventListener('load', () => {
        injectDetails(); fetchExchangeRates();
        updateAmountPlaceholder();
        const tipBar = document.getElementById('line-tip-bar');
        if (tipBar && window.getComputedStyle(tipBar).display !== 'none') document.querySelector('.app-container').style.marginTop = '45px'; 
        setTimeout(() => { const ticker = document.querySelector('.ticker-content'); if(ticker) { ticker.style.animation = 'none'; void ticker.offsetWidth; ticker.style.animation = 'scroll-left 15s linear infinite'; } }, 100);
        
        // ËºâÂÖ•ÂÑ≤Â≠òÁöÑÂú∞ÈªûË®≠ÂÆö
        const savedLoc = localStorage.getItem('current_location');
        if (savedLoc && LOCATION_CONFIG[savedLoc]) {
            currentLocation = savedLoc;
            document.getElementById('currentLocationFlag').innerText = LOCATION_CONFIG[savedLoc].flag;
            document.getElementById('currentLocationName').innerText = LOCATION_CONFIG[savedLoc].name;
            if (savedLoc !== 'TW') {
                const rateRow = document.getElementById('exchangeRateRow');
                rateRow.style.display = 'flex';
                document.getElementById('currencySymbolInRate').innerText = LOCATION_CONFIG[savedLoc].currency;
                let rateVal = exchangeRates[LOCATION_CONFIG[savedLoc].currency] || 1;
                document.getElementById('exchangeRateInput').value = parseFloat(rateVal).toFixed(4);
            }
        }
        // ËºâÂÖ•È°çÊªøÂÖ¨Âëä
    fetch('./promo_status.json?' + Date.now())
      .then(r => r.json())
      .then(status => {
        window.promoStatus = status;
      })
      .catch(() => { window.promoStatus = {}; });
        if (!localStorage.getItem('user_setup_done')) {
            if (localStorage.getItem('visibleCards') !== null) { localStorage.setItem('user_setup_done', 'true'); loadAndRenderApp(); }
            else initWelcomeModal();
        } else loadAndRenderApp();
    });

    function initWelcomeModal() {
        const list = document.getElementById('welcomeList'); list.innerHTML = '';
        cards.forEach(card => { if (card.id === 'add1') return; list.innerHTML += `<div class="welcome-item"><input type="checkbox" id="w_${card.id}" value="${card.id}"><label for="w_${card.id}">${card.name}</label></div>`; });
        document.getElementById('welcomeModal').style.display = 'flex';
    }

    function saveWelcomeSettings() {
        const checkboxes = document.querySelectorAll('.welcome-item input[type="checkbox"]:checked');
        let selectedCards = []; checkboxes.forEach(cb => selectedCards.push(cb.value));
        if (selectedCards.length === 0) { alert("Âª∫Ë≠∞ÂÖàÈÅ∏ÂπæÂºµÂç°ÁâáË©¶Áî®ÁúãÁúãÂñîÔºÅ"); return; }
        localStorage.setItem('visibleCards', JSON.stringify(selectedCards));
        localStorage.setItem('user_setup_done', 'true');
        document.getElementById('welcomeModal').style.display = 'none';
        location.reload();
    }
    
   function getScenes() { return JSON.parse(localStorage.getItem('scene_snapshots') || '[]'); }
    
    let editingSceneIndex = null; // ËøΩËπ§Ê≠£Âú®Á∑®ËºØÁöÑÊÉÖÂ¢É
    
    // ÈñãÂïüÊñ∞Â¢ûÊÉÖÂ¢ÉÂΩàÁ™ó
    function saveCurrentScene() {
        if (!visibleCards || visibleCards.length <= 1) { alert("Ë´ãÂÖàÈÅ∏ÊìáËá≥Â∞ë‰∏ÄÂºµÂç°ÁâáÔºÅ"); return; }
        editingSceneIndex = null;
        openSceneEditModal(null);
    }
    
    // ÈñãÂïüÁ∑®ËºØÊÉÖÂ¢ÉÂΩàÁ™ó
    function editScene(index) {
        editingSceneIndex = index;
        openSceneEditModal(index);
    }
    
    // ÈñãÂïüÊÉÖÂ¢ÉÁ∑®ËºØÂΩàÁ™ó
    function openSceneEditModal(index) {
        const modal = document.getElementById('sceneEditModal');
        const title = document.getElementById('sceneEditTitle');
        const nameInput = document.getElementById('sceneNameInput');
        const cardOptions = document.getElementById('sceneCardOptions');
        
        // Ë®≠ÂÆöÊ®ôÈ°å
        title.innerText = (index === null) ? 'Êñ∞Â¢ûÊÉÖÂ¢É' : 'Á∑®ËºØÊÉÖÂ¢É';
        
        // ÂèñÂæóÁèæÊúâË≥áÊñô
        const scenes = getScenes();
        const scene = (index !== null) ? scenes[index] : null;
        
        // Â°´ÂÖ•ÂêçÁ®±
        nameInput.value = scene ? scene.name : '';
        
        // ÈáçÁΩÆÂúãÂÆ∂ÈÅ∏È†Ö
        document.querySelectorAll('input[name="sceneLocation"]').forEach(cb => {
            cb.checked = false;
        });
        
        // Â°´ÂÖ•Â∑≤Á∂ÅÂÆöÁöÑÂúãÂÆ∂
        if (scene && scene.linkedLocations) {
            scene.linkedLocations.forEach(loc => {
                const cb = document.querySelector(`input[name="sceneLocation"][value="${loc}"]`);
                if (cb) cb.checked = true;
            });
        }
        
        // Áî¢ÁîüÂç°ÁâáÈÅ∏È†Ö
        cardOptions.innerHTML = '';
        const selectedCards = scene ? scene.cards : visibleCards;
  cards.filter(c => c.id !== 'add1').forEach(card => {
            const isChecked = selectedCards.includes(card.id);
            const div = document.createElement('div');
            div.style.cssText = 'position:relative; padding:12px; border:2px solid ' + (isChecked ? '#007AFF' : '#ddd') + '; border-radius:12px; cursor:pointer; background:#fff;';
            div.innerHTML = '<input type="checkbox" name="sceneCard" value="' + card.id + '"' + (isChecked ? ' checked' : '') + ' style="position:absolute; top:8px; right:8px; width:20px; height:20px;">' +
                '<div style="font-size:13px; font-weight:600; margin-bottom:4px; padding-right:28px;">' + card.name + '</div>' +
                '<div style="font-size:10px; color:#888;">' + (card.tag || '') + '</div>';
            div.onclick = function(e) {
                if (e.target.type !== 'checkbox') {
                    const cb = div.querySelector('input[type="checkbox"]');
                    cb.checked = !cb.checked;
                    div.style.borderColor = cb.checked ? '#007AFF' : '#ddd';
                }
            };
            div.querySelector('input').onchange = function() {
                div.style.borderColor = this.checked ? '#007AFF' : '#ddd';
            };
            cardOptions.appendChild(div);
        });
        
        // Ê™¢Êü•Ë°ùÁ™Å
        checkSceneLocationConflict();
        
        // È°ØÁ§∫ÂΩàÁ™ó
        modal.style.display = 'flex';
    }
    
    // ÈóúÈñâÊÉÖÂ¢ÉÁ∑®ËºØÂΩàÁ™ó
    function closeSceneEditModal() {
        document.getElementById('sceneEditModal').style.display = 'none';
        editingSceneIndex = null;
    }
    
    // Ê™¢Êü•ÂúãÂÆ∂Á∂ÅÂÆöË°ùÁ™Å
    function checkSceneLocationConflict() {
        const warning = document.getElementById('sceneLocationWarning');
        const scenes = getScenes();
        const checkedLocations = Array.from(document.querySelectorAll('input[name="sceneLocation"]:checked')).map(cb => cb.value);
        
        const conflicts = [];
        checkedLocations.forEach(loc => {
            scenes.forEach((scene, idx) => {
                // Ë∑≥ÈÅéÊ≠£Âú®Á∑®ËºØÁöÑÊÉÖÂ¢ÉÊú¨Ë∫´
                if (idx === editingSceneIndex) return;
                if (scene.linkedLocations && scene.linkedLocations.includes(loc)) {
                    const locName = {TW:'Âè∞ÁÅ£', JP:'Êó•Êú¨', KR:'ÈüìÂúã', TH:'Ê≥∞Âúã'}[loc];
                    conflicts.push(`${locName} Â∑≤Á∂ÅÂÆö„Äå${scene.name}„Äç`);
                }
            });
        });
        
        if (conflicts.length > 0) {
            warning.innerHTML = '‚ö†Ô∏è ' + conflicts.join('„ÄÅ') + 'ÔºåÂÑ≤Â≠òÂæåÂ∞áË¶ÜËìã';
            warning.style.display = 'block';
        } else {
            warning.style.display = 'none';
        }
    }
    
    // ÂÑ≤Â≠òÊÉÖÂ¢ÉÁ∑®ËºØ
    function saveSceneEdit() {
        const nameInput = document.getElementById('sceneNameInput');
        const name = nameInput.value.trim();
        
        if (!name) {
            alert('Ë´ãËº∏ÂÖ•ÊÉÖÂ¢ÉÂêçÁ®±');
            return;
        }
        
        // ÂèñÂæóÈÅ∏‰∏≠ÁöÑÂç°Áâá
        const selectedCards = Array.from(document.querySelectorAll('input[name="sceneCard"]:checked')).map(cb => cb.value);
        if (selectedCards.length === 0) {
            alert('Ë´ãËá≥Â∞ëÈÅ∏Êìá‰∏ÄÂºµÂç°Áâá');
            return;
        }
        
        // ÂèñÂæóÈÅ∏‰∏≠ÁöÑÂúãÂÆ∂
        const selectedLocations = Array.from(document.querySelectorAll('input[name="sceneLocation"]:checked')).map(cb => cb.value);
        
        // ÂèñÂæóÁèæÊúâÊÉÖÂ¢É
        let scenes = getScenes();
        
        // ÁßªÈô§ÂÖ∂‰ªñÊÉÖÂ¢É‰∏≠Â∑≤Ë¢´ÈÅ∏‰∏≠ÁöÑÂúãÂÆ∂Á∂ÅÂÆöÔºàËôïÁêÜË°ùÁ™ÅÔºâ
        selectedLocations.forEach(loc => {
            scenes.forEach((scene, idx) => {
                if (idx === editingSceneIndex) return;
                if (scene.linkedLocations) {
                    scene.linkedLocations = scene.linkedLocations.filter(l => l !== loc);
                }
            });
        });
        
        // Êñ∞Â¢ûÊàñÊõ¥Êñ∞ÊÉÖÂ¢É
        const newScene = {
            name: name,
            cards: selectedCards,
            linkedLocations: selectedLocations
        };
        
        if (editingSceneIndex !== null) {
            scenes[editingSceneIndex] = newScene;
        } else {
            scenes.push(newScene);
        }
        
        // ÂÑ≤Â≠ò
        localStorage.setItem('scene_snapshots', JSON.stringify(scenes));
        
        // ÈóúÈñâÂΩàÁ™ó‰∏¶ÈáçÊñ∞Ê∏≤Êüì
        closeSceneEditModal();
        renderScenes();
    }
   function renderScenes() {
        const container = document.getElementById('sceneList'); 
        container.innerHTML = '';
        const scenes = getScenes();
        if (scenes.length === 0) { 
            container.innerHTML = '<span style="font-size:11px; color:#aaa; padding:6px;">Â∞öÁÑ°ÊÉÖÂ¢É</span>'; 
            return; 
        }
        scenes.forEach((scene, index) => {
            const btn = document.createElement('div'); 
            btn.className = 'btn-scene';
            
            // ÈÄ£ÂãïÂúñÁ§∫
            if (scene.linkedLocations && scene.linkedLocations.length > 0) {
                const linkIcon = document.createElement('span');
                linkIcon.innerText = 'üîó';
                linkIcon.title = 'Â∑≤ÈÄ£ÂãïÔºö' + scene.linkedLocations.map(l => ({TW:'Âè∞ÁÅ£', JP:'Êó•Êú¨', KR:'ÈüìÂúã', TH:'Ê≥∞Âúã'}[l])).join('„ÄÅ');
                linkIcon.style.cssText = 'font-size:12px; margin-right:2px;';
                btn.appendChild(linkIcon);
            }
            
            // ÊÉÖÂ¢ÉÂêçÁ®±
            const nameSpan = document.createElement('span');
            nameSpan.innerText = scene.name;
            nameSpan.style.cssText = 'flex:1; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;';
            btn.appendChild(nameSpan);
            
            // Á∑®ËºØÊåâÈàï
            const editBtn = document.createElement('span');
            editBtn.className = 'btn-scene-edit';
            editBtn.innerText = '‚úèÔ∏è';
            editBtn.style.cssText = 'font-size:12px; margin-left:4px; cursor:pointer;';
            editBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                editScene(index);
            });
            btn.appendChild(editBtn);
            
            // Âà™Èô§ÊåâÈàï
            const delBtn = document.createElement('span');
            delBtn.className = 'btn-scene-del';
            delBtn.innerText = '‚úï';
            delBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                deleteScene(index);
            });
            btn.appendChild(delBtn);
            
            // ÈªûÊìäËºâÂÖ•ÊÉÖÂ¢É
            btn.addEventListener('click', function() {
                loadScene(index);
            });
            
            container.appendChild(btn);
        });
    }
    function deleteScene(index) { 
        if(confirm('Á¢∫ÂÆöË¶ÅÂà™Èô§ÈÄôÂÄãÊÉÖÂ¢ÉÂóéÔºü')) { 
            const s = getScenes(); 
            s.splice(index, 1); 
            localStorage.setItem('scene_snapshots', JSON.stringify(s)); 
            renderScenes(); 
        } 
    }
    function loadScene(index) {
        if(!confirm('ÂàáÊèõÊÉÖÂ¢ÉÔºü')) return;
        visibleCards = getScenes()[index].cards; localStorage.setItem('visibleCards', JSON.stringify(visibleCards)); renderGrid(); openManageModal();
    }
    function clearVisibleCards() { if(confirm('Ê∏ÖÁ©∫ÊâÄÊúâÂç°ÁâáÔºü')) { visibleCards = ['add1']; localStorage.setItem('visibleCards', JSON.stringify(visibleCards)); renderGrid(); openManageModal(); } }
   function loadAndRenderApp() {
        loadCustomCards();
        let currentCards = JSON.parse(localStorage.getItem('visibleCards')) || [];
        const realCardIds = cards.map(c => c.id).filter(id => id !== 'add1');
        let realCards = currentCards.filter(id => realCardIds.includes(id));
        if (realCards.length > 8) realCards = realCards.slice(0, 8);
        if (realCards.length < 8 && !currentCards.includes('add1')) realCards.push('add1');
        localStorage.setItem('visibleCards', JSON.stringify(realCards));
        visibleCards = realCards; renderGrid(); buildHistoryOptions();
    }

    function closeModal() { 
        document.getElementById('transactionModal').style.display = 'none'; 
        document.getElementById('manageModal').style.display = 'none'; 
        document.getElementById('sharePreviewModal').style.display = 'none'; 
       document.getElementById('cardSettingsModal').style.display = 'none';
        document.getElementById('customCardModal').style.display = 'none';
        
        // ‚òÖ ÈáçÁΩÆÁ∑®ËºØÁãÄÊÖã
        editingTxId = null;
        const btnConfirm = document.getElementById('btn-confirm');
        if (btnConfirm) btnConfirm.innerText = 'Á¢∫Ë™ç';
    }
    window.addEventListener('popstate', closeModal);
    
    // Cards DB
    const defaultCards = [
        { id: 'c10', name: '‰∏≠‰ø° UniOpen Âç°', nickname: '2026 Áµ±‰∏ÄÈõÜÂúòÁ•ûÂç°', note: 'icashPay/Êµ∑Â§ñ 11% ($3,750/$6,250 Â∞ÅÈ†Ç)', type: 'uniopen_special', gradient: 'linear-gradient(135deg, #FF512F 0%, #F09819 100%)', textColor: 'white', msgDanger: '', parking: `üè™ <b>Áµ±‰∏ÄÈõÜÂúò 2026 Êñ∞Ê¨äÁõä</b><br>1. <b>Âü∫Êú¨ÂõûÈ•ã</b>Ôºö1% (ÁÑ°‰∏äÈôê)<br>2. <b>ÈõÜÂúòÂä†Á¢º</b>Ôºö+2% (ÈôêÂà∑$2.5Ëê¨)<br>3. <b>Ë∏©Èªû‰ªªÂãô</b>ÔºöÊªø 5 ÂÆ∂ +4% (ÈôêÂà∑$1.25Ëê¨)<br>4. <b>icash Pay</b>ÔºöÂä†Á¢º +4% (ÈôêÂà∑$3,750)`},
        { id: 'dbs1', name: 'ÊòüÂ±ï eco Ê∞∏Á∫åÂç°', nickname: 'Á∂†ËÉΩ/Êñ∞Êà∂lpÁ•ûÂç°', note: 'ÂúãÂ§ñÂØ¶È´î +4% (Âà∑$1.5Ëê¨Â∞ÅÈ†Ç)', type: 'ceiling', limit: 15000, tier1Rate: 0.05, tier2Rate: 0.01, gradient: 'linear-gradient(135deg, #FF0000 0%, #000000 100%)', textColor: 'white', msgDanger: 'Âä†Á¢ºÂ∑≤Â∞ÅÈ†Ç (ËÆä1%)', parking: `üåø <b>Á∂†Ëâ≤/ÁâπÊñØÊãâ +9%</b><br>Âü∫Êú¨ 1% + Âä†Á¢º 9% (‰∏äÈôê300Èªû)<br>‚ö†Ô∏è Á¥ÑÂà∑ $3,333 Â∞ÅÈ†Ç<br>‚ö° <b>Êñ∞Êà∂ Line Pay 10%</b><br>Âü∫Êú¨ 1% + Âä†Á¢º 9%<br>‚ö†Ô∏è Âä†Á¢º‰∏äÈôê 1000 Èªû (Á¥ÑÂà∑ $11,111)<br>‚úàÔ∏è <b>ÂúãÂ§ñÂØ¶È´î +4%</b><br>Âü∫Êú¨ 1% + Âä†Á¢º 4% (ÂÖ±5%)<br>‚ö†Ô∏è Âä†Á¢ºÈÅ©Áî®ÊúàÂà∑ $15,000 Â∞ÅÈ†Ç`},
        { id: 'c6', name: 'Âè∞Êñ∞Ë°óÂè£Ë±¨ÂØåÂç°', nickname: 'Ë°åÊîØ/Áπ≥Ë≤ªÁ•ûÂç°', note: 'Êñ∞Êà∂ 10% (Âà∑ 8ÂçÉÂ∞ÅÈ†Ç) | Á≤æÈÅ∏ 2.5% (Âà∑ 40Ëê¨Â∞ÅÈ†Ç)', rule: '', type: 'ceiling', limit: 8000, tier1Rate: 0.135, tier2Rate: 0.035, gradient: 'linear-gradient(135deg, #e60012 0%, #FFD700 100%)', textColor: 'white', msgDanger: 'Êñ∞Êà∂10%Â∑≤Â∞ÅÈ†Ç', parking: `üê∑ <b>Êñ∞Êà∂ÈôêÂÆöÁ•ûÂç°</b><br>Êñ∞Êà∂ +10% (ÈôêÂà∑$8,000)<br>üåü <b>Á≤æÈÅ∏ÈÄöË∑Ø +2.5%</b><br>‰∏äÈôê $40 Ëê¨`},
        { id: 'c1', name: 'ÊòüÂ±ïÂÇ≥Ë™™Â∞çÊ±∫Âç°', nickname: 'Line PayÁ•ûÂç°', note: 'LinePay/Â§ñÈÄÅ/Ëù¶ÁöÆ(Âà∑$11,363 Â∞ÅÈ†Ç)', rule: '', type: 'custom_legend', limit: 11363, gradient: 'linear-gradient(135deg, #43cea2 0%, #185a9d 100%)', textColor: 'white', msgDanger: 'Âä†Á¢ºÂ∑≤Â∞ÅÈ†Ç (ËÆä1.2%)' },
        { id: 'c5', name: 'ËÅØÈÇ¶Ë≥¥ÈªûÂç°', nickname: 'Line Pay 10%', note: 'ÂÅ∂Êï∏Êó•+5% / LP+1% / Êñ∞Êà∂+4%', rule: '‚ö†Ô∏è ÈúÄÂñÆÁ≠ÜÊªø $100', type: 'custom_laidian', limit: 3000, tier1Rate: 0.06, tier2Rate: 0.01, threshold: 0, gradient: 'linear-gradient(135deg, #00B900 0%, #33CC33 100%)', textColor: 'white', msgDanger: 'Âä†Á¢ºÂ∑≤Â∞ÅÈ†Ç', parking: `‚úÖ <b>Âü∫Êú¨ÂõûÈ•ã 1%</b> (ÁÑ°‰∏äÈôê)<br>üì± <b>LP ‰∏ÄËà¨ 2%</b> (1+1, ÈôêÂà∑2Ëê¨)<br>üìÖ <b>ÂÅ∂Êï∏Êó• 6%</b> (1+5, ÈôêÂà∑3ÂçÉ)<br>üë∂ <b>Êñ∞Êà∂Âä†Á¢º +4%</b> (ÈôêÂà∑7500)<br>‚ö†Ô∏è <b>Ê≥®ÊÑè</b>ÔºöÂä†Á¢ºÈúÄÂñÆÁ≠ÜÊªø $100`},
        { id: 'c3', name: 'Ê∞∏Ë±ê Sport Âç°', nickname: 'Apple PayÂÑ™Á≠âÁîü', note: 'Apple Pay 5% (Âà∑ 5ÂçÉÂ∞ÅÈ†Ç)', rule: '', type: 'ceiling', limit: 5000, tier1Rate: 0.05, tier2Rate: 0.02, gradient: 'linear-gradient(135deg, #00B4DB 0%, #0083B0 100%)', textColor: 'white', msgDanger: 'Â∑≤Â∞ÅÈ†Ç (ËÆä1%)' },
        { id: 'c4', name: 'Â∞á‰æÜÂ∞áÂ∞áÂç°', nickname: 'Ë°åÊîØ/È§êÂª≥/Â§ñÈÄÅ', note: 'ÁîüÊ¥ª 5% (Âà∑ 6ÂçÉ6Â∞ÅÈ†Ç)', rule: '', type: 'mixed', limit: 6666, minSpend: 3000, tier1Rate: 0.05, tier2Rate: 0.005, gradient: 'linear-gradient(135deg, #ffe259 0%, #ffa751 100%)', textColor: '#333', msgDanger: 'Â∑≤Â∞ÅÈ†Ç (ËÆä0.5%)', parking: `üéØ <b>‰ΩéÊ∂à‰ªªÂãô</b>ÔºöÁï∂ÊúàÁ¥ØÁ©çÊªø <b>$3,000</b> Êâç‰∫´Âä†Á¢º<br><br>üõçÔ∏è <b>ÁîüÊ¥ªÂçáÁ¥ö 5%</b> (ÈôêÂà∑$6,666)<br>Ë°åÂãïÊîØ‰ªò/Â§ñÈÄÅ/È§êÂª≥/Ë≥ºÁâ©<br><br>‚úàÔ∏è <b>ÊóÖÈÅäÂä†Á¢º 5%</b> (ÈôêÂà∑$11,111/Â≠£)<br>Êµ∑Â§ñ/Ëà™Á©∫/ÊóÖË°åÁ§æ/È´òÈêµ`},
        { id: 'c2', name: 'ËÅØÈÇ¶Á∂†Âç°', nickname: 'Á∂†Ëâ≤/Â∏ÇÂçÄÂÅúËªäÁ•ûÂç°', note: 'Á∂†Ëâ≤ +5% (Âà∑ 3ÂçÉÂ∞ÅÈ†Ç) | ÂÅúËªä (Âà∑ 1.2Ëê¨ÈÅîÊ®ô)', rule: '', type: 'floor', target: 12000, tier1Rate: 0.02, tier2Rate: 0.02, gradient: 'linear-gradient(135deg, #20B2AA 0%, #008B8B 100%)', textColor: 'white', msgSuccess: 'Â∑≤ÈÅîÊ®ô (‰∏ãÊúàÂÖçÂÅú)', parking: `üÖøÔ∏è <b>ÂÖçË≤ªÂÅúËªäÔºö</b>ÈúÄ‰∏äÊúàÂà∑Êªø1.2Ëê¨<br>üåø <b>Á∂†Ëâ≤ÈÄöË∑Ø 6%</b><br>Âü∫Êú¨ 1% + Âä†Á¢º 5%<br>‚ö†Ô∏è Âä†Á¢ºÈÅ©Áî®ÊúàÂà∑ $3,000 Â∞ÅÈ†Ç (ÂõûÈ•ã $150)`},
        { id: 'c7', name: 'ÁéâÂ±± UNI Âç°', nickname: 'Ë°åÊîØ/ÁôæË≤®ÂÑ™Á≠âÁîü', note: 'UP 4.5% (Âà∑ 14Ëê¨Â∞ÅÈ†Ç)', type: 'ceiling', limit: 40000, tier1Rate: 0.035, tier2Rate: 0.01, gradient: 'linear-gradient(135deg, #a18cd1 0%, #fbc2eb 100%)', textColor: 'white', msgDanger: 'Â∑≤Â∞ÅÈ†Ç (ËÆä1%)', parking: `üî• <b>‰ªªÊÑèÈÅ∏ 3.5%</b> (ÈôêÂà∑$4Ëê¨)<br>üÜô <b>UP ÈÅ∏ 4.5%</b> (ÈôêÂà∑$14Ëê¨)<br>‚ÑπÔ∏è <b>Ë®ÇÈñ±Âª∫Ë≠∞</b>Ôºö<br>Ê∂àË≤ªÊªø $14,900 ‰ª•‰∏äÂª∫Ë≠∞Ë®ÇÈñ± UP ÈÅ∏`, getDynamicName: function() { const settings = JSON.parse(localStorage.getItem('uni_settings') || '{}'); return settings.isUp ? 'ÁéâÂ±± UNI Âç°ÔºàÂçáÁ¥öUPÈÅ∏Ôºâ' : 'ÁéâÂ±± UNI Âç°'; }},
        { id: 'c8', name: 'ÈÅ†Êù±Ê®ÇÂÆ∂+Âç°', nickname: 'ÁîüÊ¥ª/ÂØµÁâ©Á•ûÂç°', note: 'ÂØµÁâ©10% / ÁîüÊ¥ªÂÆâÂøÉ4% ', type: 'custom_happy', limit: 5263, minSpend: 3000, tier1Rate: 0.1, tier2Rate: 0.005, gradient: 'linear-gradient(135deg, #ff9a9e 0%, #fecfef 99%, #fecfef 100%)', textColor: 'white', msgDanger: 'Â∑≤Â∞ÅÈ†Ç (ËÆä0.5%)', parking: `üê∂ <b>ÂØµÁâ© 10%</b> (ÈôêÂà∑$5,263)<br>üçΩÔ∏è <b>ÂÆâÂøÉ/ÁîüÊ¥ª 4%</b> (ÈôêÂà∑$5,714)<br>‚úàÔ∏è <b>ÂúãÂ§ñ 2.5%</b> (ÁÑ°‰∏äÈôê)`},
        { id: 'c9', name: 'ÊªôË±êÊóÖ‰∫∫Âç°', nickname: 'Âì©Á®ãÁ¥ØÁ©ç', note: 'ÁÑ°Èôê:ÂúãÂÖß18/ÂúãÂ§ñ10 | Âæ°ÁíΩ:ÂúãÂÖß18/ÂúãÂ§ñ15', type: 'miles', gradient: 'linear-gradient(135deg, #1e3c72 0%, #2a5298 100%)', textColor: 'white', msgDanger: '', parking: `‚úàÔ∏è <b>Âì©Á®ãÁ¥ØÁ©çÁ•ûÂç°</b>`, getDynamicName: function() { const tier = localStorage.getItem('hsbc_tier') || 'infinite'; return tier === 'infinite' ? 'ÊªôË±êÊóÖ‰∫∫ÁÑ°ÈôêÂç°' : tier === 'light' ? 'ÊªôË±êÊóÖ‰∫∫ËºïÊóÖÂç°' : 'ÊªôË±êÊóÖ‰∫∫Âæ°ÁíΩÂç°'; }},
        { id: 'c11', name: 'Âè∞Êñ∞ Richart Âç°', nickname: 'Ê¨äÁõäËá™Áî±ÈÅ∏', note: 'Âè∞Êñ∞Pay 3.8% (ÁÑ°‰∏äÈôê)', type: 'ceiling', limit: 99999999, tier1Rate: 0.038, tier2Rate: 0.003, gradient: 'linear-gradient(135deg, #0F2027 0%, #203A43 50%, #2C5364 100%)', textColor: 'white', msgDanger: '', parking: `üê∂ <b>Ê¨äÁõäËá™Áî±ÈÅ∏ (ÁÑ°‰∏äÈôêÂõûÈ•ã)</b>`},
        { id: 'j1', name: 'ÂØåÈÇ¶ J Âç°', nickname: 'Êó•ÈüìÊóÖÈÅäÂÑ™Á≠âÁîü', note: 'Êó•ÈüìÊ≥∞$3.3Ëê¨/‰∫§ÈÄöÂç°$2,857(Â≠£)',type: 'custom_j', limit: 0, gradient: 'linear-gradient(135deg, #FF7E5F 0%, #FEB47B 100%)', textColor: 'white', msgDanger: '', parking: `üáØüáµüá∞üá∑üáπüá≠ <b>ÂØ¶È´îÊ∂àË≤ªÂä†Á¢º</b> (ÂÖ±Áî®Â≠£‰∏äÈôê$1000ÂõûÈ•ã)<br>‚Ä¢ Êó•ÈüìÂØ¶È´îÔºö3%+3%=6% (Âà∑$33,333Â∞ÅÈ†Ç)<br>‚Ä¢ Ê≥∞ÂúãÂØ¶È´îÔºö1%+5%=6% (Âà∑$20,000Â∞ÅÈ†Ç)<br>‚ö†Ô∏è ÈúÄÂñÆÁ≠ÜÊªø $1,000<br><br>üçé <b>Êó•Êú¨‰∫§ÈÄöÂç°</b> (Áç®Á´ãÂ≠£‰∏äÈôê$200ÂõûÈ•ã)<br>‚Ä¢ Suica/PASMOÁ≠âÔºö3%+7%=10% (Âà∑$2,857Â∞ÅÈ†Ç)<br>‚ö†Ô∏è ÈúÄÂñÆÁ≠ÜÊªø $2,000`},
        { id: 'j2', name: 'ËÅØÈÇ¶ÂêâÈ∂¥Âç°', nickname: 'Êó•Êú¨/ApplePayÈ¶ñÈÅ∏', note: 'Êó•Êú¨ AP 4% (Âà∑ 4Ëê¨Â∞ÅÈ†Ç) | ÂúãÂÖßÊó•Á≥ª 5%', type: 'ceiling', limit: 40000, tier1Rate: 0.04, tier2Rate: 0.025, gradient: 'linear-gradient(135deg, #DC143C 0%, #FFFFFF 150%)', textColor: 'white', msgDanger: 'Âä†Á¢ºÂ∑≤Â∞ÅÈ†Ç (ËÆä2.5%)', parking: `üçé <b>Êó•Êú¨ QUICPay (Apple Pay)</b><br>Êó•Êú¨ 2.5% + Âä†Á¢º 1.5% = 4%<br>‚ö†Ô∏è Âä†Á¢º‰∏äÈôê $600/Êúà (Á¥ÑÂà∑$4Ëê¨)<br>üáπüáº <b>ÂúãÂÖßÊó•Á≥ªÂêçÂ∫ó 5%</b><br>ÂúãÂÖß 1% + Âä†Á¢º 4% (Âà∑$1.25Ëê¨Â∞ÅÈ†Ç)`},
        { id: 'j3', name: 'ÁéâÂ±±ÁÜäÊú¨ÁÜäÂç°', nickname: 'Êó•Êú¨ÂÑ™Á≠âÁîü', note: 'PayPay 5% (Â≠£) | ÊåáÂÆö 8.5%', type: 'ceiling', limit: 8333, tier1Rate: 0.085, tier2Rate: 0.025, gradient: 'linear-gradient(135deg, #BDC3C7 0%, #2C3E50 100%)', textColor: 'white', msgDanger: 'Âä†Á¢ºÂ∑≤Â∞ÅÈ†Ç', parking: `üêª <b>ÊåáÂÆöÈÄöË∑Ø 8.5%</b><br>(Âü∫Êú¨2.5% + Âä†Á¢º6%)<br>‚ö†Ô∏è Âä†Á¢º‰∏äÈôê $500/Êúü (Á¥ÑÂà∑$8,333)<br>üì± <b>PayPay 5%</b> (3.5%+1.5%ÂÖçÊâãÁ∫åË≤ª)<br>‚ö†Ô∏è 3.5%Âä†Á¢º‰∏äÈôê $100/Â≠£ (Á¥ÑÂà∑$2,857)<br>üî∞ <b>ÂúãÂÖß‰∏ÄËà¨ 0.5%</b> (ÁÑ°‰∏äÈôê)`},
        { id: 'j4', name: 'Ê∞∏Ë±êÂπ£ÂÄçÂç° (Â§ßÂ§ß/Â§ßÊà∂)', nickname: 'Êµ∑Â§ñÈõôÂπ£Á•ûÂç°', note: 'Êµ∑Â§ñÁ≤æÈÅ∏ 6% (Âà∑ 2Ëê¨Â∞ÅÈ†Ç)', type: 'ceiling', limit: 80000, tier1Rate: 0.06, tier2Rate: 0.02, gradient: 'linear-gradient(135deg, #FDC830 0%, #F37335 100%)', textColor: 'white', msgDanger: 'Âä†Á¢ºÂ∑≤Â∞ÅÈ†Ç', parking: `üí∞ <b>Âπ£ÂÄçÂç° 2026</b><br><b>Level 1 (Â§ßÂ§ß)</b><br>Ê¢ù‰ª∂ÔºöËá™ÂãïÊâ£Áπ≥+ÈõªÂ≠êÂ∏≥ÂñÆ<br>ÈôêÂà∑Ôºö$7,500<br><br><b>Level 2 (Â§ßÊà∂)</b><br>Ê¢ù‰ª∂ÔºöÂæÄ‰æÜË≥áÁî¢‚â•10Ëê¨<br>ÈôêÂà∑Ôºö$20,000`},
        { id: 'j5', name: 'Ê∞∏Ë±ê‰∏â‰∫ïËÅØÂêçÂç°', nickname: 'È§êÈ£≤ÂÑ™Á≠âÁîü/Êó•ÈüìÊ≥∞ÈôÑÂä†', note: 'È§êÈ£≤ 7.3% (Â∫ï0.3%+7%)', type: 'custom_mitsui', target: 30000, tier1Rate: 0.073, tier2Rate: 0.003, gradient: 'linear-gradient(135deg, #00C9FF 0%, #92FE9D 100%)', textColor: '#333', msgSuccess: 'Â∑≤ÈÅîÊ®ô (È†ò$2000)', parking: `üçΩÔ∏è <b>ÁâπÈÅ∏È§êÈ£≤ 7.3%</b> (0.3+7)<br>ÈÄöË∑ØÔºöÈ§®Â§ñÈ§êÈ£≤(MCC 58xx) / ÂÖ®Áõà+PAY<br>‚ö†Ô∏è Âä†Á¢º‰∏äÈôêÂÉÖ 100 ÂÖÉ (Á¥ÑÂà∑ $1,428)<br><br>üáØüáµ <b>Êó•ÈüìÊ≥∞ÊªøÈ°çÁ¶Æ (ÈúÄÁôªÈåÑ)</b><br>ÊØèÂ≠£Á¥ØÁ©çÊªø 30,000 ÈÄÅ 2,000 (ÂõûÈ•ãÁ¥Ñ6.9%)`},
        { id: 'c12', name: 'Ê∞∏Ë±êÁèæÈáëÂõûÈ•ã JCB', nickname: 'ÊóÖÊó•Á•ûÂç°', note: 'ÂúãÂÖßÁâπÈÅ∏/Êó•Êú¨ +3% (Êúà$1Ëê¨ÂÖ±Áî®)', type: 'custom_jcb', limit: 10000, tier1Rate: 0.05, tier2Rate: 0.01, gradient: 'linear-gradient(135deg, #8E0E00 0%, #1F1C18 100%)', textColor: 'white', msgDanger: 'ÁâπÈÅ∏Â∑≤Â∞ÅÈ†Ç (ËÆä1%)', parking: `üáØüáµ <b>Êó•Êú¨Ê∂àË≤ª</b><br>ÊúÄÈ´ò 5% (ÂúãÂ§ñ2% + Âä†Á¢º3%)<br>üõçÔ∏è <b>ÁâπÈÅ∏ÈÄöË∑Ø</b><br>ÊúÄÈ´ò 5% (ÂúãÂ§ñ2% + Âä†Á¢º3%) Êàñ 4% (ÂúãÂÖß1% + Âä†Á¢º3%)<br>‚ö†Ô∏è Êó•Êú¨+ÁâπÈÅ∏ÂÖ±Áî®Âä†Á¢º‰∏äÈôê $300/Êúà (Á¥ÑÂà∑ $10,000)<br>üî• <b>Êó•ÈüìÊ≥∞ÊªøÈ°ç</b> (ÈúÄÁôªÈåÑ)<br>ÊØèÂ≠£Á¥ØÁ©çÊªø 2 Ëê¨ÈÄÅ $1,000 (ÂÖ±Áî®‰∏äÈôê)`},
        { id: 'cube1', name: 'ÂúãÊ≥∞ CUBE Âç°', nickname: 'ÊåáÂÆöÈÄöË∑ØÁÑ°‰∏äÈôê', note: 'Áé©Êï∏‰Ωç/Ê®ÇÈ•óË≥º/Ë∂£ÊóÖË°å 3% ÁÑ°‰∏äÈôê', type: 'custom_cube', gradient: 'linear-gradient(135deg, #1B365D 0%, #4A90D9 100%)', textColor: 'white', msgDanger: '', parking: `üñ•Ô∏è <b>Áé©Êï∏‰Ωç</b> ‰æùÁ≠âÁ¥ö 2%/3%/3.3%<br>Ëù¶ÁöÆ/momo/PChome/Netflix/ChatGPT/Claude/Max<br><br>üçΩÔ∏è <b>Ê®ÇÈ•óË≥º</b> ‰æùÁ≠âÁ¥ö 2%/3%/3.3%<br>34ÂÆ∂ÂúãÂÖßÁôæË≤®/ÂúãÂÖßÈ§êÈ£≤+È∫•Áï∂Âãû/Â§ñÈÄÅ/Ëó•Â¶ù<br><br>‚úàÔ∏è <b>Ë∂£ÊóÖË°å</b> ‰æùÁ≠âÁ¥ö 2%/3%/3.3%<br>Êµ∑Â§ñÂØ¶È´î/20ÂÆ∂Ëà™Á©∫/È´òÈêµ/6Ë®ÇÊàøÂπ≥Âè∞/13ÊóÖË°åÁ§æ/ÂúãÂÖßÈ£ØÂ∫ó<br><br>üõí <b>ÈõÜÁ≤æÈÅ∏</b> Âõ∫ÂÆö 2%<br>7-11/ÂÖ®ÂÆ∂/ÂÖ®ËÅØ/ÂÆ∂Ê®ÇÁ¶è/IKEA/‰∏≠Ê≤π/ÂÖÖÈõªÂÅúËªä<br><br>üéÇ <b>ÊÖ∂ÁîüÊúà</b> (ÈôêÁï∂ÊúàÂ£ΩÊòü)<br>7È°ûÊåáÂÆöÈ§êÂª≥/Ê®ÇÂúí/KTV 10% | Êñ∞ÂÖâ‰∏âË∂ä/Uber Eats 3.5%<br><br>üé∏ <b>ÁòãÂ§ßÊ∏Ø</b> (ÈôêÊôÇ~3/23)<br>ÁèæÂ†¥Ê∂àË≤ª10% | È´òÈõÑ‰ΩèÂÆø/Klook/È´òÈêµ 3.5%<br><br>üü¢ <b>LINE Pay È†òÂà∏</b> +1.7% (Êúà‰∏äÈôê100Èªû)<br>‚ö†Ô∏è ÈúÄËá≥ CUBE App È†òÂà∏ÔºåÁï∂ÊúàÊªø 8 Á≠Ü`},
        { id: 'add1', name: 'Êñ∞Â¢ûÂç°Áâá', nickname: 'ÈªûÊìäÈÅ∏Âç°', note: 'ÂâçÂæÄË≥áÊñôÂ∫´ÊåëÈÅ∏', type: 'placeholder', gradient: 'linear-gradient(135deg, #e0e0e0 0%, #f5f5f5 100%)', textColor: '#999', msgDanger: '' }
    ];
  let visibleCards = JSON.parse(localStorage.getItem('visibleCards')), savedOrder = JSON.parse(localStorage.getItem('cardOrder')), cards = [...defaultCards], sortableInstance = null;
    
    // ËºâÂÖ•Ëá™Âª∫Âç°Áâá
    function loadCustomCards() {
        const customs = JSON.parse(localStorage.getItem('custom_cards') || '[]');
        // ÁßªÈô§ËàäÁöÑËá™Âª∫Âç°Ôºà‰øùÁïô defaultCards + add1Ôºâ
        cards = [...defaultCards];
        customs.forEach(cc => {
            const t2 = cc.tier2Rate || 0;
            let note = '';
            if (cc.cap > 0) {
                note = t2 > 0 ? `${cc.rate}% (Âà∑$${cc.cap.toLocaleString()}Â∞ÅÈ†Ç‚Üí${t2}%)` : `${cc.rate}% (Âà∑$${cc.cap.toLocaleString()}Â∞ÅÈ†Ç)`;
            } else {
                note = `${cc.rate}% (ÁÑ°‰∏äÈôê)`;
            }
            const cardObj = {
                id: cc.id,
                name: cc.name,
                nickname: cc.nickname || '',
                note: note,
                type: cc.cap > 0 ? 'ceiling' : 'ceiling',
                limit: cc.cap > 0 ? cc.cap : 99999999,
                tier1Rate: cc.rate / 100,
                tier2Rate: t2 / 100,
                gradient: cc.gradient,
                textColor: cc.textColor || 'white',
                msgDanger: cc.cap > 0 ? (t2 > 0 ? `Â∑≤Â∞ÅÈ†Ç (ËÆä${t2}%)` : 'Â∑≤Â∞ÅÈ†Ç') : '',
                parking: '',
                isCustom: true,
                isMiles: cc.unit === 'miles'
            };
            if (cc.unit === 'miles') cardObj.type = 'miles';
          // Êö±Á®±ÂêåÊ≠•Âà∞ cardSettings
            if (cc.nickname) {
                if (!cardSettings[cc.id]) cardSettings[cc.id] = {};
                cardSettings[cc.id].nickname = cc.nickname;
            }
            // ÊèíÂÖ•Âà∞ add1 ‰πãÂâç
            const addIdx = cards.findIndex(c => c.id === 'add1');
            cards.splice(addIdx, 0, cardObj);
        });
    }
    loadCustomCards();

    const customColorPresets = [
        { name: 'Ê∑±Ëóç', gradient: 'linear-gradient(135deg, #1a2a6c 0%, #b21f1f 50%, #fdbb2d 100%)', textColor: 'white' },
        { name: 'Â¢®Èªë', gradient: 'linear-gradient(135deg, #232526 0%, #414345 100%)', textColor: 'white' },
        { name: 'ÈÖíÁ¥Ö', gradient: 'linear-gradient(135deg, #870000 0%, #190A05 100%)', textColor: 'white' },
        { name: 'Ê£ÆÁ∂†', gradient: 'linear-gradient(135deg, #134E5E 0%, #71B280 100%)', textColor: 'white' },
        { name: 'Á¥´ÁæÖËò≠', gradient: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)', textColor: 'white' },
        { name: 'Áé´Áë∞Èáë', gradient: 'linear-gradient(135deg, #f5af19 0%, #f12711 100%)', textColor: 'white' },
        { name: 'ÈäÄÁÅ∞', gradient: 'linear-gradient(135deg, #bdc3c7 0%, #2c3e50 100%)', textColor: 'white' },
        { name: 'Ê∑∫Á≤â', gradient: 'linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%)', textColor: '#333' }
    ];
    let selectedCustomColor = 0;

    function openCustomCardModal(editId) {
        const modal = document.getElementById('customCardModal');
        const title = document.getElementById('customCardTitle');
        document.getElementById('customCardEditId').value = editId || '';

        // Ê∏≤ÊüìÈ°èËâ≤ÈÅ∏ÊìáÂô®
        const picker = document.getElementById('customColorPicker');
        picker.innerHTML = '';
        customColorPresets.forEach((c, i) => {
            const dot = document.createElement('div');
            dot.style.cssText = `width:36px; height:36px; border-radius:10px; cursor:pointer; border:3px solid ${i === selectedCustomColor ? '#007AFF' : 'transparent'}; background:${c.gradient};`;
            dot.onclick = () => { selectedCustomColor = i; document.querySelectorAll('#customColorPicker > div').forEach((d,j) => d.style.borderColor = j===i ? '#007AFF' : 'transparent'); };
            picker.appendChild(dot);
        });

        // ÁµêÂ∏≥Êó•ÈÅ∏È†Ö
        const sel = document.getElementById('customCardCycleDay');
        if (sel.options.length <= 1) {
            for (let i = 1; i <= 31; i++) sel.add(new Option(`ÊØèÊúà ${i} Ëôü`, i));
        }

        if (editId) {
            title.innerText = 'Á∑®ËºØËá™Âª∫Âç°Áâá';
            const customs = JSON.parse(localStorage.getItem('custom_cards') || '[]');
            const cc = customs.find(c => c.id === editId);
            if (cc) {
                document.getElementById('customCardName').value = cc.name;
                document.getElementById('customCardNickname').value = cc.nickname || '';
                document.getElementById('customCardRate').value = cc.rate;
                document.querySelector(`input[name="customCardUnit"][value="${cc.unit}"]`).checked = true;
                document.getElementById('customCardCap').value = cc.cap > 0 ? cc.cap : '';
                document.getElementById('customCardTier2Rate').value = cc.tier2Rate > 0 ? cc.tier2Rate : '';
                document.getElementById('customCardCycleDay').value = cc.cycleDay || '';
                const ci = customColorPresets.findIndex(p => p.gradient === cc.gradient);
                selectedCustomColor = ci >= 0 ? ci : 0;
                // ÈáçÊñ∞Ê∏≤ÊüìÈ°èËâ≤ÈÅ∏‰∏≠ÁãÄÊÖã
                picker.innerHTML = '';
                customColorPresets.forEach((c, i) => {
                    const dot = document.createElement('div');
                    dot.style.cssText = `width:36px; height:36px; border-radius:10px; cursor:pointer; border:3px solid ${i === selectedCustomColor ? '#007AFF' : 'transparent'}; background:${c.gradient};`;
                    dot.onclick = () => { selectedCustomColor = i; document.querySelectorAll('#customColorPicker > div').forEach((d,j) => d.style.borderColor = j===i ? '#007AFF' : 'transparent'); };
                    picker.appendChild(dot);
                });
                // ËºâÂÖ•Â∑≤Â≠òÁÖßÁâá
                const existingPhoto = localStorage.getItem('card_photo_' + editId);
                window._pendingCustomCardPhoto = null;
                document.getElementById('customCardPhotoInput').value = '';
                if (existingPhoto) {
                    document.getElementById('customPhotoPreviewImg').src = existingPhoto;
                    document.getElementById('customPhotoPreviewBox').style.display = 'block';
                    document.getElementById('btnRemoveCustomPhoto').style.display = 'inline-block';
                } else {
                    document.getElementById('customPhotoPreviewBox').style.display = 'none';
                    document.getElementById('btnRemoveCustomPhoto').style.display = 'none';
                }
            }
        } else {
            title.innerText = 'Ëá™Âª∫Âç°Áâá';
           document.getElementById('customCardName').value = '';
            document.getElementById('customCardNickname').value = '';
            document.getElementById('customCardRate').value = '';
            document.querySelector('input[name="customCardUnit"][value="cash"]').checked = true;
            document.getElementById('customCardCap').value = '';
            document.getElementById('customCardTier2Rate').value = '';
            document.getElementById('customCardCycleDay').value = '';
            selectedCustomColor = 0;
            // ÈáçÁΩÆÁÖßÁâá
            window._pendingCustomCardPhoto = null;
            document.getElementById('customCardPhotoInput').value = '';
            document.getElementById('customPhotoPreviewBox').style.display = 'none';
            document.getElementById('btnRemoveCustomPhoto').style.display = 'none';
        }

      document.getElementById('customCardDeleteArea').style.display = editId ? 'block' : 'none';
        modal.style.display = 'flex';
        history.pushState({ modal: true }, '');
    }

    function saveCustomCard() {
        const name = document.getElementById('customCardName').value.trim();
        const rate = parseFloat(document.getElementById('customCardRate').value);
        if (!name) { alert('Ë´ãËº∏ÂÖ•Âç°ÁâáÂêçÁ®±'); return; }
        if (isNaN(rate) || rate <= 0) { alert('Ë´ãËº∏ÂÖ•ÊúâÊïàÁöÑÂõûÈ•ãÁéá'); return; }

       const nickname = document.getElementById('customCardNickname').value.trim();
        const unit = document.querySelector('input[name="customCardUnit"]:checked').value;
        const cap = parseInt(document.getElementById('customCardCap').value) || 0;
        const tier2Rate = parseFloat(document.getElementById('customCardTier2Rate').value) || 0;
        const cycleDay = document.getElementById('customCardCycleDay').value;
        const color = customColorPresets[selectedCustomColor];
        const editId = document.getElementById('customCardEditId').value;

        let customs = JSON.parse(localStorage.getItem('custom_cards') || '[]');

        if (editId) {
            const idx = customs.findIndex(c => c.id === editId);
            if (idx >= 0) {
                customs[idx] = { ...customs[idx], name, nickname, rate, unit, cap, tier2Rate, cycleDay, gradient: color.gradient, textColor: color.textColor };
            }
        } else {
            if (customs.length >= 5) { alert('Ëá™Âª∫Âç°ÁâáÊúÄÂ§ö 5 Âºµ'); return; }
            const newId = 'custom_' + Date.now();
           customs.push({ id: newId, name, nickname, rate, unit, cap, tier2Rate, cycleDay, gradient: color.gradient, textColor: color.textColor });
        }

        localStorage.setItem('custom_cards', JSON.stringify(customs));
        loadCustomCards();

        // Êñ∞Âª∫ÊôÇËá™ÂãïÂä†ÂÖ•È¶ñÈ†Å
        if (!editId) {
            const newCard = customs[customs.length - 1];
            let realCards = visibleCards.filter(id => id !== 'add1');
            if (realCards.length < 8) {
                realCards.push(newCard.id);
                visibleCards = realCards.length < 8 ? [...realCards, 'add1'] : realCards;
                localStorage.setItem('visibleCards', JSON.stringify(visibleCards));
            }
        }

        // Ëá™Âª∫Âç°ÁµêÂ∏≥Êó•Â≠òÂÖ• cardSettings
        if (editId || customs.length > 0) {
            const targetId = editId || customs[customs.length - 1].id;
            if (!cardSettings[targetId]) cardSettings[targetId] = {};
            cardSettings[targetId].cycleDay = cycleDay;
            localStorage.setItem('cardSettings', JSON.stringify(cardSettings));
        }

        document.getElementById('customCardModal').style.display = 'none';
        
        // ÂÑ≤Â≠òÁÖßÁâá
        const savedCardId = editId || customs[customs.length - 1].id;
        if (window._pendingCustomCardPhoto === '__remove__') {
            localStorage.removeItem('card_photo_' + savedCardId);
        } else if (window._pendingCustomCardPhoto) {
            localStorage.setItem('card_photo_' + savedCardId, window._pendingCustomCardPhoto);
        }
        window._pendingCustomCardPhoto = null;
        
        renderManageList();
        renderGrid();
    }

    function deleteCustomCard(cardId) {
        if (!confirm('Á¢∫ÂÆöÂà™Èô§ÈÄôÂºµËá™Âª∫Âç°ÁâáÔºüÔºàÊ∂àË≤ªÁ¥ÄÈåÑÊúÉ‰øùÁïôÔºâ')) return;
        let customs = JSON.parse(localStorage.getItem('custom_cards') || '[]');
        customs = customs.filter(c => c.id !== cardId);
        localStorage.setItem('custom_cards', JSON.stringify(customs));

        // ÂæûÈ¶ñÈ†ÅÁßªÈô§
        visibleCards = visibleCards.filter(id => id !== cardId);
        localStorage.setItem('visibleCards', JSON.stringify(visibleCards));

        loadCustomCards();
        renderManageList();
        renderGrid();
    }
    function getSortedCards() {
        if (!visibleCards) return [];
        let displayCards = cards.filter(c => visibleCards.includes(c.id));
        if (displayCards.filter(c => c.type !== 'placeholder').length < 8 && !visibleCards.includes('add1')) displayCards.push(cards.find(c => c.id === 'add1'));
        if (savedOrder) displayCards.sort((a, b) => (savedOrder.indexOf(a.id) === -1 ? 999 : savedOrder.indexOf(a.id)) - (savedOrder.indexOf(b.id) === -1 ? 999 : savedOrder.indexOf(b.id)));
        return displayCards;
    }
    function initSortable() {
        if (sortableInstance) sortableInstance.destroy();
        sortableInstance = new Sortable(document.getElementById('card-grid'), { animation: 150, ghostClass: 'sortable-ghost', dragClass: 'sortable-drag', delay: 200, delayOnTouchOnly: true, forceFallback: true, onEnd: function (evt) { const allIds = cards.map(c => c.id), vis = Array.from(evt.to.children).map(el => el.getAttribute('data-card-id')), hidden = allIds.filter(id => !vis.includes(id)); localStorage.setItem('cardOrder', JSON.stringify([...vis, ...hidden])); savedOrder = [...vis, ...hidden]; } });
    }

    // ==========================================
    // UniOpen ÂÆåÊï¥ÂìÅÁâåÊ∏ÖÂñÆ (‰æùÊìöÁµ±‰∏Ä‰ºÅÊ•≠ÈõÜÂúò)
    // ==========================================
    const uniBrandCategories = {
        cat1: { 
            name: '‰æøÂà©ÂïÜÂ∫ó/Ë∂ÖÂ∏Ç', 
            brands: ['7-ELEVEN', 'Â∫∑ÊòØÁæé', 'ËÅñÂæ∑ÁßëÊñØ', 'Áµ±‰∏ÄÁîüÊ©ü', 'Mia C\'bon', 'ÂÆ∂Ê®ÇÁ¶è'] 
        },
        cat2: { 
            name: 'ÁôæË≤®/Ë≥ºÁâ©', 
            brands: ['Áµ±‰∏ÄÊôÇ‰ª£', 'Â§¢ÊôÇ‰ª£', 'UNICCY', 'ÂçöÂÆ¢‰æÜ', 'YahooË≥ºÁâ©', 'ÈÖ∑ËÅñÁü≥'] 
        },
        cat3: { 
            name: 'È§êÈ£≤/ÁîúÈªû', 
            brands: ['ÊòüÂ∑¥ÂÖã', 'Mister Donut', 'Cold Stone', '21È¢®Âë≥È§®', '21 Plus', 'ËÅñÂ®ú', 'Semeur'] 
        },
        cat4: { 
            name: 'ÂÅ•Ë∫´/‰ºëÈñí', 
            brands: ['BEING sport', 'BEING spa', 'BEING fit', 'Áµ±‰∏ÄÊ∏°ÂÅáÊùë'] 
        },
        cat5: { 
            name: 'ÁîüÊ¥ªÊúçÂãô', 
            brands: ['DUSKIN', 'ÂÆÖÊÄ•‰æø', 'ibon', 'foodomo', 'ÈÄüÈÇÅÊ®ÇÂä†Ê≤π', 'ÈÆÆÊãæ'] 
        },
        cat6: { 
            name: 'ÊóÖÈÅä/È£ØÂ∫ó', 
            brands: ['W Taipei', 'Hotel Resonance', 'Áé≤ÁìèÊªøËóù'] 
        }
    };

    // ÂèñÂæóÁï∂ÊúüÁöÑË∏©ÈªûË®òÈåÑ key
    function getUniBrandCycleKey() {
        const now = new Date();
        return `uni_brands_${now.getFullYear()}_${now.getMonth() + 1}`;
    }

    // ÂàùÂßãÂåñ UniOpen ÂìÅÁâåÊ†º (ÂàÜÈ°ûÁâà)
    const uniChannelCategories = {
        pay: { name: 'Ë°åÂãïÊîØ‰ªò', items: ['ÁéâÂ±±Wallet', 'LINE Pay', 'ÂÖ®ÊîØ‰ªò', 'Ë°óÂè£ÊîØ‰ªò', 'ÊÇ†ÈÅä‰ªò', 'ÂÖ®Áõà+PAY', 'iPASS MONEY', 'icash Pay'] },
        ecom: { name: 'ÈõªÂïÜÂπ≥Âè∞', items: ['momoË≥ºÁâ©Á∂≤', 'Ëù¶ÁöÆË≥ºÁâ©', 'Ê∑òÂØ∂Á∂≤', 'CoupangÈÖ∑Êæé'] },
        dept: { name: 'ÂúãÂÖßÁôæË≤®', items: ['Êñ∞ÂÖâ‰∏âË∂ä', 'Âè∞Âåó101', 'ËèØÊ≥∞ÂêçÂìÅÂüé', '‰∏â‰∫ïOUTLET', '‰∫¨Á´ô', 'ÁæéÈ∫óËèØ', 'ÁßÄÊ≥∞ÁîüÊ¥ª', 'LaLaport', 'Áµ±È†òÂª£Â†¥', 'ÈááÁõü', 'ÊòáÊÅÜÊòå', 'Áµ±‰∏ÄÊôÇ‰ª£ÁôæË≤®', 'ÈÅ†Êù±ÁôæË≤®', 'Êº¢Á•ûÁôæË≤®', 'ÂæÆÈ¢®ÁôæË≤®', 'Ë™†ÂìÅÁîüÊ¥ª'] },
        life: { name: 'ÁîüÊ¥ªÊé°Ë≤∑', items: ['ÂÆ∂Ê®ÇÁ¶è', 'Â±àËá£Ê∞è', 'Â∫∑ÊòØÁæé', 'ÁâπÂäõÂ±ã', 'HOLA', 'hoiÂ•ΩÂ•ΩÁîüÊ¥ª', 'UNIQLO', 'NET', 'Â§ßÊ®πËó•Â±Ä', '‰∏Å‰∏ÅËó•Â¶ù'] },
        food: { name: 'È§êÈ£≤ÁæéÈ£ü', items: ['Uber Eats', 'foodpanda', 'EZTABLE', 'ÁéãÂìÅÁòãPay', 'È•óË≥ìÈ§êÈ£≤', 'Áì¶ÂüéÊñôÁêÜ', '‰πæÊùØÁáíËÇâ', 'Êº¢‰æÜÁæéÈ£ü', 'ÈºéÁéãÈ§êÈ£≤', 'Áà≠ÈÆÆÈ§êÈ£≤'] },
        transport: { name: 'Âä†Ê≤π‰∫§ÈÄö', items: ['Âè∞ÁÅ£‰∏≠Ê≤π', '55688', 'Âè∞Èêµ', 'È´òÈêµ', 'Uber', 'Yoxi'] },
        travel: { name: 'Ëà™Á©∫ÊóÖÈÅä', items: ['‰∏≠ËèØËà™Á©∫', 'Èï∑Ê¶ÆËà™Á©∫', 'Êó•Êú¨Ëà™Á©∫', 'Âè∞ÁÅ£ËôéËà™', 'Ê®ÇÊ°ÉËà™Á©∫', 'ÈÖ∑Ëà™', 'Trip.com', 'Booking.com', 'Hotels.com', 'AsiaYo', 'Expedia', 'KKday', 'Klook', 'ÈõÑÁçÖÊóÖÈÅä', 'ÂèØÊ®ÇÊóÖÈÅä', 'Êù±ÂçóÊóÖÈÅä', 'Agoda'] },
        overseas: { name: 'ÂúãÂ§ñÂØ¶È´î', items: ['Êó•Êú¨', 'ÈüìÂúã', 'Ê≥∞Âúã', 'Ë∂äÂçó', 'Êñ∞Âä†Âù°', 'È¶¨‰æÜË•ø‰∫û', 'Ëè≤ÂæãË≥ì', '‰∏≠Âúã', 'È¶ôÊ∏Ø', 'Êæ≥ÈñÄ', 'ÁæéÂúã', 'Âä†ÊãøÂ§ß', 'Ëã±Âúã', 'Ê≥ïÂúã', 'Âæ∑Âúã', 'Áæ©Â§ßÂà©', 'Êæ≥Ê¥≤'] },
        select: { name: 'Á≤æÈÅ∏ÂïÜÂÆ∂', items: ['AppleÁõ¥ÁáüÂ∫ó', 'Â∞èÁ±≥Âè∞ÁÅ£', 'ÂÖ®ÂúãÈõªÂ≠ê', 'Áá¶Âù§', 'Ëø™Âç°ÂÑÇ'] },
        esg: { name: 'ESGÊ∞∏Á∫å', items: ['ÁéâÂ±±WalletÊÑõÂøÉÊçêÊ¨æ', 'ÁâπÊñØÊãâ', 'GogoroÈõªÊ±†Ë≥áË≤ª', 'YouBike 2.0'] }
    };

    function toggleUniChannelList() {
        const container = document.getElementById('uniChannelContainer');
        const btn = document.getElementById('btnToggleUniChannel');
        if (container.style.display === 'none') {
            container.style.display = 'block';
            btn.innerText = 'Êî∂ÂêàÈÄöË∑Ø ‚ñ≤';
            initUniChannelGrid();
        } else {
            container.style.display = 'none';
            btn.innerText = 'Â±ïÈñãÈÄöË∑Ø ‚ñº';
        }
    }

    function initUniChannelGrid() {
        const container = document.getElementById('uniChannelContainer');
        if (!container) return;
        const saved = JSON.parse(localStorage.getItem('uni_channels') || '[]');
        container.innerHTML = '';

        Object.keys(uniChannelCategories).forEach(catId => {
            const cat = uniChannelCategories[catId];
            const section = document.createElement('div');
            section.style.cssText = 'margin-bottom:8px;';
            section.innerHTML = `<div style="font-size:11px; font-weight:bold; color:#555; margin-bottom:4px;">${cat.name}</div>`;
            const grid = document.createElement('div');
            grid.style.cssText = 'display:flex; flex-wrap:wrap; gap:4px;';
            cat.items.forEach(item => {
                const btn = document.createElement('div');
                const isActive = saved.includes(item);
                btn.className = 'brand-btn' + (isActive ? ' active' : '');
                btn.innerText = item;
                btn.onclick = () => {
                    const current = JSON.parse(localStorage.getItem('uni_channels') || '[]');
                    if (current.includes(item)) {
                        localStorage.setItem('uni_channels', JSON.stringify(current.filter(c => c !== item)));
                    } else if (current.length >= 8) {
                        alert('ÊúÄÂ§öÂè™ËÉΩÈÅ∏ 8 ÂÄãÈÄöË∑Ø');
                        return;
                    } else {
                        current.push(item);
                        localStorage.setItem('uni_channels', JSON.stringify(current));
                    }
                    initUniChannelGrid();
                };
                grid.appendChild(btn);
            });
            section.appendChild(grid);
            container.appendChild(section);
        });

        document.getElementById('uniChannelCount').innerText = `(${saved.length}/8)`;
        updateUniChannelSummary(saved);
    }

    function updateUniChannelSummary(channels) {
        const el = document.getElementById('uniChannelSummary');
        if (!el) return;
        if (!channels || channels.length === 0) {
            el.innerHTML = '<span style="color:#999;">Â∞öÊú™ÈÅ∏ÊìáÈÄöË∑Ø</span>';
        } else {
            el.innerHTML = 'Â∑≤ÈÅ∏Ôºö' + channels.map(c => `<span style="display:inline-block; background:#E3F2FD; color:#1565C0; padding:1px 6px; border-radius:4px; margin:1px 2px; font-size:10px; font-weight:600;">${c}</span>`).join('');
        }
    }

    function initUniBrandGrid() {
        const cycleKey = getUniBrandCycleKey();
        const selected = JSON.parse(localStorage.getItem(cycleKey) || '[]');
        
        Object.keys(uniBrandCategories).forEach(catId => {
            const grid = document.getElementById('uniBrandGrid-' + catId);
            if (!grid) return;
            grid.innerHTML = '';
            
            uniBrandCategories[catId].brands.forEach(brand => {
                const btn = document.createElement('div');
                btn.className = 'brand-btn' + (selected.includes(brand) ? ' active' : '');
                btn.innerText = brand;
                btn.onclick = () => { 
                    btn.classList.toggle('active'); 
                    saveUniBrands(); 
                };
                grid.appendChild(btn);
            });
        });
        
        updateTaskBonusDisplay();
    }

    // ÂÑ≤Â≠ò UniOpen ÂìÅÁâåÈÅ∏Êìá (ÊåâÈÄ±Êúü)
    function saveUniBrands() {
        const cycleKey = getUniBrandCycleKey();
        const selected = [];
        
        Object.keys(uniBrandCategories).forEach(catId => {
            const grid = document.getElementById('uniBrandGrid-' + catId);
            if (!grid) return;
            grid.querySelectorAll('.brand-btn.active').forEach(btn => {
                selected.push(btn.innerText);
            });
        });
        
        localStorage.setItem(cycleKey, JSON.stringify(selected));
        updateTaskBonusDisplay();
        updateRewardPreview();
    }

    // ÂèñÂæóÁï∂ÊúüÂ∑≤ÈÅ∏ÂìÅÁâåÊï∏
    function getUniBrandCount() {
        const cycleKey = getUniBrandCycleKey();
        const selected = JSON.parse(localStorage.getItem(cycleKey) || '[]');
        return selected.length;
    }

    function updateTaskBonusDisplay() {
        const count = getUniBrandCount();
        let bonus = 0;
        if (count >= 5) bonus = 4;
        else if (count >= 4) bonus = 3;
        else if (count >= 3) bonus = 2;
        else if (count >= 2) bonus = 1;
        const display = document.getElementById('taskBonusDisplay');
        if (display) {
            display.innerText = `ÁõÆÂâç ${count} ÂÆ∂ (Âä†Á¢º ${bonus}%)`;
        }
    }
      
    // ==========================================
    // Part 4: ‰∫§ÊòìË≥áÊñô„ÄÅToggle ÈÇèËºØËàáÈÅãÁÆóÊ†∏ÂøÉ (V126.2)
    // ==========================================

    function getTransactionsKey(cardId) { return `transactions_${cardId}`; }
    function getTransactions(cardId) { return JSON.parse(localStorage.getItem(getTransactionsKey(cardId)) || '[]'); }
    function saveTransactions(cardId, txs) { localStorage.setItem(getTransactionsKey(cardId), JSON.stringify(txs)); try { buildHistoryOptions(); } catch(e){} }
// ÂèñÂæóË©≤ÊúàÁöÑÂØ¶ÈöõÁµêÂ∏≥Êó•ÔºàËôïÁêÜÂ§ßÂ∞èÊúàÔºâ
function getActualCycleDay(year, month, cycleDay) {
    const lastDay = new Date(year, month + 1, 0).getDate();
    return Math.min(cycleDay, lastDay);
}
  function getCycleKey(cardId, dateInput) {
        const settings = cardSettings[cardId] || {};
        const cycleDay = parseInt(settings.cycleDay) || 0;
        
        // Â¶ÇÊûúÊúâÂÇ≥ÂÖ•Êó•ÊúüÂ∞±Áî®ÈÇ£ÂÄãÊó•ÊúüÔºåÂê¶ÂâáÁî®‰ªäÂ§©
        let targetDate;
        if (dateInput) {
            targetDate = (typeof dateInput === 'string') ? new Date(dateInput) : dateInput;
        } else {
            targetDate = new Date();
        }
        
        let year = targetDate.getFullYear();
        let month = targetDate.getMonth() + 1;
        const day = targetDate.getDate();
        
        if (cycleDay && cycleDay > 0) {
            // Â¶ÇÊûú‰ªäÂ§©ÁöÑÊó•Êúü > ÁµêÂ∏≥Êó•ÔºåË°®Á§∫Â∑≤ÈÄ≤ÂÖ•‰∏ã‰∏ÄÂÄãÈÄ±Êúü
            if (day > cycleDay) {
                month++;
                if (month > 12) {
                    month = 1;
                    year++;
                }
            }
        }
        
        return `${year}-${month}`;
    }
    function getCurrentCycleTransactions(cardId) {
        const txs = getTransactions(cardId);
        const currentCycleKey = getCycleKey(cardId);
        
        return txs.filter(tx => {
            const txCycleKey = getCycleKey(cardId, tx.date);
            return txCycleKey === currentCycleKey;126.2
        });
    }

    function getUniOpenDailyPromo() {
        const now = new Date();
        const day = now.getDay();
        const date = now.getDate();
        const dn = ['Êó•','‰∏Ä','‰∫å','‰∏â','Âõõ','‰∫î','ÂÖ≠'];
        let p = [];
        if (day===1) p.push('‚òï ÊòüÂ∑¥ÂÖãÂ§ßÊùØ‰ª•‰∏äË≤∑‰∏ÄÈÄÅ‰∏Ä(ÊúÄÂ§öË≤∑‰∫åÈÄÅ‰∫å)');
        if (day===2) { p.push('‚òï ÊòüÂ∑¥ÂÖãÈ£≤Êñô+Á≥ïÈªûÁµÑÂêà8Êäò'); p.push('üç¶ COLD STONE ÈÖ∑Ê®ÇÊÄùË≤∑‰∏ÄÈÄÅ‰∏Ä'); }
        if (day===3) p.push('üè¨ Áµ±‰∏ÄÊôÇ‰ª£/DREAM PLAZA Âà∑899ÈÄÅ$100Âà∏');
        if (day===5) p.push('üç¶ COLD STONE ‰∏≠ÊùØ‰ª•‰∏äË≤∑‰∏ÄÈÄÅ‰∏Ä');
        if (day===5||day===6||day===0) p.push('üçΩÔ∏è Â§¢ÊôÇ‰ª£ÊåáÂÆöÈ§êÈ£≤ OP 8%');
        if (day===0) { p.push('üíÑ Â∫∑ÊòØÁæéÊªø$988Ë¥àOP120Èªû'); p.push('üåø ËÅñÂæ∑ÁßëÊñØÊªø$688Ë¥à$50Âà∏'); }
        if (date===1) p.push('üõí ÂÆ∂Ê®ÇÁ¶èOPEN Day Âà∑$799‚Üí$1Âä†Ë≥º');
        if (p.length===0) return '';
        return `üìÖ <b>‰ªäÊó•(ÈÄ±${dn[day]})ÂìÅÁâåÊó•</b><br>` + p.join('<br>') + '<hr style="margin:6px 0;border-color:#FFC107">';
    }
function applyPromoStatus() {
        if (!window.promoStatus) return;
        const icashCb = document.getElementById('checkUniIcash');
        if (!icashCb) return;
        const icashRow = icashCb.closest('.option-row');
        if (window.promoStatus.uniopen_icash_full) {
            icashCb.checked = false;
            icashCb.disabled = true;
            if (icashRow) icashRow.style.opacity = '0.5';
            let tag = document.getElementById('icashFullTag');
            if (!tag) {
                tag = document.createElement('span');
                tag.id = 'icashFullTag';
                tag.style.cssText = 'font-size:11px; color:#FF3B30; font-weight:700; margin-left:6px;';
                icashRow.querySelector('label').appendChild(tag);
            }
            tag.innerText = '‚ö†Ô∏è Êú¨ÊúàÂ∑≤È°çÊªø';
        } else {
            icashCb.disabled = false;
            if (icashRow) icashRow.style.opacity = '1';
            const tag = document.getElementById('icashFullTag');
            if (tag) tag.remove();
        }
    }
   function openCardModal(cardId) {
        if (cardId === 'add1') { openManageModal(); return; }
        const card = cards.find(c => c.id === cardId);
        if (!card) return;
        
        // ‚òÖ ÈáçÁΩÆÁ∑®ËºØÁãÄÊÖã
        editingTxId = null;
        document.getElementById('btn-confirm').innerText = 'Á¢∫Ë™ç';
        
        document.getElementById('cardIdInput').value = cardId;
        document.getElementById('modalTitle').innerText = card.name;
        document.getElementById('modalSubtitle').innerText = card.note || '';
        document.getElementById('amountInput').value = '';
        document.getElementById('noteInput').value = '';
      const today = new Date();
document.getElementById('dateInput').value = today.getFullYear() + '-' + String(today.getMonth() + 1).padStart(2, '0') + '-' + String(today.getDate()).padStart(2, '0');
        document.getElementById('liveRewardCalc').style.display = 'none';
        document.getElementById('twdConversionDisplay').style.display = 'none';
        
        // Èö±ËóèÊâÄÊúâÂç°ÁâáÂ∞àÂ±¨ÈÅ∏È†Ö
        const allOptions = ['pigRichOptions', 'greenCardOptions', 'uniOptions', 'happyOptions', 'hsbcOptions', 'uniOpenOptions', 'richartOptions', 'fubonJOptions', 'jiheOptions', 'kumamonOptions', 'sinopacCurrencyOptions', 'sinopacMitsuiOptions', 'jiangOptions', 'dbsEcoOptions', 'sinopacJcbOptions', 'laiDianOptions', 'legendOptions', 'cubeOptions'];
        allOptions.forEach(id => { const el = document.getElementById(id); if (el) el.style.display = 'none'; });
        
        // Èö±ËóèË≠¶Âëä
        document.getElementById('thresholdWarning').style.display = 'none';
        document.getElementById('detailProgressArea').style.display = 'none';
        document.getElementById('uniUpSuggestion').style.display = 'none';
        
        const parkingInfo = document.getElementById('modalParkingInfo');
        if (card.parking) {
            let parkingHtml = card.parking;
            if (card.id === 'c10') parkingHtml = getUniOpenDailyPromo() + parkingHtml;
            parkingInfo.innerHTML = parkingHtml;
            parkingInfo.style.display = 'block';
        } else parkingInfo.style.display = 'none';

        // È°ØÁ§∫Â∞çÊáâÂç°ÁâáÁöÑÈÅ∏È†Ö
        showCardSpecificOptions(cardId);
        
        // Ê†πÊìöÂú∞ÈªûÊõ¥Êñ∞ÂúãÂ§ñË≠¶Âëä
        updateOverseasWarnings(cardId);
        
        historyMonthOffset = 0;
        renderModalHistory(cardId);
        document.getElementById('transactionModal').style.display = 'flex';
        history.pushState({ modal: true }, '');
    }

    function showCardSpecificOptions(cardId) {
        // C6 Ë±¨ÂØåÂç°
        if (cardId === 'c6') {
            document.getElementById('pigRichOptions').style.display = 'block';
            // Êó•Êú¨ PayPay ÊèêÁ§∫
            const overseasNote = document.getElementById('pigRichOverseasNote');
            if (currentLocation === 'JP') {
                overseasNote.style.display = 'block';
            } else {
                overseasNote.style.display = 'none';
            }
        }
        // C5 Ë≥¥ÈªûÂç°
        else if (cardId === 'c5') {
            document.getElementById('laiDianOptions').style.display = 'block';
            // ÂúãÂ§ñË≠¶Âëä
            const overseasWarning = document.getElementById('laiDianOverseasWarning');
            if (currentLocation !== 'TW') {
                overseasWarning.style.display = 'block';
            } else {
                overseasWarning.style.display = 'none';
            }
        }
        // C2 Á∂†Âç°
        else if (cardId === 'c2') {
            document.getElementById('greenCardOptions').style.display = 'block';
        }
        // C7 UNIÂç°
        else if (cardId === 'c7') {
            document.getElementById('uniOptions').style.display = 'block';
            loadUniSettings();
            // UPÈÅ∏‰∏çÈúÄË¶ÅÈÅ∏ÈÄöË∑Ø
            const uniSettings = JSON.parse(localStorage.getItem('uni_settings') || '{}');
            const channelSection = document.getElementById('uniChannelSection');
           if (channelSection) channelSection.style.display = uniSettings.isUp ? 'none' : 'block';
            const savedChannels = JSON.parse(localStorage.getItem('uni_channels') || '[]');
            document.getElementById('uniChannelCount').innerText = `(${savedChannels.length}/8)`;
            updateUniChannelSummary(savedChannels);
            // ÂúãÂ§ñË≠¶Âëä
            const overseasWarning = document.getElementById('uniOverseasWarning');
            if (currentLocation !== 'TW') {
                overseasWarning.style.display = 'block';
            } else {
                overseasWarning.style.display = 'none';
            }
        }
        // C8 Ê®ÇÂÆ∂+Âç°
        else if (cardId === 'c8') {
            document.getElementById('happyOptions').style.display = 'block';
            loadHappySettings();
            // ÂúãÂ§ñË≠¶Âëä
            const overseasWarning = document.getElementById('happyOverseasWarning');
            if (currentLocation !== 'TW') {
                overseasWarning.style.display = 'block';
                // Ëá™ÂãïÂãæÈÅ∏ÂúãÂ§ñÊ∂àË≤ª
                document.getElementById('checkHappyForeign').checked = true;
                document.getElementById('checkHappyPet').checked = false;
                document.getElementById('checkHappyLife').checked = false;
                document.getElementById('checkHappyPeace').checked = false;
            } else {
                overseasWarning.style.display = 'none';
            }
        }
        // C9 ÊóÖ‰∫∫Âç°
        else if (cardId === 'c9') {
            document.getElementById('hsbcOptions').style.display = 'block';
            loadHsbcSettings();
        }
        // C10 UniOpenÂç°
        else if (cardId === 'c10') {
            document.getElementById('uniOpenOptions').style.display = 'block';
        applyPromoStatus();
            initUniBrandGrid();
            // ÈáçÁΩÆÈÅ∏È†Ö (ÈÅøÂÖçÊÆòÁïô)
            document.getElementById('checkUniGroup').checked = false;
            document.getElementById('checkUniIcash').checked = false;
            document.getElementById('checkUniOverseas').checked = false;
        }
        // C11 RichartÂç°
        else if (cardId === 'c11') {
            document.getElementById('richartOptions').style.display = 'block';
            const jpRow = document.getElementById('rbRichartJpPaypayRow');
            if (currentLocation === 'JP') {
                jpRow.style.display = '';
                document.getElementById('rbRichartJpPaypay').checked = true;
            } else {
                jpRow.style.display = 'none';
                if (document.getElementById('rbRichartJpPaypay').checked)
                    document.getElementById('rbRichartGeneral').checked = true;
            }
            toggleRichartLogic();
        }
       // J1 ÂØåÈÇ¶JÂç°
        else if (cardId === 'j1') {
            document.getElementById('fubonJOptions').style.display = 'block';
            // Ê†πÊìöÂú∞ÈªûËá™ÂãïË®≠ÂÆöÊ®°Âºè
            updateFubonJByLocation();
        }
       // J2 ÂêâÈ∂¥Âç°
        else if (cardId === 'j2') {
            document.getElementById('jiheOptions').style.display = 'block';
            // Ê†πÊìöÂú∞ÈªûËá™ÂãïË®≠ÂÆöÊ®°Âºè
            updateJiheByLocation();
        }
        // J3 ÁÜäÊú¨ÁÜäÂç°
        else if (cardId === 'j3') {
            document.getElementById('kumamonOptions').style.display = 'block';
            // Ê†πÊìöÂú∞ÈªûËá™ÂãïË®≠ÂÆöÊ®°Âºè
            updateKumamonByLocation();
        }
        // J4 Âπ£ÂÄçÂç°
        else if (cardId === 'j4') {
            document.getElementById('sinopacCurrencyOptions').style.display = 'block';
            loadCurrencyLevel();
        }
        // J5 ‰∏â‰∫ïÂç°
        else if (cardId === 'j5') {
            document.getElementById('sinopacMitsuiOptions').style.display = 'block';
        }
        // C12 JCBÂç°
        else if (cardId === 'c12') {
            document.getElementById('sinopacJcbOptions').style.display = 'block';
            // Ê†πÊìöÂú∞ÈªûÈ†êÈÅ∏
            if (currentLocation === 'JP') {
                document.getElementById('checkSinopacJcbForeign').checked = true;
                document.getElementById('checkSinopacJcbBonus').checked = true;
            }
        }
        // C4 Â∞áÂ∞áÂç°
        else if (cardId === 'c4') {
            document.getElementById('jiangOptions').style.display = 'block';
            // Ê™¢Êü•ÊóÖÈÅäÂä†Á¢ºÊòØÂê¶ÈÅéÊúü
            const now = new Date();
           const expDate = new Date('2026-03-31');
            if (now > expDate) {
                document.getElementById('jiangTravelRow').classList.add('expired');
                document.getElementById('jiangTravelExpMsg').style.display = 'block';
            }
            // È°ØÁ§∫‰ΩéÊ∂àË≠¶Âëä
            updateJiangMinSpendWarning();
        }
        // DBS1 ecoÂç°
        else if (cardId === 'dbs1') {
            document.getElementById('dbsEcoOptions').style.display = 'block';
        }
        // C1 ÂÇ≥Ë™™Â∞çÊ±∫Âç°
        else if (cardId === 'c1') {
            document.getElementById('legendOptions').style.display = 'block';
        }
        // CUBE1 ÂúãÊ≥∞CUBEÂç°
        else if (cardId === 'cube1') {
            document.getElementById('cubeOptions').style.display = 'block';
            loadCubeSettings();
            // ÁòãÂ§ßÊ∏ØÂà∞ÊúüÈö±Ëóè (3/31Âæå)
            const now = new Date();
            if (now > new Date('2026-03-23')) {
                document.getElementById('cubeMegaHighRow').style.display = 'none';
                document.getElementById('cubeMegaLowRow').style.display = 'none';
                const curMode = document.querySelector('input[name="cubeMode"]:checked')?.value || '';
                if (curMode.startsWith('megaport')) {
                    document.getElementById('rbCubeGeneral').checked = true;
                }
            }
        }
    }

    // Êõ¥Êñ∞ÂúãÂ§ñÁÑ°Âä†Á¢ºË≠¶Âëä
    function updateOverseasWarnings(cardId) {
        const isOverseas = currentLocation !== 'TW';
        
        // C5 Ë≥¥ÈªûÂç° - ÂúãÂ§ñÁÑ°Âä†Á¢º
        if (cardId === 'c5') {
            const rows = document.querySelectorAll('#laiDianOptions .option-row');
            rows.forEach(row => {
                if (isOverseas && !row.querySelector('input[value="general"]')) {
                    row.classList.add('overseas-disabled');
                } else {
                    row.classList.remove('overseas-disabled');
                }
            });
        }
        
        // C1 ÂÇ≥Ë™™Â∞çÊ±∫Âç° - ÂúãÂ§ñÁÑ°Âä†Á¢º
        if (cardId === 'c1') {
            const bonusRow = document.querySelector('#legendOptions .option-row:not(.read-only)');
            if (bonusRow) {
                if (isOverseas) {
                    bonusRow.classList.add('overseas-disabled');
                    document.getElementById('checkLegendBonus').checked = false;
                } else {
                    bonusRow.classList.remove('overseas-disabled');
                }
            }
        }
        
        // C7 UNIÂç° - ÂúãÂ§ñÁÑ°Âä†Á¢º
        if (cardId === 'c7') {
            const rows = document.querySelectorAll('#uniOptions .option-row:not(.read-only)');
            rows.forEach(row => {
                if (isOverseas) {
                    row.classList.add('overseas-disabled');
                } else {
                    row.classList.remove('overseas-disabled');
                }
            });
        }
        
        // C8 Ê®ÇÂÆ∂+Âç° - ÂúãÂ§ñÂè™ÊúâÂúãÂ§ñÂä†Á¢º
        if (cardId === 'c8') {
            const domesticOptions = ['checkHappyPet', 'checkHappyLife', 'checkHappyPeace'];
            domesticOptions.forEach(id => {
                const row = document.getElementById(id)?.closest('.option-row');
                if (row) {
                    if (isOverseas) {
                        row.classList.add('overseas-disabled');
                        document.getElementById(id).checked = false;
                    } else {
                        row.classList.remove('overseas-disabled');
                    }
                }
            });
        }
    }

    // Toggle ÈÇèËºØÂáΩÊï∏
    function toggleGreenLogic() {
        const isGreen = document.getElementById('checkGreenChannel').checked;
        const isForeign = document.getElementById('checkForeign').checked;
        if (isGreen && isForeign) document.getElementById('checkForeign').checked = false;
        updateRewardPreview();
    }

    function toggleForeignLogic() {
        const isForeign = document.getElementById('checkForeign').checked;
        const isGreen = document.getElementById('checkGreenChannel').checked;
        if (isForeign && isGreen) document.getElementById('checkGreenChannel').checked = false;
        updateRewardPreview();
    }

    function toggleUniUpLogic() {
        const isUp = document.getElementById('checkUniUp').checked;
        saveUniSettings();
        updateRewardPreview();
        
        // UPÈÅ∏‰∏çÈúÄË¶ÅÈÅ∏ÈÄöË∑Ø
        const channelSection = document.getElementById('uniChannelSection');
        if (channelSection) channelSection.style.display = isUp ? 'none' : 'block';
        
        // È°ØÁ§∫ UP ÈÅ∏Âª∫Ë≠∞
        const suggestion = document.getElementById('uniUpSuggestion');
        if (!isUp) {
            const txs = getCurrentCycleTransactions('c7');
            const total = txs.reduce((sum, tx) => sum + (tx.amountTWD || tx.amount || 0), 0);
            if (total > 14900) {
                suggestion.innerHTML = 'üí° ÊÇ®Êú¨ÊúàÊ∂àË≤ªÂ∑≤Ë∂ÖÈÅé $14,900ÔºåÂª∫Ë≠∞Ë®ÇÈñ± UP ÈÅ∏ÂèØÁç≤ÂæóÊõ¥Â§öÂõûÈ•ãÔºÅ';
                suggestion.style.display = 'block';
            } else {
                suggestion.style.display = 'none';
            }
        } else {
            suggestion.style.display = 'none';
        }
    }

    function toggleUniGroup() {
    const isGroup = document.getElementById('checkUniGroup').checked;
    if (isGroup) {
        document.getElementById('checkUniOverseas').checked = false;
    }
    updateRewardPreview();
}
function toggleUniIcash() {
    const isIcash = document.getElementById('checkUniIcash').checked;
    if (isIcash) {
        document.getElementById('checkUniOverseas').checked = false;
    }
    updateRewardPreview();
}
function toggleUniOverseas() {
    const isOverseas = document.getElementById('checkUniOverseas').checked;
    if (isOverseas) {
        document.getElementById('checkUniGroup').checked = false;
        document.getElementById('checkUniIcash').checked = false;
    }
    updateRewardPreview();
}

    function toggleRichartLogic() {
        const mode = document.querySelector('input[name="richartMode"]:checked')?.value || 'general';
        const sub = document.getElementById('richartPlan33Sub');
        if (sub) sub.style.display = (mode === 'plan33') ? 'block' : 'none';
        const jpNote = document.getElementById('richartJpPaypayNote');
        if (jpNote) jpNote.style.display = (mode === 'jpPaypay') ? 'block' : 'none';
        // ÂÑ≤Â≠òÁï∂ÂâçÊñπÊ°àÂà∞ localStorageÔºà‰æõÂç°Èù¢È°ØÁ§∫Ôºâ
        localStorage.setItem('richart_mode', mode);
        if (mode === 'plan33') {
            localStorage.setItem('richart_plan33', document.getElementById('selRichartPlan33')?.value || 'tianti');
        }
        updateRewardPreview();
        renderGrid();
    }

    // J1 ÂØåÈÇ¶JÂç°ÔºöÂèñÂæó‰ΩéÊ∂àÈñÄÊ™ªÈ°ØÁ§∫ÔºàÁµ±‰∏ÄÁî®Âè∞Âπ£Ôºâ
    function getFubonJMinSpendDisplay(twdAmount) {
        return `ÈúÄÂñÆÁ≠ÜÁ≠âÂÄºÂè∞Âπ£ $${twdAmount.toLocaleString()}`;
    }
    
    // J1 ÂØåÈÇ¶JÂç°ÔºöÊõ¥Êñ∞‰ΩéÊ∂àÈñÄÊ™ªÈ°ØÁ§∫
    function updateFubonJMinSpendDisplay() {
        const jpkrEl = document.getElementById('fubonJJpkrMinSpend');
        const suicaEl = document.getElementById('fubonJSuicaMinSpend');
        const thEl = document.getElementById('fubonJThMinSpend');
        
        if (jpkrEl) jpkrEl.innerText = '‚ö†Ô∏è ' + getFubonJMinSpendDisplay(1000);
        if (suicaEl) suicaEl.innerText = '‚ö†Ô∏è ' + getFubonJMinSpendDisplay(2000);
        if (thEl) thEl.innerText = '‚ö†Ô∏è ' + getFubonJMinSpendDisplay(1000);
    }
    
    // J1 ÂØåÈÇ¶JÂç°ÔºöÂàáÊèõÊó•ÈüìÊ∂àË≤ª
    function toggleFubonJJpkr() {
        const isJpkr = document.getElementById('checkFubonJJpkr').checked;
        const thSection = document.getElementById('fubonJThSection');
        
        if (isJpkr) {
            // ÂàáÊèõÂà∞Êó•ÈüìÊ®°Âºè
            document.getElementById('labelFubonJBase').innerText = 'üî∞ Êó•ÈüìÊ∂àË≤ª 3% (ÁÑ°‰∏äÈôê)';
            // Á¶ÅÁî®Ê≥∞ÂúãÂçÄÂ°ä
            thSection.style.opacity = '0.4';
            thSection.style.pointerEvents = 'none';
            document.getElementById('checkFubonJTh').checked = false;
            document.getElementById('checkFubonJThBonus').checked = false;
        } else {
            // ÂàáÊèõÂà∞ÂúãÂÖßÊ®°Âºè
            document.getElementById('labelFubonJBase').innerText = 'üî∞ ÂúãÂÖßÊ∂àË≤ª 1% (ÁÑ°‰∏äÈôê)';
            // ÂïüÁî®Ê≥∞ÂúãÂçÄÂ°ä
            thSection.style.opacity = '1';
            thSection.style.pointerEvents = 'auto';
            // ÂèñÊ∂àÊó•ÈüìÂä†Á¢º
            document.getElementById('checkFubonJJpkrBonus').checked = false;
            document.getElementById('checkFubonJSuica').checked = false;
        }
        
        updateRewardPreview();
    }
    
    // J1 ÂØåÈÇ¶JÂç°ÔºöÊó•ÈüìÂØ¶È´îÂä†Á¢ºÔºàËá™ÂãïÂãæÊó•ÈüìÊ∂àË≤ªÔºåËàá‰∫§ÈÄöÂç°‰∫íÊñ•Ôºâ
    function toggleFubonJJpkrBonus() {
        const isBonus = document.getElementById('checkFubonJJpkrBonus').checked;
        
        if (isBonus) {
            // Ëá™ÂãïÂãæÈÅ∏Êó•ÈüìÊ∂àË≤ª
            document.getElementById('checkFubonJJpkr').checked = true;
            toggleFubonJJpkr();
            // ÂèñÊ∂à‰∫§ÈÄöÂç°
            document.getElementById('checkFubonJSuica').checked = false;
        }
        
        checkFubonJMinSpend();
        updateRewardPreview();
    }
    
    // J1 ÂØåÈÇ¶JÂç°ÔºöÊó•Êú¨‰∫§ÈÄöÂç°Âä†Á¢ºÔºàËá™ÂãïÂãæÊó•ÈüìÊ∂àË≤ªÔºåËàáÊó•ÈüìÂØ¶È´î‰∫íÊñ•Ôºâ
    function toggleFubonJSuica() {
        const isSuica = document.getElementById('checkFubonJSuica').checked;
        
        if (isSuica) {
            // Ëá™ÂãïÂãæÈÅ∏Êó•ÈüìÊ∂àË≤ª
            document.getElementById('checkFubonJJpkr').checked = true;
            toggleFubonJJpkr();
            // ÂèñÊ∂àÊó•ÈüìÂØ¶È´î
            document.getElementById('checkFubonJJpkrBonus').checked = false;
        }
        
        checkFubonJMinSpend();
        updateRewardPreview();
    }
    
    // J1 ÂØåÈÇ¶JÂç°ÔºöÂàáÊèõÊ≥∞ÂúãÊ∂àË≤ª
    function toggleFubonJTh() {
        const isTh = document.getElementById('checkFubonJTh').checked;
        const jpkrSection = document.getElementById('fubonJJpkrSection');
        
        if (isTh) {
            // ÂàáÊèõÂà∞Ê≥∞ÂúãÊ®°Âºè
            document.getElementById('labelFubonJBase').innerText = 'üî∞ Ê≥∞ÂúãÊ∂àË≤ª 1% (ÁÑ°‰∏äÈôê)';
            // Á¶ÅÁî®Êó•ÈüìÂçÄÂ°ä
            jpkrSection.style.opacity = '0.4';
            jpkrSection.style.pointerEvents = 'none';
            document.getElementById('checkFubonJJpkr').checked = false;
            document.getElementById('checkFubonJJpkrBonus').checked = false;
            document.getElementById('checkFubonJSuica').checked = false;
        } else {
            // ÂàáÊèõÂà∞ÂúãÂÖßÊ®°Âºè
            document.getElementById('labelFubonJBase').innerText = 'üî∞ ÂúãÂÖßÊ∂àË≤ª 1% (ÁÑ°‰∏äÈôê)';
            // ÂïüÁî®Êó•ÈüìÂçÄÂ°ä
            jpkrSection.style.opacity = '1';
            jpkrSection.style.pointerEvents = 'auto';
            // ÂèñÊ∂àÊ≥∞ÂúãÂä†Á¢º
            document.getElementById('checkFubonJThBonus').checked = false;
        }
        
        updateRewardPreview();
    }
    
    // J1 ÂØåÈÇ¶JÂç°ÔºöÊ≥∞ÂúãÂØ¶È´îÂä†Á¢ºÔºàËá™ÂãïÂãæÊ≥∞ÂúãÊ∂àË≤ªÔºâ
    function toggleFubonJThBonus() {
        const isBonus = document.getElementById('checkFubonJThBonus').checked;
        
        if (isBonus) {
            // Ëá™ÂãïÂãæÈÅ∏Ê≥∞ÂúãÊ∂àË≤ª
            document.getElementById('checkFubonJTh').checked = true;
            toggleFubonJTh();
        }
        
        checkFubonJMinSpend();
        updateRewardPreview();
    }
    
    // J1 ÂØåÈÇ¶JÂç°ÔºöÊ†πÊìöÂú∞ÈªûËá™ÂãïË®≠ÂÆöÊ®°Âºè
    function updateFubonJByLocation() {
        const jpkrSection = document.getElementById('fubonJJpkrSection');
        const thSection = document.getElementById('fubonJThSection');
        
        // ÂÖàÈáçÁΩÆÊâÄÊúâÁãÄÊÖã
        jpkrSection.style.opacity = '1';
        jpkrSection.style.pointerEvents = 'auto';
        thSection.style.opacity = '1';
        thSection.style.pointerEvents = 'auto';
        
        if (currentLocation === 'JP' || currentLocation === 'KR') {
            // Ëá™ÂãïÂàáÊèõÂà∞Êó•ÈüìÊ®°Âºè
            document.getElementById('checkFubonJJpkr').checked = true;
            document.getElementById('checkFubonJTh').checked = false;
            document.getElementById('checkFubonJThBonus').checked = false;
            document.getElementById('labelFubonJBase').innerText = 'üî∞ Êó•ÈüìÊ∂àË≤ª 3% (ÁÑ°‰∏äÈôê)';
            thSection.style.opacity = '0.4';
            thSection.style.pointerEvents = 'none';
        } else if (currentLocation === 'TH') {
            // Ëá™ÂãïÂàáÊèõÂà∞Ê≥∞ÂúãÊ®°Âºè
            document.getElementById('checkFubonJTh').checked = true;
            document.getElementById('checkFubonJJpkr').checked = false;
            document.getElementById('checkFubonJJpkrBonus').checked = false;
            document.getElementById('checkFubonJSuica').checked = false;
            document.getElementById('labelFubonJBase').innerText = 'üî∞ Ê≥∞ÂúãÊ∂àË≤ª 1% (ÁÑ°‰∏äÈôê)';
            jpkrSection.style.opacity = '0.4';
            jpkrSection.style.pointerEvents = 'none';
        } else {
            // ÂúãÂÖßÊ®°Âºè
            document.getElementById('checkFubonJJpkr').checked = false;
            document.getElementById('checkFubonJTh').checked = false;
            document.getElementById('checkFubonJJpkrBonus').checked = false;
            document.getElementById('checkFubonJSuica').checked = false;
            document.getElementById('checkFubonJThBonus').checked = false;
            document.getElementById('labelFubonJBase').innerText = 'üî∞ ÂúãÂÖßÊ∂àË≤ª 1% (ÁÑ°‰∏äÈôê)';
        }
        
        // Êõ¥Êñ∞‰ΩéÊ∂àÈñÄÊ™ªÈ°ØÁ§∫
        updateFubonJMinSpendDisplay();
    }
    
    // J1 ÂØåÈÇ¶JÂç°ÔºöÊ™¢Êü•‰ΩéÊ∂à
    function checkFubonJMinSpend() {
        const amountRaw = parseFloat(document.getElementById('amountInput').value) || 0;
        const rate = getCurrentRate();
        const amountTWD = Math.round(amountRaw * rate);
        const warning = document.getElementById('fubonJMinSpendWarning');
        
        const isJpkrBonus = document.getElementById('checkFubonJJpkrBonus')?.checked;
        const isSuica = document.getElementById('checkFubonJSuica')?.checked;
        const isThBonus = document.getElementById('checkFubonJThBonus')?.checked;
        
        let minSpend = 0;
        let bonusType = '';
        
        if (isJpkrBonus) {
            minSpend = 1000;
            bonusType = 'Êó•ÈüìÂØ¶È´î +3%';
        } else if (isSuica) {
            minSpend = 2000;
            bonusType = 'Êó•Êú¨‰∫§ÈÄöÂç° +7%';
        } else if (isThBonus) {
            minSpend = 1000;
            bonusType = 'Ê≥∞ÂúãÂØ¶È´î +5%';
        }
        
        if (minSpend > 0 && amountTWD > 0 && amountTWD < minSpend) {
            warning.innerHTML = `üî¥ Êú™ÈÅî‰ΩéÊ∂àÈñÄÊ™ªÔºà${getFubonJMinSpendDisplay(minSpend)}ÔºâÔºåÁÑ°Ê≥ï‰∫´Êúâ${bonusType}`;
            warning.style.display = 'block';
        } else {
            warning.style.display = 'none';
        }
    }
    
    // ‰øùÁïôËàäÂáΩÊï∏ÂêçÁ®±‰ª•Áõ∏ÂÆπ
    function toggleFubonJRegion() { updateRewardPreview(); }
    function toggleFubonJBonus() { updateRewardPreview(); }

   // ÂêâÈ∂¥Âç°ÔºöÂàáÊèõÊó•Êú¨Ê∂àË≤ª
    function toggleJiheJapan() {
        const isJapan = document.getElementById('checkJiheJapan').checked;
        const domesticRow = document.getElementById('rowJiheDomesticJapanese');
        
        if (isJapan) {
            // ÂàáÊèõÂà∞Êó•Êú¨Ê®°Âºè
            document.getElementById('labelJiheBase').innerText = 'üî∞ Êó•Êú¨Ê∂àË≤ª 2.5% (ÁÑ°‰∏äÈôê)';
            // Á¶ÅÁî®‰∏¶ÂèñÊ∂àÂúãÂÖßÊó•Á≥ªÈÅ∏È†Ö
            domesticRow.style.opacity = '0.4';
            domesticRow.style.pointerEvents = 'none';
            document.getElementById('checkJiheDomesticJapanese').checked = false;
        } else {
            // ÂàáÊèõÂà∞ÂúãÂÖßÊ®°Âºè
            document.getElementById('labelJiheBase').innerText = 'üî∞ ÂúãÂÖßÊ∂àË≤ª 1% (ÁÑ°‰∏äÈôê)';
            // ÂïüÁî®ÂúãÂÖßÊó•Á≥ªÈÅ∏È†Ö
            domesticRow.style.opacity = '1';
            domesticRow.style.pointerEvents = 'auto';
            // ÂèñÊ∂à Apple Pay
            document.getElementById('checkJiheApple').checked = false;
        }
        
        updateRewardPreview();
    }
    
    // ÂêâÈ∂¥Âç°ÔºöÂãæÈÅ∏ Apple Pay Ëá™ÂãïÂãæÊó•Êú¨Ê∂àË≤ª
    function toggleJiheApple() {
        const isApple = document.getElementById('checkJiheApple').checked;
        
        if (isApple) {
            // Ëá™ÂãïÂãæÈÅ∏Êó•Êú¨Ê∂àË≤ª
            document.getElementById('checkJiheJapan').checked = true;
            toggleJiheJapan(); // Êõ¥Êñ∞ UI ÁãÄÊÖã
        }
        
        updateRewardPreview();
    }
    
    // ÂêâÈ∂¥Âç°ÔºöÂãæÈÅ∏ÂúãÂÖßÊó•Á≥ª
    function toggleJiheDomestic() {
        const isDomestic = document.getElementById('checkJiheDomesticJapanese').checked;
        
        if (isDomestic) {
            // ÂèñÊ∂àÊó•Êú¨Ê®°ÂºèÂíå Apple Pay
            document.getElementById('checkJiheJapan').checked = false;
            document.getElementById('checkJiheApple').checked = false;
            // ÈÇÑÂéüÂúãÂÖßÊ®°Âºè UI
            document.getElementById('labelJiheBase').innerText = 'üî∞ ÂúãÂÖßÊ∂àË≤ª 1% (ÁÑ°‰∏äÈôê)';
        }
        
        updateRewardPreview();
    }
    
    // ÂêâÈ∂¥Âç°ÔºöÊ†πÊìöÂú∞ÈªûËá™ÂãïË®≠ÂÆöÊ®°Âºè
    function updateJiheByLocation() {
        const isJapan = currentLocation === 'JP';
        const domesticRow = document.getElementById('rowJiheDomesticJapanese');
        
        if (isJapan) {
            // Ëá™ÂãïÂàáÊèõÂà∞Êó•Êú¨Ê®°Âºè
            document.getElementById('checkJiheJapan').checked = true;
            document.getElementById('labelJiheBase').innerText = 'üî∞ Êó•Êú¨Ê∂àË≤ª 2.5% (ÁÑ°‰∏äÈôê)';
            domesticRow.style.opacity = '0.4';
            domesticRow.style.pointerEvents = 'none';
            document.getElementById('checkJiheDomesticJapanese').checked = false;
        } else {
            // ÂàáÊèõÂà∞ÂúãÂÖßÊ®°Âºè
            document.getElementById('checkJiheJapan').checked = false;
            document.getElementById('checkJiheApple').checked = false;
            document.getElementById('labelJiheBase').innerText = 'üî∞ ÂúãÂÖßÊ∂àË≤ª 1% (ÁÑ°‰∏äÈôê)';
            domesticRow.style.opacity = '1';
            domesticRow.style.pointerEvents = 'auto';
        }
    }
    
    // ‰øùÁïôËàäÂáΩÊï∏ÂêçÁ®±‰ª•Áõ∏ÂÆπ
    function toggleJiheLogic() {
        toggleJiheJapan();
    }
    
    function updateJiheMinSpendWarning() {
        // ‰ΩéÊ∂àÊèêÁ§∫Â∑≤Áõ¥Êé•È°ØÁ§∫Âú®ÂêÑÈÅ∏È†Ö‰∏ãÊñπ
    }

   // Â∞áÂ∞áÂç°Âä†Á¢º‰∫íÊñ• toggle
    function toggleJiangSelected() {
        if (document.getElementById('checkJiangSelected').checked) {
            document.getElementById('checkJiangTravel').checked = false;
        }
        updateJiangMinSpendWarning();
        updateRewardPreview();
    }
    
    function toggleJiangTravel() {
        if (document.getElementById('checkJiangTravel').checked) {
            document.getElementById('checkJiangSelected').checked = false;
        }
        updateJiangMinSpendWarning();
        updateRewardPreview();
    }

    // Â∞áÂ∞áÂç°‰ΩéÊ∂àË≠¶Âëä
    function updateJiangMinSpendWarning() {
        const warning = document.getElementById('jiangMinSpendWarning');
        const isSelected = document.getElementById('checkJiangSelected')?.checked || false;
        const isTravel = document.getElementById('checkJiangTravel')?.checked || false;
        const txs = getCurrentCycleTransactions('c4');
        const totalSpent = txs.reduce((sum, tx) => sum + (tx.amountTWD || tx.amount || 0), 0);
        
        let minSpend = 0;
        if (isSelected) {
            minSpend = 3000;
            warning.innerHTML = '‚ö†Ô∏è ÈúÄÁï∂ÊúàÁ¥ØÁ©çÊªø $3,000 Êâç‰∫´Âä†Á¢ºÂõûÈ•ã';
       } else if (isTravel) {
            // ÊóÖÈÅäÈÄöË∑ØÁî®Â≠£Á¥ØÁ©ç
            const travelQuota = getJiangTravelQuotaUsed();
            const now = new Date();
            const qStart = Math.floor(now.getMonth() / 3) * 3 + 1;
            const qLabel = `${qStart}~${qStart + 2}Êúà`;
            warning.innerHTML = `‚ö†Ô∏è ÈúÄÊú¨Â≠£(${qLabel})Á¥ØÁ©çÊªø $6,000 Êâç‰∫´ÊóÖÈÅäÂä†Á¢º (Â∑≤Á¥ØÁ©ç $${travelQuota.quarterTotal.toLocaleString()})`;
            warning.style.display = travelQuota.reachedMinSpend ? 'none' : 'block';
            return;
        }
        
        if (minSpend > 0 && totalSpent < minSpend) {
            warning.style.display = 'block';
        } else {
            warning.style.display = 'none';
        }
    }

    function checkLaiDianMinSpend() {
        const amount = parseFloat(document.getElementById('amountInput').value) || 0;
        const mode = document.querySelector('input[name="laiDianMode"]:checked')?.value;
        const warning = document.getElementById('thresholdWarning');
        
        // Ê®°ÂºèÁÇ∫ lp Êàñ even ÊôÇÔºåËã•ÈáëÈ°ç < 100ÔºåÊèêÁ§∫ÂÉÖ‰∫´Âü∫Êú¨ÂõûÈ•ã
        if ((mode === 'lp' || mode === 'even') && amount > 0 && amount < 100) {
            warning.innerText = '‚ö†Ô∏è Êú™Êªø $100ÔºåÂÉÖ‰∫´ 1% ÂõûÈ•ã (ÁÑ°Âä†Á¢º)';
            warning.style.display = 'block';
        } else {
            warning.style.display = 'none';
        }
    }

    // ÁÜäÊú¨ÁÜäÂç°ÔºöÂàáÊèõÊó•Êú¨Ê∂àË≤ª
    function toggleKumamonJapan() {
        const isJapan = document.getElementById('checkKumamonJapan').checked;
        const payPaySection = document.getElementById('kumamonPayPaySection');
        
        if (isJapan) {
            // ÂàáÊèõÂà∞Êó•Êú¨Ê®°Âºè
            document.getElementById('labelKumamonBase').innerText = 'üî∞ Êó•Êú¨Ê∂àË≤ª 2.5% (ÁÑ°‰∏äÈôê)';
            document.getElementById('groupKumamonJapan').style.display = 'block';
            // Á¶ÅÁî® PayPay ‰∏¶ÂèñÊ∂àÂãæÈÅ∏
            payPaySection.style.opacity = '0.4';
            payPaySection.style.pointerEvents = 'none';
            document.getElementById('checkKumamonPayPay').checked = false;
        } else {
            // ÂàáÊèõÂà∞ÂúãÂÖßÊ®°Âºè
            document.getElementById('labelKumamonBase').innerText = 'üî∞ ÂúãÂÖßÊ∂àË≤ª 0.5% (ÁÑ°‰∏äÈôê)';
            document.getElementById('groupKumamonJapan').style.display = 'none';
            document.getElementById('checkKumamonDesignated').checked = false;
            // ÂïüÁî® PayPay
            payPaySection.style.opacity = '1';
            payPaySection.style.pointerEvents = 'auto';
        }
        
        updateRewardPreview();
    }
    
    // ÁÜäÊú¨ÁÜäÂç°ÔºöÂãæÈÅ∏ÊåáÂÆöÈÄöË∑ØÔºàËá™ÂãïÂãæÊó•Êú¨Ê∂àË≤ªÔºâ
    function toggleKumamonDesignated() {
        const isDesignated = document.getElementById('checkKumamonDesignated').checked;
        
        if (isDesignated) {
            // Ëá™ÂãïÂãæÈÅ∏Êó•Êú¨Ê∂àË≤ª
            document.getElementById('checkKumamonJapan').checked = true;
            toggleKumamonJapan();
        }
        
        updateRewardPreview();
    }
    
    // ÁÜäÊú¨ÁÜäÂç°ÔºöÂãæÈÅ∏ PayPayÔºàËàáÊó•Êú¨Ê∂àË≤ª‰∫íÊñ•Ôºâ
    function toggleKumamonPayPay() {
        const isPayPay = document.getElementById('checkKumamonPayPay').checked;
        const japanSection = document.getElementById('kumamonJapanSection');
        
        if (isPayPay) {
            // Á¶ÅÁî®Êó•Êú¨Ê∂àË≤ªÂçÄÂ°ä‰∏¶ÂèñÊ∂àÂãæÈÅ∏
            japanSection.style.opacity = '0.4';
            japanSection.style.pointerEvents = 'none';
            document.getElementById('checkKumamonJapan').checked = false;
            document.getElementById('checkKumamonDesignated').checked = false;
            document.getElementById('groupKumamonJapan').style.display = 'none';
            document.getElementById('labelKumamonBase').innerText = 'üî∞ ÂúãÂÖßÊ∂àË≤ª 0.5% (ÁÑ°‰∏äÈôê)';
        } else {
            // ÂïüÁî®Êó•Êú¨Ê∂àË≤ªÂçÄÂ°ä
            japanSection.style.opacity = '1';
            japanSection.style.pointerEvents = 'auto';
        }
        
        updateRewardPreview();
    }
    
    // ÁÜäÊú¨ÁÜäÂç°ÔºöÊ†πÊìöÂú∞ÈªûËá™ÂãïË®≠ÂÆöÊ®°Âºè
    function updateKumamonByLocation() {
        const japanSection = document.getElementById('kumamonJapanSection');
        const payPaySection = document.getElementById('kumamonPayPaySection');
        
        // ÂÖàÈáçÁΩÆÊâÄÊúâÁãÄÊÖã
        japanSection.style.opacity = '1';
        japanSection.style.pointerEvents = 'auto';
        payPaySection.style.opacity = '1';
        payPaySection.style.pointerEvents = 'auto';
        
        if (currentLocation === 'JP') {
            // Ëá™ÂãïÂàáÊèõÂà∞Êó•Êú¨Ê®°Âºè
            document.getElementById('checkKumamonJapan').checked = true;
            document.getElementById('checkKumamonPayPay').checked = false;
            toggleKumamonJapan();
        } else {
            // ÂàáÊèõÂà∞ÂúãÂÖßÊ®°Âºè
            document.getElementById('checkKumamonJapan').checked = false;
            document.getElementById('checkKumamonDesignated').checked = false;
            document.getElementById('checkKumamonPayPay').checked = false;
            document.getElementById('labelKumamonBase').innerText = 'üî∞ ÂúãÂÖßÊ∂àË≤ª 0.5% (ÁÑ°‰∏äÈôê)';
            document.getElementById('groupKumamonJapan').style.display = 'none';
        }
    }
    
    // ‰øùÁïôËàäÂáΩÊï∏ÂêçÁ®±‰ª•Áõ∏ÂÆπ
    function toggleKumamonLogic() {
        toggleKumamonJapan();
    }
    
    function toggleKumamonSub(type) {
        if (type === 'designated') {
            toggleKumamonDesignated();
        } else if (type === 'paypay') {
            toggleKumamonPayPay();
        }
    }

    function toggleCurrencyLogic() { updateRewardPreview(); }

    function toggleSinopacMitsui(type) {
        if (type === 'selected') {
            if (document.getElementById('checkSinopacMitsuiSelected').checked) {
                document.getElementById('checkSinopacMitsuiTarget').checked = false;
            }
        } else if (type === 'target') {
            if (document.getElementById('checkSinopacMitsuiTarget').checked) {
                document.getElementById('checkSinopacMitsuiSelected').checked = false;
            }
        }
        updateRewardPreview();
    }

    function toggleDbsLogic(type) {
        const checkLinePay = document.getElementById('checkDbsLinePay');
        const checkGreen = document.getElementById('checkDbsGreen');
        const checkForeign = document.getElementById('checkDbsForeign');
        
        if (type === 'linepay' && checkLinePay.checked) {
            checkGreen.checked = false;
            checkForeign.checked = false;
        } else if (type === 'green' && checkGreen.checked) {
            checkLinePay.checked = false;
            checkForeign.checked = false;
        } else if (type === 'foreign' && checkForeign.checked) {
            checkLinePay.checked = false;
            checkGreen.checked = false;
        }
        updateRewardPreview();
    }

    // Âç°ÁâáË®≠ÂÆöÂ≠òÂèñÂáΩÊï∏
    function loadUniSettings() {
        const settings = JSON.parse(localStorage.getItem('uni_settings') || '{}');
        if (settings.isUp) document.getElementById('checkUniUp').checked = true;
    }
    function saveUniSettings() {
        localStorage.setItem('uni_settings', JSON.stringify({ isUp: document.getElementById('checkUniUp').checked }));
        renderGrid();
    }
function handleHappyExclusive(selected) {
        const pet = document.getElementById('checkHappyPet');
        const life = document.getElementById('checkHappyLife');
        const peace = document.getElementById('checkHappyPeace');
        const foreign = document.getElementById('checkHappyForeign');
        
        if (selected === 'pet' && pet.checked) {
            life.checked = false;
            peace.checked = false;
            foreign.checked = false;
        } else if (selected === 'life' && life.checked) {
            pet.checked = false;
            peace.checked = false;
            foreign.checked = false;
        } else if (selected === 'peace' && peace.checked) {
            pet.checked = false;
            life.checked = false;
            foreign.checked = false;
        } else if (selected === 'foreign' && foreign.checked) {
            pet.checked = false;
            life.checked = false;
            peace.checked = false;
        }
        
        updateRewardPreview();
    }
    function loadHappySettings() {
        const txs = getCurrentCycleTransactions('c8');
        let petSpent = 0, lifeSpent = 0, peaceSpent = 0;
        
        txs.forEach(tx => {
            const amount = tx.amountTWD || tx.amount || 0;
            if (tx.isHappyPet) petSpent += amount;
            if (tx.isHappyLife) lifeSpent += amount;
            if (tx.isHappyPeace) peaceSpent += amount;
        });
        
        const petLimit = 5263;
        const lifeLimit = 5714;
        const peaceLimit = 5714;
        
        document.getElementById('happyPetRemain').innerText = `(Â∑≤Âà∑$${petSpent.toLocaleString()}/$${petLimit.toLocaleString()})`;
        document.getElementById('happyLifeRemain').innerText = `(Â∑≤Âà∑$${lifeSpent.toLocaleString()}/$${lifeLimit.toLocaleString()})`;
        document.getElementById('happyPeaceRemain').innerText = `(Â∑≤Âà∑$${peaceSpent.toLocaleString()}/$${peaceLimit.toLocaleString()})`;
    }

    function loadHsbcSettings() {
        const tier = localStorage.getItem('hsbc_tier') || 'infinite';
        document.querySelector(`input[name="hsbcTier"][value="${tier}"]`).checked = true;
        document.getElementById('hsbcInitialMiles').value = localStorage.getItem('hsbc_initial') || '';
        document.getElementById('hsbcRedeemedMiles').value = localStorage.getItem('hsbc_redeemed') || '';
    }
    function saveHsbcTier() {
        const tier = document.querySelector('input[name="hsbcTier"]:checked')?.value || 'infinite';
        localStorage.setItem('hsbc_tier', tier);
        updateRewardPreview();
        renderGrid();
    }
    function saveHsbcInitial() {
        localStorage.setItem('hsbc_initial', document.getElementById('hsbcInitialMiles').value || '0');
    }
    function saveHsbcSettings() {
        localStorage.setItem('hsbc_redeemed', document.getElementById('hsbcRedeemedMiles').value || '0');
    }

    function loadCurrencyLevel() {
        const level = localStorage.getItem('currency_level') || 'low';
        document.querySelector(`input[name="currencyLevel"][value="${level}"]`).checked = true;
    }
    function saveCurrencyLevel() {
        const level = document.querySelector('input[name="currencyLevel"]:checked')?.value || 'low';
        localStorage.setItem('currency_level', level);
        updateRewardPreview();
    }

    function loadCubeSettings() {
        const level = localStorage.getItem('cube_level') || 'lv2';
        document.querySelector(`input[name="cubeLevel"][value="${level}"]`).checked = true;
    }
    function saveCubeSettings() {
        const level = document.querySelector('input[name="cubeLevel"]:checked')?.value || 'lv2';
        localStorage.setItem('cube_level', level);
        updateRewardPreview();
        renderGrid();
    }

    // ÂèñÂæó‰∫§ÊòìÈÅ∏È†Ö
    function getTransactionOptions(cardId) {
        const options = {};
        
        if (cardId === 'c6') {
            options.isBonus10 = document.getElementById('checkBonus10')?.checked || false;
            options.isBonus25 = document.getElementById('checkBonus25')?.checked || false;
            options.isBill = document.getElementById('checkIsBill')?.checked || false;
        }
        else if (cardId === 'c5') {
            options.isNew = document.getElementById('checkLaiDianNew')?.checked || false;
            options.mode = document.querySelector('input[name="laiDianMode"]:checked')?.value || 'general';
        }
        else if (cardId === 'c2') {
            options.isGreen = document.getElementById('checkGreenChannel')?.checked || false;
            options.isForeign = document.getElementById('checkForeign')?.checked || false;
        }
        else if (cardId === 'c7') {
            options.isUp = document.getElementById('checkUniUp')?.checked || false;
            options.isBonus = document.getElementById('checkUniBonus')?.checked || false;
        }
        else if (cardId === 'c8') {
            options.isPet = document.getElementById('checkHappyPet')?.checked || false;
            options.isLife = document.getElementById('checkHappyLife')?.checked || false;
            options.isPeace = document.getElementById('checkHappyPeace')?.checked || false;
            options.isForeign = document.getElementById('checkHappyForeign')?.checked || false;
        }
        else if (cardId === 'c9') {
            options.isForeign = document.getElementById('checkHsbcForeign')?.checked || false;
            options.tier = document.querySelector('input[name="hsbcTier"]:checked')?.value || 'infinite';
        }
        else if (cardId === 'c10') {
            options.isGroup = document.getElementById('checkUniGroup')?.checked || false;
            options.isIcash = document.getElementById('checkUniIcash')?.checked || false;
            options.isOverseas = document.getElementById('checkUniOverseas')?.checked || false;
            options.brandCount = getUniBrandCount();
        }
        else if (cardId === 'c11') {
            options.mode = document.querySelector('input[name="richartMode"]:checked')?.value || 'general';
            options.plan33 = document.getElementById('selRichartPlan33')?.value || 'tianti';
        }
        else if (cardId === 'j1') {
            options.isJpkr = document.getElementById('checkFubonJJpkr')?.checked || false;
            options.isTh = document.getElementById('checkFubonJTh')?.checked || false;
            options.isJpkrBonus = document.getElementById('checkFubonJJpkrBonus')?.checked || false;
            options.isSuica = document.getElementById('checkFubonJSuica')?.checked || false;
            options.isThBonus = document.getElementById('checkFubonJThBonus')?.checked || false;
        }
        else if (cardId === 'j2') {
            options.isJapan = document.getElementById('checkJiheJapan')?.checked || false;
            options.isApple = document.getElementById('checkJiheApple')?.checked || false;
            options.isDomesticJapanese = document.getElementById('checkJiheDomesticJapanese')?.checked || false;
        }
        else if (cardId === 'j3') {
            options.isJapan = document.getElementById('checkKumamonJapan')?.checked || false;
            options.isDesignated = document.getElementById('checkKumamonDesignated')?.checked || false;
            options.isPayPay = document.getElementById('checkKumamonPayPay')?.checked || false;
        }
        else if (cardId === 'j4') {
            options.level = document.querySelector('input[name="currencyLevel"]:checked')?.value || 'low';
            options.isSelected = document.querySelector('input[name="currencyType"]:checked')?.value === 'selected';
        }
        else if (cardId === 'j5') {
            options.isSelected = document.getElementById('checkSinopacMitsuiSelected')?.checked || false;
            options.isTarget = document.getElementById('checkSinopacMitsuiTarget')?.checked || false;
        }
        else if (cardId === 'c12') {
            options.isForeign = document.getElementById('checkSinopacJcbForeign')?.checked || false;
            options.isBonus = document.getElementById('checkSinopacJcbBonus')?.checked || false;
            options.isQuarterly = document.getElementById('checkSinopacJcbQuarterly')?.checked || false;
        }
       else if (cardId === 'c4') {
            options.isJiangSelected = document.getElementById('checkJiangSelected')?.checked || false;
            options.isJiangTravel = document.getElementById('checkJiangTravel')?.checked || false;
        }
        else if (cardId === 'dbs1') {
            options.isLinePay = document.getElementById('checkDbsLinePay')?.checked || false;
            options.isGreen = document.getElementById('checkDbsGreen')?.checked || false;
            options.isForeign = document.getElementById('checkDbsForeign')?.checked || false;
        }
        else if (cardId === 'c1') {
            options.isBonus = document.getElementById('checkLegendBonus')?.checked || false;
        }
        else if (cardId === 'cube1') {
            options.cubeMode = document.querySelector('input[name="cubeMode"]:checked')?.value || 'general';
            options.isCubeLinePay = document.getElementById('checkCubeLinePay')?.checked || false;
            options.cubeLevel = document.querySelector('input[name="cubeLevel"]:checked')?.value || 'lv2';
        }
        
        return options;
    }

    // ÂõûÈ•ãÈ†êË¶ΩË®àÁÆó (‰øÆÂæ©Áâà)
    function updateRewardPreview() {
        const cardId = document.getElementById('cardIdInput').value;
        const amount = parseFloat(document.getElementById('amountInput').value) || 0;
        const liveCalc = document.getElementById('liveRewardCalc');
        
        if (amount <= 0) {
            liveCalc.style.display = 'none';
            if (cardId === 'j1') checkFubonJMinSpend();
            if (cardId === 'c5') checkLaiDianMinSpend();
            return;
        }
        
        let rate = getCurrentRate();
        if (editingTxId) {
            const txs = getTransactions(cardId);
            const editTx = txs.find(t => t.id === editingTxId);
            if (editTx && editTx.exchangeRate) rate = editTx.exchangeRate;
        }
        const amountTWD = Math.round(amount * rate);
        
        if (cardId === 'j1') checkFubonJMinSpend();
        if (cardId === 'c5') checkLaiDianMinSpend();
        
        // ÂèñÂæóÈÅ∏È†Ö
        const options = getTransactionOptions(cardId);
        
     // ‚òÖ Â∞áÂ∞áÂç°ÔºöÊ™¢Êü•ÊòØÂê¶ÈÅî‰ΩéÊ∂à
        if (cardId === 'c4') {
            const isSelected = document.getElementById('checkJiangSelected')?.checked || false;
            const isTravel = document.getElementById('checkJiangTravel')?.checked || false;
            const hasBonus = isSelected || isTravel;
            const minSpend = isTravel ? 6000 : 3000;
            const txs = getCurrentCycleTransactions('c4');
            const totalSpent = txs.reduce((sum, tx) => sum + (tx.amountTWD || tx.amount || 0), 0);
            
            // Êõ¥Êñ∞Ë≠¶Ë™û
            updateJiangMinSpendWarning();
            
            // Â∞öÊú™ÈÅî‰ΩéÊ∂à
            if (hasBonus && totalSpent < minSpend) {
                const willReachMinSpend = (totalSpent + amountTWD) >= minSpend;
                
                if (!willReachMinSpend) {
                    // ÈÄôÁ≠ÜÂä†‰∏äÂéªÈÇÑÊòØ‰∏çÂ§†‰ΩéÊ∂àÔºåÂè™ÊúâÂü∫Êú¨ 0.5%
                    const baseReward = Math.floor(amountTWD * 0.005);
                    liveCalc.style.display = 'block';
                    liveCalc.innerHTML = `È†ê‰º∞Áç≤Âæó <b>$${baseReward}</b> ÂõûÈ•ã (0.5%) <span style="color:#e65100; font-size:11px;"><br>‚ö†Ô∏è ÈúÄÁ¥ØÁ©çÊªø$${minSpend.toLocaleString()}Êâç‰∫´Âä†Á¢º</span>`;
                    updateTWDPreview();
                    return;
                }
            }
        }
        
       // ‚òÖ Ê®ÇÂÆ∂Âç°ÔºöÊ™¢Êü•ÊòØÂê¶ÈÅî‰ΩéÊ∂à $3,000ÔºàÂúãÂ§ñÊ∂àË≤ª‰∏çÈúÄË¶Å‰ΩéÊ∂àÔºâ
        if (cardId === 'c8') {
            const isForeign = document.getElementById('checkHappyForeign')?.checked || false;
            
            // ÂúãÂ§ñÊ∂àË≤ª‰∏çÈúÄË¶Å‰ΩéÊ∂àÔºåË∑≥ÈÅéÊ™¢Êü•
            if (!isForeign) {
                const txs = getCurrentCycleTransactions('c8');
                const totalSpent = txs.reduce((sum, tx) => sum + (tx.amountTWD || tx.amount || 0), 0);
                const minSpend = 3000;
                const warning = document.getElementById('happyMinSpendWarning');
                
                if (totalSpent < minSpend) {
                    warning.style.display = 'block';
                    const willReachMinSpend = (totalSpent + amountTWD) >= minSpend;
                    
                    if (!willReachMinSpend) {
                        const baseReward = Math.floor(amountTWD * 0.005);
                        liveCalc.style.display = 'block';
                        liveCalc.innerHTML = `È†ê‰º∞Áç≤Âæó <b>$${baseReward}</b> ÂõûÈ•ã (0.5%) <span style="color:#e65100; font-size:11px;"><br>‚ö†Ô∏è ÈúÄÁ¥ØÁ©çÊªø$3,000Êâç‰∫´Âä†Á¢º</span>`;
                        updateTWDPreview();
                        return;
                    }
                } else {
                    warning.style.display = 'none';
                }
            } else {
                // ÂúãÂ§ñÊ∂àË≤ªÊôÇÈö±Ëóè‰ΩéÊ∂àË≠¶Âëä
                const warning = document.getElementById('happyMinSpendWarning');
                if (warning) warning.style.display = 'none';
            }
        }
        
        // ‚òÖ ÂêâÈ∂¥Âç° Apple Pay ‰ΩéÊ∂àÊ™¢Êü•
        if (cardId === 'j2') {
            const isApple = document.getElementById('checkJiheApple')?.checked || false;
            const isJapan = document.getElementById('checkJiheJapan')?.checked || false;
            
            if (isJapan && isApple && amountTWD < 100) {
                const baseReward = Math.floor(amountTWD * 0.025);
                liveCalc.style.display = 'block';
                liveCalc.innerHTML = `È†ê‰º∞Áç≤Âæó <b>$${baseReward}</b> ÂõûÈ•ã (2.5%) <span style="color:#e65100; font-size:11px;"><br>‚ö†Ô∏è Êú™ÈÅî‰ΩéÊ∂à $100ÔºåÁÑ°Ê≥ï‰∫´Êúâ Apple Pay +1.5%</span>`;
                updateTWDPreview();
                return;
            }
        }
        
        // ‚òÖ ÂÇ≥ÂÖ•ÂéüÂßãÈáëÈ°ç‰æõ‰ΩéÊ∂àÂà§Êñ∑‰ΩøÁî®
        options.originalAmount = amount;
        const result = calculateSingleReward(cardId, amountTWD, options);

        
        liveCalc.style.display = 'block';
        
        if (cardId === 'c9') {
            liveCalc.innerHTML = `È†ê‰º∞Áç≤Âæó <b>${result.reward}</b> Âì©`;
        } else {
            liveCalc.innerHTML = `È†ê‰º∞Áç≤Âæó <b>$${result.reward}</b> ÂõûÈ•ã (${(result.rate * 100).toFixed(1)}%)`;
        }
        
        updateTWDPreview();
    }

    // Êñ∞Â¢û‰∫§Êòì (‰øÆÂæ©ÔºöÂä†ÂÖ• cardId Ê¨Ñ‰Ωç)
   function addTransaction(closeAfter = true) {
        const cardId = document.getElementById('cardIdInput').value;
        const amountRaw = parseFloat(document.getElementById('amountInput').value);
        const note = document.getElementById('noteInput').value.trim();
        const dateVal = document.getElementById('dateInput').value;
        
        if (!amountRaw || amountRaw <= 0) {
            alert('Ë´ãËº∏ÂÖ•ÊúâÊïàÈáëÈ°ç');
            return;
        }
        
        const rate = getCurrentRate();
        const amountTWD = Math.round(amountRaw * rate);
        
        // ‚òÖ Á∑®ËºØÊ®°ÂºèÔºö‰øùÁïôÂéü IDÔºõÊñ∞Â¢ûÊ®°ÂºèÔºöÁî¢ÁîüÊñ∞ ID
        const txId = editingTxId || Date.now();
        
        const tx = {
            id: txId,
            cardId: cardId, // ‚òÖ ‰øÆÂæ©ÔºöÂä†ÂÖ• cardId Ê¨Ñ‰ΩçÔºåÁ¢∫‰øùÂÇô‰ªΩÈÇÑÂéü‰∏çÈÅ∫Â§±
            amount: amountRaw,
            amountTWD: amountTWD,
            currency: LOCATION_CONFIG[currentLocation].currency,
            location: currentLocation,
            exchangeRate: rate,
            note: note,
            date: dateVal,
            timestamp: new Date().toISOString(),
            // ‰ª•‰∏ãÁÇ∫ÂêÑÂç°ÁâáÂ∞àÂ±¨ÈÅ∏È†Ö
            isBonus10: document.getElementById('checkBonus10')?.checked || false,
            isBonus25: document.getElementById('checkBonus25')?.checked || false,
            isBill: document.getElementById('checkIsBill')?.checked || false,
            isLaiDianNew: document.getElementById('checkLaiDianNew')?.checked || false,
            laiDianMode: document.querySelector('input[name="laiDianMode"]:checked')?.value || 'general',
            isGreenChannel: document.getElementById('checkGreenChannel')?.checked || false,
            isForeign: document.getElementById('checkForeign')?.checked || false,
            isUniUp: document.getElementById('checkUniUp')?.checked || false,
            isUniBonus: document.getElementById('checkUniBonus')?.checked || false,
            isHappyPet: document.getElementById('checkHappyPet')?.checked || false,
            isHappyLife: document.getElementById('checkHappyLife')?.checked || false,
            isHappyPeace: document.getElementById('checkHappyPeace')?.checked || false,
            isHappyForeign: document.getElementById('checkHappyForeign')?.checked || false,
            happyMode: (function() {
                if (document.getElementById('checkHappyPet')?.checked) return 'pet';
                if (document.getElementById('checkHappyLife')?.checked) return 'life';
                if (document.getElementById('checkHappyPeace')?.checked) return 'peace';
                if (document.getElementById('checkHappyForeign')?.checked) return 'foreign';
                return 'general';
            })(),
            isHsbcForeign: document.getElementById('checkHsbcForeign')?.checked || false,
            hsbcTier: document.querySelector('input[name="hsbcTier"]:checked')?.value || 'infinite',
            isUniGroup: document.getElementById('checkUniGroup')?.checked || false,
            isUniIcash: document.getElementById('checkUniIcash')?.checked || false,
            isUniOverseas: document.getElementById('checkUniOverseas')?.checked || false,
            uniBrandCount: getUniBrandCount(),
            richartMode: document.querySelector('input[name="richartMode"]:checked')?.value || 'general',
            richartPlan33: document.getElementById('selRichartPlan33')?.value || 'tianti',
            isFubonJJpkr: document.getElementById('checkFubonJJpkr')?.checked || false,
            isFubonJTh: document.getElementById('checkFubonJTh')?.checked || false,
            isFubonJJpkrBonus: document.getElementById('checkFubonJJpkrBonus')?.checked || false,
            isFubonJSuica: document.getElementById('checkFubonJSuica')?.checked || false,
            isFubonJThBonus: document.getElementById('checkFubonJThBonus')?.checked || false,
            isJiheJapan: document.getElementById('checkJiheJapan')?.checked || false,
            isJiheApple: document.getElementById('checkJiheApple')?.checked || false,
            isJiheDomesticJapanese: document.getElementById('checkJiheDomesticJapanese')?.checked || false,
            isKumamonJapan: document.getElementById('checkKumamonJapan')?.checked || false,
            isKumamonDesignated: document.getElementById('checkKumamonDesignated')?.checked || false,
            isKumamonPayPay: document.getElementById('checkKumamonPayPay')?.checked || false,
            currencyLevel: document.querySelector('input[name="currencyLevel"]:checked')?.value || 'low',
            isCurrencySelected: document.querySelector('input[name="currencyType"]:checked')?.value === 'selected',
            isSinopacMitsuiSelected: document.getElementById('checkSinopacMitsuiSelected')?.checked || false,
            isSinopacMitsuiTarget: document.getElementById('checkSinopacMitsuiTarget')?.checked || false,
            isSinopacJcbForeign: document.getElementById('checkSinopacJcbForeign')?.checked || false,
            isSinopacJcbBonus: document.getElementById('checkSinopacJcbBonus')?.checked || false,
            isSinopacJcbQuarterly: document.getElementById('checkSinopacJcbQuarterly')?.checked || false,
           isJiangSelected: document.getElementById('checkJiangSelected')?.checked || false,
            isJiangTravel: document.getElementById('checkJiangTravel')?.checked || false,
            isDbsLinePay: document.getElementById('checkDbsLinePay')?.checked || false,
            isDbsGreen: document.getElementById('checkDbsGreen')?.checked || false,
            isDbsForeign: document.getElementById('checkDbsForeign')?.checked || false,
            isLegendBonus: document.getElementById('checkLegendBonus')?.checked || false,
            cubeMode: document.querySelector('input[name="cubeMode"]:checked')?.value || 'general',
            isCubeLinePay: document.getElementById('checkCubeLinePay')?.checked || false,
            cubeLevel: document.querySelector('input[name="cubeLevel"]:checked')?.value || 'lv2'
        };
        
        let txs = getTransactions(cardId);
        
        // ‚òÖ Á∑®ËºØÊ®°ÂºèÔºöÁßªÈô§Ëàä‰∫§ÊòìÂæåÂä†ÂÖ•Êõ¥Êñ∞ÂæåÁöÑ‰∫§Êòì
        if (editingTxId) {
            txs = txs.filter(t => t.id !== editingTxId);
        }
        
        txs.push(tx);
        saveTransactions(cardId, txs);
        
        // ‚òÖ ÈáçÁΩÆÁ∑®ËºØÁãÄÊÖã
        editingTxId = null;
        document.getElementById('btn-confirm').innerText = 'Á¢∫Ë™ç';
        
        if (cardId === 'c8') updateHappyUsed(tx);
        
        renderGrid();
        renderModalHistory(cardId);
        
        document.getElementById('amountInput').value = '';
        document.getElementById('noteInput').value = '';
        document.getElementById('liveRewardCalc').style.display = 'none';
        document.getElementById('twdConversionDisplay').style.display = 'none';
        
       if (closeAfter) {
            // ÂÅúÂú®Ë®òÂ∏≥È†ÅÔºåÊç≤Âà∞ÂàóË°®ËÆìÁî®Êà∂Á¢∫Ë™ç
            document.getElementById('amountInput').value = '';
            document.getElementById('noteInput').value = '';
            document.getElementById('modalHistoryList').scrollIntoView({ behavior: 'smooth' });
        } else {
            document.getElementById('amountInput').focus();
        }
    }

    function updateHappyUsed(tx) {
        const used = JSON.parse(localStorage.getItem('happy_used') || '{}');
        const cycleKey = getCycleKey('c8');
        if (!used[cycleKey]) used[cycleKey] = { pet: 0, life: 0, peace: 0 };
        
        const amount = tx.amountTWD || tx.amount;
        if (tx.isHappyPet || tx.happyMode === 'pet') {
            used[cycleKey].pet += Math.floor(amount * 0.095);
        } else if (tx.isHappyLife || tx.happyMode === 'life') {
            used[cycleKey].life += Math.floor(amount * 0.035);
        } else if (tx.isHappyPeace || tx.happyMode === 'peace') {
            used[cycleKey].peace += Math.floor(amount * 0.035);
        }
        localStorage.setItem('happy_used', JSON.stringify(used));
    }

    function shiftHistoryMonth(dir) {
        const newOffset = historyMonthOffset + dir;
        if (newOffset > 0) return;
        historyMonthOffset = newOffset;
        const cardId = document.getElementById('cardIdInput').value;
        renderModalHistory(cardId);
    }

    function getOffsetCycleTransactions(cardId, offset) {
        const txs = getTransactions(cardId);
        const settings = cardSettings[cardId] || {};
        const cycleDay = parseInt(settings.cycleDay) || 0;
        const target = new Date();
        target.setMonth(target.getMonth() + offset);
        const targetKey = getCycleKey(cardId, target);
        return txs.filter(tx => getCycleKey(cardId, tx.date) === targetKey);
    }

    function renderModalHistory(cardId) {
        const container = document.getElementById('modalHistoryList');
        const txs = (historyMonthOffset === 0) ? getCurrentCycleTransactions(cardId) : getOffsetCycleTransactions(cardId, historyMonthOffset);

        // Êõ¥Êñ∞Ê®ôÈ°å
        const label = document.getElementById('historyMonthLabel');
        const nextBtn = document.getElementById('historyNextBtn');
        if (historyMonthOffset === 0) {
            label.innerText = 'üìÖ Êú¨ÊúüÊ∂àË≤ªÁ¥ÄÈåÑ';
            nextBtn.style.visibility = 'hidden';
        } else {
            const d = new Date();
            d.setMonth(d.getMonth() + historyMonthOffset);
            label.innerText = `üìÖ ${d.getFullYear()}/${d.getMonth() + 1} Ê∂àË≤ªÁ¥ÄÈåÑ`;
            nextBtn.style.visibility = 'visible';
        }

        if (txs.length === 0) {
            container.innerHTML = '<div style="text-align:center; color:#aaa; padding:20px; font-size:12px;">Êú¨ÊúüÂ∞öÁÑ°Ê∂àË≤ªÁ¥ÄÈåÑ</div>';
            return;
        }
        
        txs.sort((a, b) => {
            const dateA = parseFlexibleDate(a.date || a.timestamp);
            const dateB = parseFlexibleDate(b.date || b.timestamp);
            if (dateB - dateA !== 0) return dateB - dateA;
            const timeA = a.timestamp ? new Date(a.timestamp).getTime() : (a.id || 0);
            const timeB = b.timestamp ? new Date(b.timestamp).getTime() : (b.id || 0);
            return timeB - timeA;
        });
        
        container.innerHTML = '';
        const showCount = parseInt(container.dataset.showCount || '5');
        const displayTxs = txs.slice(0, showCount);
        displayTxs.forEach(tx => {
            const div = document.createElement('div');
            div.className = 'history-item';
            
            const txDate = parseFlexibleDate(tx.date);
            const txTime = tx.timestamp ? new Date(tx.timestamp) : (tx.id ? new Date(tx.id) : null);
            const timeStr = txTime ? txTime.toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit', hour12: false }) : '';
            const dateStr = txDate ?
                txDate.toLocaleDateString('zh-TW', { month: 'short', day: 'numeric' }) + (timeStr ? ' ' + timeStr : '') : '';
            const amount = tx.amountTWD || tx.amount || 0;
            const txLoc = tx.location || tx.loc || 'TW';
            const currency = tx.currency || LOCATION_CONFIG[txLoc]?.currency || 'TWD';
            
            let displayAmount;
            if (txLoc === 'TW' || currency === 'TWD') {
                displayAmount = `${amount.toLocaleString()} ÂÖÉ`;
            } else {
                displayAmount = `${(tx.amount || amount).toLocaleString()} ${currency}`;
            }
            
            div.innerHTML = `
                <div style="flex:1;" onclick="editTransaction('${cardId}', ${tx.id})">
                    <div class="h-name">${tx.note || '(ÁÑ°ÂÇôË®ª)'}</div>
                    <div class="h-date">${dateStr}</div>
                </div>
                <div class="h-amount">${displayAmount}</div>
                <button class="btn-delete-single" onclick="event.stopPropagation(); deleteTransaction('${cardId}', ${tx.id})">‚úï</button>
            `;
            container.appendChild(div);
       });
        if (txs.length > showCount) {
            const moreBtn = document.createElement('div');
            moreBtn.style.cssText = 'text-align:center; padding:10px; color:#007AFF; font-size:13px; cursor:pointer; border-top:1px solid #eee;';
            moreBtn.innerText = `ËºâÂÖ•Êõ¥Â§ö (ÈÇÑÊúâ ${txs.length - showCount} Á≠Ü)`;
            moreBtn.onclick = () => { container.dataset.showCount = showCount + 10; renderModalHistory(cardId); };
            container.insertBefore(moreBtn, container.firstChild);
        }
    }

    function parseFlexibleDate(dateStr) {
        if (!dateStr) return null;
        if (dateStr instanceof Date) return dateStr;
        
        let d = new Date(dateStr);
        if (!isNaN(d.getTime())) return d;
        
        if (typeof dateStr === 'string' && dateStr.includes('/')) {
            d = new Date(dateStr.replace(/\//g, '-'));
            if (!isNaN(d.getTime())) return d;
        }
        return null;
    }

    function editTransaction(cardId, txId) {
        const txs = getTransactions(cardId);
        const tx = txs.find(t => t.id === txId);
        if (!tx) return;
        
        // Ê®ôË®òÁÇ∫Á∑®ËºØÊ®°ÂºèÔºà‰∏çÁ´ãÂç≥Âà™Èô§Ôºâ
        editingTxId = txId;
        
        // ÈÇÑÂéüÂü∫Êú¨Ê¨Ñ‰Ωç
        document.getElementById('amountInput').value = tx.amount;
        document.getElementById('noteInput').value = tx.note || '';
        
        if (tx.date) document.getElementById('dateInput').value = tx.date;
        
        
        // ‚òÖ Ê†πÊìöÂç°ÁâáÈ°ûÂûãÈÇÑÂéüÊâÄÊúâÂ∞àÂ±¨ÈÅ∏È†Ö
        if (cardId === 'c6') {
            document.getElementById('checkBonus10').checked = tx.isBonus10 || false;
            document.getElementById('checkBonus25').checked = tx.isBonus25 || false;
            document.getElementById('checkIsBill').checked = tx.isBill || false;
            if (tx.isBill) {
                document.getElementById('labelBaseRate').innerText = "üî∞ Âü∫Êú¨ÂõûÈ•ã 0.15% (ÁÑ°‰∏äÈôê)";
            }
        }
        else if (cardId === 'c5') {
            document.getElementById('checkLaiDianNew').checked = tx.isLaiDianNew || false;
            const mode = tx.laiDianMode || 'general';
            document.querySelector(`input[name="laiDianMode"][value="${mode}"]`).checked = true;
        }
        else if (cardId === 'c2') {
            document.getElementById('checkGreenChannel').checked = tx.isGreenChannel || false;
            document.getElementById('checkForeign').checked = tx.isForeign || false;
        }
        else if (cardId === 'c7') {
            document.getElementById('checkUniUp').checked = tx.isUniUp || false;
            document.getElementById('checkUniBonus').checked = tx.isUniBonus || false;
        }
        else if (cardId === 'c8') {
            document.getElementById('checkHappyPet').checked = tx.isHappyPet || (tx.happyMode === 'pet') || false;
            document.getElementById('checkHappyLife').checked = tx.isHappyLife || (tx.happyMode === 'life') || false;
            document.getElementById('checkHappyPeace').checked = tx.isHappyPeace || (tx.happyMode === 'peace') || false;
            document.getElementById('checkHappyForeign').checked = tx.isHappyForeign || (tx.happyMode === 'foreign') || false;
        }
        else if (cardId === 'c9') {
            document.getElementById('checkHsbcForeign').checked = tx.isHsbcForeign || false;
            const tier = tx.hsbcTier || 'infinite';
            const tierRadio = document.querySelector(`input[name="hsbcTier"][value="${tier}"]`);
            if (tierRadio) tierRadio.checked = true;
        }
        else if (cardId === 'c10') {
            document.getElementById('checkUniGroup').checked = tx.isUniGroup || false;
            document.getElementById('checkUniIcash').checked = tx.isUniIcash || false;
            document.getElementById('checkUniOverseas').checked = tx.isUniOverseas || false;
        }
        else if (cardId === 'c11') {
            let mode = tx.richartMode || 'general';
            // Áõ∏ÂÆπËàäÁâàÔºöpay‚Üítaishinpay, online/overseas‚Üíplan33, line‚Üílinepay
            if (mode === 'pay') mode = 'taishinpay';
            else if (mode === 'online' || mode === 'overseas') mode = 'plan33';
            else if (mode === 'line') mode = 'linepay';
            const modeRadio = document.querySelector(`input[name="richartMode"][value="${mode}"]`);
            if (modeRadio) modeRadio.checked = true;
            if (mode === 'plan33' && tx.richartPlan33) {
                const sel = document.getElementById('selRichartPlan33');
                if (sel) sel.value = tx.richartPlan33;
            }
            toggleRichartLogic();
        }
        else if (cardId === 'j1') {
            // Áõ∏ÂÆπËàäÊ†ºÂºè
            const oldRegion = tx.fubonJRegion || '';
            const oldBonus = tx.fubonJBonus || '';
            
            // ÈÇÑÂéüÊó•Èüì/Ê≥∞ÂúãÊ∂àË≤ª
            if (tx.isFubonJJpkr || oldRegion === 'jpkr') {
                document.getElementById('checkFubonJJpkr').checked = true;
                toggleFubonJJpkr();
            } else if (tx.isFubonJTh || oldRegion === 'th') {
                document.getElementById('checkFubonJTh').checked = true;
                toggleFubonJTh();
            }
            
            // ÈÇÑÂéüÂä†Á¢ºÈÅ∏È†Ö
            if (tx.isFubonJJpkrBonus || oldBonus === 'jpkr_physical') {
                document.getElementById('checkFubonJJpkrBonus').checked = true;
            }
            if (tx.isFubonJSuica || oldBonus === 'suica') {
                document.getElementById('checkFubonJSuica').checked = true;
            }
            if (tx.isFubonJThBonus || oldBonus === 'th_physical') {
                document.getElementById('checkFubonJThBonus').checked = true;
            }
        }
        else if (cardId === 'j2') {
            document.getElementById('checkJiheJapan').checked = tx.isJiheJapan || false;
            document.getElementById('checkJiheApple').checked = tx.isJiheApple || false;
            document.getElementById('checkJiheDomesticJapanese').checked = tx.isJiheDomesticJapanese || false;
            if (tx.isJiheJapan) toggleJiheLogic();
        }
        else if (cardId === 'j3') {
            document.getElementById('checkKumamonJapan').checked = tx.isKumamonJapan || false;
            document.getElementById('checkKumamonDesignated').checked = tx.isKumamonDesignated || false;
            document.getElementById('checkKumamonPayPay').checked = tx.isKumamonPayPay || false;
            if (tx.isKumamonJapan) toggleKumamonLogic();
        }
        else if (cardId === 'j4') {
            const level = tx.currencyLevel || 'low';
            const levelRadio = document.querySelector(`input[name="currencyLevel"][value="${level}"]`);
            if (levelRadio) levelRadio.checked = true;
            const isSelected = tx.isCurrencySelected || false;
            document.querySelector(`input[name="currencyType"][value="${isSelected ? 'selected' : 'domestic'}"]`).checked = true;
        }
        else if (cardId === 'j5') {
            document.getElementById('checkSinopacMitsuiSelected').checked = tx.isSinopacMitsuiSelected || false;
            document.getElementById('checkSinopacMitsuiTarget').checked = tx.isSinopacMitsuiTarget || false;
        }
        else if (cardId === 'c12') {
            document.getElementById('checkSinopacJcbForeign').checked = tx.isSinopacJcbForeign || false;
            document.getElementById('checkSinopacJcbBonus').checked = tx.isSinopacJcbBonus || false;
            document.getElementById('checkSinopacJcbQuarterly').checked = tx.isSinopacJcbQuarterly || false;
        }
        else if (cardId === 'c4') {
            document.getElementById('checkJiangSelected').checked = tx.isJiangSelected || false;
            document.getElementById('checkJiangTravel').checked = tx.isJiangTravel || false;
            updateJiangMinSpendWarning();
        }
        else if (cardId === 'dbs1') {
            document.getElementById('checkDbsLinePay').checked = tx.isDbsLinePay || false;
            document.getElementById('checkDbsGreen').checked = tx.isDbsGreen || false;
            document.getElementById('checkDbsForeign').checked = tx.isDbsForeign || false;
        }
        else if (cardId === 'c1') {
            document.getElementById('checkLegendBonus').checked = tx.isLegendBonus || false;
        }
        else if (cardId === 'cube1') {
            const mode = tx.cubeMode || 'general';
            const modeRadio = document.querySelector(`input[name="cubeMode"][value="${mode}"]`);
            if (modeRadio) modeRadio.checked = true;
            document.getElementById('checkCubeLinePay').checked = tx.isCubeLinePay || false;
            if (tx.cubeLevel) {
                const lvRadio = document.querySelector(`input[name="cubeLevel"][value="${tx.cubeLevel}"]`);
                if (lvRadio) lvRadio.checked = true;
            }
        }
        
        // Êõ¥Êñ∞Á¢∫Ë™çÊåâÈàïÊñáÂ≠ó
        document.getElementById('btn-confirm').innerText = 'Êõ¥Êñ∞';
        document.querySelector('.modal-content').scrollTop = 0;
        
        updateRewardPreview();
    }

  function deleteTransaction(cardId, txId, shouldRender = true, skipConfirm = false) {
        // ‚òÖ Ëã•ÈùûË∑≥ÈÅéÁ¢∫Ë™çÊ®°ÂºèÔºåÈ°ØÁ§∫Á¢∫Ë™çÂΩàÁ™ó
        if (!skipConfirm) {
            if (!confirm('Á¢∫ÂÆöË¶ÅÂà™Èô§ÈÄôÁ≠ÜÊ∂àË≤ªÁ¥ÄÈåÑÂóéÔºü')) {
                return;
            }
        }
        
        let txs = getTransactions(cardId);
        txs = txs.filter(t => t.id !== txId);
        saveTransactions(cardId, txs);
        
        if (shouldRender) {
            renderGrid();
            renderModalHistory(cardId);
        }
    }

    function formatAmountWithCurrency(amountTWD) {
        if (currentLocation === 'TW') {
            return `${amountTWD.toLocaleString()} ÂÖÉ`;
        } else {
            const rate = getCurrentRate();
            const foreignAmount = Math.round(amountTWD / rate);
            return `${foreignAmount.toLocaleString()} ${LOCATION_CONFIG[currentLocation].currency}`;
        }
    }

    function getCardBonusSpent(cardId, filterFn) {
        const txs = getCurrentCycleTransactions(cardId);
        let total = 0;
        txs.forEach(tx => {
            if (filterFn(tx)) {
                total += (tx.amountTWD || tx.amount || 0);
            }
        });
        return total;
    }

    function getFubonJQuotaUsed() {
        const txs = getCurrentCycleTransactions('j1');
        let physicalSpent = 0, suicaSpent = 0;
        
       txs.forEach(tx => {
        const amount = tx.amountTWD || tx.amount || 0;
        const bonus = tx.fubonJBonus || 'none';
        const isPhysical = (bonus === 'jpkr_physical') || (bonus === 'th_physical') || tx.isFubonJJpkrBonus || tx.isFubonJThBonus;
        const isSuica = (bonus === 'suica') || tx.isFubonJSuica;
        
        if (isPhysical && amount >= 1000) {
            physicalSpent += amount;
        } else if (isSuica && amount >= 2000) {
            suicaSpent += amount;
        }
    });
        
        // Â∞ÅÈ†ÇÈáëÈ°ç (Ê∂àË≤ªÈáëÈ°ç)
        const physicalLimit = 33333; // Êó•ÈüìÂØ¶È´îÂà∑ 33,333 ÂèØÊãø 1,000 ÂõûÈ•ã
        const suicaLimit = 2857;     // ‰∫§ÈÄöÂç°Âà∑ 2,857 ÂèØÊãø 200 ÂõûÈ•ã
        
        return {
            physicalSpent,
            physicalLimit,
            physicalRemain: Math.max(0, physicalLimit - physicalSpent),
            suicaSpent,
            suicaLimit,
            suicaRemain: Math.max(0, suicaLimit - suicaSpent)
        };
    }
// ‚òÖ‚òÖ‚òÖ Ë±¨ÂØåÂç°Â∞ÅÈ†ÇÈ°çÂ∫¶Ë®àÁÆó (Êñ∞Â¢û) ‚òÖ‚òÖ‚òÖ
    function getPigRichQuotaUsed() {
        const txs = getCurrentCycleTransactions('c6');
        let bonus10Spent = 0, bonus25Spent = 0;
        
        txs.forEach(tx => {
            const amount = tx.amountTWD || tx.amount || 0;
            if (tx.isBill) return;
            if (tx.isBonus10) bonus10Spent += amount;
            if (tx.isBonus25) bonus25Spent += amount;
        });
        
        return {
            bonus10Spent,
            bonus10Limit: 8000,
            bonus10Remain: Math.max(0, 8000 - bonus10Spent),
            bonus25Spent,
            bonus25Limit: 400000,
            bonus25Remain: Math.max(0, 400000 - bonus25Spent)
        };
    }

    // ‚òÖ‚òÖ‚òÖ UniOpen Â∞ÅÈ†ÇÈ°çÂ∫¶Ë®àÁÆó (Êñ∞Â¢û) ‚òÖ‚òÖ‚òÖ
    function getUniOpenQuotaUsed() {
        const txs = getCurrentCycleTransactions('c10');
        let groupSpent = 0, icashSpent = 0, overseasSpent = 0, brandSpent = 0;
        
        txs.forEach(tx => {
            const amount = tx.amountTWD || tx.amount || 0;
            if (tx.isUniOverseas) {
                overseasSpent += amount;
            } else {
                if (tx.isUniGroup) groupSpent += amount;
                if (tx.isUniIcash) icashSpent += amount;
                if (tx.isUniGroup && (tx.uniBrandCount || 0) >= 5) brandSpent += amount;
            }
        });
        
        return {
            groupSpent, groupLimit: 25000, groupRemain: Math.max(0, 25000 - groupSpent),
            icashSpent, icashLimit: 3750, icashRemain: Math.max(0, 3750 - icashSpent),
            overseasSpent, overseasLimit: 6250, overseasRemain: Math.max(0, 6250 - overseasSpent),
            brandSpent, brandLimit: 12500, brandRemain: Math.max(0, 12500 - brandSpent)
        };
    }
    // JCB Âç°Â∞ÅÈ†ÇÈ°çÂ∫¶Ë®àÁÆó
    function getJcbQuotaUsed() {
        const txs = getCurrentCycleTransactions('c12');
        let bonusSpent = 0;
        
        txs.forEach(tx => {
            const amount = tx.amountTWD || tx.amount || 0;
            // ÊúâÂãæÈÅ∏Âä†Á¢º (Êó•Êú¨ÊàñÁâπÈÅ∏) ÁöÑ‰∫§ÊòìÊâçË®àÂÖ•
            if (tx.isSinopacJcbBonus) {
                bonusSpent += amount;
            }
        });
        
        // Âä†Á¢º‰∏äÈôê $300/Êúà (Á¥ÑÂà∑ $10,000)
        const bonusLimit = 10000;
        
        return {
            bonusSpent,
            bonusLimit,
            bonusRemain: Math.max(0, bonusLimit - bonusSpent)
        };
    }
// ‚òÖ‚òÖ‚òÖ Â∞áÂ∞áÂç°ÊóÖÈÅäÈÄöË∑ØÂ∞ÅÈ†ÇÈ°çÂ∫¶Ë®àÁÆó (Â≠£Âà∂) ‚òÖ‚òÖ‚òÖ
    function getJiangTravelQuotaUsed() {
        const txs = getTransactions('c4');
        const now = new Date();
        const qStart = new Date(now.getFullYear(), Math.floor(now.getMonth() / 3) * 3, 1);
        const qEnd = new Date(now.getFullYear(), Math.floor(now.getMonth() / 3) * 3 + 3, 0, 23, 59, 59);
        
        let travelSpent = 0, quarterTotal = 0;
        txs.forEach(tx => {
            const txDate = parseFlexibleDate(tx.date);
            if (!txDate || txDate < qStart || txDate > qEnd) return;
            const amount = tx.amountTWD || tx.amount || 0;
            quarterTotal += amount;
            if (tx.isJiangTravel) travelSpent += amount;
        });
        
        const travelLimit = 11111;
        return {
            travelSpent,
            travelLimit,
            travelRemain: Math.max(0, travelLimit - travelSpent),
            quarterTotal,
            quarterMinSpend: 6000,
            reachedMinSpend: quarterTotal >= 6000
        };
    }
      // ÂñÆÁ≠ÜÂõûÈ•ãË®àÁÆó
    function calculateSingleReward(cardId, amount, options) {
        let reward = 0;
        let rate = 0;
        
        const card = cards.find(c => c.id === cardId);
        if (!card) return { reward: 0, rate: 0 };

       // C6 Ë±¨ÂØåÂç° (‰øÆÂæ©ÔºöÂä†ÂÖ•Â∞ÅÈ†ÇË®àÁÆó)
        if (cardId === 'c6') {
            const quota = getPigRichQuotaUsed();
            
            if (options.isBill) {
                reward = Math.floor(amount * 0.0015);
                rate = 0.0015;
                if (options.isBonus10) {
                    if (quota.bonus10Spent < quota.bonus10Limit) {
                        const available10 = quota.bonus10Limit - quota.bonus10Spent;
                        const validFor10 = Math.min(amount, available10);
                        reward += Math.floor(validFor10 * 0.10);
                        rate = (amount > 0) ? (reward / amount) : 0.0015;
                    }
                }
            } else {
                let baseReward = Math.floor(amount * 0.01);
                reward = baseReward;
                rate = 0.01;
                
                if (options.isBonus10) {
                    if (quota.bonus10Spent >= quota.bonus10Limit) {
                        // Â∑≤Â∞ÅÈ†ÇÔºå‰∏çÂä†Á¢º
                    } else {
                        const available10 = quota.bonus10Limit - quota.bonus10Spent;
                        const validFor10 = Math.min(amount, available10);
                        reward += Math.floor(validFor10 * 0.10);
                    }
                }
                
                if (options.isBonus25) {
                    if (quota.bonus25Spent >= quota.bonus25Limit) {
                        // Â∑≤Â∞ÅÈ†ÇÔºå‰∏çÂä†Á¢º
                    } else {
                        const available25 = quota.bonus25Limit - quota.bonus25Spent;
                        const validFor25 = Math.min(amount, available25);
                        if (currentLocation === 'JP') {
                            reward += Math.floor(validFor25 * 0.01);
                        } else {
                            reward += Math.floor(validFor25 * 0.025);
                        }
                    }
                }
                
                rate = (amount > 0) ? (reward / amount) : 0.01;
            }
            return { reward, rate };
        }
        // C5 Ë≥¥ÈªûÂç°
        else if (cardId === 'c5') {
            let totalReward = Math.floor(amount * 0.01); // Âü∫Êú¨ 1%
            
            // ÂúãÂ§ñÂè™ÊúâÂü∫Êú¨ 1% (‰∏îÈùû‰∏ÄËà¨Ê∂àË≤ªÈÅ∏È†ÖÊôÇ)
            if (currentLocation !== 'TW' && options.mode !== 'general') {
                return { reward: totalReward, rate: 0.01 };
            }

            // LP Ëàá ÂÅ∂Êï∏Êó• Ê®°ÂºèÁöÜÈúÄÂñÆÁ≠ÜÊªø 100 Êâç‰∫´Âä†Á¢º
            if (amount >= 100) {
                // 1. LINE Pay Âä†Á¢º (+1%)
                // Âè™Ë¶ÅÊ®°ÂºèÊòØ 'lp' Êàñ 'even' (ÂÅ∂Êï∏Êó•ÂøÖÁÇ∫LP)ÔºåÈÉΩÁ¨¶ÂêàÊ≠§Ê¢ù‰ª∂
                if (options.mode === 'lp' || options.mode === 'even') {
                    // Ë®àÁÆóÂ∑≤‰ΩøÁî®ÁöÑ LP È°çÂ∫¶ (ÂåÖÂê´ lp Âíå even ÁöÑ‰∫§Êòì)
                    const lpSpent = getCardBonusSpent(cardId, t => (t.laiDianMode === 'lp' || t.laiDianMode === 'even') && (t.amountTWD || t.amount) >= 100);
                    
                    // LP +1% (ÈôêÂà∑2Ëê¨)
                    if (lpSpent < 20000) {
                        totalReward += Math.floor(Math.min(amount, 20000 - lpSpent) * 0.01);
                    }
                    
                    // Êñ∞Êà∂ +4% (ÈôêÂà∑7500ÔºåÈúÄÁ∂ÅÂÆö LP)
                    if (options.isNew) {
                        const newSpent = getCardBonusSpent(cardId, t => (t.laiDianMode === 'lp' || t.laiDianMode === 'even') && t.isLaiDianNew && (t.amountTWD || t.amount) >= 100);
                        if (newSpent < 7500) {
                            totalReward += Math.floor(Math.min(amount, 7500 - newSpent) * 0.04);
                        }
                    }
                }

                // 2. ÂÅ∂Êï∏Êó•Âä†Á¢º (+5%)
                if (options.mode === 'even') {
                    const evenSpent = getCardBonusSpent(cardId, t => t.laiDianMode === 'even' && (t.amountTWD || t.amount) >= 100);
                    // ÂÅ∂Êï∏Êó• +5% (ÈôêÂà∑3000)
                    if (evenSpent < 3000) {
                        totalReward += Math.floor(Math.min(amount, 3000 - evenSpent) * 0.05);
                    }
                }
            }
            
            rate = (amount > 0) ? (totalReward / amount) : 0.01;
            return { reward: totalReward, rate: rate };
        }
       // C2 Á∂†Âç° (‰øÆÂæ©ÔºöÁ∂†Ëâ≤ÈÄöË∑ØÂ∞ÅÈ†Ç)
        else if (cardId === 'c2') {
            if (options.isForeign) {
                rate = 0.02;
                reward = Math.floor(amount * rate);
            } else if (options.isGreen) {
                const greenSpent = getCardBonusSpent(cardId, t => t.isGreenChannel);
                const greenLimit = 3000;
                const baseReward = Math.floor(amount * 0.01);
                
                if (greenSpent >= greenLimit) {
                    reward = baseReward;
                    rate = 0.01;
                } else {
                    const available = greenLimit - greenSpent;
                    const validForGreen = Math.min(amount, available);
                    reward = baseReward + Math.floor(validForGreen * 0.05);
                    rate = (amount > 0) ? (reward / amount) : 0.06;
                }
            } else {
                rate = 0.01;
                reward = Math.floor(amount * rate);
            }
            return { reward, rate };
        }
    // C7 UNIÂç° (‰øÆÂæ©ÔºöÂä†ÂÖ•Â∞ÅÈ†ÇË®àÁÆó)
        else if (cardId === 'c7') {
            if (currentLocation !== 'TW') {
                rate = 0.01;
                reward = Math.floor(amount * rate);
            } else {
                const baseReward = Math.floor(amount * 0.01);
                reward = baseReward;
                
                // ‰ªªÊÑèÈÅ∏/UPÈÅ∏ Âä†Á¢º
                const isUp = options.isUp;
                const bonusRate = isUp ? 0.035 : 0.025; // UPÈÅ∏+3.5%, ‰ªªÊÑèÈÅ∏+2.5%
                const bonusLimit = isUp ? 140000 : 40000;
               const bonusSpent = getCardBonusSpent(cardId, t => !editingTxId || t.id < editingTxId);
                
                if (bonusSpent < bonusLimit) {
                    const available = bonusLimit - bonusSpent;
                    const validForBonus = Math.min(amount, available);
                    reward += Math.floor(validForBonus * bonusRate);
                }
                
               // Áµ±‰∏ÄÊôÇ‰ª£‰ªªÂãô +3%
                if (options.isBonus) {
                    const timeLimit = 16000;
                    const timeSpent = getCardBonusSpent(cardId, t => t.isUniBonus && (!editingTxId || t.id < editingTxId));
                    if (timeSpent < timeLimit) {
                        const available = timeLimit - timeSpent;
                        const validForTime = Math.min(amount, available);
                        reward += Math.floor(validForTime * 0.03);
                    }
                }
                
                rate = (amount > 0) ? (reward / amount) : 0.01;
            }
            return { reward, rate };
        }
   // C8 Ê®ÇÂÆ∂+Âç° (‰øÆÂæ©ÔºöÂúãÂ§ñÊ∂àË≤ª‰∏çÈúÄ‰ΩéÊ∂àÔºåÂÖ∂‰ªñÈúÄ$3,000Êâç‰∫´Âä†Á¢º)
        else if (cardId === 'c8') {
            const baseReward = Math.floor(amount * 0.005);
            reward = baseReward;
            
            // ÂúãÂ§ñÊ∂àË≤ª +2% ÁÑ°‰∏äÈôêÔºå‰∏çÈúÄË¶Å‰ΩéÊ∂à
            if (options.isForeign) {
                reward += Math.floor(amount * 0.02);
                rate = (amount > 0) ? (reward / amount) : 0.025;
                return { reward, rate };
            }
            
            // ÂÖ∂‰ªñÂä†Á¢ºÈúÄÊ™¢Êü•ÊòØÂê¶ÈÅî‰ΩéÊ∂à $3,000
            const txs = getCurrentCycleTransactions(cardId);
            const totalSpent = txs.reduce((sum, tx) => sum + (tx.amountTWD || tx.amount || 0), 0);
            const minSpend = 3000;
            const reachedMinSpend = (totalSpent + amount) >= minSpend;
            
            if (!reachedMinSpend) {
                // Êú™ÈÅî‰ΩéÊ∂àÔºåÂè™ÊúâÂü∫Êú¨ 0.5%
                rate = 0.005;
                return { reward, rate };
            }
            
            if (options.isPet) {
                // ÂØµÁâ© +9.5%ÔºåÂõûÈ•ã‰∏äÈôê $500
                const petUsed = getCardBonusSpent(cardId, t => t.isHappyPet || t.happyMode === 'pet');
                const petRewardUsed = Math.floor(petUsed * 0.095);
                const petRewardRemain = Math.max(0, 500 - petRewardUsed);
                const thisPetReward = Math.min(Math.floor(amount * 0.095), petRewardRemain);
                reward += thisPetReward;
            } else if (options.isLife) {
                // ÁîüÊ¥ª +3.5%ÔºåÂõûÈ•ã‰∏äÈôê $200
                const lifeUsed = getCardBonusSpent(cardId, t => t.isHappyLife || t.happyMode === 'life');
                const lifeRewardUsed = Math.floor(lifeUsed * 0.035);
                const lifeRewardRemain = Math.max(0, 200 - lifeRewardUsed);
                const thisLifeReward = Math.min(Math.floor(amount * 0.035), lifeRewardRemain);
                reward += thisLifeReward;
            } else if (options.isPeace) {
                // ÂÆâÂøÉ +3.5%ÔºåÂõûÈ•ã‰∏äÈôê $200
                const peaceUsed = getCardBonusSpent(cardId, t => t.isHappyPeace || t.happyMode === 'peace');
                const peaceRewardUsed = Math.floor(peaceUsed * 0.035);
                const peaceRewardRemain = Math.max(0, 200 - peaceRewardUsed);
                const thisPeaceReward = Math.min(Math.floor(amount * 0.035), peaceRewardRemain);
                reward += thisPeaceReward;
            }
            
            rate = (amount > 0) ? (reward / amount) : 0.005;
            return { reward, rate };
        }
        // C9 ÊóÖ‰∫∫Âç° (Âì©Á®ã)
       else if (cardId === 'c9') {
            const tier = options.tier || 'infinite';
            let milesPerDollar;
            if (tier === 'light') {
                milesPerDollar = 20;
            } else if (options.isForeign) {
                milesPerDollar = (tier === 'infinite') ? 10 : 15;
            } else {
                milesPerDollar = 18;
            }
            reward = Math.floor(amount / milesPerDollar);
            rate = 1 / milesPerDollar;
            return { reward, rate };
        }
        
        // È†êË®≠
        // C10 UniOpenÂç° (‰øÆÂæ©ÔºöÂÖàÂä†Á∏ΩÂõûÈ•ãÁéáÂÜçË®àÁÆó)
        else if (cardId === 'c10') {
            const txs = getCurrentCycleTransactions('c10');
            let overseasSpent = 0, groupSpent = 0, icashSpent = 0, brandSpent = 0;
            txs.forEach(t => {
                if (editingTxId && t.id === editingTxId) return;
                const a = t.amountTWD || t.amount || 0;
                if (t.isUniOverseas) overseasSpent += a;
                else {
                    if (t.isUniGroup) groupSpent += a;
                    if (t.isUniIcash) icashSpent += a;
                    if (t.isUniGroup && (t.uniBrandCount || 0) >= 5) brandSpent += a;
                }
            });
            const quota = {
                overseasSpent, overseasLimit: 6250, overseasRemain: Math.max(0, 6250 - overseasSpent),
                groupSpent, groupLimit: 25000, groupRemain: Math.max(0, 25000 - groupSpent),
                icashSpent, icashLimit: 3750, icashRemain: Math.max(0, 3750 - icashSpent),
                brandSpent, brandLimit: 12500, brandRemain: Math.max(0, 12500 - brandSpent)
            };
            
            if (options.isOverseas) {
                // Êµ∑Â§ñÂØ¶È´î 11%
                const availableOverseas = Math.max(0, quota.overseasLimit - quota.overseasSpent);
                if (availableOverseas <= 0) {
                    // Â∑≤Â∞ÅÈ†ÇÔºåÂè™ÊúâÂü∫Êú¨ 1%
                    return { reward: Math.floor(amount * 0.01), rate: 0.01 };
                }
                const validForOverseas = Math.min(amount, availableOverseas);
                const overseasReward = Math.floor(validForOverseas * 0.11);
                const baseReward = Math.floor((amount - validForOverseas) * 0.01);
                reward = overseasReward + baseReward;
                rate = (availableOverseas >= amount) ? 0.11 : (amount > 0 ? (reward / amount) : 0.11);
            } else {
                // ÂúãÂÖßÊ∂àË≤ªÔºöÂü∫Êú¨ + ÂêÑÈ†ÖÂä†Á¢ºÂàÜÈñãÁÆóÂ∞ÅÈ†Ç
                reward = Math.floor(amount * 0.01);
                
                // Áµ±‰∏ÄÈõÜÂúò +2%
                if (options.isGroup) {
                    const available = Math.max(0, quota.groupLimit - quota.groupSpent);
                    if (available > 0) {
                        reward += Math.floor(Math.min(amount, available) * 0.02);
                    }
                }
                
                // icash Pay +4%
                if (options.isIcash) {
                    const available = Math.max(0, quota.icashLimit - quota.icashSpent);
                    if (available > 0) {
                        reward += Math.floor(Math.min(amount, available) * 0.04);
                    }
                }
                
                // Ë∏©Èªû‰ªªÂãô +1%~4%
                const brandCount = options.brandCount || 0;
                if (brandCount >= 2 && options.isGroup) {
                    const available = Math.max(0, quota.brandLimit - quota.brandSpent);
                    if (available > 0) {
                        let brandRate = 0;
                        if (brandCount >= 5) brandRate = 0.04;
                        else if (brandCount >= 4) brandRate = 0.03;
                        else if (brandCount >= 3) brandRate = 0.02;
                        else brandRate = 0.01;
                        reward += Math.floor(Math.min(amount, available) * brandRate);
                    }
                }
                
                rate = (amount > 0) ? (reward / amount) : 0.01;
            }
            return { reward, rate };
        }
        // C11 RichartÂç°
        else if (cardId === 'c11') {
            const mode = options.mode || 'general';
            if (mode === 'general') rate = 0.003;
            else if (mode === 'taishinpay') rate = 0.038;
            else if (mode === 'linepay') rate = 0.023;
            else if (mode === 'plan33') rate = 0.033;
            else if (mode === 'holiday') rate = 0.02;
            else if (mode === 'jpPaypay') rate = 0.053;
            // Áõ∏ÂÆπËàäÁâà mode ÂÄº
            else if (mode === 'pay') rate = 0.038;
            else if (mode === 'online' || mode === 'overseas') rate = 0.033;
            else if (mode === 'line') rate = 0.023;
            reward = Math.floor(amount * rate);
            return { reward, rate };
        }
        // Ëá™Âª∫Âç°Áâá
        else if (cardId.startsWith('custom_')) {
            rate = card.tier1Rate || 0;
            const t2Rate = card.tier2Rate || 0;
            if (card.limit && card.limit < 99999999) {
                const bonusSpent = getCardBonusSpent(cardId, t => (!editingTxId || t.id !== editingTxId));
                if (bonusSpent >= card.limit) {
                    reward = Math.floor(amount * t2Rate);
                    return { reward, rate: t2Rate };
                }
                const available = Math.min(amount, card.limit - bonusSpent);
                const overCap = amount - available;
                reward = Math.floor(available * rate) + Math.floor(overCap * t2Rate);
                return { reward, rate: amount > 0 ? reward / amount : rate };
            }
            reward = Math.floor(amount * rate);
            return { reward, rate };
        }
       // J1 ÂØåÈÇ¶JÂç° (Âê´Â∞ÅÈ†ÇÂà§Êñ∑)
        else if (cardId === 'j1') {
            const isJpkr = options.isJpkr || options.region === 'jpkr' || false;
            const isTh = options.isTh || options.region === 'th' || false;
            const isJpkrBonus = options.isJpkrBonus || options.bonus === 'jpkr_physical' || options.isFubonJJpkrBonus || false;
            const isSuica = options.isSuica || options.bonus === 'suica' || options.isFubonJSuica || false;
            const isThBonus = options.isThBonus || options.bonus === 'th_physical' || options.isFubonJThBonus || false;
            const quota = getFubonJQuotaUsed();
            
            // Âü∫Á§éÂõûÈ•ã (ÁÑ°‰∏äÈôê)
            let baseRate = 0.01; // ÂúãÂÖß
            if (isJpkr) baseRate = 0.03;
            else if (isTh) baseRate = 0.01;
            
            reward = Math.floor(amount * baseRate);
            
            // Âä†Á¢ºÂõûÈ•ã (Ê™¢Êü•Ââ©È§òÈ°çÂ∫¶ÔºåÁî® TWD ÈáëÈ°çÂà§Êñ∑‰ΩéÊ∂à)
            let bonusRate = 0;
            let cap = 0;
            let spent = 0;

            if (isJpkrBonus && amount >= 1000) {
                bonusRate = 0.03;
                cap = quota.physicalLimit;
                spent = quota.physicalSpent;
            } else if (isThBonus && amount >= 1000) {
                bonusRate = 0.05;
                cap = quota.physicalLimit;
                spent = quota.physicalSpent;
            } else if (isSuica && amount >= 2000) {
                bonusRate = 0.07;
                cap = quota.suicaLimit;
                spent = quota.suicaSpent;
            }

            if (bonusRate > 0) {
                const available = Math.max(0, cap - spent);
                const validForBonus = Math.min(amount, available);
                reward += Math.floor(validForBonus * bonusRate);
            }

            rate = (amount > 0) ? (reward / amount) : baseRate;
            return { reward, rate };
        }
       // J2 ÂêâÈ∂¥Âç°
        else if (cardId === 'j2') {
            if (options.isJapan) {
                let totalReward = Math.floor(amount * 0.025);
                let totalRate = 0.025;
                // Apple Pay ‰ΩéÊ∂àÈñÄÊ™ªÔºöÁ≠âÂÄºÂè∞Âπ£ $100
                if (options.isApple && amount >= 100) {
                    const appleSpent = getCardBonusSpent(cardId, t => t.isJiheJapan && t.isJiheApple);
                    if (appleSpent < 40000) {
                        totalReward += Math.floor(Math.min(amount, 40000 - appleSpent) * 0.015);
                        totalRate = 0.04; // 2.5% + 1.5% = 4%
                    }
                }
                return { reward: totalReward, rate: totalRate };
            } else {
                let totalReward = Math.floor(amount * 0.01);
                let totalRate = 0.01;
                // ÂúãÂÖßÊó•Á≥ªÂêçÂ∫óÔºàÁÑ°‰ΩéÊ∂àÈñÄÊ™ªÔºâ
                if (options.isDomesticJapanese) {
                    const djSpent = getCardBonusSpent(cardId, t => t.isJiheDomesticJapanese);
                    if (djSpent < 12500) {
                        totalReward += Math.floor(Math.min(amount, 12500 - djSpent) * 0.04);
                        totalRate = 0.05; // 1% + 4% = 5%
                    }
                }
                return { reward: totalReward, rate: totalRate };
            }
        }
       // J3 ÁÜäÊú¨ÁÜäÂç°
        else if (cardId === 'j3') {
            // PayPay Áç®Á´ãË®àÁÆóÔºà‰∏çËàáÂÖ∂‰ªñÂõûÈ•ãÁñäÂä†Ôºâ
            if (options.isPayPay) {
                const paypayLimit = 2857;
                const paypaySpent = getCardBonusSpent(cardId, t => t.isKumamonPayPay);
                
                if (paypaySpent >= paypayLimit) {
                    // Â∑≤Â∞ÅÈ†ÇÔºåÂõûÈ•ã 0%
                    return { reward: 0, rate: 0 };
                }
                
                const available = paypayLimit - paypaySpent;
                const validForPayPay = Math.min(amount, available);
                const payPayReward = Math.floor(validForPayPay * 0.05);
                // Ë∂ÖÂá∫Â∞ÅÈ†ÇÁöÑÈÉ®ÂàÜ‰πüÊòØ 0%
                
                return { reward: payPayReward, rate: (amount > 0) ? (payPayReward / amount) : 0.05 };
            }
            // Êó•Êú¨Ê∂àË≤ª
            if (options.isJapan) {
                let totalReward = Math.floor(amount * 0.025);
                if (options.isDesignated) {
                    const designatedSpent = getCardBonusSpent(cardId, t => t.isKumamonJapan && t.isKumamonDesignated);
                    if (designatedSpent < 8333) totalReward += Math.floor(Math.min(amount, 8333 - designatedSpent) * 0.06);
                }
                return { reward: totalReward, rate: totalReward / amount };
            }
            // ÂúãÂÖß‰∏ÄËà¨Ê∂àË≤ª
            return { reward: Math.floor(amount * 0.005), rate: 0.005 };
        }
        // J4 Âπ£ÂÄçÂç° (‰øÆÂæ©ÔºöÂä†ÂÖ•Â∞ÅÈ†ÇË®àÁÆó)
        else if (cardId === 'j4') {
            const baseReward = Math.floor(amount * 0.01);
            reward = baseReward;
            
            if (options.isSelected) {
                const level = options.level || localStorage.getItem('currency_level') || 'low';
                const bonusLimit = (level === 'high') ? 20000 : 7500;
                const bonusSpent = getCardBonusSpent(cardId, t => t.isCurrencySelected);
                
                if (bonusSpent < bonusLimit) {
                    const available = bonusLimit - bonusSpent;
                    const validForBonus = Math.min(amount, available);
                    reward += Math.floor(validForBonus * 0.05);
                }
            }
            
            rate = (amount > 0) ? (reward / amount) : 0.01;
            return { reward, rate };
        }
        // J5 ‰∏â‰∫ïÂç° (‰øÆÂæ©ÔºöÁâπÈÅ∏È§êÈ£≤ÂõûÈ•ã‰∏äÈôê)
        else if (cardId === 'j5') {
            const baseReward = Math.floor(amount * 0.003);
            reward = baseReward;
            
            if (options.isSelected) {
                // ÁâπÈÅ∏È§êÈ£≤ +7%ÔºåÂõûÈ•ã‰∏äÈôê $100
                const selectedSpent = getCardBonusSpent(cardId, t => t.isSinopacMitsuiSelected);
                const selectedRewardUsed = Math.floor(selectedSpent * 0.07);
                const selectedRewardRemain = Math.max(0, 100 - selectedRewardUsed);
                const thisSelectedReward = Math.min(Math.floor(amount * 0.07), selectedRewardRemain);
                reward += thisSelectedReward;
            }
            
            rate = (amount > 0) ? (reward / amount) : 0.003;
            return { reward, rate };
        }
        // C12 JCBÂç° (‰øÆÂæ©ÔºöÂä†ÂÖ•Â∞ÅÈ†ÇË®àÁÆó)
        else if (cardId === 'c12') {
            const quota = getJcbQuotaUsed();
            
            // Âü∫Á§éÂõûÈ•ã
            let baseRate = 0.01; // ÂúãÂÖß 1%
            if (options.isForeign) {
                baseRate = 0.02; // ÂúãÂ§ñ 2%
            }
            
            let totalReward = Math.floor(amount * baseRate);
            
            // Âä†Á¢ºÂõûÈ•ã (+3%ÔºåÈúÄÊ™¢Êü•Â∞ÅÈ†Ç)
            if (options.isBonus) {
                const available = Math.max(0, quota.bonusLimit - quota.bonusSpent);
                if (available > 0) {
                    const validForBonus = Math.min(amount, available);
                    totalReward += Math.floor(validForBonus * 0.03);
                }
            }
            
            rate = (amount > 0) ? (totalReward / amount) : baseRate;
            return { reward: totalReward, rate };
        }
    // C4 Â∞áÂ∞áÂç° (‰øÆÂæ©ÔºöÈÅî‰ΩéÊ∂àÂæåÂÖ®ÈÉ®ÂõûÊ∫Ø‰∫´Âä†Á¢º)
        else if (cardId === 'c4') {
            const isSelected = options.isJiangSelected || false;
            const isTravel = options.isJiangTravel || false;
            const txs = getCurrentCycleTransactions(cardId);
            const totalCycleSpent = txs.reduce((sum, tx) => sum + (tx.amountTWD || tx.amount || 0), 0);
            
            if (isSelected) {
                const minSpend = 3000;
                const selectedLimit = 6666;
                if ((totalCycleSpent + amount) < minSpend) {
                    return { reward: Math.floor(amount * 0.005), rate: 0.005 };
                }
                const selectedSpent = getCardBonusSpent(cardId, t => t.isJiangSelected && (!editingTxId || t.id !== editingTxId));
                if (selectedSpent >= selectedLimit) {
                    return { reward: Math.floor(amount * 0.005), rate: 0.005 };
                }
                const available = Math.min(amount, selectedLimit - selectedSpent);
                const bonusReward = Math.floor(available * 0.05);
                const baseReward = Math.floor((amount - available) * 0.005);
                return { reward: bonusReward + baseReward, rate: (bonusReward + baseReward) / amount };
          } else if (isTravel) {
                // ÊóÖÈÅäÈÄöË∑ØÔºöÂ≠£Âà∂Â∞ÅÈ†Ç
                const quota = getJiangTravelQuotaUsed();
                // ÊéíÈô§Ê≠£Âú®Á∑®ËºØÁöÑ‰∫§Êòì
                let adjTravelSpent = quota.travelSpent;
                let adjQuarterTotal = quota.quarterTotal;
                if (editingTxId) {
                    const editTx = getTransactions(cardId).find(t => t.id === editingTxId);
                    if (editTx) {
                        const editAmt = editTx.amountTWD || editTx.amount || 0;
                        adjQuarterTotal -= editAmt;
                        if (editTx.isJiangTravel) adjTravelSpent -= editAmt;
                    }
                }
                if ((adjQuarterTotal + amount) < 6000) {
                    return { reward: Math.floor(amount * 0.005), rate: 0.005 };
                }
                if (adjTravelSpent >= quota.travelLimit) {
                    return { reward: Math.floor(amount * 0.005), rate: 0.005 };
                }
                const available = Math.min(amount, quota.travelLimit - adjTravelSpent);
                const bonusReward = Math.floor(available * 0.05);
                const baseReward = Math.floor((amount - available) * 0.005);
                return { reward: bonusReward + baseReward, rate: (bonusReward + baseReward) / amount };
            }
            return { reward: Math.floor(amount * 0.005), rate: 0.005 };
        }
       // DBS1 ecoÂç° (‰øÆÂæ©ÔºöÂü∫Êú¨ÂõûÈ•ã + Âä†Á¢ºÂàÜÈñãË®àÁÆó)
        else if (cardId === 'dbs1') {
            // Âü∫Êú¨ÂõûÈ•ã 1%ÔºàÁÑ°‰∏äÈôêÔºâ
            let baseReward = Math.floor(amount * 0.01);
            let bonusReward = 0;
            
            if (options.isLinePay) {
                // Êñ∞Êà∂ LINE Pay +9%ÔºàÂä†Á¢º‰∏äÈôê 1000 ÈªûÔºâ
                const lpSpent = getCardBonusSpent(cardId, t => t.isDbsLinePay);
                const lpBonusUsed = Math.floor(lpSpent * 0.09); // Â∑≤Áî®ÊéâÁöÑÂä†Á¢ºÈªûÊï∏
                const lpBonusRemain = Math.max(0, 1000 - lpBonusUsed); // Ââ©È§òÂèØÁî®Âä†Á¢ºÈªûÊï∏
                if (lpBonusRemain > 0) {
                    bonusReward = Math.min(Math.floor(amount * 0.09), lpBonusRemain);
                }
            } else if (options.isGreen) {
                // Á∂†Ëâ≤/ÁâπÊñØÊãâ +9%ÔºàÂä†Á¢º‰∏äÈôê 300 ÈªûÔºâ
                const greenSpent = getCardBonusSpent(cardId, t => t.isDbsGreen);
                const greenBonusUsed = Math.floor(greenSpent * 0.09);
                const greenBonusRemain = Math.max(0, 300 - greenBonusUsed);
                if (greenBonusRemain > 0) {
                    bonusReward = Math.min(Math.floor(amount * 0.09), greenBonusRemain);
                }
            } else if (options.isForeign) {
                // ÂúãÂ§ñÂØ¶È´î +4%ÔºàÊúàÂà∑ $15,000 Â∞ÅÈ†ÇÔºâ
                const foreignSpent = getCardBonusSpent(cardId, t => t.isDbsForeign);
                const foreignRemain = Math.max(0, 15000 - foreignSpent);
                if (foreignRemain > 0) {
                    const validAmount = Math.min(amount, foreignRemain);
                    bonusReward = Math.floor(validAmount * 0.04);
                }
            }
            
            const totalReward = baseReward + bonusReward;
            const rate = (amount > 0) ? (totalReward / amount) : 0.01;
            return { reward: totalReward, rate: rate };
        }
        // C1 ÂÇ≥Ë™™Â∞çÊ±∫Âç°
        else if (cardId === 'c1') {
            const baseReward = Math.floor(amount * 0.012);
            if (options.isBonus && currentLocation === 'TW') {
               const bonusSpent = getCardBonusSpent(cardId, t => t.isLegendBonus && (t.location || 'TW') === 'TW' && (!editingTxId || t.id < editingTxId));
                const limit = 11363;
                if (bonusSpent < limit) {
                    const available = Math.min(amount, limit - bonusSpent);
                    const totalReward = baseReward + Math.floor(available * 0.088);
            return { reward: totalReward, rate: (available >= amount) ? 0.10 : (amount > 0 ? (totalReward / amount) : 0.10) };
                }
            }
            return { reward: baseReward, rate: 0.012 };
        }
        
        // CUBE1 ÂúãÊ≥∞CUBEÂç°
        else if (cardId === 'cube1') {
            const cubeMode = options.cubeMode || options.mode || 'general';
            const cubeLevel = options.cubeLevel || localStorage.getItem('cube_level') || 'lv2';
            const isCubeLP = options.isCubeLinePay || false;
            
            // ‰æùÁ≠âÁ¥öÊ±∫ÂÆö‰∏âÂ§ßÊñπÊ°àÂõûÈ•ãÁéá
            let levelRate = 0.03; // LV2 default
            if (cubeLevel === 'lv1') levelRate = 0.02;
            else if (cubeLevel === 'lv3') levelRate = 0.033;
            
            // ‰æù mode Ê±∫ÂÆöÂõûÈ•ãÁéá
            let mainRate = 0.003; // ‰∏ÄËà¨Ê∂àË≤ª
            if (cubeMode === 'digital' || cubeMode === 'dining' || cubeMode === 'travel') {
                mainRate = levelRate;
            } else if (cubeMode === 'select') {
                mainRate = 0.02;
            } else if (cubeMode === 'birthday_high') {
                mainRate = 0.10;
            } else if (cubeMode === 'birthday_low') {
                mainRate = 0.035;
            } else if (cubeMode === 'megaport_high') {
                mainRate = 0.10;
            } else if (cubeMode === 'megaport_low') {
                mainRate = 0.035;
            }
            
            reward = Math.floor(amount * mainRate);
            rate = mainRate;
            
            // LINE Pay È†òÂà∏Âä†Á¢º +1.7% (Êúà‰∏äÈôê 100 Èªû)
            if (isCubeLP) {
                const lpSpent = getCardBonusSpent(cardId, t => t.isCubeLinePay && (!editingTxId || t.id !== editingTxId));
                const lpRewardUsed = Math.floor(lpSpent * 0.017);
                const lpRemain = Math.max(0, 100 - lpRewardUsed);
                const thisLpReward = Math.min(Math.floor(amount * 0.017), lpRemain);
                reward += thisLpReward;
                rate = amount > 0 ? reward / amount : rate;
            }
            
            return { reward, rate };
        }
        
        // È†êË®≠ÔºàÂê´Ëá™Âª∫Âç°ÁâáÂ∞ÅÈ†ÇËôïÁêÜÔºâ
        rate = card.tier1Rate || 0.01;
        if (card.isCustom && card.limit && card.limit < 99999999) {
            const t2Rate = card.tier2Rate || 0;
            const bonusSpent = getCardBonusSpent(cardId, t => (!editingTxId || t.id !== editingTxId));
            if (bonusSpent >= card.limit) {
                return { reward: Math.floor(amount * t2Rate), rate: t2Rate };
            }
            const available = Math.min(amount, card.limit - bonusSpent);
            const overCap = amount - available;
            const reward = Math.floor(available * rate) + Math.floor(overCap * t2Rate);
            return { reward, rate: amount > 0 ? reward / amount : rate };
        }
        return { reward: Math.floor(amount * rate), rate };
    }

    function calculateStats(cardId) {
        const card = cards.find(c => c.id === cardId);
        if (!card || card.type === 'placeholder') return { spent: 0, reward: 0, progress: 0, msg: '' };
        
        if (cardId === 'j1') return calculateFubonJStats();
        if (cardId === 'c12') return calculateJcbStats();
        if (cardId === 'j3') return calculateKumamonStats();
        
        const txs = getCurrentCycleTransactions(cardId);
        let totalSpent = 0, totalReward = 0;
        
       let totalSpentForeign = 0;
       txs.forEach(tx => {
            const amount = tx.amountTWD || tx.amount || 0;
            totalSpent += amount;
            if (tx.location && tx.location !== 'TW' && tx.amount) totalSpentForeign += tx.amount;
        });
        
        const jiangMinSpend = 3000;
        const happyMinSpend = 3000;
       const jiangReachedMin = (cardId === 'c4') ? (totalSpent >= jiangMinSpend) : true;
        const happyReachedMin = (cardId === 'c8') ? (totalSpent >= happyMinSpend) : true;
        let legendBonusCumulative = 0;
        let uniBonusCumulative = 0;
        let uniTimeCumulative = 0;
        let jiangSelectedCumulative = 0;
        let jiangTravelCumulative = 0;
        let uniOpenGroupCumulative = 0;
        let uniOpenIcashCumulative = 0;
        let uniOpenOverseasCumulative = 0;
        let customCumulative = 0;
        let cubeLpCumulative = 0;
        
        txs.forEach(tx => {
            const amount = tx.amountTWD || tx.amount || 0;
            
            if (cardId === 'c4') {
            if (!jiangReachedMin) {
                totalReward += Math.floor(amount * 0.005);
            } else {
                let txReward = Math.floor(amount * 0.005);
                if (tx.isJiangSelected) {
                    const selectedLimit = 6666;
                    if (jiangSelectedCumulative < selectedLimit) {
                        const available = Math.min(amount, selectedLimit - jiangSelectedCumulative);
                        txReward = Math.floor(available * 0.05) + Math.floor((amount - available) * 0.005);
                    }
                    jiangSelectedCumulative += amount;
               } else if (tx.isJiangTravel) {
                    // ÊóÖÈÅäÈÄöË∑ØÂ≠£Âà∂ÔºöÁî® quota Âà§Êñ∑
                    const travelQuota = getJiangTravelQuotaUsed();
                    if (travelQuota.reachedMinSpend && jiangTravelCumulative < travelQuota.travelLimit) {
                        const available = Math.min(amount, travelQuota.travelLimit - jiangTravelCumulative);
                        txReward = Math.floor(available * 0.05) + Math.floor((amount - available) * 0.005);
                    }
                    jiangTravelCumulative += amount;
                }
                totalReward += txReward;
            }
            } else if (cardId === 'c8') {
                if (!happyReachedMin) {
                    totalReward += Math.floor(amount * 0.005);
                } else {
                    const result = calculateTxRewardWithCap(cardId, tx);
                    totalReward += result.reward;
                }
            } else if (cardId === 'c1') {
                const baseReward = Math.floor(amount * 0.012);
                if (tx.isLegendBonus && (tx.location || 'TW') === 'TW') {
                    const limit = 11363;
                    if (legendBonusCumulative < limit) {
                        const available = Math.min(amount, limit - legendBonusCumulative);
                        totalReward += baseReward + Math.floor(available * 0.088);
                    } else {
                        totalReward += baseReward;
                    }
                    legendBonusCumulative += amount;
                } else {
                    totalReward += baseReward;
                }
            } else if (cardId === 'c7') {
        if (currentLocation !== 'TW') {
            totalReward += Math.floor(amount * 0.01);
        } else {
            const uniSettings = JSON.parse(localStorage.getItem('uni_settings') || '{}');
            const isUp = tx.isUniUp || uniSettings.isUp;
            const bonusRate = isUp ? 0.035 : 0.025;
            const bonusLimit = isUp ? 140000 : 40000;
            let txReward = Math.floor(amount * 0.01);
            if (uniBonusCumulative < bonusLimit) {
                const available = Math.min(amount, bonusLimit - uniBonusCumulative);
                txReward += Math.floor(available * bonusRate);
            }
            uniBonusCumulative += amount;
            if (tx.isUniBonus) {
                const timeLimit = 16000;
                if (uniTimeCumulative < timeLimit) {
                    const available = Math.min(amount, timeLimit - uniTimeCumulative);
                    txReward += Math.floor(available * 0.03);
                }
                uniTimeCumulative += amount;
            }
            totalReward += txReward;
        }
    } else if (cardId === 'c10') {
                let txReward = Math.floor(amount * 0.01);
                if (tx.isUniOverseas) {
                    const overseasLimit = 6250;
                    if (uniOpenOverseasCumulative < overseasLimit) {
                        const available = Math.min(amount, overseasLimit - uniOpenOverseasCumulative);
                        txReward = Math.floor(available * 0.11) + Math.floor((amount - available) * 0.01);
                    }
                    uniOpenOverseasCumulative += amount;
                } else {
                    let bonusRate = 0;
                    if (tx.isUniGroup) {
                        const groupLimit = 25000;
                        if (uniOpenGroupCumulative < groupLimit) bonusRate += 0.02;
                    }
                    if (tx.isUniIcash) {
                        const icashLimit = 3750;
                        if (uniOpenIcashCumulative < icashLimit) bonusRate += 0.04;
                    }
                    if (tx.isUniGroup && (tx.uniBrandCount || 0) >= 2) {
                        const bc = tx.uniBrandCount;
                        if (bc >= 5) bonusRate += 0.04;
                        else if (bc >= 4) bonusRate += 0.03;
                        else if (bc >= 3) bonusRate += 0.02;
                        else bonusRate += 0.01;
                    }
                    txReward = Math.floor(amount * (0.01 + bonusRate));
                    if (tx.isUniGroup) uniOpenGroupCumulative += amount;
                    if (tx.isUniIcash) uniOpenIcashCumulative += amount;
                }
                totalReward += txReward;
    } else if (cardId === 'cube1') {
        // CUBEÂç°Ôºö‰∏ªÂõûÈ•ãÁÑ°‰∏äÈôêÔºåLINE PayÊúâ‰∏äÈôê
        const cubeMode = tx.cubeMode || 'general';
        const cubeLevel = tx.cubeLevel || localStorage.getItem('cube_level') || 'lv2';
        let levelRate = 0.03;
        if (cubeLevel === 'lv1') levelRate = 0.02;
        else if (cubeLevel === 'lv3') levelRate = 0.033;
        
        let mainRate = 0.003;
        if (cubeMode === 'digital' || cubeMode === 'dining' || cubeMode === 'travel') mainRate = levelRate;
        else if (cubeMode === 'select') mainRate = 0.02;
        else if (cubeMode === 'birthday_high') mainRate = 0.10;
        else if (cubeMode === 'birthday_low') mainRate = 0.035;
        else if (cubeMode === 'megaport_high') mainRate = 0.10;
        else if (cubeMode === 'megaport_low') mainRate = 0.035;
        
        let txReward = Math.floor(amount * mainRate);
        
        // LINE Pay È†òÂà∏ +1.7% Êúà‰∏äÈôê 100 Èªû
        if (tx.isCubeLinePay) {
            const lpRewardUsed = Math.floor(cubeLpCumulative * 0.017);
            const lpRemain = Math.max(0, 100 - lpRewardUsed);
            const thisLpReward = Math.min(Math.floor(amount * 0.017), lpRemain);
            txReward += thisLpReward;
            cubeLpCumulative += amount;
        }
        totalReward += txReward;
    } else if (card.isCustom && card.limit && card.limit < 99999999) {
        // Ëá™Âª∫Âç°ÁâáÂ∞ÅÈ†ÇÁ¥ØË®à
        const cRate = card.tier1Rate || 0.01;
        const cT2Rate = card.tier2Rate || 0;
        if (customCumulative < card.limit) {
            const available = Math.min(amount, card.limit - customCumulative);
            const overCap = amount - available;
            totalReward += Math.floor(available * cRate) + Math.floor(overCap * cT2Rate);
        } else {
            totalReward += Math.floor(amount * cT2Rate);
        }
        customCumulative += amount;
    } else {
        const result = calculateTxRewardWithCap(cardId, tx);
        totalReward += result.reward;
    }
        });
        
        let progress = 0, msg = '';
        let limit = card.limit || 99999999;
        
        // UNIÂç°ÔºöÊ†πÊìöÊòØÂê¶ UP ÈÅ∏Ë™øÊï¥Â∞ÅÈ†Ç
        if (cardId === 'c7') {
            const uniSettings = JSON.parse(localStorage.getItem('uni_settings') || '{}');
            limit = uniSettings.isUp ? 140000 : 40000;
        }
        const isOverseas = currentLocation !== 'TW';

        // ÁâπÊÆäËôïÁêÜÔºöRichartÂç° (c11) - ÁÑ°Â∞ÅÈ†ÇÔºåÈ°ØÁ§∫ÊñπÊ°àÂêç
        if (cardId === 'c11') {
            const rm = localStorage.getItem('richart_mode') || 'general';
            const rp = localStorage.getItem('richart_plan33') || 'tianti';
            const plan = getRichartPlanDisplay(rm, rp);
            msg = `${plan.name} ${plan.rate}`;
            progress = 0;
            return { spent: totalSpent, spentForeign: totalSpentForeign, reward: totalReward, progress, msg };
        }

        // ÁâπÊÆäËôïÁêÜÔºöCUBEÂç°
        if (cardId === 'cube1') {
            const cubeLevel = localStorage.getItem('cube_level') || 'lv2';
            const lvLabel = cubeLevel === 'lv1' ? 'LV1 2%' : cubeLevel === 'lv3' ? 'LV3 3.3%' : 'LV2 3%';
            const lpSpent = getCardBonusSpent(cardId, t => t.isCubeLinePay);
            const lpRewardUsed = Math.floor(lpSpent * 0.017);
            const lpRemain = Math.max(0, 100 - lpRewardUsed);
            if (lpSpent > 0) {
                if (lpRemain <= 0) {
                    msg = `${lvLabel} | LPÂ∞ÅÈ†Ç`;
                } else {
                    const lpSpendRemain = Math.ceil(lpRemain / 0.017);
                    msg = `${lvLabel} | LP$${lpSpendRemain.toLocaleString()}`;
                }
            } else {
                msg = `${lvLabel} ÊåáÂÆöÈÄöË∑ØÁÑ°‰∏äÈôê`;
            }
            progress = lpSpent > 0 ? Math.min(100, (lpRewardUsed / 100) * 100) : 0;
            return { spent: totalSpent, spentForeign: totalSpentForeign, reward: totalReward, progress, msg };
        }

        // ÁâπÊÆäËôïÁêÜÔºöUniOpen Âç° (c10)
        if (cardId === 'c10') {
            let groupSpent = 0, icashSpent = 0, overseasSpent = 0;
            txs.forEach(t => {
                const a = t.amountTWD || t.amount || 0;
                if (t.isUniOverseas) overseasSpent += a;
                if (t.isUniGroup) groupSpent += a;
                if (t.isUniIcash) icashSpent += a;
            });
            const groupLimit = 25000, icashLimit = 3750, overseasLimit = 6250;
            
           let parts = [];
            if (isOverseas) {
                if (overseasSpent >= overseasLimit) parts.push('Êµ∑Â§ñÂ∑≤Â∞ÅÈ†Ç');
                else parts.push(`Êµ∑Â§ñÂèØÂÜçÂà∑ ${formatAmountWithCurrency(overseasLimit - overseasSpent)}`);
            } else {
                if (groupSpent >= groupLimit) parts.push('ÈõÜÂúò‚ö°');
                else parts.push(`ÈõÜÂúò$${(groupLimit - groupSpent).toLocaleString()}`);
                
              if (window.promoStatus?.uniopen_icash_full) parts.push('icpÂ∑≤È°çÊªø');
                else if (icashSpent >= icashLimit) parts.push('icp‚ö°');
                else parts.push(`icp$${(icashLimit - icashSpent).toLocaleString()}`);
            }
            
            msg = parts.join('/');
            const mainSpent = isOverseas ? overseasSpent : groupSpent;
            const mainLimit = isOverseas ? overseasLimit : groupLimit;
            progress = Math.min(100, (mainSpent / mainLimit) * 100);
            
            return { spent: totalSpent, spentForeign: totalSpentForeign, reward: totalReward, progress, msg };
        }

        // ÂÖ®ÂüüÂúãÂ§ñÊ®°ÂºèÂº∑Âà∂ÂÄíÊï∏ (ÈáùÂ∞çÊúâÊµ∑Â§ñ‰∏äÈôêÁöÑÂç°Áâá)
        if (isOverseas) {
             // DBS eco (dbs1) - Êµ∑Â§ñÂØ¶È´î‰∏äÈôê 15000
             if (cardId === 'dbs1') {
                 const overseasLimit = 15000;
                 const overseasSpent = txs.reduce((sum, t) => (t.location !== 'TW' || t.isDbsForeign) ? sum + (t.amountTWD || t.amount) : sum, 0);
                 const remain = Math.max(0, overseasLimit - overseasSpent);
                 msg = (overseasSpent >= overseasLimit) ? 'Êµ∑Â§ñÂä†Á¢ºÂ∑≤Â∞ÅÈ†Ç' : `Êµ∑Â§ñÂèØÂÜçÂà∑ ${formatAmountWithCurrency(remain)}`;
                 progress = Math.min(100, (overseasSpent / overseasLimit) * 100);
                 return { spent: totalSpent, spentForeign: totalSpentForeign, reward: totalReward, progress, msg };
             }
             // Âπ£ÂÄçÂç° (j4) - Êµ∑Â§ñ‰∏äÈôê‰æùÁ≠âÁ¥ö
             if (cardId === 'j4') {
                 const level = localStorage.getItem('currency_level') || 'low';
                 const currencyLimit = (level === 'high') ? 20000 : 7500;
                 const qualSpent = txs.reduce((sum, t) => (t.isCurrencySelected || t.isSinopacCurrencySelected) ? sum + (t.amountTWD || t.amount) : sum, 0);
                 const remain = Math.max(0, currencyLimit - qualSpent);
                 msg = (qualSpent >= currencyLimit) ? 'Êµ∑Â§ñÂä†Á¢ºÂ∑≤Â∞ÅÈ†Ç' : `Êµ∑Â§ñÂèØÂÜçÂà∑ ${formatAmountWithCurrency(remain)}`;
                 progress = Math.min(100, (qualSpent / currencyLimit) * 100);
                 return { spent: totalSpent, spentForeign: totalSpentForeign, reward: totalReward, progress, msg };
             }
        }
// ÁâπÊÆäËôïÁêÜÔºöÂ∞áÂ∞áÂç°È°ØÁ§∫ÁîüÊ¥ª(Êúà)/ÊóÖÈÅä(Â≠£)Â∞ÅÈ†ÇÁãÄÊÖã
        if (cardId === 'c4') {
            const selectedLimit = 6666;
            const selectedSpent = txs.filter(t => t.isJiangSelected).reduce((sum, t) => sum + (t.amountTWD || t.amount || 0), 0);
            const travelQuota = getJiangTravelQuotaUsed();
            
            // ÁîüÊ¥ª‰ΩéÊ∂àÂà§Êñ∑ (Êúà $3,000)
            const lifeReached = totalSpent >= 3000;
            // ÊóÖÈÅä‰ΩéÊ∂àÂà§Êñ∑ (Â≠£ $6,000)
            const travelReached = travelQuota.reachedMinSpend;
            
            let lines = [];
            
            // === ‰ªªÂãôÂÄíÊï∏ (Êú™ÈÅî‰ΩéÊ∂à) ===
            if (!lifeReached) {
                lines.push(`üéØ ÁîüÊ¥ªÔºöÂ∑Æ$${(3000 - totalSpent).toLocaleString()}ÈÅîÊ®ô`);
            }
            if (!travelReached) {
                lines.push(`üéØ ÊóÖÈÅäÔºöÂ∑Æ$${(travelQuota.quarterMinSpend - travelQuota.quarterTotal).toLocaleString()}ÈÅîÊ®ô(Â≠£)`);
            }
            
            // === Â∞ÅÈ†ÇÂÄíÊï∏ (Â∑≤ÈÅî‰ΩéÊ∂àÂæåÊâçÈ°ØÁ§∫) ===
            if (lifeReached) {
                if (selectedSpent >= selectedLimit) {
                    lines.push('‚úÖ ÁîüÊ¥ªÂ∑≤Â∞ÅÈ†Ç');
                } else {
                    lines.push(`ÁîüÊ¥ªÂèØÂÜçÂà∑$${(selectedLimit - selectedSpent).toLocaleString()}`);
                }
            }
            if (travelReached) {
                if (travelQuota.travelSpent >= travelQuota.travelLimit) {
                    lines.push('‚úÖ ÊóÖÈÅäÂ∑≤Â∞ÅÈ†Ç(Â≠£)');
                } else {
                    lines.push(`ÊóÖÈÅäÂèØÂÜçÂà∑$${(travelQuota.travelRemain).toLocaleString()}(Â≠£)`);
                }
            }
            
            msg = lines.join('\n');
            progress = !lifeReached ? Math.min(100, (totalSpent / 3000) * 100) : Math.min(100, (selectedSpent / selectedLimit) * 100);
            
            return { spent: totalSpent, spentForeign: totalSpentForeign, reward: totalReward, progress, msg };
        }
        // ÁâπÊÆäËôïÁêÜÔºöÊ®ÇÂÆ∂Âç°È°ØÁ§∫ÂêÑÈ°ûÂà•Â∞ÅÈ†ÇÁãÄÊÖã
        if (cardId === 'c8') {
            const txs = getCurrentCycleTransactions('c8');
            let petSpent = 0, lifeSpent = 0, peaceSpent = 0;
            
            txs.forEach(tx => {
                const amount = tx.amountTWD || tx.amount || 0;
                if (tx.isHappyPet) petSpent += amount;
                if (tx.isHappyLife) lifeSpent += amount;
                if (tx.isHappyPeace) peaceSpent += amount;
            });
            
            const petLimit = 5263;
            const lifeLimit = 5714;
            const peaceLimit = 5714;
            
            let statusParts = [];
            // ‰ΩéÊ∂à‰ªªÂãôÊèêÈÜí
            if (totalSpent < 3000) {
                statusParts.push(`‚ö†Ô∏èÈúÄÁ¥ØÂà∑$${(3000 - totalSpent).toLocaleString()}`);
            }
            if (petSpent >= petLimit) {
                statusParts.push('ÂØµÁâ©Â∞ÅÈ†Ç');
            } else {
                statusParts.push(`ÂØµÁâ©$${(petLimit - petSpent).toLocaleString()}`);
            }
            if (lifeSpent >= lifeLimit) {
                statusParts.push('ÁîüÊ¥ªÂ∞ÅÈ†Ç');
            } else {
                statusParts.push(`ÁîüÊ¥ª$${(lifeLimit - lifeSpent).toLocaleString()}`);
            }
            if (peaceSpent >= peaceLimit) {
                statusParts.push('ÂÆâÂøÉÂ∞ÅÈ†Ç');
            } else {
                statusParts.push(`ÂÆâÂøÉ$${(peaceLimit - peaceSpent).toLocaleString()}`);
            }
            
            msg = statusParts.join('/');
            progress = totalSpent < 3000 ? Math.min(100, (totalSpent / 3000) * 100) : Math.min(100, (totalSpent / 26000) * 100);
            
            return { spent: totalSpent, spentForeign: totalSpentForeign, reward: totalReward, progress, msg };
        }

        // ÁâπÊÆäËôïÁêÜÔºöÊóÖ‰∫∫Âç°È°ØÁ§∫Á¥ØÁ©çÂì©Á®ã
        if (cardId === 'c9') {
            const initial = parseInt(localStorage.getItem('hsbc_initial') || '0');
            const redeemed = parseInt(localStorage.getItem('hsbc_redeemed') || '0');
            
            // Ë®àÁÆóÊ≠∑Âè≤Á∏ΩÂõûÈ•ã (‰∏çÂÉÖÊòØÁï∂Êúü)
            const allTxs = getTransactions(cardId);
            let allTimeReward = 0;
            allTxs.forEach(tx => {
                 const res = calculateTxRewardWithCap(cardId, tx);
                 allTimeReward += res.reward;
            });
            
            const currentBalance = initial + allTimeReward - redeemed;
            msg = `ÁõÆÂâçÁ¥ØÁ©ç ${currentBalance.toLocaleString()} Âì©`;
            progress = 50; // Âõ∫ÂÆöÈÄ≤Â∫¶
            
            return { spent: totalSpent, spentForeign: totalSpentForeign, reward: totalReward, progress, msg };
        }

        // ÂÑ™ÂÖàÁ¥ö 1: ‰ΩéÊ∂à‰ªªÂãô (Min Spend Task)
        if (card.minSpend && totalSpent < card.minSpend) {
            const diff = card.minSpend - totalSpent;
            msg = `Â∑Æ ${formatAmountWithCurrency(diff)} ÈÅî‰ΩéÊ∂à`;
            progress = Math.min(100, (totalSpent / card.minSpend) * 100);
        }
        // ÂÑ™ÂÖàÁ¥ö 2: ÈÅîÊ®ô‰ªªÂãô (Target Task, e.g. Á∂†Âç°ÂÅúËªä)
        else if (card.type === 'floor' && totalSpent < (card.target || 0)) {
            const diff = (card.target || 0) - totalSpent;
            msg = `Â∑Æ ${formatAmountWithCurrency(diff)} ÈÅîÊ®ô`;
            progress = Math.min(100, (totalSpent / card.target) * 100);
        }
        // ÂÑ™ÂÖàÁ¥ö 3: È°çÂ∫¶ÂÄíÊï∏ (Quota Countdown)
        else if (['ceiling', 'custom_happy', 'custom_legend', 'mixed', 'custom_j', 'uniopen_special', 'custom_mitsui', 'floor', 'custom_laidian'].includes(card.type)) {
            // Ê≥®ÊÑèÔºöfloor È°ûÂûãÈÅîÊ®ôÂæåÔºåËã•ÁÑ°ÂÖ∂‰ªñ limit ÂÆöÁæ©ÔºåÈ°ØÁ§∫Â∑≤ÈÅîÊ®ô
            if (card.type === 'floor') {
                 msg = card.msgSuccess || 'Â∑≤ÈÅîÊ®ô';
                 progress = 100;
            }
            else if (card.type === 'uniopen_special') {
                 msg = `Êú¨ÊúüÂ∑≤Âà∑ ${formatAmountWithCurrency(totalSpent)}`;
                 progress = (card.target && card.target > 0) ? Math.min(100, (totalSpent / card.target) * 100) : 0;
            }
            else if (card.type === 'custom_mitsui') {
                 // ‰∏â‰∫ïÂç°ÔºöÁâπÈÅ∏È§êÈ£≤ÂõûÈ•ãÂÄíÊï∏ + Â≠£ÊªøÈ°çÈÄ≤Â∫¶
                 const selectedSpent = getCardBonusSpent(cardId, t => t.isSinopacMitsuiSelected);
                 const selectedRewardUsed = Math.floor(selectedSpent * 0.07);
                 const selectedRewardRemain = Math.max(0, 100 - selectedRewardUsed);
                 if (selectedRewardRemain <= 0) {
                     msg = 'ÁâπÈÅ∏/È§êÈ£≤Â∞ÅÈ†Ç';
                 } else {
                     const spendRemain = Math.ceil(selectedRewardRemain / 0.07);
                     msg = `ÂèØÂÜçÂà∑ ÁâπÈÅ∏/È§êÈ£≤$${spendRemain.toLocaleString()}`;
                 }
                 progress = (card.target && card.target > 0) ? Math.min(100, (totalSpent / card.target) * 100) : 0;
            }
            else if (card.type === 'custom_laidian') {
                 // Ë≥¥ÈªûÂç°Â§öËªåÂÄíÊï∏ÔºöÂÅ∂Êï∏Êó• + LP + Êñ∞Êà∂
                 const evenSpent = getCardBonusSpent(cardId, t => t.laiDianMode === 'even' && (t.amountTWD || t.amount) >= 100);
                 const evenLimit = 3000;
                 const lpSpent = getCardBonusSpent(cardId, t => (t.laiDianMode === 'lp' || t.laiDianMode === 'even') && (t.amountTWD || t.amount) >= 100);
                 const lpLimit = 20000;
                 const newSpent = getCardBonusSpent(cardId, t => (t.laiDianMode === 'lp' || t.laiDianMode === 'even') && t.isLaiDianNew && (t.amountTWD || t.amount) >= 100);
                 const newLimit = 7500;
                 let parts = [];
                 if (evenSpent >= evenLimit) parts.push('ÂÅ∂Êï∏‚ö°');
                 else parts.push(`ÂÅ∂Êï∏$${(evenLimit - evenSpent).toLocaleString()}`);
                 if (lpSpent >= lpLimit) parts.push('LP‚ö°');
                 else parts.push(`LP$${(lpLimit - lpSpent).toLocaleString()}`);
                 const hasNewTx = getCardBonusSpent(cardId, t => t.isLaiDianNew) > 0;
                 if (hasNewTx) {
                     if (newSpent >= newLimit) parts.push('Êñ∞Êà∂‚ö°');
                     else parts.push(`Êñ∞Êà∂$${(newLimit - newSpent).toLocaleString()}`);
                 }
                 msg = parts.join('/');
                 progress = (evenSpent / evenLimit) * 100;
            }
            else {
                // ‰∏ÄËà¨Â∞ÅÈ†ÇË®àÁÆó
                progress = Math.min(100, (totalSpent / limit) * 100);
                if (totalSpent >= limit) {
                    msg = card.msgDanger || 'Â∑≤Â∞ÅÈ†Ç';
                } else {
                    const remainTWD = limit - totalSpent;
                    msg = `ÂèØÂÜçÂà∑ ${formatAmountWithCurrency(remainTWD)}`;
                }
            }
        } else if (card.type === 'miles') {
            // Fallback for generic miles if not c9
            msg = 'Á¥ØÁ©ç‰∏≠';
            progress = 50;
        }
        
        return { spent: totalSpent, spentForeign: totalSpentForeign, reward: totalReward, progress, msg };
    }

    function calculateKumamonStats() {
        const txs = getCurrentCycleTransactions('j3');
        let totalSpent = 0, totalReward = 0, totalSpentForeign = 0;
        let designatedCumulative = 0, paypayCumulative = 0;
        
        const designatedLimit = 8333;
        const paypayLimit = 2857;
        
        txs.forEach(tx => {
            const amount = tx.amountTWD || tx.amount || 0;
            totalSpent += amount;
            if (tx.location && tx.location !== 'TW' && tx.amount) totalSpentForeign += tx.amount;
            
            if (tx.isKumamonPayPay) {
                if (paypayCumulative < paypayLimit) {
                    const available = Math.min(amount, paypayLimit - paypayCumulative);
                    totalReward += Math.floor(available * 0.05);
                }
                paypayCumulative += amount;
            } else if (tx.isKumamonJapan) {
                let txReward = Math.floor(amount * 0.025);
                if (tx.isKumamonDesignated) {
                    if (designatedCumulative < designatedLimit) {
                        const available = Math.min(amount, designatedLimit - designatedCumulative);
                        txReward += Math.floor(available * 0.06);
                    }
                    designatedCumulative += amount;
                }
                totalReward += txReward;
            } else {
                totalReward += Math.floor(amount * 0.005);
            }
        });
        
        let parts = [];
        if (currentLocation === 'JP') {
            if (designatedCumulative >= designatedLimit) parts.push('ÊåáÂÆö‚ö°');
            else parts.push(`ÊåáÂÆö${formatAmountWithCurrency(designatedLimit - designatedCumulative)}`);
            
            if (paypayCumulative >= paypayLimit) parts.push('PP‚ö°');
            else parts.push(`PP${formatAmountWithCurrency(paypayLimit - paypayCumulative)}`);
       } else {
            if (totalSpent > 0) parts.push(`ÂúãÂÖß 0.5%`);
            else parts.push(`ÂèØÂà∑ÂúãÂÖß/Êó•Êú¨`);
        }
        
        const msg = parts.join('/');
        const mainSpent = (currentLocation === 'JP') ? designatedCumulative : totalSpent;
        const mainLimit = (currentLocation === 'JP') ? designatedLimit : 99999;
        const progress = Math.min(100, (mainSpent / mainLimit) * 100);
        
        return { spent: totalSpent, spentForeign: totalSpentForeign, reward: totalReward, progress, msg };
    }

    function calculateFubonJStats() {
        const txs = getCurrentCycleTransactions('j1');
        const quota = getFubonJQuotaUsed();
        
        let totalSpent = 0, totalReward = 0;
        
       let totalSpentForeign = 0;
       txs.forEach(tx => {
        const amount = tx.amountTWD || tx.amount || 0;
        totalSpent += amount;
        if (tx.location && tx.location !== 'TW' && tx.amount) totalSpentForeign += tx.amount;
        const isJpkr = tx.isFubonJJpkr || (tx.fubonJRegion === 'jpkr');
        const isTh = tx.isFubonJTh || (tx.fubonJRegion === 'th');
        const baseRate = isJpkr ? 0.03 : isTh ? 0.01 : 0.01;
        totalReward += Math.floor(amount * baseRate);
        
        const bonus = tx.fubonJBonus || 'none';
        const isPhysicalJpkr = tx.isFubonJJpkrBonus || (bonus === 'jpkr_physical');
        const isPhysicalTh = tx.isFubonJThBonus || (bonus === 'th_physical');
        const isSuica = tx.isFubonJSuica || (bonus === 'suica');
        
        if (isPhysicalJpkr && amount >= 1000) {
            totalReward += Math.floor(Math.min(amount, Math.max(0, quota.physicalLimit - (quota.physicalSpent - amount))) * 0.03);
        } else if (isPhysicalTh && amount >= 1000) {
            totalReward += Math.floor(Math.min(amount, Math.max(0, quota.physicalLimit - (quota.physicalSpent - amount))) * 0.05);
        } else if (isSuica && amount >= 2000) {
            totalReward += Math.floor(Math.min(amount, Math.max(0, quota.suicaLimit - (quota.suicaSpent - amount))) * 0.07);
        }
    });
        
        const progress = Math.min(100, (quota.physicalSpent / quota.physicalLimit) * 100);
        
        // Ë®äÊÅØÈ°ØÁ§∫ (Áî®Ê∂àË≤ªÈáëÈ°ç)
        let msg = '';
        const physicalCapped = quota.physicalRemain <= 0;
        const suicaCapped = quota.suicaRemain <= 0;
        
        if (physicalCapped && suicaCapped) {
            msg = 'Âä†Á¢ºÁöÜÂ∑≤Â∞ÅÈ†Ç';
        } else if (physicalCapped) {
            msg = `ÂØ¶È´îÂ∞ÅÈ†ÇÔΩú‰∫§ÈÄöÂèØÂÜçÂà∑ ${formatAmountWithCurrency(quota.suicaRemain)}`;
        } else if (suicaCapped) {
            msg = `ÂèØÂÜçÂà∑ ${formatAmountWithCurrency(quota.physicalRemain)}ÔΩú‰∫§ÈÄöÂ∞ÅÈ†Ç`;
        } else {
            msg = `ÂèØÂÜçÂà∑ ${formatAmountWithCurrency(quota.physicalRemain)}ÔΩú‰∫§ÈÄö ${formatAmountWithCurrency(quota.suicaRemain)}`;
        }
        
        return { spent: totalSpent, spentForeign: totalSpentForeign, reward: totalReward, progress, msg };
    }

    // JCB Âç°Áµ±Ë®à (Êñ∞Â¢û)
    function calculateJcbStats() {
        const txs = getCurrentCycleTransactions('c12');
        const quota = getJcbQuotaUsed();
        
        let totalSpent = 0, totalReward = 0, totalSpentForeign = 0;
        
        txs.forEach(tx => {
            const amount = tx.amountTWD || tx.amount || 0;
            totalSpent += amount;
            if (tx.location && tx.location !== 'TW' && tx.amount) totalSpentForeign += tx.amount;
            
            // Âü∫Á§éÂõûÈ•ã
            const baseRate = tx.isSinopacJcbForeign ? 0.02 : 0.01;
            totalReward += Math.floor(amount * baseRate);
        });
        
        // Âä†Á¢ºÂõûÈ•ã (Â∞ÅÈ†Ç $300ÔºåÂç≥Âà∑ $10,000)
        const bonusReward = Math.min(Math.floor(quota.bonusSpent * 0.03), 300);
        totalReward += bonusReward;
        
        const progress = Math.min(100, (quota.bonusSpent / quota.bonusLimit) * 100);
        
        let msg = '';
        if (quota.bonusRemain <= 0) {
            msg = 'Âä†Á¢ºÂ∑≤Â∞ÅÈ†Ç (ËÆä1%/2%)';
        } else {
            msg = `Âä†Á¢ºÂèØÂÜçÂà∑ ${formatAmountWithCurrency(quota.bonusRemain)}`;
        }
        
        return { spent: totalSpent, spentForeign: totalSpentForeign, reward: totalReward, progress, msg };
    }

    function calculateStatsAllLocations(cardId) {
        return calculateStats(cardId);
    }

    function calculateTxRewardWithCap(cardId, tx) {
        const options = {
            ...tx,
           mode: [tx.cubeMode, tx.laiDianMode, tx.richartMode].find(m => m && m !== 'general') || 'general',
            tier: tx.hsbcTier,
            brandCount: tx.uniBrandCount,
            region: tx.fubonJRegion,
            bonus: tx.fubonJBonus,
            level: tx.currencyLevel,
            isSelected: tx.isCurrencySelected || tx.isSinopacMitsuiSelected,
            isTarget: tx.isSinopacMitsuiTarget,
            isQuarterly: tx.isSinopacJcbQuarterly,
            isBonus: tx.isUniBonus || tx.isSinopacJcbBonus || tx.isLegendBonus,
            isNew: tx.isLaiDianNew,
            isJapan: tx.isJiheJapan || tx.isKumamonJapan,
            isApple: tx.isJiheApple,
            isDomesticJapanese: tx.isJiheDomesticJapanese,
            isDesignated: tx.isKumamonDesignated,
            isPayPay: tx.isKumamonPayPay,
            isPet: tx.isHappyPet,
            isLife: tx.isHappyLife,
            isPeace: tx.isHappyPeace,
            isForeign: tx.isForeign || tx.isHappyForeign || tx.isHsbcForeign || tx.isSinopacJcbForeign || tx.isDbsForeign,
            isGreen: tx.isGreenChannel || tx.isDbsGreen,
            isLinePay: tx.isDbsLinePay,
            isCubeLinePay: tx.isCubeLinePay,
            cubeLevel: tx.cubeLevel,
            isGroup: tx.isUniGroup,
            isIcash: tx.isUniIcash,
            isOverseas: tx.isUniOverseas,
            isUp: tx.isUniUp,
            isBonus10: tx.isBonus10,
            isBonus25: tx.isBonus25,
            isBill: tx.isBill
        };
        
        const result = calculateSingleReward(cardId, tx.amountTWD || tx.amount || 0, options);
        return result;
    }
function getCardDisplayName(card) {
        if (card.id === 'c9') {
            const tier = localStorage.getItem('hsbc_tier') || 'infinite';
            return tier === 'infinite' ? 'ÊªôË±êÊóÖ‰∫∫ÁÑ°ÈôêÂç°' : tier === 'light' ? 'ÊªôË±êÊóÖ‰∫∫ËºïÊóÖÂç°' : 'ÊªôË±êÊóÖ‰∫∫Âæ°ÁíΩÂç°';
        }
        if (card.id === 'c7') {
            const settings = JSON.parse(localStorage.getItem('uni_settings') || '{}');
            return settings.isUp ? 'ÁéâÂ±± UNI Âç°ÔºàUPÈÅ∏Ôºâ' : 'ÁéâÂ±± UNI Âç°';
        }
        return card.name;
    }
    function getRichartPlanDisplay(mode, plan33) {
        const plan33Names = { tianti: 'Â§©Â§©Âà∑', dabi: 'Â§ßÁ≠ÜÂà∑', haoxiang: 'Â•ΩÈ•óÂà∑', shuqu: 'Êï∏Ë∂£Âà∑', wanlv: 'Áé©ÊóÖÂà∑' };
        switch (mode) {
            case 'taishinpay': return { name: 'PayËëóÂà∑(Âè∞Êñ∞Pay)', rate: '3.8%' };
            case 'linepay': return { name: 'PayËëóÂà∑(LINE Pay)', rate: '2.3%' };
            case 'plan33': return { name: plan33Names[plan33] || 'Â§©Â§©Âà∑', rate: '3.3%' };
            case 'holiday': return { name: 'ÂÅáÊó•Âà∑', rate: '2%' };
            case 'jpPaypay': return { name: 'PayPay', rate: '5.3%' };
            // Áõ∏ÂÆπËàäÁâà
            case 'pay': return { name: 'PayËëóÂà∑(Âè∞Êñ∞Pay)', rate: '3.8%' };
            case 'online': return { name: 'Êï∏Ë∂£Âà∑', rate: '3.3%' };
            case 'overseas': return { name: 'Áé©ÊóÖÂà∑', rate: '3.3%' };
            case 'line': return { name: 'PayËëóÂà∑(LINE Pay)', rate: '2.3%' };
            default: return { name: '‰∏ÄËà¨Ê∂àË≤ª', rate: '0.3%' };
        }
    }

    function getCardMaxRate(card) {
        switch (card.id) {
            case 'c9': return '';
            case 'c7':
                const uniSettings = JSON.parse(localStorage.getItem('uni_settings') || '{}');
                return uniSettings.isUp ? '4.5%' : '3.5%';
            case 'c10': return '11%';
            case 'c6': return '13.5%';
            case 'c1': return '10%';
            case 'c5': return '11%';
            case 'c3': return '5%';
            case 'c4': return '5%';
            case 'c2': return '6%';
            case 'c8': return '10%';
            case 'c11': {
                const rm = localStorage.getItem('richart_mode') || 'general';
                const rp = localStorage.getItem('richart_plan33') || 'tianti';
                return getRichartPlanDisplay(rm, rp).rate;
            }
            case 'j1': return '10%';
            case 'j2': return '5%';
            case 'j3': return '8.5%';
            case 'j4': return '6%';
            case 'j5': return '7.3%';
            case 'c12': return '5%';
            case 'dbs1': return '10%';
          default:
                if (card.isCustom) {
                   return `${parseFloat((card.tier1Rate * 100).toFixed(2))}%`;
                }
                return '';
        }
    }
    function getCardDisplayNote(card) {
        // RichartÂç°ÔºöÈ°ØÁ§∫Áï∂ÂâçÊñπÊ°à
        if (card.id === 'c11') {
            const rm = localStorage.getItem('richart_mode') || 'general';
            const rp = localStorage.getItem('richart_plan33') || 'tianti';
            const plan = getRichartPlanDisplay(rm, rp);
            return `${plan.name} ${plan.rate} (ÁÑ°‰∏äÈôê)`;
        }
        // ÊóÖ‰∫∫Âç°ÔºöÊ†πÊìöÁ≠âÁ¥öÈ°ØÁ§∫‰∏çÂêåÂÖÉ/Âì©
        if (card.id === 'c9') {
            const tier = localStorage.getItem('hsbc_tier') || 'infinite';
           if (tier === 'infinite') {
                return 'ÂúãÂÖß 18ÂÖÉ/Âì© | ÂúãÂ§ñ 10ÂÖÉ/Âì©';
            } else if (tier === 'light') {
                return 'ÂúãÂÖßÂ§ñ 20ÂÖÉ/Âì©';
            } else {
                return 'ÂúãÂÖß 18ÂÖÉ/Âì© | ÂúãÂ§ñ 15ÂÖÉ/Âì©';
            }
        }
        // UNIÂç°ÔºöÊ†πÊìöÊòØÂê¶Ë®ÇÈñ± UP È°ØÁ§∫‰∏çÂêåÂõûÈ•ãÁéáÂíåÂ∞ÅÈ†Ç
        if (card.id === 'c7') {
            const settings = JSON.parse(localStorage.getItem('uni_settings') || '{}');
            if (settings.isUp) {
                return 'UPÈÅ∏ 4.5% (Âà∑$14Ëê¨Â∞ÅÈ†Ç)';
            } else {
                return '‰ªªÊÑèÈÅ∏ 3.5% (Âà∑$4Ëê¨Â∞ÅÈ†Ç)';
            }
        }
        // CUBEÂç°ÔºöÊ†πÊìöÁ≠âÁ¥öÈ°ØÁ§∫‰∏çÂêåÂõûÈ•ãÁéá
        if (card.id === 'cube1') {
            const level = localStorage.getItem('cube_level') || 'lv2';
            if (level === 'lv1') return 'ÊåáÂÆöÈÄöË∑Ø 2% ÁÑ°‰∏äÈôê (LV1)';
            if (level === 'lv3') return 'ÊåáÂÆöÈÄöË∑Ø 3.3% ÁÑ°‰∏äÈôê (LV3)';
            return 'ÊåáÂÆöÈÄöË∑Ø 3% ÁÑ°‰∏äÈôê (LV2)';
        }
        return card.note || '';
    }
    function renderGrid() {
        const grid = document.getElementById('card-grid');
        grid.innerHTML = '';
        
        const displayCards = getSortedCards();
        
        displayCards.forEach(card => {
            const tile = document.createElement('div');
            tile.className = 'card-tile';
           var cardPhoto = localStorage.getItem('card_photo_' + card.id);
            if (cardPhoto) {
                tile.style.background = 'linear-gradient(rgba(0,0,0,0.55), rgba(0,0,0,0.65)), url(' + cardPhoto + ')';
                tile.style.backgroundSize = 'cover, cover';
                tile.style.backgroundPosition = tile.style.backgroundPosition = 'center';;
                tile.style.color = 'white';
            } else {
                tile.style.background = card.gradient;
                tile.style.color = card.textColor;
            }
            tile.setAttribute('data-card-id', card.id);
            tile.onclick = () => openCardModal(card.id);
            
            if (card.type === 'placeholder') {
                tile.innerHTML = `
                    <div class="tile-header">
                        <div class="tile-name">${getCardDisplayName(card)}</div>
                    <div class="tile-body">
                        <div class="tile-stat-group">
                            <div class="tile-stat-main">Ôºã</div>
                            <div class="tile-stat-sub">${card.note}</div>
                        </div>
                    </div>
                `;
            } else {
                const stats = calculateStats(card.id);
                const nickname = cardSettings[card.id]?.nickname || card.nickname || '';
                const isMiles = card.type === 'miles';
                const rewardUnit = isMiles ? 'Âì©' : 'ÂÖÉ';
                
                // Ê∂àË≤ªÈáëÈ°çÈ°ØÁ§∫
                let spentDisplay;
                if (currentLocation !== 'TW' && stats.spentForeign > 0) {
                    spentDisplay = `${stats.spentForeign.toLocaleString()} ${LOCATION_CONFIG[currentLocation].currency}`;
                } else {
                    spentDisplay = formatAmountWithCurrency(stats.spent);
                }
                
               let cycleHint = '';
const settings = cardSettings[card.id] || {};
const cycleDay = parseInt(settings.cycleDay);

if (cycleDay && cycleDay > 0) {
    const now = new Date();
    const today = now.getDate();
    const thisMonth = now.getMonth();
    const thisYear = now.getFullYear();
    
    // ÂèñÂæóÊú¨ÊúàÂíå‰∏äÊúàÁöÑÂØ¶ÈöõÁµêÂ∏≥Êó•
    const actualCycleDayThisMonth = getActualCycleDay(thisYear, thisMonth, cycleDay);
    const actualCycleDayLastMonth = getActualCycleDay(thisYear, thisMonth - 1, cycleDay);
    
    let startDate, endDate;
    
    if (today > actualCycleDayThisMonth) {
        // Êú¨ÊúüÔºöÈÄôÂÄãÊúà ÁµêÂ∏≥Êó•+1 Âà∞ ‰∏ãÂÄãÊúà ÁµêÂ∏≥Êó•
        const actualCycleDayNextMonth = getActualCycleDay(thisYear, thisMonth + 1, cycleDay);
        startDate = new Date(thisYear, thisMonth, actualCycleDayThisMonth + 1);
        endDate = new Date(thisYear, thisMonth + 1, actualCycleDayNextMonth);
    } else {
        // Êú¨ÊúüÔºö‰∏äÂÄãÊúà ÁµêÂ∏≥Êó•+1 Âà∞ ÈÄôÂÄãÊúà ÁµêÂ∏≥Êó•
        startDate = new Date(thisYear, thisMonth - 1, actualCycleDayLastMonth + 1);
        endDate = new Date(thisYear, thisMonth, actualCycleDayThisMonth);
    }
    
    const sM = startDate.getMonth() + 1;
    const sD = startDate.getDate();
    const eM = endDate.getMonth() + 1;
    const eD = endDate.getDate();
    
    cycleHint = `${sM}/${sD} - ${eM}/${eD}`;
} else {
    const month = new Date().getMonth() + 1;
    cycleHint = `${month}Êúà`;
}
                
                let overseasWarning = '';
                if (currentLocation !== 'TW') {
                    if (['c5', 'c1', 'c7'].includes(card.id)) {
                        overseasWarning = '<div class="tile-overseas-warning" style="display:block;">‚ö†Ô∏è ÂúãÂ§ñÁÑ°Âä†Á¢º</div>';
                    } else if (card.id === 'c8') {
                        overseasWarning = '<div class="tile-overseas-warning" style="display:block;">‚ö†Ô∏è ÂÉÖÈôêÂúãÂ§ñ+2%</div>';
                    }
                }
                
               tile.innerHTML = `
                    <div class="tile-nickname-badge ${nickname ? '' : 'placeholder'}">${nickname || ''}</div>
                    <div class="tile-header">
                        <div class="tile-name">${getCardDisplayName(card)}</div>
                      ${getCardMaxRate(card) ? `<span class="rate-badge">${getCardMaxRate(card)}</span>` : ''}
                    </div>
                    <span class="tile-note">${getCardDisplayNote(card)}</span>
                    <div class="tile-body">
                        <div class="tile-stat-group">
                           <div class="tile-stat-main">Êú¨ÊúüÂ∑≤Âà∑ ${spentDisplay}</div>
                        </div>
                        <div class="tile-earned">+${stats.reward.toLocaleString()} ${rewardUnit}</div>
                    </div>
                    <div class="tile-footer">
                        <div class="progress-track"><div class="progress-fill" style="width:${stats.progress}%"></div></div>
                        <div class="tile-msg${stats.msg && stats.msg.includes('\n') ? ' multiline' : ''}">${stats.msg}</div>
                        ${overseasWarning}
                        <div class="tile-cycle-hint ${card.textColor === '#333' ? 'dark-text' : ''}">${cycleHint}</div>
                    </div>
                `;
            }
            
            grid.appendChild(tile);
        });
        
        initSortable();
        updateTotalReward();
        updateDateDisplay();
        checkUrgentAlerts();
    }

    // ===== Ê≠∑Âè≤Êúà‰ªΩÂõûÈ•ãË®àÁÆó =====
    function replayCyclePerTx(cardId, txs) {
        const card = cards.find(c => c.id === cardId);
        if (!card || card.type === 'placeholder' || txs.length === 0) return [];
        
        const perTx = [];
        let totalReward = 0;
        const totalSpent = txs.reduce((s, t) => s + (t.amountTWD || t.amount || 0), 0);
        
        // Cumulative state
        let jiangSelCum = 0, jiangTrvCum = 0;
        let legendCum = 0, uniBonusCum = 0, uniTimeCum = 0;
        let uoGroupCum = 0, uoIcashCum = 0, uoOverseasCum = 0;
        let cubeLpCum = 0, customCum = 0;
        let fubonPhysCum = 0, fubonSuicaCum = 0;
        let kumaDesigCum = 0, kumaPPCum = 0;
        let jcbBonusCum = 0;
        
        const jiangReachedMin = (cardId === 'c4') ? (totalSpent >= 3000) : true;
        const happyReachedMin = (cardId === 'c8') ? (totalSpent >= 3000) : true;
        
        txs.forEach(tx => {
            const prev = totalReward;
            const amount = tx.amountTWD || tx.amount || 0;
            
            if (cardId === 'c4') {
                if (!jiangReachedMin) {
                    totalReward += Math.floor(amount * 0.005);
                } else {
                    let r = Math.floor(amount * 0.005);
                    if (tx.isJiangSelected) {
                        const lim = 6666;
                        if (jiangSelCum < lim) { const av = Math.min(amount, lim - jiangSelCum); r = Math.floor(av * 0.05) + Math.floor((amount - av) * 0.005); }
                        jiangSelCum += amount;
                    } else if (tx.isJiangTravel) {
                        const tq = getJiangTravelQuotaUsed();
                        if (tq.reachedMinSpend && jiangTrvCum < tq.travelLimit) { const av = Math.min(amount, tq.travelLimit - jiangTrvCum); r = Math.floor(av * 0.05) + Math.floor((amount - av) * 0.005); }
                        jiangTrvCum += amount;
                    }
                    totalReward += r;
                }
            } else if (cardId === 'c8') {
                if (!happyReachedMin) { totalReward += Math.floor(amount * 0.005); }
                else { totalReward += calculateTxRewardWithCap(cardId, tx).reward; }
            } else if (cardId === 'c1') {
                const base = Math.floor(amount * 0.012);
                if (tx.isLegendBonus && (tx.location || 'TW') === 'TW') {
                    const lim = 11363;
                    if (legendCum < lim) { const av = Math.min(amount, lim - legendCum); totalReward += base + Math.floor(av * 0.088); }
                    else { totalReward += base; }
                    legendCum += amount;
                } else { totalReward += base; }
            } else if (cardId === 'c7') {
                const uniS = JSON.parse(localStorage.getItem('uni_settings') || '{}');
                const isUp = tx.isUniUp || uniS.isUp;
                const bRate = isUp ? 0.035 : 0.025;
                const bLim = isUp ? 140000 : 40000;
                let r = Math.floor(amount * 0.01);
                if (uniBonusCum < bLim) { const av = Math.min(amount, bLim - uniBonusCum); r += Math.floor(av * bRate); }
                uniBonusCum += amount;
                if (tx.isUniBonus) {
                    const tLim = 16000;
                    if (uniTimeCum < tLim) { const av = Math.min(amount, tLim - uniTimeCum); r += Math.floor(av * 0.03); }
                    uniTimeCum += amount;
                }
                totalReward += r;
            } else if (cardId === 'c10') {
                let r = Math.floor(amount * 0.01);
                if (tx.isUniOverseas) {
                    const lim = 6250;
                    if (uoOverseasCum < lim) { const av = Math.min(amount, lim - uoOverseasCum); r = Math.floor(av * 0.11) + Math.floor((amount - av) * 0.01); }
                    uoOverseasCum += amount;
                } else {
                    let br = 0;
                    if (tx.isUniGroup) { if (uoGroupCum < 25000) br += 0.02; }
                    if (tx.isUniIcash) { if (uoIcashCum < 3750) br += 0.04; }
                    if (tx.isUniGroup && (tx.uniBrandCount || 0) >= 2) {
                        const bc = tx.uniBrandCount;
                        br += bc >= 5 ? 0.04 : bc >= 4 ? 0.03 : bc >= 3 ? 0.02 : 0.01;
                    }
                    r = Math.floor(amount * (0.01 + br));
                    if (tx.isUniGroup) uoGroupCum += amount;
                    if (tx.isUniIcash) uoIcashCum += amount;
                }
                totalReward += r;
            } else if (cardId === 'cube1') {
                const cm = tx.cubeMode || 'general';
                const cl = tx.cubeLevel || localStorage.getItem('cube_level') || 'lv2';
                let lr = cl === 'lv1' ? 0.02 : cl === 'lv3' ? 0.033 : 0.03;
                let mr = 0.003;
                if (['digital','dining','travel'].includes(cm)) mr = lr;
                else if (cm === 'select') mr = 0.02;
                else if (cm === 'birthday_high' || cm === 'megaport_high') mr = 0.10;
                else if (cm === 'birthday_low' || cm === 'megaport_low') mr = 0.035;
                let r = Math.floor(amount * mr);
                if (tx.isCubeLinePay) {
                    const lpUsed = Math.floor(cubeLpCum * 0.017);
                    const lpRem = Math.max(0, 100 - lpUsed);
                    r += Math.min(Math.floor(amount * 0.017), lpRem);
                    cubeLpCum += amount;
                }
                totalReward += r;
            } else if (cardId === 'j1') {
                const isJpkr = tx.isFubonJJpkr || (tx.fubonJRegion === 'jpkr');
                const isTh = tx.isFubonJTh || (tx.fubonJRegion === 'th');
                const baseRate = isJpkr ? 0.03 : isTh ? 0.01 : 0.01;
                totalReward += Math.floor(amount * baseRate);
                const bonus = tx.fubonJBonus || 'none';
                const physJpkr = tx.isFubonJJpkrBonus || (bonus === 'jpkr_physical');
                const physTh = tx.isFubonJThBonus || (bonus === 'th_physical');
                const isSuica = tx.isFubonJSuica || (bonus === 'suica');
                const physLim = 33333, suicaLim = 2857;
                if (physJpkr && amount >= 1000) {
                    if (fubonPhysCum < physLim) totalReward += Math.floor(Math.min(amount, physLim - fubonPhysCum) * 0.03);
                    fubonPhysCum += amount;
                } else if (physTh && amount >= 1000) {
                    if (fubonPhysCum < physLim) totalReward += Math.floor(Math.min(amount, physLim - fubonPhysCum) * 0.05);
                    fubonPhysCum += amount;
                } else if (isSuica && amount >= 2000) {
                    if (fubonSuicaCum < suicaLim) totalReward += Math.floor(Math.min(amount, suicaLim - fubonSuicaCum) * 0.07);
                    fubonSuicaCum += amount;
                }
            } else if (cardId === 'j3') {
                if (tx.isKumamonPayPay) {
                    const lim = 2857;
                    if (kumaPPCum < lim) totalReward += Math.floor(Math.min(amount, lim - kumaPPCum) * 0.05);
                    kumaPPCum += amount;
                } else if (tx.isKumamonJapan) {
                    let r = Math.floor(amount * 0.025);
                    if (tx.isKumamonDesignated) {
                        const lim = 8333;
                        if (kumaDesigCum < lim) r += Math.floor(Math.min(amount, lim - kumaDesigCum) * 0.06);
                        kumaDesigCum += amount;
                    }
                    totalReward += r;
                } else { totalReward += Math.floor(amount * 0.005); }
            } else if (cardId === 'c12') {
                const baseRate = tx.isSinopacJcbForeign ? 0.02 : 0.01;
                totalReward += Math.floor(amount * baseRate);
                if (tx.isSinopacJcbBonus) {
                    const lim = 10000;
                    if (jcbBonusCum < lim) {
                        const av = Math.min(amount, lim - jcbBonusCum);
                        totalReward += Math.min(Math.floor(av * 0.03), 300 - Math.floor(jcbBonusCum * 0.03));
                    }
                    jcbBonusCum += amount;
                }
            } else if (card.isCustom && card.limit && card.limit < 99999999) {
                const cRate = card.tier1Rate || 0.01;
                const cT2 = card.tier2Rate || 0;
                if (customCum < card.limit) {
                    const av = Math.min(amount, card.limit - customCum);
                    totalReward += Math.floor(av * cRate) + Math.floor((amount - av) * cT2);
                } else { totalReward += Math.floor(amount * cT2); }
                customCum += amount;
            } else {
                totalReward += calculateTxRewardWithCap(cardId, tx).reward;
            }
            
            perTx.push({ id: tx.id, date: tx.date, reward: totalReward - prev });
        });
        
        return perTx;
    }
    
    function getMonthlyTotalReward(year, month) {
        let totalCash = 0, totalMiles = 0;
        
        cards.forEach(card => {
            if (card.type === 'placeholder') return;
            
            const allTxs = getTransactions(card.id);
            if (allTxs.length === 0) return;
            
            // ÊâæÂá∫ËêΩÂú®ÁõÆÊ®ôÊúà‰ªΩÁöÑ‰∫§Êòì ID
            const targetIds = new Set();
            allTxs.forEach(tx => {
                const d = parseFlexibleDate(tx.date);
                if (d && d.getFullYear() === year && d.getMonth() === (month - 1)) targetIds.add(tx.id);
            });
            if (targetIds.size === 0) return;
            
            // ÊåâÂ∏≥ÂñÆÈÄ±ÊúüÂàÜÁµÑ
            const groups = {};
            allTxs.forEach(tx => {
                const key = getCycleKey(card.id, tx.date);
                if (!groups[key]) groups[key] = [];
                groups[key].push(tx);
            });
            
            // Âè™ÈáçÊí≠Âê´ÊúâÁõÆÊ®ôÊúà‰ªΩ‰∫§ÊòìÁöÑÈÄ±Êúü
            Object.values(groups).forEach(cycleTxs => {
                if (!cycleTxs.some(tx => targetIds.has(tx.id))) return;
                // ÊåâÊó•ÊúüÊéíÂ∫èÁ¢∫‰øùÁ¥ØË®àÈ†ÜÂ∫èÊ≠£Á¢∫
                cycleTxs.sort((a, b) => new Date(a.date) - new Date(b.date));
                const perTx = replayCyclePerTx(card.id, cycleTxs);
                perTx.forEach(r => {
                    if (targetIds.has(r.id)) {
                        if (card.type === 'miles') totalMiles += r.reward;
                        else totalCash += r.reward;
                    }
                });
            });
        });
        
        return { totalCash, totalMiles };
    }
    
    // ===== ‰∏âÈ†ÅÂõûÈ•ãÂàáÊèõ =====
    let rewardPage = 1; // 0=Êúà‰ªΩ, 1=Áï∂Êúü, 2=Âπ¥Â∫¶
    
    function goRewardPage(idx) {
        rewardPage = idx;
        const track = document.getElementById('rewardCarouselTrack');
        track.style.transform = `translateX(-${idx * 100 / 3}%)`;
        updateRewardDots();
    }
    
    function updateRewardDots() {
        document.querySelectorAll('#rewardDots .reward-dot, .total-reward-card .reward-dot').forEach((d, i) => {
            // ÊØèÁµÑ3ÂÄãdotsÔºåÊâæÂá∫Â∞çÊáâÁöÑpage index
            const pageIdx = i % 3;
            d.classList.toggle('active', pageIdx === rewardPage);
        });
    }
    
    function buildHistoryOptions() {
        // ÊâæÊúÄÊó©‰∫§ÊòìÊúà‰ªΩ
        let earliest = new Date();
        cards.forEach(card => {
            if (card.type === 'placeholder') return;
            getTransactions(card.id).forEach(tx => {
                const d = parseFlexibleDate(tx.date);
                if (d && d < earliest) earliest = d;
            });
        });
        
        const now = new Date();
        const curYear = now.getFullYear();
        const curMonth = now.getMonth() + 1;
        
        // Êúà‰ªΩ‰∏ãÊãâ
        const mSel = document.getElementById('historyMonthSel');
        const prevM = mSel.value;
        mSel.innerHTML = '';
        let y = curYear, m = curMonth;
        const eY = earliest.getFullYear(), eM = earliest.getMonth() + 1;
        while (y > eY || (y === eY && m >= eM)) {
            mSel.appendChild(new Option(`${y}Âπ¥${m}Êúà`, `${y}_${m}`));
            m--;
            if (m < 1) { m = 12; y--; }
        }
        if ([...mSel.options].some(o => o.value === prevM)) mSel.value = prevM;
        
        // Âπ¥Â∫¶‰∏ãÊãâ
        const ySel = document.getElementById('historyYearSel');
        const prevY = ySel.value;
        ySel.innerHTML = '';
        for (let yr = curYear; yr >= earliest.getFullYear(); yr--) {
            ySel.appendChild(new Option(`üèÜ ${yr}Âπ¥ Á¥ØË®àÂõûÈ•ã`, String(yr)));
        }
        if ([...ySel.options].some(o => o.value === prevY)) ySel.value = prevY;
        
        // ÂàùÂßãË®àÁÆó
        onMonthSelChange();
        onYearSelChange();
        
        // È†êË®≠ÂÅúÂú®Áï∂ÊúüÔºà‰∏≠ÈñìÔºâ
        goRewardPage(1);
    }
    
    function displayReward(amountEl, milesEl, result) {
        amountEl.innerText = `$${result.totalCash.toLocaleString()}`;
        if (milesEl) {
            milesEl.innerText = result.totalMiles > 0 ? `‚úàÔ∏è ${result.totalMiles.toLocaleString()} Âì©` : '';
        }
    }
    
    function onMonthSelChange() {
        const val = document.getElementById('historyMonthSel').value;
        if (!val) return;
        const [y, m] = val.split('_').map(Number);
        const result = getMonthlyTotalReward(y, m);
        displayReward(
            document.getElementById('monthRewardDisplay'),
            document.getElementById('monthRewardMiles'),
            result
        );
    }
    
    function onYearSelChange() {
        const year = parseInt(document.getElementById('historyYearSel').value);
        if (!year) return;
        const now = new Date();
        const maxMonth = (year === now.getFullYear()) ? now.getMonth() + 1 : 12;
        let totalCash = 0, totalMiles = 0;
        for (let m = 1; m <= maxMonth; m++) {
            const r = getMonthlyTotalReward(year, m);
            totalCash += r.totalCash;
            totalMiles += r.totalMiles;
        }
        displayReward(
            document.getElementById('yearRewardDisplay'),
            document.getElementById('yearRewardMiles'),
            { totalCash, totalMiles }
        );
    }
    
    // Ëß∏ÊéßÊªëÂãï
    (function() {
        let startX = 0, swiping = false;
        const el = document.getElementById('rewardCarouselWrap');
        if (!el) return;
        el.addEventListener('touchstart', e => { startX = e.touches[0].clientX; swiping = true; }, { passive: true });
        el.addEventListener('touchend', e => {
            if (!swiping) return;
            swiping = false;
            const dx = e.changedTouches[0].clientX - startX;
            if (Math.abs(dx) > 40) {
                const newPage = rewardPage + (dx < 0 ? 1 : -1);
                if (newPage >= 0 && newPage <= 2) goRewardPage(newPage);
            }
        }, { passive: true });
    })();

    function updateTotalReward() {
        
        let totalCash = 0, totalMiles = 0;
        const savedLocation = currentLocation;
        currentLocation = 'TW';
        cards.forEach(card => {
            if (card.type === 'placeholder') return;
            const stats = calculateStats(card.id);
            if (card.type === 'miles') totalMiles += stats.reward;
            else totalCash += stats.reward;
        });
       let rewardHtml = '';
        if (totalCash > 0 && totalMiles > 0) {
            rewardHtml = `$${totalCash.toLocaleString()}<div style="font-size:60%; opacity:0.7; margin-top:2px;">‚úàÔ∏è ${totalMiles.toLocaleString()} Âì©</div>`;
        } else if (totalMiles > 0) {
            rewardHtml = `${totalMiles.toLocaleString()} Âì©`;
        } else {
            rewardHtml = `$${totalCash.toLocaleString()}`;
        }
currentLocation = savedLocation;
        document.getElementById('totalRewardDisplay').innerHTML = rewardHtml;
        
        const breakdownEl = document.getElementById('totalRewardBreakdown');
        if (breakdownEl) breakdownEl.style.display = 'none';
    }

    function updateDateDisplay() {
        const dateStr = new Date().toLocaleDateString('zh-TW', { month: 'long', day: 'numeric', weekday: 'short' });
        document.getElementById('dateDisplay').innerText = dateStr;
    }

    function checkUrgentAlerts() {
        document.getElementById('urgent-alert-area').style.display = 'none';
    }

    function openManageModal() {
        renderManageList();
        renderScenes();
        document.getElementById('manageModal').style.display = 'flex';
        history.pushState({ modal: true }, '');
    }

    function renderManageList() {
        const container = document.getElementById('manageCardList');
        container.innerHTML = '';
        
        cards.forEach(card => {
            if (card.id === 'add1') return;
            
            const isActive = visibleCards.includes(card.id);
            const nickname = cardSettings[card.id]?.nickname || '';
            
            const btn = document.createElement('div');
            btn.className = 'manage-card-btn' + (isActive ? ' active' : '');
            btn.setAttribute('data-card-id', card.id);
            
            const settingHtml = `<div class="m-setting-btn" onclick="event.stopPropagation(); ${card.isCustom ? `openCustomCardModal('${card.id}')` : `openCardSetting('${card.id}')`}">‚öôÔ∏è</div>`;
            
            btn.innerHTML = `
                <div class="m-check-mark">‚úì</div>
                <div class="m-card-name">${card.isCustom ? '‚≠ê ' : ''}${card.name}</div>
                <div class="m-card-nick">${nickname || card.nickname || ''}</div>
                ${settingHtml}
            `;
            
            btn.onclick = (e) => {
                if (e.target.closest('.m-setting-btn')) return;
                toggleCardVisibility(card.id);
            };
            
            container.appendChild(btn);
        });

        // Êõ¥Êñ∞Ëá™Âª∫Âç°Êï∏Èáè
        const customs = JSON.parse(localStorage.getItem('custom_cards') || '[]');
        const countEl = document.getElementById('customCardCount');
        if (countEl) countEl.innerText = customs.length;
        const addBtn = document.getElementById('btnAddCustomCard');
       if (addBtn) addBtn.style.display = customs.length >= 5 ? 'none' : '';
    }

    function toggleCardVisibility(cardId) {
        const realCardIds = cards.map(c => c.id).filter(id => id !== 'add1');
        let currentReal = visibleCards.filter(id => realCardIds.includes(id));
        
        if (currentReal.includes(cardId)) {
            currentReal = currentReal.filter(id => id !== cardId);
        } else {
            if (currentReal.length >= 8) {
                alert('ÊúÄÂ§öÂè™ËÉΩÈ°ØÁ§∫ 8 ÂºµÂç°Áâá');
                return;
            }
            currentReal.push(cardId);
        }
        
        visibleCards = currentReal.length < 8 ? [...currentReal, 'add1'] : currentReal;
        localStorage.setItem('visibleCards', JSON.stringify(visibleCards));
        renderManageList();
        renderGrid();
    }

    // Êñ∞ÁâàÂç°ÁâáË®≠ÂÆöÂΩàÁ™ó
    function openCardSetting(cardId) {
        const card = cards.find(c => c.id === cardId);
        if (!card) return;
        
        document.getElementById('settingsModalTitle').innerText = `${card.name} Ë®≠ÂÆö`;
        document.getElementById('settingCardId').value = cardId;
        
        // ËºâÂÖ•Êö±Á®±
        const nickname = cardSettings[cardId]?.nickname || '';
        document.getElementById('settingNicknameInput').value = nickname;
        
        // ËºâÂÖ•ÁµêÂ∏≥Êó•
        const cycleDay = cardSettings[cardId]?.cycleDay || '';
        document.getElementById('settingCycleDayInput').value = cycleDay;
        
        // ÂãïÊÖãÊèíÂÖ•Âç°Èù¢ÁÖßÁâáÂäüËÉΩ
        let photoSection = document.getElementById('cardPhotoSection');
        if (!photoSection) {
            photoSection = document.createElement('div');
            photoSection.id = 'cardPhotoSection';
            photoSection.className = 'input-group';
            photoSection.innerHTML = `
                <label>üñºÔ∏è Âç°Èù¢ÁÖßÁâá</label>
                <div style="display:flex; gap:8px; align-items:center;">
                    <button class="btn" style="flex:1; background:#f0f8ff; color:#007AFF; border:1px dashed #007AFF; font-size:13px; padding:10px;" onclick="document.getElementById('cardPhotoFileInput').click()">üì∑ ÈÅ∏ÊìáÁÖßÁâá</button>
                    <button id="btnRemovePhoto" class="btn" style="background:#fff0f0; color:#FF3B30; border:1px solid #ffcdd2; font-size:13px; padding:10px; display:none;" onclick="removeCardPhoto()">ÁßªÈô§</button>
                </div>
                <input type="file" id="cardPhotoFileInput" accept="image/*" style="display:none" onchange="handleCardPhoto(event)">
                <div id="photoPreviewBox" style="margin-top:8px; display:none; width:100%; height:120px; border-radius:12px; overflow:hidden;">
                    <img id="photoPreviewImg" style="width:100%; height:100%; object-fit:cover;">
                </div>
               
                <div style="font-size:11px; color:#888; margin-top:4px;">ÁÖßÁâáÊúÉË£ÅÂàáÊàêÂç°ÁâáÊØî‰æãÔºåË¶ÜËìãÂéüÊú¨Êº∏Â±§ËÉåÊôØ„ÄÇ</div>
            `;
            const btnGroup = document.querySelector('#cardSettingsModal .btn-group');
            btnGroup.parentNode.insertBefore(photoSection, btnGroup);
        }
        // ËºâÂÖ•Â∑≤Â≠òÁÖßÁâá
        const existingPhoto = localStorage.getItem('card_photo_' + cardId);
        window._pendingCardPhoto = null;
        document.getElementById('cardPhotoFileInput').value = '';
        if (existingPhoto) {
            document.getElementById('photoPreviewImg').src = existingPhoto;
            document.getElementById('photoPreviewBox').style.display = 'block';
            document.getElementById('btnRemovePhoto').style.display = 'inline-block';
            
        } else {
            document.getElementById('photoPreviewBox').style.display = 'none';
            document.getElementById('btnRemovePhoto').style.display = 'none';
            
        }
        var savedAlign = localStorage.getItem('card_photo_align_' + cardId) || 'center';
        
        

        document.getElementById('cardSettingsModal').style.display = 'flex';
    }
function handleCardPhoto(event) {
        var file = event.target.files[0];
        if (!file) return;
        var reader = new FileReader();
        reader.onload = function(e) {
            var img = new Image();
            img.onload = function() {
                var maxW = 400, maxH = 400;
                var scale = Math.min(maxW / img.width, maxH / img.height, 1);
                var canvas = document.createElement('canvas');
                canvas.width = Math.round(img.width * scale);
                canvas.height = Math.round(img.height * scale);
                var ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                var dataUrl = canvas.toDataURL('image/jpeg', 0.7);
                document.getElementById('photoPreviewImg').src = dataUrl;
                document.getElementById('photoPreviewBox').style.display = 'block';
                document.getElementById('btnRemovePhoto').style.display = 'inline-block';
                window._pendingCardPhoto = dataUrl;
                
                
                
            };
            img.src = e.target.result;
        };
        reader.readAsDataURL(file);
    }

    function removeCardPhoto() {
        var cardId = document.getElementById('settingCardId').value;
        window._pendingCardPhoto = '__remove__';
        
        document.getElementById('photoPreviewBox').style.display = 'none';
        document.getElementById('btnRemovePhoto').style.display = 'none';
        
        document.getElementById('cardPhotoFileInput').value = '';
    }

    function handleCustomCardPhoto(event) {
        var file = event.target.files[0];
        if (!file) return;
        var reader = new FileReader();
        reader.onload = function(e) {
            var img = new Image();
            img.onload = function() {
                var maxW = 400, maxH = 400;
                var scale = Math.min(maxW / img.width, maxH / img.height, 1);
                var canvas = document.createElement('canvas');
                canvas.width = Math.round(img.width * scale);
                canvas.height = Math.round(img.height * scale);
                var ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                var dataUrl = canvas.toDataURL('image/jpeg', 0.7);
                document.getElementById('customPhotoPreviewImg').src = dataUrl;
                document.getElementById('customPhotoPreviewBox').style.display = 'block';
                document.getElementById('btnRemoveCustomPhoto').style.display = 'inline-block';
                window._pendingCustomCardPhoto = dataUrl;
            };
            img.src = e.target.result;
        };
        reader.readAsDataURL(file);
    }

    function removeCustomCardPhoto() {
        window._pendingCustomCardPhoto = '__remove__';
        document.getElementById('customPhotoPreviewBox').style.display = 'none';
        document.getElementById('btnRemoveCustomPhoto').style.display = 'none';
        document.getElementById('customCardPhotoInput').value = '';
    }

   
    function saveCardSetting() {
        const cardId = document.getElementById('settingCardId').value;
        const newNickname = document.getElementById('settingNicknameInput').value.trim();
        const newCycleDay = document.getElementById('settingCycleDayInput').value;
        
        if (!cardSettings[cardId]) cardSettings[cardId] = {};
        
        cardSettings[cardId].nickname = newNickname;
        cardSettings[cardId].cycleDay = newCycleDay;
        
      if (window._pendingCardPhoto === '__remove__') {
            localStorage.removeItem('card_photo_' + cardId);
            
        } else if (window._pendingCardPhoto) {
            localStorage.setItem('card_photo_' + cardId, window._pendingCardPhoto);
        }
        
        window._pendingCardPhoto = null;
       
        localStorage.setItem('cardSettings', JSON.stringify(cardSettings));
        
        document.getElementById('cardSettingsModal').style.display = 'none';
        
        // ÈáçÊñ∞Ê∏≤ÊüìÁï´Èù¢‰ª•Â•óÁî®Êñ∞Ë®≠ÂÆö
        renderManageList();
        renderGrid();
    }

    function filterManageCards() {
        const keyword = document.getElementById('cardSearchInput').value.trim().toLowerCase();
        const clearBtn = document.getElementById('btnSearchClear');
        clearBtn.style.display = keyword ? 'flex' : 'none';
        
        document.querySelectorAll('.manage-card-btn').forEach(btn => {
            const cardId = btn.getAttribute('data-card-id');
            const card = cards.find(c => c.id === cardId);
            if (!card) return;
            
            const searchText = (card.name + ' ' + card.nickname + ' ' + (card.note || '')).toLowerCase();
            btn.style.display = (!keyword || searchText.includes(keyword)) ? 'flex' : 'none';
        });
    }

    function clearCardSearch() {
        document.getElementById('cardSearchInput').value = '';
        document.getElementById('btnSearchClear').style.display = 'none';
        filterManageCards();
    }

    // ÂåØÂá∫Ë≥áÊñô (‰øÆÂæ©ÔºöÁ¢∫‰øù cardId Ê¨Ñ‰ΩçÂ≠òÂú®)
    function exportData() {
        const data = {
            version: 'V126.4',
            exportTime: new Date().toISOString(),
            visibleCards: visibleCards,
            cardOrder: savedOrder,
            cardSettings: cardSettings,
            transactions: {},
            settings: {
                current_location: currentLocation,
                exchange_rates: exchangeRates,
                uni_settings: localStorage.getItem('uni_settings'),
                happy_used: localStorage.getItem('happy_used'),
                hsbc_tier: localStorage.getItem('hsbc_tier'),
                hsbc_initial: localStorage.getItem('hsbc_initial'),
                hsbc_redeemed: localStorage.getItem('hsbc_redeemed'),
                currency_level: localStorage.getItem('currency_level'),
                scene_snapshots: localStorage.getItem('scene_snapshots')
            }
        };
        
        // ÂåØÂá∫ÊâÄÊúâÂç°ÁâáÁöÑ‰∫§ÊòìÁ¥ÄÈåÑ
        cards.forEach(card => {
            const txs = getTransactions(card.id);
            if (txs.length > 0) {
                // Á¢∫‰øùÊØèÁ≠Ü‰∫§ÊòìÈÉΩÊúâ cardId Ê¨Ñ‰Ωç
                data.transactions[card.id] = txs.map(tx => ({
                    ...tx,
                    cardId: card.id
                }));
            }
        });
        
        // ÂåØÂá∫ UniOpen ÂêÑÈÄ±ÊúüÁöÑË∏©ÈªûË®òÈåÑ
        data.uniBrandsByPeriod = {};
        for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            if (key && key.startsWith('uni_brands_')) {
                data.uniBrandsByPeriod[key] = localStorage.getItem(key);
            }
        }
        
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
       const now = new Date();
        const dateStr = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')}`;
        a.download = `Âà∑Âç°ÂõûÈ•ãÁÆ°ÂÆ∂_ÂÇô‰ªΩ_${dateStr}.json`;
        a.click();
        URL.revokeObjectURL(url);
    }

    function triggerImport() {
        document.getElementById('fileInput').click();
    }

    // ÂåØÂÖ•Ë≥áÊñô (‰øÆÂæ©ÔºöÊîπÂñÑÂåØÂÖ•ÈÇèËºØÔºåËôïÁêÜ cardId ÈÅ∫Â§±ÂïèÈ°å)
    function importFile(input) {
        const file = input.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const data = JSON.parse(e.target.result);
                
                if (!confirm('Á¢∫ÂÆöË¶ÅÂåØÂÖ•ÂÇô‰ªΩÊ™îÔºüÈÄôÊúÉË¶ÜËìãÁõÆÂâçÁöÑË≥áÊñô„ÄÇ')) {
                    input.value = '';
                    return;
                }
                
                // ÂåØÂÖ•Âü∫Êú¨Ë®≠ÂÆö
                if (data.visibleCards) {
                    localStorage.setItem('visibleCards', JSON.stringify(data.visibleCards));
                }
                if (data.cardOrder) {
                    localStorage.setItem('cardOrder', JSON.stringify(data.cardOrder));
                }
               if (data.cardSettings) {
                    // Áõ∏ÂÆπËàäÁâà billingDay ‚Üí cycleDay
                    const newSettings = {};
                    Object.keys(data.cardSettings).forEach(cardId => {
                        const old = data.cardSettings[cardId];
                        newSettings[cardId] = {
                            nickname: old.nickname || '',
                            cycleDay: old.cycleDay || old.billingDay || ''
                        };
                    });
                    localStorage.setItem('cardSettings', JSON.stringify(newSettings));
                }
                // ÂåØÂÖ•‰∫§ÊòìÁ¥ÄÈåÑ (‰øÆÂæ©Áâà)
                if (data.transactions) {
                    // ÊÉÖÊ≥Å AÔºöÊñ∞Ê†ºÂºè (Áâ©‰ª∂Ôºåkey ÁÇ∫ cardId)
                    if (typeof data.transactions === 'object' && !Array.isArray(data.transactions)) {
                        Object.keys(data.transactions).forEach(cardId => {
                            const txs = data.transactions[cardId];
                            if (Array.isArray(txs)) {
                                const normalizedTxs = txs.map(tx => normalizeTx(tx, cardId));
                                saveTransactions(cardId, normalizedTxs);
                            }
                        });
                    }
                    // ÊÉÖÊ≥Å BÔºöËàäÊ†ºÂºè (Èô£ÂàóÔºå‰æùË≥¥ tx.cardId)
                    else if (Array.isArray(data.transactions)) {
                        const txsByCard = {};
                        data.transactions.forEach(tx => {
                            const cardId = tx.cardId;
                            if (!cardId) {
                                console.warn('Ë∑≥ÈÅéÁÑ° cardId ÁöÑ‰∫§Êòì:', tx);
                                return;
                            }
                            if (!txsByCard[cardId]) txsByCard[cardId] = [];
                            txsByCard[cardId].push(normalizeTx(tx, cardId));
                        });
                        Object.keys(txsByCard).forEach(cardId => {
                            saveTransactions(cardId, txsByCard[cardId]);
                        });
                    }
                }
                
                // ÂåØÂÖ•Ë®≠ÂÆö
                if (data.settings) {
                    const s = data.settings;
                    if (s.current_location) localStorage.setItem('current_location', s.current_location);
                    if (s.exchange_rates) localStorage.setItem('exchange_rates', JSON.stringify(s.exchange_rates));
                    if (s.uni_settings) localStorage.setItem('uni_settings', s.uni_settings);
                    if (s.happy_used) localStorage.setItem('happy_used', s.happy_used);
                    if (s.hsbc_tier) localStorage.setItem('hsbc_tier', s.hsbc_tier);
                    if (s.hsbc_initial) localStorage.setItem('hsbc_initial', s.hsbc_initial);
                    if (s.hsbc_redeemed) localStorage.setItem('hsbc_redeemed', s.hsbc_redeemed);
                    if (s.currency_level) localStorage.setItem('currency_level', s.currency_level);
                    if (s.scene_snapshots) localStorage.setItem('scene_snapshots', s.scene_snapshots);
                }
                
                // ÂåØÂÖ• UniOpen Ë∏©ÈªûË®òÈåÑ (ÊåâÈÄ±Êúü)
                if (data.uniBrandsByPeriod) {
                    Object.keys(data.uniBrandsByPeriod).forEach(key => {
                        localStorage.setItem(key, data.uniBrandsByPeriod[key]);
                    });
                }
                // Áõ∏ÂÆπËàäÁâà uni_brands (ÁÑ°ÈÄ±Êúü)
                if (data.settings && data.settings.uni_brands && !data.uniBrandsByPeriod) {
                    const cycleKey = getUniBrandCycleKey();
                    localStorage.setItem(cycleKey, data.settings.uni_brands);
                }
                // ========== Áõ∏ÂÆπËàäÊ†ºÂºèÔºàË®≠ÂÆöÂú®Ê†πÂ±§Á¥öÔºâ==========
                // currentLocation
                if (!data.settings && data.currentLocation) {
                    localStorage.setItem('current_location', data.currentLocation);
                }
                // currencyLevel
                if (!data.settings && data.currencyLevel) {
                    localStorage.setItem('currency_level', data.currencyLevel);
                }
                // hsbcTier / hsbcInitial / hsbcRedeemed
                if (!data.settings && data.hsbcTier) {
                    localStorage.setItem('hsbc_tier', data.hsbcTier);
                }
                if (!data.settings && data.hsbcInitial) {
                    localStorage.setItem('hsbc_initial', data.hsbcInitial);
                }
                if (!data.settings && data.hsbcRedeemed) {
                    localStorage.setItem('hsbc_redeemed', data.hsbcRedeemed);
                }
                // sceneSnapshots
                if (!data.settings && data.sceneSnapshots) {
                    localStorage.setItem('scene_snapshots', JSON.stringify(data.sceneSnapshots));
                }
                // uniOpenState
                if (!data.settings && data.uniOpenState) {
                    if (data.uniOpenState.brands) {
                        const cycleKey = getUniBrandCycleKey();
                        localStorage.setItem(cycleKey, JSON.stringify(data.uniOpenState.brands));
                    }
                }
                alert('ÂåØÂÖ•ÊàêÂäüÔºÅÈ†ÅÈù¢Â∞áÈáçÊñ∞ËºâÂÖ•„ÄÇ');
                location.reload();
                
            } catch (err) {
                console.error('Import error:', err);
                alert('ÂåØÂÖ•Â§±ÊïóÔºö' + err.message);
            }
        };
        reader.readAsText(file);
        input.value = '';
    }

    // Ê≠£Ë¶èÂåñ‰∫§ÊòìË≥áÊñô (‰øÆÂæ©ÔºöÁ¢∫‰øù cardId Â≠òÂú®)
    function normalizeTx(tx, fallbackCardId) {
        const normalized = { ...tx };
        
        // Á¢∫‰øù cardId Â≠òÂú®
        if (!normalized.cardId && fallbackCardId) {
            normalized.cardId = fallbackCardId;
        }
        
        if (!normalized.id) normalized.id = Date.now() + Math.random();
        if (!normalized.amountTWD && normalized.amount) normalized.amountTWD = normalized.amount;
        if (!normalized.location && normalized.loc) normalized.location = normalized.loc;
        if (!normalized.location) normalized.location = 'TW';
        if (!normalized.currency) normalized.currency = 'TWD';
        
        if (normalized.date) {
            const d = parseFlexibleDate(normalized.date);
            if (d) normalized.date = d.toISOString().split('T')[0];
        }
        
        return normalized;
    }

    function resetAllData() {
        if (!confirm('‚ö†Ô∏è Á¢∫ÂÆöË¶ÅÈáçÁΩÆÊâÄÊúâË≥áÊñôÔºü\n\nÈÄôÂ∞áÊ∏ÖÈô§Ôºö\n‚Ä¢ ÊâÄÊúâÊ∂àË≤ªË®òÈåÑ\n‚Ä¢ Âç°ÁâáË®≠ÂÆö\n‚Ä¢ ÊÉÖÂ¢ÉÂø´ÁÖß\n\nÊ≠§Êìç‰ΩúÁÑ°Ê≥ïÂæ©ÂéüÔºÅ')) return;
        if (!confirm('ÂÜçÊ¨°Á¢∫Ë™çÔºöÁúüÁöÑË¶ÅÂà™Èô§ÊâÄÊúâË≥áÊñôÂóéÔºü')) return;
        
        const keysToRemove = [];
        for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            if (key && (
                key.startsWith('transactions_') || 
                key.startsWith('uni_brands_') ||
                ['visibleCards', 'cardOrder', 'cardSettings', 'user_setup_done', 'scene_snapshots',
                 'uni_settings', 'happy_used', 'hsbc_tier', 'hsbc_initial', 'hsbc_redeemed',
                 'currency_level', 'uni_brands', 'current_location', 'exchange_rates', 'last_rate_update'].includes(key)
            )) {
                keysToRemove.push(key);
            }
        }
        keysToRemove.forEach(key => localStorage.removeItem(key));
        
        alert('Ë≥áÊñôÂ∑≤ÈáçÁΩÆÔºÅ');
        location.reload();
    }

    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('sw.js').catch(() => {});
        });
    }
</script>
</body>
</html>
