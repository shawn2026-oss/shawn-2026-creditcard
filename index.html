<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="å›é¥‹ç®¡å®¶">
    <title>å›é¥‹ç®¡å®¶</title>
    
    <link rel="apple-touch-icon" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAALQAAAC0CAMAAAAKE/YAAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAAAhFBMVEUAAAAAAAD///8AAAD///8AAAD///8AAAD///8AAAD///8AAAD///8AAAD///8AAAD///8AAAD///8AAAD///8AAAD///8AAAD///8AAAD///8AAAD///8AAAD///8AAAD///8AAAD///8AAAD///8AAAD///8AAAD///8AAAD///8AAAD///+0633YAAAAHXRSTlMAAgQGCAoMDhASFBcYGhweICIjJScoKiwtLzAxM3/87uoAAAABYktHRACIBR1IAAAAB3RJTUUH6AEUBRYwz0680AAAAMFJREFUeNrt2LENwkAQBdF/7010QAUUQAO0QAM0QAs0QCtoABqBBqABKBA6IAQkFnKE5C1v9rQz693O/q051y+N9W1jL815fG3sw5p7/djYxzXvDWP7ufXlY2M719429m3N/XhvbL9b3z+2360fH9vv1k+P7Xfr58f2u/XLJ/2w5l4/NvbSnMfXxj6suX9r7Meae/3Y2Esz/7f2Yc39W2M/1tzrx8ZemvP42tiHNfdvjf1Yc68fG3tpzuNrYx/W3L819mPNvX5s7KWZ/1v7sOb+rbEfa+71Y2MvzXl8bezDmvu3xn6suX9r7Meae/3Y2Esz/7f2Yc39W2M/1tzrx8ZemvP42tiHNfdvjf1Yc68fG3tpzuNrYx/W3L819mPNvX5s7KWZ/1v7sOb+rbEfa+71Y2MvzXl8bezDmvu3xn6suX9r7Meae/3Y2Esz/7f2Yc39W2M/1tzrx8ZemvP42tiHNfdvjf1Yc68fG3tpzuNrYx/W3L819mPNvX5s7KWZ/1v7sOb+rbEfa+71Y2MvzXl8bezDmvu3xn6suX9r7Meae/3Y2Esz/7f2Yc39W2M/1tzrx8ZemvP42tiHNfdvjf1Yc68fG3tpzuNrYx/W3L819mPNvX5s7KWZ/1v7sOb+rbEfa+71Y2MvzXl8bezDmvu3xn6suX9r7Meae/3Y2Esz/7f2Yc39W2M/1tzrx8ZemvP42tiHNfdvjf1Yc68fG3tpzuNrYx/W3L819mPNvX5s7KWZ/1v7sOb+rbEfa+71Y2MvzXl8bezDmvu3xn6suX9r7Meae/3Y2Esz/7f2Yc39W2M/1tzrx8ZemvP42tiHNfdvjf1Yc68fG3tpzuNrYx/W3L819mPNvX5s7KWZ/1v7sOb+rbEfa+71Y2MvzXl8bezDmvu3xn6suX9r7Meae/3Y2Esz/7f2Yc39W2M/1tzrx8ZemvP42tiHNfdvjf1Yc68fG3tpzuNrYx/W3L819mPN/f/H/gC58y7t+e1+sAAAAABJRU5ErkJggg==">

    <style>
        :root {
            --bg-color: #F0F2F5;
            --text-primary: #1C1C1E;
            --text-secondary: #8E8E93;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", Arial, sans-serif;
            background-color: #E0E5EC; 
            color: var(--text-primary);
            margin: 0;
            display: flex;
            justify-content: center;
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
        }

        .app-container {
            width: 100%;
            max-width: 480px;
            background-color: var(--bg-color);
            min-height: 100vh;
            padding: 24px 20px;
            padding-bottom: 120px;
            box-shadow: 0 0 40px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
            box-sizing: border-box;
        }

        @media (max-width: 480px) {
            body { background-color: var(--bg-color); display: block; }
            .app-container { box-shadow: none; padding: 16px; width: 100%; max-width: 100%; }
        }

        .author-top {
            font-size: 14px; font-weight: 800; color: #007AFF; margin-bottom: 8px; letter-spacing: 0.5px;
        }

        .header-section { margin-bottom: 20px; }
        h1 { font-size: 28px; font-weight: 800; margin: 0; color: #333; letter-spacing: -0.5px; line-height: 1.2;}
        .subtitle { font-size: 13px; color: var(--text-secondary); font-weight: 500; margin-top: 4px; display: flex; justify-content: space-between; align-items: center; }
        
        .today-date {
            background: rgba(0,0,0,0.05); padding: 4px 8px; border-radius: 6px; font-size: 12px; font-weight: 600; color: #555;
        }

        /* ç·Šæ€¥è­¦å ± */
        #urgent-alert-area { display: none; margin-bottom: 20px; }
        .urgent-card {
            background: linear-gradient(135deg, #FF3B30, #FF2D55);
            color: white; border-radius: 20px; padding: 16px;
            box-shadow: 0 8px 20px rgba(255, 59, 48, 0.3);
            animation: pulse 2s infinite;
        }
        .urgent-title { font-size: 15px; font-weight: 800; display: flex; align-items: center; gap: 6px; margin-bottom: 8px;}
        .urgent-item { 
            background: rgba(255,255,255,0.2); border-radius: 12px; padding: 10px; margin-top: 8px;
            font-size: 13px; font-weight: 600; line-height: 1.4;
        }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.02); } 100% { transform: scale(1); } }

        /* ç¸½å›é¥‹é‡‘ */
        .total-reward-card {
            background: #2c3e50; color: white; border-radius: 24px; padding: 20px 24px; margin-bottom: 24px;
            box-shadow: 0 10px 30px rgba(44, 62, 80, 0.3); display: flex; justify-content: space-between; align-items: center;
            position: relative; overflow: hidden;
        }
        .total-reward-card::after {
            content: ''; position: absolute; top: -50%; right: -50%; width: 200px; height: 200px;
            background: rgba(255,255,255,0.1); border-radius: 50%; pointer-events: none;
        }
        .total-reward-label { font-size: 14px; font-weight: 600; opacity: 0.8; }
        .total-reward-amount { font-size: 34px; font-weight: 700; letter-spacing: -0.5px; }

        /* Grid */
        #card-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 30px; }

        .card-tile {
            border-radius: 24px; padding: 16px; min-height: 190px;
            display: flex; flex-direction: column; justify-content: space-between;
            box-shadow: 0 8px 20px rgba(0,0,0,0.15); position: relative;
            transition: transform 0.1s; cursor: pointer; color: white; overflow: hidden;
        }
        .card-tile:active { transform: scale(0.96); }

        .tile-header { display: flex; justify-content: space-between; align-items: flex-start; z-index: 2; margin-bottom: 4px;}
        .tile-name { font-size: 15px; font-weight: 700; line-height: 1.3; text-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .tile-note {
            font-size: 10.5px; font-weight: 500; opacity: 0.95; margin-bottom: 8px; display: block;
            line-height: 1.3; white-space: normal; z-index: 2; letter-spacing: -0.3px;
        }
        .rate-badge {
            background: rgba(255,255,255,0.25); font-size: 11px; font-weight: 800;
            padding: 2px 6px; border-radius: 6px; white-space: nowrap; backdrop-filter: blur(4px); margin-left: 4px; flex-shrink: 0;
        }
        .tile-body { z-index: 2; flex:1; display:flex; flex-direction:column; justify-content:center; }
        .tile-stat { font-size: 24px; font-weight: 700; letter-spacing: -0.5px; margin-bottom: 4px;}
        .tile-earned { font-size: 13px; font-weight: 600; color: rgba(255,255,255,0.9); display: flex; align-items: center; gap: 4px;}
        .tile-earned::before { content: 'è³º'; font-size: 10px; opacity: 0.7; border: 1px solid rgba(255,255,255,0.6); padding: 0 3px; border-radius: 4px;}
        
        .tile-footer { z-index: 2; margin-top: 10px; position: relative; }
        .progress-track { background: rgba(0,0,0,0.15); height: 6px; border-radius: 3px; overflow: hidden; margin-bottom: 6px; }
        .progress-fill { height: 100%; background: rgba(255,255,255,0.95); transition: width 0.5s ease; }
        .tile-msg { font-size: 13px; font-weight: 700; opacity: 0.98; white-space: normal; line-height: 1.3; }

        /* History */
        .history-section { margin-top: 10px; flex: 1; }
        .history-title { font-size: 16px; font-weight: 700; margin-bottom: 12px; color: #3a3a3c; }
        .history-list { background: white; border-radius: 20px; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.03); }
        .history-item { padding: 16px; border-bottom: 1px solid #f0f0f0; display: flex; justify-content: space-between; align-items: center; font-size: 14px;}
        .history-item:last-child { border-bottom: none; }
        .h-name { font-weight: 600; color: #333; }
        .h-date { font-size: 11px; color: #999; margin-top: 2px;}
        .h-amount { font-weight: 700; color: #333; }
        .btn-delete-single { background: none; border: none; color: #ccc; font-size: 16px; padding: 5px; cursor: pointer; }
        .btn-delete-single:hover { color: #FF3B30; }

        /* æŒ‰éˆ•ç¾¤çµ„ */
        .settings-area { margin-top: 30px; display: flex; gap: 10px; flex-direction: column; }
        .settings-row { display: flex; gap: 10px; }
        .btn-tool {
            flex: 1; padding: 12px; border-radius: 12px; font-size: 13px; font-weight: 600;
            border: 1px solid #ddd; background: white; color: #555; cursor: pointer;
            display: flex; align-items: center; justify-content: center; gap: 5px;
        }
        .btn-tool:active { background: #f5f5f5; }
        .btn-reset-visible {
            width: 100%; padding: 14px; background-color: #fff0f0; 
            border: 1px solid #ffcccc; color: #FF3B30; border-radius: 16px; font-weight: 600; font-size: 14px; cursor: pointer;
        }

        /* Footer & Version */
        .footer { text-align: center; font-size: 12px; color: #aaa; margin-top: 30px; font-weight: 500; line-height: 1.5; }
        .version-tag { font-size: 10px; opacity: 0.6; }

        /* Modal */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); backdrop-filter: blur(5px); z-index: 1000; align-items: center; justify-content: center; }
        .modal-content { background: white; width: 85%; max-width: 320px; border-radius: 24px; padding: 24px; box-shadow: 0 25px 50px rgba(0,0,0,0.25); animation: modalPop 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes modalPop { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        
        .input-group label { display: block; font-size: 13px; font-weight: 600; color: #8E8E93; margin-bottom: 8px; margin-top: 12px; }
        input, select { width: 100%; padding: 12px; border: 2px solid #f2f2f7; background: #fff; border-radius: 14px; font-size: 18px; box-sizing: border-box; outline: none; font-weight: 600; color: #333; }
        input:focus { border-color: #007AFF; }
        .btn-group { display: flex; gap: 10px; margin-top: 24px; }
        .btn { flex: 1; padding: 12px; border: none; border-radius: 14px; font-size: 16px; font-weight: 600; cursor: pointer; }
        .btn-cancel { background: #f2f2f7; color: #333; }
        .btn-confirm { background: #007AFF; color: white; }
    </style>
</head>
<body>

    <div class="app-container">

        <div class="author-top">Designed by Shawn</div>

        <div class="header-section">
            <h1>å›é¥‹ç®¡å®¶</h1>
            <div class="subtitle">
                æ¶ˆè²»é€²åº¦èˆ‡å›é¥‹è¿½è¹¤
                <span class="today-date" id="dateDisplay"></span>
            </div>
        </div>

        <div id="urgent-alert-area">
            <div class="urgent-card">
                <div class="urgent-title">ğŸš¨ ä»»å‹™åˆ°æœŸè­¦å ± (å‰© 3 å¤©)</div>
                <div id="urgent-list"></div>
            </div>
        </div>

        <div class="total-reward-card">
            <span class="total-reward-label">æœ¬æœˆé ä¼°ç¸½å›é¥‹</span>
            <span class="total-reward-amount" id="totalRewardDisplay">$0</span>
        </div>
        
        <div id="card-grid"></div>

        <div class="history-section">
            <div class="history-title">æœ€è¿‘æ¶ˆè²»</div>
            <div id="history-list" class="history-list"></div>
        </div>
        
        <div class="settings-area">
            <div class="settings-row">
                <button class="btn-tool" onclick="exportData()">ğŸ“¤ å‚™ä»½è³‡æ–™</button>
                <button class="btn-tool" onclick="importData()">ğŸ“¥ é‚„åŸè³‡æ–™</button>
            </div>
            <button class="btn-reset-visible" onclick="resetAllData()">ğŸ—‘ï¸ æ¸…é™¤æ‰€æœ‰è³‡æ–™ (é‡ç½®)</button>
        </div>

        <div class="footer">
            Designed by Shawn<br>
            <span class="version-tag">Ver 2026.01.04 20:10 (iOS Icon Fixed)</span>
        </div>

    </div>

    <div id="transactionModal" class="modal">
        <div class="modal-content">
            <h2 id="modalTitle" style="margin: 0 0 5px 0; font-size: 20px; font-weight: 800; color:#333;"></h2>
            <div style="font-size:13px; color:#888; margin-bottom:10px; font-weight: 500;" id="modalSubtitle"></div>
            <div id="modalParkingInfo" class="modal-parking-info"></div>
            <input type="hidden" id="cardIdInput"> 
            <div class="input-group" style="margin-top:0;">
                <input type="number" id="amountInput" placeholder="$ è¼¸å…¥é‡‘é¡" inputmode="numeric" style="font-size: 32px; text-align: center; color: #007AFF; border:none; border-bottom: 2px solid #eee; border-radius:0;">
            </div>
            <div class="input-group">
                <input type="text" id="noteInput" placeholder="å‚™è¨» (ä¾‹å¦‚: åˆé¤)" style="font-size:16px; font-weight:400;">
            </div>
            <div class="btn-group">
                <button class="btn btn-cancel" onclick="closeModal()">å–æ¶ˆ</button>
                <button class="btn btn-confirm" onclick="addTransaction()">ç¢ºèª</button>
            </div>
        </div>
    </div>

<script>
    // --- å¡ç‰‡è¨­å®š ---
    const cards = [
        {
            id: 'c1',
            name: 'æ˜Ÿå±•å‚³èªªå°æ±º', 
            note: 'LinePay / è¦çš® / Uber Eats (10%)',
            type: 'ceiling', 
            limit: 11363,
            tier1Rate: 0.10, tier2Rate: 0.012, 
            gradient: 'linear-gradient(135deg, #FF416C 0%, #FF4B2B 100%)',
            textColor: 'white',
            msgDanger: 'ğŸš¨ å·²æ»¿ (é™ç‚º 1.2%)'
        },
        {
            id: 'c2',
            name: 'è¯é‚¦ç¶ å¡',
            note: 'åœ‹å¤– 2% / åœ‹å…§ 1%',
            type: 'floor', 
            target: 12000, 
            tier1Rate: 0.02, tier2Rate: 0.02, 
            gradient: 'linear-gradient(135deg, #11998e 0%, #38ef7d 100%)',
            textColor: 'white',
            msgSuccess: 'âœ… å·²é”æ¨™ï¼ä¸‹æœˆäº«å…è²»åœè»Š',
            parking: 'ğŸ…¿ï¸ <b>å…è²»åœè»Šå ´ï¼š</b><br>å°ç£è¯é€šã€è©®ç‡Ÿã€ViVi PARKã€å˜Ÿå˜Ÿæˆ¿ã€è»Šéº»å‰<br>ï¼ˆæ¯æ—¥1æ¬¡ / æ¯æœˆ5æ¬¡ / æ¯æ¬¡2å°æ™‚ï¼‰',
            billingDay: 3
        },
        {
            id: 'c3',
            name: 'æ°¸è± Sport',
            note: 'Apple Pay (5%)',
            type: 'ceiling', 
            limit: 5000,     
            tier1Rate: 0.05, tier2Rate: 0.02, 
            gradient: 'linear-gradient(135deg, #00B4DB 0%, #0083B0 100%)',
            textColor: 'white',
            msgDanger: 'ğŸš¨ 5% å·²æ»¿ (é™ç‚º 2%)'
        },
        {
            id: 'c4',
            name: 'å°‡ä¾†å°‡å°‡',
            note: 'LinePay / æ‚ éŠä»˜ (5%)',
            type: 'mixed', 
            limit: 6666, minSpend: 3000, 
            tier1Rate: 0.05, tier2Rate: 0.005, 
            gradient: 'linear-gradient(135deg, #FDC830 0%, #F37335 100%)',
            textColor: '#333',
            msgDanger: 'ğŸš¨ åŠ ç¢¼å·²æ»¿ (å‰©0.5%)'
        }
    ];

    let transactions = JSON.parse(localStorage.getItem('transactions')) || [];

    function updateDate() {
        const now = new Date();
        const str = `${now.getFullYear()}å¹´${now.getMonth()+1}æœˆ${now.getDate()}æ—¥`;
        document.getElementById('dateDisplay').innerText = str;
    }

    function getCardStartDate(card) {
        return new Date(new Date().getFullYear(), new Date().getMonth(), 1); 
    }

    function getCardEndDate(card) {
        return new Date(new Date().getFullYear(), new Date().getMonth() + 1, 0);
    }

    function formatDate(isoString) {
        const d = new Date(isoString);
        return `${d.getMonth()+1}/${d.getDate()}`;
    }

    function calculateStats(cardId) {
        const card = cards.find(c => c.id === cardId);
        const startDate = getCardStartDate(card);
        const relevantTx = transactions.filter(t => {
            return t.cardId === cardId && new Date(t.date) >= startDate;
        });
        const totalSpend = relevantTx.reduce((sum, t) => sum + parseFloat(t.amount), 0);
        let reward = 0;
        let currentRate = 0;

        if (card.type === 'mixed') { 
            if (totalSpend < card.minSpend) {
                reward = totalSpend * card.tier2Rate; 
                currentRate = card.tier2Rate;
            } else if (totalSpend <= card.limit) {
                reward = totalSpend * card.tier1Rate; 
                currentRate = card.tier1Rate;
            } else {
                reward = (card.limit * card.tier1Rate) + ((totalSpend - card.limit) * card.tier2Rate);
                currentRate = card.tier2Rate;
            }
        } else if (card.type === 'ceiling') { 
            if (totalSpend <= card.limit) {
                reward = totalSpend * card.tier1Rate;
                currentRate = card.tier1Rate;
            } else {
                reward = (card.limit * card.tier1Rate) + ((totalSpend - card.limit) * card.tier2Rate);
                currentRate = card.tier2Rate;
            }
        } else { // floor
            reward = totalSpend * card.tier1Rate;
            currentRate = card.tier1Rate;
        }
        return { spend: totalSpend, reward: Math.round(reward), rate: (currentRate * 100).toFixed(1) };
    }

    function checkUrgentTasks() {
        const alertArea = document.getElementById('urgent-alert-area');
        const alertList = document.getElementById('urgent-list');
        alertList.innerHTML = '';
        let hasUrgent = false;

        cards.forEach(card => {
            const stats = calculateStats(card.id);
            let target = 0;
            if (card.type === 'floor') target = card.target;
            if (card.type === 'mixed') target = card.minSpend;

            if (target > 0 && stats.spend < target) {
                const endDate = getCardEndDate(card);
                const today = new Date();
                const diffTime = endDate - today;
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

                if (diffDays <= 3 && diffDays >= 0) {
                    hasUrgent = true;
                    const remaining = target - stats.spend;
                    const dateStr = `${endDate.getMonth()+1}/${endDate.getDate()}`;
                    alertList.innerHTML += `
                        <div class="urgent-item">
                            ${card.name} å°šç¼º $${remaining.toLocaleString()}<br>
                            ğŸ“… çµå¸³æ—¥ï¼š${dateStr} (å‰© ${diffDays} å¤©)
                        </div>
                    `;
                }
            }
        });

        if (hasUrgent) alertArea.style.display = 'block';
        else alertArea.style.display = 'none';
    }

    function renderGrid() {
        const container = document.getElementById('card-grid');
        const totalDisplay = document.getElementById('totalRewardDisplay');
        container.innerHTML = '';
        let monthTotalReward = 0;

        cards.forEach(card => {
            const stats = calculateStats(card.id);
            monthTotalReward += stats.reward;

            let percent = 0;
            let statusText = '';
            let msgStyle = ''; 
            
            if (card.type === 'mixed') { 
                if (stats.spend < card.minSpend) {
                    percent = (stats.spend / card.minSpend) * 100;
                    statusText = `ğŸ”¥ åŠ æ²¹ï¼å·® $${(card.minSpend - stats.spend).toLocaleString()} å‡ç´š 5%`;
                    msgStyle = 'color: #D35400; font-weight: 800;'; 
                } else if (stats.spend <= card.limit) {
                    percent = (stats.spend / card.limit) * 100;
                    const remain = card.limit - stats.spend;
                    statusText = remain < 1000 ? `âš ï¸ å‰© $${remain.toLocaleString()} (å¿«çˆ†äº†)` : `âœ… 5% å•Ÿå‹•ä¸­ (å‰© $${remain.toLocaleString()})`;
                    if(remain < 1000) msgStyle = 'color: #D35400; font-weight: 800;';
                } else {
                    percent = 100; statusText = card.msgDanger;
                    msgStyle = 'background: rgba(255,255,255,0.95); color: #FF3B30; padding: 2px 6px; border-radius: 4px; font-weight: 800; display: inline-block;';
                }
            } else if (card.type === 'ceiling') { 
                percent = (stats.spend / card.limit) * 100;
                if (stats.spend <= card.limit) {
                    const remain = card.limit - stats.spend;
                    statusText = remain < 1000 ? `âš ï¸ å‰© $${remain.toLocaleString()} (å¿«çˆ†äº†)` : `å‰© $${remain.toLocaleString()} (${(card.tier1Rate*100)}%ä¸­)`;
                    if(remain < 1000) msgStyle = 'color: #FFD700; font-weight: 800; text-shadow: 0 1px 2px rgba(0,0,0,0.2);';
                } else {
                    percent = 100; statusText = card.msgDanger;
                    msgStyle = 'background: rgba(255,255,255,0.95); color: #FF3B30; padding: 2px 6px; border-radius: 4px; font-weight: 800; display: inline-block;';
                }
            } else { // floor
                percent = (stats.spend / card.target) * 100;
                statusText = stats.spend >= card.target ? card.msgSuccess : `åŠ æ²¹ï¼å·® $${(card.target - stats.spend).toLocaleString()}`;
            }

            const tile = document.createElement('div');
            tile.className = 'card-tile';
            tile.style.background = card.gradient;
            tile.style.color = card.textColor;
            tile.onclick = () => openQuickAdd(card.id); 
            
            tile.innerHTML = `
                <div class="tile-header">
                    <span class="tile-name">${card.name}</span>
                    <span class="rate-badge" style="color:black">${stats.rate}%</span>
                </div>
                <span class="tile-note" style="color:${card.textColor === 'white' ? 'rgba(255,255,255,0.85)' : 'rgba(0,0,0,0.6)'}">${card.note}</span>
                <div class="tile-body">
                    <div class="tile-stat">$${stats.spend.toLocaleString()}</div>
                    <div class="tile-earned">+$${stats.reward.toLocaleString()}</div>
                </div>
                <div class="tile-footer">
                    <div class="progress-track"><div class="progress-fill" style="width:${Math.min(percent, 100)}%"></div></div>
                    <div class="tile-msg" style="${msgStyle}">${statusText}</div>
                </div>
            `;
            container.appendChild(tile);
        });
        totalDisplay.innerText = `$${monthTotalReward.toLocaleString()}`;
        checkUrgentTasks();
    }

    function openQuickAdd(cardId) {
        const card = cards.find(c => c.id === cardId);
        document.getElementById('modalTitle').innerText = card.name;
        document.getElementById('modalSubtitle').innerText = card.note;
        document.getElementById('cardIdInput').value = cardId;
        const parkingInfoDiv = document.getElementById('modalParkingInfo');
        if (card.parking) { parkingInfoDiv.innerHTML = card.parking; parkingInfoDiv.style.display = 'block'; }
        else { parkingInfoDiv.style.display = 'none'; }
        document.getElementById('transactionModal').style.display = 'flex';
        const input = document.getElementById('amountInput');
        input.value = ''; document.getElementById('noteInput').value = '';
        setTimeout(() => { input.focus(); }, 100);
    }

    function closeModal() { document.getElementById('transactionModal').style.display = 'none'; }

    function addTransaction() {
        const cardId = document.getElementById('cardIdInput').value;
        const amount = document.getElementById('amountInput').value;
        const note = document.getElementById('noteInput').value;
        if (!amount || amount <= 0) return alert('è«‹è¼¸å…¥é‡‘é¡');
        transactions.push({ id: Date.now(), cardId: cardId, amount: parseFloat(amount), note: note, date: new Date().toISOString() });
        localStorage.setItem('transactions', JSON.stringify(transactions));
        closeModal(); renderGrid(); renderHistory();
    }

    function renderHistory() {
        const list = document.getElementById('history-list');
        list.innerHTML = '';
        if (transactions.length === 0) { list.innerHTML = '<div class="empty-state">å°šç„¡æ¶ˆè²»ç´€éŒ„</div>'; return; }
        [...transactions].reverse().forEach((tx, idx) => {
            const realIdx = transactions.length - 1 - idx;
            const card = cards.find(c => c.id === tx.cardId);
            list.innerHTML += `
                <div class="history-item">
                    <div>
                        <div class="h-name">${card ? card.name : 'æœªçŸ¥'} <span style="font-weight:400; color:#888; font-size:12px; margin-left:5px;">${tx.note || ''}</span></div>
                        <div class="h-date">${formatDate(tx.date)}</div>
                    </div>
                    <div style="display:flex; align-items:center;">
                        <span class="h-amount">$${tx.amount.toLocaleString()}</span>
                        <button class="btn-delete-single" onclick="delTx(${realIdx})">âœ•</button>
                    </div>
                </div>`;
        });
    }

    function delTx(index) {
        if(confirm('åˆªé™¤æ­¤ç­†ç´€éŒ„ï¼Ÿ')) {
            transactions.splice(index, 1);
            localStorage.setItem('transactions', JSON.stringify(transactions));
            renderGrid(); renderHistory();
        }
    }

    function resetAllData() {
        if(confirm('âš ï¸ ç¢ºå®šé‡ç½®ï¼Ÿæ¶ˆè²»ç´€éŒ„å°‡æ¸…ç©ºã€‚')) { localStorage.clear(); transactions = []; renderGrid(); renderHistory(); }
    }

    function exportData() {
        const dataStr = JSON.stringify(transactions);
        navigator.clipboard.writeText(dataStr).then(() => { alert('âœ… è³‡æ–™å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼\nè«‹è²¼åˆ°è¨˜äº‹æœ¬ä¿å­˜ã€‚'); });
    }

    function importData() {
        const json = prompt('è«‹è²¼ä¸Šå‚™ä»½çš„ JSON è³‡æ–™ï¼š');
        if (json) {
            try {
                const parsed = JSON.parse(json);
                if (Array.isArray(parsed)) { transactions = parsed; localStorage.setItem('transactions', JSON.stringify(transactions)); renderGrid(); renderHistory(); alert('âœ… è³‡æ–™é‚„åŸæˆåŠŸï¼'); }
            } catch (e) { alert('âŒ ç„¡æ³•è§£æè³‡æ–™'); }
        }
    }

    updateDate(); renderGrid(); renderHistory();
</script>
</body>
</html>