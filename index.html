<div id="manageModal" class="modal" onclick="if(event.target===this) document.getElementById('manageModal').style.display='none'">
        <div class="modal-content" style="max-height:80vh; overflow-y:auto;">
            <h2 style="margin: 0 0 4px 0; font-size: 18px; font-weight: 800; color:#333;">ç®¡ç†æˆ‘çš„å¡ç‰‡</h2>
            <div style="font-size:12px; color:#888; margin-bottom:12px;">é–‹å•Ÿ / éš±è—æ‚¨çš„å¡ç‰‡ (å³æ™‚ç”Ÿæ•ˆ)</div>
            <div id="manageCardList" style="border-top:1px solid #eee;"></div>
            <button class="btn btn-confirm" style="width:100%; margin-top:20px;" onclick="document.getElementById('manageModal').style.display='none'">å®Œæˆ</button>
        </div>
    </div>
  <script>
    // è‡ªå‹•æ³¨å…¥é æ±æ¨‚å®¶+å¡å®Œæ•´é€šè·¯ (é˜²å‘†ä¿éšª)
    function injectHappyDetails() {
        const petDiv = document.getElementById('happyPetDetails');
        if(petDiv && petDiv.innerHTML.trim() === "") {
            petDiv.innerHTML = `
                <b>(1) æŒ‡å®šå¯µç‰©é€£é–ï¼š</b><br>å¯µç‰©å…¬åœ’ã€æ±æ£®å¯µç‰©ã€é­šä¸­é­šã€è²“ç‹—éšŠé•·ã€æ¯›å­©å¸‚é›†ã€é‡‘å‰åˆ©ã€å¥½ç‹—å‘½ã€å¥½ç‹—é‹ã€é‡‘ç‹å­ã€æ„›è²“åœ’ã€ç¦å£½å¯µç‰©æ——è‰¦é¤¨<br>
                <b>(2) 2026 æ–°å¢å“ç‰Œï¼š</b><br>æ±ªå–µæ˜Ÿçƒã€æ€ªç¸éƒ¨è½ã€è¶…å‡å°å§ã€Hero Mama<br>
                <b>(3) é†«ç™‚èˆ‡ç¾å®¹ï¼š</b><br>ç¸é†«è¨ºæ‰€ã€å‹•ç‰©é†«é™¢ã€å¯µç‰©æ—…é¤¨ã€å¯µç‰©ç¾å®¹ (MCC 0742, 5995)
            `;
        }
    }

    // --- æ›¬æˆ°ç¸¾åŠŸèƒ½æ ¸å¿ƒé‚è¼¯ (V123.98 æ¥µé€Ÿç‰ˆ) ---
    function openShareModal() {
        const totalAmount = document.getElementById('totalRewardDisplay').innerText;
        const date = new Date();
        const month = date.getMonth() + 1;
        
        // 1. å¡«å…¥æ¨™é¡Œ
        document.getElementById('shareCardMonth').innerText = `${month} æœˆå›é¥‹æˆ°ç¸¾`;
        document.getElementById('shareCardAmount').innerText = totalAmount;
        
        // 2. æ‰¾å‡ºæ‰€æœ‰å›é¥‹ > 0 çš„å¡ç‰‡ (å…¨åˆ—å‡º)
        let cardRewards = [];
        cards.forEach(card => {
            if(card.type === 'placeholder') return;
            const stats = calculateStats(card.id);
            if(stats.reward > 0) {
                cardRewards.push({ name: card.name, reward: stats.reward });
            }
        });
        
        // æ’åºï¼šé‡‘é¡é«˜åˆ°ä½
        cardRewards.sort((a, b) => b.reward - a.reward);
        
        const listContainer = document.getElementById('shareCardList');
        listContainer.innerHTML = '';
        
        if(cardRewards.length === 0) {
             listContainer.innerHTML = '<div style="text-align:center; opacity:0.6; padding:10px;">æœ¬æœˆå°šç„¡å›é¥‹ç´€éŒ„</div>';
        } else {
            cardRewards.forEach(c => {
                let unit = (c.name.includes('æ—…äºº')) ? 'å“©' : 'å…ƒ';
                listContainer.innerHTML += `
                    <div class="share-item">
                        <span>${c.name}</span>
                        <span>+${c.reward.toLocaleString()} ${unit}</span>
                    </div>`;
            });
        }

        // 3. é¡¯ç¤ºè¦–çª—
        document.getElementById('sharePreviewModal').style.display = 'flex';
    }

    // V123.98 æ ¸å¿ƒï¼šå…¨èƒ½åˆ†äº«å‡½å¼ (ç”Ÿæˆ -> ç³»çµ±é¸å–®)
    function shareUniversal() {
        const node = document.getElementById('captureNode');
        // æš«å­˜æ¨£å¼é˜²æ­¢è·‘ç‰ˆ
        const originalTransform = node.style.transform;
        node.style.transform = 'none';

        // çµ¦ç”¨æˆ¶ä¸€é»åé¥‹
        const btns = document.querySelectorAll('.social-btn');
        btns.forEach(b => b.style.opacity = '0.5');

        html2canvas(node, {
            backgroundColor: null,
            scale: 2 // é«˜è§£æåº¦
        }).then(canvas => {
            node.style.transform = originalTransform; // æ¢å¾©
            btns.forEach(b => b.style.opacity = '1'); // æ¢å¾©æŒ‰éˆ•
            
            canvas.toBlob(async (blob) => {
                // å»ºç«‹æª”æ¡ˆç‰©ä»¶
                const file = new File([blob], `reward_${Date.now()}.png`, { type: "image/png" });
                
                // æª¢æŸ¥ç€è¦½å™¨æ˜¯å¦æ”¯æ´åŸç”Ÿåˆ†äº«æª”æ¡ˆ (iOS Safari / Android Chrome å¤§å¤šæ”¯æ´)
                if (navigator.share && navigator.canShare && navigator.canShare({ files: [file] })) {
                    try {
                        // é€™ä¸€æ­¥æœƒç›´æ¥å«å‡ºç³»çµ±åº•éƒ¨çš„ã€Œæ›´å¤šã€é¸å–®
                        await navigator.share({
                            files: [file],
                            title: 'æˆ‘çš„åˆ·å¡æˆ°ç¸¾',
                            text: getShareText() // éƒ¨åˆ† App æœƒåƒé€™å€‹æ–‡å­—ï¼ŒFB/IG é€šå¸¸å¿½ç•¥
                        });
                    } catch (err) {
                        console.log('åˆ†äº«å·²å–æ¶ˆ'); // ç”¨æˆ¶è‡ªå·±å–æ¶ˆï¼Œä¸éœ€å ±éŒ¯
                    }
                } else {
                    // è‹¥ä¸æ”¯æ´ (ä¾‹å¦‚é›»è…¦ç‰ˆ)ï¼ŒåªåŸ·è¡Œä¸‹è¼‰ï¼Œä¸è·³è½‰
                    alert("æ‚¨çš„è£ç½®ä¸æ”¯æ´ç›´æ¥åˆ†äº«ï¼Œç³»çµ±å°‡è‡ªå‹•ä¸‹è¼‰åœ–ç‰‡ã€‚");
                    downloadShareImage(); 
                }
            });
        });
    }

    // ä¸‹è¼‰åœ–ç‰‡ (å‚™ç”¨)
    function downloadShareImage(callback) {
        const node = document.getElementById('captureNode');
        const originalTransform = node.style.transform;
        node.style.transform = 'none'; 
        
        html2canvas(node, {
            backgroundColor: null,
            scale: 2 
        }).then(canvas => {
            node.style.transform = originalTransform; 
            const link = document.createElement('a');
            link.download = `æˆ‘çš„å›é¥‹æˆ°ç¸¾_${new Date().getTime()}.png`;
            link.href = canvas.toDataURL();
            link.click();
            if(callback) callback();
        });
    }

    function getShareText() {
        const totalAmount = document.getElementById('totalRewardDisplay').innerText;
        return `ğŸ’° ç‹‚ï¼æœ¬æœˆå›é¥‹ ${totalAmount}ï¼\nå¿«ä¾†è©¦ç®— ğŸ‘‰ https://shawn2026-oss.github.io/shawn-2026-creditcard/`;
    }

    // --- çµæŸ æ›¬æˆ°ç¸¾åŠŸèƒ½ ---

    fetch('config.json?t=' + Date.now()).then(response => response.json()).then(data => { if(data.news) document.getElementById('news-text').innerHTML = data.news; }).catch(error => {});
    let cardSettings = JSON.parse(localStorage.getItem('cardSettings')) || {};

    window.addEventListener('load', () => {
        injectHappyDetails(); 
        setTimeout(() => { const ticker = document.querySelector('.ticker-content'); if(ticker) { ticker.style.animation = 'none'; void ticker.offsetWidth; ticker.style.animation = 'scroll-left 15s linear infinite'; } }, 100);
        
        const isSetupDone = localStorage.getItem('user_setup_done');
        const hasLegacyData = localStorage.getItem('visibleCards') !== null;

        if (!isSetupDone) {
            if (hasLegacyData) {
                localStorage.setItem('user_setup_done', 'true');
                loadAndRenderApp();
            } else {
                initWelcomeModal();
            }
        } else {
            loadAndRenderApp();
        }
    });

    function initWelcomeModal() {
        const modal = document.getElementById('welcomeModal');
        const list = document.getElementById('welcomeList');
        list.innerHTML = '';
        cards.forEach(card => {
            if (card.id === 'add1') return;
            const item = document.createElement('div');
            item.className = 'welcome-item';
            item.innerHTML = `
                <input type="checkbox" id="w_${card.id}" value="${card.id}">
                <label for="w_${card.id}">${card.name}</label>
            `;
            list.appendChild(item);
        });
        modal.style.display = 'flex';
    }

    function saveWelcomeSettings() {
        const checkboxes = document.querySelectorAll('.welcome-item input[type="checkbox"]:checked');
        let selectedCards = [];
        checkboxes.forEach(cb => selectedCards.push(cb.value));
        if (selectedCards.length === 0) {
            alert("ğŸ’¡ å°æé†’ï¼š\nå»ºè­°å…ˆé¸å¹¾å¼µå¡ç‰‡è©¦ç”¨çœ‹çœ‹å–”ï¼");
            return;
        }
        localStorage.setItem('visibleCards', JSON.stringify(selectedCards));
        localStorage.setItem('user_setup_done', 'true');
        document.getElementById('welcomeModal').style.display = 'none';
        location.reload();
    }

    function loadAndRenderApp() {
        let currentCards = JSON.parse(localStorage.getItem('visibleCards')) || [];
        const realCardIds = cards.map(c => c.id).filter(id => id !== 'add1');
        let realCards = currentCards.filter(id => realCardIds.includes(id));
        if (realCards.length > 8) { 
            realCards = realCards.slice(0, 8);
            localStorage.setItem('visibleCards', JSON.stringify(realCards)); 
        }
        
        if (realCards.length < 8) { 
            if (!currentCards.includes('add1')) { 
                realCards.push('add1');
                localStorage.setItem('visibleCards', JSON.stringify(realCards)); 
            } 
        } else { 
            if (currentCards.includes('add1')) { 
                localStorage.setItem('visibleCards', JSON.stringify(realCards));
            } 
        }
        visibleCards = JSON.parse(localStorage.getItem('visibleCards'));
        renderGrid();
    }

    function closeModal() {
        document.getElementById('transactionModal').style.display = 'none';
        document.getElementById('manageModal').style.display = 'none';
        document.getElementById('sharePreviewModal').style.display = 'none';
    }

    window.addEventListener('popstate', function(event) { 
        closeModal();
    });

    // æ ¸å¿ƒè³‡æ–™åº« (æ›´æ–°ï¼šå¹£å€å¡èˆ‡æ¨‚å®¶å¡é‚è¼¯æ–‡å­—)
    const defaultCards = [
        { 
            id: 'c10', name: 'ä¸­ä¿¡ UniOpen å¡', nickname: '2026 çµ±ä¸€é›†åœ˜ç¥å¡', 
            note: 'icashPay +4% / æµ·å¤– 11% / è¸©é» +4%', 
            type: 'uniopen_special', gradient: 'linear-gradient(135deg, #FF512F 0%, #F09819 100%)', textColor: 'white', msgDanger: '', 
            parking: `ğŸª <b>çµ±ä¸€é›†åœ˜ 2026 æ–°æ¬Šç›Š</b><br>1. <b>åŸºæœ¬å›é¥‹</b>ï¼š1% (ç„¡ä¸Šé™)<br>2. <b>é›†åœ˜åŠ ç¢¼</b>ï¼š+2% (é™åˆ·$2.5è¬)<br>3. <b>è¸©é»ä»»å‹™</b>ï¼šæ»¿ 5 å®¶ +4% (é™åˆ·$1.25è¬)<br>4. <b>icash Pay</b>ï¼šåŠ ç¢¼ +4% (é™åˆ·$3,750)<br><br>âœˆï¸ <b>æµ·å¤–å¯¦é«”</b>ï¼š11% (3% + åŠ ç¢¼8%é™åˆ·$6,250)`
        },
        { 
            id: 'c6', name: 'å°æ–°è¡—å£è±¬å¯Œå¡', nickname: 'è¡Œæ”¯/ç¹³è²»ç¥å¡', 
            note: 'è¡Œæ”¯/æµ·å¤–/æ©Ÿç¥¨(é™åˆ·$8åƒ) | ç²¾é¸+2.5%(é™åˆ·40è¬)', 
            rule: '', type: 'ceiling', limit: 8000, tier1Rate: 0.135, tier2Rate: 0.035, 
            gradient: 'linear-gradient(135deg, #e60012 0%, #FFD700 100%)', 
            textColor: 'white', msgDanger: 'æ–°æˆ¶10%å·²å°é ‚',
            parking: `ğŸ· <b>æ–°æˆ¶é™å®šç¥å¡</b><br>æ–°æˆ¶ +10% (é™åˆ·$8,000)<br>ğŸŒŸ <b>ç²¾é¸é€šè·¯ +2.5%</b><br>ä¸Šé™ $40 è¬`
        },
        { id: 'c1', name: 'æ˜Ÿå±•å‚³èªªå°æ±ºå¡', nickname: 'Line Payç¥å¡', note: 'LinePay / è¦çš® / å¤–é€ (åˆ· $11,363 å°é ‚)', rule: '', type: 'ceiling', limit: 11363, tier1Rate: 0.10, tier2Rate: 0.012, gradient: 'linear-gradient(135deg, #43cea2 0%, #185a9d 100%)', textColor: 'white', msgDanger: 'å·²å°é ‚ (è®Š1.2%)' },
        { id: 'c5', name: 'è¯é‚¦è³´é»å¡', nickname: 'Line Payå„ªç­‰ç”Ÿ', note: 'Line Pay / å¶æ•¸æ—¥æŒ‡å®šé€šè·¯ (åˆ· $3,000 å°é ‚)', rule: 'âš ï¸ å–®ç­†éœ€æ»¿$100', type: 'ceiling', limit: 3000, tier1Rate: 0.06, tier2Rate: 0.01, threshold: 100, gradient: 'linear-gradient(135deg, #00B900 0%, #33CC33 100%)', textColor: 'white', msgDanger: 'å·²å°é ‚ (è®Š1%)', parking: `âš ï¸ <b>å–®ç­†éœ€æ»¿ $100</b> (å›é¥‹ 6%)`},
        { id: 'c3', name: 'æ°¸è± Sport å¡', nickname: 'Apple Payå„ªç­‰ç”Ÿ', note: 'Apple Pay 5% (åˆ· $5,000 å°é ‚)', rule: '', type: 'ceiling', limit: 5000, tier1Rate: 0.05, tier2Rate: 0.02, gradient: 'linear-gradient(135deg, #00B4DB 0%, #0083B0 100%)', textColor: 'white', msgDanger: 'å·²å°é ‚ (è®Š1%)' },
        { 
            id: 'c4', name: 'å°‡ä¾†å°‡å°‡å¡', nickname: 'è¡Œæ”¯/é¤å»³/å¤–é€', 
            note: 'ç”Ÿæ´»/æ—…éŠ 5% (éœ€æœˆåˆ·æ»¿ $3,000)', 
            rule: '', type: 'mixed', limit: 6666, minSpend: 3000, tier1Rate: 0.05, tier2Rate: 0.005, 
            gradient: 'linear-gradient(135deg, #ffe259 0%, #ffa751 100%)', textColor: '#333', msgDanger: 'å·²å°é ‚ (è®Š0.5%)', 
            parking: `ğŸ¯ <b>ä½æ¶ˆä»»å‹™</b>ï¼šç•¶æœˆç´¯ç©æ»¿ <b>$3,000</b> æ‰äº«åŠ ç¢¼<br><br>ğŸ›ï¸ <b>ç”Ÿæ´»å‡ç´š 5%</b> (é™åˆ·$6,666)<br>è¡Œå‹•æ”¯ä»˜/å¤–é€/é¤å»³/è³¼ç‰©<br><br>âœˆï¸ <b>æ—…éŠåŠ ç¢¼ 5%</b> (é™åˆ·$11,111)<br>æµ·å¤–/èˆªç©º/æ—…è¡Œç¤¾/é«˜éµ`
        },
        { id: 'c2', name: 'è¯é‚¦ç¶ å¡', nickname: 'å…è²»å¸‚å€åœè»Š', note: 'åœ‹å…§1% / åœ‹å¤–2% / ç¶ è‰²6% (ä½æ¶ˆ$12000)', rule: '', type: 'floor', target: 12000, tier1Rate: 0.02, tier2Rate: 0.02, gradient: 'linear-gradient(135deg, #20B2AA 0%, #008B8B 100%)', textColor: 'white', msgSuccess: 'å·²é”æ¨™ (å…åœ)', parking: `ğŸ…¿ï¸ <b>å…è²»åœè»Šï¼š</b>éœ€ä¸Šæœˆåˆ·æ»¿1.2è¬`},
        { id: 'c7', name: 'ç‰å±± UNI å¡', nickname: 'è¡Œæ”¯/ç™¾è²¨å„ªç­‰ç”Ÿ', note: 'ä»»æ„3.5% / UP 4.5% (åˆ· 4~14è¬ å°é ‚)', type: 'ceiling', limit: 40000, tier1Rate: 0.035, tier2Rate: 0.01, gradient: 'linear-gradient(135deg, #a18cd1 0%, #fbc2eb 100%)', textColor: 'white', msgDanger: 'å·²å°é ‚ (è®Š1%)', 
          parking: `ğŸ”¥ <b>ä»»æ„é¸ 3.5%</b> (é™åˆ·$4è¬)<br>ğŸ†™ <b>UP é¸ 4.5%</b> (é™åˆ·$14è¬)<br>ğŸ¬ <b>çµ±ä¸€æ™‚ä»£ +3%</b> (é™åˆ·$1.6è¬)`},
        { 
            id: 'c8', name: 'é æ±æ¨‚å®¶+å¡', nickname: 'ç”Ÿæ´»/å¯µç‰©ç¥å¡', 
            note: 'å¯µç‰©10% | ç”Ÿæ´»/å®‰å¿ƒ 4% (éœ€ä¸€èˆ¬æ¶ˆè²»æ»¿3åƒ)', 
            type: 'ceiling', limit: 5263, tier1Rate: 0.1, tier2Rate: 0.005, 
            gradient: 'linear-gradient(135deg, #ff9a9e 0%, #fecfef 99%, #fecfef 100%)', 
            textColor: 'white', msgDanger: 'å·²å°é ‚ (è®Š0.5%)', 
            parking: `ğŸ¶ <b>å¯µç‰© 10%</b> (é™åˆ·$5,263)<br>ğŸ½ï¸ <b>å®‰å¿ƒ/ç”Ÿæ´» 4%</b> (é™åˆ·$5,714)<br>âœˆï¸ <b>åœ‹å¤– 2.5%</b> (ç„¡ä¸Šé™)`
        },
        { id: 'c9', name: 'æ»™è±æ—…äººå¡', nickname: 'å“©ç¨‹ç´¯ç©', note: 'ç„¡é™:åœ‹å…§18/åœ‹å¤–10 | å¾¡ç’½:åœ‹å…§18/åœ‹å¤–15', type: 'miles', gradient: 'linear-gradient(135deg, #1e3c72 0%, #2a5298 100%)', textColor: 'white', msgDanger: '', parking: `âœˆï¸ <b>å“©ç¨‹ç´¯ç©ç¥å¡</b>`},
        { id: 'c11', name: 'å°æ–° Richart å¡', nickname: 'æ¬Šç›Šè‡ªç”±é¸', note: 'å°æ–°Pay 3.8% / ç¶²è³¼ 3.3% / LP 2.3% (ç„¡ä¸Šé™)', type: 'ceiling', limit: 99999999, tier1Rate: 0.038, tier2Rate: 0.003, gradient: 'linear-gradient(135deg, #0F2027 0%, #203A43 50%, #2C5364 100%)', textColor: 'white', msgDanger: '', parking: `ğŸ¶ <b>æ¬Šç›Šè‡ªç”±é¸ (ç„¡ä¸Šé™å›é¥‹)</b>`},
        
        { 
            id: 'j1', name: 'å¯Œé‚¦ J å¡', nickname: 'æ—¥éŸ“æ—…éŠç¥å¡', 
            note: 'æ—¥éŸ“ 3% / å¯¦é«” +3% (åˆ· $33,333 å°é ‚)', 
            type: 'ceiling', limit: 33333, tier1Rate: 0.06, tier2Rate: 0.03, 
            gradient: 'linear-gradient(135deg, #FF7E5F 0%, #FEB47B 100%)', textColor: 'white', msgDanger: 'åŠ ç¢¼å·²å°é ‚ (è®Š3%)', 
            parking: `ğŸ‡¯ğŸ‡µ <b>æ—¥éŸ“å¯¦é«”æ¶ˆè²»</b><br>åŸºæœ¬ 3% + å¯¦é«” 3% = 6%<br>âš ï¸ å¯¦é«”åŠ ç¢¼ä¸Šé™ $1000/å­£ (ç´„åˆ·$3.3è¬)`
        },
        { 
            id: 'j2', name: 'è¯é‚¦å‰é¶´å¡', nickname: 'æ—¥æœ¬/ApplePayå°ˆæ­¦', 
            note: 'æ—¥æœ¬ 2.5% / Apple Pay +1.5% (åˆ· $40,000 å°é ‚)', 
            type: 'ceiling', limit: 40000, tier1Rate: 0.04, tier2Rate: 0.025, 
            gradient: 'linear-gradient(135deg, #DC143C 0%, #FFFFFF 150%)', textColor: 'white', msgDanger: 'åŠ ç¢¼å·²å°é ‚ (è®Š2.5%)', 
            parking: `ğŸ <b>æ—¥æœ¬ QUICPay (Apple Pay)</b><br>æ—¥æœ¬ 2.5% + åŠ ç¢¼ 1.5% = 4%<br>âš ï¸ åŠ ç¢¼ä¸Šé™ $600/æœˆ (ç´„åˆ·$4è¬)`
        },
        { 
            id: 'j3', name: 'ç‰å±±ç†Šæœ¬ç†Šå¡', nickname: 'è—¥å¦/Suica ç¥å¡', 
            note: 'æŒ‡å®šé€šè·¯ 8.5% (åˆ· $10,000 å°é ‚)', 
            type: 'ceiling', limit: 10000, tier1Rate: 0.085, tier2Rate: 0.025, 
            gradient: 'linear-gradient(135deg, #BDC3C7 0%, #2C3E50 100%)', textColor: 'white', msgDanger: 'åŠ ç¢¼å·²å°é ‚ (è®Š2.5%)', 
            parking: `ğŸ» <b>æŒ‡å®šé€šè·¯ 8.5%</b><br>(åŸºæœ¬1% + å…æ‰‹çºŒè²»1.5% + åŠ ç¢¼5% + é›™å¹£1%)<br>å« Suica åŠ å€¼ã€å”å‰è¨¶å¾·ã€å¤§åœ‹è—¥å¦ç­‰<br>âš ï¸ åŠ ç¢¼ä¸Šé™ $500/æœŸ (ç´„åˆ·$1è¬)`
        },
        { 
            id: 'j4', name: 'æ°¸è±å¹£å€å¡', nickname: 'æµ·å¤–é›™å¹£ç¥å¡', 
            note: 'ç²¾é¸/æµ·å¤– +4% (é™åˆ·$7,500 æˆ– $2è¬)', 
            type: 'ceiling', limit: 80000, tier1Rate: 0.06, tier2Rate: 0.02, 
            gradient: 'linear-gradient(135deg, #FDC830 0%, #F37335 100%)', textColor: 'white', msgDanger: 'åŠ ç¢¼å·²å°é ‚',
            parking: `ğŸ’° <b>å¹£å€å¡ 2026</b><br><b>Level 1 (é™åˆ·$7,500)</b>ï¼šè‡ªå‹•æ‰£ç¹³+é›»å­å¸³å–®<br><b>Level 2 (é™åˆ·$20,000)</b>ï¼šè³‡ç”¢â‰¥10è¬ æˆ– å¤§æˆ¶`
        },
        { 
            id: 'j5', name: 'æ°¸è±ä¸‰äº•è¯åå¡', nickname: 'é¤é£²/æ—¥éŸ“ç¥å¡', 
            note: 'é¤¨å¤–é¤é£²/å…¨ç›ˆ 7% (é™$100)', 
            type: 'floor', target: 30000, tier1Rate: 0.073, tier2Rate: 0.003, 
            gradient: 'linear-gradient(135deg, #00C9FF 0%, #92FE9D 100%)', textColor: '#333', msgSuccess: 'å·²é”æ¨™ (é ˜$2000)',
            parking: `ğŸ½ï¸ <b>ç‰¹é¸é€šè·¯ 7% (ä¸Šé™100å…ƒ)</b><br>é€šè·¯ï¼šé¤¨å¤–é¤é£²(MCC 58xx) / å…¨ç›ˆ+PAY<br>âš ï¸ åŠ ç¢¼ä¸Šé™åƒ… 100 å…ƒ (ç´„åˆ· $1,428)<br><br>ğŸ‡¯ğŸ‡µ <b>æ—¥éŸ“æ³°æ»¿é¡ç¦® (JCBé™å®š)</b><br>æ¯å­£ç´¯ç©æ»¿ 30,000 é€ 2,000`
        },

        { id: 'add1', name: 'æ–°å¢å¡ç‰‡', nickname: 'é»æ“Šé¸å¡', note: 'å‰å¾€è³‡æ–™åº«æŒ‘é¸', type: 'placeholder', gradient: 'linear-gradient(135deg, #e0e0e0 0%, #f5f5f5 100%)', textColor: '#999', msgDanger: '' }
    ];

    let visibleCards = JSON.parse(localStorage.getItem('visibleCards'));
    let savedOrder = JSON.parse(localStorage.getItem('cardOrder'));
    let cards = [...defaultCards];
    let sortableInstance = null;

    function getSortedCards() {
        if (!visibleCards) return [];
        let displayCards = cards.filter(c => visibleCards.includes(c.id));
        const realCardCount = displayCards.filter(c => c.type !== 'placeholder').length;
        if (realCardCount < 8 && !visibleCards.includes('add1')) { const placeholder = cards.find(c => c.id === 'add1');
        if(placeholder && !displayCards.includes(placeholder)) displayCards.push(placeholder); }
        if (savedOrder && Array.isArray(savedOrder)) { displayCards.sort((a, b) => { let indexA = savedOrder.indexOf(a.id); let indexB = savedOrder.indexOf(b.id); if (indexA === -1) indexA = 999; if (indexB === -1) indexB = 999; return indexA - indexB; });
        }
        return displayCards;
    }

    function initSortable() {
        var el = document.getElementById('card-grid');
        if (sortableInstance) { sortableInstance.destroy(); }
        sortableInstance = new Sortable(el, { animation: 150, ghostClass: 'sortable-ghost', dragClass: 'sortable-drag', delay: 200, delayOnTouchOnly: true, forceFallback: true, onEnd: function (evt) { const visibleOrder = Array.from(evt.to.children).map(el => el.getAttribute('data-card-id')); const allCardIds = cards.map(c => c.id); const hiddenCards = allCardIds.filter(id => !visibleOrder.includes(id)); const finalOrder = [...visibleOrder, ...hiddenCards]; localStorage.setItem('cardOrder', JSON.stringify(finalOrder)); savedOrder = finalOrder; } });
    }

    let transactions = JSON.parse(localStorage.getItem('transactions')) || [];
    function updateDate() { const now = new Date();
    document.getElementById('dateDisplay').innerText = `${now.getMonth()+1}/${now.getDate()}`; }
    function saveHsbcTier() { const tier = document.querySelector('input[name="hsbcTier"]:checked').value; localStorage.setItem('hsbc_tier', tier); renderGrid(); updateRewardPreview();
    }
    function saveHsbcInitial() { const initial = document.getElementById('hsbcInitialMiles').value; localStorage.setItem('hsbc_initial_miles', initial); renderGrid();
    }
    
    function saveHsbcSettings() {
        const redeemed = document.getElementById('hsbcRedeemedMiles').value;
        localStorage.setItem('hsbc_redeemed_miles', redeemed);
        renderGrid();
    }

    const uniBrands = ["7-11", "æ˜Ÿå·´å…‹", "åº·æ˜¯ç¾", "å®¶æ¨‚ç¦", "Mia C'bon", "åšå®¢ä¾†", "Yahooè³¼ç‰©", "é€Ÿé‚æ¨‚", "21ä¸–ç´€", "é…·è–çŸ³", "è–å¾·ç§‘æ–¯", "çµ±ä¸€æ™‚ä»£", "å¤¢æ™‚ä»£", "å…¶ä»–"];
    function initUniBrandGrid() {
        const grid = document.getElementById('uniBrandGrid');
        grid.innerHTML = '';
        uniBrands.forEach(brand => {
            const btn = document.createElement('div');
            btn.className = 'brand-btn';
            btn.innerText = brand;
            btn.onclick = () => toggleUniBrand(brand, btn);
            grid.appendChild(btn);
        });
    }

    function saveUniOpenState() {
        const state = {
            group: document.getElementById('checkUniGroup').checked,
            icash: document.getElementById('checkUniIcash').checked,
            overseas: document.getElementById('checkUniOverseas').checked,
            brands: getCheckedBrands()
        };
        localStorage.setItem('uniOpenState', JSON.stringify(state));
        const count = state.brands.length;
        updateTaskBonusDisplay(count);
        renderGrid(); 
        updateRewardPreview();
    }
    
    function toggleUniBrand(brand, btn) {
        if (document.getElementById('checkUniOverseas').checked) {
            document.getElementById('checkUniOverseas').checked = false;
        }
        if(!btn.classList.contains('active')) {
            document.getElementById('checkUniGroup').checked = true;
        }
        btn.classList.toggle('active');
        saveUniOpenState();
    }
    
    function toggleUniGroup() {
        if(document.getElementById('checkUniGroup').checked) {
            document.getElementById('checkUniOverseas').checked = false;
        }
        saveUniOpenState();
    }
    
    function toggleUniIcash() {
        if(document.getElementById('checkUniIcash').checked) {
            document.getElementById('checkUniOverseas').checked = false;
        }
        saveUniOpenState();
    }
    
    function getCheckedBrands() {
        const activeBtns = document.querySelectorAll('.brand-btn.active');
        const brands = [];
        activeBtns.forEach(btn => brands.push(btn.innerText));
        return brands;
    }
    
    function updateTaskBonusDisplay(count) {
        const display = document.getElementById('taskBonusDisplay');
        let rate = 0;
        if(count >= 5) rate = 4;
        else if(count === 4) rate = 3;
        else if(count === 3) rate = 2;
        else if(count === 2) rate = 1;
        display.innerText = `ç›®å‰è¸©é» ${count} å®¶ (åŠ ç¢¼ +${rate}%)`;
    }
    
    function toggleUniOverseas() {
        const isOverseas = document.getElementById('checkUniOverseas').checked;
        if (isOverseas) {
            document.getElementById('checkUniGroup').checked = false;
            document.getElementById('checkUniIcash').checked = false;
            const btns = document.querySelectorAll('.brand-btn');
            btns.forEach(btn => btn.classList.remove('active'));
        }
        saveUniOpenState();
    }

    function toggleUniUpLogic() {
        const isUp = document.getElementById('checkUniUp').checked;
        const label = document.getElementById('labelUniBase');
        if (isUp) {
            label.innerHTML = "ğŸ†™ <b>UP é¸ 4.5%</b> (ä¸Šé™14è¬)";
            label.parentNode.style.background = "#fff3e0"; 
        } else {
            label.innerHTML = "ğŸ”° <b>ä»»æ„é¸ 3.5%</b> (ä¸Šé™4è¬)";
            label.parentNode.style.background = "transparent";
        }
        updateRewardPreview();
    }

    function toggleFubonJLogic() {
        const isJapan = document.getElementById('checkFubonJJapan').checked;
        const labelBase = document.getElementById('labelFubonBase');
        const physicalRow = document.getElementById('rowFubonPhysical');
        const domesticRow = document.getElementById('rowFubonDomesticBonus');
        if (isJapan) {
            labelBase.innerHTML = "âœˆï¸ <b>æ—¥éŸ“åŸºæœ¬ 3%</b> (ç„¡ä¸Šé™)";
            physicalRow.style.display = 'flex';
            domesticRow.style.display = 'none';
            document.getElementById('checkFubonJDomesticBonus').checked = false;
        } else {
            labelBase.innerHTML = "ğŸ”° <b>åœ‹å…§æ¶ˆè²» 1%</b> (ç„¡ä¸Šé™)";
            document.getElementById('checkFubonJPhysical').checked = false;
            physicalRow.style.display = 'none';
            domesticRow.style.display = 'flex';
        }
        updateRewardPreview();
    }

    function toggleJiheLogic() {
        const isJapan = document.getElementById('checkJiheJapan').checked;
        const labelBase = document.getElementById('labelJiheBase');
        const appleRow = document.getElementById('rowJiheApple');
        const domesticRow = document.getElementById('rowJiheDomesticJapanese');
        if (isJapan) {
            labelBase.innerHTML = "âœˆï¸ <b>æ—¥æœ¬æ¶ˆè²» 2.5%</b> (ç„¡ä¸Šé™)";
            appleRow.style.display = 'flex';
            domesticRow.style.display = 'none';
            document.getElementById('checkJiheDomesticJapanese').checked = false;
        } else {
            labelBase.innerHTML = "ğŸ”° <b>åœ‹å…§æ¶ˆè²» 1%</b> (ç„¡ä¸Šé™)";
            document.getElementById('checkJiheApple').checked = false;
            appleRow.style.display = 'none';
            domesticRow.style.display = 'flex';
        }
        updateRewardPreview();
    }

    function toggleKumamonLogic() {
        const isJapan = document.getElementById('checkKumamonJapan').checked;
        const labelBase = document.getElementById('labelKumamonBase');
        const groupJapan = document.getElementById('groupKumamonJapan');
        const groupDomestic = document.getElementById('groupKumamonDomestic');
        if (isJapan) {
            labelBase.innerHTML = "âœˆï¸ <b>æ—¥æœ¬æ¶ˆè²» 2%</b> (å«å…æ‰‹çºŒè²»)";
            groupJapan.style.display = 'block';
            groupDomestic.style.display = 'none';
            document.getElementById('checkKumamonDomesticGreen').checked = false;
        } else {
            labelBase.innerHTML = "ğŸ”° <b>åœ‹å…§æ¶ˆè²» 1%</b> (ç„¡ä¸Šé™)";
            document.getElementById('checkKumamonDesignated').checked = false;
            document.getElementById('checkKumamonPayPay').checked = false;
            groupJapan.style.display = 'none';
            groupDomestic.style.display = 'block';
        }
        updateRewardPreview();
    }
    
    function toggleKumamonSub() {
        if(document.getElementById('checkKumamonDesignated').checked) {
            document.getElementById('checkKumamonPayPay').checked = false;
            document.getElementById('checkKumamonJapan').checked = true; 
        }
        if(document.getElementById('checkKumamonPayPay').checked) {
            document.getElementById('checkKumamonDesignated').checked = false;
            document.getElementById('checkKumamonJapan').checked = true;
        }
        const isJapan = document.getElementById('checkKumamonJapan').checked;
        if(isJapan) {
             document.getElementById('groupKumamonJapan').style.display = 'block';
             document.getElementById('groupKumamonDomestic').style.display = 'none';
        }
        updateRewardPreview();
    }

    function toggleCurrencyLogic() {
        updateRewardPreview();
    }
    
    function toggleJiangDetails() {
        const el = document.getElementById('jiangDetails');
        el.style.display = (el.style.display === 'block') ? 'none' : 'block';
    }
    
    function toggleJiangTravelDetails() {
        const el = document.getElementById('jiangTravelDetails');
        el.style.display = (el.style.display === 'block') ? 'none' : 'block';
    }
    
    function toggleCurrencyDetails() {
        const el = document.getElementById('currencyDetails');
        el.style.display = (el.style.display === 'block') ? 'none' : 'block';
    }

    function togglePigRichNewUser() {
        const el = document.getElementById('pigRichNewUserDetails');
        el.style.display = (el.style.display === 'block') ? 'none' : 'block';
    }

    function togglePigRichSelected() {
        const el = document.getElementById('pigRichSelectedDetails');
        el.style.display = (el.style.display === 'block') ? 'none' : 'block';
    }
    
    function toggleHappyPetDetails() {
        const el = document.getElementById('happyPetDetails');
        el.style.display = (el.style.display === 'block') ? 'none' : 'block';
    }
    function toggleHappyPeaceDetails() {
        const el = document.getElementById('happyPeaceDetails');
        el.style.display = (el.style.display === 'block') ? 'none' : 'block';
    }
    function toggleHappyLifeDetails() {
        const el = document.getElementById('happyLifeDetails');
        el.style.display = (el.style.display === 'block') ? 'none' : 'block';
    }
    
    function saveCurrencyLevel() {
        const level = document.querySelector('input[name="currencyLevel"]:checked').value;
        localStorage.setItem('currency_level', level);
        renderGrid();
        updateRewardPreview();
    }

    function addTransaction(isConfirm) {
        const amount = parseFloat(document.getElementById('amountInput').value);
        const date = document.getElementById('dateInput').value;
        const note = document.getElementById('noteInput').value;
        const cardId = document.getElementById('cardIdInput').value;
        
        if (!amount || amount <= 0) { alert('è«‹è¼¸å…¥æœ‰æ•ˆé‡‘é¡');
        return; }
        if (!date) { alert('è«‹é¸æ“‡æ—¥æœŸ'); return;
        }

        let isGreen = document.getElementById('checkGreenChannel') ? document.getElementById('checkGreenChannel').checked : false;
        let isForeign = document.getElementById('checkForeign') ? document.getElementById('checkForeign').checked : false;
        let isUniUp = document.getElementById('checkUniUp') ? document.getElementById('checkUniUp').checked : false;
        let isUniBonus = document.getElementById('checkUniBonus') ? document.getElementById('checkUniBonus').checked : false;
        let isHappyPet = document.getElementById('checkHappyPet') ? document.getElementById('checkHappyPet').checked : false;
        let isHappyPeace = document.getElementById('checkHappyPeace') ? document.getElementById('checkHappyPeace').checked : false;
        let isHappyLife = document.getElementById('checkHappyLife') ? document.getElementById('checkHappyLife').checked : false;
        let isHappyForeign = document.getElementById('checkHappyForeign') ? document.getElementById('checkHappyForeign').checked : false;
        let isHsbcForeign = document.getElementById('checkHsbcForeign') ? document.getElementById('checkHsbcForeign').checked : false;
        let isUniGroup = document.getElementById('checkUniGroup') ? document.getElementById('checkUniGroup').checked : false;
        let isUniIcash = document.getElementById('checkUniIcash') ? document.getElementById('checkUniIcash').checked : false;
        let isUniOverseas = document.getElementById('checkUniOverseas') ? document.getElementById('checkUniOverseas').checked : false;
        
        let richartMode = document.querySelector('input[name="richartMode"]:checked') ? document.querySelector('input[name="richartMode"]:checked').value : 'general';
        let isRichartPay = richartMode === 'pay';
        let isRichartOnline = richartMode === 'online';
        let isRichartLine = richartMode === 'line';
        let isRichartOverseas = richartMode === 'overseas';

        let isBonus10 = document.getElementById('checkBonus10') ? document.getElementById('checkBonus10').checked : false;
        let isBonus25 = document.getElementById('checkBonus25') ? document.getElementById('checkBonus25').checked : false;
        let isBill = document.getElementById('checkIsBill') ? document.getElementById('checkIsBill').checked : false;
        
        let isFubonJJapan = document.getElementById('checkFubonJJapan') ? document.getElementById('checkFubonJJapan').checked : false;
        let isFubonJPhysical = document.getElementById('checkFubonJPhysical') ? document.getElementById('checkFubonJPhysical').checked : false;
        let isFubonJDomesticBonus = document.getElementById('checkFubonJDomesticBonus') ? document.getElementById('checkFubonJDomesticBonus').checked : false;
        let isJiheJapan = document.getElementById('checkJiheJapan') ? document.getElementById('checkJiheJapan').checked : false;
        let isJiheApple = document.getElementById('checkJiheApple') ? document.getElementById('checkJiheApple').checked : false;
        let isJiheDomesticJapanese = document.getElementById('checkJiheDomesticJapanese') ? document.getElementById('checkJiheDomesticJapanese').checked : false;
        
        let isKumamonJapan = document.getElementById('checkKumamonJapan') ? document.getElementById('checkKumamonJapan').checked : false;
        let isKumamonDesignated = document.getElementById('checkKumamonDesignated') ? document.getElementById('checkKumamonDesignated').checked : false;
        let isKumamonPayPay = document.getElementById('checkKumamonPayPay') ? document.getElementById('checkKumamonPayPay').checked : false;
        let isKumamonDomesticGreen = document.getElementById('checkKumamonDomesticGreen') ? document.getElementById('checkKumamonDomesticGreen').checked : false;

        let isSinopacCurrencyOverseas = document.getElementById('checkSinopacCurrencyOverseas') ? document.getElementById('checkSinopacCurrencyOverseas').checked : false;
        let isSinopacCurrencySelected = document.getElementById('checkSinopacCurrencySelected') ? document.getElementById('checkSinopacCurrencySelected').checked : false;
        
        let isSinopacMitsuiSelected = document.getElementById('checkSinopacMitsuiSelected') ? document.getElementById('checkSinopacMitsuiSelected').checked : false;
        let isSinopacMitsuiTarget = document.getElementById('checkSinopacMitsuiTarget') ? document.getElementById('checkSinopacMitsuiTarget').checked : false;
        let isSinopacMitsuiDining = document.getElementById('checkSinopacMitsuiDining') ? document.getElementById('checkSinopacMitsuiDining').checked : false;
        let jiangMode = document.querySelector('input[name="jiangMode"]:checked') ? document.querySelector('input[name="jiangMode"]:checked').value : 'base';
        let isJiangSelected = jiangMode === 'selected';
        let isJiangTravel = jiangMode === 'travel';
        let currencyType = document.querySelector('input[name="currencyType"]:checked') ? document.querySelector('input[name="currencyType"]:checked').value : 'domestic';
        let isSinopacCurrencySelectedFinal = (currencyType === 'selected');
        let isSinopacCurrencyOverseasFinal = (currencyType === 'selected');
        const newTx = {
            id: editingId ||
            Date.now(),
            cardId, amount, date, note,
            isGreen, isForeign, isUniUp, isUniBonus, isHappyPet, isHappyPeace, isHappyLife, isHappyForeign, isHsbcForeign,
            isUniGroup, isUniIcash, isUniOverseas,
            isRichartPay, isRichartOnline, isRichartLine, isRichartOverseas,
            isBonus10, isBonus25, isBill,
            isFubonJJapan, isFubonJPhysical, isFubonJDomesticBonus,
            isJiheJapan, isJiheApple, isJiheDomesticJapanese,
            isKumamonJapan, isKumamonDesignated, isKumamonPayPay, isKumamonDomesticGreen,
            isSinopacCurrencyOverseas: isSinopacCurrencyOverseasFinal, 
            isSinopacCurrencySelected: isSinopacCurrencySelectedFinal,
            isSinopacMitsuiSelected, isSinopacMitsuiTarget, isSinopacMitsuiDining,
            isJiangSelected, isJiangTravel
        };
        if (editingId) {
            const index = transactions.findIndex(t => t.id === editingId);
            if (index !== -1) transactions[index] = newTx;
            editingId = null;
        } else {
            transactions.push(newTx);
        }

        localStorage.setItem('transactions', JSON.stringify(transactions));
        
        document.getElementById('amountInput').value = '';
        document.getElementById('noteInput').value = '';
        document.getElementById('btn-confirm').innerText = "ç¢ºèª";
        
        renderGrid();
        renderModalHistory(cardId);
        updateRewardPreview();

        if (isConfirm) {
            document.getElementById('transactionModal').style.display = 'none';
        } else {
            document.getElementById('amountInput').focus();
        }
    }

    function getBillingCycle(cardId, dateObj = new Date()) {
        const settings = cardSettings[cardId] ||
        {};
        const bDay = parseInt(settings.billingDay) || 1;

        if (bDay === 1) {
            return {
                start: new Date(dateObj.getFullYear(), dateObj.getMonth(), 1),
                end: new Date(dateObj.getFullYear(), dateObj.getMonth() + 1, 0),
                isCustom: false
            };
        }

        let start, end;
        const currentDay = dateObj.getDate();
        if (currentDay >= bDay) {
            start = new Date(dateObj.getFullYear(), dateObj.getMonth(), bDay);
            end = new Date(dateObj.getFullYear(), dateObj.getMonth() + 1, bDay - 1);
        } else {
            start = new Date(dateObj.getFullYear(), dateObj.getMonth() - 1, bDay);
            end = new Date(dateObj.getFullYear(), dateObj.getMonth(), bDay - 1);
        }
        end.setHours(23, 59, 59, 999);
        return { start, end, isCustom: true };
    }
    function calculateStats(cardId, addedAmount = 0, addedIsGreen = false, addedIsForeign = false, addedIsUniBonus = false, addedIsUniUp = false, addedIsHappyPet = false, addedIsHappyLife = false, addedIsHappyForeign = false, addedIsHappyPeace = false, addedIsHsbcForeign = false, addedIsUniGroup = false, addedIsUniIcash = false, addedIsUniOverseas = false, addedIsRichartPay = false, addedIsRichartOnline = false, addedIsRichartLine = false, addedIsRichartOverseas = false, addedIsBonus10 = false, addedIsBonus25 = false, addedIsBill = false, 
        addedIsFubonJJapan = false, addedIsFubonJPhysical = false, addedIsFubonJDomesticBonus = false, 
        addedIsJiheJapan = 
        false, addedIsJiheApple = false, addedIsJiheDomesticJapanese = false,
        addedIsKumamonJapan = false, addedIsKumamonDesignated = false, addedIsKumamonPayPay = false, addedIsKumamonDomesticGreen = false,
        addedIsSinopacCurrencyOverseas = false, addedIsSinopacCurrencySelected = false, 
        addedIsSinopacMitsuiSelected = false, addedIsSinopacMitsuiTarget = false, addedIsSinopacMitsuiDining = false,
        addedIsJiangSelected = false, addedIsJiangTravel = false, addedIsSinopacCurrencyBonus = false) {
        
        const card = cards.find(c => c.id === cardId);
        if (card.type === 'placeholder') return { spend: 0, validSpend: 0, reward: 0, rate: '0.0' };
        const { start: cycleStart, end: cycleEnd, isCustom } = getBillingCycle(cardId);
        const relevantTx = transactions.filter(t => {
            const tDate = new Date(t.date);
            return t.cardId === cardId && tDate >= cycleStart && tDate <= cycleEnd;
        });
        let totalSpend = relevantTx.reduce((sum, t) => sum + parseFloat(t.amount), 0);
        totalSpend += addedAmount;
        let reward = 0;
        if (cardId === 'j1') {
            const txList = [...relevantTx];
            if (addedAmount > 0) txList.push({ amount: addedAmount, isFubonJJapan: addedIsFubonJJapan, isFubonJPhysical: addedIsFubonJPhysical, isFubonJDomesticBonus: addedIsFubonJDomesticBonus });
            reward = txList.reduce((sum, t) => {
                if (t.isFubonJJapan) return sum + (t.amount * 0.03); 
                else return sum + (t.amount * 0.01);
            }, 0);
            const physicalSpend = relevantTx.filter(t => t.isFubonJPhysical).reduce((sum, t) => sum + t.amount, 0) + (addedIsFubonJPhysical ? addedAmount : 0);
            const bonusPhys = Math.min(physicalSpend, 33333) * 0.03;
            reward += bonusPhys;
            const domesticBonusSpend = relevantTx.filter(t => t.isFubonJDomesticBonus).reduce((sum, t) => sum + t.amount, 0) + (addedIsFubonJDomesticBonus ? addedAmount : 0);
            const bonusDom = Math.min(domesticBonusSpend, 10000) * 0.03;
            reward += bonusDom;
            return { spend: totalSpend, validSpend: totalSpend, reward: Math.round(reward), rate: "10.0", isCustom, cycleStart, cycleEnd };
        }

        if (cardId === 'j2') {
            const txList = [...relevantTx];
            if (addedAmount > 0) txList.push({ amount: addedAmount, isJiheJapan: addedIsJiheJapan, isJiheApple: addedIsJiheApple, isJiheDomesticJapanese: addedIsJiheDomesticJapanese });
            reward = txList.reduce((sum, t) => {
                if (t.isJiheJapan) return sum + (t.amount * 0.025);
                else return sum + (t.amount * 0.01);
            }, 0);
            const appleSpend = relevantTx.filter(t => t.isJiheApple).reduce((sum, t) => sum + t.amount, 0) + (addedIsJiheApple ? addedAmount : 0);
            const bonusApple = Math.min(appleSpend, 40000) * 0.015;
            reward += bonusApple;
            const domesticJpSpend = relevantTx.filter(t => t.isJiheDomesticJapanese).reduce((sum, t) => sum + t.amount, 0) + (addedIsJiheDomesticJapanese ? addedAmount : 0);
            const bonusDom = Math.min(domesticJpSpend, 12500) * 0.04;
            reward += bonusDom;
            return { spend: totalSpend, validSpend: totalSpend, reward: Math.round(reward), rate: "4.5", isCustom, cycleStart, cycleEnd };
        }

        if (cardId === 'j3') {
            const txList = [...relevantTx];
            if (addedAmount > 0) txList.push({ amount: addedAmount, isKumamonJapan: addedIsKumamonJapan, isKumamonDesignated: addedIsKumamonDesignated, isKumamonPayPay: addedIsKumamonPayPay, isKumamonDomesticGreen: addedIsKumamonDomesticGreen });
            reward = txList.reduce((sum, t) => {
                if (t.isKumamonJapan) return sum + (t.amount * 0.02);
                else return sum + (t.amount * 0.01);
            }, 0);
            const desigSpend = relevantTx.filter(t => t.isKumamonDesignated).reduce((sum, t) => sum + t.amount, 0) + (addedIsKumamonDesignated ? addedAmount : 0);
            const paypaySpend = relevantTx.filter(t => t.isKumamonPayPay).reduce((sum, t) => sum + t.amount, 0) + (addedIsKumamonPayPay ? addedAmount : 0);
            const domesticGreenSpend = relevantTx.filter(t => t.isKumamonDomesticGreen).reduce((sum, t) => sum + t.amount, 0) + (addedIsKumamonDomesticGreen ? addedAmount : 0);
            let bonusDesig = Math.min(desigSpend, 10000) * 0.065;
            let bonusPayPay = Math.min(paypaySpend, 10000) * 0.03;
            let bonusDom = Math.min(domesticGreenSpend, 10000) * 0.02;
            reward += (bonusDesig + bonusPayPay + bonusDom);
            return { spend: totalSpend, validSpend: totalSpend, reward: Math.round(reward), rate: "8.5", isCustom, cycleStart, cycleEnd };
        }

        if (cardId === 'j4') {
            const level = localStorage.getItem('currency_level') ||
            'low';
            const bonusCap = (level === 'high') ? 800 : 300;
            const txList = [...relevantTx];
            if (addedAmount > 0) txList.push({ amount: addedAmount, isSinopacCurrencySelected: addedIsSinopacCurrencySelected });
            
            let baseReward = 0;
            txList.forEach(t => {
                if(t.isSinopacCurrencySelected) baseReward += t.amount * 0.02;
                else baseReward += t.amount * 0.01;
            });
            const bonusTx = txList.filter(t => t.isSinopacCurrencySelected);
            const totalBonusSpend = bonusTx.reduce((sum, t) => sum + t.amount, 0);
            const actualBonus = Math.min(totalBonusSpend * 0.04, bonusCap);
            reward = baseReward + actualBonus;
            
            let displayRate = "1.0";
            if(addedIsSinopacCurrencySelected) {
                 const remainingCap = Math.max(0, bonusCap - (totalBonusSpend - addedAmount) * 0.04);
                 if (remainingCap > 0) displayRate = "6.0";
                 else displayRate = "2.0";
            }
            
            let statusText = `åŠ ç¢¼å‰© $${(bonusCap - actualBonus).toFixed(0)}`;
            if (actualBonus >= bonusCap) statusText = 'åŠ ç¢¼å·²å°é ‚';
            
            return { spend: totalSpend, validSpend: totalSpend, reward: Math.round(reward), rate: displayRate, isCustom, cycleStart, cycleEnd, msgDanger: statusText };
        }

        if (cardId === 'j5') {
            const baseReward = totalSpend * 0.003;
            const txList = [...relevantTx];
            if (addedAmount > 0) txList.push({ amount: addedAmount, isSinopacMitsuiSelected: addedIsSinopacMitsuiSelected });
            const selectedSpend = txList.filter(t => t.isSinopacMitsuiSelected).reduce((sum, t) => sum + t.amount, 0);
            const selectedBonus = Math.min(selectedSpend * 0.07, 100);
            const targetSpend = txList.filter(t => t.isSinopacMitsuiTarget).reduce((sum, t) => sum + t.amount, 0);
            let targetBonus = 0;
            if (targetSpend >= 30000) targetBonus = 2000;
            reward = baseReward + selectedBonus + targetBonus;
            let displayRate = "0.3";
            if (addedIsSinopacMitsuiSelected) {
                const effectiveBonus = Math.min(addedAmount * 0.07, Math.max(0, 100 - (selectedSpend - addedAmount) * 0.07));
                const effectiveRate = ((addedAmount * 0.003 + effectiveBonus) / addedAmount) * 100;
                displayRate = effectiveRate.toFixed(1);
            }
            if (addedIsSinopacMitsuiTarget && targetSpend >= 30000) { displayRate = "6.9";
            }
            return { spend: totalSpend, validSpend: totalSpend, reward: Math.round(reward), rate: displayRate, isCustom, cycleStart, cycleEnd };
        }
        
        if (cardId === 'c4') {
            const baseReward = totalSpend * 0.005;
            let bonusReward = 0;
            if (totalSpend >= 3000) {
                const txList = [...relevantTx];
                if(addedAmount > 0) txList.push({ amount: addedAmount, isJiangSelected: addedIsJiangSelected, isJiangTravel: addedIsJiangTravel });
                const selectedSpend = txList.filter(t => t.isJiangSelected).reduce((sum, t) => sum + t.amount, 0);
                const selectedBonus = Math.min(selectedSpend, 6666) * 0.045;
                const travelTx = txList.filter(t => t.isJiangTravel);
                let qualifiedTravelSpend = 0;
                const travelExpiry = new Date('2026-03-31T23:59:59');
                travelTx.forEach(t => {
                    const tDate = new Date(t.date || new Date());
                    if (tDate <= travelExpiry) qualifiedTravelSpend += t.amount;
                });
                const travelBonus = Math.min(qualifiedTravelSpend, 11111) * 0.045;
                bonusReward = selectedBonus + travelBonus;
            }
            reward = baseReward + bonusReward;
            let displayRate = "0.5";
            if (totalSpend >= 3000) {
                if (addedIsJiangSelected) displayRate = "5.0";
                if (addedIsJiangTravel) displayRate = "5.0";
            }
            return { spend: totalSpend, validSpend: totalSpend, reward: Math.round(reward), rate: displayRate, isCustom, cycleStart, cycleEnd };
        }

        if (cardId === 'c8') {
            if (totalSpend < 3000) {
                reward = totalSpend * 0.005;
                return { spend: totalSpend, validSpend: totalSpend, reward: Math.round(reward), rate: "0.5", isCustom, cycleStart, cycleEnd };
            } else {
                let baseReward = totalSpend * 0.005;
                const petSpend = relevantTx.filter(t => t.isHappyPet).reduce((sum, t) => sum + t.amount, 0) + (addedIsHappyPet ? addedAmount : 0);
                const lifeSpend = relevantTx.filter(t => t.isHappyLife).reduce((sum, t) => sum + t.amount, 0) + (addedIsHappyLife ? addedAmount : 0);
                const peaceSpend = relevantTx.filter(t => t.isHappyPeace).reduce((sum, t) => sum + t.amount, 0) + (addedIsHappyPeace ? addedAmount : 0);
                const foreignSpend = relevantTx.filter(t => t.isHappyForeign).reduce((sum, t) => sum + t.amount, 0) + (addedIsHappyForeign ? addedAmount : 0);
                const bonusPet = Math.min(petSpend, 5263) * 0.095;
                // ä¿®æ­£ï¼šç”Ÿæ´»/å®‰å¿ƒåˆ· 3.5% (ä¸Šé™$5714)
                const bonusLife = Math.min(lifeSpend, 5714) * 0.035;
                const bonusPeace = Math.min(peaceSpend, 5714) * 0.035;
                const bonusForeign = foreignSpend * 0.02;
                reward = baseReward + bonusPet + bonusLife + bonusPeace + bonusForeign;
                if(totalSpend >= 26000) reward += 400;
                let displayRate = "0.5";
                if (addedIsHappyPet) displayRate = "10.0";
                else if (addedIsHappyLife || addedIsHappyPeace) displayRate = "4.0";
                else if (addedIsHappyForeign) displayRate = "2.5";
                return { spend: totalSpend, validSpend: totalSpend, reward: Math.round(reward), rate: displayRate, isCustom, cycleStart, cycleEnd };
            }
        }
        
        if (cardId === 'c2') {
            if (totalSpend < 12000) {
                reward = totalSpend * 0.01;
                return { spend: totalSpend, validSpend: totalSpend, reward: Math.round(reward), rate: "1.0", isCustom, cycleStart, cycleEnd };
            } else {
                let baseReward = totalSpend * 0.01;
                const greenSpend = relevantTx.filter(t => t.isGreen).reduce((sum, t) => sum + t.amount, 0) + (addedIsGreen ? addedAmount : 0);
                const foreignSpend = relevantTx.filter(t => t.isForeign).reduce((sum, t) => sum + t.amount, 0) + (addedIsForeign ? addedAmount : 0);
                const bonusGreen = Math.min(greenSpend, 2500) * 0.05;
                const bonusForeign = foreignSpend * 0.01;
                reward = baseReward + bonusGreen + bonusForeign;
                return { spend: totalSpend, validSpend: totalSpend, reward: Math.round(reward), rate: "6.0", isCustom, cycleStart, cycleEnd };
            }
        }
        
        if (cardId === 'c7') {
            const isUpMode = addedIsUniUp ||
            relevantTx.some(t => t.isUniUp);
            let currentRate = 0.035; 
            let currentCap = 40000;
            if (isUpMode) {
                currentRate = 0.045;
                currentCap = 142857; 
            }
            let baseReward = 0;
            if (totalSpend <= currentCap) {
                baseReward = totalSpend * currentRate;
            } else {
                baseReward = (currentCap * currentRate) + ((totalSpend - currentCap) * 0.01);
            }
            const bonusSpend = relevantTx.filter(t => t.isUniBonus).reduce((sum, t) => sum + t.amount, 0) + (addedIsUniBonus ? addedAmount : 0);
            const bonusReward = Math.min(bonusSpend, 16666) * 0.03;
            reward = baseReward + bonusReward;
            return { spend: totalSpend, validSpend: totalSpend, reward: Math.round(reward), rate: (currentRate*100).toFixed(1), isCustom, cycleStart, cycleEnd };
        }
        
        if (cardId === 'c6') {
            const bonus10TxSpend = relevantTx.filter(t => t.isBonus10).reduce((sum, t) => sum + t.amount, 0) + (addedIsBonus10 ? addedAmount : 0);
            const bonus10Reward = Math.min(bonus10TxSpend, 8000) * 0.10;
            // ä¿®æ­£ï¼šç²¾é¸é€šè·¯ 2.5% (ä¸Šé™40è¬)
            const bonus25TxSpend = relevantTx.filter(t => t.isBonus25).reduce((sum, t) => sum + t.amount, 0) + (addedIsBonus25 ? addedAmount : 0);
            const selectedReward = Math.min(bonus25TxSpend, 400000) * 0.025;
            
            let baseReward = relevantTx.reduce((sum, t) => sum + (t.amount * (t.isBill ? 0.0015 : 0.01)), 0);
            if (addedAmount > 0) baseReward += addedAmount * (addedIsBill ? 0.0015 : 0.01);
            
            reward = baseReward + selectedReward + bonus10Reward;
            
            let currentRate = 13.5;
            if (totalSpend > 0) currentRate = (reward / totalSpend) * 100;
            return { spend: totalSpend, validSpend: totalSpend, reward: Math.round(reward), rate: currentRate.toFixed(1), isCustom, cycleStart, cycleEnd };
        }

        if (cardId === 'c10') {
            const currentOverseasSpend = relevantTx.filter(t => t.isUniOverseas).reduce((sum, t) => sum + t.amount, 0) + (addedIsUniOverseas ? addedAmount : 0);
            const overseasReward = (currentOverseasSpend * 0.03) + Math.min(currentOverseasSpend, 6250) * 0.08;
            
            const icashSpend = relevantTx.filter(t => t.isUniIcash && !t.isUniOverseas).reduce((sum, t) => sum + t.amount, 0) + (addedIsUniIcash && !addedIsUniOverseas ? addedAmount : 0);
            const icashReward = Math.min(icashSpend, 3750) * 0.04;
            
            const groupTx = relevantTx.filter(t => t.isUniGroup && !t.isUniOverseas);
            let currentGroupSpend = groupTx.reduce((sum, t) => sum + t.amount, 0);
            if (addedIsUniGroup && !addedIsUniOverseas) currentGroupSpend += addedAmount;
            const groupBonus = Math.min(currentGroupSpend, 25000) * 0.02;
            
            const savedState = JSON.parse(localStorage.getItem('uniOpenState') || '{"brands":[]}');
            const count = savedState.brands ?
            savedState.brands.length : 0;
            let taskRate = 0;
            if (count >= 5) taskRate = 0.04;
            else if (count === 4) taskRate = 0.03;
            else if (count === 3) taskRate = 0.02;
            else if (count === 2) taskRate = 0.01;
            const taskBonus = Math.min(currentGroupSpend, 12500) * taskRate;
            
            const domesticSpend = totalSpend - currentOverseasSpend;
            const baseDomesticReward = domesticSpend * 0.01;
            reward = overseasReward + baseDomesticReward + groupBonus + taskBonus + icashReward;
            
            let displayRate = 1.0;
            if (addedIsUniOverseas) displayRate = 11.0;
            else if (addedIsUniGroup) {
                displayRate = 3.0;
                if (addedIsUniIcash) displayRate += 4.0;
                displayRate += (taskRate * 100);
            }
            return { spend: totalSpend, validSpend: totalSpend, reward: Math.round(reward), rate: displayRate.toFixed(1), isCustom, cycleStart, cycleEnd };
        }

        if (cardId === 'c11') {
            const richartPaySpend = relevantTx.filter(t => t.isRichartPay).reduce((sum, t) => sum + t.amount, 0) + (addedIsRichartPay ? addedAmount : 0);
            const richartOnlineSpend = relevantTx.filter(t => t.isRichartOnline).reduce((sum, t) => sum + t.amount, 0) + (addedIsRichartOnline ? addedAmount : 0);
            const richartLineSpend = relevantTx.filter(t => t.isRichartLine).reduce((sum, t) => sum + t.amount, 0) + (addedIsRichartLine ? addedAmount : 0);
            const richartOverseasSpend = relevantTx.filter(t => t.isRichartOverseas).reduce((sum, t) => sum + t.amount, 0) + (addedIsRichartOverseas ? addedAmount : 0);
            const normalSpend = Math.max(0, totalSpend - richartPaySpend - richartOnlineSpend - richartLineSpend - richartOverseasSpend);
            reward = (richartPaySpend * 0.038) + (richartOnlineSpend * 0.033) + (richartLineSpend * 0.023) + (richartOverseasSpend * 0.033) + (normalSpend * 0.003);
            let currentRate = 0.3;
            if(totalSpend > 0) currentRate = (reward / totalSpend) * 100;
            else if(addedIsRichartPay) currentRate = 3.8;
            else if(addedIsRichartOnline) currentRate = 3.3;
            else if(addedIsRichartLine) currentRate = 2.3;
            else if(addedIsRichartOverseas) currentRate = 3.3;
            return { spend: totalSpend, validSpend: totalSpend, reward: Math.round(reward), rate: currentRate.toFixed(1), isCustom, cycleStart, cycleEnd };
        }

        if (cardId === 'c9') {
            const tier = localStorage.getItem('hsbc_tier') ||
            'infinite';
            let rateDomestic = 18; let rateForeign = 10; if (tier === 'signature') { rateDomestic = 18; rateForeign = 15;
            }
            let totalMiles = parseInt(localStorage.getItem('hsbc_initial_miles') || 0);
            let redeemedMiles = parseInt(localStorage.getItem('hsbc_redeemed_miles') || 0);
            const allHistoryTx = transactions.filter(t => t.cardId === 'c9');
            allHistoryTx.forEach(tx => { const rate = tx.isHsbcForeign ? rateForeign : rateDomestic; totalMiles += Math.floor(tx.amount / rate); });
            if (addedAmount > 0) { const currentRate = addedIsHsbcForeign ? rateForeign : rateDomestic; totalMiles += Math.floor(addedAmount / currentRate);
            }
            reward = totalMiles - redeemedMiles;
            // ä¿®æ­£ï¼šcalculateStats åƒ…è¨ˆç®—æœ¬æœŸï¼Œæ­¤è™•è¨ˆç®—ä¾› grid ä½¿ç”¨
            let cycleReward = 0; // æš«æ™‚è®Šæ•¸
            const { start, end } = getBillingCycle(cardId);
            const cycleTx = transactions.filter(t => {
                const tDate = new Date(t.date);
                return t.cardId === 'c9' && tDate >= start && tDate <= end;
            });
            cycleTx.forEach(tx => {
                 const rate = tx.isHsbcForeign ? rateForeign : rateDomestic;
                 cycleReward += Math.floor(tx.amount / rate);
            });
            if(addedAmount > 0) {
                 const currentRate = addedIsHsbcForeign ? rateForeign : rateDomestic;
                 cycleReward += Math.floor(addedAmount / currentRate);
            }
            return { spend: totalSpend, validSpend: totalSpend, reward: cycleReward, rate: (totalSpend>0?(totalSpend/totalMiles).toFixed(1):0), isCustom, cycleStart, cycleEnd };
        }
        
        let validSpend = totalSpend;
        if (card.type === 'mixed') { if (validSpend < card.minSpend) reward = validSpend * card.tier2Rate;
        else if (validSpend <= card.limit) reward = validSpend * card.tier1Rate;
        else reward = (card.limit * card.tier1Rate) + ((validSpend - card.limit) * card.tier2Rate);
        } 
        else if (card.type === 'ceiling') { if (validSpend <= card.limit) reward = validSpend * card.tier1Rate;
        else reward = (card.limit * card.tier1Rate) + ((validSpend - card.limit) * card.tier2Rate);
        } 
        else { reward = validSpend * (card.tier1Rate || 0);
        }
        let currentRate = (card.tier1Rate || 0)*100;
        if(totalSpend>0) currentRate = (reward/totalSpend)*100;
        return { spend: totalSpend, validSpend: validSpend, reward: Math.round(reward), rate: currentRate.toFixed(1), isCustom, cycleStart, cycleEnd };
    }

    function toggleBillLogic() { const isBill = document.getElementById('checkIsBill').checked; document.getElementById('labelBaseRate').innerText = isBill ?
    "ğŸ”° åŸºæœ¬å›é¥‹ 0.15% (ç„¡ä¸Šé™)" : "ğŸ”° åŸºæœ¬å›é¥‹ 1% (ç„¡ä¸Šé™)"; if(isBill) document.getElementById('checkBonus25').checked = false; updateRewardPreview();
    }
    function toggleSelectedLogic() { const isSelected = document.getElementById('checkBonus25').checked; document.getElementById('labelBaseRate').innerText = isSelected ?
    "ğŸ”° åŸºæœ¬å›é¥‹ 1% (ç„¡ä¸Šé™)" : "ğŸ”° åŸºæœ¬å›é¥‹ 1% (ç„¡ä¸Šé™)"; if(isSelected) document.getElementById('checkIsBill').checked = false; updateRewardPreview();
    }
    function toggleGreenLogic() { if(document.getElementById('checkGreenChannel').checked) document.getElementById('checkForeign').checked = false; updateRewardPreview();
    }
    function toggleForeignLogic() { if(document.getElementById('checkForeign').checked) document.getElementById('checkGreenChannel').checked = false; updateRewardPreview();
    }
    function toggleHappyPet() { if(document.getElementById('checkHappyPet').checked) { document.getElementById('checkHappyPeace').checked = false; document.getElementById('checkHappyLife').checked = false; document.getElementById('checkHappyForeign').checked = false; } updateRewardPreview();
    }
    function toggleHappyPeace() { if(document.getElementById('checkHappyPeace').checked) { document.getElementById('checkHappyPet').checked = false; document.getElementById('checkHappyLife').checked = false; document.getElementById('checkHappyForeign').checked = false; } updateRewardPreview();
    }
    function toggleHappyLife() { if(document.getElementById('checkHappyLife').checked) { document.getElementById('checkHappyPet').checked = false; document.getElementById('checkHappyPeace').checked = false; document.getElementById('checkHappyForeign').checked = false; } updateRewardPreview();
    }
    function toggleHappyForeign() { if(document.getElementById('checkHappyForeign').checked) { document.getElementById('checkHappyPet').checked = false; document.getElementById('checkHappyPeace').checked = false; document.getElementById('checkHappyLife').checked = false; } updateRewardPreview();
    }
    function toggleRichartLogic() { updateRewardPreview(); }

    function updateRewardPreview() {
        const inputVal = document.getElementById('amountInput').value;
        const amount = parseFloat(inputVal);
        const previewDiv = document.getElementById('liveRewardCalc');
        const cardId = document.getElementById('cardIdInput').value;
        if (!amount || amount <= 0) { previewDiv.style.display = 'none'; return;
        }
        previewDiv.style.display = 'block'; 
        
        let isGreen = document.getElementById('checkGreenChannel') ? document.getElementById('checkGreenChannel').checked : false;
        let isForeign = document.getElementById('checkForeign') ? document.getElementById('checkForeign').checked : false;
        let isUniUp = document.getElementById('checkUniUp') ? document.getElementById('checkUniUp').checked : false;
        let isUniBonus = document.getElementById('checkUniBonus') ? document.getElementById('checkUniBonus').checked : false;
        let isHappyPet = document.getElementById('checkHappyPet') ? document.getElementById('checkHappyPet').checked : false;
        let isHappyPeace = document.getElementById('checkHappyPeace') ? document.getElementById('checkHappyPeace').checked : false;
        let isHappyLife = document.getElementById('checkHappyLife') ? document.getElementById('checkHappyLife').checked : false;
        let isHappyForeign = document.getElementById('checkHappyForeign') ? document.getElementById('checkHappyForeign').checked : false;
        let isHsbcForeign = document.getElementById('checkHsbcForeign') ? document.getElementById('checkHsbcForeign').checked : false;
        let isUniGroup = document.getElementById('checkUniGroup') ? document.getElementById('checkUniGroup').checked : false;
        let isUniIcash = document.getElementById('checkUniIcash') ? document.getElementById('checkUniIcash').checked : false;
        let isUniOverseas = document.getElementById('checkUniOverseas') ? document.getElementById('checkUniOverseas').checked : false;
        let richartMode = document.querySelector('input[name="richartMode"]:checked') ? document.querySelector('input[name="richartMode"]:checked').value : 'general';
        let isRichartPay = richartMode === 'pay';
        let isRichartOnline = richartMode === 'online';
        let isRichartLine = richartMode === 'line';
        let isRichartOverseas = richartMode === 'overseas';
        
        let isBonus10 = document.getElementById('checkBonus10') ? document.getElementById('checkBonus10').checked : false;
        let isBonus25 = document.getElementById('checkBonus25') ?
        document.getElementById('checkBonus25').checked : false;
        let isBill = document.getElementById('checkIsBill') ? document.getElementById('checkIsBill').checked : false;
        let isFubonJJapan = document.getElementById('checkFubonJJapan') ? document.getElementById('checkFubonJJapan').checked : false;
        let isFubonJPhysical = document.getElementById('checkFubonJPhysical') ? document.getElementById('checkFubonJPhysical').checked : false;
        let isFubonJDomesticBonus = document.getElementById('checkFubonJDomesticBonus') ? document.getElementById('checkFubonJDomesticBonus').checked : false;
        let isJiheJapan = document.getElementById('checkJiheJapan') ? document.getElementById('checkJiheJapan').checked : false;
        let isJiheApple = document.getElementById('checkJiheApple') ? document.getElementById('checkJiheApple').checked : false;
        let isJiheDomesticJapanese = document.getElementById('checkJiheDomesticJapanese') ? document.getElementById('checkJiheDomesticJapanese').checked : false;
        let isKumamonJapan = document.getElementById('checkKumamonJapan') ? document.getElementById('checkKumamonJapan').checked : false;
        let isKumamonDesignated = document.getElementById('checkKumamonDesignated') ? document.getElementById('checkKumamonDesignated').checked : false;
        let isKumamonPayPay = document.getElementById('checkKumamonPayPay') ? document.getElementById('checkKumamonPayPay').checked : false;
        let isKumamonDomesticGreen = document.getElementById('checkKumamonDomesticGreen') ? document.getElementById('checkKumamonDomesticGreen').checked : false;
        let isSinopacCurrencyOverseas = document.getElementById('checkSinopacCurrencyOverseas') ? document.getElementById('checkSinopacCurrencyOverseas').checked : false;
        let isSinopacCurrencySelected = document.getElementById('checkSinopacCurrencySelected') ? document.getElementById('checkSinopacCurrencySelected').checked : false;
        let isSinopacMitsuiSelected = document.getElementById('checkSinopacMitsuiSelected') ? document.getElementById('checkSinopacMitsuiSelected').checked : false;
        let isSinopacMitsuiTarget = document.getElementById('checkSinopacMitsuiTarget') ? document.getElementById('checkSinopacMitsuiTarget').checked : false;
        let isSinopacMitsuiDining = document.getElementById('checkSinopacMitsuiDining') ? document.getElementById('checkSinopacMitsuiDining').checked : false;
        let jiangMode = document.querySelector('input[name="jiangMode"]:checked') ? document.querySelector('input[name="jiangMode"]:checked').value : 'base';
        let isJiangSelected = jiangMode === 'selected';
        let isJiangTravel = jiangMode === 'travel';
        let currencyType = document.querySelector('input[name="currencyType"]:checked') ? document.querySelector('input[name="currencyType"]:checked').value : 'domestic';
        let isSinopacCurrencySelectedFinal = (currencyType === 'selected');
        let isSinopacCurrencyOverseasFinal = (currencyType === 'selected');
        const currentStats = calculateStats(cardId, 0);
        const newStats = calculateStats(cardId, amount, isGreen, isForeign, isUniBonus, isUniUp, isHappyPet, isHappyLife, isHappyForeign, isHappyPeace, isHsbcForeign, isUniGroup, isUniIcash, isUniOverseas, isRichartPay, isRichartOnline, isRichartLine, isRichartOverseas, isBonus10, isBonus25, isBill,
            isFubonJJapan, isFubonJPhysical, isFubonJDomesticBonus,
            isJiheJapan, isJiheApple, isJiheDomesticJapanese,
            isKumamonJapan, isKumamonDesignated, isKumamonPayPay, isKumamonDomesticGreen,
            isSinopacCurrencyOverseasFinal, isSinopacCurrencySelectedFinal,
            isSinopacMitsuiSelected, isSinopacMitsuiTarget, isSinopacMitsuiDining,
            isJiangSelected, isJiangTravel);
        const thisTransactionReward = newStats.reward - currentStats.reward;
        if (cardId === 'c9') { 
            previewDiv.innerHTML = `âœ¨ é è¨ˆå›é¥‹ï¼š${thisTransactionReward} å“©`;
        } else { 
            const effectiveRate = (thisTransactionReward / amount) * 100;
            if (effectiveRate > 20) {
                previewDiv.innerHTML = `âœ¨ é è¨ˆå›é¥‹ï¼š$${thisTransactionReward} (å«é”æ¨™å›æº¯)`;
            } else {
                previewDiv.innerHTML = `âœ¨ é è¨ˆå›é¥‹ï¼š$${thisTransactionReward} (${effectiveRate.toFixed(1)}%)`;
            }
        }
    }

    function renderGrid() {
        const container = document.getElementById('card-grid');
        let monthTotalReward = 0; container.innerHTML = '';
        cards.forEach(card => { if (card.type === 'placeholder') return; const stats = calculateStats(card.id); if (card.id !== 'c9') monthTotalReward += (Number(stats.reward) || 0); });
        document.getElementById('totalRewardDisplay').innerText = `$${monthTotalReward.toLocaleString()}`;
        const displayCards = getSortedCards();

        displayCards.forEach(card => {
            const stats = calculateStats(card.id); 
            let percent = 0, statusText = '', msgStyle = '';
            let displayRate = `${stats.rate}%`;

            if (card.id === 'c10') {
                statusText = `æœ¬æœˆå·²è³º ${stats.reward} é»`;
                const savedState = JSON.parse(localStorage.getItem('uniOpenState') || '{}');
                if (savedState.icash) {
                    const icashSpend = transactions.filter(t => t.cardId === 'c10' && t.isUniIcash).reduce((sum, t) => sum + t.amount, 0);
                    if (icashSpend >= 3750) { msgStyle = 'color:#d32f2f;'; 
                    statusText = 'icashå›é¥‹å·²æ»¿'; }
                }
            } else if (card.id === 'c9') {
                const tier = localStorage.getItem('hsbc_tier') || 'infinite';
                card.name = (tier === 'infinite') ? 'æ»™è±æ—…äººç„¡é™å¡' 
                : 'æ»™è±æ—…äººå¾¡ç’½å¡';
                card.note = (tier === 'infinite') ? 'åœ‹å…§18/åœ‹å¤–10 (å“©)' : 'åœ‹å…§18/åœ‹å¤–15 (å“©)';
                
                // ä¸»ç•«é¢é¡¯ç¤ºç¸½å“©ç¨‹
                let totalMiles = parseInt(localStorage.getItem('hsbc_initial_miles') || 0);
                let redeemedMiles = parseInt(localStorage.getItem('hsbc_redeemed_miles') || 0);
                const allHistoryTx = transactions.filter(t => t.cardId === 'c9');
                const rateDomestic = (tier === 'infinite') ? 18 : 18;
                const rateForeign = (tier === 'infinite') ? 10 : 15;
                
                allHistoryTx.forEach(tx => { 
                    const rate = tx.isHsbcForeign ? rateForeign : rateDomestic; 
                    totalMiles += Math.floor(tx.amount / rate); 
                });
                const finalTotal = Math.max(0, totalMiles - redeemedMiles);
                
                statusText = `ç¸½å“©ç¨‹ ${finalTotal.toLocaleString()} å“©`;
                msgStyle = 'color: #007AFF; font-weight:bold;';
            } else if (card.id === 'c8') { 
                if (stats.spend < 3000) { 
                    percent = (stats.spend / 3000) * 100;
                    statusText = `å·® $${(3000 - stats.spend).toLocaleString()} å‡ç´šå›é¥‹`;
                    msgStyle = 'color: #FFD700;';
                } 
                else if (stats.spend < 26000) { percent = (stats.spend / 26000) * 100;
                statusText = `å·® $${(26000 - stats.spend).toLocaleString()} é ˜æ»¿é¡ç¦®`; } 
                else { percent = 100;
                statusText = 'ğŸ‰ æ»¿é¡é”æ¨™ (è¨˜å¾—ç™»éŒ„!)'; msgStyle = 'color: #38ef7d;'; }
            } else if (card.type === 'mixed') { 
                if (stats.validSpend < card.minSpend) { 
                    percent = (stats.validSpend / card.minSpend) * 100;
                    statusText = `âš ï¸ å·® $${(card.minSpend - stats.validSpend).toLocaleString()} å•Ÿå‹•åŠ ç¢¼`;
                    msgStyle = 'color: #FFD700; font-weight: bold;';
                }
                else if (stats.validSpend <= card.limit) { 
                    percent = (stats.validSpend / card.limit) * 100;
                    const remain = card.limit - stats.validSpend; 
                    statusText = `å‰© $${remain.toLocaleString()} (5%)`;
                }
                else { percent = 100;
                statusText = 'å·²å°é ‚ (è®Š0.5%)'; msgStyle = 'color: #ffcccc;'; }
            } else if (card.type === 'ceiling' || card.id === 'c6' || card.id === 'j1' || card.id === 'j2' || card.id === 'j3' || card.id === 'j4') {
                percent = (stats.validSpend / card.limit) * 100;
                if (stats.validSpend <= card.limit) { const remain = card.limit - stats.validSpend; statusText = `å‰© $${remain.toLocaleString()}`;
                if(remain < 1000) {statusText = `âš ï¸ å‰© $${remain.toLocaleString()}`; msgStyle='color:#FFD700;';} }
                else { percent = 100;
                statusText = card.msgDanger; msgStyle = 'color: #ffcccc;'; }
            } else { percent = (stats.validSpend / card.target) * 100;
            statusText = stats.validSpend >= card.target ? 'ä»»å‹™é”æˆ' : `å·® $${(card.target - stats.validSpend).toLocaleString()}`;
            }

            if (card.id === 'c6') displayRate = '13.5%';
            if (card.id === 'c1') displayRate = '10.0%';
            if (card.id === 'c5') displayRate = '6.0%';
            if (card.id === 'c3') displayRate = '5.0%';
            if (card.id === 'c4') displayRate = '5.0%';
            if (card.id === 'c2') displayRate = '6.0%';
            if (card.id === 'c7') displayRate = '4.5%';
            if (card.id === 'c8') displayRate = '10.0%';
            if (card.id === 'c9') displayRate = 'å“©ç¨‹';
            if (card.id === 'c10') displayRate = '11.0%';
            if (card.id === 'c11') displayRate = '3.8%';
            if (card.id === 'j1') displayRate = '10.0%';
            if (card.id === 'j2') displayRate = '4.5%';
            if (card.id === 'j3') displayRate = '8.5%';
            if (card.id === 'j4') displayRate = '6.0%';
            if (card.id === 'j5') displayRate = '7.3%';
            if (card.type === 'placeholder') displayRate = '--%';
            
            let tileClass = 'card-tile';
            let nickClass = 'tile-nickname-badge';
            if (card.type === 'placeholder') nickClass += ' placeholder';
            const tile = document.createElement('div'); tile.className = tileClass;
            tile.setAttribute('data-card-id', card.id);
            tile.style.background = card.gradient;
            tile.style.color = card.textColor; 
            tile.onclick = () => card.type === 'placeholder' ? openManageModal() : openQuickAdd(card.id);
            let earnedText = `+$${stats.reward.toLocaleString()}`;
            if (card.id === 'c9') {
                earnedText = `+${stats.reward.toLocaleString()} å“©`; // ä¸»ç•«é¢ tile ä»é¡¯ç¤ºæœ¬æœˆç²å¾—
            }
            if (card.id === 'c11') displayRate = '3.8%';
            let cycleHint = '';
            if (stats.isCustom) {
                cycleHint = `<div class="tile-cycle-hint">é€±æœŸ: ${stats.cycleStart.getMonth()+1}/${stats.cycleStart.getDate()}-${stats.cycleEnd.getMonth()+1}/${stats.cycleEnd.getDate()}</div>`;
            }

            tile.innerHTML = `<div class="tile-header"><span class="tile-name">${card.name}</span><span class="rate-badge" style="color:black">${displayRate}</span></div><div class="${nickClass}">${card.nickname}</div><span class="tile-note" style="color:${card.textColor==='white'?'rgba(255,255,255,0.8)':'rgba(0,0,0,0.6)'}">${card.note}</span><div class="tile-body"><div class="tile-stat">$${stats.spend.toLocaleString()}</div><div class="tile-earned">${earnedText}</div></div><div class="tile-footer"><div class="progress-track"><div class="progress-fill" style="width:${Math.min(percent, 100)}%"></div></div><div class="tile-msg" style="${msgStyle}">${statusText}</div>${cycleHint}</div>`;
            container.appendChild(tile);
        });
        checkUrgentTasks(); initSortable();
    }
    
    function openManageModal() {
        const list = document.getElementById('manageCardList');
        list.innerHTML = '';
        const realCardIds = ['c6', 'c1', 'c5', 'c3', 'c4', 'c2', 'c7', 'c8', 'c9', 'c10', 'c11', 'j1', 'j2', 'j3', 'j4', 'j5'];
        const currentRealCardsCount = visibleCards.filter(id => realCardIds.includes(id)).length;
        cards.forEach(card => {
            if (card.id === 'add1') return; 
            const isVisible = visibleCards.includes(card.id);
            const item = document.createElement('div'); item.className = 'manage-item';
            
            const settingBtn = document.createElement('button');
            settingBtn.className = 'btn-card-setting';
            settingBtn.innerHTML = 'âš™ï¸';
            settingBtn.onclick = (e) => { e.stopPropagation(); editCardSettings(card.id); };

            const label = document.createElement('label'); label.className = 'switch'; label.onclick = function(e) { e.stopPropagation(); }; 
            const input = document.createElement('input'); input.type = 'checkbox'; input.checked = isVisible;
            input.onchange = function() { if (this.checked && currentRealCardsCount >= 8) 
            { alert('âš ï¸ æœ€å¤šåªèƒ½é¡¯ç¤º 8 å¼µå¡ç‰‡ï¼Œè«‹å…ˆéš±è—ä¸€å¼µï¼'); this.checked = false; return; } toggleCardVisibility(card.id); };
            const slider = document.createElement('span');
            slider.className = 'slider'; label.appendChild(input); label.appendChild(slider);
            
            item.onclick = function(e) { if (e.target.tagName === 'INPUT' || e.target.tagName === 'BUTTON') return;
            const checkbox = this.querySelector('input[type="checkbox"]'); if (!checkbox.checked && currentRealCardsCount >= 8) { alert('âš ï¸ æœ€å¤šåªèƒ½é¡¯ç¤º 8 å¼µå¡ç‰‡ï¼Œè«‹å…ˆéš±è—ä¸€å¼µï¼'); return; } checkbox.checked = !checkbox.checked;
            toggleCardVisibility(card.id); };

            item.innerHTML = `<div class="manage-info"><div class="manage-name">${card.name}</div><div class="manage-desc">${card.nickname}</div></div>`; 
            item.appendChild(settingBtn);
            item.appendChild(label); 
            list.appendChild(item);
        });
        document.getElementById('manageModal').style.display = 'flex';
    }

    function editCardSettings(cardId) {
        const current = cardSettings[cardId] || {};
        const bDay = prompt('è«‹è¼¸å…¥æ­¤å¡ç‰‡çš„ã€Œçµå¸³æ—¥ã€ (1-31)\n\nä¾‹å¦‚ï¼šè‹¥å¸³å–®é€±æœŸç‚º 1/17~2/16ï¼Œè«‹è¼¸å…¥ 17ã€‚\nè‹¥è¼¸å…¥ 1 æˆ–ä¸è¼¸å…¥ï¼Œå‰‡ä»£è¡¨æ¯æœˆ 1 è™Ÿé–‹å§‹ã€‚', current.billingDay || '');
        if (bDay !== null) {
            const dayNum = parseInt(bDay);
            if (!isNaN(dayNum) && dayNum >= 1 && dayNum <= 31) {
                cardSettings[cardId] = { billingDay: dayNum };
            } else {
                delete cardSettings[cardId];
            }
            localStorage.setItem('cardSettings', JSON.stringify(cardSettings));
            renderGrid();
            alert('âœ… è¨­å®šå·²æ›´æ–°ï¼');
        }
    }
    
    function toggleCardVisibility(cardId) {
        if (visibleCards.includes(cardId)) { visibleCards = visibleCards.filter(id => id !== cardId);
        const realCardsCount = visibleCards.filter(id => id !== 'add1').length; if (realCardsCount < 8 && !visibleCards.includes('add1')) { visibleCards.push('add1');
        } } 
        else { visibleCards.push(cardId);
        if (visibleCards.includes('add1')) { visibleCards = visibleCards.filter(id => id !== 'add1');
        } }
        localStorage.setItem('visibleCards', JSON.stringify(visibleCards)); openManageModal(); renderGrid();
    }

    function openQuickAdd(cardId) {
        const card = cards.find(c => c.id === cardId);
        document.getElementById('modalTitle').innerText = card.name; 
        document.getElementById('modalSubtitle').innerText = card.note;
        
        if (cardId === 'c10') {
            document.getElementById('modalSubtitle').style.display = 'none';
        } else {
            document.getElementById('modalSubtitle').style.display = 'block';
        }

        document.getElementById('cardIdInput').value = cardId;
        const now = new Date();
        const day = String(now.getDate()).padStart(2, '0');
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const year = now.getFullYear();
        const today = `${year}-${month}-${day}`;
        document.getElementById('dateInput').value = today;
        
        editingId = null;
        document.getElementById('btn-confirm').innerText = "ç¢ºèª";
        document.getElementById('transactionModal').style.display = 'flex';
        const allOptionIds = ['pigRichOptions', 'greenCardOptions', 'uniOptions', 'happyOptions', 'hsbcOptions', 'uniOpenOptions', 'richartOptions', 'fubonJOptions', 'jiheOptions', 'kumamonOptions', 'sinopacCurrencyOptions', 'sinopacMitsuiOptions', 'jiangOptions'];
        allOptionIds.forEach(id => { document.getElementById(id).style.display = 'none'; });

        if (cardId === 'c6') document.getElementById('pigRichOptions').style.display = 'block';
        if (cardId === 'c2') document.getElementById('greenCardOptions').style.display = 'block';
        if (cardId === 'c7') {
             document.getElementById('uniOptions').style.display = 'block';
             toggleUniUpLogic(); 
        }
        if (cardId === 'c8') document.getElementById('happyOptions').style.display = 'block';
        if (cardId === 'c9') document.getElementById('hsbcOptions').style.display = 'block';
        if (cardId === 'c10') {
            document.getElementById('uniOpenOptions').style.display = 'block';
            const savedState = JSON.parse(localStorage.getItem('uniOpenState') || '{}');
            document.getElementById('checkUniGroup').checked = !!savedState.group;
            document.getElementById('checkUniIcash').checked = !!savedState.icash;
            document.getElementById('checkUniOverseas').checked = !!savedState.overseas;
            initUniBrandGrid();
            if(savedState.brands) {
                const btns = document.querySelectorAll('.brand-btn');
                btns.forEach(btn => {
                    if(savedState.brands.includes(btn.innerText)) btn.classList.add('active');
                });
            }
            const count = savedState.brands ? savedState.brands.length : 0;
            updateTaskBonusDisplay(count);
        }
        
        if (cardId === 'c11') {
            document.getElementById('richartOptions').style.display = 'block';
            document.getElementById('rbRichartGeneral').checked = true;
        }

        if (cardId === 'j1') { document.getElementById('fubonJOptions').style.display = 'block'; toggleFubonJLogic();
        }
        if (cardId === 'j2') { document.getElementById('jiheOptions').style.display = 'block'; toggleJiheLogic();
        }
        if (cardId === 'j3') { document.getElementById('kumamonOptions').style.display = 'block'; toggleKumamonLogic();
        }
        if (cardId === 'j4') { 
            document.getElementById('sinopacCurrencyOptions').style.display = 'block';
            document.querySelector('input[name="currencyType"][value="domestic"]').checked = true;
            toggleCurrencyLogic(); 
        }
        if (cardId === 'j5') { document.getElementById('sinopacMitsuiOptions').style.display = 'block';
        }
        
        if (cardId === 'c4') {
            document.getElementById('jiangOptions').style.display = 'block';
            document.querySelector('input[name="jiangMode"][value="base"]').checked = true;
            const today = new Date();
            const expiry = new Date('2026-03-31T23:59:59');
            const travelRow = document.getElementById('jiangTravelRow');
            const travelMsg = document.getElementById('jiangTravelExpMsg');
            const travelCheck = document.getElementById('rbJiangTravel');
            
            if (today > expiry) {
                travelRow.classList.add('expired');
                travelCheck.disabled = true;
                travelCheck.checked = false;
                travelMsg.style.display = 'block';
            } else {
                travelRow.classList.remove('expired');
                travelCheck.disabled = false;
                travelMsg.style.display = 'none';
            }
        }

        if (card.parking) { document.getElementById('modalParkingInfo').innerHTML = card.parking;
        document.getElementById('modalParkingInfo').style.display = 'block';
        } else { document.getElementById('modalParkingInfo').style.display = 'none'; }
        
        if (cardId === 'c8') document.getElementById('happyDashboard').style.display = 'block';
        else document.getElementById('happyDashboard').style.display = 'none';

        if (cardId === 'c9') { 
            const savedTier = localStorage.getItem('hsbc_tier') ||
            'infinite'; 
            document.querySelector(`input[name="hsbcTier"][value="${savedTier}"]`).checked = true; 
            document.getElementById('checkHsbcForeign').checked = false; 
            document.getElementById('hsbcInitialMiles').value = localStorage.getItem('hsbc_initial_miles') || '';
            document.getElementById('hsbcRedeemedMiles').value = localStorage.getItem('hsbc_redeemed_miles') || '';
        }

        document.getElementById('liveRewardCalc').style.display = 'none'; document.getElementById('liveRewardCalc').innerHTML = '';
        
        document.getElementById('amountInput').value = '';
        document.getElementById('noteInput').value = '';
        if (cardId === 'c6') {
             const isBill = document.getElementById('checkIsBill').checked;
             document.getElementById('labelBaseRate').innerText = isBill ? "ğŸ”° åŸºæœ¬å›é¥‹ 0.15% (ç„¡ä¸Šé™)" : "ğŸ”° åŸºæœ¬å›é¥‹ 1% (ç„¡ä¸Šé™)";
        }
        
        renderModalHistory(cardId);
        // æ–°å¢ï¼šç¢ºä¿é–‹å•Ÿè¦–çª—æ™‚æ³¨å…¥æ­£ç¢ºå…§å®¹
        if(cardId === 'c8') injectHappyDetails();
        
        setTimeout(() => document.getElementById('amountInput').focus(), 100);
    }
    
    function renderModalHistory(cardId) {
        const container = document.getElementById('modalHistoryList');
        const titleDiv = document.getElementById('modalHistoryTitle');
        container.innerHTML = '';
        
        const { start, end, isCustom } = getBillingCycle(cardId);
        const rangeText = `${start.getMonth() + 1}/${start.getDate()} - ${end.getMonth() + 1}/${end.getDate()}`;
        titleDiv.innerHTML = `<span>ğŸ“… æœ¬æœŸ (${rangeText}) æ¶ˆè²»ç´€éŒ„</span><span style="font-weight:normal; font-size:10px; color:#aaa;">(é»æ“Šæ–‡å­—ä¿®æ”¹ / âœ• åˆªé™¤)</span>`;
        const cardTx = transactions.filter(t => {
            const tDate = new Date(t.date);
            return t.cardId === cardId && tDate >= start && tDate <= end;
        }).reverse();
        if (cardTx.length === 0) { container.innerHTML = '<div style="text-align:center; color:#ccc; font-size:12px; margin-top:10px;">æœ¬æœŸå°šç„¡æ¶ˆè²»ç´€éŒ„</div>';
        return;
        }
        cardTx.forEach(tx => {
            const item = document.createElement('div'); item.className = 'history-item'; 
            let noteText = tx.note || 'ä¸€èˆ¬æ¶ˆè²»';
            if (tx.isGreen) noteText = 'ğŸŒ¿ ' + noteText; if (tx.isForeign) noteText = 'âœˆï¸ ' + noteText; if (tx.isUniBonus) noteText = 'ğŸ”¥ ' + noteText; if (tx.isHappyPet) 
            noteText = 'ğŸ¶ ' 
            + noteText; if (tx.isHappyPeace) noteText = 'ğŸ½ï¸ ' + noteText; if (tx.isHappyLife) noteText = 'ğŸ›’ ' + noteText; if (tx.isHappyForeign) noteText = 'âœˆï¸ ' + noteText; if (tx.isHsbcForeign) noteText = 'âœˆï¸ ' + noteText;
            if (tx.isUniGroup) noteText = 'ğŸª ' + noteText; if (tx.isUniIcash) noteText = 'ğŸ“± ' + noteText; if (tx.isUniOverseas) noteText = 'âœˆï¸ ' + noteText;
            if (tx.isRichartPay) noteText = 'ğŸ“± ' + noteText; if (tx.isRichartOnline) noteText = 'ğŸ›ï¸ ' + noteText; if (tx.isRichartLine) noteText = 
            'ğŸŸ¢ ' + noteText; if (tx.isRichartOverseas) noteText = 'âœˆï¸ ' + noteText;
            if (tx.isBill) noteText = 'ğŸ§¾ ' + noteText;
            if (tx.isBonus25) noteText = 'ğŸŒŸ ' + noteText; if (tx.isBonus10) noteText = 'âš¡ ' + noteText;
            if (tx.isFubonJJapan) noteText = 'ğŸ‡¯ğŸ‡µ ' + noteText;
            if (tx.isJiheJapan) noteText = 'ğŸ‡¯ğŸ‡µ ' + noteText;
            if (tx.isKumamonJapan) noteText = 'ğŸ‡¯ğŸ‡µ ' + noteText;
            if (tx.isSinopacCurrencyOverseas) noteText = 'âœˆï¸ ' + noteText;
            if (tx.isSinopacMitsuiSelected) noteText = 'ğŸ½ï¸ ' + noteText;
            if (tx.isSinopacMitsuiTarget) noteText = 'ğŸ‡¯ğŸ‡µ ' + noteText;
            if (tx.isJiangSelected) noteText = 'ğŸ›ï¸ ' + noteText;
            if (tx.isJiangTravel) noteText = 'âœˆï¸ ' + noteText;
            if (tx.isSinopacCurrencySelected) noteText = 'ğŸ›ï¸ ' + noteText;

            let amountDisplay = `$${tx.amount.toLocaleString()}`;
            if (cardId === 'c9') {
                const tier = localStorage.getItem('hsbc_tier') ||
                'infinite';
                let rate = 18; if (tier === 'infinite' && tx.isHsbcForeign) rate = 10;
                else if (tier === 'signature' && tx.isHsbcForeign) rate = 15;
                const miles = Math.floor(tx.amount / rate); amountDisplay = `${miles} å“©`;
            }
            
            const textDiv = document.createElement('div');
            textDiv.style.flex = '1';
            textDiv.innerHTML = `<div class="h-name">${noteText}</div><div class="h-date">${new Date(tx.date).getMonth()+1}/${new Date(tx.date).getDate()}</div>`;
            textDiv.onclick = () => editTransaction(tx.id);

            const rightDiv = document.createElement('div');
            rightDiv.style.display = 'flex';
            rightDiv.style.alignItems = 'center';
            rightDiv.innerHTML = `<span class="h-amount">${amountDisplay}</span>`;
            
            const delBtn = document.createElement('button');
            delBtn.className = 'btn-delete-single';
            delBtn.innerText = 'âœ•';
            delBtn.onclick = (e) => { e.stopPropagation(); deleteTransaction(tx.id, true); };
            rightDiv.appendChild(delBtn);

            item.appendChild(textDiv);
            item.appendChild(rightDiv);
            container.appendChild(item);
        });
    }

    let editingId = null;
    function editTransaction(id) {
        const tx = transactions.find(t => t.id === id);
        if(!tx) return;
        editingId = id;
        document.getElementById('amountInput').value = tx.amount;
        document.getElementById('noteInput').value = tx.note || '';
        document.getElementById('dateInput').value = tx.date.split('T')[0];
        
        if(document.getElementById('checkGreenChannel')) document.getElementById('checkGreenChannel').checked = tx.isGreen;
        if(document.getElementById('checkForeign')) document.getElementById('checkForeign').checked = tx.isForeign;
        if(document.getElementById('checkUniUp')) {
             document.getElementById('checkUniUp').checked = tx.isUniUp;
             toggleUniUpLogic(); 
        }
        if(document.getElementById('checkUniBonus')) document.getElementById('checkUniBonus').checked = tx.isUniBonus;
        if(document.getElementById('checkHappyPet')) document.getElementById('checkHappyPet').checked = tx.isHappyPet;
        if(document.getElementById('checkHappyPeace')) document.getElementById('checkHappyPeace').checked = tx.isHappyPeace;
        if(document.getElementById('checkHappyLife')) document.getElementById('checkHappyLife').checked = tx.isHappyLife;
        if(document.getElementById('checkHappyForeign')) document.getElementById('checkHappyForeign').checked = tx.isHappyForeign;
        if(document.getElementById('checkHsbcForeign')) document.getElementById('checkHsbcForeign').checked = tx.isHsbcForeign;
        if(document.getElementById('checkUniGroup')) document.getElementById('checkUniGroup').checked = tx.isUniGroup;
        if(document.getElementById('checkUniIcash')) document.getElementById('checkUniIcash').checked = tx.isUniIcash;
        if(document.getElementById('checkUniOverseas')) document.getElementById('checkUniOverseas').checked = tx.isUniOverseas;
        if (tx.isRichartPay) document.getElementById('rbRichartPay').checked = true;
        else if (tx.isRichartOnline) document.getElementById('rbRichartOnline').checked = true;
        else if (tx.isRichartLine) document.getElementById('rbRichartLine').checked = true;
        else if (tx.isRichartOverseas) document.getElementById('rbRichartOverseas').checked = true;
        else if (document.getElementById('rbRichartGeneral')) document.getElementById('rbRichartGeneral').checked = true;
        if(document.getElementById('checkBonus10')) document.getElementById('checkBonus10').checked = tx.isBonus10;
        if(document.getElementById('checkBonus25')) document.getElementById('checkBonus25').checked = tx.isBonus25;
        if(document.getElementById('checkIsBill')) document.getElementById('checkIsBill').checked = tx.isBill;

        if(document.getElementById('checkFubonJJapan')) { document.getElementById('checkFubonJJapan').checked = tx.isFubonJJapan; toggleFubonJLogic();
        }
        if(document.getElementById('checkFubonJPhysical')) document.getElementById('checkFubonJPhysical').checked = tx.isFubonJPhysical;
        if(document.getElementById('checkJiheJapan')) { document.getElementById('checkJiheJapan').checked = tx.isJiheJapan; toggleJiheLogic();
        }
        if(document.getElementById('checkJiheApple')) document.getElementById('checkJiheApple').checked = tx.isJiheApple;
        if(document.getElementById('checkKumamonJapan')) { document.getElementById('checkKumamonJapan').checked = tx.isKumamonJapan; toggleKumamonLogic();
        }
        if(document.getElementById('checkKumamonDesignated')) document.getElementById('checkKumamonDesignated').checked = tx.isKumamonDesignated;
        if(document.getElementById('checkKumamonPayPay')) document.getElementById('checkKumamonPayPay').checked = tx.isKumamonPayPay;
        if(document.getElementById('checkSinopacCurrencyOverseas')) { document.getElementById('checkSinopacCurrencyOverseas').checked = tx.isSinopacCurrencyOverseas; toggleCurrencyLogic(); }
        if(document.getElementById('checkSinopacCurrencySelected')) document.getElementById('checkSinopacCurrencySelected').checked = tx.isSinopacCurrencySelected;
        if(document.getElementById('checkSinopacMitsuiSelected')) document.getElementById('checkSinopacMitsuiSelected').checked = tx.isSinopacMitsuiSelected;
        if(document.getElementById('checkSinopacMitsuiTarget')) document.getElementById('checkSinopacMitsuiTarget').checked = tx.isSinopacMitsuiTarget;
        if(tx.isJiangSelected) document.getElementById('rbJiangSelected').checked = true;
        else if(tx.isJiangTravel) document.getElementById('rbJiangTravel').checked = true;
        else if(document.querySelector('input[name="jiangMode"][value="base"]')) document.querySelector('input[name="jiangMode"][value="base"]').checked = true;
        if(tx.isSinopacCurrencySelected) document.getElementById('rbCurrencySelected').checked = true;
        else document.querySelector('input[name="currencyType"][value="domestic"]').checked = true;
        
        document.getElementById('btn-confirm').innerText = "ä¿®æ”¹";
        updateRewardPreview();
    }

    function deleteTransaction(id, fromModal = false) {
        if(confirm('åˆªé™¤æ­¤ç­†ç´€éŒ„ï¼Ÿ')) {
            transactions = transactions.filter(t => t.id !== id);
            localStorage.setItem('transactions', JSON.stringify(transactions));
            renderGrid(); if (fromModal) { const cardId = document.getElementById('cardIdInput').value; renderModalHistory(cardId); if(cardId === 'c8') renderHappyDashboard();
            }
        }
    }
    function resetAllData() { if(confirm('âš ï¸ ç¢ºå®šæ¸…ç©ºï¼Ÿ')) { localStorage.clear();
    transactions = []; renderGrid(); } }
    
    async function exportData() {
        const backupData = {
            transactions: transactions,
            settings: {
                hsbc_tier: localStorage.getItem('hsbc_tier'),
                hsbc_initial_miles: localStorage.getItem('hsbc_initial_miles'),
                hsbc_redeemed_miles: localStorage.getItem('hsbc_redeemed_miles'),
                uniOpenState: localStorage.getItem('uniOpenState'),
                visibleCards: localStorage.getItem('visibleCards'),
                cardOrder: localStorage.getItem('cardOrder'),
                cardSettings: localStorage.getItem('cardSettings'),
                user_setup_done: localStorage.getItem('user_setup_done')
            }
        };
        const dataStr = JSON.stringify(backupData);
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        const fileName = `backup_${year}-${month}-${day}.json`;
        const file = new File([dataStr], fileName, { type: "application/json" });
        if (navigator.share && navigator.canShare({ files: [file] })) { try { await navigator.share({ files: [file] }); return;
        } catch (error) { if (error.name === 'AbortError') return; } }
        const blob = new Blob([dataStr], {type: "application/json"});
        const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = fileName; document.body.appendChild(a); a.click(); document.body.removeChild(a);
    }
    
    function triggerImport() { document.getElementById('fileInput').click();
    }
    
    function importFile(input) {
        const file = input.files[0];
        if (!file) return; const reader = new FileReader();
        reader.onload = function(e) { 
            try { 
                const json = JSON.parse(e.target.result);
                if (Array.isArray(json)) { 
                    transactions = json;
                    localStorage.setItem('transactions', JSON.stringify(transactions)); 
                    alert('âœ… èˆŠç‰ˆå‚™ä»½é‚„åŸæˆåŠŸï¼(åƒ…åŒ…å«äº¤æ˜“ç´€éŒ„)'); 
                } 
                else if (json.transactions) {
                    transactions = json.transactions;
                    localStorage.setItem('transactions', JSON.stringify(transactions));
                    
                    if (json.settings) {
                        if(json.settings.hsbc_tier) localStorage.setItem('hsbc_tier', json.settings.hsbc_tier);
                        if(json.settings.hsbc_initial_miles) localStorage.setItem('hsbc_initial_miles', json.settings.hsbc_initial_miles);
                        if(json.settings.hsbc_redeemed_miles) localStorage.setItem('hsbc_redeemed_miles', json.settings.hsbc_redeemed_miles);
                        if(json.settings.uniOpenState) localStorage.setItem('uniOpenState', json.settings.uniOpenState);
                        if(json.settings.visibleCards) localStorage.setItem('visibleCards', json.settings.visibleCards);
                        if(json.settings.cardOrder) localStorage.setItem('cardOrder', json.settings.cardOrder);
                        if(json.settings.cardSettings) localStorage.setItem('cardSettings', json.settings.cardSettings);
                        if(json.settings.user_setup_done) localStorage.setItem('user_setup_done', json.settings.user_setup_done);
                    }
                    alert('âœ… å®Œæ•´å‚™ä»½é‚„åŸæˆåŠŸï¼(å«è¨­å®šèˆ‡å“©ç¨‹)');
                }
                else { alert('âŒ æª”æ¡ˆå…§å®¹æ ¼å¼éŒ¯èª¤');
                }
                location.reload();
            } catch (err) { alert('âŒ ç„¡æ³•è®€å–æª”æ¡ˆ'); } 
        };
        reader.readAsText(file); input.value = '';
    }
    
    function checkUrgentTasks() {
        const alertArea = document.getElementById('urgent-alert-area'), alertList = document.getElementById('urgent-list');
        alertList.innerHTML = ''; let hasUrgent = false;
        cards.forEach(card => {
            if (card.type === 'placeholder') return;
            const stats = calculateStats(card.id); let target = card.type === 'floor' ? card.target : (card.type === 'mixed' ? card.minSpend : 0);
            if (target > 0 && stats.spend < target) {
                const end = new Date(new Date().getFullYear(), new Date().getMonth() 
                + 1, 0), diff = Math.ceil((end - new Date()) / 86400000);
                if (diff <= 3 && diff >= 0) { hasUrgent = true; alertList.innerHTML += `<div class="urgent-item">${card.name} ç¼º $${(target - stats.spend).toLocaleString()} (å‰© ${diff} å¤©)</div>`; }
            }
        });
        alertArea.style.display = hasUrgent ? 'block' : 'none';
    }
    updateDate(); 
</script>
</body>
</html>
