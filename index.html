function initUniBrandGrid() {
        const grid = document.getElementById('uniBrandGrid');
        grid.innerHTML = '';
        uniBrands.forEach(brand => {
            const btn = document.createElement('div');
            btn.className = 'brand-btn';
            btn.innerText = brand;
            btn.onclick = () => toggleUniBrand(brand, btn);
            grid.appendChild(btn);
        });
    }

    function saveUniOpenState() {
        const state = {
            group: document.getElementById('checkUniGroup').checked,
            icash: document.getElementById('checkUniIcash').checked,
            overseas: document.getElementById('checkUniOverseas').checked,
            brands: getCheckedBrands()
        };
        localStorage.setItem('uniOpenState', JSON.stringify(state));
        const count = state.brands.length;
        updateTaskBonusDisplay(count);
        renderGrid(); 
        updateRewardPreview();
    }
    
    function toggleUniBrand(brand, btn) {
        if (document.getElementById('checkUniOverseas').checked) { document.getElementById('checkUniOverseas').checked = false; }
        if(!btn.classList.contains('active')) { document.getElementById('checkUniGroup').checked = true; }
        btn.classList.toggle('active');
        saveUniOpenState();
    }
    
    function toggleUniGroup() {
        if(document.getElementById('checkUniGroup').checked) { document.getElementById('checkUniOverseas').checked = false; }
        saveUniOpenState();
    }
    
    function toggleUniIcash() {
        if(document.getElementById('checkUniIcash').checked) { document.getElementById('checkUniOverseas').checked = false; }
        saveUniOpenState();
    }
    
    function getCheckedBrands() {
        const activeBtns = document.querySelectorAll('.brand-btn.active');
        const brands = [];
        activeBtns.forEach(btn => brands.push(btn.innerText));
        return brands;
    }
    
    function updateTaskBonusDisplay(count) {
        const display = document.getElementById('taskBonusDisplay');
        let rate = 0;
        if(count >= 5) rate = 4;
        else if(count === 4) rate = 3;
        else if(count === 3) rate = 2;
        else if(count === 2) rate = 1;
        display.innerText = `ç›®å‰è¸©é» ${count} å®¶ (åŠ ç¢¼ +${rate}%)`;
    }
    
    function toggleUniOverseas() {
        const isOverseas = document.getElementById('checkUniOverseas').checked;
        if (isOverseas) {
            document.getElementById('checkUniGroup').checked = false;
            document.getElementById('checkUniIcash').checked = false;
            const btns = document.querySelectorAll('.brand-btn');
            btns.forEach(btn => btn.classList.remove('active'));
        }
        saveUniOpenState();
    }

    function toggleUniUpLogic() {
        const isUp = document.getElementById('checkUniUp').checked;
        const label = document.getElementById('labelUniBase');
        if (isUp) {
            label.innerHTML = "ğŸ†™ <b>UP é¸ 4.5%</b> (åˆ·$14è¬å°é ‚)";
            label.parentNode.style.background = "#fff3e0"; 
        } else {
            label.innerHTML = "ğŸ”° <b>ä»»æ„é¸ 3.5%</b> (åˆ·$4è¬å°é ‚)";
            label.parentNode.style.background = "transparent";
        }
        updateRewardPreview();
    }

    function toggleFubonJGeneral() {
        const isGeneral = document.getElementById('checkFubonJGeneral').checked;
        const labelBase = document.getElementById('labelFubonBase');
        if (isGeneral) {
            labelBase.innerHTML = "ğŸ‡¯ğŸ‡µğŸ‡°ğŸ‡· <b>æ—¥éŸ“åŸºæœ¬ 3%</b> (ç„¡ä¸Šé™)";
            document.getElementById('checkFubonJThai').checked = false;
        } else {
            labelBase.innerHTML = "ğŸ”° <b>åœ‹å…§æ¶ˆè²» 1%</b> (ç„¡ä¸Šé™)";
            document.getElementById('checkFubonJKorea').checked = false;
            document.getElementById('checkFubonJSuica').checked = false;
        }
        updateRewardPreview();
    }

    function toggleFubonJPhysical() {
        if(document.getElementById('checkFubonJKorea').checked) {
            document.getElementById('checkFubonJGeneral').checked = true;
            document.getElementById('checkFubonJSuica').checked = false; // å¯¦é«”èˆ‡äº¤é€šäº’æ–¥
            toggleFubonJGeneral();
        }
        updateRewardPreview();
    }

    function toggleFubonJSuica() {
        if(document.getElementById('checkFubonJSuica').checked) {
            document.getElementById('checkFubonJGeneral').checked = true;
            document.getElementById('checkFubonJKorea').checked = false; // å¯¦é«”èˆ‡äº¤é€šäº’æ–¥
            toggleFubonJGeneral();
        }
        updateRewardPreview();
    }

    function toggleFubonJThai() {
        if(document.getElementById('checkFubonJThai').checked) {
            document.getElementById('checkFubonJGeneral').checked = false;
            toggleFubonJGeneral();
        }
        updateRewardPreview();
    }

    function toggleJiheLogic() {
        const isJapan = document.getElementById('checkJiheJapan').checked;
        const labelBase = document.getElementById('labelJiheBase');
        const appleRow = document.getElementById('rowJiheApple');
        const domesticRow = document.getElementById('rowJiheDomesticJapanese');
        if (isJapan) {
            labelBase.innerHTML = "âœˆï¸ <b>æ—¥æœ¬æ¶ˆè²» 2.5%</b> (ç„¡ä¸Šé™)";
            appleRow.style.display = 'flex';
            domesticRow.style.display = 'none';
            document.getElementById('checkJiheDomesticJapanese').checked = false;
        } else {
            labelBase.innerHTML = "ğŸ”° <b>åœ‹å…§æ¶ˆè²» 1%</b> (ç„¡ä¸Šé™)";
            document.getElementById('checkJiheApple').checked = false;
            appleRow.style.display = 'none';
            domesticRow.style.display = 'flex';
        }
        updateRewardPreview();
    }

    // ç†Šæœ¬ç†Šå¡é‚è¼¯ä¿®æ­£
    function toggleKumamonLogic() {
        const isJapan = document.getElementById('checkKumamonJapan').checked;
        const labelBase = document.getElementById('labelKumamonBase');
        const groupJapan = document.getElementById('groupKumamonJapan');
        const groupDomestic = document.getElementById('groupKumamonDomestic');
        if (isJapan) {
            labelBase.innerHTML = "âœˆï¸ <b>æ—¥æœ¬æ¶ˆè²» 2.5%</b> (å«å…æ‰‹çºŒè²»)";
            groupJapan.style.display = 'block';
            if (groupDomestic) groupDomestic.style.display = 'none';
        } else {
            labelBase.innerHTML = "ğŸ”° <b>åœ‹å…§ä¸€èˆ¬ 0.5%</b> (ç„¡ä¸Šé™)";
            document.getElementById('checkKumamonDesignated').checked = false;
            document.getElementById('checkKumamonPayPay').checked = false;
            groupJapan.style.display = 'none';
            document.getElementById('rowKumamonJapan').style.display = 'flex';
        }
        updateRewardPreview();
    }
    
    function toggleKumamonSub(mode) {
        const isPayPay = document.getElementById('checkKumamonPayPay').checked;
        const isDesignated = document.getElementById('checkKumamonDesignated').checked;
        const labelBase = document.getElementById('labelKumamonBase');
        const japanRow = document.getElementById('rowKumamonJapan');
        
        if (mode === 'designated' && isDesignated) { document.getElementById('checkKumamonPayPay').checked = false; }
        if (mode === 'paypay' && isPayPay) { document.getElementById('checkKumamonDesignated').checked = false; }
        
        if (document.getElementById('checkKumamonPayPay').checked) {
             document.getElementById('checkKumamonJapan').checked = true;
             japanRow.style.display = 'none'; 
             labelBase.innerHTML = "ğŸ“± <b>PayPay 5%</b> (3.5%+1.5%å…æ‰‹çºŒè²»)";
             document.getElementById('groupKumamonJapan').style.display = 'block';
             
        } else if (document.getElementById('checkKumamonDesignated').checked) {
             document.getElementById('checkKumamonJapan').checked = true;
             japanRow.style.display = 'flex'; 
             labelBase.innerHTML = "ğŸ» <b>æŒ‡å®šé€šè·¯ 8.5%</b> (åˆ·$8,333å°é ‚)";
             document.getElementById('groupKumamonJapan').style.display = 'block';
             
        } else {
             japanRow.style.display = 'flex';
             toggleKumamonLogic(); 
        }
        updateRewardPreview();
    }

    function toggleCurrencyLogic() { 
        const currencyType = document.querySelector('input[name="currencyType"]:checked').value;
        const labelBase = document.getElementById('labelCurrencyBase');
        if (currencyType === 'selected') {
            labelBase.innerHTML = "âœˆï¸ <b>æµ·å¤–/ç²¾é¸ 2%</b>";
        } else {
            labelBase.innerHTML = "ğŸ”° <b>åœ‹å…§ä¸€èˆ¬ 1%</b>";
        }
        updateRewardPreview(); 
    }
    
    function toggleSinopacMitsui(mode) {
        if (mode === 'selected' && document.getElementById('checkSinopacMitsuiSelected').checked) {
            document.getElementById('checkSinopacMitsuiTarget').checked = false;
        }
        if (mode === 'target' && document.getElementById('checkSinopacMitsuiTarget').checked) {
            document.getElementById('checkSinopacMitsuiSelected').checked = false;
        }
        updateRewardPreview();
    }
    
    function toggleJiangDetails() { const el = document.getElementById('jiangDetails'); el.style.display = (el.style.display === 'block') ? 'none' : 'block'; }
    function toggleJiangTravelDetails() { const el = document.getElementById('jiangTravelDetails'); el.style.display = (el.style.display === 'block') ? 'none' : 'block'; }
    function toggleCurrencyDetails() { const el = document.getElementById('currencyDetails'); el.style.display = (el.style.display === 'block') ? 'none' : 'block'; }
    function togglePigRichNewUser() { const el = document.getElementById('pigRichNewUserDetails'); el.style.display = (el.style.display === 'block') ? 'none' : 'block'; }
    function togglePigRichSelected() { const el = document.getElementById('pigRichSelectedDetails'); el.style.display = (el.style.display === 'block') ? 'none' : 'block'; }
    function toggleHappyPetDetails() { const el = document.getElementById('happyPetDetails'); el.style.display = (el.style.display === 'block') ? 'none' : 'block'; }
    function toggleHappyPeaceDetails() { const el = document.getElementById('happyPeaceDetails'); el.style.display = (el.style.display === 'block') ? 'none' : 'block'; }
    function toggleHappyLifeDetails() { const el = document.getElementById('happyLifeDetails'); el.style.display = (el.style.display === 'block') ? 'none' : 'block'; }
    
    function saveCurrencyLevel() {
        const level = document.querySelector('input[name="currencyLevel"]:checked').value;
        localStorage.setItem('currency_level', level);
        renderGrid();
        updateRewardPreview();
    }
    
    function getQuarterRange(dateObj) {
        const year = dateObj.getFullYear();
        const month = dateObj.getMonth();
        const q = Math.floor(month / 3);
        const start = new Date(year, q * 3, 1);
        const end = new Date(year, (q + 1) * 3, 0, 23, 59, 59, 999);
        return { start, end };
    }

    function getBillingCycle(cardId, dateObj = new Date()) {
        const settings = cardSettings[cardId] || {};
        const statementDate = parseInt(settings.billingDay);

        if (!statementDate || statementDate >= 31 || statementDate === 1) {
            return {
                start: new Date(dateObj.getFullYear(), dateObj.getMonth(), 1),
                end: new Date(dateObj.getFullYear(), dateObj.getMonth() + 1, 0, 23, 59, 59),
                isCustom: false
            };
        }

        let start, end;
        const currentDay = dateObj.getDate();
        if (currentDay <= statementDate) {
            end = new Date(dateObj.getFullYear(), dateObj.getMonth(), statementDate, 23, 59, 59);
            start = new Date(dateObj.getFullYear(), dateObj.getMonth() - 1, statementDate + 1);
        } else {
            end = new Date(dateObj.getFullYear(), dateObj.getMonth() + 1, statementDate, 23, 59, 59);
            start = new Date(dateObj.getFullYear(), dateObj.getMonth(), statementDate + 1);
        }
        
        return { start, end, isCustom: true };
    }

    function addTransaction(isConfirm) {
        const amount = parseFloat(document.getElementById('amountInput').value);
        const date = document.getElementById('dateInput').value;
        const note = document.getElementById('noteInput').value;
        const cardId = document.getElementById('cardIdInput').value;
        
        if (!amount || amount <= 0) { alert('è«‹è¼¸å…¥æœ‰æ•ˆé‡‘é¡'); return; }
        if (!date) { alert('è«‹é¸æ“‡æ—¥æœŸ'); return; }

        const isCard = (id) => cardId === id;
        // C6
        let isBonus10 = isCard('c6') && document.getElementById('checkBonus10').checked;
        let isBonus25 = isCard('c6') && document.getElementById('checkBonus25').checked;
        let isBill = isCard('c6') && document.getElementById('checkIsBill').checked;
        // C2
        let isGreen = isCard('c2') && document.getElementById('checkGreenChannel').checked;
        let isForeign = (isCard('c2') && document.getElementById('checkForeign').checked) || (isCard('hsbc') && document.getElementById('checkHsbcForeign').checked);

        // C7
        let isUniUp = isCard('c7') && document.getElementById('checkUniUp').checked;
        let isUniBonus = isCard('c7') && document.getElementById('checkUniBonus').checked;

        // C8
        let isHappyPet = isCard('c8') && document.getElementById('checkHappyPet').checked;
        let isHappyPeace = isCard('c8') && document.getElementById('checkHappyPeace').checked;
        let isHappyLife = isCard('c8') && document.getElementById('checkHappyLife').checked;
        let isHappyForeign = isCard('c8') && document.getElementById('checkHappyForeign').checked;
        // C9
        let isHsbcForeign = isCard('c9') && document.getElementById('checkHsbcForeign').checked;
        // C10
        let isUniGroup = isCard('c10') && document.getElementById('checkUniGroup').checked;
        let isUniIcash = isCard('c10') && document.getElementById('checkUniIcash').checked;
        let isUniOverseas = isCard('c10') && document.getElementById('checkUniOverseas').checked;
        // C11
        let richartMode = 'general';
        if (isCard('c11')) {
             richartMode = document.querySelector('input[name="richartMode"]:checked') ? document.querySelector('input[name="richartMode"]:checked').value : 'general';
        }
        let isRichartPay = (richartMode === 'pay');
        let isRichartOnline = (richartMode === 'online');
        let isRichartLine = (richartMode === 'line');
        let isRichartOverseas = (richartMode === 'overseas');
        // J1
        let isFubonJGeneral = isCard('j1') && document.getElementById('checkFubonJGeneral').checked;
        let isFubonJKorea = isCard('j1') && document.getElementById('checkFubonJKorea').checked;
        let isFubonJThai = isCard('j1') && document.getElementById('checkFubonJThai').checked;
        let isFubonJSuica = isCard('j1') && document.getElementById('checkFubonJSuica').checked;
        // J2
        let isJiheJapan = isCard('j2') && document.getElementById('checkJiheJapan').checked;
        let isJiheApple = isCard('j2') && document.getElementById('checkJiheApple').checked;
        let isJiheDomesticJapanese = isCard('j2') && document.getElementById('checkJiheDomesticJapanese').checked;
        // J3
        let isKumamonJapan = isCard('j3') && document.getElementById('checkKumamonJapan').checked;
        let isKumamonDesignated = isCard('j3') && document.getElementById('checkKumamonDesignated').checked;
        let isKumamonPayPay = isCard('j3') && document.getElementById('checkKumamonPayPay').checked;
        // J4
        let isSinopacCurrencySelectedFinal = false;
        if (isCard('j4')) {
            let cType = document.querySelector('input[name="currencyType"]:checked') ? document.querySelector('input[name="currencyType"]:checked').value : 'domestic';
            isSinopacCurrencySelectedFinal = (cType === 'selected');
        }
        // J5
        let isSinopacMitsuiSelected = isCard('j5') && document.getElementById('checkSinopacMitsuiSelected').checked;
        let isSinopacMitsuiTarget = isCard('j5') && document.getElementById('checkSinopacMitsuiTarget').checked;
        // C4
        let isJiangSelected = false;
        let isJiangTravel = false;
        if (isCard('c4')) {
            let jMode = document.querySelector('input[name="jiangMode"]:checked') ? document.querySelector('input[name="jiangMode"]:checked').value : 'base';
            isJiangSelected = (jMode === 'selected');
            isJiangTravel = (jMode === 'travel');
        }

        const newTx = {
            id: editingId || Date.now(),
            cardId, amount, date, note,
            isGreen, isForeign, isUniUp, isUniBonus, isHappyPet, isHappyPeace, isHappyLife, isHappyForeign, isHsbcForeign,
            isUniGroup, isUniIcash, isUniOverseas,
            isRichartPay, isRichartOnline, isRichartLine, isRichartOverseas,
            isBonus10, isBonus25, isBill,
            isFubonJGeneral, isFubonJKorea, isFubonJThai, isFubonJSuica,
            isJiheJapan, isJiheApple, isJiheDomesticJapanese,
            isKumamonJapan, isKumamonDesignated, isKumamonPayPay,
            isSinopacCurrencySelected: isSinopacCurrencySelectedFinal,
            isSinopacMitsuiSelected, isSinopacMitsuiTarget,
            isJiangSelected, isJiangTravel
        };
        if (editingId) {
            const index = transactions.findIndex(t => t.id === editingId);
            if (index !== -1) transactions[index] = newTx;
            editingId = null;
        } else {
            transactions.push(newTx);
        }

        localStorage.setItem('transactions', JSON.stringify(transactions));
        
        document.getElementById('amountInput').value = '';
        document.getElementById('noteInput').value = '';
        document.getElementById('btn-confirm').innerText = "ç¢ºèª";
        
        renderGrid();
        renderModalHistory(cardId);
        updateRewardPreview();

        if (isConfirm) {
            document.getElementById('transactionModal').style.display = 'none';
        } else {
            document.getElementById('amountInput').focus();
        }
    }

    function calculateStats(cardId, addedAmount = 0, addedIsGreen = false, addedIsForeign = false, addedIsUniBonus = false, addedIsUniUp = false, addedIsHappyPet = false, addedIsHappyLife = false, addedIsHappyForeign = false, addedIsHappyPeace = false, addedIsHsbcForeign = false, addedIsUniGroup = false, addedIsUniIcash = false, addedIsUniOverseas = false, addedIsRichartPay = false, addedIsRichartOnline = false, addedIsRichartLine = false, addedIsRichartOverseas = false, addedIsBonus10 = false, addedIsBonus25 = false, addedIsBill = false, 
        addedIsFubonJGeneral = false, addedIsFubonJKorea = false, addedIsFubonJThai = false, addedIsFubonJSuica = false,
        addedIsJiheJapan = false, addedIsJiheApple = false, addedIsJiheDomesticJapanese = false,
        addedIsKumamonJapan = false, addedIsKumamonDesignated = false, addedIsKumamonPayPay = false,
        addedIsSinopacCurrencySelected = false, 
        addedIsSinopacMitsuiSelected = false, addedIsSinopacMitsuiTarget = false,
        addedIsJiangSelected = false, addedIsJiangTravel = false) {
        
        const card = cards.find(c => c.id === cardId);
        if (card.type === 'placeholder') return { spend: 0, validSpend: 0, reward: 0, rate: '0.0' };
        
        const dateInputVal = document.getElementById('dateInput') ? document.getElementById('dateInput').value : null;
        const refDate = (addedAmount > 0 && dateInputVal) ? new Date(dateInputVal) : new Date();
        const { start: cycleStart, end: cycleEnd, isCustom } = getBillingCycle(cardId, refDate);
        const { start: quarterStart, end: quarterEnd } = getQuarterRange(refDate);
        const relevantTx = transactions.filter(t => {
            const tDate = new Date(t.date);
            return t.cardId === cardId && tDate >= cycleStart && tDate <= cycleEnd;
        });
        const quarterTx = transactions.filter(t => {
            const tDate = new Date(t.date);
            return t.cardId === cardId && tDate >= quarterStart && tDate <= quarterEnd;
        });
        let totalSpend = relevantTx.reduce((sum, t) => sum + parseFloat(t.amount), 0);
        totalSpend += addedAmount;
        let reward = 0;
        // J1
        if (cardId === 'j1') {
            const txList = [...relevantTx];
            if (addedAmount > 0) txList.push({ amount: addedAmount, isFubonJGeneral: addedIsFubonJGeneral, isFubonJKorea: addedIsFubonJKorea, isFubonJThai: addedIsFubonJThai, isFubonJSuica: addedIsFubonJSuica });
            let baseReward = 0;
            txList.forEach(t => {
                if(t.isFubonJGeneral) baseReward += t.amount * 0.03;
                else baseReward += t.amount * 0.01;
            });
            let jkBonusTotal = 0;
            txList.forEach(t => { if(t.isFubonJKorea && t.amount >= 1000) jkBonusTotal += t.amount * 0.03; });
            jkBonusTotal = Math.min(jkBonusTotal, 1000);
            let thaiBonusTotal = 0;
            txList.forEach(t => { if(t.isFubonJThai && t.amount >= 1000) thaiBonusTotal += t.amount * 0.05; });
            thaiBonusTotal = Math.min(thaiBonusTotal, 1000);
            let suicaBonusTotal = 0;
            txList.forEach(t => { if(t.isFubonJSuica && t.amount >= 2000) suicaBonusTotal += t.amount * 0.07; });
            suicaBonusTotal = Math.min(suicaBonusTotal, 200);
            reward = baseReward + jkBonusTotal + thaiBonusTotal + suicaBonusTotal;
            
            let displayRate = "1.0";
            if(addedIsFubonJGeneral) displayRate = "3.0";
            if(addedIsFubonJKorea && addedAmount >= 1000) displayRate = "6.0";
            else if(addedIsFubonJThai && addedAmount >= 1000) displayRate = "6.0";
            else if(addedIsFubonJSuica && addedAmount >= 2000) displayRate = "10.0";
            return { spend: totalSpend, validSpend: totalSpend, reward: Math.round(reward), rate: displayRate, isCustom, cycleStart, cycleEnd };
        }

        // J2
        if (cardId === 'j2') {
            const txList = [...relevantTx];
            if (addedAmount > 0) txList.push({ amount: addedAmount, isJiheJapan: addedIsJiheJapan, isJiheApple: addedIsJiheApple, isJiheDomesticJapanese: addedIsJiheDomesticJapanese });
            let baseReward = 0;
            txList.forEach(t => {
                if (t.isJiheJapan) baseReward += t.amount * 0.025;
                else baseReward += t.amount * 0.01;
            });
            const appleSpend = relevantTx.filter(t => t.isJiheApple).reduce((sum, t) => sum + t.amount, 0) + (addedIsJiheApple ? addedAmount : 0);
            const bonusApple = Math.min(appleSpend, 40000) * 0.015;
            const domesticJpSpend = relevantTx.filter(t => t.isJiheDomesticJapanese).reduce((sum, t) => sum + t.amount, 0) + (addedIsJiheDomesticJapanese ? addedAmount : 0);
            const bonusDom = Math.min(domesticJpSpend, 12500) * 0.04;
            reward = baseReward + bonusApple + bonusDom;
            
            let displayRate = "1.0";
            if (addedIsJiheJapan) {
                displayRate = "2.5";
                if(addedIsJiheApple) displayRate = "4.0";
            } else {
                if(addedIsJiheDomesticJapanese) displayRate = "5.0";
            }
            return { spend: totalSpend, validSpend: totalSpend, reward: Math.round(reward), rate: displayRate, isCustom, cycleStart, cycleEnd };
        }

        // J3
        if (cardId === 'j3') {
            const txList = [...relevantTx];
            if (addedAmount > 0) txList.push({ amount: addedAmount, isKumamonJapan: addedIsKumamonJapan, isKumamonDesignated: addedIsKumamonDesignated, isKumamonPayPay: addedIsKumamonPayPay });
            reward = txList.reduce((sum, t) => {
                if (t.isKumamonPayPay) { return sum + (t.amount * 0.05); }
                if (t.isKumamonDesignated) { return sum + (t.amount * 0.085); }
                if (t.isKumamonJapan) { return sum + (t.amount * 0.025); }
                return sum + (t.amount * 0.005);
            }, 0);
            const desigSpend = relevantTx.filter(t => t.isKumamonDesignated).reduce((sum, t) => sum + t.amount, 0) + (addedIsKumamonDesignated ? addedAmount : 0);
            if (desigSpend > 8333) { reward -= (desigSpend - 8333) * 0.06; }
            const paypayQuarterSpend = quarterTx.filter(t => t.isKumamonPayPay).reduce((sum, t) => sum + t.amount, 0) + (addedIsKumamonPayPay ? addedAmount : 0);
            if (paypayQuarterSpend > 2857) { reward -= (paypayQuarterSpend - 2857) * 0.035; }

            let validSpend = desigSpend;
            let limit = 8333;
            let msg = '';
            
            if (addedIsKumamonPayPay || (quarterTx.some(t=>t.isKumamonPayPay) && !addedIsKumamonDesignated && !addedIsKumamonJapan)) {
                validSpend = paypayQuarterSpend;
                limit = 2857;
                if (validSpend >= limit) msg = 'PayPay 3.5% å·²å°é ‚';
                else msg = `PayPay å‰© $${Math.floor(limit - validSpend).toLocaleString()} (å­£)`;
            } else if (addedIsKumamonDesignated || desigSpend > 0) {
                if (validSpend >= limit) msg = 'æŒ‡å®šåŠ ç¢¼å·²å°é ‚';
                else msg = `æŒ‡å®šé€šè·¯å‰© $${Math.floor(limit - validSpend).toLocaleString()}`;
            } else {
                msg = 'æœ¬æœˆç´¯ç©æ¶ˆè²»';
                limit = 0; 
            }

            let displayRate = "0.5";
            if (addedIsKumamonPayPay) displayRate = "5.0";
            else if (addedIsKumamonDesignated) displayRate = "8.5";
            else if (addedIsKumamonJapan) displayRate = "2.5";
            return { spend: totalSpend, validSpend: validSpend, reward: Math.round(reward), rate: displayRate, isCustom, cycleStart, cycleEnd, msgDanger: msg, customLimit: limit };
        }

        // J4
        if (cardId === 'j4') {
            const level = localStorage.getItem('currency_level') || 'low';
            const bonusCap = (level === 'high') ? 800 : 300; 
            const spendingCap = bonusCap / 0.04;
            const txList = [...relevantTx];
            if (addedAmount > 0) txList.push({ amount: addedAmount, isSinopacCurrencySelected: addedIsSinopacCurrencySelected });
            
            let baseReward = 0;
            txList.forEach(t => {
                if(t.isSinopacCurrencySelected) baseReward += t.amount * 0.02; 
                else baseReward += t.amount * 0.01;
            });
            const bonusTx = txList.filter(t => t.isSinopacCurrencySelected);
            const totalBonusSpend = bonusTx.reduce((sum, t) => sum + t.amount, 0);
            const actualBonus = Math.min(totalBonusSpend * 0.04, bonusCap);
            
            reward = baseReward + actualBonus;
            
            let displayRate = "1.0";
            if(addedIsSinopacCurrencySelected) {
                 const remainingSpend = Math.max(0, spendingCap - totalBonusSpend);
                 displayRate = (remainingSpend > 0) ? "6.0" : "2.0";
            }
            
            let statusText = '';
            if (totalBonusSpend >= spendingCap) { statusText = 'åŠ ç¢¼å·²å°é ‚ (è®Š2%)'; } 
            else { statusText = `å‰© $${Math.floor(spendingCap - totalBonusSpend).toLocaleString()} (ç²¾é¸)`; }
            return { spend: totalSpend, validSpend: totalBonusSpend, reward: Math.round(reward), rate: displayRate, isCustom, cycleStart, cycleEnd, msgDanger: statusText, customLimit: spendingCap };
        }

        // J5
        if (cardId === 'j5') {
            const baseReward = totalSpend * 0.003;
            const txList = [...relevantTx]; 
            if (addedAmount > 0) txList.push({ amount: addedAmount, isSinopacMitsuiSelected: addedIsSinopacMitsuiSelected });
            const selectedSpend = txList.filter(t => t.isSinopacMitsuiSelected).reduce((sum, t) => sum + t.amount, 0);
            const selectedBonus = Math.min(selectedSpend * 0.07, 100);
            const spendingCap = 1428;
            const quarterHistory = quarterTx.filter(t => t.isSinopacMitsuiTarget).reduce((sum, t) => sum + t.amount, 0);
            let currentQuarterSpend = quarterHistory;
            if (addedIsSinopacMitsuiTarget) currentQuarterSpend += addedAmount;
            
            let targetBonus = 0;
            if (currentQuarterSpend >= 30000 && quarterHistory < 30000) { targetBonus = 2000; }
            
            reward = baseReward + selectedBonus + targetBonus;
            let displayRate = "0.3";
            let statusText = '';
            let validSpend = selectedSpend; 
            let limit = spendingCap;
            if (addedIsSinopacMitsuiTarget || (quarterHistory > 0 && !addedIsSinopacMitsuiSelected)) {
                validSpend = currentQuarterSpend;
                limit = 30000;
                if (currentQuarterSpend >= 30000) {
                    statusText = 'ğŸ‰ æœ¬å­£å·²é”æ¨™ (é ˜$2000)';
                    if (addedIsSinopacMitsuiTarget) displayRate = "6.9"; 
                } else {
                    statusText = `å·® $${(30000 - currentQuarterSpend).toLocaleString()} é ˜$2000 (å­£)`;
                    if (addedIsSinopacMitsuiTarget) displayRate = "0.3";
                }
            } else {
                if (addedIsSinopacMitsuiSelected) displayRate = (selectedSpend < spendingCap) ? "7.3" : "0.3";
                if (selectedSpend >= spendingCap) { statusText = 'ç‰¹é¸å·²å°é ‚'; } 
                else { statusText = `å‰© $${Math.floor(spendingCap - selectedSpend).toLocaleString()} (ç‰¹é¸)`; }
            }
            return { spend: totalSpend, validSpend: validSpend, reward: Math.round(reward), rate: displayRate, isCustom, cycleStart, cycleEnd, msgDanger: statusText, customLimit: limit };
        }
        
        // C4
        if (cardId === 'c4') {
            const baseReward = totalSpend * 0.005;
            let bonusReward = 0;
            if (totalSpend >= 3000) {
                const txList = [...relevantTx];
                if(addedAmount > 0) txList.push({ amount: addedAmount, isJiangSelected: addedIsJiangSelected, isJiangTravel: addedIsJiangTravel });
                const selectedSpend = txList.filter(t => t.isJiangSelected).reduce((sum, t) => sum + t.amount, 0);
                const selectedBonus = Math.min(selectedSpend, 6666) * 0.045;
                const travelTx = txList.filter(t => t.isJiangTravel);
                let qualifiedTravelSpend = 0;
                const travelExpiry = new Date('2026-03-31T23:59:59');
                travelTx.forEach(t => {
                    const tDate = new Date(t.date || new Date());
                    if (tDate <= travelExpiry) qualifiedTravelSpend += t.amount;
                });
                const travelBonus = Math.min(qualifiedTravelSpend, 11111) * 0.045;
                bonusReward = selectedBonus + travelBonus;
            }
            reward = baseReward + bonusReward;
            let displayRate = "0.5";
            if (totalSpend >= 3000) {
                if (addedIsJiangSelected) displayRate = "5.0";
                if (addedIsJiangTravel) displayRate = "5.0";
            }
            return { spend: totalSpend, validSpend: totalSpend, reward: Math.round(reward), rate: displayRate, isCustom, cycleStart, cycleEnd };
        }

        // C8
        if (cardId === 'c8') {
            if (totalSpend < 3000) {
                reward = totalSpend * 0.005;
                return { spend: totalSpend, validSpend: totalSpend, reward: Math.round(reward), rate: "0.5", isCustom, cycleStart, cycleEnd };
            } else {
                let baseReward = totalSpend * 0.005;
                const petSpend = relevantTx.filter(t => t.isHappyPet).reduce((sum, t) => sum + t.amount, 0) + (addedIsHappyPet ? addedAmount : 0);
                const lifeSpend = relevantTx.filter(t => t.isHappyLife).reduce((sum, t) => sum + t.amount, 0) + (addedIsHappyLife ? addedAmount : 0);
                const peaceSpend = relevantTx.filter(t => t.isHappyPeace).reduce((sum, t) => sum + t.amount, 0) + (addedIsHappyPeace ? addedAmount : 0);
                const foreignSpend = relevantTx.filter(t => t.isHappyForeign).reduce((sum, t) => sum + t.amount, 0) + (addedIsHappyForeign ? addedAmount : 0);
                const bonusPet = Math.min(petSpend, 5263) * 0.095;
                const bonusLife = Math.min(lifeSpend, 5714) * 0.035;
                const bonusPeace = Math.min(peaceSpend, 5714) * 0.035;
                const bonusForeign = foreignSpend * 0.02;
                reward = baseReward + bonusPet + bonusLife + bonusPeace + bonusForeign;
                if(totalSpend >= 26000) reward += 400;
                let displayRate = "0.5";
                if (addedIsHappyPet) displayRate = "10.0";
                else if (addedIsHappyLife || addedIsHappyPeace) displayRate = "4.0";
                else if (addedIsHappyForeign) displayRate = "2.5";
                return { spend: totalSpend, validSpend: totalSpend, reward: Math.round(reward), rate: displayRate, isCustom, cycleStart, cycleEnd };
            }
        }
        
        // C2
        if (cardId === 'c2') {
            let baseReward = totalSpend * 0.01;
            const greenSpend = relevantTx.filter(t => t.isGreen).reduce((sum, t) => sum + t.amount, 0) + (addedIsGreen ? addedAmount : 0);
            const bonusGreen = Math.min(greenSpend, 3000) * 0.05;
            const foreignSpend = relevantTx.filter(t => t.isForeign).reduce((sum, t) => sum + t.amount, 0) + (addedIsForeign ? addedAmount : 0);
            const bonusForeign = foreignSpend * 0.01;
            reward = baseReward + bonusGreen + bonusForeign;
            let displayRate = "1.0";
            if (addedIsGreen && greenSpend <= 3000) displayRate = "6.0";
            else if (addedIsForeign) displayRate = "2.0";
            return { spend: totalSpend, validSpend: totalSpend, reward: Math.round(reward), rate: displayRate, isCustom, cycleStart, cycleEnd };
        }
        
        // C7
        if (cardId === 'c7') {
            const isUpMode = addedIsUniUp || relevantTx.some(t => t.isUniUp);
            let currentRate = 0.035; 
            let currentCap = 40000;
            if (isUpMode) { currentRate = 0.045; currentCap = 142857; }
            let baseReward = 0;
            if (totalSpend <= currentCap) { baseReward = totalSpend * currentRate;
            } else { baseReward = (currentCap * currentRate) + ((totalSpend - currentCap) * 0.01); }
            const bonusSpend = relevantTx.filter(t => t.isUniBonus).reduce((sum, t) => sum + t.amount, 0) + (addedIsUniBonus ? addedAmount : 0);
            const bonusReward = Math.min(bonusSpend, 16666) * 0.03;
            reward = baseReward + bonusReward;
            return { spend: totalSpend, validSpend: totalSpend, reward: Math.round(reward), rate: (currentRate*100).toFixed(1), isCustom, cycleStart, cycleEnd };
        }
        
        // C6
        if (cardId === 'c6') {
            const bonus10TxSpend = relevantTx.filter(t => t.isBonus10).reduce((sum, t) => sum + t.amount, 0) + (addedIsBonus10 ? addedAmount : 0);
            const bonus10Reward = Math.min(bonus10TxSpend, 8000) * 0.10;
            const bonus25TxSpend = relevantTx.filter(t => t.isBonus25).reduce((sum, t) => sum + t.amount, 0) + (addedIsBonus25 ? addedAmount : 0);
            const selectedReward = Math.min(bonus25TxSpend, 400000) * 0.025;
            let baseReward = relevantTx.reduce((sum, t) => sum + (t.amount * (t.isBill ? 0.0015 : 0.01)), 0);
            if (addedAmount > 0) baseReward += addedAmount * (addedIsBill ? 0.0015 : 0.01);
            reward = baseReward + selectedReward + bonus10Reward;
            let currentRate = 13.5;
            if (totalSpend > 0) currentRate = (reward / totalSpend) * 100;
            return { spend: totalSpend, validSpend: totalSpend, reward: Math.round(reward), rate: currentRate.toFixed(1), isCustom, cycleStart, cycleEnd };
        }

        // C10
        if (cardId === 'c10') {
            const currentOverseasSpend = relevantTx.filter(t => t.isUniOverseas).reduce((sum, t) => sum + t.amount, 0) + (addedIsUniOverseas ? addedAmount : 0);
            const overseasReward = (currentOverseasSpend * 0.03) + Math.min(currentOverseasSpend, 6250) * 0.08;
            const icashSpend = relevantTx.filter(t => t.isUniIcash && !t.isUniOverseas).reduce((sum, t) => sum + t.amount, 0) + (addedIsUniIcash && !addedIsUniOverseas ? addedAmount : 0);
            const icashReward = Math.min(icashSpend, 3750) * 0.04;
            
            const groupTx = relevantTx.filter(t => t.isUniGroup && !t.isUniOverseas);
            let currentGroupSpend = groupTx.reduce((sum, t) => sum + t.amount, 0);
            if (addedIsUniGroup && !addedIsUniOverseas) currentGroupSpend += addedAmount;
            const groupBonus = Math.min(currentGroupSpend, 25000) * 0.02;
            
            const savedState = JSON.parse(localStorage.getItem('uniOpenState') || '{"brands":[]}');
            const count = savedState.brands ? savedState.brands.length : 0;
            let taskRate = 0;
            if (count >= 5) taskRate = 0.04;
            else if (count === 4) taskRate = 0.03;
            else if (count === 3) taskRate = 0.02;
            else if (count === 2) taskRate = 0.01;
            const taskBonus = Math.min(currentGroupSpend, 12500) * taskRate;
            const domesticSpend = totalSpend - currentOverseasSpend;
            const baseDomesticReward = domesticSpend * 0.01;
            reward = overseasReward + baseDomesticReward + groupBonus + taskBonus + icashReward;
            
            let displayRate = 1.0;
            if (addedIsUniOverseas) displayRate = 11.0;
            else if (addedIsUniGroup) {
                displayRate = 3.0;
                if (addedIsUniIcash) displayRate += 4.0;
                displayRate += (taskRate * 100);
            }
            return { spend: totalSpend, validSpend: totalSpend, reward: Math.round(reward), rate: displayRate.toFixed(1), isCustom, cycleStart, cycleEnd };
        }

        // C11
        if (cardId === 'c11') {
            const richartPaySpend = relevantTx.filter(t => t.isRichartPay).reduce((sum, t) => sum + t.amount, 0) + (addedIsRichartPay ? addedAmount : 0);
            const richartOnlineSpend = relevantTx.filter(t => t.isRichartOnline).reduce((sum, t) => sum + t.amount, 0) + (addedIsRichartOnline ? addedAmount : 0);
            const richartLineSpend = relevantTx.filter(t => t.isRichartLine).reduce((sum, t) => sum + t.amount, 0) + (addedIsRichartLine ? addedAmount : 0);
            const richartOverseasSpend = relevantTx.filter(t => t.isRichartOverseas).reduce((sum, t) => sum + t.amount, 0) + (addedIsRichartOverseas ? addedAmount : 0);
            const normalSpend = Math.max(0, totalSpend - richartPaySpend - richartOnlineSpend - richartLineSpend - richartOverseasSpend);
            reward = (richartPaySpend * 0.038) + (richartOnlineSpend * 0.033) + (richartLineSpend * 0.023) + (richartOverseasSpend * 0.033) + (normalSpend * 0.003);
            let currentRate = 0.3;
            if(totalSpend > 0) currentRate = (reward / totalSpend) * 100;
            else if(addedIsRichartPay) currentRate = 3.8;
            else if(addedIsRichartOnline) currentRate = 3.3;
            else if(addedIsRichartLine) currentRate = 2.3;
            else if(addedIsRichartOverseas) currentRate = 3.3;
            return { spend: totalSpend, validSpend: totalSpend, reward: Math.round(reward), rate: currentRate.toFixed(1), isCustom, cycleStart, cycleEnd };
        }

        // C9
        if (cardId === 'c9') {
            const tier = localStorage.getItem('hsbc_tier') || 'infinite';
            let rateDomestic = 18; let rateForeign = 10; if (tier === 'signature') { rateDomestic = 18; rateForeign = 15; }
            let totalMiles = parseInt(localStorage.getItem('hsbc_initial_miles') || 0);
            let redeemedMiles = parseInt(localStorage.getItem('hsbc_redeemed_miles') || 0);
            const allHistoryTx = transactions.filter(t => t.cardId === 'c9');
            allHistoryTx.forEach(tx => { const rate = tx.isHsbcForeign ? rateForeign : rateDomestic; totalMiles += Math.floor(tx.amount / rate); });
            if (addedAmount > 0) { const currentRate = addedIsHsbcForeign ? rateForeign : rateDomestic; totalMiles += Math.floor(addedAmount / currentRate); }
            reward = totalMiles - redeemedMiles;
            let cycleReward = 0;
            const { start, end } = getBillingCycle(cardId);
            const cycleTx = transactions.filter(t => { const tDate = new Date(t.date); return t.cardId === 'c9' && tDate >= start && tDate <= end; });
            cycleTx.forEach(tx => { const rate = tx.isHsbcForeign ? rateForeign : rateDomestic; cycleReward += Math.floor(tx.amount / rate); });
            if(addedAmount > 0) { const currentRate = addedIsHsbcForeign ? rateForeign : rateDomestic; cycleReward += Math.floor(addedAmount / currentRate); }
            return { spend: totalSpend, validSpend: totalSpend, reward: cycleReward, rate: (totalSpend>0?(totalSpend/totalMiles).toFixed(1):0), isCustom, cycleStart, cycleEnd };
        }
        
        // å…¶ä»–
        let validSpend = totalSpend;
        if (card.type === 'mixed') { if (validSpend < card.minSpend) reward = validSpend * card.tier2Rate;
        else if (validSpend <= card.limit) reward = validSpend * card.tier1Rate;
        else reward = (card.limit * card.tier1Rate) + ((validSpend - card.limit) * card.tier2Rate);
        } 
        else if (card.type === 'ceiling') { if (validSpend <= card.limit) reward = validSpend * card.tier1Rate;
        else reward = (card.limit * card.tier1Rate) + ((validSpend - card.limit) * card.tier2Rate);
        } 
        else { reward = validSpend * (card.tier1Rate || 0); }
        let currentRate = (card.tier1Rate || 0)*100;
        if(totalSpend>0) currentRate = (reward/totalSpend)*100;
        return { spend: totalSpend, validSpend: validSpend, reward: Math.round(reward), rate: currentRate.toFixed(1), isCustom, cycleStart, cycleEnd };
    }

    function toggleBillLogic() { const isBill = document.getElementById('checkIsBill').checked; document.getElementById('labelBaseRate').innerText = isBill ? "ğŸ”° åŸºæœ¬å›é¥‹ 0.15% (ç„¡ä¸Šé™)" : "ğŸ”° åŸºæœ¬å›é¥‹ 1% (ç„¡ä¸Šé™)"; if(isBill) document.getElementById('checkBonus25').checked = false; updateRewardPreview(); }
    function toggleSelectedLogic() { const isSelected = document.getElementById('checkBonus25').checked; document.getElementById('labelBaseRate').innerText = isSelected ? "ğŸ”° åŸºæœ¬å›é¥‹ 1% (ç„¡ä¸Šé™)" : "ğŸ”° åŸºæœ¬å›é¥‹ 1% (ç„¡ä¸Šé™)"; if(isSelected) document.getElementById('checkIsBill').checked = false; updateRewardPreview(); }
    function toggleGreenLogic() { if(document.getElementById('checkGreenChannel').checked) document.getElementById('checkForeign').checked = false; updateRewardPreview(); }
    function toggleForeignLogic() { if(document.getElementById('checkForeign').checked) document.getElementById('checkGreenChannel').checked = false; updateRewardPreview(); }
    function toggleHappyPet() { if(document.getElementById('checkHappyPet').checked) { document.getElementById('checkHappyPeace').checked = false; document.getElementById('checkHappyLife').checked = false; document.getElementById('checkHappyForeign').checked = false; } updateRewardPreview(); }
    function toggleHappyPeace() { if(document.getElementById('checkHappyPeace').checked) { document.getElementById('checkHappyPet').checked = false; document.getElementById('checkHappyLife').checked = false; document.getElementById('checkHappyForeign').checked = false; } updateRewardPreview(); }
    function toggleHappyLife() { if(document.getElementById('checkHappyLife').checked) { document.getElementById('checkHappyPet').checked = false; document.getElementById('checkHappyPeace').checked = false; document.getElementById('checkHappyForeign').checked = false; } updateRewardPreview(); }
    function toggleHappyForeign() { if(document.getElementById('checkHappyForeign').checked) { document.getElementById('checkHappyPet').checked = false; document.getElementById('checkHappyPeace').checked = false; document.getElementById('checkHappyLife').checked = false; } updateRewardPreview(); }
    function toggleRichartLogic() { updateRewardPreview(); }

    function updateRewardPreview() {
        const inputVal = document.getElementById('amountInput').value;
        const amount = parseFloat(inputVal);
        const previewDiv = document.getElementById('liveRewardCalc');
        const cardId = document.getElementById('cardIdInput').value;
        if (!amount || amount <= 0) { previewDiv.style.display = 'none'; return; }
        previewDiv.style.display = 'block'; 
        
        let isGreen = document.getElementById('checkGreenChannel') ? document.getElementById('checkGreenChannel').checked : false;
        let isForeign = document.getElementById('checkForeign') ? document.getElementById('checkForeign').checked : false;
        let isUniUp = document.getElementById('checkUniUp') ? document.getElementById('checkUniUp').checked : false;
        let isUniBonus = document.getElementById('checkUniBonus') ? document.getElementById('checkUniBonus').checked : false;
        let isHappyPet = document.getElementById('checkHappyPet') ? document.getElementById('checkHappyPet').checked : false;
        let isHappyPeace = document.getElementById('checkHappyPeace') ? document.getElementById('checkHappyPeace').checked : false;
        let isHappyLife = document.getElementById('checkHappyLife') ? document.getElementById('checkHappyLife').checked : false;
        let isHappyForeign = document.getElementById('checkHappyForeign') ? document.getElementById('checkHappyForeign').checked : false;
        let isHsbcForeign = document.getElementById('checkHsbcForeign') ? document.getElementById('checkHsbcForeign').checked : false;
        let isUniGroup = document.getElementById('checkUniGroup') ? document.getElementById('checkUniGroup').checked : false;
        let isUniIcash = document.getElementById('checkUniIcash') ? document.getElementById('checkUniIcash').checked : false;
        let isUniOverseas = document.getElementById('checkUniOverseas') ? document.getElementById('checkUniOverseas').checked : false;
        let richartMode = document.querySelector('input[name="richartMode"]:checked') ? document.querySelector('input[name="richartMode"]:checked').value : 'general';
        let isRichartPay = richartMode === 'pay';
        let isRichartOnline = richartMode === 'online';
        let isRichartLine = richartMode === 'line';
        let isRichartOverseas = richartMode === 'overseas';
        
        let isBonus10 = document.getElementById('checkBonus10') ? document.getElementById('checkBonus10').checked : false;
        let isBonus25 = document.getElementById('checkBonus25') ? document.getElementById('checkBonus25').checked : false;
        let isBill = document.getElementById('checkIsBill') ? document.getElementById('checkIsBill').checked : false;
        // J1
        let isFubonJGeneral = document.getElementById('checkFubonJGeneral') ? document.getElementById('checkFubonJGeneral').checked : false;
        let isFubonJKorea = document.getElementById('checkFubonJKorea') ? document.getElementById('checkFubonJKorea').checked : false;
        let isFubonJThai = document.getElementById('checkFubonJThai') ? document.getElementById('checkFubonJThai').checked : false;
        let isFubonJSuica = document.getElementById('checkFubonJSuica') ? document.getElementById('checkFubonJSuica').checked : false;
        
        let isJiheJapan = document.getElementById('checkJiheJapan') ? document.getElementById('checkJiheJapan').checked : false;
        let isJiheApple = document.getElementById('checkJiheApple') ? document.getElementById('checkJiheApple').checked : false;
        let isJiheDomesticJapanese = document.getElementById('checkJiheDomesticJapanese') ? document.getElementById('checkJiheDomesticJapanese').checked : false;
        let isKumamonJapan = document.getElementById('checkKumamonJapan') ? document.getElementById('checkKumamonJapan').checked : false;
        let isKumamonDesignated = document.getElementById('checkKumamonDesignated') ? document.getElementById('checkKumamonDesignated').checked : false;
        let isKumamonPayPay = document.getElementById('checkKumamonPayPay') ? document.getElementById('checkKumamonPayPay').checked : false;
        
        let isSinopacCurrencySelected = document.getElementById('checkSinopacCurrencySelected') ? document.getElementById('checkSinopacCurrencySelected').checked : false;
        let isSinopacMitsuiSelected = document.getElementById('checkSinopacMitsuiSelected') ? document.getElementById('checkSinopacMitsuiSelected').checked : false;
        let isSinopacMitsuiTarget = document.getElementById('checkSinopacMitsuiTarget') ? document.getElementById('checkSinopacMitsuiTarget').checked : false;
        let jiangMode = document.querySelector('input[name="jiangMode"]:checked') ? document.querySelector('input[name="jiangMode"]:checked').value : 'base';
        let isJiangSelected = jiangMode === 'selected';
        let isJiangTravel = jiangMode === 'travel';
        let currencyType = document.querySelector('input[name="currencyType"]:checked') ? document.querySelector('input[name="currencyType"]:checked').value : 'domestic';
        let isSinopacCurrencySelectedFinal = (currencyType === 'selected');

        const currentStats = calculateStats(cardId, 0);
        const newStats = calculateStats(cardId, amount, isGreen, isForeign, isUniBonus, isUniUp, isHappyPet, isHappyLife, isHappyForeign, isHappyPeace, isHsbcForeign, isUniGroup, isUniIcash, isUniOverseas, isRichartPay, isRichartOnline, isRichartLine, isRichartOverseas, isBonus10, isBonus25, isBill,
            isFubonJGeneral, isFubonJKorea, isFubonJThai, isFubonJSuica,
            isJiheJapan, isJiheApple, isJiheDomesticJapanese,
            isKumamonJapan, isKumamonDesignated, isKumamonPayPay, 
            isSinopacCurrencySelectedFinal,
            isSinopacMitsuiSelected, isSinopacMitsuiTarget,
            isJiangSelected, isJiangTravel);
        const thisTransactionReward = newStats.reward - currentStats.reward;
        if (cardId === 'c9') { 
            previewDiv.innerHTML = `âœ¨ é è¨ˆå›é¥‹ï¼š${thisTransactionReward} å“©`;
        } else { 
            const effectiveRate = (thisTransactionReward / amount) * 100;
            if (effectiveRate > 20) {
                previewDiv.innerHTML = `âœ¨ é è¨ˆå›é¥‹ï¼š$${thisTransactionReward} (å«é”æ¨™å›æº¯)`;
            } else {
                previewDiv.innerHTML = `âœ¨ é è¨ˆå›é¥‹ï¼š$${thisTransactionReward} (${effectiveRate.toFixed(1)}%)`;
            }
        }
    }

    function renderGrid() {
        const container = document.getElementById('card-grid');
        let monthTotalReward = 0; container.innerHTML = '';
        cards.forEach(card => { if (card.type === 'placeholder') return; const stats = calculateStats(card.id); if (card.id !== 'c9') monthTotalReward += (Number(stats.reward) || 0); });
        document.getElementById('totalRewardDisplay').innerText = `$${monthTotalReward.toLocaleString()}`;
        const displayCards = getSortedCards();

        displayCards.forEach(card => {
            const stats = calculateStats(card.id); 
            let percent = 0, statusText = '', msgStyle = '';
            let displayRate = `${stats.rate}%`;

            if (card.id === 'c10') {
                statusText = `æœ¬æœˆå·²è³º ${stats.reward} é»`;
                const savedState = JSON.parse(localStorage.getItem('uniOpenState') || '{}');
                if (savedState.icash) {
                    const icashSpend = transactions.filter(t => t.cardId === 'c10' && t.isUniIcash).reduce((sum, t) => sum + t.amount, 0);
                    if (icashSpend >= 3750) { msgStyle = 'color:#d32f2f;'; statusText = 'icashå›é¥‹å·²æ»¿'; }
                }
            } else if (card.id === 'c9') {
                const tier = localStorage.getItem('hsbc_tier') || 'infinite';
                card.name = (tier === 'infinite') ? 'æ»™è±æ—…äººç„¡é™å¡' : 'æ»™è±æ—…äººå¾¡ç’½å¡';
                card.note = (tier === 'infinite') ? 'åœ‹å…§18/åœ‹å¤–10 (å“©)' : 'åœ‹å…§18/åœ‹å¤–15 (å“©)';
                let totalMiles = parseInt(localStorage.getItem('hsbc_initial_miles') || 0);
                let redeemedMiles = parseInt(localStorage.getItem('hsbc_redeemed_miles') || 0);
                const allHistoryTx = transactions.filter(t => t.cardId === 'c9');
                const rateDomestic = (tier === 'infinite') ? 18 : 18;
                const rateForeign = (tier === 'infinite') ? 10 : 15;
                allHistoryTx.forEach(tx => { const rate = tx.isHsbcForeign ? rateForeign : rateDomestic; totalMiles += Math.floor(tx.amount / rate); });
                const finalTotal = Math.max(0, totalMiles - redeemedMiles);
                statusText = `ç¸½å“©ç¨‹ ${finalTotal.toLocaleString()} å“©`;
                msgStyle = 'color: #007AFF; font-weight:bold;';
            } else if (card.id === 'c8') { 
                if (stats.spend < 3000) { 
                    percent = (stats.spend / 3000) * 100;
                    statusText = `å·® $${(3000 - stats.spend).toLocaleString()} å‡ç´šå›é¥‹`;
                    msgStyle = 'color: #FFD700;';
                } else if (stats.spend < 26000) { percent = (stats.spend / 26000) * 100;
                statusText = `å·® $${(26000 - stats.spend).toLocaleString()} é ˜æ»¿é¡ç¦®`; } 
                else { percent = 100;
                statusText = 'ğŸ‰ æ»¿é¡é”æ¨™ (è¨˜å¾—ç™»éŒ„!)'; msgStyle = 'color: #38ef7d;'; }
            } else if (card.type === 'mixed') { 
                if (stats.validSpend < card.minSpend) { 
                    percent = (stats.validSpend / card.minSpend) * 100;
                    statusText = `âš ï¸ å·® $${(card.minSpend - stats.validSpend).toLocaleString()} å•Ÿå‹•åŠ ç¢¼`;
                    msgStyle = 'color: #FFD700; font-weight: bold;';
                }
                else if (stats.validSpend <= card.limit) { 
                    percent = (stats.validSpend / card.limit) * 100;
                    const remain = card.limit - stats.validSpend; 
                    statusText = `å‰© $${remain.toLocaleString()} (5%)`;
                }
                else { percent = 100;
                statusText = 'å·²å°é ‚ (è®Š0.5%)'; msgStyle = 'color: #ffcccc;'; }
            } else if (card.type === 'ceiling' || card.type === 'custom_j' || card.id === 'j2' || card.id === 'j3' || card.id === 'j4' || card.id === 'j5') {
                if(card.id === 'j1') {
                    statusText = `æœ¬æœˆç´¯ç© $${stats.spend.toLocaleString()}`;
                    percent = 0; 
                } else {
                    const limit = stats.customLimit || card.limit;
                    if(limit > 0) percent = (stats.validSpend / limit) * 100;
                    else percent = 0;
                    if (stats.msgDanger) {
                        statusText = stats.msgDanger;
                        if(stats.msgDanger.includes('å·²å°é ‚')) msgStyle = 'color: #ffcccc;';
                    } else if (stats.validSpend <= limit) { 
                        const remain = limit - stats.validSpend;
                        statusText = `å‰© $${remain.toLocaleString()}`;
                        if(remain < 1000) {statusText = `âš ï¸ å‰© $${remain.toLocaleString()}`;
                        msgStyle='color:#FFD700;';} 
                    } else { 
                        percent = 100;
                        statusText = card.msgDanger; msgStyle = 'color: #ffcccc;'; 
                    }
                }
            } else if (card.id === 'c2') {
                percent = (stats.validSpend / 12000) * 100;
                if (stats.validSpend >= 12000) {
                    statusText = 'å·²é”æ¨™ (ä¸‹æœˆå…åœ)';
                    msgStyle = 'color: #38ef7d; font-weight:bold;';
                    percent = 100;
                } else {
                    statusText = `å·® $${(12000 - stats.validSpend).toLocaleString()} äº«å…è²»åœè»Š`;
                    msgStyle = 'color: #FFD700;';
                }
            } else { 
                percent = (stats.validSpend / card.target) * 100;
                statusText = stats.validSpend >= card.target ? 'ä»»å‹™é”æˆ' : `å·® $${(card.target - stats.validSpend).toLocaleString()}`;
            }

            if (card.id === 'c6') displayRate = '13.5%';
            if (card.id === 'c1') displayRate = '10.0%';
            if (card.id === 'c5') displayRate = '6.0%';
            if (card.id === 'c3') displayRate = '5.0%';
            if (card.id === 'c4') displayRate = '5.0%';
            if (card.id === 'c2') displayRate = '6.0%';
            if (card.id === 'c7') displayRate = '4.5%';
            if (card.id === 'c8') displayRate = '10.0%';
            if (card.id === 'c9') displayRate = 'å“©ç¨‹';
            if (card.id === 'c10') displayRate = '11.0%';
            if (card.id === 'c11') displayRate = '3.8%';
            if (card.id === 'j1') displayRate = '10.0%';
            if (card.id === 'j2') displayRate = '4.0%';
            if (card.id === 'j3') displayRate = '8.5%';
            if (card.id === 'j4') displayRate = '6.0%';
            if (card.id === 'j5') displayRate = '7.3%';
            if (card.type === 'placeholder') displayRate = '--%';
            
            let tileClass = 'card-tile';
            let nickClass = 'tile-nickname-badge';
            if (card.type === 'placeholder') nickClass += ' placeholder';
            const tile = document.createElement('div'); tile.className = tileClass;
            tile.setAttribute('data-card-id', card.id);
            tile.style.background = card.gradient;
            tile.style.color = card.textColor; 
            tile.onclick = () => card.type === 'placeholder' ? openManageModal() : openQuickAdd(card.id);
            let earnedText = `+$${stats.reward.toLocaleString()}`;
            if (card.id === 'c9') { earnedText = `+${stats.reward.toLocaleString()} å“©`; }
            let cycleHint = '';
            if (stats.isCustom) {
                cycleHint = `<div class="tile-cycle-hint">é€±æœŸ: ${stats.cycleStart.getMonth()+1}/${stats.cycleStart.getDate()}-${stats.cycleEnd.getMonth()+1}/${stats.cycleEnd.getDate()}</div>`;
            }

            tile.innerHTML = `<div class="tile-header"><span class="tile-name">${card.name}</span><span class="rate-badge" style="color:black">${displayRate}</span></div><div class="${nickClass}">${card.nickname}</div><span class="tile-note" style="color:${card.textColor==='white'?'rgba(255,255,255,0.8)':'rgba(0,0,0,0.6)'}">${card.note}</span><div class="tile-body"><div class="tile-stat">$${stats.spend.toLocaleString()}</div><div class="tile-earned">${earnedText}</div></div><div class="tile-footer"><div class="progress-track"><div class="progress-fill" style="width:${Math.min(percent, 100)}%"></div></div><div class="tile-msg" style="${msgStyle}">${statusText}</div>${cycleHint}</div>`;
            container.appendChild(tile);
        });
        checkUrgentTasks(); initSortable();
    }
    
    function openManageModal() {
        const list = document.getElementById('manageCardList');
        list.innerHTML = '';
        const realCardIds = ['c6', 'c1', 'c5', 'c3', 'c4', 'c2', 'c7', 'c8', 'c9', 'c10', 'c11', 'j1', 'j2', 'j3', 'j4', 'j5'];
        const currentRealCardsCount = visibleCards.filter(id => realCardIds.includes(id)).length;
        cards.forEach(card => {
            if (card.id === 'add1') return; 
            const isVisible = visibleCards.includes(card.id);
            const item = document.createElement('div'); item.className = 'manage-item';
            
            const settingBtn = document.createElement('button');
            settingBtn.className = 'btn-card-setting';
            settingBtn.innerHTML = 'âš™ï¸';
            settingBtn.onclick = (e) => { e.stopPropagation(); editCardSettings(card.id); };

            const label = document.createElement('label'); label.className = 'switch'; label.onclick = function(e) { e.stopPropagation(); }; 
            const input = document.createElement('input'); input.type = 'checkbox'; input.checked = isVisible;
            input.onchange = function() { if (this.checked && currentRealCardsCount >= 8) 
            { alert('âš ï¸ æœ€å¤šåªèƒ½é¡¯ç¤º 8 å¼µå¡ç‰‡ï¼Œè«‹å…ˆéš±è—ä¸€å¼µï¼'); this.checked = false; return; } toggleCardVisibility(card.id); };
            const slider = document.createElement('span');
            slider.className = 'slider'; label.appendChild(input); label.appendChild(slider);
            
            item.onclick = function(e) { if (e.target.tagName === 'INPUT' || e.target.tagName === 'BUTTON') return;
            const checkbox = this.querySelector('input[type="checkbox"]'); if (!checkbox.checked && currentRealCardsCount >= 8) { alert('âš ï¸ æœ€å¤šåªèƒ½é¡¯ç¤º 8 å¼µå¡ç‰‡ï¼Œè«‹å…ˆéš±è—ä¸€å¼µï¼'); return; } checkbox.checked = !checkbox.checked;
            toggleCardVisibility(card.id); };

            item.innerHTML = `<div class="manage-info"><div class="manage-name">${card.name}</div><div class="manage-desc">${card.nickname}</div></div>`; 
            item.appendChild(settingBtn);
            item.appendChild(label); 
            list.appendChild(item);
        });
        document.getElementById('manageModal').style.display = 'flex';
        renderScenes(); // ç¢ºä¿æ‰“é–‹ç®¡ç†è¦–çª—æ™‚åˆ·æ–°æƒ…å¢ƒåˆ—è¡¨
    }

    function editCardSettings(cardId) {
        const current = cardSettings[cardId] || {};
        const bDay = prompt(
            'è«‹è¼¸å…¥å¸³å–®çµå¸³æ—¥ï¼Œç³»çµ±æœƒè‡ªå‹•ç‚ºæ‚¨è¨ˆç®—å¸³å–®é€±æœŸ \n\n' +
            'ä¾‹å¦‚ï¼šæ¯æœˆ 17 è™Ÿçµå¸³ï¼Œè«‹è¼¸å…¥ 17ã€‚\n' + 
            '(è‹¥ä¸è¼¸å…¥æˆ–è¼¸å…¥ 1ï¼Œé è¨­ç‚ºæ¯æœˆ 1 è™Ÿè‡³æœˆåº•)', 
            current.billingDay || ''
        );
        if (bDay !== null) {
            const dayNum = parseInt(bDay);
            if (!isNaN(dayNum) && dayNum >= 1 && dayNum <= 31) {
                cardSettings[cardId] = { billingDay: dayNum };
            } else {
                delete cardSettings[cardId];
            }
            localStorage.setItem('cardSettings', JSON.stringify(cardSettings));
            renderGrid();
        }
    }
    
    function toggleCardVisibility(cardId) {
        if (visibleCards.includes(cardId)) { visibleCards = visibleCards.filter(id => id !== cardId);
        const realCardsCount = visibleCards.filter(id => id !== 'add1').length; if (realCardsCount < 8 && !visibleCards.includes('add1')) { visibleCards.push('add1');
        } } 
        else { visibleCards.push(cardId);
        if (visibleCards.includes('add1')) { visibleCards = visibleCards.filter(id => id !== 'add1');
        } }
        localStorage.setItem('visibleCards', JSON.stringify(visibleCards)); openManageModal(); renderGrid();
    }

    function openQuickAdd(cardId) {
        const card = cards.find(c => c.id === cardId);
        document.getElementById('modalTitle').innerText = card.name; 
        document.getElementById('modalSubtitle').innerText = card.note;
        
        if (cardId === 'c10') { document.getElementById('modalSubtitle').style.display = 'none'; } else { document.getElementById('modalSubtitle').style.display = 'block'; }

        document.getElementById('cardIdInput').value = cardId;
        const now = new Date();
        const day = String(now.getDate()).padStart(2, '0');
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const year = now.getFullYear();
        const today = `${year}-${month}-${day}`;
        document.getElementById('dateInput').value = today;
        
        editingId = null;
        document.getElementById('btn-confirm').innerText = "ç¢ºèª";
        document.getElementById('transactionModal').style.display = 'flex';
        const allOptionIds = ['pigRichOptions', 'greenCardOptions', 'uniOptions', 'happyOptions', 'hsbcOptions', 'uniOpenOptions', 'richartOptions', 'fubonJOptions', 'jiheOptions', 'kumamonOptions', 'sinopacCurrencyOptions', 'sinopacMitsuiOptions', 'jiangOptions'];
        allOptionIds.forEach(id => { document.getElementById(id).style.display = 'none'; });

        if (cardId === 'c6') document.getElementById('pigRichOptions').style.display = 'block';
        if (cardId === 'c2') document.getElementById('greenCardOptions').style.display = 'block';
        if (cardId === 'c7') {
             document.getElementById('uniOptions').style.display = 'block';
             toggleUniUpLogic(); 
        }
        if (cardId === 'c8') document.getElementById('happyOptions').style.display = 'block';
        if (cardId === 'c9') document.getElementById('hsbcOptions').style.display = 'block';
        if (cardId === 'c10') {
            document.getElementById('uniOpenOptions').style.display = 'block';
            const savedState = JSON.parse(localStorage.getItem('uniOpenState') || '{}');
            document.getElementById('checkUniGroup').checked = !!savedState.group;
            document.getElementById('checkUniIcash').checked = !!savedState.icash;
            document.getElementById('checkUniOverseas').checked = !!savedState.overseas;
            initUniBrandGrid();
            if(savedState.brands) {
                const btns = document.querySelectorAll('.brand-btn');
                btns.forEach(btn => { if(savedState.brands.includes(btn.innerText)) btn.classList.add('active'); });
            }
            const count = savedState.brands ? savedState.brands.length : 0;
            updateTaskBonusDisplay(count);
        }
        
        if (cardId === 'c11') {
            document.getElementById('richartOptions').style.display = 'block';
            document.getElementById('rbRichartGeneral').checked = true;
        }

        if (cardId === 'j1') { document.getElementById('fubonJOptions').style.display = 'block'; toggleFubonJGeneral(); }
        if (cardId === 'j2') { document.getElementById('jiheOptions').style.display = 'block'; toggleJiheLogic(); }
        if (cardId === 'j3') { document.getElementById('kumamonOptions').style.display = 'block'; toggleKumamonLogic(); }
        if (cardId === 'j4') { 
            document.getElementById('sinopacCurrencyOptions').style.display = 'block';
            document.querySelector('input[name="currencyType"][value="domestic"]').checked = true;
            const savedLevel = localStorage.getItem('currency_level') || 'low';
            const levelRadio = document.querySelector(`input[name="currencyLevel"][value="${savedLevel}"]`);
            if (levelRadio) levelRadio.checked = true;
            toggleCurrencyLogic();
        }
        if (cardId === 'j5') { document.getElementById('sinopacMitsuiOptions').style.display = 'block'; }
        
        if (cardId === 'c4') {
            document.getElementById('jiangOptions').style.display = 'block';
            document.querySelector('input[name="jiangMode"][value="base"]').checked = true;
            const today = new Date();
            const expiry = new Date('2026-03-31T23:59:59');
            const travelRow = document.getElementById('jiangTravelRow');
            const travelMsg = document.getElementById('jiangTravelExpMsg');
            const travelCheck = document.getElementById('rbJiangTravel');
            
            if (today > expiry) {
                travelRow.classList.add('expired');
                travelCheck.disabled = true;
                travelCheck.checked = false;
                travelMsg.style.display = 'block';
            } else {
                travelRow.classList.remove('expired');
                travelCheck.disabled = false;
                travelMsg.style.display = 'none';
            }
        }

        if (card.parking) { document.getElementById('modalParkingInfo').innerHTML = card.parking;
            document.getElementById('modalParkingInfo').style.display = 'block';
        } else { document.getElementById('modalParkingInfo').style.display = 'none'; }
        
        if (cardId === 'c8') document.getElementById('happyDashboard').style.display = 'block';
        else document.getElementById('happyDashboard').style.display = 'none';

        if (cardId === 'c9') { 
            const savedTier = localStorage.getItem('hsbc_tier') || 'infinite'; 
            document.querySelector(`input[name="hsbcTier"][value="${savedTier}"]`).checked = true; 
            document.getElementById('checkHsbcForeign').checked = false; 
            document.getElementById('hsbcInitialMiles').value = localStorage.getItem('hsbc_initial_miles') || '';
            document.getElementById('hsbcRedeemedMiles').value = localStorage.getItem('hsbc_redeemed_miles') || '';
        }

        document.getElementById('liveRewardCalc').style.display = 'none'; document.getElementById('liveRewardCalc').innerHTML = '';
        
        document.getElementById('amountInput').value = '';
        document.getElementById('noteInput').value = '';
        if (cardId === 'c6') {
             const isBill = document.getElementById('checkIsBill').checked;
             document.getElementById('labelBaseRate').innerText = isBill ? "ğŸ”° åŸºæœ¬å›é¥‹ 0.15% (ç„¡ä¸Šé™)" : "ğŸ”° åŸºæœ¬å›é¥‹ 1% (ç„¡ä¸Šé™)";
        }
        
        renderModalHistory(cardId);
        if(cardId === 'c8') injectDetails();
        
        setTimeout(() => document.getElementById('amountInput').focus(), 100);
    }
    
    // â˜…â˜…â˜… é—œéµä¿®æ­£ï¼šrenderModalHistory å„ªåŒ– (ç„¡å‚™è¨»å‰‡ç©ºç™½) â˜…â˜…â˜…
    function renderModalHistory(cardId) {
        const list = document.getElementById('modalHistoryList');
        const title = document.getElementById('modalHistoryTitle');
        list.innerHTML = '';
        
        const { start, end } = getBillingCycle(cardId);
        const history = transactions.filter(t => {
            const tDate = new Date(t.date);
            return t.cardId === cardId && tDate >= start && tDate <= end;
        });
        title.innerHTML = `<span>ğŸ“… ${start.getMonth()+1}/${start.getDate()} - ${end.getMonth()+1}/${end.getDate()} æ¶ˆè²»ç´€éŒ„</span><span style="font-weight:normal; font-size:10px; color:#aaa;">(é»æ“Šæ–‡å­—ä¿®æ”¹ / âœ• åˆªé™¤)</span>`;
        history.sort((a, b) => new Date(b.date) - new Date(a.date));

        if (history.length === 0) {
            list.innerHTML = '<div style="text-align:center; color:#ccc; padding:20px; font-size:12px;">æœ¬æœŸå°šç„¡ç´€éŒ„</div>';
            return;
        }

        history.forEach(t => {
            const item = document.createElement('div');
            item.className = 'history-item';
            
            // å„ªåŒ–é»ï¼šå¦‚æœæ²’æœ‰ noteï¼Œå°±çµ¦ç©ºå­—ä¸² (CSS h-name å·²è¨­å®š min-height é˜²æ­¢å¡Œé™·)
            let displayText = t.note || ''; 
            
            let tags = [];
            const isCard = (id) => t.cardId === id;

            if(isCard('c2') && t.isGreen) tags.push('ğŸŒ¿');
            if(isCard('c2') && t.isForeign) tags.push('âœˆï¸');
            
            if(isCard('c7') && t.isUniUp) tags.push('ğŸ†™');
            if(isCard('c7') && t.isUniBonus) tags.push('ğŸ”¥');
            
            if(isCard('c8') && t.isHappyPet) tags.push('ğŸ¶');
            if(isCard('c8') && t.isHappyPeace) tags.push('ğŸ½ï¸');
            if(isCard('c8') && t.isHappyLife) tags.push('ğŸ›’');
            if(isCard('c8') && t.isHappyForeign) tags.push('âœˆï¸');
            
            if(isCard('c9') && t.isHsbcForeign) tags.push('âœˆï¸');
            
            if(isCard('c10') && t.isUniGroup) tags.push('ğŸª');
            if(isCard('c10') && t.isUniIcash) tags.push('ğŸ“±');
            if(isCard('c10') && t.isUniOverseas) tags.push('âœˆï¸');
            
            if(isCard('c11') && t.isRichartPay) tags.push('ğŸ“±');
            if(isCard('c11') && t.isRichartOnline) tags.push('ğŸ›ï¸');
            if(isCard('c11') && t.isRichartLine) tags.push('ğŸŸ¢');
            if(isCard('c11') && t.isRichartOverseas) tags.push('âœˆï¸');
            
            if(isCard('c6') && t.isBonus10) tags.push('âš¡');
            if(isCard('c6') && t.isBonus25) tags.push('ğŸŒŸ');
            if(isCard('c6') && t.isBill) tags.push('ğŸ§¾');
            // Jå¡ç³»åˆ—
            if(isCard('j1') && t.isFubonJGeneral) tags.push('ğŸ‡¯ğŸ‡µ');
            if(isCard('j1') && t.isFubonJKorea) tags.push('ğŸ›ï¸');
            if(isCard('j1') && t.isFubonJThai) tags.push('ğŸ‡¹ğŸ‡­');
            if(isCard('j1') && t.isFubonJSuica) tags.push('ğŸ');
            // å‰é¶´
            if(isCard('j2') && t.isJiheJapan) tags.push('ğŸ‡¯ğŸ‡µ');
            if(isCard('j2') && t.isJiheApple) tags.push('ğŸ');
            if(isCard('j2') && t.isJiheDomesticJapanese) tags.push('ğŸ‡¹ğŸ‡¼');
            
            // ç†Šæœ¬ç†Š
            if(isCard('j3') && t.isKumamonJapan) tags.push('ğŸ‡¯ğŸ‡µ');
            if(isCard('j3') && t.isKumamonDesignated) tags.push('ğŸ»');
            if(isCard('j3') && t.isKumamonPayPay) tags.push('ğŸ“±');
            
            // å¹£å€
            if(isCard('j4') && t.isSinopacCurrencySelected) tags.push('âœˆï¸');
            // ä¸‰äº•
            if(isCard('j5') && t.isSinopacMitsuiSelected) tags.push('ğŸ½ï¸');
            if(isCard('j5') && t.isSinopacMitsuiTarget) tags.push('ğŸ‡¯ğŸ‡µ');
            
            // å°‡å°‡
            if(isCard('c4') && t.isJiangSelected) tags.push('ğŸ›ï¸');
            if(isCard('c4') && t.isJiangTravel) tags.push('âœˆï¸');

            const tagStr = tags.length > 0 ? tags.join('') + ' ' : '';
            item.innerHTML = `
                <div style="flex:1" onclick="loadTransaction(${t.id})">
                    <div class="h-name">${tagStr}${displayText}</div>
                    <div class="h-date">${t.date}</div>
                </div>
                <div style="display:flex; align-items:center;">
                    <div class="h-amount" onclick="loadTransaction(${t.id})">$${t.amount.toLocaleString()}</div>
                    <button class="btn-delete-single" onclick="deleteTransaction(${t.id}, event)">âœ•</button>
                </div>
            `;
            list.appendChild(item);
        });
    }

    let editingId = null;
    function loadTransaction(id) {
        const tx = transactions.find(t => t.id === id);
        if (!tx) return;
        editingId = id;
        document.getElementById('amountInput').value = tx.amount;
        document.getElementById('dateInput').value = tx.date;
        document.getElementById('noteInput').value = tx.note;
        document.getElementById('btn-confirm').innerText = "ä¿®æ”¹";
        // è¼‰å…¥å±¬æ€§ (Checkbox ç‹€æ…‹)
        if(document.getElementById('checkGreenChannel')) document.getElementById('checkGreenChannel').checked = !!tx.isGreen;
        if(document.getElementById('checkForeign')) document.getElementById('checkForeign').checked = !!tx.isForeign;
        if(document.getElementById('checkUniUp')) document.getElementById('checkUniUp').checked = !!tx.isUniUp;
        if(document.getElementById('checkUniBonus')) document.getElementById('checkUniBonus').checked = !!tx.isUniBonus;
        if(document.getElementById('checkHappyPet')) document.getElementById('checkHappyPet').checked = !!tx.isHappyPet;
        if(document.getElementById('checkHappyPeace')) document.getElementById('checkHappyPeace').checked = !!tx.isHappyPeace;
        if(document.getElementById('checkHappyLife')) document.getElementById('checkHappyLife').checked = !!tx.isHappyLife;
        if(document.getElementById('checkHappyForeign')) document.getElementById('checkHappyForeign').checked = !!tx.isHappyForeign;
        if(document.getElementById('checkHsbcForeign')) document.getElementById('checkHsbcForeign').checked = !!tx.isHsbcForeign;
        if(document.getElementById('checkUniGroup')) document.getElementById('checkUniGroup').checked = !!tx.isUniGroup;
        if(document.getElementById('checkUniIcash')) document.getElementById('checkUniIcash').checked = !!tx.isUniIcash;
        if(document.getElementById('checkUniOverseas')) document.getElementById('checkUniOverseas').checked = !!tx.isUniOverseas;
        // Richart Radio
        if(tx.isRichartPay) document.getElementById('rbRichartPay').checked = true;
        else if(tx.isRichartOnline) document.getElementById('rbRichartOnline').checked = true;
        else if(tx.isRichartLine) document.getElementById('rbRichartLine').checked = true;
        else if(tx.isRichartOverseas) document.getElementById('rbRichartOverseas').checked = true;
        else if(document.getElementById('rbRichartGeneral')) document.getElementById('rbRichartGeneral').checked = true;

        if(document.getElementById('checkBonus10')) document.getElementById('checkBonus10').checked = !!tx.isBonus10;
        if(document.getElementById('checkBonus25')) document.getElementById('checkBonus25').checked = !!tx.isBonus25;
        if(document.getElementById('checkIsBill')) document.getElementById('checkIsBill').checked = !!tx.isBill;
        
        // Jå¡
        if(document.getElementById('checkFubonJGeneral')) document.getElementById('checkFubonJGeneral').checked = !!tx.isFubonJGeneral;
        if(document.getElementById('checkFubonJKorea')) document.getElementById('checkFubonJKorea').checked = !!tx.isFubonJKorea;
        if(document.getElementById('checkFubonJThai')) document.getElementById('checkFubonJThai').checked = !!tx.isFubonJThai;
        if(document.getElementById('checkFubonJSuica')) document.getElementById('checkFubonJSuica').checked = !!tx.isFubonJSuica;
        // å‰é¶´
        if(document.getElementById('checkJiheJapan')) document.getElementById('checkJiheJapan').checked = !!tx.isJiheJapan;
        if(document.getElementById('checkJiheApple')) document.getElementById('checkJiheApple').checked = !!tx.isJiheApple;
        if(document.getElementById('checkJiheDomesticJapanese')) document.getElementById('checkJiheDomesticJapanese').checked = !!tx.isJiheDomesticJapanese;
        
        // ç†Šæœ¬ç†Š
        if(document.getElementById('checkKumamonJapan')) document.getElementById('checkKumamonJapan').checked = !!tx.isKumamonJapan;
        if(document.getElementById('checkKumamonDesignated')) document.getElementById('checkKumamonDesignated').checked = !!tx.isKumamonDesignated;
        if(document.getElementById('checkKumamonPayPay')) document.getElementById('checkKumamonPayPay').checked = !!tx.isKumamonPayPay;
        
        // å¹£å€
        if(tx.isSinopacCurrencySelected) document.getElementById('rbCurrencySelected').checked = true;
        // ä¸‰äº•
        if(document.getElementById('checkSinopacMitsuiSelected')) document.getElementById('checkSinopacMitsuiSelected').checked = !!tx.isSinopacMitsuiSelected;
        if(document.getElementById('checkSinopacMitsuiTarget')) document.getElementById('checkSinopacMitsuiTarget').checked = !!tx.isSinopacMitsuiTarget;
        // å°‡å°‡
        if(tx.isJiangSelected) document.getElementById('rbJiangSelected').checked = true;
        else if(tx.isJiangTravel) document.getElementById('rbJiangTravel').checked = true;
        // è§¸ç™¼ UI æ›´æ–°
        if (tx.cardId === 'j3') toggleKumamonSub('none');
        if (tx.cardId === 'j2') toggleJiheLogic();
        if (tx.cardId === 'c6') toggleBillLogic();
        if (tx.cardId === 'c7') toggleUniUpLogic();
        
        updateRewardPreview();
    }

    function deleteTransaction(id, event) {
        event.stopPropagation();
        if(!confirm('ç¢ºå®šè¦åˆªé™¤é€™ç­†ç´€éŒ„å—ï¼Ÿ')) return;
        transactions = transactions.filter(t => t.id !== id);
        localStorage.setItem('transactions', JSON.stringify(transactions));
        
        const cardId = document.getElementById('cardIdInput').value;
        renderGrid();
        renderModalHistory(cardId);
        updateRewardPreview();
    }

    function resetAllData() {
        if(!confirm("âš ï¸ è­¦å‘Šï¼šé€™å°‡åˆªé™¤æ‰€æœ‰è¨˜å¸³è³‡æ–™ä¸”ç„¡æ³•å¾©åŸï¼\nç¢ºå®šè¦é‡ç½®å—ï¼Ÿ")) return;
        localStorage.clear();
        location.reload();
    }
    
    function exportData() {
        const data = {
            transactions: transactions,
            cardSettings: cardSettings,
            visibleCards: visibleCards,
            cardOrder: savedOrder,
            uniOpenState: JSON.parse(localStorage.getItem('uniOpenState') || '{}'),
            currencyLevel: localStorage.getItem('currency_level'),
            hsbcTier: localStorage.getItem('hsbc_tier'),
            hsbcInitial: localStorage.getItem('hsbc_initial_miles'),
            hsbcRedeemed: localStorage.getItem('hsbc_redeemed_miles'),
            sceneSnapshots: getScenes() // å‚™ä»½æƒ…å¢ƒå¿«ç…§
        };
        const blob = new Blob([JSON.stringify(data)], {type: "application/json"});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `backup_${new Date().toISOString().slice(0,10)}.json`;
        a.click();
    }

    function triggerImport() { document.getElementById('fileInput').click(); }
    function importFile(input) {
        const file = input.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const data = JSON.parse(e.target.result);
                if(data.transactions) localStorage.setItem('transactions', JSON.stringify(data.transactions));
                if(data.cardSettings) localStorage.setItem('cardSettings', JSON.stringify(data.cardSettings));
                if(data.visibleCards) localStorage.setItem('visibleCards', JSON.stringify(data.visibleCards));
                if(data.cardOrder) localStorage.setItem('cardOrder', JSON.stringify(data.cardOrder));
                if(data.uniOpenState) localStorage.setItem('uniOpenState', JSON.stringify(data.uniOpenState));
                if(data.currencyLevel) localStorage.setItem('currency_level', data.currencyLevel);
                if(data.hsbcTier) localStorage.setItem('hsbc_tier', data.hsbcTier);
                if(data.hsbcInitial) localStorage.setItem('hsbc_initial_miles', data.hsbcInitial);
                if(data.hsbcRedeemed) localStorage.setItem('hsbc_redeemed_miles', data.hsbcRedeemed);
                if(data.sceneSnapshots) localStorage.setItem('scene_snapshots', JSON.stringify(data.sceneSnapshots));
                
                alert("åŒ¯å…¥æˆåŠŸï¼å³å°‡é‡æ–°æ•´ç†...");
                location.reload();
            } catch(err) {
                alert("æª”æ¡ˆæ ¼å¼éŒ¯èª¤æˆ–ææ¯€");
            }
        };
        reader.readAsText(file);
    }

    function checkUrgentTasks() {
        const alertArea = document.getElementById('urgent-alert-area'), alertList = document.getElementById('urgent-list');
        alertList.innerHTML = ''; let hasUrgent = false;
        cards.forEach(card => {
            if (card.type === 'placeholder') return;
            const stats = calculateStats(card.id); let target = card.type === 'floor' ? card.target : (card.type === 'mixed' ? card.minSpend : 0);
            if (target > 0 && stats.spend < target) {
                const end = new Date(new Date().getFullYear(), new Date().getMonth() + 1, 0), diff = Math.ceil((end - new Date()) / 86400000);
                if (diff <= 3 && diff >= 0) { hasUrgent = true; alertList.innerHTML += `<div class="urgent-item">${card.name} ç¼º $${(target - stats.spend).toLocaleString()} (å‰© ${diff} å¤©)</div>`; }
            }
        });
        alertArea.style.display = hasUrgent ? 'block' : 'none';
    }
    updateDate(); 
</script>
</body>
</html>
