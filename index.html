<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-FMD1PV6QZV"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-FMD1PV6QZV');
    </script>

    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="åˆ·å¡å›é¥‹ç®¡å®¶">
    <meta name="theme-color" content="#F0F2F5">
        
    <meta property="og:title" content="åˆ·å¡å›é¥‹ç®¡å®¶ - æ‚¨çš„ä¿¡ç”¨å¡æœ€ä½³å¹«æ‰‹">
    <meta property="og:description" content="è‡ªå‹•è¨ˆç®—å›é¥‹ã€å³æ™‚é¡¯ç¤ºä¸Šé™ã€æ”¯æ´æˆ°ç¸¾åœ–åˆ†äº«ã€‚å¿«ä¾†çœ‹çœ‹ä½ æœ¬æœˆè³ºäº†å¤šå°‘å›é¥‹ï¼">
    <meta property="og:image" content="https://shawn2026-oss.github.io/shawn-2026-creditcard/icon-192.png">
    <meta property="og:url" content="https://shawn2026-oss.github.io/shawn-2026-creditcard/">
    <meta property="og:type" content="website">

    <title>åˆ·å¡å›é¥‹ç®¡å®¶ (V126.1 )</title>
        
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" sizes="192x192" href="icon-192.png">
    <link rel="icon" type="image/png" sizes="48x48" href="icon-48.png">
    <link rel="shortcut icon" href="icon-48.png">

    <style>
        :root { --bg-color: #F0F2F5; --text-primary: #1C1C1E; --text-secondary: #8E8E93; }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif; 
            background-color: #E0E5EC; 
            color: var(--text-primary); 
            margin: 0; 
            display: flex; 
            justify-content: center; 
            min-height: 100vh; 
            -webkit-font-smoothing: antialiased; 
            position: relative; 
        }

        .app-container { 
            width: 100%; 
            max-width: 480px; 
            background-color: var(--bg-color); 
            min-height: 100vh; 
            padding: 16px 12px; 
            padding-top: env(safe-area-inset-top, 20px); 
            padding-bottom: env(safe-area-inset-bottom, 20px); 
            box-shadow: 0 0 40px rgba(0,0,0,0.05); 
            display: flex; 
            flex-direction: column; 
            box-sizing: border-box; 
            z-index: 1; 
        }

        @media (max-width: 480px) { 
            body { background-color: var(--bg-color); } 
            .app-container { box-shadow: none; width: 100%; max-width: 100%; } 
        }

        .detail-progress-area {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 12px;
            padding: 10px;
            margin-bottom: 12px;
            display: none; 
        }
        .dp-row { margin-bottom: 8px; }
        .dp-row:last-child { margin-bottom: 0; }
        .dp-header {
            display: flex;
            justify-content: space-between;
            font-size: 11px;
            font-weight: 700;
            color: #555;
            margin-bottom: 3px;
        }
        .dp-track {
            height: 6px;
            background: #e0e0e0;
            border-radius: 3px;
            overflow: hidden;
        }
        .dp-fill {
            height: 100%;
            background: #007AFF; 
            width: 0%;
            transition: width 0.3s;
        }
        .dp-fill.green { background: #34C759; }
        .dp-fill.orange { background: #FF9500; }
        .dp-fill.red { background: #FF3B30; }
        .dp-fill.purple { background: #AF52DE; }
        
        .threshold-warning {
            color: #FF3B30;
            font-size: 11px;
            font-weight: 700;
            margin-top: 4px;
            display: none; 
        }

        .header-top-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2px; width: 100%; }
        .author-top { font-size: 12px; font-weight: 800; color: #007AFF; letter-spacing: 0.5px; }
        .version-tag { font-size: 10px; color: #888; font-weight: 600; background: rgba(0,0,0,0.05); padding: 2px 8px; border-radius: 4px; white-space: nowrap; flex-shrink: 0; display: inline-block; min-width: 36px; text-align: center; }
        
        .location-selector {
            display: flex;
            align-items: center;
            gap: 6px;
            background: rgba(0,122,255,0.1);
            padding: 6px 12px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid rgba(0,122,255,0.2);
        }
        .location-selector:active {
            transform: scale(0.95);
            background: rgba(0,122,255,0.15);
        }
        .location-icon { font-size: 16px; }
        .location-text { font-size: 12px; font-weight: 700; color: #007AFF; }
        .location-arrow { font-size: 10px; color: #007AFF; }
        
        .exchange-rate-row {
            display: none;
            align-items: center;
            justify-content: space-between;
            margin-top: 8px;
            padding: 6px 10px;
            background: rgba(255,255,255,0.6);
            border: 1px solid rgba(0,0,0,0.05);
            border-radius: 12px;
            backdrop-filter: blur(5px);
        }
        .exchange-rate-label { font-size: 11px; font-weight: 600; color: #666; display: flex; align-items: center; gap:4px; }
        .rate-input-group { display: flex; align-items: center; gap: 6px; }
        
        .exchange-rate-input {
            width: 58px;
            padding: 2px 4px;
            border: none;
            background: transparent;
            border-bottom: 1px dashed #ccc;
            border-radius: 0;
            font-size: 12px;
            font-weight: 700;
            text-align: right;
            color: #333;
            outline: none;
        }
        .exchange-rate-input:focus { border-bottom-color: #007AFF; color: #007AFF; }
        .exchange-rate-edit-btn { background: none; border: none; color: #007AFF; font-size: 11px; cursor: pointer; padding: 0 2px; opacity: 0.7; }
        .exchange-rate-edit-btn:active { opacity: 1; transform: scale(0.95); }
        
        .header-section { margin-bottom: 12px; display: flex; justify-content: space-between; align-items: flex-end; }
        h1 { font-size: 22px; font-weight: 800; margin: 0; color: #333; letter-spacing: -0.5px; line-height: 1.2;}
        .subtitle { font-size: 11px; color: var(--text-secondary); font-weight: 500; }
        .today-date { background: rgba(0,0,0,0.05); padding: 2px 6px; border-radius: 4px; font-size: 11px; font-weight: 600; color: #555; margin-left: 5px;}
        .news-ticker { background: #FFF9C4; color: #856404; border-radius: 8px; margin-bottom: 12px; height: 36px; display: block; overflow: hidden; white-space: nowrap; position: relative; box-shadow: 0 2px 5px rgba(0,0,0,0.05); width: 100%; transform: translate3d(0,0,0); }
        .ticker-content { display: inline-block; height: 36px; line-height: 36px; padding-left: 100%; min-width: 100%; box-sizing: content-box; animation: scroll-left 15s linear infinite; will-change: transform; transform: translate3d(0, 0, 0); }
        @keyframes scroll-left { 0% { transform: translate3d(0, 0, 0); } 100% { transform: translate3d(-100%, 0, 0); } }
        
        .total-reward-card { background: #2c3e50; color: white; border-radius: 16px; padding: 16px 20px; margin-bottom: 16px; display: flex; justify-content: space-between; align-items: center; position: relative; overflow: hidden; box-shadow: 0 4px 10px rgba(44, 62, 80, 0.2); }
        .total-reward-card::after { content: ''; position: absolute; top: -50%; right: -50%; width: 150px; height: 150px; background: rgba(255,255,255,0.1); border-radius: 50%; pointer-events: none; }
        .total-info { display: flex; flex-direction: column; gap: 2px; }
        .total-reward-label { font-size: 13px; font-weight: 600; opacity: 0.9; }
        .total-reward-amount { font-size: 32px; font-weight: 800; letter-spacing: -0.5px; }
        .total-reward-breakdown { font-size: 11px; opacity: 0.8; margin-top: 4px; }
        .btn-share-result { background: rgba(255,255,255,0.2); backdrop-filter: blur(5px); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 8px 16px; border-radius: 20px; font-size: 13px; font-weight: 700; cursor: pointer; display: flex; align-items: center; gap: 6px; transition: all 0.2s; z-index: 2; }
        .btn-share-result:active { transform: scale(0.95); background: rgba(255,255,255,0.3); }
        
        #urgent-alert-area { display: none; margin-bottom: 12px; }
        .urgent-card { background: linear-gradient(135deg, #FF3B30, #FF2D55); color: white; border-radius: 12px; padding: 10px 14px; box-shadow: 0 4px 10px rgba(255, 59, 48, 0.25); animation: pulse 2s infinite; }
        .urgent-title { font-size: 13px; font-weight: 800; display: flex; align-items: center; gap: 6px; }
        .urgent-item { background: rgba(255,255,255,0.25); border-radius: 8px; padding: 6px 10px; margin-top: 6px; font-size: 12px; font-weight: 600; line-height: 1.3; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.01); } 100% { transform: scale(1); } }
        
        #card-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 20px; flex: 1; align-content: start;}
        .card-tile { border-radius: 16px; padding: 12px; min-height: 135px; display: flex; flex-direction: column; justify-content: space-between; box-shadow: 0 4px 12px rgba(0,0,0,0.1); position: relative; transition: transform 0.1s; cursor: pointer; color: white; overflow: hidden; user-select: none; -webkit-user-select: none; touch-action: pan-y; }
        .card-tile:active { transform: scale(0.97); }
        .sortable-ghost { opacity: 0.4; transform: scale(0.95); }
        .sortable-drag { cursor: grabbing; }
        
        .tile-header { display: flex; justify-content: space-between; align-items: flex-start; z-index: 2; margin-bottom: 2px;}
        .tile-name { font-size: 15px; font-weight: 800; line-height: 1.2; text-shadow: 0 1px 2px rgba(0,0,0,0.15); }
        .tile-nickname-badge { display: inline-block; font-size: 10px; font-weight: 800; background: rgba(0,0,0,0.2); color: #FFD700; padding: 2px 6px; border-radius: 4px; margin-bottom: 4px; z-index: 2; width: fit-content; }
        .tile-nickname-badge.placeholder { background: rgba(0,0,0,0.1); color: #aaa; }
        .tile-note { font-size: 10px; font-weight: 500; opacity: 0.9; margin-bottom: 4px; display: block; line-height: 1.2; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; z-index: 2; letter-spacing: -0.2px; }
        .tile-rule { font-size: 10px; font-weight: 700; background: rgba(0,0,0,0.25); padding: 2px 6px; border-radius: 4px; display: inline-block; margin-bottom: 6px; color: #FFD700; z-index: 2; }
        .rate-badge { background: rgba(255,255,255,0.3); font-size: 10px; font-weight: 800; padding: 2px 5px; border-radius: 5px; white-space: nowrap; backdrop-filter: blur(4px); margin-left: 2px; flex-shrink: 0; }
        
        .tile-body { z-index: 2; flex:1; display:flex; flex-direction:column; justify-content:center; }
        .tile-stat-group { display: flex; flex-direction: column; align-items: flex-start; justify-content: center; margin-bottom: 2px; }
        .tile-stat-main { font-size: 20px; font-weight: 800; letter-spacing: -0.5px; line-height: 1.1; }
        .tile-stat-sub { font-size: 11px; color: rgba(255,255,255,0.8); font-weight: 600; margin-top: 1px; letter-spacing: 0.2px; }
        
        .tile-stat { font-size: 20px; font-weight: 700; letter-spacing: -0.5px; margin-bottom: 2px;}
        
        .tile-earned { font-size: 11px; font-weight: 600; color: rgba(255,255,255,0.95); display: flex; align-items: center; gap: 3px;}
        .tile-earned::before { content: 'è³º'; font-size: 9px; opacity: 0.8; border: 1px solid rgba(255,255,255,0.7); padding: 0 2px; border-radius: 3px;}
        
        .tile-footer { z-index: 2; margin-top: 6px; position: relative; }
        .progress-track { background: rgba(0,0,0,0.2); height: 4px; border-radius: 2px; overflow: hidden; margin-bottom: 4px; }
        .progress-fill { height: 100%; background: rgba(255,255,255,0.95); transition: width 0.5s ease; }
        .tile-msg { font-size: 11px; font-weight: 700; opacity: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; line-height: 1.2; }
        .tile-cycle-hint { font-size: 9px; color: #fff; opacity: 0.95; margin-top: 3px; text-align: right; text-shadow: 0 1px 2px rgba(0,0,0,0.5); font-weight: 700; letter-spacing: 0.3px; }
        .tile-cycle-hint.dark-text { color: rgba(0,0,0,0.6); text-shadow: none; }
        .tile-overseas-warning { font-size: 10px; color: #FFD700; background: rgba(0,0,0,0.3); padding: 2px 6px; border-radius: 4px; margin-top: 4px; display: none; }
        
        .history-section { flex: 1; display: flex; flex-direction: column; }
        .history-title { font-size: 14px; font-weight: 700; margin-bottom: 8px; color: #555; }
        
        .settings-area { margin-top: auto; display: flex; gap: 8px; flex-direction: column; padding-top: 20px;}
        .settings-row { display: flex; gap: 8px; }
        .btn-tool { flex: 1; padding: 10px; border-radius: 10px; font-size: 12px; font-weight: 600; border: 1px solid #eee; background: white; color: #555; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 4px; box-shadow: 0 1px 3px rgba(0,0,0,0.05);}
        .btn-manage { background: #333; color: white; border: none; box-shadow: 0 2px 8px rgba(0,0,0,0.2); }
        .btn-reset-visible { width: 100%; padding: 12px; background-color: #fff5f5; border: 1px solid #ffdede; color: #FF3B30; border-radius: 12px; font-weight: 600; font-size: 12px; cursor: pointer; margin-top: 10px;}
        .btn-ig { width: 100%; padding: 12px; background: linear-gradient(45deg, #f09433 0%, #e6683c 25%, #dc2743 50%, #cc2366 75%, #bc1888 100%); color: white; border: none; border-radius: 12px; font-weight: 600; font-size: 14px; cursor: pointer; margin-top: 10px; box-shadow: 0 4px 12px rgba(220, 39, 67, 0.3); display: flex; align-items: center; justify-content: center; gap: 6px; }
        .btn-ig:active { transform: scale(0.98); }
        .details-content { display: none; background: #fff; border: 1px solid #eee; border-radius: 8px; padding: 10px; margin-top: 6px; font-size: 11px; color: #666; line-height: 1.6; }
        
        .modal { display: none; position: fixed !important; top: 0 !important; left: 0 !important; width: 100%; height: 100%; background: rgba(0,0,0,0.5); backdrop-filter: blur(3px); z-index: 10000; align-items: center; justify-content: center; }
        .modal-content { background: white; width: 85%; max-width: 320px; border-radius: 20px; padding: 20px; box-shadow: 0 25px 50px rgba(0,0,0,0.25); animation: modalPop 0.2s; display: flex; flex-direction: column; max-height: 85vh; overflow-y: auto; overflow-x: hidden; position: relative; z-index: 10001; box-sizing: border-box; }
        .modal-body-input { flex-shrink: 0; }
        
        .location-modal-content { background: white; width: 85%; max-width: 300px; border-radius: 20px; padding: 20px; box-shadow: 0 25px 50px rgba(0,0,0,0.25); animation: modalPop 0.2s; }
        .location-modal-title { font-size: 18px; font-weight: 800; color: #333; margin-bottom: 16px; text-align: center; }
        .location-option { display: flex; align-items: center; gap: 12px; padding: 14px; background: #f9f9f9; border-radius: 12px; margin-bottom: 8px; cursor: pointer; transition: all 0.2s; border: 2px solid transparent; }
        .location-option:active { transform: scale(0.98); }
        .location-option.active { background: #E3F2FD; border-color: #007AFF; }
        .location-flag { font-size: 24px; }
        .location-info { flex: 1; }
        .location-name { font-size: 15px; font-weight: 700; color: #333; }
        .location-currency { font-size: 11px; color: #888; margin-top: 2px; }
        .location-check { font-size: 18px; color: #007AFF; display: none; }
        .location-option.active .location-check { display: block; }
        
        .welcome-overlay { position: fixed !important; top: 0 !important; left: 0 !important; width: 100vw; height: 100vh; background: rgba(0,0,0,0.85); z-index: 20000; display: none; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        .welcome-content { background: white; width: 85%; max-width: 340px; border-radius: 24px; padding: 24px; text-align: center; box-shadow: 0 10px 40px rgba(0,0,0,0.5); animation: modalPop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .welcome-title { font-size: 22px; font-weight: 800; color: #333; margin-bottom: 10px; }
        .welcome-desc { font-size: 14px; color: #666; margin-bottom: 20px; line-height: 1.5; }
        .welcome-list { text-align: left; max-height: 300px; overflow-y: auto; margin-bottom: 20px; border: 1px solid #eee; border-radius: 12px; padding: 10px; }
        .welcome-item { display: flex; align-items: center; padding: 10px; border-bottom: 1px solid #f9f9f9; }
        .welcome-item:last-child { border-bottom: none; }
        .welcome-item input { width: 20px; height: 20px; margin-right: 12px; margin-bottom: 0; padding: 0;}
        .welcome-item label { margin: 0; font-size: 15px; font-weight: 600; color: #333; flex: 1; }
        .welcome-btn { background: #007AFF; color: white; border: none; padding: 14px; width: 100%; border-radius: 12px; font-size: 16px; font-weight: 700; cursor: pointer; box-shadow: 0 4px 12px rgba(0,122,255,0.3); }
        .welcome-btn:active { transform: scale(0.98); }
        
        #captureArea { position: fixed; top: -9999px; left: -9999px; z-index: -1; }
        .share-card-node { width: 320px; height: auto; background: linear-gradient(135deg, #1C1C1E, #2c3e50); color: white; border-radius: 20px; padding: 24px; box-sizing: border-box; font-family: -apple-system, sans-serif; text-align: center; box-shadow: 0 20px 40px rgba(0,0,0,0.3); margin-bottom: 20px; }
        .share-header { font-size: 14px; opacity: 0.8; letter-spacing: 1px; margin-bottom: 4px; text-transform: uppercase; }
        .share-month { font-size: 18px; font-weight: 700; margin-bottom: 20px; }
        .share-amount { font-size: 48px; font-weight: 800; margin-bottom: 20px; text-shadow: 0 2px 10px rgba(0,0,0,0.2); }
        .share-divider { height: 1px; background: rgba(255,255,255,0.1); margin: 15px 0; }
        .share-footer { font-size: 11px; opacity: 0.8; margin-top: 15px; background: rgba(255,255,255,0.1); padding: 8px; border-radius: 8px; font-weight: 600; }
        .share-list { text-align: left; margin-top: 10px; }
        .share-item { display: flex; justify-content: space-between; font-size: 13px; margin-bottom: 8px; font-weight: 500; }
        .share-item span:last-child { font-weight: 700; color: #FFD700; }
        .social-btn-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; width: 100%; margin-top: 10px; }
        .social-btn { display: flex; align-items: center; justify-content: center; gap: 6px; padding: 12px; border-radius: 12px; border: none; font-size: 13px; font-weight: 700; color: white; cursor: pointer; transition: transform 0.1s; }
        .social-btn:active { transform: scale(0.97); }
        .social-btn.instagram { background: linear-gradient(45deg, #f09433 0%, #e6683c 25%, #dc2743 50%, #cc2366 75%, #bc1888 100%); }
        .social-btn.threads { background: #000000; border: 1px solid #333; }
        .social-btn.facebook { background: #1877F2; }
        .social-btn.line { background: #06C755; }
        .social-btn.download { background: #555; grid-column: span 2; }
        
        .input-group label { display: block; font-size: 12px; font-weight: 600; color: #888; margin-bottom: 6px; margin-top: 10px; }
        input { width: 100%; padding: 10px; border: 2px solid #f0f0f0; background: #fff; border-radius: 12px; font-size: 18px; box-sizing: border-box; outline: none; font-weight: 600; color: #333; }
        .btn-group { display: flex; gap: 8px; margin-top: 20px; flex-shrink: 0; }
        .btn { flex: 1; padding: 10px; border: none; border-radius: 12px; font-size: 15px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center;}
        .btn-cancel { background: #f5f5f5; color: #333; }
        .btn-confirm { background: #007AFF; color: white; flex: 2; }
        .btn-again { background: #E3F2FD; color: #007AFF; border: 1px solid #b3e5fc; }
        #liveRewardCalc { text-align: center; font-size: 16px; color: #0056b3; font-weight: 700; margin-top: 12px; min-height: 20px; background: #E3F2FD; padding: 8px; border-radius: 8px; display: none; }
        .modal-history-section { margin-top: 15px; border-top: 2px solid #f0f0f0; padding-top: 10px; height: auto; overflow: visible; }
        .modal-history-title { font-size: 12px; font-weight: 700; color: #555; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; }
        .history-item { padding: 10px 0; border-bottom: 1px solid #f9f9f9; display: flex; justify-content: space-between; align-items: center; font-size: 12px; cursor: pointer; }
        .history-item:active { background: #f5f5f5; }
        .history-item:last-child { border-bottom: none; }
        .h-name { font-weight: 600; color: #555; min-height: 15px; }
        .h-date { font-size: 10px; color: #aaa; margin-top: 2px;}
        .h-amount { font-weight: 700; color: #333; font-size: 13px; }
        .btn-delete-single { background: none; border: none; color: #ccc; font-size: 14px; padding: 0 5px; cursor: pointer; margin-left: 8px;}
        .btn-delete-single:hover { color: #FF3B30; }
        
        #pigRichOptions, #greenCardOptions, #uniOptions, #happyOptions, #hsbcOptions, #uniOpenOptions, #richartOptions, #fubonJOptions, #jiheOptions, #kumamonOptions, #sinopacCurrencyOptions, #sinopacMitsuiOptions, #jiangOptions, #dbsEcoOptions, #sinopacJcbOptions, #laiDianOptions, #legendOptions { display: none; background: #f9f9f9; padding: 10px; border-radius: 10px; margin-top: 10px; border: 1px dashed #ddd; }
        .option-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 6px; font-size: 13px; font-weight: 600; color: #555; }
        .option-row input[type="checkbox"], .option-row input[type="radio"], .option-row input[type="number"] { margin: 0; }
        .option-row input[type="checkbox"], .option-row input[type="radio"] { width: 20px; height: 20px; }
        .option-row.read-only { opacity: 0.8; pointer-events: none; }
        .option-row.read-only input { opacity: 0.6; }
        .option-row.expired { opacity: 0.5; pointer-events: none; background: #eee; padding: 4px; border-radius: 4px; }
        .option-row.overseas-disabled { opacity: 0.4; pointer-events: none; }
        .option-row.overseas-disabled::after { content: ' (åœ‹å¤–ç„¡åŠ ç¢¼)'; color: #FF3B30; font-size: 10px; }
        
        /* UniOpen å“ç‰Œåˆ†é¡æŠ˜ç–Šæ¨£å¼ */
        .brand-category { margin-bottom: 10px; }
        .brand-category-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 8px 10px; 
            background: #e8f4fc; 
            border-radius: 8px; 
            cursor: pointer; 
            font-size: 12px; 
            font-weight: 700; 
            color: #007AFF;
            transition: background 0.2s;
        }
        .brand-category-header:active { background: #d0e8f8; }
        .brand-category-header .arrow { transition: transform 0.2s; }
        .brand-category-header.collapsed .arrow { transform: rotate(-90deg); }
        .brand-category-content { display: block; margin-top: 6px; }
        .brand-category-content.collapsed { display: none; }
        
        .brand-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px; margin-top: 6px; }
        .brand-btn { border: 1px solid #ddd; background: white; border-radius: 6px; padding: 6px 2px; font-size: 11px; color: #666; text-align: center; cursor: pointer; transition: 0.2s; font-weight: 600; display: flex; align-items: center; justify-content: center; }
        .brand-btn.active { background: #FF9800; color: white; border-color: #F57C00; box-shadow: 0 2px 4px rgba(255, 152, 0, 0.3); }
        .manage-item { display: flex; align-items: center; justify-content: space-between; padding: 16px 12px; border-bottom: 1px solid #f0f0f0; background: #fff; cursor: pointer; transition: background 0.2s; }
        .manage-item:active { background: #f9f9f9; }
        .manage-info { display: flex; flex-direction: column; gap: 4px; }
        .manage-name { font-size: 15px; font-weight: 700; color: #333; }
        .manage-desc { font-size: 12px; color: #999; }
        .switch { position: relative; display: inline-block; width: 44px; height: 24px; flex-shrink: 0; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 2px; bottom: 2px; background-color: white; transition: .4s; border-radius: 50%; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        input:checked + .slider { background-color: #34C759; }
        input:checked + .slider:before { transform: translateX(20px); }
        .btn-card-setting { background: #f0f0f0; border: none; border-radius: 50%; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; font-size: 16px; cursor: pointer; margin-right: 12px; color: #555; }
        .btn-card-setting:hover { background: #e0e0e0; }
        .happy-dashboard { background: transparent; border: none; padding: 0; margin-top: 10px; display: none; }
        .dash-row { margin-bottom: 8px; }
        .dash-label { font-size: 12px; font-weight: 700; color: #555; display: flex; justify-content: space-between; margin-bottom: 2px;}
        .dash-bar-bg { background: #eee; height: 6px; border-radius: 3px; overflow: hidden; }
        .dash-bar-fill { height: 100%; background: #4cd964; transition: width 0.3s; }
        .dash-bar-fill.danger { background: #ff3b30; }
        .manage-tools { margin-bottom: 12px; padding-bottom: 12px; border-bottom: 1px solid #eee; }
        .tools-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .btn-tool-small { background: #f0f0f0; border: 1px solid #e0e0e0; padding: 6px 12px; border-radius: 8px; font-size: 12px; font-weight: 600; color: #555; cursor: pointer; }
        .btn-tool-small:active { background: #ddd; }
        .scene-container { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 4px; white-space: nowrap; -webkit-overflow-scrolling: touch; }
        .btn-scene { padding: 6px 12px; background: #e8f5e9; color: #2e7d32; border: 1px solid #c8e6c9; border-radius: 20px; font-size: 12px; font-weight: 700; cursor: pointer; display: flex; align-items: center; gap: 4px; flex-shrink: 0;}
        .btn-scene:active { transform: scale(0.95); }
        .btn-scene-del { width: 16px; height: 16px; background: rgba(0,0,0,0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 10px; margin-left: 4px; color: #2e7d32; }
        
        .manage-search-container { position: sticky; top: 0; background: white; z-index: 10; padding-bottom: 12px; margin-bottom: 8px; border-bottom: 1px solid #f0f0f0; }
        .manage-search-wrapper { position: relative; width: 100%; }
        .manage-search-input { width: 100%; padding: 12px 40px 12px 12px; border-radius: 12px; border: 1px solid #e0e0e0; background: #f9f9f9; font-size: 15px; font-weight: 600; color: #333; transition: all 0.2s; box-sizing: border-box; outline: none; }
        .manage-search-input:focus { background: white; border-color: #007AFF; box-shadow: 0 0 0 3px rgba(0,122,255,0.1); }
        .btn-search-clear { position: absolute; right: 10px; top: 50%; transform: translateY(-50%); width: 24px; height: 24px; background: #ccc; color: white; border-radius: 50%; border: none; font-size: 14px; display: none; align-items: center; justify-content: center; cursor: pointer; }
        .manage-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; padding-bottom: 20px; }
        .manage-card-btn { position: relative; border-radius: 16px; padding: 12px; background: #f5f5f5; border: 2px solid transparent; text-align: left; transition: all 0.2s cubic-bezier(0.25, 0.8, 0.25, 1); cursor: pointer; display: flex; flex-direction: column; justify-content: space-between; min-height: 80px; user-select: none; -webkit-tap-highlight-color: transparent; opacity: 0.7; filter: grayscale(100%); }
        .manage-card-btn.active { opacity: 1; filter: grayscale(0%); background: white; border-color: #007AFF; box-shadow: 0 4px 12px rgba(0,0,0,0.08); transform: translateY(-1px); }
        .manage-card-btn:active { transform: scale(0.96); }
        .m-card-name { font-size: 14px; font-weight: 800; color: #333; line-height: 1.3; margin-bottom: 4px; padding-right: 20px; }
        .m-card-nick { font-size: 11px; color: #888; font-weight: 500; }
        .m-check-mark { position: absolute; top: 10px; right: 10px; width: 18px; height: 18px; background: #007AFF; color: white; border-radius: 50%; font-size: 12px; display: none; align-items: center; justify-content: center; font-weight: bold; box-shadow: 0 2px 4px rgba(0,0,0,0.2); z-index: 2; }
        .manage-card-btn.active .m-check-mark { display: flex; }
        .m-setting-btn { position: absolute; bottom: 8px; right: 8px; width: 28px; height: 28px; border-radius: 50%; background: rgba(0,0,0,0.05); color: #666; border: 1px solid rgba(0,0,0,0.05); display: flex; align-items: center; justify-content: center; font-size: 14px; z-index: 3; transition: all 0.2s; }
        .manage-card-btn.active .m-setting-btn { background: rgba(0,0,0,0.03); color: #333; }
        .m-setting-btn:active { background: #e0e0e0; transform: scale(0.9); }
        @keyframes modalPop { 0% { transform: scale(0.9); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
    </style>
</head>
  <body>
    <div id="locationModal" class="modal" onclick="if(event.target===this) document.getElementById('locationModal').style.display='none'">
        <div class="location-modal-content">
            <div class="location-modal-title">é¸æ“‡æ‰€åœ¨åœ°</div>
            <div class="location-option active" onclick="selectLocation('TW', 'ğŸ‡¹ğŸ‡¼', 'æˆ‘åœ¨å°ç£', 'TWD', 1)">
                <span class="location-flag">ğŸ‡¹ğŸ‡¼</span>
                <div class="location-info">
                    <div class="location-name">æˆ‘åœ¨å°ç£</div>
                    <div class="location-currency">TWD (å°å¹£)</div>
                </div>
                <span class="location-check">âœ“</span>
            </div>
            <div class="location-option" onclick="selectLocation('JP', 'ğŸ‡¯ğŸ‡µ', 'æˆ‘åœ¨æ—¥æœ¬', 'JPY', null)">
                <span class="location-flag">ğŸ‡¯ğŸ‡µ</span>
                <div class="location-info">
                    <div class="location-name">æˆ‘åœ¨æ—¥æœ¬</div>
                    <div class="location-currency">JPY (æ—¥åœ“)</div>
                </div>
                <span class="location-check">âœ“</span>
            </div>
            <div class="location-option" onclick="selectLocation('KR', 'ğŸ‡°ğŸ‡·', 'æˆ‘åœ¨éŸ“åœ‹', 'KRW', null)">
                <span class="location-flag">ğŸ‡°ğŸ‡·</span>
                <div class="location-info">
                    <div class="location-name">æˆ‘åœ¨éŸ“åœ‹</div>
                    <div class="location-currency">KRW (éŸ“å…ƒ)</div>
                </div>
                <span class="location-check">âœ“</span>
            </div>
            <div class="location-option" onclick="selectLocation('US', 'ğŸ‡ºğŸ‡¸', 'æˆ‘åœ¨ç¾åœ‹', 'USD', null)">
                <span class="location-flag">ğŸ‡ºğŸ‡¸</span>
                <div class="location-info">
                    <div class="location-name">æˆ‘åœ¨ç¾åœ‹</div>
                    <div class="location-currency">USD (ç¾å…ƒ)</div>
                </div>
                <span class="location-check">âœ“</span>
            </div>
            <div class="location-option" onclick="selectLocation('TH', 'ğŸ‡¹ğŸ‡­', 'æˆ‘åœ¨æ³°åœ‹', 'THB', null)">
                <span class="location-flag">ğŸ‡¹ğŸ‡­</span>
                <div class="location-info">
                    <div class="location-name">æˆ‘åœ¨æ³°åœ‹</div>
                    <div class="location-currency">THB (æ³°éŠ–)</div>
                </div>
                <span class="location-check">âœ“</span>
            </div>
        </div>
    </div>
    
    <div id="line-tip-bar">
        <span id="line-tip-text">âš ï¸ åµæ¸¬ä¸­...</span>
        <button onclick="this.parentElement.style.display='none'">âœ•</button>
    </div>

    <div id="safari-install-bubble" onclick="closeBubble()">
        <div class="bubble-content">
            <span class="bubble-text">è«‹é»æ“Šä¸‹æ–¹ã€Œ...ã€å¾Œé»ã€Œåˆ†äº«ã€å†ä¸‹æ»‘åŠ å…¥ã€Œä¸»ç•«é¢ã€ğŸ‘‡</span>
            <div class="bubble-arrow"></div>
        </div>
        <button class="bubble-close">âœ•</button>
    </div>

    <div id="android-install-bar">
        <div class="install-info">
            <div class="install-icon">ğŸ’³</div>
            <div class="install-text">
                <div style="font-weight:800; font-size:14px;">å®‰è£ã€Œåˆ·å¡å›é¥‹ç®¡å®¶ã€</div>
                <div style="font-size:11px; opacity:0.8;">å…¨è¢å¹•åŸ·è¡Œï¼Œè³‡æ–™ä¸éºå¤±</div>
            </div>
        </div>
        <div style="display:flex; align-items:center; gap:10px;">
            <button class="btn-install-trigger" onclick="triggerAndroidInstall()">ğŸ“² å®‰è£</button>
            <button class="btn-close-install" onclick="closeAndroidBar()">âœ•</button>
        </div>
    </div>

    <style>
        #line-tip-bar, #safari-install-bubble, #android-install-bar { display: none; }
        #line-tip-bar {
            background: #FFF9C4; color: #856404;
            padding: 12px 15px; font-size: 13px; font-weight: 600;
            position: fixed; top: 0; left: 0; width: 100%;
            z-index: 99999; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            justify-content: space-between; align-items: center; box-sizing: border-box;
            line-height: 1.4;
        }
        #line-tip-bar strong { color: #d32f2f; text-decoration: underline; }
        #line-tip-bar button { background: none; border: none; font-size: 18px; color: #856404; cursor: pointer; padding: 0 0 0 10px; flex-shrink: 0; }
        #safari-install-bubble {
            position: fixed; 
            bottom: calc(20px + env(safe-area-inset-bottom)); 
            right: 4px;
            left: auto; 
            transform: none;
            max-width: 220px;
            z-index: 10000; animation: bounce 2s infinite;
            cursor: pointer;
            width: fit-content;
        }
        .bubble-content {
            background: #007AFF; color: white; padding: 10px 16px; border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,122,255,0.4); position: relative; text-align: center; 
            min-width: 240px; 
        }
        .bubble-text { font-size: 13px; line-height: 1.4; display: block; pointer-events: none; font-weight: 600; } 
        .bubble-arrow {
            position: absolute; bottom: -8px; 
          right: 24px; left: auto; transform: none;
            width: 0; height: 0; border-left: 8px solid transparent; border-right: 8px solid transparent; border-top: 8px solid #007AFF;
        }
        .bubble-close {
            position: absolute; top: -8px; right: -8px; background: #ccc; color: white; border: 2px solid white;
            border-radius: 50%; width: 20px; height: 20px; font-size: 12px; cursor: pointer; display: flex; align-items: center; justify-content: center;
            pointer-events: auto;
        }
        #android-install-bar {
            position: fixed; bottom: 20px; left: 5%; width: 90%;
            background: #222; color: white; border-radius: 16px;
            padding: 12px 16px; box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            z-index: 10000; display: none; justify-content: space-between; align-items: center;
            box-sizing: border-box; animation: slideUp 0.5s ease-out;
        }
        .install-info { display: flex; align-items: center; gap: 12px; }
        .install-icon { width: 40px; height: 40px; background: linear-gradient(135deg, #00C9FF, #92FE9D); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 20px; }
        .btn-install-trigger {
            background: #007AFF; color: white; border: none; padding: 8px 16px; border-radius: 20px;
            font-weight: 700; font-size: 13px; cursor: pointer; white-space: nowrap;
        }
        .btn-close-install { background: rgba(255,255,255,0.2); border: none; width: 24px; height: 24px; border-radius: 50%; color: #aaa; font-size: 12px; cursor: pointer; display: flex; align-items: center; justify-content: center; }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% {transform: translateX(-50%) translateY(0);}
            40% {transform: translateX(-50%) translateY(-10px);}
            60% {transform: translateX(-50%) translateY(-5px);}
        }
        @keyframes slideUp { from { transform: translateY(100px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    </style>

    <script>
        let deferredPrompt;
        (function() {
            var ua = navigator.userAgent.toLowerCase();
            var isIOS = /iphone|ipad|ipod/.test(ua);
            var isChromeIOS = ua.indexOf('crios') > -1;
            var isFirefoxIOS = ua.indexOf('fxios') > -1;
            var isInAppKeywords = ua.indexOf('line') > -1 || ua.indexOf('fban') > -1 || ua.indexOf('fbav') > -1 || ua.indexOf('instagram') > -1 || ua.indexOf('threads') > -1;
            var isRealSafari = isIOS && ua.indexOf('safari') > -1 && !isChromeIOS && !isFirefoxIOS && !isInAppKeywords;
            var isStandalone = window.navigator.standalone === true || window.matchMedia('(display-mode: standalone)').matches;

            if (isIOS && !isStandalone) {
                if (!isRealSafari) {
                    // é Safari (Line ç­‰)
                    var tipBar = document.getElementById('line-tip-bar');
                    var tipText = document.getElementById('line-tip-text');
                    if(tipBar && tipText) {
                          tipText.innerHTML = isInAppKeywords ? 
                              'âš ï¸ å…§å»ºç€è¦½å™¨ç„¡æ³•å­˜æª”ï¼Œè«‹é»æ“Š<strong>è§’è½é¸å–®ã€Œ...ã€</strong>,é¸æ“‡<strong>ã€Œåœ¨ Chrome/Safari é–‹å•Ÿã€</strong>' : 
                              'âš ï¸ è«‹å‹™å¿…ä½¿ç”¨ <strong>Safari</strong> é–‹å•Ÿæ‰æœ‰å­˜æª”åŠŸèƒ½';
                          tipBar.style.display = 'flex';
                          var appContainer = document.querySelector('.app-container');
                          if(appContainer) appContainer.style.marginTop = '45px';
                    }
                } else {
                    // æ˜¯ Safari ä½†æœªå®‰è£
                    setTimeout(function() {
                        var bubble = document.getElementById('safari-install-bubble');
                        if(bubble) bubble.style.display = 'block';
                    }, 1500);
                }
            }
        })();

        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            document.getElementById('android-install-bar').style.display = 'flex';
        });

        async function triggerAndroidInstall() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                deferredPrompt = null;
                document.getElementById('android-install-bar').style.display = 'none';
            }
        }
        function closeBubble() { document.getElementById('safari-install-bubble').style.display = 'none'; }
        function closeAndroidBar() { document.getElementById('android-install-bar').style.display = 'none'; }
    </script>

    <div id="welcomeModal" class="welcome-overlay">
        <div class="welcome-content">
            <div class="welcome-title">ğŸ‘‹ æ­¡è¿ä½¿ç”¨å›é¥‹ç®¡å®¶</div>
            <div class="welcome-desc">ç‚ºäº†æä¾›æœ€ç²¾æº–çš„æœå‹™<br>è«‹å‹¾é¸æ‚¨<b>ç›®å‰æŒæœ‰</b>çš„å¡ç‰‡ï¼š</div>
            <div class="welcome-list" id="welcomeList"></div>
            <button class="welcome-btn" onclick="saveWelcomeSettings()">é–‹å§‹ä½¿ç”¨ ğŸš€</button>
        </div>
    </div>
    <div class="app-container">
        <div class="header-top-row">
            <div class="author-top">Designed by Pocket Lab</div>
            <div class="version-tag">V126.1 </div>
        </div>
        <div class="header-section">
            <h1>åˆ·å¡å›é¥‹ç®¡å®¶</h1>
            <div class="location-selector" onclick="openLocationModal()">
                <span class="location-icon" id="currentLocationFlag">ğŸ‡¹ğŸ‡¼</span>
                <span class="location-text" id="currentLocationName">æˆ‘åœ¨å°ç£</span>
                <span class="location-arrow">â–¼</span>
            </div>
        </div>
        
        <div class="exchange-rate-row" id="exchangeRateRow" style="width: fit-content; margin-left: auto;">
            <span class="exchange-rate-label">ğŸ“Š åŒ¯ç‡ <span id="currencySymbolInRate"></span> â†’ TWD</span>
            <div class="rate-input-group">
                <input type="number" id="exchangeRateInput" class="exchange-rate-input" step="0.01" oninput="updateTWDPreview()">
                <button class="exchange-rate-edit-btn" onclick="toggleExchangeRateEdit()">âœï¸</button>
                <button class="exchange-rate-edit-btn" id="refreshRateBtn" onclick="refreshExchangeRates()" title="é‡æ–°æŠ“å–åŒ¯ç‡" style="margin-left:-4px;">ğŸ”„</button>
            </div>
        </div>

        <div class="subtitle"><span class="today-date" id="dateDisplay"></span></div>
        
        <div class="news-ticker">
            <div class="ticker-content" id="news-text">ğŸ‰ V126.1ä¿®å¾©ï¼šå‚™ä»½é‚„åŸç´€éŒ„éºå¤±ã€UniOpen å®Œæ•´å“ç‰Œæ¸…å–®ã€JCB å°é ‚è¨ˆç®—ï¼</div>
        </div>
        
        <div id="urgent-alert-area"><div class="urgent-card"><div class="urgent-title">ğŸš¨ ä»»å‹™åˆ°æœŸè­¦å ±</div><div id="urgent-list"></div></div></div>
        
        <div class="total-reward-card">
            <div class="total-info">
                <span class="total-reward-label">ç•¶æœŸç´¯ç©å›é¥‹é ä¼°</span>
                <span class="total-reward-amount" id="totalRewardDisplay">$0</span>
                <span class="total-reward-breakdown" id="totalRewardBreakdown"></span>
            </div>
             <button class="btn-share-result" onclick="openShareModal()">ğŸ“© æ›¬æˆ°ç¸¾</button>
        </div>
        
        <div id="card-grid"></div>
        
        <div style="flex:1;"></div>
        
        <div class="settings-area">
            <div class="settings-row">
                <button class="btn-tool btn-manage" onclick="openManageModal()">ğŸ’³ ç®¡ç†æˆ‘çš„å¡ç‰‡</button>
            </div>
             <div class="settings-row">
                <button class="btn-tool" onclick="exportData()">ğŸ’¾ å‚™ä»½æª”æ¡ˆ</button>
                <button class="btn-tool" onclick="triggerImport()">ğŸ“¥ è®€æª”é‚„åŸ</button>
                <input type="file" id="fileInput" style="display:none" accept=".json, .txt" onchange="importFile(this)">
            </div>
            <button class="btn-ig" onclick="window.open('https://www.instagram.com/pocket_lab_tw', '_blank')">
              ğŸ“¸ æ­¡è¿è¿½è¹¤å£è¢‹å¯¦é©—å®¤
            </button>
            <button class="btn-reset-visible" onclick="resetAllData()">ğŸ—‘ï¸ é‡ç½®æ‰€æœ‰è³‡æ–™</button>
        </div>
    
        <div style="text-align:center; font-size:11px; color:#555; background:#ebebeb; padding:10px; border-radius:8px; margin-top:15px; margin-bottom:10px; line-height:1.4; font-weight:600;">
            âš ï¸ æœ¬å·¥å…·åƒ…å”åŠ©ç”¨æˆ¶ç›£æ§åˆ·å¡é€²åº¦<br>å¯¦éš›å…¥å¸³éœ€ä»¥å„å®¶éŠ€è¡Œåˆ¤å®šç‚ºä¸»
        </div>
        <div style="height:20px;"></div>
    </div>

    <div id="sharePreviewModal" class="modal" onclick="if(event.target===this) document.getElementById('sharePreviewModal').style.display='none'">
        <div class="modal-content" style="background:transparent; box-shadow:none; align-items:center; padding:0; width:100%; max-width:340px;">
            <div id="captureNode" class="share-card-node">
                <div class="share-header">Monthly Rewards</div>
                <div class="share-month" id="shareCardMonth">æˆ°ç¸¾å ±å‘Š</div>
                <div class="share-amount" id="shareCardAmount">$0</div>
                <div class="share-divider"></div>
                <div class="share-list" id="shareCardList"></div>
                <div class="share-footer">
                    <div>Generated by åˆ·å¡å›é¥‹ç®¡å®¶</div>
                </div>
            </div>

            <div style="background:white; border-radius:20px; padding:15px; width:100%; box-sizing:border-box; box-shadow: 0 10px 30px rgba(0,0,0,0.3); margin-top:10px;">
                <div style="text-align:center; font-size:12px; color:#333; margin-bottom:12px; font-weight:700;">âœ¨ è«‹é¸æ“‡åˆ†äº«æ–¹å¼</div>
                <div class="social-btn-grid">
                    <button class="social-btn instagram" onclick="shareToIG()">ğŸ“¸ Instagram</button>
                    <button class="social-btn facebook" onclick="shareToFB()">ğŸ“˜ Facebook</button>
                    <button class="social-btn threads" onclick="shareToThreads()">ğŸ§µ Threads</button>
                    <button class="social-btn line" onclick="shareToLine()">ğŸŸ¢ LINE</button>
                    <button class="social-btn download" onclick="downloadShareImage()">ğŸ“¥ åƒ…ä¿å­˜åœ–ç‰‡</button>
                </div>
                <div style="text-align:center; font-size:10px; color:#999; margin-top:10px; line-height:1.4;">
                    (FB/IG ç‚ºå‚³åœ–æ¨¡å¼ï¼›LINE/Threads ç‚ºé€£çµæ¨¡å¼)
                </div>
            </div>
            <button style="margin-top:15px; background:none; border:none; color:white; font-size:14px; text-decoration:underline; cursor:pointer;" onclick="document.getElementById('sharePreviewModal').style.display='none'">é—œé–‰è¦–çª—</button>
        </div>
    </div>

    <div id="transactionModal" class="modal" onclick="if(event.target===this) closeModal()">
        <div class="modal-content">
            <div class="modal-body-input">
                <h2 id="modalTitle" style="margin: 0 0 4px 0; font-size: 18px; font-weight: 800; color:#333;"></h2>
                <div style="font-size:12px; color:#888; margin-bottom:10px; font-weight: 500;" id="modalSubtitle"></div>
                
                <div id="modalParkingInfo" style="background:#FFF9C4; color:#856404; padding:10px; border-radius:10px; font-size:12px; margin-bottom:12px; border-left:4px solid #FFC107; display:none; line-height:1.5;"></div>
                
                <div id="detailProgressArea" class="detail-progress-area"></div>
                
                <div id="uniUpSuggestion" style="background:#E3F2FD; color:#0D47A1; padding:10px; border-radius:10px; font-size:12px; margin-bottom:12px; border-left:4px solid #2196F3; display:none; line-height:1.5;"></div>
                
                <input type="hidden" id="cardIdInput"> 
                
                <div id="legendOptions">
                    <div class="option-row read-only"><label>ğŸ”° ä¸€èˆ¬æ¶ˆè²» 1.2% (ç„¡ä¸Šé™)</label><input type="checkbox" checked disabled></div>
                    <div class="option-row" style="flex-direction:column; align-items:flex-start; gap:0;">
                        <div style="display:flex; justify-content:space-between; width:100%; align-items:center;">
                             <label for="checkLegendBonus">ğŸ”¥ ç²¾é¸é€šè·¯ +8.8% (åˆ·$11,363å°é ‚)</label>
                             <input type="checkbox" id="checkLegendBonus" onchange="updateRewardPreview()">
                        </div>
                        <button onclick="toggleLegendDetails()" style="border:none; background:none; color:#007AFF; font-size:11px; cursor:pointer; padding:2px 0 6px 0;">ğŸ”½ æŸ¥çœ‹æŒ‡å®šé€šè·¯ (å¨›æ¨‚/å½±éŸ³/ç”Ÿæ´»)</button>
                        <div id="legendDetails" class="details-content">
                            <b>(1) æŒ‡å®šå¨›æ¨‚å¹³å°ï¼š</b><br>
                            App Store, Google Play, Garena, GASH, MyCard, Nintendo, PlayStation, Steam, Acer, ASUS, Logitech, NOVA...<br>
                            <b>(2) å½±éŸ³ä¸²æµå¹³å°ï¼š</b><br>
                            YouTube Premium, Netflix, Disney+, Spotify, Twitch, æ„›å¥‡è—, Catchplay, KKBOX, KKTV, LiTV...<br>
                            <b>(3) ç”Ÿæ´»è£œçµ¦é€šè·¯ï¼š</b><br>
                            LINE Pay, UberEats, foodpanda, éº¥ç•¶å‹, è‚¯å¾·åŸº, æ‘©æ–¯æ¼¢å ¡, 21ä¸–ç´€, ç¾å¢¨ç‚¸é›, æ‹¿å¡é‡Œ, Pizzahut, è¦çš®...
                        </div>
                    </div>
                </div>
                
                <div id="pigRichOptions">
                    <div class="option-row read-only"><label id="labelBaseRate">ğŸ”° åŸºæœ¬å›é¥‹ 1% (ç„¡ä¸Šé™)</label><input type="checkbox" checked disabled></div>
                    <div class="option-row" style="flex-direction:column; align-items:flex-start; gap:0;">
                          <div style="display:flex; justify-content:space-between; width:100%; align-items:center;">
                             <label for="checkBonus10">âš¡ æ–°æˆ¶åŠ ç¢¼ +10% (åˆ·$8,000å°é ‚)</label>
                             <input type="checkbox" id="checkBonus10" checked onchange="updateRewardPreview()">
                        </div>
                        <button onclick="togglePigRichNewUser()" style="border:none; background:none; color:#007AFF; font-size:11px; cursor:pointer; padding:2px 0 6px 0;">ğŸ”½ é»æ“ŠæŸ¥çœ‹ 10% å®šç¾©</button>
                        <div id="pigRichNewUserDetails" class="details-content">
                            <b>â˜… è¡Œå‹•æ”¯ä»˜ï¼š</b><br>LINE Payã€è¡—å£æ”¯ä»˜ã€icash Pay (å«APPå…§ç¹³è²»)<br>
                            <b>â˜… æµ·å¤–æ¶ˆè²»ï¼š</b><br>å«å¯¦é«”åŠç·šä¸Šäº¤æ˜“ (éœ€éå°å¹£/éå°ç£)<br>
                            <b>â˜… æ©Ÿç¥¨ï¼š</b><br>åœ‹å…§å¤–èˆªç©ºå…¬å¸ (é™é€éèˆªç©ºå…¬å¸å®˜ç¶²è³¼è²·)<br>
                        </div>
                    </div>

                    <div class="option-row" style="flex-direction:column; align-items:flex-start; gap:0; border-top:1px dashed #ddd; padding-top:6px;">
                        <div style="display:flex; justify-content:space-between; width:100%; align-items:center;">
                            <label for="checkBonus25">ğŸŒŸ ç²¾é¸é€šè·¯ +2.5% (åˆ·$40è¬å°é ‚)</label>
                            <input type="checkbox" id="checkBonus25" checked onchange="toggleSelectedLogic()">
                        </div>
                        <button onclick="togglePigRichSelected()" style="border:none; background:none; color:#007AFF; font-size:11px; cursor:pointer; padding:2px 0 6px 0;">ğŸ”½ é»æ“ŠæŸ¥çœ‹ç²¾é¸é€šè·¯</button>
                        <div id="pigRichSelectedDetails" class="details-content">
                            <b>(1) æ—…éŠäº¤é€šï¼š</b><br>æ—¥æœ¬PayPay(é™è¡—å£)ã€éŸ“åœ‹ã€Klookã€KKdayã€æ˜“éŠç¶²ã€Agodaã€Airbnbã€DJBã€é…·éŠå¡ã€é«˜éµã€Uberã€å«è»Šå§ã€å°ç£å¿«ç¶«ã€è¯é€šã€USPACEã€ä¿¥äº­åœè»Š<br>
                            <b>(2) ç”Ÿæ´»è³¼ç‰©ï¼š</b><br>æ–°å…‰ä¸‰è¶Šã€é æ±ç™¾è²¨ã€é æ±å·¨åŸã€LaLaportã€ä¸‰äº•Outletã€åº·æ˜¯ç¾ã€ç¾å»‰ç¤¾ã€è–å¾·ç§‘æ–¯<br>
                            <b>(3) å¤–é€ç¾é£Ÿï¼š</b><br>Uber Eatsã€foodpandaã€Foodomoã€EZTABLEã€85åº¦Cã€æ¸…å¿ƒç¦å…¨ã€ä¸‰å•†é¤é£²<br>
                            <b>(4) å½±åŸKæ­Œï¼š</b><br>å¨ç§€ã€åœ‹è³“ã€æ–°å…‰ã€å–œæ¨‚æ™‚ä»£ã€ç§€æ³°ã€éŒ¢æ«ƒã€å¥½æ¨‚è¿ªã€äº«æº«é¦¨ã€å‡±æ‚…ã€æ˜Ÿèšé»ã€Sing Goã€ONCOR<br>
                        </div>
                    </div>

                    <div class="option-row" style="margin-bottom:0; border-top:1px dashed #ddd; padding-top:6px;"><label for="checkIsBill">ğŸ§¾ APPç¹³è²» (åº•1%â†’0.15%)</label><input type="checkbox" id="checkIsBill" onchange="toggleBillLogic()"></div>
                    
                    <div id="pigRichOverseasNote" style="display:none; margin-top:8px; padding:8px; background:#fff3e0; border-radius:6px; font-size:11px; color:#e65100;">
                        âš ï¸ æ—¥æœ¬ PayPay é€éè¡—å£ï¼šåƒ…äº« +1% ç²¾é¸åŠ ç¢¼ (é2.5%)
                    </div>
                </div>

                <div id="laiDianOptions" style="display:none; background:#f9f9f9; padding:10px; border-radius:10px; margin-top:10px; border:1px dashed #ddd;">
                    <div class="option-row" style="margin-bottom:8px;">
                        <label for="checkLaiDianNew" style="font-weight:700; color:#007AFF;">ğŸ‘¶ æˆ‘æ˜¯æ–°æˆ¶ (æ ¸å¡6å€‹æœˆå…§)</label>
                        <input type="checkbox" id="checkLaiDianNew" onchange="updateRewardPreview()">
                    </div>
                    
                    <div class="option-row" style="flex-direction:column; align-items:flex-start; gap:4px; border-top:1px dashed #ddd; padding-top:8px;">
                        <div style="font-size:12px; font-weight:700; color:#555; margin-bottom:4px;">è«‹é¸æ“‡æ¶ˆè²»æ¨¡å¼ï¼š</div>
                        
                        <label style="display:flex; align-items:center; width:100%; justify-content:space-between; margin-bottom:6px;">
                            <span>1ï¸âƒ£ å¯¦é«” / ä¸€èˆ¬ / åœ‹å¤–</span>
                            <input type="radio" name="laiDianMode" value="general" checked onchange="updateRewardPreview()">
                        </label>
                        
                        <label style="display:flex; align-items:center; width:100%; justify-content:space-between; margin-bottom:6px;">
                            <span>2ï¸âƒ£ LINE Pay ä¸€èˆ¬ (åŠ ç¢¼1%)</span>
                            <input type="radio" name="laiDianMode" value="lp" onchange="updateRewardPreview()">
                        </label>
                        
                        <label style="display:flex; align-items:center; width:100%; justify-content:space-between;">
                            <span>3ï¸âƒ£ å¶æ•¸æ—¥ + æŒ‡å®šé€šè·¯ (åŠ ç¢¼5%)</span>
                            <input type="radio" name="laiDianMode" value="even" onchange="updateRewardPreview()">
                        </label>
                        
                        <button onclick="toggleLaiDianDetails()" style="border:none; background:none; color:#007AFF; font-size:11px; cursor:pointer; padding:6px 0 0 0; width:100%; text-align:left;">ğŸ”½ æŸ¥çœ‹æŒ‡å®šé€šè·¯ (å¶æ•¸æ—¥+5%)</button>
                        <div id="laiDianDetails" class="details-content">
                            <b>æŒ‡å®šé€šè·¯ (éœ€ç¶å®š LINE Pay)ï¼š</b><br>
                            <b>é¤é£²ï¼š</b>ç‹å“ã€ä¸‰å•†ã€è¼•äº•æ¾¤ã€æ¼¢ä¾†ã€é¥—è³“ã€æµ·åº•æ’ˆã€ç¯‰é–“ã€æ˜¥æ°´å ‚ã€å£½å¸éƒã€çˆ­é®®ã€å…«æ–¹é›²é›†ã€éº¥ç•¶å‹ã€è‚¯å¾·åŸºã€æ‘©æ–¯ã€æ¼¢å ¡ç‹ã€æ˜Ÿå·´å…‹ã€è·¯æ˜“èã€camaã€50åµã€å¾—æ­£ã€éº»å¤ã€å¯ä¸å¯<br>
                            <b>è—¥å¦ï¼š</b>å±ˆè‡£æ°ã€å¯¶é›…ã€å”å‰è¨¶å¾·ã€å¤§æ¨¹ã€æä¸€ã€ä¸ä¸ã€ä½‘å…¨ã€èºç…<br>
                            <b>å®¶å±…å¯µç‰©ï¼š</b>IKEAã€Holaã€å°åŒ—ã€æ±ªå–µæ˜Ÿçƒã€æ±æ£®å¯µç‰©ã€å’•å’•Gã€é­šä¸­é­šã€å¯µç‰©å…¬åœ’<br>
                            <b>é‹å‹•ï¼š</b>NIKEã€Adidasã€NewBalanceã€è¿ªå¡å„‚ã€é‹å…¨å®¶ç¦ã€æ‘©æ›¼é “
                        </div>
                    </div>
                    
                    <div id="laiDianOverseasWarning" style="display:none; margin-top:8px; padding:8px; background:#ffebee; border-radius:6px; font-size:11px; color:#c62828;">
                        âš ï¸ åœ‹å¤–ç„¡ LP åŠ ç¢¼ï¼Œå›ºå®š 3% å›é¥‹ (ç„¡ä¸Šé™)
                    </div>
                </div>

                <div id="greenCardOptions">
                    <div class="option-row read-only"><label>ğŸ”° åœ‹å…§ 1% / åœ‹å¤– 2%</label><input type="checkbox" checked disabled></div>
                    
                    <div class="option-row" style="flex-direction:column; align-items:flex-start; gap:0;">
                        <div style="display:flex; justify-content:space-between; width:100%; align-items:center;">
                            <label for="checkGreenChannel">ğŸŒ¿ ç¶ è‰²é€šè·¯ +5% (åˆ·$3,000å°é ‚)</label>
                            <input type="checkbox" id="checkGreenChannel" onchange="toggleGreenLogic()">
                        </div>
                        <button onclick="toggleGreenDetails()" style="border:none; background:none; color:#007AFF; font-size:11px; cursor:pointer; padding:2px 0 6px 0;">ğŸ”½ é»æ“ŠæŸ¥çœ‹ç¶ è‰²é€šè·¯</button>
                        <div id="greenDetails" class="details-content">
                            <b>(1) ç¶ è‰²äº¤é€šï¼š</b><br>ç‰¹æ–¯æ‹‰ã€Gogoroã€WeMoã€iRentã€GoShareã€USPACEã€Ubike<br>
                            <b>(2) ç¶ è‰²é£²é£Ÿï¼š</b><br>å¯¬å¿ƒåœ’ã€é™½æ˜æ˜¥å¤©ã€å°å°æ¨¹é£Ÿã€é¤Šå¿ƒèŒ¶æ¨“ã€è‰è”¬å®´ã€ä¸Šå–„è±†å®¶<br>
                            <b>(3) ç¶ è‰²è³¼/æï¼š</b><br>ä¸­è¯é›»ä¿¡(é›»å­å¸³å–®)ã€å°ç£å¤§å“¥å¤§(é›»å­å¸³å–®)ã€é å‚³(é›»å­å¸³å–®)ã€Teslaå……é›»ã€æ…ˆæ¿Ÿã€ä¸–ç•Œå±•æœ›æœƒ<br>
                        </div>
                    </div>
                    
                    <div class="option-row" style="flex-direction:column; align-items:flex-start; gap:0; border-top:1px dashed #ddd; padding-top:6px; margin-top:6px;">
                          <button onclick="toggleParkingDetails()" style="border:none; background:none; color:#007AFF; font-size:11px; cursor:pointer; padding:2px 0 6px 0; font-weight:700;">ğŸ…¿ï¸ æŸ¥çœ‹å…è²»åœè»Šé©ç”¨åå–® (éœ€ä¸Šæœˆæ»¿é¡)</button>
                          <div id="greenParkingDetails" class="details-content">
                            <b>å°ç£è¯é€šã€è©®ç‡Ÿã€ViVi PARKã€å˜Ÿå˜Ÿæˆ¿ã€è»Šéº»å‰</b><br>
                            <span style="font-size:10px; color:#555;">(æ¯æ—¥1æ¬¡ã€æ¯æ¬¡2å°æ™‚ã€æ¯æœˆæœ€é«˜5æ¬¡)</span><br>
                          </div>
                    </div>

                    <div class="option-row" style="margin-top:6px; border-top:1px dashed #ddd; padding-top:6px; margin-bottom:0;"><label for="checkForeign">âœˆï¸ åœ‹å¤–æ¶ˆè²» 2% (ç„¡ä¸Šé™)</label><input type="checkbox" id="checkForeign" onchange="toggleForeignLogic()"></div>
                </div>
                
                <div id="uniOptions">
                    <div class="option-row read-only"><label id="labelUniBase">ğŸ”° ä»»æ„é¸ 3.5% (åˆ·$4è¬å°é ‚)</label><input type="checkbox" checked disabled></div>
                    <div class="option-row"><label for="checkUniUp">ğŸ†™ è¨‚é–± UP é¸ 4.5% (åˆ·$14è¬å°é ‚)</label><input type="checkbox" id="checkUniUp" onchange="toggleUniUpLogic()"></div>
                    <div id="uniChannelSection" style="margin-top:6px; border-top:1px dashed #ddd; padding-top:6px;">
                        <div style="display:flex; justify-content:space-between; width:100%; align-items:center; margin-bottom:6px;">
                            <label style="font-size:13px;">ğŸ“‹ æˆ‘çš„ 8 é …é€šè·¯ <span id="uniChannelCount" style="font-size:11px; color:#999;"></span></label>
                            <button onclick="toggleUniChannelList()" style="border:none; background:#007AFF; color:white; font-size:10px; padding:4px 8px; border-radius:4px; cursor:pointer;" id="btnToggleUniChannel">å±•é–‹é€šè·¯ â–¼</button>
                        </div>
                        <div id="uniChannelContainer" style="width:100%; display:none;"></div>
                    </div>

                    <div class="option-row" style="margin-top:6px; border-top:1px dashed #ddd; padding-top:6px; margin-bottom:0;"><label for="checkUniBonus">ğŸ”¥ çµ±ä¸€æ™‚ä»£ä»»å‹™ +3% (åˆ·$1.6è¬å°é ‚)</label><input type="checkbox" id="checkUniBonus" onchange="updateRewardPreview()"></div>
                    
                    <div id="uniOverseasWarning" style="display:none; margin-top:8px; padding:8px; background:#ffebee; border-radius:6px; font-size:11px; color:#c62828;">
                        âš ï¸ åœ‹å¤–æ¶ˆè²»ç„¡åŠ ç¢¼ï¼Œåƒ…äº«åŸºæœ¬ 1% å›é¥‹
                    </div>
                </div>
                
                <div id="uniOpenOptions">
                    <div class="option-row read-only"><label>ğŸ”° åŸºæœ¬å›é¥‹ 1% (ç„¡ä¸Šé™)</label><input type="checkbox" checked disabled></div>
                    <div class="option-row"><label for="checkUniGroup">ğŸª çµ±ä¸€é›†åœ˜ +2% (åˆ·$2.5è¬å°é ‚)</label><input type="checkbox" id="checkUniGroup" onchange="toggleUniGroup()"></div>
                    <div class="option-row"><label for="checkUniIcash">ğŸ“± icash Pay +4% (åˆ·$3,750å°é ‚)</label><input type="checkbox" id="checkUniIcash" onchange="toggleUniIcash()"></div>
                    
                    <div class="option-row" style="border-top:1px dashed #ddd; padding-top:6px; margin-top:6px; flex-direction:column; align-items:flex-start;">
                        <div style="display:flex; justify-content:space-between; width:100%; align-items:center; margin-bottom:6px;">
                            <label>ğŸƒ è¸©é»ä»»å‹™ (2å®¶èµ·è·³ï¼Œæœ€é«˜+4%)</label>
                            <button onclick="toggleUniBrandList()" style="border:none; background:#007AFF; color:white; font-size:10px; padding:4px 8px; border-radius:4px; cursor:pointer;" id="btnToggleUniBrand">å±•é–‹å“ç‰Œ â–¼</button>
                        </div>
                        <div id="uniBrandContainer" style="width:100%; display:none;">
                            <!-- ä¾¿åˆ©å•†åº—/è¶…å¸‚ -->
                            <div class="brand-category">
                                <div class="brand-category-header" onclick="toggleBrandCategory('cat1')">
                                    <span>ğŸª ä¾¿åˆ©å•†åº—/è¶…å¸‚</span>
                                    <span class="arrow" id="arrow-cat1">â–¼</span>
                                </div>
                                <div class="brand-category-content" id="content-cat1">
                                    <div class="brand-grid" id="uniBrandGrid-cat1"></div>
                                </div>
                            </div>
                            <!-- ç™¾è²¨/è³¼ç‰© -->
                            <div class="brand-category">
                                <div class="brand-category-header" onclick="toggleBrandCategory('cat2')">
                                    <span>ğŸ›ï¸ ç™¾è²¨/è³¼ç‰©</span>
                                    <span class="arrow" id="arrow-cat2">â–¼</span>
                                </div>
                                <div class="brand-category-content" id="content-cat2">
                                    <div class="brand-grid" id="uniBrandGrid-cat2"></div>
                                </div>
                            </div>
                            <!-- é¤é£²/ç”œé» -->
                            <div class="brand-category">
                                <div class="brand-category-header" onclick="toggleBrandCategory('cat3')">
                                    <span>ğŸ½ï¸ é¤é£²/ç”œé»</span>
                                    <span class="arrow" id="arrow-cat3">â–¼</span>
                                </div>
                                <div class="brand-category-content" id="content-cat3">
                                    <div class="brand-grid" id="uniBrandGrid-cat3"></div>
                                </div>
                            </div>
                            <!-- å¥èº«/ä¼‘é–’ -->
                            <div class="brand-category">
                                <div class="brand-category-header" onclick="toggleBrandCategory('cat4')">
                                    <span>ğŸ’ª å¥èº«/ä¼‘é–’</span>
                                    <span class="arrow" id="arrow-cat4">â–¼</span>
                                </div>
                                <div class="brand-category-content" id="content-cat4">
                                    <div class="brand-grid" id="uniBrandGrid-cat4"></div>
                                </div>
                            </div>
                            <!-- ç”Ÿæ´»æœå‹™ -->
                            <div class="brand-category">
                                <div class="brand-category-header" onclick="toggleBrandCategory('cat5')">
                                    <span>ğŸ  ç”Ÿæ´»æœå‹™</span>
                                    <span class="arrow" id="arrow-cat5">â–¼</span>
                                </div>
                                <div class="brand-category-content" id="content-cat5">
                                    <div class="brand-grid" id="uniBrandGrid-cat5"></div>
                                </div>
                            </div>
                            <!-- æ—…éŠ/é£¯åº— -->
                            <div class="brand-category">
                                <div class="brand-category-header" onclick="toggleBrandCategory('cat6')">
                                    <span>ğŸ¨ æ—…éŠ/é£¯åº—</span>
                                    <span class="arrow" id="arrow-cat6">â–¼</span>
                                </div>
                                <div class="brand-category-content" id="content-cat6">
                                    <div class="brand-grid" id="uniBrandGrid-cat6"></div>
                                </div>
                            </div>
                        </div>
                        <div style="font-size:10px; color:#FF9800; margin-top:6px; font-weight:700;" id="taskBonusDisplay">ç›®å‰ 0 å®¶ (åŠ ç¢¼ 0%)</div>
                    </div>
                    <div class="option-row" style="margin-top:6px; border-top:1px dashed #ddd; padding-top:6px;">
                        <label for="checkUniOverseas">âœˆï¸ æµ·å¤–å¯¦é«” 11% (åˆ·$6,250å°é ‚)</label>
                        <input type="checkbox" id="checkUniOverseas" onchange="toggleUniOverseas()">
                    </div>
                </div>
                
                <div id="jiangOptions">
                    <div class="option-row read-only"><label>ğŸ”° åŸºæœ¬å›é¥‹ 0.5% (ç„¡ä¸Šé™)</label><input type="checkbox" checked disabled></div>
                    
                    <div class="option-row" style="flex-direction:column; align-items:flex-start; gap:0px; border-top:1px dashed #ddd; padding-top:8px;">
                        <div style="display:flex; justify-content:space-between; width:100%; align-items:center; margin-bottom:4px;">
                            <label for="checkJiangSelected">ğŸ›ï¸ ç”Ÿæ´»å‡ç´š +4.5% (åˆ·$6,666å°é ‚)</label>
                            <input type="checkbox" id="checkJiangSelected" onchange="toggleJiangSelected()">
                        </div>
                        <button onclick="toggleJiangDetails()" style="border:none; background:none; color:#007AFF; font-size:11px; cursor:pointer; padding:0 0 6px 0;">ğŸ”½ é»æ“ŠæŸ¥çœ‹æŒ‡å®šé€šè·¯æ¸…å–®</button>
                        <div id="jiangDetails" class="details-content">
                            <b>(1) Aiå·¥å…·åŠæ•¸ä½å·¥å…·ï¼š</b><br>ChatGPTã€Canvaã€Claudeã€Cursorã€Duolingoã€Gammaã€Geminiã€Notionã€Perplexityã€Speakã€Apple åª’é«”æœå‹™ã€Google Play<br>
                            <b>(2) å­¸ç¿’å¹³å°ï¼š</b><br>Hahowã€Udemyã€VoiceTubeã€PressPlayã€AmazingTalkerã€Readmooã€æ™ºåŸºç§‘æŠ€(å­¸æ€é…·)<br>
                            <b>(3) åœ‹å…§å¤–é€å¹³å°(ä¸å«æœƒå“¡è²»ç”¨)ï¼š</b><br>Uber Eatsã€foodpanda<br>
                            <b>(4) ç”Ÿæ´»å®¶å±…ï¼š</b><br>IKEAå®œå®¶å®¶å±…ã€ç‰¹åŠ›å±‹ã€HOLA<br>
                            <b>(5) æŒ‡å®šè¶…å•†è¶…å¸‚ï¼š</b><br>7-ELEVEN å¯¦é«”é–€å¸‚(icash payã€è¡—å£æ”¯ä»˜ã€æ©˜å­æ”¯ä»˜)ã€å…¨å®¶ä¾¿åˆ©å•†åº—(è¡—å£æ”¯ä»˜)ã€å®¶æ¨‚ç¦<br>
                            <b>(6) é‹å‹•å¥èº«ï¼š</b><br>World Gymã€BEING Fitã€Curvesã€å¥èº«å·¥å» <br>
                            <b>(7) åœ‹å…§é¤å»³ï¼š</b><br>åœ‹å…§é¤å»³(MCC 5811/5812/5814/5462)ã€é€£é–é€Ÿé£Ÿï¼éº¥ç•¶å‹<br>
                            <b>(8) è¡Œå‹•æ”¯ä»˜ï¼š</b><br>LINE Payã€è¡—å£æ”¯ä»˜ã€icash Payã€æ©˜å­æ”¯ä»˜ã€æ‚ éŠä»˜ã€Hami Payã€PiéŒ¢åŒ…ã€TWQR<br>
                            <b>(9) äº¤é€šï¼š</b><br>ä¸€å¡é€šè‡ªå‹•åŠ å€¼ã€é«˜éµ(å«é«˜éµappç·šä¸Šåˆ·å¡)<br>
                        </div>
                    </div>
                    
                    <div class="option-row" id="jiangTravelRow" style="border-top:1px dashed #ddd; padding-top:8px; margin-top:4px; flex-direction:column; align-items:flex-start;">
                          <div style="display:flex; justify-content:space-between; width:100%; align-items:center;">
                            <label for="checkJiangTravel">âœˆï¸ æ—…éŠåŠ ç¢¼ +4.5% (åˆ·$1.1è¬å°é ‚)</label>
                            <input type="checkbox" id="checkJiangTravel" onchange="toggleJiangTravel()">
                        </div>
                        <button onclick="toggleJiangTravelDetails()" style="border:none; background:none; color:#007AFF; font-size:11px; cursor:pointer; padding:2px 0 6px 0;">ğŸ”½ é»æ“ŠæŸ¥çœ‹æ—…éŠ/èˆªç©º/æ—…è¡Œç¤¾</button>
                        <div id="jiangTravelDetails" class="details-content">
                            <b>(1) æµ·å¤–åŠèˆªç©ºï¼š</b><br>æ¶ˆè²»åœ‹åˆ¥éå°ç£æˆ–å¹£åˆ¥éå°å¹£ã€èˆªç©º MCC 3000~3350/4511/4723<br>(æ˜Ÿå®‡ã€è¯èˆªã€é•·æ¦®ã€åœ‹æ³°ã€è™èˆªã€é˜¿è¯é…‹ã€é…·èˆªã€æ¨‚æ¡ƒã€æ·æ˜Ÿã€æ—¥èˆªã€ANAã€äºèˆªã€è¯åˆã€è¶Šæ·ã€å¤§éŸ“ã€é”ç¾ã€åœŸè€³å…¶ã€å¡é”ã€æ³•èˆª)<br>
                            <b>(2) æ—…è¡Œç¤¾ï¼š</b><br>æ˜“éŠç¶²ã€é›„ç…ã€å¯æ¨‚ã€æ±å—ã€äº”ç¦ã€ç‡¦æ˜Ÿã€å±±å¯Œã€é•·æ±ã€é³³å‡°ã€æ˜“é£›ç¶²ã€ç†æƒ³ã€æ°¸åˆ©ã€ä¸‰è³€<br>
                        </div>
                    </div>
                    <div id="jiangTravelExpMsg" style="font-size:10px; color:#d32f2f; margin-top:2px; display:none;">âš ï¸ æ´»å‹•å·²æ–¼ 3/31 çµæŸ</div>
                    
                    <div id="jiangMinSpendWarning" style="display:none; margin-top:8px; padding:8px; background:#fff3e0; border-radius:6px; font-size:11px; color:#e65100;">
                        âš ï¸ éœ€ç•¶æœˆç´¯ç©æ»¿ $3,000 æ‰äº«åŠ ç¢¼å›é¥‹
                    </div>
                </div>

                <div id="dbsEcoOptions">
                      <div class="option-row read-only"><label>ğŸ”° åœ‹å…§å¤–ä¸€èˆ¬ 1% (ç„¡ä¸Šé™)</label><input type="checkbox" checked disabled></div>
                      
                      <div class="option-row" style="background:#fff3e0; padding:8px; border-radius:6px; margin-top:6px; flex-direction:column; align-items:flex-start;">
                          <div style="display:flex; justify-content:space-between; width:100%; align-items:center;">
                            <label for="checkDbsLinePay">âš¡ æ–°æˆ¶ LINE Pay +9% (åˆ·$11,111å°é ‚)</label>
                            <input type="checkbox" id="checkDbsLinePay" onchange="toggleDbsLogic('linepay')">
                        </div>
                        <div style="font-size:10px; color:#d32f2f; margin-top:4px;">*ä¸Šé™ 1000 é»</div>
                      </div>
                      
                      <div class="option-row" style="margin-top:6px; border-top:1px dashed #ddd; padding-top:6px; flex-direction:column; align-items:flex-start;">
                          <div style="display:flex; justify-content:space-between; width:100%; align-items:center;">
                            <label for="checkDbsGreen">ğŸŒ¿ ç¶ è‰²/ç‰¹æ–¯æ‹‰ +9% (åˆ·$3,333å°é ‚)</label>
                            <input type="checkbox" id="checkDbsGreen" onchange="toggleDbsLogic('green')">
                        </div>
                        <button onclick="toggleDbsDetails()" style="border:none; background:none; color:#007AFF; font-size:11px; cursor:pointer; padding:2px 0 6px 0;">ğŸ”½ é»æ“ŠæŸ¥çœ‹åŠ ç¢¼è©³æƒ…</button>
                        <div id="dbsDetails" class="details-content">
                            <b>ç¶ è‰²æ¶ˆè²» (å«ç‰¹æ–¯æ‹‰/Gogoro)ï¼š</b><br>åŠ ç¢¼ 9% (ä¸Šé™ 300 é»)ã€‚<br>é€šè·¯ï¼šTeslaå……é›»/é…ä»¶ã€Gogoroé›»æ± è³‡è²»ã€æ˜Ÿå·´å…‹(éš¨è¡Œå¡å„²å€¼ä¸é©ç”¨)ã€é®®ä¹³åŠã€èŒ¶ç±½å ‚ã€å°ç£å¤§è»ŠéšŠã€iRentã€WeMoã€GoShare<br>
                        </div>
                      </div>

                      <div class="option-row" style="margin-top:6px; border-top:1px dashed #ddd; padding-top:6px;">
                          <label for="checkDbsForeign">âœˆï¸ åœ‹å¤–å¯¦é«” +4% (åˆ·$1.5è¬å°é ‚)</label>
                          <input type="checkbox" id="checkDbsForeign" onchange="toggleDbsLogic('foreign')">
                      </div>
                </div>
                
                <div id="happyOptions">
                      <div class="option-row read-only"><label>ğŸ”° åŸºæœ¬å›é¥‹ 0.5% (ç„¡ä¸Šé™)</label><input type="checkbox" checked disabled></div>
                      <div class="option-row" style="flex-direction:column; align-items:flex-start; margin-bottom:10px; margin-top:6px;">
                          <div class="option-row" style="width:100%; justify-content:space-between;">
                              <label>ğŸ¶ æŒ‡å®šå¯µç‰© +9.5%  <span id="happyPetRemain" style="font-size:10px;color:#aaa"></span></label>
                             <input type="checkbox" id="checkHappyPet" onchange="handleHappyExclusive('pet')">
                          </div>
                          <button onclick="toggleHappyPetDetails()" style="border:none; background:none; color:#007AFF; font-size:11px; cursor:pointer; padding:0 0 8px 24px; text-align:left;">ğŸ”½ æŸ¥çœ‹å¯µç‰©é€šè·¯</button>
                          <div id="happyPetDetails" class="details-content" style="margin-left:8px; margin-bottom:8px;">
                            <b>(1) æŒ‡å®šå¯µç‰©é€£é–ï¼š</b><br>å¯µç‰©å…¬åœ’ã€æ±æ£®å¯µç‰©ã€é­šä¸­é­šã€è²“ç‹—éšŠé•·ã€æ¯›å­©å¸‚é›†ã€é‡‘å‰åˆ©ã€å¥½ç‹—å‘½ã€å¥½ç‹—é‹ã€é‡‘ç‹å­ã€æ„›è²“åœ’ã€ç¦å£½å¯µç‰©æ——è‰¦é¤¨<br>
                            <b>(2) 2026 æ–°å¢å“ç‰Œï¼š</b><br>æ±ªå–µæ˜Ÿçƒã€æ€ªç¸éƒ¨è½ã€è¶…å‡å°å§ã€Hero Mama<br>
                            <b>(3) é†«ç™‚èˆ‡ç¾å®¹ï¼š</b><br>ç¸é†«è¨ºæ‰€ã€å‹•ç‰©é†«é™¢ã€å¯µç‰©æ—…é¤¨ã€å¯µç‰©ç¾å®¹ (MCC 0742, 5995)<br>
                          </div>
                          
                          <div class="option-row" style="width:100%; justify-content:space-between;">
                              <label>ğŸ½ï¸ æŒ‡å®šç”Ÿæ´» +3.5%  <span id="happyLifeRemain" style="font-size:10px;color:#aaa"></span></label>
                              <input type="checkbox" id="checkHappyLife" onchange="handleHappyExclusive('life')">
                          </div>
                          <button onclick="toggleHappyLifeDetails()" style="border:none; background:none; color:#007AFF; font-size:11px; cursor:pointer; padding:0 0 8px 24px; text-align:left;">ğŸ”½ æŸ¥çœ‹ç™¾è²¨/é‡è²©/äº¤é€š</button>
                          <div id="happyLifeDetails" class="details-content" style="margin-left:8px; margin-bottom:8px;">
                            <b>(1) ç™¾è²¨/Outletï¼š</b><br>é æ±ç™¾è²¨ã€SOGOã€å·¨åŸã€å¤§é ç™¾ã€å—ç´¡ã€å¤¢æ™‚ä»£ã€skmparkã€å°šé †ã€å¤§é­¯é–£(æ¹³é›…)ã€æ¡ƒçŸ¥é“ã€å¤§æ±Ÿã€å°èŒ‚ã€æ–°æœˆã€é é›„ã€å®åŒ¯ã€CITYLINKã€ç¾éº—è¯ã€å¤§è‘‰é«˜å³¶å±‹ã€çµ±ä¸€æ™‚ä»£ã€æ•…å®®ã€ç§€æ³°ã€ç’°çƒã€IKEAã€éº—å¯¶ã€LaLaport<br>
                            <b>(2) è¶…å¸‚é‡è²©/ç”Ÿæ©Ÿï¼š</b><br>æ„›è²·ã€å®¶æ¨‚ç¦ã€ç¾å»‰ç¤¾ã€å°åŒ—ã€å¤§è²·å®¶ã€å–œäº’æƒ ã€æ£‰èŠ±ç”°ã€è–å¾·ç§‘æ–¯ã€æ°¸è±é¤˜ç”ŸæŠ€ã€é‡Œä»ã€å°ç£ä¸»å©¦è¯ç›Ÿã€å¥åº·é£Ÿå½©ã€å®‰éº—ã€è‘¡çœ¾ã€ç¾æ¨‚å®¶<br>
                            <b>(3) äº¤é€šé›»ä¿¡ï¼š</b><br>åœ‹å…§åŠ æ²¹(ä¸­æ²¹/å°äº/å°å¡‘)ã€gogoroã€Teslaã€å°ç£å¤§è»ŠéšŠã€yoxiã€Uber(å°ç£)ã€GoShareã€iRentã€WeMoã€é å‚³/å°å“¥å¤§å¸³å–®<br>
                            <b>(4) æ•™è‚²/æ›¸åº—ï¼š</b><br>å°ç£è”¦å±‹ã€èª å“ã€åšå®¢ä¾†ã€é‡‘çŸ³å ‚ã€å·¨åŒ ã€è¯æˆã€æœ±å®—æ…¶ã€é›²é–€<br>
                          </div>
                          
                          <div class="option-row" style="width:100%; justify-content:space-between;">
                              <label>ğŸ“¡ æŒ‡å®šå®‰å¿ƒ +3.5%  <span id="happyPeaceRemain" style="font-size:10px;color:#aaa"></span></label>
                              <input type="checkbox" id="checkHappyPeace" onchange="handleHappyExclusive('peace')">
                          </div>
                            <button onclick="toggleHappyPeaceDetails()" style="border:none; background:none; color:#007AFF; font-size:11px; cursor:pointer; padding:0 0 8px 24px; text-align:left;">ğŸ”½ æŸ¥çœ‹é¤å»³/è—¥å±€/å±…å®¶</button>
                            <div id="happyPeaceDetails" class="details-content" style="margin-left:8px; margin-bottom:8px;">
                            <b>(1) åœ‹å…§é¤å»³ï¼š</b><br>åœ‹å…§å„å¤§æŒ‡å®šé¤å»³ (MCC 5811, 5812, 5813, 5814)<br>
                            <b>(2) å©¦å¹¼è—¥å±€/å±…å®¶ï¼š</b><br>å¤§æ¨¹ã€æä¸€ã€ç¶­åº·ã€èºç…ã€å¡å¤šæ‘©ã€å®œå…’æ¨‚ã€ç‡Ÿé¤ŠéŠ€è¡Œã€éº—å…’é‡‡å®¶ã€åª½å’ªæ¨‚å±…å®¶æœå‹™ã€æ½”å®¢å¹«<br>
                            <b>(3) é‹å‹•å¥èº«ï¼š</b><br>ä½ç™»å¦®çµ²ã€å¥èº«å·¥å» ã€World Gymã€BEING spaã€BEING sportã€Curveså¯çˆ¾å§¿<br>
                           </div>

                          <div class="option-row" style="width:100%; justify-content:space-between;">
                              <label>âœˆï¸ åœ‹å¤–æ¶ˆè²» +2.0% </label>
                              <input type="checkbox" id="checkHappyForeign" onchange="handleHappyExclusive('foreign')">
                          </div>
                      </div>
                    <div id="happyDashboard" class="happy-dashboard"></div>
                    
                    <div id="happyMinSpendWarning" style="display:none; margin-top:8px; padding:8px; background:#fff3e0; border-radius:6px; font-size:11px; color:#e65100;">
                        âš ï¸ éœ€ç•¶æœˆç´¯ç©æ»¿ $3,000 æ‰äº«åŠ ç¢¼ï¼›æ»¿ $26,000 é¡å¤–é€ $400
                    </div>
                    
                    <div id="happyOverseasWarning" style="display:none; margin-top:8px; padding:8px; background:#ffebee; border-radius:6px; font-size:11px; color:#c62828;">
                        âš ï¸ åœ‹å¤–åƒ…äº« +2% åœ‹å¤–åŠ ç¢¼ï¼Œå…¶ä»–é€šè·¯åŠ ç¢¼ä¸é©ç”¨
                    </div>
                </div>

                <div id="hsbcOptions">
                      <div class="option-row" style="border-bottom:1px solid #eee; padding-bottom:10px; margin-bottom:10px;">
                        <span style="font-weight:700; color:#333;">ğŸ’³ é¸æ“‡æ‚¨çš„å¡ç‰‡ç­‰ç´š (è‡ªå‹•è¨˜æ†¶)ï¼š</span>
                        <div style="display:flex; gap:15px; margin-top:8px;">
                            <label style="display:flex; align-items:center; font-weight:normal; font-size:13px;"><input type="radio" name="hsbcTier" value="infinite" onchange="saveHsbcTier()"> ç„¡é™å¡</label>
                            <label style="display:flex; align-items:center; font-weight:normal; font-size:13px;"><input type="radio" name="hsbcTier" value="signature" onchange="saveHsbcTier()"> å¾¡ç’½å¡</label>
                        </div>
                    </div>
                    <div class="option-row"><label for="hsbcInitialMiles">ğŸ å·²æœ‰å“©ç¨‹ (èµ·å§‹å€¼)</label><input type="number" id="hsbcInitialMiles" onchange="saveHsbcInitial()" style="text-align:right; width: 100px; border:1px solid #ccc; border-radius:4px; padding:4px;" placeholder="0"></div>
                    <div class="option-row"><label for="hsbcRedeemedMiles" style="color:#d32f2f;">â– å·²å…Œæ›å“©ç¨‹</label><input type="number" id="hsbcRedeemedMiles" onchange="saveHsbcSettings()" style="text-align:right; width: 100px; border:1px solid #ffcdd2; color:#d32f2f; border-radius:4px; padding:4px;" placeholder="0"></div>
                      <div class="option-row" style="margin-top:10px; border-top:1px dashed #ddd; padding-top:6px;"><label for="checkHsbcForeign">âœˆï¸ åœ‹å¤–æ¶ˆè²»</label><input type="checkbox" id="checkHsbcForeign" onchange="updateRewardPreview()"></div>
                </div>
                
                <div id="richartOptions">
                    <div style="font-size:12px; color:#D32F2F; background:#FFEBEE; padding:8px; border-radius:6px; margin-bottom:10px; font-weight:700; border:1px solid #FFCDD2;">
                        âš ï¸ éœ€ç¶å®š Richart å¸³æˆ¶è‡ªå‹•æ‰£ç¹³ (æœªç¶åƒ…0.3%)
                    </div>
                    <div class="option-row"><label for="rbRichartGeneral">ğŸ”° ä¸€èˆ¬æ¶ˆè²» (0.3%)</label><input type="radio" name="richartMode" id="rbRichartGeneral" value="general" checked onchange="toggleRichartLogic()"></div>
                    <div class="option-row"><label for="rbRichartTaishinPay">ğŸ“± Payè‘—åˆ·ï¼å°æ–°Pay (3.8%)</label><input type="radio" name="richartMode" id="rbRichartTaishinPay" value="taishinpay" onchange="toggleRichartLogic()"></div>
                    <div class="option-row"><label for="rbRichartLinePay">ğŸŸ¢ Payè‘—åˆ·ï¼LINE Pay (2.3%)</label><input type="radio" name="richartMode" id="rbRichartLinePay" value="linepay" onchange="toggleRichartLogic()"></div>
                    <div class="option-row"><label for="rbRichartPlan33">ğŸ“‹ æŒ‡å®šæ–¹æ¡ˆ (3.3%)</label><input type="radio" name="richartMode" id="rbRichartPlan33" value="plan33" onchange="toggleRichartLogic()"></div>
                    <div id="richartPlan33Sub" style="display:none; margin-left:28px; margin-top:4px; margin-bottom:4px;">
                        <select id="selRichartPlan33" onchange="toggleRichartLogic()" style="width:100%; padding:6px 8px; border-radius:6px; border:1px solid #ccc; font-size:13px;">
                            <option value="tianti">å¤©å¤©åˆ· (è¶…å•†é‡è²©/é€šå‹¤äº¤é€š/è—¥å¦è—¥å±€)</option>
                            <option value="dabi">å¤§ç­†åˆ· (æŒ‡å®šç™¾è²¨/Outlet/å±…å®¶è£ä¿®)</option>
                            <option value="haoxiang">å¥½é¥—åˆ· (é¤é£²/å¤–é€/è¨‚æˆ¿/å¨›æ¨‚)</option>
                            <option value="shuqu">æ•¸è¶£åˆ· (ç¶²è³¼/ç·šä¸Šèª²ç¨‹/éŠæˆ²å½±éŸ³)</option>
                            <option value="wanlv">ç©æ—…åˆ· (æµ·å¤–æ¶ˆè²»/èˆªç©º/è¨‚æˆ¿æ—…è¡Œ)</option>
                        </select>
                    </div>
                    <div class="option-row"><label for="rbRichartHoliday">ğŸ‰ å‡æ—¥åˆ· (2%)</label><input type="radio" name="richartMode" id="rbRichartHoliday" value="holiday" onchange="toggleRichartLogic()"></div>
                    <div class="option-row" id="rbRichartJpPaypayRow" style="display:none; border-top:1px dashed #ddd; margin-top:6px; padding-top:6px;">
                        <label for="rbRichartJpPaypay">ğŸ‡¯ğŸ‡µ å°æ–°Pay+ æ—¥æœ¬PayPay (3.8%+å…1.5%æ‰‹çºŒè²»)</label>
                        <input type="radio" name="richartMode" id="rbRichartJpPaypay" value="jpPaypay" onchange="toggleRichartLogic()">
                    </div>
                    <div id="richartJpPaypayNote" style="display:none; font-size:10px; color:#555; margin-top:4px; opacity:0.8;">
                        ğŸ’¡ éœ€æ­é… Payè‘—åˆ· æ¬Šç›Šï¼Œé€é Richart Life APP æƒç¢¼ä»˜æ¬¾
                    </div>
                    <div style="font-size:10px; color:#555; margin-top:8px; opacity:0.8;">
                        ğŸ’¡ å°æ’‡æ­¥ï¼šè‹¥ç¶²è³¼ä½¿ç”¨å°æ–°Payï¼Œè«‹å‹¾é¸ã€ŒPayè‘—åˆ·ï¼å°æ–°Pay (3.8%)ã€
                    </div>
                </div>

               <div id="fubonJOptions">
                    <div class="option-row read-only"><label id="labelFubonJBase">ğŸ”° åœ‹å…§æ¶ˆè²» 1% (ç„¡ä¸Šé™)</label><input type="checkbox" checked disabled></div>
                    
                    <!-- æ—¥éŸ“å°ˆå±¬å€å¡Š -->
                    <div id="fubonJJpkrSection" style="border-top:1px dashed #ddd; padding-top:8px; margin-top:8px;">
                        <div class="option-row">
                            <label for="checkFubonJJpkr">ğŸ‡¯ğŸ‡µğŸ‡°ğŸ‡· æ—¥éŸ“æ¶ˆè²» (åŸºæœ¬ 3%)</label>
                            <input type="checkbox" id="checkFubonJJpkr" onchange="toggleFubonJJpkr()">
                        </div>
                        
                        <div class="option-row" id="rowFubonJJpkrBonus" style="margin-top:6px; padding-left:20px;">
                            <label for="checkFubonJJpkrBonus">ğŸ›ï¸ æ—¥éŸ“å¯¦é«” +3%</label>
                            <input type="checkbox" id="checkFubonJJpkrBonus" onchange="toggleFubonJJpkrBonus()">
                        </div>
                        <div id="fubonJJpkrMinSpend" style="font-size:10px; color:#888; margin-top:2px; padding-left:20px;"></div>
                        
                        <div class="option-row" id="rowFubonJSuica" style="margin-top:6px; padding-left:20px;">
                            <label for="checkFubonJSuica">ğŸ æ—¥æœ¬äº¤é€šå¡ +7%</label>
                            <input type="checkbox" id="checkFubonJSuica" onchange="toggleFubonJSuica()">
                        </div>
                        <div id="fubonJSuicaMinSpend" style="font-size:10px; color:#888; margin-top:2px; padding-left:20px;"></div>
                    </div>
                    
                    <!-- æ³°åœ‹å°ˆå±¬å€å¡Š -->
                    <div id="fubonJThSection" style="border-top:1px dashed #ddd; padding-top:8px; margin-top:8px;">
                        <div class="option-row">
                            <label for="checkFubonJTh">ğŸ‡¹ğŸ‡­ æ³°åœ‹æ¶ˆè²» (åŸºæœ¬ 1%)</label>
                            <input type="checkbox" id="checkFubonJTh" onchange="toggleFubonJTh()">
                        </div>
                        
                        <div class="option-row" id="rowFubonJThBonus" style="margin-top:6px; padding-left:20px;">
                            <label for="checkFubonJThBonus">ğŸ›ï¸ æ³°åœ‹å¯¦é«” +5%</label>
                            <input type="checkbox" id="checkFubonJThBonus" onchange="toggleFubonJThBonus()">
                        </div>
                        <div id="fubonJThMinSpend" style="font-size:10px; color:#888; margin-top:2px; padding-left:20px;"></div>
                    </div>
                    
                    <div id="fubonJMinSpendWarning" style="display:none; margin-top:8px; padding:8px; background:#ffebee; border-radius:6px; font-size:11px; color:#c62828;"></div>
                </div>

                <div id="jiheOptions">
                    <div class="option-row read-only"><label id="labelJiheBase">ğŸ”° åœ‹å…§æ¶ˆè²» 1% (ç„¡ä¸Šé™)</label><input type="checkbox" checked disabled></div>
                    
                    <!-- åœ‹å…§å°ˆå±¬ï¼šæ—¥ç³»ååº— -->
                    <div class="option-row" id="rowJiheDomesticJapanese" style="border-top:1px dashed #ddd; padding-top:6px; flex-direction:column; align-items:flex-start;">
                        <div style="display:flex; justify-content:space-between; width:100%; align-items:center;">
                             <label for="checkJiheDomesticJapanese">ğŸ‡¹ğŸ‡¼ åœ‹å…§æ—¥ç³»ååº— +4% (åˆ·$1.25è¬å°é ‚)</label>
                             <input type="checkbox" id="checkJiheDomesticJapanese" onchange="toggleJiheDomestic()">
                        </div>
                        <button onclick="toggleJiheDetails()" style="border:none; background:none; color:#007AFF; font-size:11px; cursor:pointer; padding:2px 0 6px 0;">ğŸ”½ é»æ“ŠæŸ¥çœ‹æŒ‡å®šé€šè·¯</button>
                        <div id="jiheDetails" class="details-content">
                            <b>(1) æœé£¾ï¼š</b><br>UNIQLOã€GUã€æ€å¤¢æ¨‚ã€GLOBAL WORKã€niko and â€¦ã€LOWRYS FARMã€LAKOLEã€studio CLIPã€repipi armarioã€HAREã€Heatherã€PAGEBOYã€RAGEBLUEã€LEPSIMã€JEANASIS<br>
                            <b>(2) ç”Ÿæ´»/è—¥å¦ï¼š</b><br>DAISOå¤§å‰µã€Standard Productsã€THREEPPYã€æ—¥è—¥æœ¬èˆ–ã€æ¾æœ¬æ¸…ã€Tomod'sã€æœ­å¹Œè—¥å¦ã€TSUTAYA BOOKSTOREã€HANDSå°éš†æ‰‹å‰µé¤¨ã€å®œå¾—åˆ©å®¶å±…<br>
                        </div>
 
                    </div>
                    
                    <!-- æ—¥æœ¬å°ˆå±¬å€å¡Š -->
                    <div id="jiheJapanSection" style="border-top:1px dashed #ddd; padding-top:8px; margin-top:8px;">
                        <div class="option-row">
                            <label for="checkJiheJapan">ğŸ‡¯ğŸ‡µ æ—¥æœ¬æ¶ˆè²» (åŸºæœ¬ 2.5%)</label>
                            <input type="checkbox" id="checkJiheJapan" onchange="toggleJiheJapan()">
                        </div>
                        
                        <div class="option-row" id="rowJiheApple" style="margin-top:6px; padding-left:20px;">
                            <label for="checkJiheApple">ğŸ Apple Pay +1.5% (åˆ·$4è¬å°é ‚)</label>
                            <input type="checkbox" id="checkJiheApple" onchange="toggleJiheApple()">
                        </div>
                        <div style="font-size:10px; color:#888; margin-top:2px; padding-left:20px;">âš ï¸ éœ€å–®ç­†ç­‰å€¼å°å¹£ $100ï¼Œå‹¾é¸è‡ªå‹•åˆ‡æ›ç‚ºæ—¥æœ¬æ¶ˆè²»</div>
                    </div>
                </div>
                
               <div id="kumamonOptions">
                    <div class="option-row read-only"><label id="labelKumamonBase">ğŸ”° åœ‹å…§æ¶ˆè²» 0.5% (ç„¡ä¸Šé™)</label><input type="checkbox" checked disabled></div>
                    
                    <!-- æ—¥æœ¬æ¶ˆè²»å€å¡Š -->
                    <div id="kumamonJapanSection" style="border-top:1px dashed #ddd; padding-top:8px; margin-top:8px;">
                        <div class="option-row"><label for="checkKumamonJapan">ğŸ‡¯ğŸ‡µ æ—¥æœ¬æ¶ˆè²» (åŸºæœ¬ 2.5%)</label><input type="checkbox" id="checkKumamonJapan" onchange="toggleKumamonJapan()"></div>
                        
                        <div id="groupKumamonJapan" style="display:none;">
                            <div class="option-row" style="padding-top:6px; padding-left:20px; flex-direction:column; align-items:flex-start;">
                                <div style="display:flex; justify-content:space-between; width:100%; align-items:center;">
                                    <label for="checkKumamonDesignated">ğŸ» æŒ‡å®šé€šè·¯ +6% (åˆ·$8,333å°é ‚)</label>
                                    <input type="checkbox" id="checkKumamonDesignated" onchange="toggleKumamonDesignated()">
                                </div>
                                <button onclick="toggleKumamonDetails()" style="border:none; background:none; color:#007AFF; font-size:11px; cursor:pointer; padding:2px 0 6px 0;">ğŸ”½ é»æ“ŠæŸ¥çœ‹æŒ‡å®šé€šè·¯ (ç†Šå¥½ç³»åˆ—)</button>
                                <div id="kumamonDetails" class="details-content">
                                    <b>(1) ç†Šå¥½éŠ (äº¤é€š/ä½å®¿)ï¼š</b><br>äº¤é€šICå¡ï¼šSUICAã€PASMOã€ICOCA<br>è‡ªé§•ç§Ÿè»Šï¼šTOYOTA Rent a Carã€Times Car Rentalã€NIPPON RENT-A-CARã€OTSç§Ÿè»Šã€ORIXç§Ÿè»Š<br>éµè·¯/èˆªç©ºï¼šJRéµè·¯å…¬å¸ã€æ—¥æœ¬èˆªç©º<br>ä½å®¿ï¼šæ¨‚å¤©æ—…éŠã€æ±æ©«INNã€æ˜Ÿé‡é›†åœ˜<br>
                                    <b>(2) ç†Šå¥½ç© (æ¨‚åœ’)ï¼š</b><br>æ±äº¬è¿ªå£«å°¼ã€è¯ç´å…„å¼Ÿå“ˆåˆ©æ³¢ç‰¹å½±åŸã€æ—¥æœ¬ç’°çƒå½±åŸã€è±ªæ–¯ç™»å ¡ã€ä¹å·éæ´²ç…æ¨‚åœ’ã€åå¤å±‹æ¨‚é«˜æ¨‚åœ’ã€å‰ä¼Šå¡å“‡æ¨‚åœ’<br>
                                    <b>(3) ç†Šå¥½åƒ (é¤é£²)ï¼š</b><br>ç‡’è‚‰ï¼šå‹çƒˆäº­ã€æ•˜æ•˜è‹‘ã€ç‰›è§’ã€åŠ›ä¸¸ç‡’è‚‰ã€å…­æ­Œä»™<br>æ¼¢å ¡/å’–å•¡ï¼šshake shackã€DOUTOR Coffeeã€Fuglen<br>å…¶ä»–ï¼šé³¥è²´æ—ã€ä¸€è˜­æ‹‰éºµã€æ¾å±‹ã€SUKIYAã€å£½å¸éƒã€è—å£½å¸<br>
                                    <b>(4) ç†Šå¥½è²· (è³¼ç‰©)ï¼š</b><br>å®¶é›»/è—¥å¦ï¼šBicCameraã€Yodobashiã€æ¾æœ¬æ¸…ã€å”å‰è»»å¾·ã€å¤§åœ‹è—¥å¦<br>ç”Ÿæ´»/å•†åŸï¼šç„¡å°è‰¯å“ã€æ—¥æœ¬MITSUIè³¼ç‰©åœ’å€<br>æœé£¾ï¼šUNIQLOã€GU
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- PayPay ç¨ç«‹å€å¡Šï¼ˆèˆ‡æ—¥æœ¬æ¶ˆè²»äº’æ–¥ï¼‰ -->
                    <div id="kumamonPayPaySection" style="border-top:1px dashed #ddd; padding-top:8px; margin-top:8px;">
                        <div class="option-row" style="flex-direction:column; align-items:flex-start;">
                            <div style="display:flex; justify-content:space-between; width:100%; align-items:center;">
                                <label for="checkKumamonPayPay">ğŸ“± æ—¥æœ¬ PayPay 5% (å­£åˆ·$2,857å°é ‚)</label>
                                <input type="checkbox" id="checkKumamonPayPay" onchange="toggleKumamonPayPay()">
                            </div>
                            <div style="font-size:10px; color:#888; margin-top:2px;">å« 3.5% å›é¥‹ + å… 1.5% æµ·å¤–äº¤æ˜“æ‰‹çºŒè²»</div>
                        </div>
                    </div>
                </div>
                
                <div id="sinopacCurrencyOptions">
                    <div class="option-row" style="background:#eee; padding:8px; border-radius:6px; margin-bottom:8px; flex-direction:column; align-items:flex-start;">
                          <label style="margin-bottom:4px; color:#555;">ğŸ’° é¸æ“‡è³‡æ ¼ç­‰ç´š (è‡ªå‹•è¨˜æ†¶)</label>
                          <div style="display:flex; gap:10px; width:100%;">
                              <label style="font-weight:normal; font-size:12px; display:flex; align-items:center;"><input type="radio" name="currencyLevel" value="low" onchange="saveCurrencyLevel()" checked> å¤§å¤§ç­‰ç´š (Level 1)</label>
                              <label style="font-weight:normal; font-size:12px; display:flex; align-items:center;"><input type="radio" name="currencyLevel" value="high" onchange="saveCurrencyLevel()"> å¤§æˆ¶ç­‰ç´š (Level 2)</label>
                          </div>
                          <div style="font-size:10px; color:#999; margin-top:2px;">å¤§å¤§: è‡ªå‹•æ‰£ç¹³+é›»å­å¸³å–® | å¤§æˆ¶: å¾€ä¾†è³‡ç”¢â‰¥10è¬</div>
                    </div>
                    
                    <div class="option-row read-only"><label id="labelCurrencyBase">ğŸ”° åœ‹å…§ä¸€èˆ¬ 1%</label><input type="checkbox" checked disabled></div>

                    <div class="option-row"><label>ğŸ‡¹ğŸ‡¼ åœ‹å…§æ¶ˆè²»</label><input type="radio" name="currencyType" value="domestic" checked onchange="toggleCurrencyLogic()"></div>

                    <div class="option-row" style="border-top:1px dashed #ddd; padding-top:6px; flex-direction:column; align-items:flex-start;">
                        <div style="display:flex; justify-content:space-between; width:100%; align-items:center;">
                            <label for="rbCurrencySelected">âœˆï¸ æµ·å¤–/ç²¾é¸ +4% (è¦‹ç­‰ç´šå°é ‚)</label>
                            <input type="radio" name="currencyType" id="rbCurrencySelected" value="selected" onchange="toggleCurrencyLogic()">
                        </div>

                        <button onclick="toggleCurrencyDetails()" style="border:none; background:none; color:#007AFF; font-size:11px; cursor:pointer; padding:0 0 6px 0;">ğŸ”½ é»æ“ŠæŸ¥çœ‹ç²¾é¸é€šè·¯</button>
                        <div id="currencyDetails" class="details-content">
                            <b>(1) åœ‹å¤–å¯¦é«”ï¼š</b><br>éå°ç£åœ°å€ä¸”éå°å¹£ä¹‹ä¸€èˆ¬äº¤æ˜“<br>
                            <b>(2) ç¶²è³¼æ¶ˆè²»ï¼š</b><br>Suica/PASMO/ICOCAå„²å€¼ã€Amazonã€Rakutenã€æ·˜å¯¶ã€eBayã€Gmarketã€iHerbã€Selfridgeã€Mercariã€å¤§åœ‹è—¥å¦ã€Sugiè—¥å¦ã€Olive Young<br>
                            <b>(3) æ—…éŠé€šè·¯ï¼š</b><br>èˆªç©ºå…¬å¸ã€æ—…è¡Œç¤¾ã€Booking.comã€Agodaã€Hotels.comã€Expediaã€Trip.comã€Airbnbã€Klookã€KKdayã€Trivagoã€AsiaYoã€æ­ç‰¹å„€æ¾å±±æ©Ÿå ´åœè»Š<br>
                        </div>
                    </div>
                </div>

                <div id="sinopacMitsuiOptions">
                    <div class="option-row read-only"><label id="labelMitsuiBase">ğŸ”° ä¸€èˆ¬æ¶ˆè²» 0.3% (é¤¨å¤–/åœ‹å¤–)</label><input type="checkbox" checked disabled></div>
                    
                    <div class="option-row" style="border-top:1px dashed #ddd; padding-top:6px; display:flex; flex-direction:column; align-items:flex-start;">
                        <div style="display:flex; justify-content:space-between; width:100%; align-items:center;">
                            <label for="checkSinopacMitsuiSelected">ğŸ½ï¸ ç‰¹é¸é¤é£² +7% (å…±7.3%)</label>
                            <input type="checkbox" id="checkSinopacMitsuiSelected" onchange="toggleSinopacMitsui('selected')">
                        </div>

                        <div style="font-size:10px; color:#aaa; margin-top:2px; line-height:1.3;">
                            é€šè·¯ï¼šé¤¨å¤–é¤é£²(MCC 58xx) / å…¨ç›ˆ+PAY<br>
                            <span style="color:#d32f2f; font-weight:bold;">âš ï¸ ä¸Šé™åƒ… 100 å…ƒ (ç´„åˆ· $1,428)</span>
                        </div>
                    </div>
                    
                    <div class="option-row" style="background:#fff3e0; padding:8px; border-radius:6px; margin-top:6px;"><label for="checkSinopacMitsuiTarget">ğŸ‡¯ğŸ‡µ æ—¥éŸ“æ³°å¯¦é«” (æ»¿3è¬é€2000/éœ€ç™»éŒ„)</label><input type="checkbox" id="checkSinopacMitsuiTarget" onchange="toggleSinopacMitsui('target')"></div>
                </div>

                <div id="sinopacJcbOptions">
                    <div class="option-row read-only"><label id="labelJcbBase">ğŸ”° åœ‹å…§æ¶ˆè²» 1%</label><input type="checkbox" checked disabled></div>
                    
                    <div class="option-row"><label for="checkSinopacJcbForeign">âœˆï¸ åœ‹å¤–æ¶ˆè²» (1% â†’ 2%)</label><input type="checkbox" id="checkSinopacJcbForeign" onchange="updateRewardPreview()"></div>
                    
                    <div class="option-row" style="flex-direction:column; align-items:flex-start; gap:0; border-top:1px dashed #ddd; padding-top:6px;">
                        <div style="display:flex; justify-content:space-between; width:100%; align-items:center;">
                             <label for="checkSinopacJcbBonus">ğŸ‡¯ğŸ‡µ æ—¥æœ¬ / ğŸ›ï¸ ç‰¹é¸ +3% (æœˆåˆ·1è¬å°é ‚)</label>
                             <input type="checkbox" id="checkSinopacJcbBonus" onchange="updateRewardPreview()">
                        </div>
                        <button onclick="toggleSinopacJcbDetails()" style="border:none; background:none; color:#007AFF; font-size:11px; cursor:pointer; padding:2px 0 6px 0;">ğŸ”½ é»æ“ŠæŸ¥çœ‹é€šè·¯ (ç¶²è³¼/ç™¾è²¨/é¤å»³)</button>
                        <div id="sinopacJcbDetails" class="details-content">
                            <b>(1) ç¶²è³¼ï¼š</b><br>è¦çš®ã€momoã€PChomeã€Yahooã€æ±æ£®ã€åšå®¢ä¾†...<br>
                            <b>(2) ç™¾è²¨ï¼š</b><br>æ¼¢ç¥ã€é æ±ã€SOGOã€101...<br>
                            <b>(3) é¤å»³ï¼š</b><br>ç‹å“é›†åœ˜ã€é¼æ³°è±...<br>
                        </div>
                    </div>
                    
                    <div class="option-row" style="background:#fff3e0; padding:8px; border-radius:6px; margin-top:6px; flex-direction:column; align-items:flex-start;">
                          <div style="display:flex; justify-content:space-between; width:100%; align-items:center;">
                             <label for="checkSinopacJcbQuarterly">ğŸ”¥ æ—¥éŸ“æ³°æ»¿é¡ +5% (å­£/å…±ç”¨ä¸Šé™)</label>
                             <input type="checkbox" id="checkSinopacJcbQuarterly" onchange="updateRewardPreview()">
                            </div>
                            <div style="font-size:10px; color:#d32f2f; margin-top:2px;">éœ€ç™»éŒ„ï¼Œæ»¿2è¬é€1000 (ä¸Šé™1000)</div>
                    </div>
                </div>
                
                <div class="input-group" style="margin-top:15px; border-top:1px solid #eee; padding-top:15px;">
                    <label style="margin-bottom:4px;">ğŸ“… æ¶ˆè²»æ—¥æœŸ</label>
                    <input type="date" id="dateInput" style="font-size:16px; padding:8px; text-align:left;">
                </div>

                <div class="input-group" style="margin-top:10px;">
                    <input type="number" id="amountInput" placeholder="$ é‡‘é¡" inputmode="numeric" style="font-size:28px; text-align:center; border:none; border-bottom:2px solid #eee; border-radius:0;" oninput="updateRewardPreview()" onkeyup="updateRewardPreview()" onpaste="updateRewardPreview()">
                    <div id="twdConversionDisplay" style="text-align:center; font-size:14px; color:#666; margin-top:6px; display:none;">
                        â‰ˆ TWD <span id="twdAmount">0</span>
                    </div>
                    <div id="thresholdWarning" class="threshold-warning">âš ï¸ æœªæ»¿ $100ï¼Œåƒ…äº« 1% å›é¥‹</div>
                    <div id="liveRewardCalc"></div>
                </div>
                
                <div class="input-group"><input type="text" id="noteInput" placeholder="å‚™è¨» (ä¾‹å¦‚: åˆé¤)"></div>
                <div class="btn-group">
                    <button class="btn btn-cancel" onclick="document.getElementById('transactionModal').style.display='none'">å–æ¶ˆ</button>
                    <button class="btn btn-again" onclick="addTransaction(false)">ğŸ”„ å†è¨˜ä¸€ç­†</button>
                    <button class="btn btn-confirm" id="btn-confirm" onclick="addTransaction(true)">ç¢ºèª</button>
                </div>
            </div>
            <div class="modal-history-section">
               <div class="modal-history-title" id="modalHistoryTitle">
                    <div style="display:flex; align-items:center; gap:6px;">
                        <span onclick="shiftHistoryMonth(-1)" style="cursor:pointer; font-size:16px; padding:2px 6px;">â—€</span>
                        <span id="historyMonthLabel">ğŸ“… æœ¬æœŸæ¶ˆè²»ç´€éŒ„</span>
                        <span id="historyNextBtn" onclick="shiftHistoryMonth(1)" style="cursor:pointer; font-size:16px; padding:2px 6px; visibility:hidden;">â–¶</span>
                    </div>
                    <span style="font-weight:normal; font-size:10px; color:#aaa;">(é»æ“Šä¿®æ”¹ / âœ• åˆªé™¤)</span>
                </div>
                <div id="modalHistoryList" style="max-height:40vh; overflow-y:auto;"></div>
            </div>
        </div>
    </div>
    
    <div id="manageModal" class="modal" onclick="if(event.target===this) document.getElementById('manageModal').style.display='none'">
        <div class="modal-content" style="max-height:80vh; overflow-y:auto; padding-top:15px;">
            <h2 style="margin: 0 0 4px 0; font-size: 18px; font-weight: 800; color:#333;">ç®¡ç†æˆ‘çš„å¡ç‰‡</h2>
            
            <div class="manage-tools">
                 <div class="tools-header">
                     <div style="font-size:12px; color:#888;">æƒ…å¢ƒå¿«ç…§èˆ‡å·¥å…·</div>
                     <div style="display:flex; gap:8px;">
                         <button class="btn-tool-small" onclick="clearVisibleCards()">ğŸ§¹ ä¸€éµæ¸…ç©º</button>
                         <button class="btn-tool-small" style="background:#007AFF; color:white; border:none;" onclick="saveCurrentScene()">ğŸ’¾ å­˜æˆæƒ…å¢ƒ</button>
                     </div>
                 </div>
                 <div id="sceneList" class="scene-container"></div>
            </div>
            
            <div class="manage-search-container">
                 <div class="manage-search-wrapper">
                     <input type="text" id="cardSearchInput" class="manage-search-input" placeholder="æœå°‹å¡ç‰‡ (å¦‚: å‰é¶´, æ—…äºº...)" oninput="filterManageCards()">
                     <button id="btnSearchClear" class="btn-search-clear" onclick="clearCardSearch()">âœ•</button>
                </div>
            </div>
        
            <div style="font-size:12px; color:#888; margin-bottom:12px;">é»æ“Šå¡ç‰‡å³å¯ å•Ÿç”¨ / éš±è—</div>
            
            <div id="manageCardList" class="manage-grid"></div>
            
            <div id="customCardSection" style="margin-top:12px; border-top:2px solid #f0f0f0; padding-top:12px;">
                <div style="font-size:12px; color:#888; margin-bottom:8px;">è‡ªå»ºå¡ç‰‡ (<span id="customCardCount">0</span>/2)</div>
                <button id="btnAddCustomCard" class="btn" style="width:100%; background:#f0f8ff; color:#007AFF; border:1px dashed #007AFF; font-size:14px;" onclick="openCustomCardModal()">ï¼‹ è‡ªå»ºå¡ç‰‡</button>
            </div>

            <button class="btn btn-confirm" style="width:100%; margin-top:10px;" onclick="document.getElementById('manageModal').style.display='none'">å®Œæˆ</button>
        </div>
    </div>

    <!-- å¡ç‰‡è¨­å®šå½ˆçª— (æš±ç¨± + çµå¸³æ—¥) -->
    <div id="cardSettingsModal" class="modal" onclick="if(event.target===this) document.getElementById('cardSettingsModal').style.display='none'">
        <div class="modal-content">
             <h2 id="settingsModalTitle" style="margin: 0 0 12px 0; font-size: 18px; font-weight: 800; color:#333;">å¡ç‰‡è¨­å®š</h2>
             
             <div class="input-group">
                 <label>ğŸ·ï¸ å¡ç‰‡æš±ç¨±</label>
                 <input type="text" id="settingNicknameInput" placeholder="è‡ªè¨‚åç¨± (ä¾‹å¦‚: è²·èœå¡)">
             </div>
             
             <div class="input-group">
                 <label>ğŸ“… çµå¸³æ—¥ (æ¯æœˆå¹¾è™Ÿçµç®—)</label>
                 <select id="settingCycleDayInput" style="width: 100%; padding: 10px; border: 2px solid #f0f0f0; background: #fff; border-radius: 12px; font-size: 16px; outline: none; font-weight: 600; color: #333;">
                     <option value="">é è¨­ (æŒ‰è‡ªç„¶æœˆ)</option>
                     <!-- 1~31 -->
                 </select>
                 <div style="font-size:11px; color:#888; margin-top:6px;">è¨­å®šå¾Œï¼Œè‹¥æ¶ˆè²»æ—¥è¶…éçµå¸³æ—¥ï¼Œå°‡è‡ªå‹•æ­¸å…¥ä¸‹æœŸå¸³å–®ã€‚</div>
             </div>
             
             <input type="hidden" id="settingCardId">

             <div class="btn-group">
                 <button class="btn btn-cancel" onclick="document.getElementById('cardSettingsModal').style.display='none'">å–æ¶ˆ</button>
                 <button class="btn btn-confirm" onclick="saveCardSetting()">å„²å­˜</button>
             </div>
        </div>
    </div>
    
   <!-- è‡ªå»ºå¡ç‰‡ Modal -->
    <div id="customCardModal" class="modal" onclick="if(event.target===this) document.getElementById('customCardModal').style.display='none'">
        <div class="modal-content">
             <h2 id="customCardTitle" style="margin: 0 0 12px 0; font-size: 18px; font-weight: 800; color:#333;">è‡ªå»ºå¡ç‰‡</h2>
             
             <div class="input-group">
                 <label>ğŸ’³ å¡ç‰‡åç¨± (å¿…å¡«)</label>
                 <input type="text" id="customCardName" placeholder="ä¾‹å¦‚ï¼šåœ‹æ³° CUBE å¡" maxlength="20">
             </div>
             
             <div class="input-group">
                 <label>ğŸ·ï¸ æš±ç¨± (é¸å¡«)</label>
                 <input type="text" id="customCardNickname" placeholder="ä¾‹å¦‚ï¼šç¹³è²»å°ˆç”¨" maxlength="10">
             </div>

             <div class="input-group">
                 <label>ğŸ“Š å›é¥‹ç‡ % (å¿…å¡«)</label>
                 <input type="number" id="customCardRate" placeholder="ä¾‹å¦‚ï¼š3" step="0.1" min="0" max="100" style="font-size:16px;">
             </div>

             <div class="input-group">
                 <label>ğŸ å›é¥‹å–®ä½</label>
                 <div style="display:flex; gap:10px; margin-top:4px;">
                     <label style="font-size:14px; display:flex; align-items:center; gap:4px;"><input type="radio" name="customCardUnit" value="cash" checked style="width:18px; height:18px;"> ç¾é‡‘å›é¥‹</label>
                     <label style="font-size:14px; display:flex; align-items:center; gap:4px;"><input type="radio" name="customCardUnit" value="miles" style="width:18px; height:18px;"> å“©ç¨‹</label>
                 </div>
             </div>
             
             <div class="input-group">
                 <label>ğŸ”’ æ¯æœŸå°é ‚æ¶ˆè²»é‡‘é¡ (é¸å¡«ï¼Œç©º=ç„¡ä¸Šé™)</label>
                 <input type="number" id="customCardCap" placeholder="ä¾‹å¦‚ï¼š10000" style="font-size:16px;">
             </div>

             <div class="input-group">
                 <label>ğŸ“… çµå¸³æ—¥ (é¸å¡«)</label>
                 <select id="customCardCycleDay" style="width:100%; padding:10px; border:2px solid #f0f0f0; background:#fff; border-radius:12px; font-size:16px; outline:none; font-weight:600; color:#333;">
                     <option value="">é è¨­ (æŒ‰è‡ªç„¶æœˆ)</option>
                 </select>
             </div>

             <div class="input-group">
                 <label>ğŸ¨ å¡é¢é¡è‰²</label>
                 <div id="customColorPicker" style="display:flex; flex-wrap:wrap; gap:8px; margin-top:6px;"></div>
             </div>
             
             <input type="hidden" id="customCardEditId" value="">

           <div class="btn-group">
                 <button class="btn btn-cancel" onclick="document.getElementById('customCardModal').style.display='none'">å–æ¶ˆ</button>
                 <button class="btn btn-confirm" onclick="saveCustomCard()">å„²å­˜</button>
             </div>
             <div id="customCardDeleteArea" style="display:none; margin-top:10px; text-align:center;">
                 <button onclick="deleteCustomCard(document.getElementById('customCardEditId').value)" style="background:none; border:none; color:#FF3B30; font-size:13px; cursor:pointer; padding:8px;">ğŸ—‘ï¸ åˆªé™¤æ­¤å¡ç‰‡</button>
             </div>
        </div>
    </div>

   <!-- ç·¨è¼¯æƒ…å¢ƒ Modal -->
    <div id="sceneEditModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:10001; justify-content:center; align-items:center;">
        <div style="background:#fff; border-radius:16px; width:90%; max-width:400px; max-height:85vh; overflow-y:auto; padding:20px;">
            <h3 id="sceneEditTitle" style="margin:0 0 16px 0; font-size:18px;">æ–°å¢æƒ…å¢ƒ</h3>
            
            <div style="margin-bottom:16px;">
                <label style="font-size:13px; color:#555; display:block; margin-bottom:6px;">æƒ…å¢ƒåç¨±</label>
                <input type="text" id="sceneNameInput" placeholder="ä¾‹å¦‚ï¼šğŸ‡¯ğŸ‡µ æ—¥æœ¬æ—…éŠ" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:8px; font-size:15px; box-sizing:border-box;">
            </div>
            
            <div style="margin-bottom:16px;">
                <label style="font-size:13px; color:#555; display:block; margin-bottom:6px;">åˆ‡æ›åœ‹å®¶æ™‚è‡ªå‹•å¥—ç”¨ï¼ˆå¯å¤šé¸ï¼‰</label>
                <div id="sceneLocationOptions">
                    <div style="display:flex; gap:8px; margin-bottom:8px;">
                        <label style="flex:1; padding:12px; border:1px solid #ddd; border-radius:8px; cursor:pointer; text-align:center;"><input type="checkbox" name="sceneLocation" value="TW" onchange="checkSceneLocationConflict()" style="margin-right:6px;">ğŸ‡¹ğŸ‡¼å°ç£</label>
                        <label style="flex:1; padding:12px; border:1px solid #ddd; border-radius:8px; cursor:pointer; text-align:center;"><input type="checkbox" name="sceneLocation" value="JP" onchange="checkSceneLocationConflict()" style="margin-right:6px;">ğŸ‡¯ğŸ‡µæ—¥æœ¬</label>
                    </div>
                    <div style="display:flex; gap:8px;">
                        <label style="flex:1; padding:12px; border:1px solid #ddd; border-radius:8px; cursor:pointer; text-align:center;"><input type="checkbox" name="sceneLocation" value="KR" onchange="checkSceneLocationConflict()" style="margin-right:6px;">ğŸ‡°ğŸ‡·éŸ“åœ‹</label>
                        <label style="flex:1; padding:12px; border:1px solid #ddd; border-radius:8px; cursor:pointer; text-align:center;"><input type="checkbox" name="sceneLocation" value="TH" onchange="checkSceneLocationConflict()" style="margin-right:6px;">ğŸ‡¹ğŸ‡­æ³°åœ‹</label>
                    </div>
                </div>
                <div id="sceneLocationWarning" style="display:none; margin-top:8px; padding:8px; background:#fff3e0; border-radius:6px; font-size:11px; color:#e65100;"></div>
            </div>
            
            <div style="margin-bottom:16px;">
                <label style="font-size:13px; color:#555; display:block; margin-bottom:6px;">é¸æ“‡å¡ç‰‡</label>
               <div id="sceneCardOptions" style="display:grid; grid-template-columns:1fr 1fr; gap:8px; max-height:250px; overflow-y:auto;"></div>
            </div>
            
            <div style="display:flex; gap:10px; margin-top:20px;">
                <button onclick="closeSceneEditModal()" style="flex:1; padding:12px; border:1px solid #ddd; background:#fff; border-radius:8px; font-size:15px; cursor:pointer;">å–æ¶ˆ</button>
                <button onclick="saveSceneEdit()" style="flex:1; padding:12px; border:none; background:#007AFF; color:#fff; border-radius:8px; font-size:15px; cursor:pointer;">å„²å­˜</button>
            </div>
        </div>
    </div>
    
    <script>
    // ==========================================
    // Part 3: æ ¸å¿ƒè¨­å®šã€åŒ¯ç‡èˆ‡ UI é‚è¼¯ (V126.1)
    // ==========================================
    
    const LOCATION_CONFIG = {
        'TW': { flag: 'ğŸ‡¹ğŸ‡¼', name: 'æˆ‘åœ¨å°ç£', currency: 'TWD', rate: 1 },
        'JP': { flag: 'ğŸ‡¯ğŸ‡µ', name: 'æˆ‘åœ¨æ—¥æœ¬', currency: 'JPY', rate: null },
        'KR': { flag: 'ğŸ‡°ğŸ‡·', name: 'æˆ‘åœ¨éŸ“åœ‹', currency: 'KRW', rate: null },
        'US': { flag: 'ğŸ‡ºğŸ‡¸', name: 'æˆ‘åœ¨ç¾åœ‹', currency: 'USD', rate: null },
        'TH': { flag: 'ğŸ‡¹ğŸ‡­', name: 'æˆ‘åœ¨æ³°åœ‹', currency: 'THB', rate: null }
    };

    let currentLocation = localStorage.getItem('current_location') || 'TW';
    let exchangeRates = JSON.parse(localStorage.getItem('exchange_rates') || '{}');
    let lastRateUpdate = localStorage.getItem('last_rate_update') || '';

    async function fetchExchangeRates() {
        const today = new Date().toISOString().split('T')[0];
        if (lastRateUpdate === today && Object.keys(exchangeRates).length > 0) return;
        try {
            const response = await fetch('https://api.exchangerate-api.com/v4/latest/TWD');
            const data = await response.json();
            exchangeRates = {
                JPY: 1 / data.rates.JPY,
                KRW: 1 / data.rates.KRW,
                USD: 1 / data.rates.USD,
                THB: 1 / data.rates.THB
            };
            localStorage.setItem('exchange_rates', JSON.stringify(exchangeRates));
            localStorage.setItem('last_rate_update', today);
        } catch (error) {
            if (Object.keys(exchangeRates).length === 0) exchangeRates = { JPY: 0.22, KRW: 0.024, USD: 32.5, THB: 0.92 };
        }
    }
    
    // å¼·åˆ¶é‡æ–°æŠ“å–åŒ¯ç‡
    async function refreshExchangeRates() {
        const btn = document.getElementById('refreshRateBtn');
        const rateInput = document.getElementById('exchangeRateInput');
        
        // é¡¯ç¤ºè¼‰å…¥ä¸­
        btn.innerText = 'â³';
        btn.disabled = true;
        
        try {
            const response = await fetch('https://api.exchangerate-api.com/v4/latest/TWD');
            const data = await response.json();
            const today = new Date().toISOString().split('T')[0];
            
            exchangeRates = {
                JPY: 1 / data.rates.JPY,
                KRW: 1 / data.rates.KRW,
                USD: 1 / data.rates.USD,
                THB: 1 / data.rates.THB
            };
            localStorage.setItem('exchange_rates', JSON.stringify(exchangeRates));
            localStorage.setItem('last_rate_update', today);
            
            // æ›´æ–°é¡¯ç¤ºçš„åŒ¯ç‡
            if (currentLocation !== 'TW') {
                const currencySymbol = LOCATION_CONFIG[currentLocation].currency;
                rateInput.value = parseFloat(exchangeRates[currencySymbol] || 1).toFixed(4);
            }
            
            // æˆåŠŸæç¤º
            btn.innerText = 'âœ…';
            setTimeout(() => { btn.innerText = 'ğŸ”„'; }, 1500);
            
        } catch (error) {
            // å¤±æ•—æç¤º
            btn.innerText = 'âŒ';
            setTimeout(() => { btn.innerText = 'ğŸ”„'; }, 1500);
            alert('åŒ¯ç‡æ›´æ–°å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
        }
        
        btn.disabled = false;
    }

    function openLocationModal() {
        document.getElementById('locationModal').style.display = 'flex';
        const options = document.querySelectorAll('.location-option');
        options.forEach(opt => opt.classList.remove('active'));
        const currentOpt = Array.from(options).find(opt => opt.querySelector('.location-flag').innerText === LOCATION_CONFIG[currentLocation].flag);
        if (currentOpt) currentOpt.classList.add('active');
    }

    function selectLocation(code, flag, name, currency, rate) {
        currentLocation = code;
        localStorage.setItem('current_location', code);
        document.getElementById('currentLocationFlag').innerText = flag;
        document.getElementById('currentLocationName').innerText = name;
        document.getElementById('locationModal').style.display = 'none';
        
        const rateRow = document.getElementById('exchangeRateRow');
        const rateInput = document.getElementById('exchangeRateInput');
        const currencySymbol = LOCATION_CONFIG[code].currency;
        
        if (code !== 'TW') {
            rateRow.style.display = 'flex';
            document.getElementById('currencySymbolInRate').innerText = currencySymbol;
            let rateVal = exchangeRates[currencySymbol] || 1;
            rateInput.value = parseFloat(rateVal).toFixed(4);
        } else {
            rateRow.style.display = 'none';
        }
        
        updateAmountPlaceholder();
        
        // â˜… è‡ªå‹•è¼‰å…¥è©²åœ‹å®¶ç¶å®šçš„æƒ…å¢ƒ
        const scenes = getScenes();
        const linkedScene = scenes.find(s => s.linkedLocations && s.linkedLocations.includes(code));
        if (linkedScene) {
            visibleCards = [...linkedScene.cards];
            if (!visibleCards.includes('add1') && visibleCards.length < 8) {
                visibleCards.push('add1');
            }
            localStorage.setItem('visibleCards', JSON.stringify(visibleCards));
        }
        
        renderGrid();
        
        // â˜… é€£å‹•å‰é¶´å¡ï¼šæ ¹æ“šåœ°é»è‡ªå‹•åˆ‡æ›æ¨¡å¼
        if (document.getElementById('jiheOptions')?.style.display !== 'none') {
            updateJiheByLocation();
        }
        
       // â˜… é€£å‹•å¯Œé‚¦Jå¡ï¼šæ ¹æ“šåœ°é»è‡ªå‹•åˆ‡æ›æ¨¡å¼
        if (document.getElementById('fubonJOptions')?.style.display !== 'none') {
            updateFubonJByLocation();
        }
        
        // â˜… é€£å‹•ç†Šæœ¬ç†Šå¡ï¼šæ ¹æ“šåœ°é»è‡ªå‹•åˆ‡æ›æ¨¡å¼
        if (document.getElementById('kumamonOptions')?.style.display !== 'none') {
            updateKumamonByLocation();
        }
    }
    function updateAmountPlaceholder() {
        const config = LOCATION_CONFIG[currentLocation];
        const input = document.getElementById('amountInput');
        if (input) input.placeholder = `${config.currency} é‡‘é¡`;
    }

    function getCurrentRate() {
        if (currentLocation === 'TW') return 1;
        const inputVal = parseFloat(document.getElementById('exchangeRateInput').value);
        if(inputVal) return inputVal;
        return exchangeRates[LOCATION_CONFIG[currentLocation].currency] || 1;
    }

    function updateTWDPreview() {
        const amount = parseFloat(document.getElementById('amountInput').value);
        const twdDisplay = document.getElementById('twdConversionDisplay');
        const twdAmount = document.getElementById('twdAmount');
        
        if (currentLocation === 'TW' || !amount || amount <= 0) { 
            twdDisplay.style.display = 'none'; 
            return; 
        }
        
        const rate = getCurrentRate();
        twdAmount.innerText = Math.round(amount * rate).toLocaleString();
        twdDisplay.style.display = 'block';
    }

    function toggleExchangeRateEdit() {
        const input = document.getElementById('exchangeRateInput');
        input.readOnly = !input.readOnly;
        if (!input.readOnly) { input.focus(); input.select(); }
    }

    function injectDetails() {
        const petDiv = document.getElementById('happyPetDetails');
        if(petDiv && petDiv.innerHTML.trim() === "") {
            petDiv.innerHTML = `<b>(1) æŒ‡å®šå¯µç‰©é€£é–ï¼š</b><br>å¯µç‰©å…¬åœ’ã€æ±æ£®å¯µç‰©ã€é­šä¸­é­šã€è²“ç‹—éšŠé•·ã€æ¯›å­©å¸‚é›†ã€é‡‘å‰åˆ©...<br><b>(2) 2026 æ–°å¢ï¼š</b><br>æ±ªå–µæ˜Ÿçƒã€æ€ªç¸éƒ¨è½ã€è¶…å‡å°å§...`;
        }
        
        // å¡«å……çµå¸³æ—¥é¸å–®
        const select = document.getElementById('settingCycleDayInput');
        if (select && select.options.length <= 1) {
            for(let i=1; i<=31; i++) {
                const opt = document.createElement('option');
                opt.value = i;
                opt.text = `æ¯æœˆ ${i} è™Ÿ`;
                select.add(opt);
            }
        }
    }

    // Toggle Functions
    function toggleGreenDetails() { const el = document.getElementById('greenDetails'); el.style.display = (el.style.display === 'block') ? 'none' : 'block'; }
    function toggleParkingDetails() { const el = document.getElementById('greenParkingDetails'); el.style.display = (el.style.display === 'block') ? 'none' : 'block'; }
    function toggleJiheDetails() { const el = document.getElementById('jiheDetails'); el.style.display = (el.style.display === 'block') ? 'none' : 'block'; }
    function toggleKumamonDetails() { const el = document.getElementById('kumamonDetails'); el.style.display = (el.style.display === 'block') ? 'none' : 'block'; }
    function toggleDbsDetails() { const el = document.getElementById('dbsDetails'); el.style.display = (el.style.display === 'block') ? 'none' : 'block'; }
    function toggleJiangDetails() { const el = document.getElementById('jiangDetails'); el.style.display = (el.style.display === 'block') ? 'none' : 'block'; }
    function toggleJiangTravelDetails() { const el = document.getElementById('jiangTravelDetails'); el.style.display = (el.style.display === 'block') ? 'none' : 'block'; }
    function toggleCurrencyDetails() { const el = document.getElementById('currencyDetails'); el.style.display = (el.style.display === 'block') ? 'none' : 'block'; }
    function togglePigRichNewUser() { const el = document.getElementById('pigRichNewUserDetails'); el.style.display = (el.style.display === 'block') ? 'none' : 'block'; }
    function togglePigRichSelected() { const el = document.getElementById('pigRichSelectedDetails'); el.style.display = (el.style.display === 'block') ? 'none' : 'block'; }
    function toggleHappyPetDetails() { const el = document.getElementById('happyPetDetails'); el.style.display = (el.style.display === 'block') ? 'none' : 'block'; }
    function toggleHappyPeaceDetails() { const el = document.getElementById('happyPeaceDetails'); el.style.display = (el.style.display === 'block') ? 'none' : 'block'; }
    function toggleHappyLifeDetails() { const el = document.getElementById('happyLifeDetails'); el.style.display = (el.style.display === 'block') ? 'none' : 'block'; }
    function toggleSinopacJcbDetails() { const el = document.getElementById('sinopacJcbDetails'); el.style.display = (el.style.display === 'block') ? 'none' : 'block'; }
    function toggleLaiDianDetails() { const el = document.getElementById('laiDianDetails'); el.style.display = (el.style.display === 'block') ? 'none' : 'block'; }
    function toggleLegendDetails() { const el = document.getElementById('legendDetails'); el.style.display = (el.style.display === 'block') ? 'none' : 'block'; }

    // UniOpen å“ç‰Œåˆ—è¡¨å±•é–‹/æ”¶åˆ
    function toggleUniBrandList() {
        const container = document.getElementById('uniBrandContainer');
        const btn = document.getElementById('btnToggleUniBrand');
        if (container.style.display === 'none') {
            container.style.display = 'block';
            btn.innerText = 'æ”¶åˆå“ç‰Œ â–²';
        } else {
            container.style.display = 'none';
            btn.innerText = 'å±•é–‹å“ç‰Œ â–¼';
        }
    }

    // UniOpen å“ç‰Œåˆ†é¡æŠ˜ç–Š
    function toggleBrandCategory(catId) {
        const content = document.getElementById('content-' + catId);
        const arrow = document.getElementById('arrow-' + catId);
        const header = arrow.parentElement;
        
        if (content.classList.contains('collapsed')) {
            content.classList.remove('collapsed');
            header.classList.remove('collapsed');
            arrow.innerText = 'â–¼';
        } else {
            content.classList.add('collapsed');
            header.classList.add('collapsed');
            arrow.innerText = 'â–¶';
        }
    }

    function toggleSelectedLogic() {
        if(document.getElementById('checkBonus25').checked) {
            document.getElementById('checkIsBill').checked = false;
            document.getElementById('labelBaseRate').innerText = "ğŸ”° åŸºæœ¬å›é¥‹ 1% (ç„¡ä¸Šé™)";
        }
        updateRewardPreview();
    }
    function toggleBillLogic() {
        if(document.getElementById('checkIsBill').checked) {
            document.getElementById('checkBonus25').checked = false;
            document.getElementById('labelBaseRate').innerText = "ğŸ”° åŸºæœ¬å›é¥‹ 0.15% (ç„¡ä¸Šé™)";
        } else {
            document.getElementById('labelBaseRate').innerText = "ğŸ”° åŸºæœ¬å›é¥‹ 1% (ç„¡ä¸Šé™)";
        }
        updateRewardPreview();
    }

    function openShareModal() {
       document.getElementById('shareCardMonth').innerText = `${new Date().getMonth() + 1} æœˆå›é¥‹æˆ°ç¸¾`;
        let shareCash = 0, shareMiles = 0;
        let cardRewards = [];
        cards.forEach(card => {
            if(card.type === 'placeholder') return;
            const stats = calculateStatsAllLocations(card.id);
            if(stats.reward > 0) {
                if (card.type === 'miles') shareMiles += stats.reward;
                else shareCash += stats.reward;
                cardRewards.push({ name: card.name, reward: stats.reward, isMiles: card.type === 'miles' });
            }
        });
       let shareHtml = '';
        if (shareCash > 0 && shareMiles > 0) {
            shareHtml = `$${shareCash.toLocaleString()}<div style="font-size:50%; opacity:0.8; margin-top:4px;">âœˆï¸ ${shareMiles.toLocaleString()} å“©</div>`;
        } else if (shareMiles > 0) {
            shareHtml = `${shareMiles.toLocaleString()} å“©`;
        } else {
            shareHtml = `$${shareCash.toLocaleString()}`;
        }
        document.getElementById('shareCardAmount').innerHTML = shareHtml;
        cardRewards.sort((a, b) => b.reward - a.reward);
        const listContainer = document.getElementById('shareCardList');
        listContainer.innerHTML = '';
        if(cardRewards.length === 0) listContainer.innerHTML = '<div style="text-align:center; opacity:0.6; padding:10px;">æœ¬æœˆå°šç„¡å›é¥‹ç´€éŒ„</div>';
        else {
            cardRewards.forEach(c => {
               let unit = c.isMiles ? 'å“©' : 'å…ƒ';
                listContainer.innerHTML += `<div class="share-item"><span>${c.name}</span><span>+${c.reward.toLocaleString()} ${unit}</span></div>`;
            });
        }
        document.getElementById('sharePreviewModal').style.display = 'flex';
    }

    function shareToIG() { shareImageNative(); }
    function shareToFB() { shareImageNative(); }
    function shareToLine() { window.open(`https://line.me/R/msg/text/?${encodeURIComponent(getShareText())}`, '_blank'); }
    function shareToThreads() { window.open(`https://www.threads.net/intent/post?text=${encodeURIComponent(getShareText())}`, '_blank'); }

    function shareImageNative() {
        const node = document.getElementById('captureNode');
        const originalTransform = node.style.transform;
        node.style.transform = 'none';
        const btns = document.querySelectorAll('.social-btn');
        btns.forEach(b => b.style.opacity = '0.5');
        html2canvas(node, { backgroundColor: null, scale: 2 }).then(canvas => {
            node.style.transform = originalTransform; 
            btns.forEach(b => b.style.opacity = '1'); 
            canvas.toBlob(async (blob) => {
                const file = new File([blob], `Reward.png`, { type: "image/png" });
                if (navigator.share && navigator.canShare && navigator.canShare({ files: [file] })) {
                    try { await navigator.share({ files: [file], title: 'My Rewards', text: getShareText() }); } catch (err) {}
                } else { downloadShareImage(); }
            });
        });
    }

    function downloadShareImage() {
        const node = document.getElementById('captureNode');
        const originalTransform = node.style.transform;
        node.style.transform = 'none'; 
        html2canvas(node, { backgroundColor: null, scale: 2 }).then(canvas => {
            node.style.transform = originalTransform; 
            const link = document.createElement('a');
            link.download = `Reward_${Date.now()}.png`;
            link.href = canvas.toDataURL();
            link.click();
        });
    }

    function getShareText() { return `ğŸ’° ç‹‚ï¼æœ¬æœˆå›é¥‹ ${document.getElementById('totalRewardDisplay').innerText}ï¼\nå¿«ä¾†è©¦ç®— ğŸ‘‰ https://shawn2026-oss.github.io/shawn-2026-creditcard/`; }

    fetch('config.json?t=' + Date.now()).then(response => response.json()).then(data => { if(data.news) document.getElementById('news-text').innerHTML = data.news; }).catch(error => {});
    let cardSettings = JSON.parse(localStorage.getItem('cardSettings')) || {};
let editingTxId = null; // è¿½è¹¤æ­£åœ¨ç·¨è¼¯çš„äº¤æ˜“ ID
let historyMonthOffset = 0; // æ­·å²æœˆä»½åç§» (0=æœ¬æœŸ, -1=ä¸ŠæœŸ...)

    window.addEventListener('load', () => {
        injectDetails(); fetchExchangeRates();
        updateAmountPlaceholder();
        const tipBar = document.getElementById('line-tip-bar');
        if (tipBar && window.getComputedStyle(tipBar).display !== 'none') document.querySelector('.app-container').style.marginTop = '45px'; 
        setTimeout(() => { const ticker = document.querySelector('.ticker-content'); if(ticker) { ticker.style.animation = 'none'; void ticker.offsetWidth; ticker.style.animation = 'scroll-left 15s linear infinite'; } }, 100);
        
        // è¼‰å…¥å„²å­˜çš„åœ°é»è¨­å®š
        const savedLoc = localStorage.getItem('current_location');
        if (savedLoc && LOCATION_CONFIG[savedLoc]) {
            currentLocation = savedLoc;
            document.getElementById('currentLocationFlag').innerText = LOCATION_CONFIG[savedLoc].flag;
            document.getElementById('currentLocationName').innerText = LOCATION_CONFIG[savedLoc].name;
            if (savedLoc !== 'TW') {
                const rateRow = document.getElementById('exchangeRateRow');
                rateRow.style.display = 'flex';
                document.getElementById('currencySymbolInRate').innerText = LOCATION_CONFIG[savedLoc].currency;
                let rateVal = exchangeRates[LOCATION_CONFIG[savedLoc].currency] || 1;
                document.getElementById('exchangeRateInput').value = parseFloat(rateVal).toFixed(4);
            }
        }
        
        if (!localStorage.getItem('user_setup_done')) {
            if (localStorage.getItem('visibleCards') !== null) { localStorage.setItem('user_setup_done', 'true'); loadAndRenderApp(); }
            else initWelcomeModal();
        } else loadAndRenderApp();
    });

    function initWelcomeModal() {
        const list = document.getElementById('welcomeList'); list.innerHTML = '';
        cards.forEach(card => { if (card.id === 'add1') return; list.innerHTML += `<div class="welcome-item"><input type="checkbox" id="w_${card.id}" value="${card.id}"><label for="w_${card.id}">${card.name}</label></div>`; });
        document.getElementById('welcomeModal').style.display = 'flex';
    }

    function saveWelcomeSettings() {
        const checkboxes = document.querySelectorAll('.welcome-item input[type="checkbox"]:checked');
        let selectedCards = []; checkboxes.forEach(cb => selectedCards.push(cb.value));
        if (selectedCards.length === 0) { alert("å»ºè­°å…ˆé¸å¹¾å¼µå¡ç‰‡è©¦ç”¨çœ‹çœ‹å–”ï¼"); return; }
        localStorage.setItem('visibleCards', JSON.stringify(selectedCards));
        localStorage.setItem('user_setup_done', 'true');
        document.getElementById('welcomeModal').style.display = 'none';
        location.reload();
    }
    
   function getScenes() { return JSON.parse(localStorage.getItem('scene_snapshots') || '[]'); }
    
    let editingSceneIndex = null; // è¿½è¹¤æ­£åœ¨ç·¨è¼¯çš„æƒ…å¢ƒ
    
    // é–‹å•Ÿæ–°å¢æƒ…å¢ƒå½ˆçª—
    function saveCurrentScene() {
        if (!visibleCards || visibleCards.length <= 1) { alert("è«‹å…ˆé¸æ“‡è‡³å°‘ä¸€å¼µå¡ç‰‡ï¼"); return; }
        editingSceneIndex = null;
        openSceneEditModal(null);
    }
    
    // é–‹å•Ÿç·¨è¼¯æƒ…å¢ƒå½ˆçª—
    function editScene(index) {
        editingSceneIndex = index;
        openSceneEditModal(index);
    }
    
    // é–‹å•Ÿæƒ…å¢ƒç·¨è¼¯å½ˆçª—
    function openSceneEditModal(index) {
        const modal = document.getElementById('sceneEditModal');
        const title = document.getElementById('sceneEditTitle');
        const nameInput = document.getElementById('sceneNameInput');
        const cardOptions = document.getElementById('sceneCardOptions');
        
        // è¨­å®šæ¨™é¡Œ
        title.innerText = (index === null) ? 'æ–°å¢æƒ…å¢ƒ' : 'ç·¨è¼¯æƒ…å¢ƒ';
        
        // å–å¾—ç¾æœ‰è³‡æ–™
        const scenes = getScenes();
        const scene = (index !== null) ? scenes[index] : null;
        
        // å¡«å…¥åç¨±
        nameInput.value = scene ? scene.name : '';
        
        // é‡ç½®åœ‹å®¶é¸é …
        document.querySelectorAll('input[name="sceneLocation"]').forEach(cb => {
            cb.checked = false;
        });
        
        // å¡«å…¥å·²ç¶å®šçš„åœ‹å®¶
        if (scene && scene.linkedLocations) {
            scene.linkedLocations.forEach(loc => {
                const cb = document.querySelector(`input[name="sceneLocation"][value="${loc}"]`);
                if (cb) cb.checked = true;
            });
        }
        
        // ç”¢ç”Ÿå¡ç‰‡é¸é …
        cardOptions.innerHTML = '';
        const selectedCards = scene ? scene.cards : visibleCards;
  cards.filter(c => c.id !== 'add1').forEach(card => {
            const isChecked = selectedCards.includes(card.id);
            const div = document.createElement('div');
            div.style.cssText = 'position:relative; padding:12px; border:2px solid ' + (isChecked ? '#007AFF' : '#ddd') + '; border-radius:12px; cursor:pointer; background:#fff;';
            div.innerHTML = '<input type="checkbox" name="sceneCard" value="' + card.id + '"' + (isChecked ? ' checked' : '') + ' style="position:absolute; top:8px; right:8px; width:20px; height:20px;">' +
                '<div style="font-size:13px; font-weight:600; margin-bottom:4px; padding-right:28px;">' + card.name + '</div>' +
                '<div style="font-size:10px; color:#888;">' + (card.tag || '') + '</div>';
            div.onclick = function(e) {
                if (e.target.type !== 'checkbox') {
                    const cb = div.querySelector('input[type="checkbox"]');
                    cb.checked = !cb.checked;
                    div.style.borderColor = cb.checked ? '#007AFF' : '#ddd';
                }
            };
            div.querySelector('input').onchange = function() {
                div.style.borderColor = this.checked ? '#007AFF' : '#ddd';
            };
            cardOptions.appendChild(div);
        });
        
        // æª¢æŸ¥è¡çª
        checkSceneLocationConflict();
        
        // é¡¯ç¤ºå½ˆçª—
        modal.style.display = 'flex';
    }
    
    // é—œé–‰æƒ…å¢ƒç·¨è¼¯å½ˆçª—
    function closeSceneEditModal() {
        document.getElementById('sceneEditModal').style.display = 'none';
        editingSceneIndex = null;
    }
    
    // æª¢æŸ¥åœ‹å®¶ç¶å®šè¡çª
    function checkSceneLocationConflict() {
        const warning = document.getElementById('sceneLocationWarning');
        const scenes = getScenes();
        const checkedLocations = Array.from(document.querySelectorAll('input[name="sceneLocation"]:checked')).map(cb => cb.value);
        
        const conflicts = [];
        checkedLocations.forEach(loc => {
            scenes.forEach((scene, idx) => {
                // è·³éæ­£åœ¨ç·¨è¼¯çš„æƒ…å¢ƒæœ¬èº«
                if (idx === editingSceneIndex) return;
                if (scene.linkedLocations && scene.linkedLocations.includes(loc)) {
                    const locName = {TW:'å°ç£', JP:'æ—¥æœ¬', KR:'éŸ“åœ‹', TH:'æ³°åœ‹'}[loc];
                    conflicts.push(`${locName} å·²ç¶å®šã€Œ${scene.name}ã€`);
                }
            });
        });
        
        if (conflicts.length > 0) {
            warning.innerHTML = 'âš ï¸ ' + conflicts.join('ã€') + 'ï¼Œå„²å­˜å¾Œå°‡è¦†è“‹';
            warning.style.display = 'block';
        } else {
            warning.style.display = 'none';
        }
    }
    
    // å„²å­˜æƒ…å¢ƒç·¨è¼¯
    function saveSceneEdit() {
        const nameInput = document.getElementById('sceneNameInput');
        const name = nameInput.value.trim();
        
        if (!name) {
            alert('è«‹è¼¸å…¥æƒ…å¢ƒåç¨±');
            return;
        }
        
        // å–å¾—é¸ä¸­çš„å¡ç‰‡
        const selectedCards = Array.from(document.querySelectorAll('input[name="sceneCard"]:checked')).map(cb => cb.value);
        if (selectedCards.length === 0) {
            alert('è«‹è‡³å°‘é¸æ“‡ä¸€å¼µå¡ç‰‡');
            return;
        }
        
        // å–å¾—é¸ä¸­çš„åœ‹å®¶
        const selectedLocations = Array.from(document.querySelectorAll('input[name="sceneLocation"]:checked')).map(cb => cb.value);
        
        // å–å¾—ç¾æœ‰æƒ…å¢ƒ
        let scenes = getScenes();
        
        // ç§»é™¤å…¶ä»–æƒ…å¢ƒä¸­å·²è¢«é¸ä¸­çš„åœ‹å®¶ç¶å®šï¼ˆè™•ç†è¡çªï¼‰
        selectedLocations.forEach(loc => {
            scenes.forEach((scene, idx) => {
                if (idx === editingSceneIndex) return;
                if (scene.linkedLocations) {
                    scene.linkedLocations = scene.linkedLocations.filter(l => l !== loc);
                }
            });
        });
        
        // æ–°å¢æˆ–æ›´æ–°æƒ…å¢ƒ
        const newScene = {
            name: name,
            cards: selectedCards,
            linkedLocations: selectedLocations
        };
        
        if (editingSceneIndex !== null) {
            scenes[editingSceneIndex] = newScene;
        } else {
            scenes.push(newScene);
        }
        
        // å„²å­˜
        localStorage.setItem('scene_snapshots', JSON.stringify(scenes));
        
        // é—œé–‰å½ˆçª—ä¸¦é‡æ–°æ¸²æŸ“
        closeSceneEditModal();
        renderScenes();
    }
   function renderScenes() {
        const container = document.getElementById('sceneList'); 
        container.innerHTML = '';
        const scenes = getScenes();
        if (scenes.length === 0) { 
            container.innerHTML = '<span style="font-size:11px; color:#aaa; padding:6px;">å°šç„¡æƒ…å¢ƒ</span>'; 
            return; 
        }
        scenes.forEach((scene, index) => {
            const btn = document.createElement('div'); 
            btn.className = 'btn-scene';
            
            // é€£å‹•åœ–ç¤º
            if (scene.linkedLocations && scene.linkedLocations.length > 0) {
                const linkIcon = document.createElement('span');
                linkIcon.innerText = 'ğŸ”—';
                linkIcon.title = 'å·²é€£å‹•ï¼š' + scene.linkedLocations.map(l => ({TW:'å°ç£', JP:'æ—¥æœ¬', KR:'éŸ“åœ‹', TH:'æ³°åœ‹'}[l])).join('ã€');
                linkIcon.style.cssText = 'font-size:12px; margin-right:2px;';
                btn.appendChild(linkIcon);
            }
            
            // æƒ…å¢ƒåç¨±
            const nameSpan = document.createElement('span');
            nameSpan.innerText = scene.name;
            nameSpan.style.cssText = 'flex:1; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;';
            btn.appendChild(nameSpan);
            
            // ç·¨è¼¯æŒ‰éˆ•
            const editBtn = document.createElement('span');
            editBtn.className = 'btn-scene-edit';
            editBtn.innerText = 'âœï¸';
            editBtn.style.cssText = 'font-size:12px; margin-left:4px; cursor:pointer;';
            editBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                editScene(index);
            });
            btn.appendChild(editBtn);
            
            // åˆªé™¤æŒ‰éˆ•
            const delBtn = document.createElement('span');
            delBtn.className = 'btn-scene-del';
            delBtn.innerText = 'âœ•';
            delBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                deleteScene(index);
            });
            btn.appendChild(delBtn);
            
            // é»æ“Šè¼‰å…¥æƒ…å¢ƒ
            btn.addEventListener('click', function() {
                loadScene(index);
            });
            
            container.appendChild(btn);
        });
    }
    function deleteScene(index) { 
        if(confirm('ç¢ºå®šè¦åˆªé™¤é€™å€‹æƒ…å¢ƒå—ï¼Ÿ')) { 
            const s = getScenes(); 
            s.splice(index, 1); 
            localStorage.setItem('scene_snapshots', JSON.stringify(s)); 
            renderScenes(); 
        } 
    }
    function loadScene(index) {
        if(!confirm('åˆ‡æ›æƒ…å¢ƒï¼Ÿ')) return;
        visibleCards = getScenes()[index].cards; localStorage.setItem('visibleCards', JSON.stringify(visibleCards)); renderGrid(); openManageModal();
    }
    function clearVisibleCards() { if(confirm('æ¸…ç©ºæ‰€æœ‰å¡ç‰‡ï¼Ÿ')) { visibleCards = ['add1']; localStorage.setItem('visibleCards', JSON.stringify(visibleCards)); renderGrid(); openManageModal(); } }
   function loadAndRenderApp() {
        loadCustomCards();
        let currentCards = JSON.parse(localStorage.getItem('visibleCards')) || [];
        const realCardIds = cards.map(c => c.id).filter(id => id !== 'add1');
        let realCards = currentCards.filter(id => realCardIds.includes(id));
        if (realCards.length > 8) realCards = realCards.slice(0, 8);
        if (realCards.length < 8 && !currentCards.includes('add1')) realCards.push('add1');
        localStorage.setItem('visibleCards', JSON.stringify(realCards));
        visibleCards = realCards; renderGrid();
    }

    function closeModal() { 
        document.getElementById('transactionModal').style.display = 'none'; 
        document.getElementById('manageModal').style.display = 'none'; 
        document.getElementById('sharePreviewModal').style.display = 'none'; 
       document.getElementById('cardSettingsModal').style.display = 'none';
        document.getElementById('customCardModal').style.display = 'none';
        
        // â˜… é‡ç½®ç·¨è¼¯ç‹€æ…‹
        editingTxId = null;
        const btnConfirm = document.getElementById('btn-confirm');
        if (btnConfirm) btnConfirm.innerText = 'ç¢ºèª';
    }
    window.addEventListener('popstate', closeModal);
    
    // Cards DB
    const defaultCards = [
        { id: 'c10', name: 'ä¸­ä¿¡ UniOpen å¡', nickname: '2026 çµ±ä¸€é›†åœ˜ç¥å¡', note: 'icashPay/æµ·å¤– 11% ($3,750/$6,250 å°é ‚)', type: 'uniopen_special', gradient: 'linear-gradient(135deg, #FF512F 0%, #F09819 100%)', textColor: 'white', msgDanger: '', parking: `ğŸª <b>çµ±ä¸€é›†åœ˜ 2026 æ–°æ¬Šç›Š</b><br>1. <b>åŸºæœ¬å›é¥‹</b>ï¼š1% (ç„¡ä¸Šé™)<br>2. <b>é›†åœ˜åŠ ç¢¼</b>ï¼š+2% (é™åˆ·$2.5è¬)<br>3. <b>è¸©é»ä»»å‹™</b>ï¼šæ»¿ 5 å®¶ +4% (é™åˆ·$1.25è¬)<br>4. <b>icash Pay</b>ï¼šåŠ ç¢¼ +4% (é™åˆ·$3,750)`},
        { id: 'dbs1', name: 'æ˜Ÿå±• eco æ°¸çºŒå¡', nickname: 'ç¶ èƒ½/æ–°æˆ¶lpç¥å¡', note: 'åœ‹å¤–å¯¦é«” +4% (åˆ·$1.5è¬å°é ‚)', type: 'ceiling', limit: 15000, tier1Rate: 0.05, tier2Rate: 0.01, gradient: 'linear-gradient(135deg, #FF0000 0%, #000000 100%)', textColor: 'white', msgDanger: 'åŠ ç¢¼å·²å°é ‚ (è®Š1%)', parking: `ğŸŒ¿ <b>ç¶ è‰²/ç‰¹æ–¯æ‹‰ +9%</b><br>åŸºæœ¬ 1% + åŠ ç¢¼ 9% (ä¸Šé™300é»)<br>âš ï¸ ç´„åˆ· $3,333 å°é ‚<br>âš¡ <b>æ–°æˆ¶ Line Pay 10%</b><br>åŸºæœ¬ 1% + åŠ ç¢¼ 9%<br>âš ï¸ åŠ ç¢¼ä¸Šé™ 1000 é» (ç´„åˆ· $11,111)<br>âœˆï¸ <b>åœ‹å¤–å¯¦é«” +4%</b><br>åŸºæœ¬ 1% + åŠ ç¢¼ 4% (å…±5%)<br>âš ï¸ åŠ ç¢¼é©ç”¨æœˆåˆ· $15,000 å°é ‚`},
        { id: 'c6', name: 'å°æ–°è¡—å£è±¬å¯Œå¡', nickname: 'è¡Œæ”¯/ç¹³è²»ç¥å¡', note: 'æ–°æˆ¶ 10% (åˆ· 8åƒå°é ‚) | ç²¾é¸ 2.5% (åˆ· 40è¬å°é ‚)', rule: '', type: 'ceiling', limit: 8000, tier1Rate: 0.135, tier2Rate: 0.035, gradient: 'linear-gradient(135deg, #e60012 0%, #FFD700 100%)', textColor: 'white', msgDanger: 'æ–°æˆ¶10%å·²å°é ‚', parking: `ğŸ· <b>æ–°æˆ¶é™å®šç¥å¡</b><br>æ–°æˆ¶ +10% (é™åˆ·$8,000)<br>ğŸŒŸ <b>ç²¾é¸é€šè·¯ +2.5%</b><br>ä¸Šé™ $40 è¬`},
        { id: 'c1', name: 'æ˜Ÿå±•å‚³èªªå°æ±ºå¡', nickname: 'Line Payç¥å¡', note: 'LinePay/å¤–é€/è¦çš®(åˆ·$11,363 å°é ‚)', rule: '', type: 'custom_legend', limit: 11363, gradient: 'linear-gradient(135deg, #43cea2 0%, #185a9d 100%)', textColor: 'white', msgDanger: 'åŠ ç¢¼å·²å°é ‚ (è®Š1.2%)' },
        { id: 'c5', name: 'è¯é‚¦è³´é»å¡', nickname: 'Line Pay 10%', note: 'å¶æ•¸æ—¥+5% / LP+1% / æ–°æˆ¶+4%', rule: 'âš ï¸ éœ€å–®ç­†æ»¿ $100', type: 'custom_laidian', limit: 3000, tier1Rate: 0.06, tier2Rate: 0.01, threshold: 0, gradient: 'linear-gradient(135deg, #00B900 0%, #33CC33 100%)', textColor: 'white', msgDanger: 'åŠ ç¢¼å·²å°é ‚', parking: `âœ… <b>åŸºæœ¬å›é¥‹ 1%</b> (ç„¡ä¸Šé™)<br>ğŸ“± <b>LP ä¸€èˆ¬ 2%</b> (1+1, é™åˆ·2è¬)<br>ğŸ“… <b>å¶æ•¸æ—¥ 6%</b> (1+5, é™åˆ·3åƒ)<br>ğŸ‘¶ <b>æ–°æˆ¶åŠ ç¢¼ +4%</b> (é™åˆ·7500)<br>âš ï¸ <b>æ³¨æ„</b>ï¼šåŠ ç¢¼éœ€å–®ç­†æ»¿ $100`},
        { id: 'c3', name: 'æ°¸è± Sport å¡', nickname: 'Apple Payå„ªç­‰ç”Ÿ', note: 'Apple Pay 5% (åˆ· 5åƒå°é ‚)', rule: '', type: 'ceiling', limit: 5000, tier1Rate: 0.05, tier2Rate: 0.02, gradient: 'linear-gradient(135deg, #00B4DB 0%, #0083B0 100%)', textColor: 'white', msgDanger: 'å·²å°é ‚ (è®Š1%)' },
        { id: 'c4', name: 'å°‡ä¾†å°‡å°‡å¡', nickname: 'è¡Œæ”¯/é¤å»³/å¤–é€', note: 'ç”Ÿæ´» 5% (åˆ· 6åƒ6å°é ‚)', rule: '', type: 'mixed', limit: 6666, minSpend: 3000, tier1Rate: 0.05, tier2Rate: 0.005, gradient: 'linear-gradient(135deg, #ffe259 0%, #ffa751 100%)', textColor: '#333', msgDanger: 'å·²å°é ‚ (è®Š0.5%)', parking: `ğŸ¯ <b>ä½æ¶ˆä»»å‹™</b>ï¼šç•¶æœˆç´¯ç©æ»¿ <b>$3,000</b> æ‰äº«åŠ ç¢¼<br><br>ğŸ›ï¸ <b>ç”Ÿæ´»å‡ç´š 5%</b> (é™åˆ·$6,666)<br>è¡Œå‹•æ”¯ä»˜/å¤–é€/é¤å»³/è³¼ç‰©<br><br>âœˆï¸ <b>æ—…éŠåŠ ç¢¼ 5%</b> (é™åˆ·$11,111)<br>æµ·å¤–/èˆªç©º/æ—…è¡Œç¤¾/é«˜éµ`},
        { id: 'c2', name: 'è¯é‚¦ç¶ å¡', nickname: 'ç¶ è‰²/å¸‚å€åœè»Šç¥å¡', note: 'ç¶ è‰² +5% (åˆ· 3åƒå°é ‚) | åœè»Š (åˆ· 1.2è¬é”æ¨™)', rule: '', type: 'floor', target: 12000, tier1Rate: 0.02, tier2Rate: 0.02, gradient: 'linear-gradient(135deg, #20B2AA 0%, #008B8B 100%)', textColor: 'white', msgSuccess: 'å·²é”æ¨™ (ä¸‹æœˆå…åœ)', parking: `ğŸ…¿ï¸ <b>å…è²»åœè»Šï¼š</b>éœ€ä¸Šæœˆåˆ·æ»¿1.2è¬<br>ğŸŒ¿ <b>ç¶ è‰²é€šè·¯ 6%</b><br>åŸºæœ¬ 1% + åŠ ç¢¼ 5%<br>âš ï¸ åŠ ç¢¼é©ç”¨æœˆåˆ· $3,000 å°é ‚ (å›é¥‹ $150)`},
        { id: 'c7', name: 'ç‰å±± UNI å¡', nickname: 'è¡Œæ”¯/ç™¾è²¨å„ªç­‰ç”Ÿ', note: 'UP 4.5% (åˆ· 14è¬å°é ‚)', type: 'ceiling', limit: 40000, tier1Rate: 0.035, tier2Rate: 0.01, gradient: 'linear-gradient(135deg, #a18cd1 0%, #fbc2eb 100%)', textColor: 'white', msgDanger: 'å·²å°é ‚ (è®Š1%)', parking: `ğŸ”¥ <b>ä»»æ„é¸ 3.5%</b> (é™åˆ·$4è¬)<br>ğŸ†™ <b>UP é¸ 4.5%</b> (é™åˆ·$14è¬)<br>â„¹ï¸ <b>è¨‚é–±å»ºè­°</b>ï¼š<br>æ¶ˆè²»æ»¿ $14,900 ä»¥ä¸Šå»ºè­°è¨‚é–± UP é¸`, getDynamicName: function() { const settings = JSON.parse(localStorage.getItem('uni_settings') || '{}'); return settings.isUp ? 'ç‰å±± UNI å¡ï¼ˆå‡ç´šUPé¸ï¼‰' : 'ç‰å±± UNI å¡'; }},
        { id: 'c8', name: 'é æ±æ¨‚å®¶+å¡', nickname: 'ç”Ÿæ´»/å¯µç‰©ç¥å¡', note: 'å¯µç‰©10% / ç”Ÿæ´»å®‰å¿ƒ4% ', type: 'custom_happy', limit: 5263, minSpend: 3000, tier1Rate: 0.1, tier2Rate: 0.005, gradient: 'linear-gradient(135deg, #ff9a9e 0%, #fecfef 99%, #fecfef 100%)', textColor: 'white', msgDanger: 'å·²å°é ‚ (è®Š0.5%)', parking: `ğŸ¶ <b>å¯µç‰© 10%</b> (é™åˆ·$5,263)<br>ğŸ½ï¸ <b>å®‰å¿ƒ/ç”Ÿæ´» 4%</b> (é™åˆ·$5,714)<br>âœˆï¸ <b>åœ‹å¤– 2.5%</b> (ç„¡ä¸Šé™)`},
        { id: 'c9', name: 'æ»™è±æ—…äººå¡', nickname: 'å“©ç¨‹ç´¯ç©', note: 'ç„¡é™:åœ‹å…§18/åœ‹å¤–10 | å¾¡ç’½:åœ‹å…§18/åœ‹å¤–15', type: 'miles', gradient: 'linear-gradient(135deg, #1e3c72 0%, #2a5298 100%)', textColor: 'white', msgDanger: '', parking: `âœˆï¸ <b>å“©ç¨‹ç´¯ç©ç¥å¡</b>`, getDynamicName: function() { const tier = localStorage.getItem('hsbc_tier') || 'infinite'; return tier === 'infinite' ? 'æ»™è±æ—…äººç„¡é™å¡' : 'æ»™è±æ—…äººå¾¡ç’½å¡'; }},
        { id: 'c11', name: 'å°æ–° Richart å¡', nickname: 'æ¬Šç›Šè‡ªç”±é¸', note: 'å°æ–°Pay 3.8% (ç„¡ä¸Šé™)', type: 'ceiling', limit: 99999999, tier1Rate: 0.038, tier2Rate: 0.003, gradient: 'linear-gradient(135deg, #0F2027 0%, #203A43 50%, #2C5364 100%)', textColor: 'white', msgDanger: '', parking: `ğŸ¶ <b>æ¬Šç›Šè‡ªç”±é¸ (ç„¡ä¸Šé™å›é¥‹)</b>`},
        { id: 'j1', name: 'å¯Œé‚¦ J å¡', nickname: 'æ—¥éŸ“æ—…éŠå„ªç­‰ç”Ÿ', note: 'æ—¥éŸ“æ³°$3.3è¬/äº¤é€šå¡$2,857(å­£)',type: 'custom_j', limit: 0, gradient: 'linear-gradient(135deg, #FF7E5F 0%, #FEB47B 100%)', textColor: 'white', msgDanger: '', parking: `ğŸ‡¯ğŸ‡µğŸ‡°ğŸ‡·ğŸ‡¹ğŸ‡­ <b>å¯¦é«”æ¶ˆè²»åŠ ç¢¼</b> (å…±ç”¨å­£ä¸Šé™$1000å›é¥‹)<br>â€¢ æ—¥éŸ“å¯¦é«”ï¼š3%+3%=6% (åˆ·$33,333å°é ‚)<br>â€¢ æ³°åœ‹å¯¦é«”ï¼š1%+5%=6% (åˆ·$20,000å°é ‚)<br>âš ï¸ éœ€å–®ç­†æ»¿ $1,000<br><br>ğŸ <b>æ—¥æœ¬äº¤é€šå¡</b> (ç¨ç«‹å­£ä¸Šé™$200å›é¥‹)<br>â€¢ Suica/PASMOç­‰ï¼š3%+7%=10% (åˆ·$2,857å°é ‚)<br>âš ï¸ éœ€å–®ç­†æ»¿ $2,000`},
        { id: 'j2', name: 'è¯é‚¦å‰é¶´å¡', nickname: 'æ—¥æœ¬/ApplePayé¦–é¸', note: 'æ—¥æœ¬ AP 4% (åˆ· 4è¬å°é ‚) | åœ‹å…§æ—¥ç³» 5%', type: 'ceiling', limit: 40000, tier1Rate: 0.04, tier2Rate: 0.025, gradient: 'linear-gradient(135deg, #DC143C 0%, #FFFFFF 150%)', textColor: 'white', msgDanger: 'åŠ ç¢¼å·²å°é ‚ (è®Š2.5%)', parking: `ğŸ <b>æ—¥æœ¬ QUICPay (Apple Pay)</b><br>æ—¥æœ¬ 2.5% + åŠ ç¢¼ 1.5% = 4%<br>âš ï¸ åŠ ç¢¼ä¸Šé™ $600/æœˆ (ç´„åˆ·$4è¬)<br>ğŸ‡¹ğŸ‡¼ <b>åœ‹å…§æ—¥ç³»ååº— 5%</b><br>åœ‹å…§ 1% + åŠ ç¢¼ 4% (åˆ·$1.25è¬å°é ‚)`},
        { id: 'j3', name: 'ç‰å±±ç†Šæœ¬ç†Šå¡', nickname: 'æ—¥æœ¬å„ªç­‰ç”Ÿ', note: 'PayPay 5% (å­£) | æŒ‡å®š 8.5%', type: 'ceiling', limit: 8333, tier1Rate: 0.085, tier2Rate: 0.025, gradient: 'linear-gradient(135deg, #BDC3C7 0%, #2C3E50 100%)', textColor: 'white', msgDanger: 'åŠ ç¢¼å·²å°é ‚', parking: `ğŸ» <b>æŒ‡å®šé€šè·¯ 8.5%</b><br>(åŸºæœ¬2.5% + åŠ ç¢¼6%)<br>âš ï¸ åŠ ç¢¼ä¸Šé™ $500/æœŸ (ç´„åˆ·$8,333)<br>ğŸ“± <b>PayPay 5%</b> (3.5%+1.5%å…æ‰‹çºŒè²»)<br>âš ï¸ 3.5%åŠ ç¢¼ä¸Šé™ $100/å­£ (ç´„åˆ·$2,857)<br>ğŸ”° <b>åœ‹å…§ä¸€èˆ¬ 0.5%</b> (ç„¡ä¸Šé™)`},
        { id: 'j4', name: 'æ°¸è±å¹£å€å¡ (å¤§å¤§/å¤§æˆ¶)', nickname: 'æµ·å¤–é›™å¹£ç¥å¡', note: 'æµ·å¤–ç²¾é¸ 6% (åˆ· 2è¬å°é ‚)', type: 'ceiling', limit: 80000, tier1Rate: 0.06, tier2Rate: 0.02, gradient: 'linear-gradient(135deg, #FDC830 0%, #F37335 100%)', textColor: 'white', msgDanger: 'åŠ ç¢¼å·²å°é ‚', parking: `ğŸ’° <b>å¹£å€å¡ 2026</b><br><b>Level 1 (å¤§å¤§)</b><br>æ¢ä»¶ï¼šè‡ªå‹•æ‰£ç¹³+é›»å­å¸³å–®<br>é™åˆ·ï¼š$7,500<br><br><b>Level 2 (å¤§æˆ¶)</b><br>æ¢ä»¶ï¼šå¾€ä¾†è³‡ç”¢â‰¥10è¬<br>é™åˆ·ï¼š$20,000`},
        { id: 'j5', name: 'æ°¸è±ä¸‰äº•è¯åå¡', nickname: 'é¤é£²å„ªç­‰ç”Ÿ/æ—¥éŸ“æ³°é™„åŠ ', note: 'é¤é£² 7.3% (åº•0.3%+7%)', type: 'custom_mitsui', target: 30000, tier1Rate: 0.073, tier2Rate: 0.003, gradient: 'linear-gradient(135deg, #00C9FF 0%, #92FE9D 100%)', textColor: '#333', msgSuccess: 'å·²é”æ¨™ (é ˜$2000)', parking: `ğŸ½ï¸ <b>ç‰¹é¸é¤é£² 7.3%</b> (0.3+7)<br>é€šè·¯ï¼šé¤¨å¤–é¤é£²(MCC 58xx) / å…¨ç›ˆ+PAY<br>âš ï¸ åŠ ç¢¼ä¸Šé™åƒ… 100 å…ƒ (ç´„åˆ· $1,428)<br><br>ğŸ‡¯ğŸ‡µ <b>æ—¥éŸ“æ³°æ»¿é¡ç¦® (éœ€ç™»éŒ„)</b><br>æ¯å­£ç´¯ç©æ»¿ 30,000 é€ 2,000 (å›é¥‹ç´„6.9%)`},
        { id: 'c12', name: 'æ°¸è±ç¾é‡‘å›é¥‹ JCB', nickname: 'æ—…æ—¥ç¥å¡', note: 'åœ‹å…§ç‰¹é¸/æ—¥æœ¬ +3% (æœˆ$1è¬å…±ç”¨)', type: 'custom_jcb', limit: 10000, tier1Rate: 0.05, tier2Rate: 0.01, gradient: 'linear-gradient(135deg, #8E0E00 0%, #1F1C18 100%)', textColor: 'white', msgDanger: 'ç‰¹é¸å·²å°é ‚ (è®Š1%)', parking: `ğŸ‡¯ğŸ‡µ <b>æ—¥æœ¬æ¶ˆè²»</b><br>æœ€é«˜ 5% (åœ‹å¤–2% + åŠ ç¢¼3%)<br>ğŸ›ï¸ <b>ç‰¹é¸é€šè·¯</b><br>æœ€é«˜ 5% (åœ‹å¤–2% + åŠ ç¢¼3%) æˆ– 4% (åœ‹å…§1% + åŠ ç¢¼3%)<br>âš ï¸ æ—¥æœ¬+ç‰¹é¸å…±ç”¨åŠ ç¢¼ä¸Šé™ $300/æœˆ (ç´„åˆ· $10,000)<br>ğŸ”¥ <b>æ—¥éŸ“æ³°æ»¿é¡</b> (éœ€ç™»éŒ„)<br>æ¯å­£ç´¯ç©æ»¿ 2 è¬é€ $1,000 (å…±ç”¨ä¸Šé™)`},
        { id: 'add1', name: 'æ–°å¢å¡ç‰‡', nickname: 'é»æ“Šé¸å¡', note: 'å‰å¾€è³‡æ–™åº«æŒ‘é¸', type: 'placeholder', gradient: 'linear-gradient(135deg, #e0e0e0 0%, #f5f5f5 100%)', textColor: '#999', msgDanger: '' }
    ];
  let visibleCards = JSON.parse(localStorage.getItem('visibleCards')), savedOrder = JSON.parse(localStorage.getItem('cardOrder')), cards = [...defaultCards], sortableInstance = null;
    
    // è¼‰å…¥è‡ªå»ºå¡ç‰‡
    function loadCustomCards() {
        const customs = JSON.parse(localStorage.getItem('custom_cards') || '[]');
        // ç§»é™¤èˆŠçš„è‡ªå»ºå¡ï¼ˆä¿ç•™ defaultCards + add1ï¼‰
        cards = [...defaultCards];
        customs.forEach(cc => {
            const cardObj = {
                id: cc.id,
                name: cc.name,
                nickname: cc.nickname || '',
                note: cc.cap > 0 ? `${cc.rate}% (åˆ·$${cc.cap.toLocaleString()}å°é ‚)` : `${cc.rate}% (ç„¡ä¸Šé™)`,
                type: cc.cap > 0 ? 'ceiling' : 'ceiling',
                limit: cc.cap > 0 ? cc.cap : 99999999,
                tier1Rate: parseFloat((cc.rate / 100).toFixed(10)),
                tier2Rate: 0,
                gradient: cc.gradient,
                textColor: cc.textColor || 'white',
                msgDanger: cc.cap > 0 ? 'å·²å°é ‚' : '',
                parking: '',
                isCustom: true,
                isMiles: cc.unit === 'miles'
            };
            if (cc.unit === 'miles') cardObj.type = 'miles';
          // æš±ç¨±åŒæ­¥åˆ° cardSettings
            if (cc.nickname) {
                if (!cardSettings[cc.id]) cardSettings[cc.id] = {};
                cardSettings[cc.id].nickname = cc.nickname;
            }
            // æ’å…¥åˆ° add1 ä¹‹å‰
            const addIdx = cards.findIndex(c => c.id === 'add1');
            cards.splice(addIdx, 0, cardObj);
        });
    }
    loadCustomCards();

    const customColorPresets = [
        { name: 'æ·±è—', gradient: 'linear-gradient(135deg, #1a2a6c 0%, #b21f1f 50%, #fdbb2d 100%)', textColor: 'white' },
        { name: 'å¢¨é»‘', gradient: 'linear-gradient(135deg, #232526 0%, #414345 100%)', textColor: 'white' },
        { name: 'é…’ç´…', gradient: 'linear-gradient(135deg, #870000 0%, #190A05 100%)', textColor: 'white' },
        { name: 'æ£®ç¶ ', gradient: 'linear-gradient(135deg, #134E5E 0%, #71B280 100%)', textColor: 'white' },
        { name: 'ç´«ç¾…è˜­', gradient: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)', textColor: 'white' },
        { name: 'ç«ç‘°é‡‘', gradient: 'linear-gradient(135deg, #f5af19 0%, #f12711 100%)', textColor: 'white' },
        { name: 'éŠ€ç°', gradient: 'linear-gradient(135deg, #bdc3c7 0%, #2c3e50 100%)', textColor: 'white' },
        { name: 'æ·ºç²‰', gradient: 'linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%)', textColor: '#333' }
    ];
    let selectedCustomColor = 0;

    function openCustomCardModal(editId) {
        const modal = document.getElementById('customCardModal');
        const title = document.getElementById('customCardTitle');
        document.getElementById('customCardEditId').value = editId || '';

        // æ¸²æŸ“é¡è‰²é¸æ“‡å™¨
        const picker = document.getElementById('customColorPicker');
        picker.innerHTML = '';
        customColorPresets.forEach((c, i) => {
            const dot = document.createElement('div');
            dot.style.cssText = `width:36px; height:36px; border-radius:10px; cursor:pointer; border:3px solid ${i === selectedCustomColor ? '#007AFF' : 'transparent'}; background:${c.gradient};`;
            dot.onclick = () => { selectedCustomColor = i; document.querySelectorAll('#customColorPicker > div').forEach((d,j) => d.style.borderColor = j===i ? '#007AFF' : 'transparent'); };
            picker.appendChild(dot);
        });

        // çµå¸³æ—¥é¸é …
        const sel = document.getElementById('customCardCycleDay');
        if (sel.options.length <= 1) {
            for (let i = 1; i <= 31; i++) sel.add(new Option(`æ¯æœˆ ${i} è™Ÿ`, i));
        }

        if (editId) {
            title.innerText = 'ç·¨è¼¯è‡ªå»ºå¡ç‰‡';
            const customs = JSON.parse(localStorage.getItem('custom_cards') || '[]');
            const cc = customs.find(c => c.id === editId);
            if (cc) {
                document.getElementById('customCardName').value = cc.name;
                document.getElementById('customCardNickname').value = cc.nickname || '';
                document.getElementById('customCardRate').value = cc.rate;
                document.querySelector(`input[name="customCardUnit"][value="${cc.unit}"]`).checked = true;
                document.getElementById('customCardCap').value = cc.cap > 0 ? cc.cap : '';
                document.getElementById('customCardCycleDay').value = cc.cycleDay || '';
                const ci = customColorPresets.findIndex(p => p.gradient === cc.gradient);
                selectedCustomColor = ci >= 0 ? ci : 0;
                // é‡æ–°æ¸²æŸ“é¡è‰²é¸ä¸­ç‹€æ…‹
                picker.innerHTML = '';
                customColorPresets.forEach((c, i) => {
                    const dot = document.createElement('div');
                    dot.style.cssText = `width:36px; height:36px; border-radius:10px; cursor:pointer; border:3px solid ${i === selectedCustomColor ? '#007AFF' : 'transparent'}; background:${c.gradient};`;
                    dot.onclick = () => { selectedCustomColor = i; document.querySelectorAll('#customColorPicker > div').forEach((d,j) => d.style.borderColor = j===i ? '#007AFF' : 'transparent'); };
                    picker.appendChild(dot);
                });
            }
        } else {
            title.innerText = 'è‡ªå»ºå¡ç‰‡';
           document.getElementById('customCardName').value = '';
            document.getElementById('customCardNickname').value = '';
            document.getElementById('customCardRate').value = '';
            document.querySelector('input[name="customCardUnit"][value="cash"]').checked = true;
            document.getElementById('customCardCap').value = '';
            document.getElementById('customCardCycleDay').value = '';
            selectedCustomColor = 0;
        }

      document.getElementById('customCardDeleteArea').style.display = editId ? 'block' : 'none';
        modal.style.display = 'flex';
        history.pushState({ modal: true }, '');
    }

    function saveCustomCard() {
        const name = document.getElementById('customCardName').value.trim();
        const rate = parseFloat(document.getElementById('customCardRate').value);
        if (!name) { alert('è«‹è¼¸å…¥å¡ç‰‡åç¨±'); return; }
        if (isNaN(rate) || rate <= 0) { alert('è«‹è¼¸å…¥æœ‰æ•ˆçš„å›é¥‹ç‡'); return; }

       const nickname = document.getElementById('customCardNickname').value.trim();
        const unit = document.querySelector('input[name="customCardUnit"]:checked').value;
        const cap = parseInt(document.getElementById('customCardCap').value) || 0;
        const cycleDay = document.getElementById('customCardCycleDay').value;
        const color = customColorPresets[selectedCustomColor];
        const editId = document.getElementById('customCardEditId').value;

        let customs = JSON.parse(localStorage.getItem('custom_cards') || '[]');

        if (editId) {
            const idx = customs.findIndex(c => c.id === editId);
            if (idx >= 0) {
                customs[idx] = { ...customs[idx], name, nickname, rate, unit, cap, cycleDay, gradient: color.gradient, textColor: color.textColor };
            }
        } else {
            if (customs.length >= 2) { alert('è‡ªå»ºå¡ç‰‡æœ€å¤š 2 å¼µ'); return; }
            const newId = 'custom_' + Date.now();
           customs.push({ id: newId, name, nickname, rate, unit, cap, cycleDay, gradient: color.gradient, textColor: color.textColor });
        }

        localStorage.setItem('custom_cards', JSON.stringify(customs));
        loadCustomCards();

        // æ–°å»ºæ™‚è‡ªå‹•åŠ å…¥é¦–é 
        if (!editId) {
            const newCard = customs[customs.length - 1];
            let realCards = visibleCards.filter(id => id !== 'add1');
            if (realCards.length < 8) {
                realCards.push(newCard.id);
                visibleCards = realCards.length < 8 ? [...realCards, 'add1'] : realCards;
                localStorage.setItem('visibleCards', JSON.stringify(visibleCards));
            }
        }

        // è‡ªå»ºå¡çµå¸³æ—¥å­˜å…¥ cardSettings
        if (editId || customs.length > 0) {
            const targetId = editId || customs[customs.length - 1].id;
            if (!cardSettings[targetId]) cardSettings[targetId] = {};
            cardSettings[targetId].cycleDay = cycleDay;
            localStorage.setItem('cardSettings', JSON.stringify(cardSettings));
        }

        document.getElementById('customCardModal').style.display = 'none';
        renderManageList();
        renderGrid();
    }

    function deleteCustomCard(cardId) {
        if (!confirm('ç¢ºå®šåˆªé™¤é€™å¼µè‡ªå»ºå¡ç‰‡ï¼Ÿï¼ˆæ¶ˆè²»ç´€éŒ„æœƒä¿ç•™ï¼‰')) return;
        let customs = JSON.parse(localStorage.getItem('custom_cards') || '[]');
        customs = customs.filter(c => c.id !== cardId);
        localStorage.setItem('custom_cards', JSON.stringify(customs));

        // å¾é¦–é ç§»é™¤
        visibleCards = visibleCards.filter(id => id !== cardId);
        localStorage.setItem('visibleCards', JSON.stringify(visibleCards));

        loadCustomCards();
        renderManageList();
        renderGrid();
    }
    function getSortedCards() {
        if (!visibleCards) return [];
        let displayCards = cards.filter(c => visibleCards.includes(c.id));
        if (displayCards.filter(c => c.type !== 'placeholder').length < 8 && !visibleCards.includes('add1')) displayCards.push(cards.find(c => c.id === 'add1'));
        if (savedOrder) displayCards.sort((a, b) => (savedOrder.indexOf(a.id) === -1 ? 999 : savedOrder.indexOf(a.id)) - (savedOrder.indexOf(b.id) === -1 ? 999 : savedOrder.indexOf(b.id)));
        return displayCards;
    }
    function initSortable() {
        if (sortableInstance) sortableInstance.destroy();
        sortableInstance = new Sortable(document.getElementById('card-grid'), { animation: 150, ghostClass: 'sortable-ghost', dragClass: 'sortable-drag', delay: 200, delayOnTouchOnly: true, forceFallback: true, onEnd: function (evt) { const allIds = cards.map(c => c.id), vis = Array.from(evt.to.children).map(el => el.getAttribute('data-card-id')), hidden = allIds.filter(id => !vis.includes(id)); localStorage.setItem('cardOrder', JSON.stringify([...vis, ...hidden])); savedOrder = [...vis, ...hidden]; } });
    }

    // ==========================================
    // UniOpen å®Œæ•´å“ç‰Œæ¸…å–® (ä¾æ“šçµ±ä¸€ä¼æ¥­é›†åœ˜)
    // ==========================================
    const uniBrandCategories = {
        cat1: { 
            name: 'ä¾¿åˆ©å•†åº—/è¶…å¸‚', 
            brands: ['7-ELEVEN', 'åº·æ˜¯ç¾', 'è–å¾·ç§‘æ–¯', 'çµ±ä¸€ç”Ÿæ©Ÿ', 'Mia C\'bon', 'å®¶æ¨‚ç¦'] 
        },
        cat2: { 
            name: 'ç™¾è²¨/è³¼ç‰©', 
            brands: ['çµ±ä¸€æ™‚ä»£', 'å¤¢æ™‚ä»£', 'UNICCY', 'åšå®¢ä¾†', 'Yahooè³¼ç‰©', 'é…·è–çŸ³'] 
        },
        cat3: { 
            name: 'é¤é£²/ç”œé»', 
            brands: ['æ˜Ÿå·´å…‹', 'Mister Donut', 'Cold Stone', '21é¢¨å‘³é¤¨', '21 Plus', 'è–å¨œ', 'Semeur'] 
        },
        cat4: { 
            name: 'å¥èº«/ä¼‘é–’', 
            brands: ['BEING sport', 'BEING spa', 'BEING fit', 'çµ±ä¸€æ¸¡å‡æ‘'] 
        },
        cat5: { 
            name: 'ç”Ÿæ´»æœå‹™', 
            brands: ['DUSKIN', 'å®…æ€¥ä¾¿', 'ibon', 'foodomo', 'é€Ÿé‚æ¨‚åŠ æ²¹', 'é®®æ‹¾'] 
        },
        cat6: { 
            name: 'æ—…éŠ/é£¯åº—', 
            brands: ['W Taipei', 'Hotel Resonance', 'ç²ç“æ»¿è—'] 
        }
    };

    // å–å¾—ç•¶æœŸçš„è¸©é»è¨˜éŒ„ key
    function getUniBrandCycleKey() {
        const now = new Date();
        return `uni_brands_${now.getFullYear()}_${now.getMonth() + 1}`;
    }

    // åˆå§‹åŒ– UniOpen å“ç‰Œæ ¼ (åˆ†é¡ç‰ˆ)
    const uniChannelCategories = {
        pay: { name: 'è¡Œå‹•æ”¯ä»˜', items: ['ç‰å±±Wallet', 'LINE Pay', 'å…¨æ”¯ä»˜', 'è¡—å£æ”¯ä»˜', 'æ‚ éŠä»˜', 'å…¨ç›ˆ+PAY', 'iPASS MONEY', 'icash Pay'] },
        ecom: { name: 'é›»å•†å¹³å°', items: ['momoè³¼ç‰©ç¶²', 'è¦çš®è³¼ç‰©', 'æ·˜å¯¶ç¶²', 'Coupangé…·æ¾'] },
        dept: { name: 'åœ‹å…§ç™¾è²¨', items: ['æ–°å…‰ä¸‰è¶Š', 'å°åŒ—101', 'è¯æ³°åå“åŸ', 'ä¸‰äº•OUTLET', 'äº¬ç«™', 'ç¾éº—è¯', 'ç§€æ³°ç”Ÿæ´»', 'LaLaport', 'çµ±é ˜å»£å ´', 'é‡‡ç›Ÿ', 'æ˜‡æ†æ˜Œ', 'çµ±ä¸€æ™‚ä»£ç™¾è²¨', 'é æ±ç™¾è²¨', 'æ¼¢ç¥ç™¾è²¨', 'å¾®é¢¨ç™¾è²¨', 'èª å“ç”Ÿæ´»'] },
        life: { name: 'ç”Ÿæ´»æ¡è²·', items: ['å®¶æ¨‚ç¦', 'å±ˆè‡£æ°', 'åº·æ˜¯ç¾', 'ç‰¹åŠ›å±‹', 'HOLA', 'hoiå¥½å¥½ç”Ÿæ´»', 'UNIQLO', 'NET', 'å¤§æ¨¹è—¥å±€', 'ä¸ä¸è—¥å¦'] },
        food: { name: 'é¤é£²ç¾é£Ÿ', items: ['Uber Eats', 'foodpanda', 'EZTABLE', 'ç‹å“ç˜‹Pay', 'é¥—è³“é¤é£²', 'ç“¦åŸæ–™ç†', 'ä¹¾æ¯ç‡’è‚‰', 'æ¼¢ä¾†ç¾é£Ÿ', 'é¼ç‹é¤é£²', 'çˆ­é®®é¤é£²'] },
        transport: { name: 'åŠ æ²¹äº¤é€š', items: ['å°ç£ä¸­æ²¹', '55688', 'å°éµ', 'é«˜éµ', 'Uber', 'Yoxi'] },
        travel: { name: 'èˆªç©ºæ—…éŠ', items: ['ä¸­è¯èˆªç©º', 'é•·æ¦®èˆªç©º', 'æ—¥æœ¬èˆªç©º', 'å°ç£è™èˆª', 'æ¨‚æ¡ƒèˆªç©º', 'é…·èˆª', 'Trip.com', 'Booking.com', 'Hotels.com', 'AsiaYo', 'Expedia', 'KKday', 'Klook', 'é›„ç…æ—…éŠ', 'å¯æ¨‚æ—…éŠ', 'æ±å—æ—…éŠ', 'Agoda'] },
        overseas: { name: 'åœ‹å¤–å¯¦é«”', items: ['æ—¥æœ¬', 'éŸ“åœ‹', 'æ³°åœ‹', 'è¶Šå—', 'æ–°åŠ å¡', 'é¦¬ä¾†è¥¿äº', 'è²å¾‹è³“', 'ä¸­åœ‹', 'é¦™æ¸¯', 'æ¾³é–€', 'ç¾åœ‹', 'åŠ æ‹¿å¤§', 'è‹±åœ‹', 'æ³•åœ‹', 'å¾·åœ‹', 'ç¾©å¤§åˆ©', 'æ¾³æ´²'] },
        select: { name: 'ç²¾é¸å•†å®¶', items: ['Appleç›´ç‡Ÿåº—', 'å°ç±³å°ç£', 'å…¨åœ‹é›»å­', 'ç‡¦å¤', 'è¿ªå¡å„‚'] },
        esg: { name: 'ESGæ°¸çºŒ', items: ['ç‰å±±Walletæ„›å¿ƒææ¬¾', 'ç‰¹æ–¯æ‹‰', 'Gogoroé›»æ± è³‡è²»', 'YouBike 2.0'] }
    };

    function toggleUniChannelList() {
        const container = document.getElementById('uniChannelContainer');
        const btn = document.getElementById('btnToggleUniChannel');
        if (container.style.display === 'none') {
            container.style.display = 'block';
            btn.innerText = 'æ”¶åˆé€šè·¯ â–²';
            initUniChannelGrid();
        } else {
            container.style.display = 'none';
            btn.innerText = 'å±•é–‹é€šè·¯ â–¼';
        }
    }

    function initUniChannelGrid() {
        const container = document.getElementById('uniChannelContainer');
        if (!container) return;
        const saved = JSON.parse(localStorage.getItem('uni_channels') || '[]');
        container.innerHTML = '';

        Object.keys(uniChannelCategories).forEach(catId => {
            const cat = uniChannelCategories[catId];
            const section = document.createElement('div');
            section.style.cssText = 'margin-bottom:8px;';
            section.innerHTML = `<div style="font-size:11px; font-weight:bold; color:#555; margin-bottom:4px;">${cat.name}</div>`;
            const grid = document.createElement('div');
            grid.style.cssText = 'display:flex; flex-wrap:wrap; gap:4px;';
            cat.items.forEach(item => {
                const btn = document.createElement('div');
                const isActive = saved.includes(item);
                btn.className = 'brand-btn' + (isActive ? ' active' : '');
                btn.innerText = item;
                btn.onclick = () => {
                    const current = JSON.parse(localStorage.getItem('uni_channels') || '[]');
                    if (current.includes(item)) {
                        localStorage.setItem('uni_channels', JSON.stringify(current.filter(c => c !== item)));
                    } else if (current.length >= 8) {
                        alert('æœ€å¤šåªèƒ½é¸ 8 å€‹é€šè·¯');
                        return;
                    } else {
                        current.push(item);
                        localStorage.setItem('uni_channels', JSON.stringify(current));
                    }
                    initUniChannelGrid();
                };
                grid.appendChild(btn);
            });
            section.appendChild(grid);
            container.appendChild(section);
        });

        document.getElementById('uniChannelCount').innerText = `(${saved.length}/8)`;
    }

    function initUniBrandGrid() {
        const cycleKey = getUniBrandCycleKey();
        const selected = JSON.parse(localStorage.getItem(cycleKey) || '[]');
        
        Object.keys(uniBrandCategories).forEach(catId => {
            const grid = document.getElementById('uniBrandGrid-' + catId);
            if (!grid) return;
            grid.innerHTML = '';
            
            uniBrandCategories[catId].brands.forEach(brand => {
                const btn = document.createElement('div');
                btn.className = 'brand-btn' + (selected.includes(brand) ? ' active' : '');
                btn.innerText = brand;
                btn.onclick = () => { 
                    btn.classList.toggle('active'); 
                    saveUniBrands(); 
                };
                grid.appendChild(btn);
            });
        });
        
        updateTaskBonusDisplay();
    }

    // å„²å­˜ UniOpen å“ç‰Œé¸æ“‡ (æŒ‰é€±æœŸ)
    function saveUniBrands() {
        const cycleKey = getUniBrandCycleKey();
        const selected = [];
        
        Object.keys(uniBrandCategories).forEach(catId => {
            const grid = document.getElementById('uniBrandGrid-' + catId);
            if (!grid) return;
            grid.querySelectorAll('.brand-btn.active').forEach(btn => {
                selected.push(btn.innerText);
            });
        });
        
        localStorage.setItem(cycleKey, JSON.stringify(selected));
        updateTaskBonusDisplay();
        updateRewardPreview();
    }

    // å–å¾—ç•¶æœŸå·²é¸å“ç‰Œæ•¸
    function getUniBrandCount() {
        const cycleKey = getUniBrandCycleKey();
        const selected = JSON.parse(localStorage.getItem(cycleKey) || '[]');
        return selected.length;
    }

    function updateTaskBonusDisplay() {
        const count = getUniBrandCount();
        let bonus = 0;
        if (count >= 5) bonus = 4;
        else if (count >= 4) bonus = 3;
        else if (count >= 3) bonus = 2;
        else if (count >= 2) bonus = 1;
        const display = document.getElementById('taskBonusDisplay');
        if (display) {
            display.innerText = `ç›®å‰ ${count} å®¶ (åŠ ç¢¼ ${bonus}%)`;
        }
    }
      
    // ==========================================
    // Part 4: äº¤æ˜“è³‡æ–™ã€Toggle é‚è¼¯èˆ‡é‹ç®—æ ¸å¿ƒ (V126.1)
    // ==========================================

    function getTransactionsKey(cardId) { return `transactions_${cardId}`; }
    function getTransactions(cardId) { return JSON.parse(localStorage.getItem(getTransactionsKey(cardId)) || '[]'); }
    function saveTransactions(cardId, txs) { localStorage.setItem(getTransactionsKey(cardId), JSON.stringify(txs)); }
// å–å¾—è©²æœˆçš„å¯¦éš›çµå¸³æ—¥ï¼ˆè™•ç†å¤§å°æœˆï¼‰
function getActualCycleDay(year, month, cycleDay) {
    const lastDay = new Date(year, month + 1, 0).getDate();
    return Math.min(cycleDay, lastDay);
}
  function getCycleKey(cardId, dateInput) {
        const settings = cardSettings[cardId] || {};
        const cycleDay = parseInt(settings.cycleDay) || 0;
        
        // å¦‚æœæœ‰å‚³å…¥æ—¥æœŸå°±ç”¨é‚£å€‹æ—¥æœŸï¼Œå¦å‰‡ç”¨ä»Šå¤©
        let targetDate;
        if (dateInput) {
            targetDate = (typeof dateInput === 'string') ? new Date(dateInput) : dateInput;
        } else {
            targetDate = new Date();
        }
        
        let year = targetDate.getFullYear();
        let month = targetDate.getMonth() + 1;
        const day = targetDate.getDate();
        
        if (cycleDay && cycleDay > 0) {
            // å¦‚æœä»Šå¤©çš„æ—¥æœŸ > çµå¸³æ—¥ï¼Œè¡¨ç¤ºå·²é€²å…¥ä¸‹ä¸€å€‹é€±æœŸ
            if (day > cycleDay) {
                month++;
                if (month > 12) {
                    month = 1;
                    year++;
                }
            }
        }
        
        return `${year}-${month}`;
    }
    function getCurrentCycleTransactions(cardId) {
        const txs = getTransactions(cardId);
        const currentCycleKey = getCycleKey(cardId);
        
        return txs.filter(tx => {
            const txCycleKey = getCycleKey(cardId, tx.date);
            return txCycleKey === currentCycleKey;126.1
        });
    }

    function getUniOpenDailyPromo() {
        const now = new Date();
        const day = now.getDay();
        const date = now.getDate();
        const dn = ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'];
        let p = [];
        if (day===1) p.push('â˜• æ˜Ÿå·´å…‹å¤§æ¯ä»¥ä¸Šè²·ä¸€é€ä¸€(æœ€å¤šè²·äºŒé€äºŒ)');
        if (day===2) { p.push('â˜• æ˜Ÿå·´å…‹é£²æ–™+ç³•é»çµ„åˆ8æŠ˜'); p.push('ğŸ¦ COLD STONE é…·æ¨‚æ€è²·ä¸€é€ä¸€'); }
        if (day===3) p.push('ğŸ¬ çµ±ä¸€æ™‚ä»£/DREAM PLAZA åˆ·899é€$100åˆ¸');
        if (day===5) p.push('ğŸ¦ COLD STONE ä¸­æ¯ä»¥ä¸Šè²·ä¸€é€ä¸€');
        if (day===5||day===6||day===0) p.push('ğŸ½ï¸ å¤¢æ™‚ä»£æŒ‡å®šé¤é£² OP 8%');
        if (day===0) { p.push('ğŸ’„ åº·æ˜¯ç¾æ»¿$988è´ˆOP120é»'); p.push('ğŸŒ¿ è–å¾·ç§‘æ–¯æ»¿$688è´ˆ$50åˆ¸'); }
        if (date===1) p.push('ğŸ›’ å®¶æ¨‚ç¦OPEN Day åˆ·$799â†’$1åŠ è³¼');
        if (p.length===0) return '';
        return `ğŸ“… <b>ä»Šæ—¥(é€±${dn[day]})å“ç‰Œæ—¥</b><br>` + p.join('<br>') + '<hr style="margin:6px 0;border-color:#FFC107">';
    }

   function openCardModal(cardId) {
        if (cardId === 'add1') { openManageModal(); return; }
        const card = cards.find(c => c.id === cardId);
        if (!card) return;
        
        // â˜… é‡ç½®ç·¨è¼¯ç‹€æ…‹
        editingTxId = null;
        document.getElementById('btn-confirm').innerText = 'ç¢ºèª';
        
        document.getElementById('cardIdInput').value = cardId;
        document.getElementById('modalTitle').innerText = card.name;
        document.getElementById('modalSubtitle').innerText = card.note || '';
        document.getElementById('amountInput').value = '';
        document.getElementById('noteInput').value = '';
      const today = new Date();
document.getElementById('dateInput').value = today.getFullYear() + '-' + String(today.getMonth() + 1).padStart(2, '0') + '-' + String(today.getDate()).padStart(2, '0');
        document.getElementById('liveRewardCalc').style.display = 'none';
        document.getElementById('twdConversionDisplay').style.display = 'none';
        
        // éš±è—æ‰€æœ‰å¡ç‰‡å°ˆå±¬é¸é …
        const allOptions = ['pigRichOptions', 'greenCardOptions', 'uniOptions', 'happyOptions', 'hsbcOptions', 'uniOpenOptions', 'richartOptions', 'fubonJOptions', 'jiheOptions', 'kumamonOptions', 'sinopacCurrencyOptions', 'sinopacMitsuiOptions', 'jiangOptions', 'dbsEcoOptions', 'sinopacJcbOptions', 'laiDianOptions', 'legendOptions'];
        allOptions.forEach(id => { const el = document.getElementById(id); if (el) el.style.display = 'none'; });
        
        // éš±è—è­¦å‘Š
        document.getElementById('thresholdWarning').style.display = 'none';
        document.getElementById('detailProgressArea').style.display = 'none';
        document.getElementById('uniUpSuggestion').style.display = 'none';
        
        const parkingInfo = document.getElementById('modalParkingInfo');
        if (card.parking) {
            let parkingHtml = card.parking;
            if (card.id === 'c10') parkingHtml = getUniOpenDailyPromo() + parkingHtml;
            parkingInfo.innerHTML = parkingHtml;
            parkingInfo.style.display = 'block';
        } else parkingInfo.style.display = 'none';

        // é¡¯ç¤ºå°æ‡‰å¡ç‰‡çš„é¸é …
        showCardSpecificOptions(cardId);
        
        // æ ¹æ“šåœ°é»æ›´æ–°åœ‹å¤–è­¦å‘Š
        updateOverseasWarnings(cardId);
        
        historyMonthOffset = 0;
        renderModalHistory(cardId);
        document.getElementById('transactionModal').style.display = 'flex';
        history.pushState({ modal: true }, '');
    }

    function showCardSpecificOptions(cardId) {
        // C6 è±¬å¯Œå¡
        if (cardId === 'c6') {
            document.getElementById('pigRichOptions').style.display = 'block';
            // æ—¥æœ¬ PayPay æç¤º
            const overseasNote = document.getElementById('pigRichOverseasNote');
            if (currentLocation === 'JP') {
                overseasNote.style.display = 'block';
            } else {
                overseasNote.style.display = 'none';
            }
        }
        // C5 è³´é»å¡
        else if (cardId === 'c5') {
            document.getElementById('laiDianOptions').style.display = 'block';
            // åœ‹å¤–è­¦å‘Š
            const overseasWarning = document.getElementById('laiDianOverseasWarning');
            if (currentLocation !== 'TW') {
                overseasWarning.style.display = 'block';
            } else {
                overseasWarning.style.display = 'none';
            }
        }
        // C2 ç¶ å¡
        else if (cardId === 'c2') {
            document.getElementById('greenCardOptions').style.display = 'block';
        }
        // C7 UNIå¡
        else if (cardId === 'c7') {
            document.getElementById('uniOptions').style.display = 'block';
            loadUniSettings();
            // UPé¸ä¸éœ€è¦é¸é€šè·¯
            const uniSettings = JSON.parse(localStorage.getItem('uni_settings') || '{}');
            const channelSection = document.getElementById('uniChannelSection');
            if (channelSection) channelSection.style.display = uniSettings.isUp ? 'none' : 'block';
            // åœ‹å¤–è­¦å‘Š
            const overseasWarning = document.getElementById('uniOverseasWarning');
            if (currentLocation !== 'TW') {
                overseasWarning.style.display = 'block';
            } else {
                overseasWarning.style.display = 'none';
            }
        }
        // C8 æ¨‚å®¶+å¡
        else if (cardId === 'c8') {
            document.getElementById('happyOptions').style.display = 'block';
            loadHappySettings();
            // åœ‹å¤–è­¦å‘Š
            const overseasWarning = document.getElementById('happyOverseasWarning');
            if (currentLocation !== 'TW') {
                overseasWarning.style.display = 'block';
                // è‡ªå‹•å‹¾é¸åœ‹å¤–æ¶ˆè²»
                document.getElementById('checkHappyForeign').checked = true;
                document.getElementById('checkHappyPet').checked = false;
                document.getElementById('checkHappyLife').checked = false;
                document.getElementById('checkHappyPeace').checked = false;
            } else {
                overseasWarning.style.display = 'none';
            }
        }
        // C9 æ—…äººå¡
        else if (cardId === 'c9') {
            document.getElementById('hsbcOptions').style.display = 'block';
            loadHsbcSettings();
        }
        // C10 UniOpenå¡
        else if (cardId === 'c10') {
            document.getElementById('uniOpenOptions').style.display = 'block';
            initUniBrandGrid();
            // é‡ç½®é¸é … (é¿å…æ®˜ç•™)
            document.getElementById('checkUniGroup').checked = false;
            document.getElementById('checkUniIcash').checked = false;
            document.getElementById('checkUniOverseas').checked = false;
        }
        // C11 Richartå¡
        else if (cardId === 'c11') {
            document.getElementById('richartOptions').style.display = 'block';
            const jpRow = document.getElementById('rbRichartJpPaypayRow');
            if (currentLocation === 'JP') {
                jpRow.style.display = '';
                document.getElementById('rbRichartJpPaypay').checked = true;
            } else {
                jpRow.style.display = 'none';
                if (document.getElementById('rbRichartJpPaypay').checked)
                    document.getElementById('rbRichartGeneral').checked = true;
            }
            toggleRichartLogic();
        }
       // J1 å¯Œé‚¦Jå¡
        else if (cardId === 'j1') {
            document.getElementById('fubonJOptions').style.display = 'block';
            // æ ¹æ“šåœ°é»è‡ªå‹•è¨­å®šæ¨¡å¼
            updateFubonJByLocation();
        }
       // J2 å‰é¶´å¡
        else if (cardId === 'j2') {
            document.getElementById('jiheOptions').style.display = 'block';
            // æ ¹æ“šåœ°é»è‡ªå‹•è¨­å®šæ¨¡å¼
            updateJiheByLocation();
        }
        // J3 ç†Šæœ¬ç†Šå¡
        else if (cardId === 'j3') {
            document.getElementById('kumamonOptions').style.display = 'block';
            // æ ¹æ“šåœ°é»è‡ªå‹•è¨­å®šæ¨¡å¼
            updateKumamonByLocation();
        }
        // J4 å¹£å€å¡
        else if (cardId === 'j4') {
            document.getElementById('sinopacCurrencyOptions').style.display = 'block';
            loadCurrencyLevel();
        }
        // J5 ä¸‰äº•å¡
        else if (cardId === 'j5') {
            document.getElementById('sinopacMitsuiOptions').style.display = 'block';
        }
        // C12 JCBå¡
        else if (cardId === 'c12') {
            document.getElementById('sinopacJcbOptions').style.display = 'block';
            // æ ¹æ“šåœ°é»é é¸
            if (currentLocation === 'JP') {
                document.getElementById('checkSinopacJcbForeign').checked = true;
                document.getElementById('checkSinopacJcbBonus').checked = true;
            }
        }
        // C4 å°‡å°‡å¡
        else if (cardId === 'c4') {
            document.getElementById('jiangOptions').style.display = 'block';
            // æª¢æŸ¥æ—…éŠåŠ ç¢¼æ˜¯å¦éæœŸ
            const now = new Date();
           const expDate = new Date('2026-03-31');
            if (now > expDate) {
                document.getElementById('jiangTravelRow').classList.add('expired');
                document.getElementById('jiangTravelExpMsg').style.display = 'block';
            }
            // é¡¯ç¤ºä½æ¶ˆè­¦å‘Š
            updateJiangMinSpendWarning();
        }
        // DBS1 ecoå¡
        else if (cardId === 'dbs1') {
            document.getElementById('dbsEcoOptions').style.display = 'block';
        }
        // C1 å‚³èªªå°æ±ºå¡
        else if (cardId === 'c1') {
            document.getElementById('legendOptions').style.display = 'block';
        }
    }

    // æ›´æ–°åœ‹å¤–ç„¡åŠ ç¢¼è­¦å‘Š
    function updateOverseasWarnings(cardId) {
        const isOverseas = currentLocation !== 'TW';
        
        // C5 è³´é»å¡ - åœ‹å¤–ç„¡åŠ ç¢¼
        if (cardId === 'c5') {
            const rows = document.querySelectorAll('#laiDianOptions .option-row');
            rows.forEach(row => {
                if (isOverseas && !row.querySelector('input[value="general"]')) {
                    row.classList.add('overseas-disabled');
                } else {
                    row.classList.remove('overseas-disabled');
                }
            });
        }
        
        // C1 å‚³èªªå°æ±ºå¡ - åœ‹å¤–ç„¡åŠ ç¢¼
        if (cardId === 'c1') {
            const bonusRow = document.querySelector('#legendOptions .option-row:not(.read-only)');
            if (bonusRow) {
                if (isOverseas) {
                    bonusRow.classList.add('overseas-disabled');
                    document.getElementById('checkLegendBonus').checked = false;
                } else {
                    bonusRow.classList.remove('overseas-disabled');
                }
            }
        }
        
        // C7 UNIå¡ - åœ‹å¤–ç„¡åŠ ç¢¼
        if (cardId === 'c7') {
            const rows = document.querySelectorAll('#uniOptions .option-row:not(.read-only)');
            rows.forEach(row => {
                if (isOverseas) {
                    row.classList.add('overseas-disabled');
                } else {
                    row.classList.remove('overseas-disabled');
                }
            });
        }
        
        // C8 æ¨‚å®¶+å¡ - åœ‹å¤–åªæœ‰åœ‹å¤–åŠ ç¢¼
        if (cardId === 'c8') {
            const domesticOptions = ['checkHappyPet', 'checkHappyLife', 'checkHappyPeace'];
            domesticOptions.forEach(id => {
                const row = document.getElementById(id)?.closest('.option-row');
                if (row) {
                    if (isOverseas) {
                        row.classList.add('overseas-disabled');
                        document.getElementById(id).checked = false;
                    } else {
                        row.classList.remove('overseas-disabled');
                    }
                }
            });
        }
    }

    // Toggle é‚è¼¯å‡½æ•¸
    function toggleGreenLogic() {
        const isGreen = document.getElementById('checkGreenChannel').checked;
        const isForeign = document.getElementById('checkForeign').checked;
        if (isGreen && isForeign) document.getElementById('checkForeign').checked = false;
        updateRewardPreview();
    }

    function toggleForeignLogic() {
        const isForeign = document.getElementById('checkForeign').checked;
        const isGreen = document.getElementById('checkGreenChannel').checked;
        if (isForeign && isGreen) document.getElementById('checkGreenChannel').checked = false;
        updateRewardPreview();
    }

    function toggleUniUpLogic() {
        const isUp = document.getElementById('checkUniUp').checked;
        saveUniSettings();
        updateRewardPreview();
        
        // UPé¸ä¸éœ€è¦é¸é€šè·¯
        const channelSection = document.getElementById('uniChannelSection');
        if (channelSection) channelSection.style.display = isUp ? 'none' : 'block';
        
        // é¡¯ç¤º UP é¸å»ºè­°
        const suggestion = document.getElementById('uniUpSuggestion');
        if (!isUp) {
            const txs = getCurrentCycleTransactions('c7');
            const total = txs.reduce((sum, tx) => sum + (tx.amountTWD || tx.amount || 0), 0);
            if (total > 14900) {
                suggestion.innerHTML = 'ğŸ’¡ æ‚¨æœ¬æœˆæ¶ˆè²»å·²è¶…é $14,900ï¼Œå»ºè­°è¨‚é–± UP é¸å¯ç²å¾—æ›´å¤šå›é¥‹ï¼';
                suggestion.style.display = 'block';
            } else {
                suggestion.style.display = 'none';
            }
        } else {
            suggestion.style.display = 'none';
        }
    }

    function toggleUniGroup() {
    const isGroup = document.getElementById('checkUniGroup').checked;
    if (isGroup) {
        document.getElementById('checkUniOverseas').checked = false;
    }
    updateRewardPreview();
}
function toggleUniIcash() {
    const isIcash = document.getElementById('checkUniIcash').checked;
    if (isIcash) {
        document.getElementById('checkUniOverseas').checked = false;
    }
    updateRewardPreview();
}
function toggleUniOverseas() {
    const isOverseas = document.getElementById('checkUniOverseas').checked;
    if (isOverseas) {
        document.getElementById('checkUniGroup').checked = false;
        document.getElementById('checkUniIcash').checked = false;
    }
    updateRewardPreview();
}

    function toggleRichartLogic() {
        const mode = document.querySelector('input[name="richartMode"]:checked')?.value || 'general';
        const sub = document.getElementById('richartPlan33Sub');
        if (sub) sub.style.display = (mode === 'plan33') ? 'block' : 'none';
        const jpNote = document.getElementById('richartJpPaypayNote');
        if (jpNote) jpNote.style.display = (mode === 'jpPaypay') ? 'block' : 'none';
        // å„²å­˜ç•¶å‰æ–¹æ¡ˆåˆ° localStorageï¼ˆä¾›å¡é¢é¡¯ç¤ºï¼‰
        localStorage.setItem('richart_mode', mode);
        if (mode === 'plan33') {
            localStorage.setItem('richart_plan33', document.getElementById('selRichartPlan33')?.value || 'tianti');
        }
        updateRewardPreview();
        renderGrid();
    }

    // J1 å¯Œé‚¦Jå¡ï¼šå–å¾—ä½æ¶ˆé–€æª»é¡¯ç¤ºï¼ˆçµ±ä¸€ç”¨å°å¹£ï¼‰
    function getFubonJMinSpendDisplay(twdAmount) {
        return `éœ€å–®ç­†ç­‰å€¼å°å¹£ $${twdAmount.toLocaleString()}`;
    }
    
    // J1 å¯Œé‚¦Jå¡ï¼šæ›´æ–°ä½æ¶ˆé–€æª»é¡¯ç¤º
    function updateFubonJMinSpendDisplay() {
        const jpkrEl = document.getElementById('fubonJJpkrMinSpend');
        const suicaEl = document.getElementById('fubonJSuicaMinSpend');
        const thEl = document.getElementById('fubonJThMinSpend');
        
        if (jpkrEl) jpkrEl.innerText = 'âš ï¸ ' + getFubonJMinSpendDisplay(1000);
        if (suicaEl) suicaEl.innerText = 'âš ï¸ ' + getFubonJMinSpendDisplay(2000);
        if (thEl) thEl.innerText = 'âš ï¸ ' + getFubonJMinSpendDisplay(1000);
    }
    
    // J1 å¯Œé‚¦Jå¡ï¼šåˆ‡æ›æ—¥éŸ“æ¶ˆè²»
    function toggleFubonJJpkr() {
        const isJpkr = document.getElementById('checkFubonJJpkr').checked;
        const thSection = document.getElementById('fubonJThSection');
        
        if (isJpkr) {
            // åˆ‡æ›åˆ°æ—¥éŸ“æ¨¡å¼
            document.getElementById('labelFubonJBase').innerText = 'ğŸ”° æ—¥éŸ“æ¶ˆè²» 3% (ç„¡ä¸Šé™)';
            // ç¦ç”¨æ³°åœ‹å€å¡Š
            thSection.style.opacity = '0.4';
            thSection.style.pointerEvents = 'none';
            document.getElementById('checkFubonJTh').checked = false;
            document.getElementById('checkFubonJThBonus').checked = false;
        } else {
            // åˆ‡æ›åˆ°åœ‹å…§æ¨¡å¼
            document.getElementById('labelFubonJBase').innerText = 'ğŸ”° åœ‹å…§æ¶ˆè²» 1% (ç„¡ä¸Šé™)';
            // å•Ÿç”¨æ³°åœ‹å€å¡Š
            thSection.style.opacity = '1';
            thSection.style.pointerEvents = 'auto';
            // å–æ¶ˆæ—¥éŸ“åŠ ç¢¼
            document.getElementById('checkFubonJJpkrBonus').checked = false;
            document.getElementById('checkFubonJSuica').checked = false;
        }
        
        updateRewardPreview();
    }
    
    // J1 å¯Œé‚¦Jå¡ï¼šæ—¥éŸ“å¯¦é«”åŠ ç¢¼ï¼ˆè‡ªå‹•å‹¾æ—¥éŸ“æ¶ˆè²»ï¼Œèˆ‡äº¤é€šå¡äº’æ–¥ï¼‰
    function toggleFubonJJpkrBonus() {
        const isBonus = document.getElementById('checkFubonJJpkrBonus').checked;
        
        if (isBonus) {
            // è‡ªå‹•å‹¾é¸æ—¥éŸ“æ¶ˆè²»
            document.getElementById('checkFubonJJpkr').checked = true;
            toggleFubonJJpkr();
            // å–æ¶ˆäº¤é€šå¡
            document.getElementById('checkFubonJSuica').checked = false;
        }
        
        checkFubonJMinSpend();
        updateRewardPreview();
    }
    
    // J1 å¯Œé‚¦Jå¡ï¼šæ—¥æœ¬äº¤é€šå¡åŠ ç¢¼ï¼ˆè‡ªå‹•å‹¾æ—¥éŸ“æ¶ˆè²»ï¼Œèˆ‡æ—¥éŸ“å¯¦é«”äº’æ–¥ï¼‰
    function toggleFubonJSuica() {
        const isSuica = document.getElementById('checkFubonJSuica').checked;
        
        if (isSuica) {
            // è‡ªå‹•å‹¾é¸æ—¥éŸ“æ¶ˆè²»
            document.getElementById('checkFubonJJpkr').checked = true;
            toggleFubonJJpkr();
            // å–æ¶ˆæ—¥éŸ“å¯¦é«”
            document.getElementById('checkFubonJJpkrBonus').checked = false;
        }
        
        checkFubonJMinSpend();
        updateRewardPreview();
    }
    
    // J1 å¯Œé‚¦Jå¡ï¼šåˆ‡æ›æ³°åœ‹æ¶ˆè²»
    function toggleFubonJTh() {
        const isTh = document.getElementById('checkFubonJTh').checked;
        const jpkrSection = document.getElementById('fubonJJpkrSection');
        
        if (isTh) {
            // åˆ‡æ›åˆ°æ³°åœ‹æ¨¡å¼
            document.getElementById('labelFubonJBase').innerText = 'ğŸ”° æ³°åœ‹æ¶ˆè²» 1% (ç„¡ä¸Šé™)';
            // ç¦ç”¨æ—¥éŸ“å€å¡Š
            jpkrSection.style.opacity = '0.4';
            jpkrSection.style.pointerEvents = 'none';
            document.getElementById('checkFubonJJpkr').checked = false;
            document.getElementById('checkFubonJJpkrBonus').checked = false;
            document.getElementById('checkFubonJSuica').checked = false;
        } else {
            // åˆ‡æ›åˆ°åœ‹å…§æ¨¡å¼
            document.getElementById('labelFubonJBase').innerText = 'ğŸ”° åœ‹å…§æ¶ˆè²» 1% (ç„¡ä¸Šé™)';
            // å•Ÿç”¨æ—¥éŸ“å€å¡Š
            jpkrSection.style.opacity = '1';
            jpkrSection.style.pointerEvents = 'auto';
            // å–æ¶ˆæ³°åœ‹åŠ ç¢¼
            document.getElementById('checkFubonJThBonus').checked = false;
        }
        
        updateRewardPreview();
    }
    
    // J1 å¯Œé‚¦Jå¡ï¼šæ³°åœ‹å¯¦é«”åŠ ç¢¼ï¼ˆè‡ªå‹•å‹¾æ³°åœ‹æ¶ˆè²»ï¼‰
    function toggleFubonJThBonus() {
        const isBonus = document.getElementById('checkFubonJThBonus').checked;
        
        if (isBonus) {
            // è‡ªå‹•å‹¾é¸æ³°åœ‹æ¶ˆè²»
            document.getElementById('checkFubonJTh').checked = true;
            toggleFubonJTh();
        }
        
        checkFubonJMinSpend();
        updateRewardPreview();
    }
    
    // J1 å¯Œé‚¦Jå¡ï¼šæ ¹æ“šåœ°é»è‡ªå‹•è¨­å®šæ¨¡å¼
    function updateFubonJByLocation() {
        const jpkrSection = document.getElementById('fubonJJpkrSection');
        const thSection = document.getElementById('fubonJThSection');
        
        // å…ˆé‡ç½®æ‰€æœ‰ç‹€æ…‹
        jpkrSection.style.opacity = '1';
        jpkrSection.style.pointerEvents = 'auto';
        thSection.style.opacity = '1';
        thSection.style.pointerEvents = 'auto';
        
        if (currentLocation === 'JP' || currentLocation === 'KR') {
            // è‡ªå‹•åˆ‡æ›åˆ°æ—¥éŸ“æ¨¡å¼
            document.getElementById('checkFubonJJpkr').checked = true;
            document.getElementById('checkFubonJTh').checked = false;
            document.getElementById('checkFubonJThBonus').checked = false;
            document.getElementById('labelFubonJBase').innerText = 'ğŸ”° æ—¥éŸ“æ¶ˆè²» 3% (ç„¡ä¸Šé™)';
            thSection.style.opacity = '0.4';
            thSection.style.pointerEvents = 'none';
        } else if (currentLocation === 'TH') {
            // è‡ªå‹•åˆ‡æ›åˆ°æ³°åœ‹æ¨¡å¼
            document.getElementById('checkFubonJTh').checked = true;
            document.getElementById('checkFubonJJpkr').checked = false;
            document.getElementById('checkFubonJJpkrBonus').checked = false;
            document.getElementById('checkFubonJSuica').checked = false;
            document.getElementById('labelFubonJBase').innerText = 'ğŸ”° æ³°åœ‹æ¶ˆè²» 1% (ç„¡ä¸Šé™)';
            jpkrSection.style.opacity = '0.4';
            jpkrSection.style.pointerEvents = 'none';
        } else {
            // åœ‹å…§æ¨¡å¼
            document.getElementById('checkFubonJJpkr').checked = false;
            document.getElementById('checkFubonJTh').checked = false;
            document.getElementById('checkFubonJJpkrBonus').checked = false;
            document.getElementById('checkFubonJSuica').checked = false;
            document.getElementById('checkFubonJThBonus').checked = false;
            document.getElementById('labelFubonJBase').innerText = 'ğŸ”° åœ‹å…§æ¶ˆè²» 1% (ç„¡ä¸Šé™)';
        }
        
        // æ›´æ–°ä½æ¶ˆé–€æª»é¡¯ç¤º
        updateFubonJMinSpendDisplay();
    }
    
    // J1 å¯Œé‚¦Jå¡ï¼šæª¢æŸ¥ä½æ¶ˆ
    function checkFubonJMinSpend() {
        const amountRaw = parseFloat(document.getElementById('amountInput').value) || 0;
        const rate = getCurrentRate();
        const amountTWD = Math.round(amountRaw * rate);
        const warning = document.getElementById('fubonJMinSpendWarning');
        
        const isJpkrBonus = document.getElementById('checkFubonJJpkrBonus')?.checked;
        const isSuica = document.getElementById('checkFubonJSuica')?.checked;
        const isThBonus = document.getElementById('checkFubonJThBonus')?.checked;
        
        let minSpend = 0;
        let bonusType = '';
        
        if (isJpkrBonus) {
            minSpend = 1000;
            bonusType = 'æ—¥éŸ“å¯¦é«” +3%';
        } else if (isSuica) {
            minSpend = 2000;
            bonusType = 'æ—¥æœ¬äº¤é€šå¡ +7%';
        } else if (isThBonus) {
            minSpend = 1000;
            bonusType = 'æ³°åœ‹å¯¦é«” +5%';
        }
        
        if (minSpend > 0 && amountTWD > 0 && amountTWD < minSpend) {
            warning.innerHTML = `ğŸ”´ æœªé”ä½æ¶ˆé–€æª»ï¼ˆ${getFubonJMinSpendDisplay(minSpend)}ï¼‰ï¼Œç„¡æ³•äº«æœ‰${bonusType}`;
            warning.style.display = 'block';
        } else {
            warning.style.display = 'none';
        }
    }
    
    // ä¿ç•™èˆŠå‡½æ•¸åç¨±ä»¥ç›¸å®¹
    function toggleFubonJRegion() { updateRewardPreview(); }
    function toggleFubonJBonus() { updateRewardPreview(); }

   // å‰é¶´å¡ï¼šåˆ‡æ›æ—¥æœ¬æ¶ˆè²»
    function toggleJiheJapan() {
        const isJapan = document.getElementById('checkJiheJapan').checked;
        const domesticRow = document.getElementById('rowJiheDomesticJapanese');
        
        if (isJapan) {
            // åˆ‡æ›åˆ°æ—¥æœ¬æ¨¡å¼
            document.getElementById('labelJiheBase').innerText = 'ğŸ”° æ—¥æœ¬æ¶ˆè²» 2.5% (ç„¡ä¸Šé™)';
            // ç¦ç”¨ä¸¦å–æ¶ˆåœ‹å…§æ—¥ç³»é¸é …
            domesticRow.style.opacity = '0.4';
            domesticRow.style.pointerEvents = 'none';
            document.getElementById('checkJiheDomesticJapanese').checked = false;
        } else {
            // åˆ‡æ›åˆ°åœ‹å…§æ¨¡å¼
            document.getElementById('labelJiheBase').innerText = 'ğŸ”° åœ‹å…§æ¶ˆè²» 1% (ç„¡ä¸Šé™)';
            // å•Ÿç”¨åœ‹å…§æ—¥ç³»é¸é …
            domesticRow.style.opacity = '1';
            domesticRow.style.pointerEvents = 'auto';
            // å–æ¶ˆ Apple Pay
            document.getElementById('checkJiheApple').checked = false;
        }
        
        updateRewardPreview();
    }
    
    // å‰é¶´å¡ï¼šå‹¾é¸ Apple Pay è‡ªå‹•å‹¾æ—¥æœ¬æ¶ˆè²»
    function toggleJiheApple() {
        const isApple = document.getElementById('checkJiheApple').checked;
        
        if (isApple) {
            // è‡ªå‹•å‹¾é¸æ—¥æœ¬æ¶ˆè²»
            document.getElementById('checkJiheJapan').checked = true;
            toggleJiheJapan(); // æ›´æ–° UI ç‹€æ…‹
        }
        
        updateRewardPreview();
    }
    
    // å‰é¶´å¡ï¼šå‹¾é¸åœ‹å…§æ—¥ç³»
    function toggleJiheDomestic() {
        const isDomestic = document.getElementById('checkJiheDomesticJapanese').checked;
        
        if (isDomestic) {
            // å–æ¶ˆæ—¥æœ¬æ¨¡å¼å’Œ Apple Pay
            document.getElementById('checkJiheJapan').checked = false;
            document.getElementById('checkJiheApple').checked = false;
            // é‚„åŸåœ‹å…§æ¨¡å¼ UI
            document.getElementById('labelJiheBase').innerText = 'ğŸ”° åœ‹å…§æ¶ˆè²» 1% (ç„¡ä¸Šé™)';
        }
        
        updateRewardPreview();
    }
    
    // å‰é¶´å¡ï¼šæ ¹æ“šåœ°é»è‡ªå‹•è¨­å®šæ¨¡å¼
    function updateJiheByLocation() {
        const isJapan = currentLocation === 'JP';
        const domesticRow = document.getElementById('rowJiheDomesticJapanese');
        
        if (isJapan) {
            // è‡ªå‹•åˆ‡æ›åˆ°æ—¥æœ¬æ¨¡å¼
            document.getElementById('checkJiheJapan').checked = true;
            document.getElementById('labelJiheBase').innerText = 'ğŸ”° æ—¥æœ¬æ¶ˆè²» 2.5% (ç„¡ä¸Šé™)';
            domesticRow.style.opacity = '0.4';
            domesticRow.style.pointerEvents = 'none';
            document.getElementById('checkJiheDomesticJapanese').checked = false;
        } else {
            // åˆ‡æ›åˆ°åœ‹å…§æ¨¡å¼
            document.getElementById('checkJiheJapan').checked = false;
            document.getElementById('checkJiheApple').checked = false;
            document.getElementById('labelJiheBase').innerText = 'ğŸ”° åœ‹å…§æ¶ˆè²» 1% (ç„¡ä¸Šé™)';
            domesticRow.style.opacity = '1';
            domesticRow.style.pointerEvents = 'auto';
        }
    }
    
    // ä¿ç•™èˆŠå‡½æ•¸åç¨±ä»¥ç›¸å®¹
    function toggleJiheLogic() {
        toggleJiheJapan();
    }
    
    function updateJiheMinSpendWarning() {
        // ä½æ¶ˆæç¤ºå·²ç›´æ¥é¡¯ç¤ºåœ¨å„é¸é …ä¸‹æ–¹
    }

   // å°‡å°‡å¡åŠ ç¢¼äº’æ–¥ toggle
    function toggleJiangSelected() {
        if (document.getElementById('checkJiangSelected').checked) {
            document.getElementById('checkJiangTravel').checked = false;
        }
        updateJiangMinSpendWarning();
        updateRewardPreview();
    }
    
    function toggleJiangTravel() {
        if (document.getElementById('checkJiangTravel').checked) {
            document.getElementById('checkJiangSelected').checked = false;
        }
        updateJiangMinSpendWarning();
        updateRewardPreview();
    }

    // å°‡å°‡å¡ä½æ¶ˆè­¦å‘Š
    function updateJiangMinSpendWarning() {
        const warning = document.getElementById('jiangMinSpendWarning');
        const isSelected = document.getElementById('checkJiangSelected')?.checked || false;
        const isTravel = document.getElementById('checkJiangTravel')?.checked || false;
        const txs = getCurrentCycleTransactions('c4');
        const totalSpent = txs.reduce((sum, tx) => sum + (tx.amountTWD || tx.amount || 0), 0);
        
        let minSpend = 0;
        if (isSelected) {
            minSpend = 3000;
            warning.innerHTML = 'âš ï¸ éœ€ç•¶æœˆç´¯ç©æ»¿ $3,000 æ‰äº«åŠ ç¢¼å›é¥‹';
        } else if (isTravel) {
            minSpend = 6000;
            warning.innerHTML = 'âš ï¸ éœ€ç•¶æœˆç´¯ç©æ»¿ $6,000 æ‰äº«åŠ ç¢¼å›é¥‹';
        }
        
        if (minSpend > 0 && totalSpent < minSpend) {
            warning.style.display = 'block';
        } else {
            warning.style.display = 'none';
        }
    }

    function checkLaiDianMinSpend() {
        const amount = parseFloat(document.getElementById('amountInput').value) || 0;
        const mode = document.querySelector('input[name="laiDianMode"]:checked')?.value;
        const warning = document.getElementById('thresholdWarning');
        
        // æ¨¡å¼ç‚º lp æˆ– even æ™‚ï¼Œè‹¥é‡‘é¡ < 100ï¼Œæç¤ºåƒ…äº«åŸºæœ¬å›é¥‹
        if ((mode === 'lp' || mode === 'even') && amount > 0 && amount < 100) {
            warning.innerText = 'âš ï¸ æœªæ»¿ $100ï¼Œåƒ…äº« 1% å›é¥‹ (ç„¡åŠ ç¢¼)';
            warning.style.display = 'block';
        } else {
            warning.style.display = 'none';
        }
    }

    // ç†Šæœ¬ç†Šå¡ï¼šåˆ‡æ›æ—¥æœ¬æ¶ˆè²»
    function toggleKumamonJapan() {
        const isJapan = document.getElementById('checkKumamonJapan').checked;
        const payPaySection = document.getElementById('kumamonPayPaySection');
        
        if (isJapan) {
            // åˆ‡æ›åˆ°æ—¥æœ¬æ¨¡å¼
            document.getElementById('labelKumamonBase').innerText = 'ğŸ”° æ—¥æœ¬æ¶ˆè²» 2.5% (ç„¡ä¸Šé™)';
            document.getElementById('groupKumamonJapan').style.display = 'block';
            // ç¦ç”¨ PayPay ä¸¦å–æ¶ˆå‹¾é¸
            payPaySection.style.opacity = '0.4';
            payPaySection.style.pointerEvents = 'none';
            document.getElementById('checkKumamonPayPay').checked = false;
        } else {
            // åˆ‡æ›åˆ°åœ‹å…§æ¨¡å¼
            document.getElementById('labelKumamonBase').innerText = 'ğŸ”° åœ‹å…§æ¶ˆè²» 0.5% (ç„¡ä¸Šé™)';
            document.getElementById('groupKumamonJapan').style.display = 'none';
            document.getElementById('checkKumamonDesignated').checked = false;
            // å•Ÿç”¨ PayPay
            payPaySection.style.opacity = '1';
            payPaySection.style.pointerEvents = 'auto';
        }
        
        updateRewardPreview();
    }
    
    // ç†Šæœ¬ç†Šå¡ï¼šå‹¾é¸æŒ‡å®šé€šè·¯ï¼ˆè‡ªå‹•å‹¾æ—¥æœ¬æ¶ˆè²»ï¼‰
    function toggleKumamonDesignated() {
        const isDesignated = document.getElementById('checkKumamonDesignated').checked;
        
        if (isDesignated) {
            // è‡ªå‹•å‹¾é¸æ—¥æœ¬æ¶ˆè²»
            document.getElementById('checkKumamonJapan').checked = true;
            toggleKumamonJapan();
        }
        
        updateRewardPreview();
    }
    
    // ç†Šæœ¬ç†Šå¡ï¼šå‹¾é¸ PayPayï¼ˆèˆ‡æ—¥æœ¬æ¶ˆè²»äº’æ–¥ï¼‰
    function toggleKumamonPayPay() {
        const isPayPay = document.getElementById('checkKumamonPayPay').checked;
        const japanSection = document.getElementById('kumamonJapanSection');
        
        if (isPayPay) {
            // ç¦ç”¨æ—¥æœ¬æ¶ˆè²»å€å¡Šä¸¦å–æ¶ˆå‹¾é¸
            japanSection.style.opacity = '0.4';
            japanSection.style.pointerEvents = 'none';
            document.getElementById('checkKumamonJapan').checked = false;
            document.getElementById('checkKumamonDesignated').checked = false;
            document.getElementById('groupKumamonJapan').style.display = 'none';
            document.getElementById('labelKumamonBase').innerText = 'ğŸ”° åœ‹å…§æ¶ˆè²» 0.5% (ç„¡ä¸Šé™)';
        } else {
            // å•Ÿç”¨æ—¥æœ¬æ¶ˆè²»å€å¡Š
            japanSection.style.opacity = '1';
            japanSection.style.pointerEvents = 'auto';
        }
        
        updateRewardPreview();
    }
    
    // ç†Šæœ¬ç†Šå¡ï¼šæ ¹æ“šåœ°é»è‡ªå‹•è¨­å®šæ¨¡å¼
    function updateKumamonByLocation() {
        const japanSection = document.getElementById('kumamonJapanSection');
        const payPaySection = document.getElementById('kumamonPayPaySection');
        
        // å…ˆé‡ç½®æ‰€æœ‰ç‹€æ…‹
        japanSection.style.opacity = '1';
        japanSection.style.pointerEvents = 'auto';
        payPaySection.style.opacity = '1';
        payPaySection.style.pointerEvents = 'auto';
        
        if (currentLocation === 'JP') {
            // è‡ªå‹•åˆ‡æ›åˆ°æ—¥æœ¬æ¨¡å¼
            document.getElementById('checkKumamonJapan').checked = true;
            document.getElementById('checkKumamonPayPay').checked = false;
            toggleKumamonJapan();
        } else {
            // åˆ‡æ›åˆ°åœ‹å…§æ¨¡å¼
            document.getElementById('checkKumamonJapan').checked = false;
            document.getElementById('checkKumamonDesignated').checked = false;
            document.getElementById('checkKumamonPayPay').checked = false;
            document.getElementById('labelKumamonBase').innerText = 'ğŸ”° åœ‹å…§æ¶ˆè²» 0.5% (ç„¡ä¸Šé™)';
            document.getElementById('groupKumamonJapan').style.display = 'none';
        }
    }
    
    // ä¿ç•™èˆŠå‡½æ•¸åç¨±ä»¥ç›¸å®¹
    function toggleKumamonLogic() {
        toggleKumamonJapan();
    }
    
    function toggleKumamonSub(type) {
        if (type === 'designated') {
            toggleKumamonDesignated();
        } else if (type === 'paypay') {
            toggleKumamonPayPay();
        }
    }

    function toggleCurrencyLogic() { updateRewardPreview(); }

    function toggleSinopacMitsui(type) {
        if (type === 'selected') {
            if (document.getElementById('checkSinopacMitsuiSelected').checked) {
                document.getElementById('checkSinopacMitsuiTarget').checked = false;
            }
        } else if (type === 'target') {
            if (document.getElementById('checkSinopacMitsuiTarget').checked) {
                document.getElementById('checkSinopacMitsuiSelected').checked = false;
            }
        }
        updateRewardPreview();
    }

    function toggleDbsLogic(type) {
        const checkLinePay = document.getElementById('checkDbsLinePay');
        const checkGreen = document.getElementById('checkDbsGreen');
        const checkForeign = document.getElementById('checkDbsForeign');
        
        if (type === 'linepay' && checkLinePay.checked) {
            checkGreen.checked = false;
            checkForeign.checked = false;
        } else if (type === 'green' && checkGreen.checked) {
            checkLinePay.checked = false;
            checkForeign.checked = false;
        } else if (type === 'foreign' && checkForeign.checked) {
            checkLinePay.checked = false;
            checkGreen.checked = false;
        }
        updateRewardPreview();
    }

    // å¡ç‰‡è¨­å®šå­˜å–å‡½æ•¸
    function loadUniSettings() {
        const settings = JSON.parse(localStorage.getItem('uni_settings') || '{}');
        if (settings.isUp) document.getElementById('checkUniUp').checked = true;
    }
    function saveUniSettings() {
        localStorage.setItem('uni_settings', JSON.stringify({ isUp: document.getElementById('checkUniUp').checked }));
        renderGrid();
    }
function handleHappyExclusive(selected) {
        const pet = document.getElementById('checkHappyPet');
        const life = document.getElementById('checkHappyLife');
        const peace = document.getElementById('checkHappyPeace');
        const foreign = document.getElementById('checkHappyForeign');
        
        if (selected === 'pet' && pet.checked) {
            life.checked = false;
            peace.checked = false;
            foreign.checked = false;
        } else if (selected === 'life' && life.checked) {
            pet.checked = false;
            peace.checked = false;
            foreign.checked = false;
        } else if (selected === 'peace' && peace.checked) {
            pet.checked = false;
            life.checked = false;
            foreign.checked = false;
        } else if (selected === 'foreign' && foreign.checked) {
            pet.checked = false;
            life.checked = false;
            peace.checked = false;
        }
        
        updateRewardPreview();
    }
    function loadHappySettings() {
        const txs = getCurrentCycleTransactions('c8');
        let petSpent = 0, lifeSpent = 0, peaceSpent = 0;
        
        txs.forEach(tx => {
            const amount = tx.amountTWD || tx.amount || 0;
            if (tx.isHappyPet) petSpent += amount;
            if (tx.isHappyLife) lifeSpent += amount;
            if (tx.isHappyPeace) peaceSpent += amount;
        });
        
        const petLimit = 5263;
        const lifeLimit = 5714;
        const peaceLimit = 5714;
        
        document.getElementById('happyPetRemain').innerText = `(å·²åˆ·$${petSpent.toLocaleString()}/$${petLimit.toLocaleString()})`;
        document.getElementById('happyLifeRemain').innerText = `(å·²åˆ·$${lifeSpent.toLocaleString()}/$${lifeLimit.toLocaleString()})`;
        document.getElementById('happyPeaceRemain').innerText = `(å·²åˆ·$${peaceSpent.toLocaleString()}/$${peaceLimit.toLocaleString()})`;
    }

    function loadHsbcSettings() {
        const tier = localStorage.getItem('hsbc_tier') || 'infinite';
        document.querySelector(`input[name="hsbcTier"][value="${tier}"]`).checked = true;
        document.getElementById('hsbcInitialMiles').value = localStorage.getItem('hsbc_initial') || '';
        document.getElementById('hsbcRedeemedMiles').value = localStorage.getItem('hsbc_redeemed') || '';
    }
    function saveHsbcTier() {
        const tier = document.querySelector('input[name="hsbcTier"]:checked')?.value || 'infinite';
        localStorage.setItem('hsbc_tier', tier);
        updateRewardPreview();
        renderGrid();
    }
    function saveHsbcInitial() {
        localStorage.setItem('hsbc_initial', document.getElementById('hsbcInitialMiles').value || '0');
    }
    function saveHsbcSettings() {
        localStorage.setItem('hsbc_redeemed', document.getElementById('hsbcRedeemedMiles').value || '0');
    }

    function loadCurrencyLevel() {
        const level = localStorage.getItem('currency_level') || 'low';
        document.querySelector(`input[name="currencyLevel"][value="${level}"]`).checked = true;
    }
    function saveCurrencyLevel() {
        const level = document.querySelector('input[name="currencyLevel"]:checked')?.value || 'low';
        localStorage.setItem('currency_level', level);
        updateRewardPreview();
    }

    // å–å¾—äº¤æ˜“é¸é …
    function getTransactionOptions(cardId) {
        const options = {};
        
        if (cardId === 'c6') {
            options.isBonus10 = document.getElementById('checkBonus10')?.checked || false;
            options.isBonus25 = document.getElementById('checkBonus25')?.checked || false;
            options.isBill = document.getElementById('checkIsBill')?.checked || false;
        }
        else if (cardId === 'c5') {
            options.isNew = document.getElementById('checkLaiDianNew')?.checked || false;
            options.mode = document.querySelector('input[name="laiDianMode"]:checked')?.value || 'general';
        }
        else if (cardId === 'c2') {
            options.isGreen = document.getElementById('checkGreenChannel')?.checked || false;
            options.isForeign = document.getElementById('checkForeign')?.checked || false;
        }
        else if (cardId === 'c7') {
            options.isUp = document.getElementById('checkUniUp')?.checked || false;
            options.isBonus = document.getElementById('checkUniBonus')?.checked || false;
        }
        else if (cardId === 'c8') {
            options.isPet = document.getElementById('checkHappyPet')?.checked || false;
            options.isLife = document.getElementById('checkHappyLife')?.checked || false;
            options.isPeace = document.getElementById('checkHappyPeace')?.checked || false;
            options.isForeign = document.getElementById('checkHappyForeign')?.checked || false;
        }
        else if (cardId === 'c9') {
            options.isForeign = document.getElementById('checkHsbcForeign')?.checked || false;
            options.tier = document.querySelector('input[name="hsbcTier"]:checked')?.value || 'infinite';
        }
        else if (cardId === 'c10') {
            options.isGroup = document.getElementById('checkUniGroup')?.checked || false;
            options.isIcash = document.getElementById('checkUniIcash')?.checked || false;
            options.isOverseas = document.getElementById('checkUniOverseas')?.checked || false;
            options.brandCount = getUniBrandCount();
        }
        else if (cardId === 'c11') {
            options.mode = document.querySelector('input[name="richartMode"]:checked')?.value || 'general';
            options.plan33 = document.getElementById('selRichartPlan33')?.value || 'tianti';
        }
        else if (cardId === 'j1') {
            options.isJpkr = document.getElementById('checkFubonJJpkr')?.checked || false;
            options.isTh = document.getElementById('checkFubonJTh')?.checked || false;
            options.isJpkrBonus = document.getElementById('checkFubonJJpkrBonus')?.checked || false;
            options.isSuica = document.getElementById('checkFubonJSuica')?.checked || false;
            options.isThBonus = document.getElementById('checkFubonJThBonus')?.checked || false;
        }
        else if (cardId === 'j2') {
            options.isJapan = document.getElementById('checkJiheJapan')?.checked || false;
            options.isApple = document.getElementById('checkJiheApple')?.checked || false;
            options.isDomesticJapanese = document.getElementById('checkJiheDomesticJapanese')?.checked || false;
        }
        else if (cardId === 'j3') {
            options.isJapan = document.getElementById('checkKumamonJapan')?.checked || false;
            options.isDesignated = document.getElementById('checkKumamonDesignated')?.checked || false;
            options.isPayPay = document.getElementById('checkKumamonPayPay')?.checked || false;
        }
        else if (cardId === 'j4') {
            options.level = document.querySelector('input[name="currencyLevel"]:checked')?.value || 'low';
            options.isSelected = document.querySelector('input[name="currencyType"]:checked')?.value === 'selected';
        }
        else if (cardId === 'j5') {
            options.isSelected = document.getElementById('checkSinopacMitsuiSelected')?.checked || false;
            options.isTarget = document.getElementById('checkSinopacMitsuiTarget')?.checked || false;
        }
        else if (cardId === 'c12') {
            options.isForeign = document.getElementById('checkSinopacJcbForeign')?.checked || false;
            options.isBonus = document.getElementById('checkSinopacJcbBonus')?.checked || false;
            options.isQuarterly = document.getElementById('checkSinopacJcbQuarterly')?.checked || false;
        }
       else if (cardId === 'c4') {
            options.isJiangSelected = document.getElementById('checkJiangSelected')?.checked || false;
            options.isJiangTravel = document.getElementById('checkJiangTravel')?.checked || false;
        }
        else if (cardId === 'dbs1') {
            options.isLinePay = document.getElementById('checkDbsLinePay')?.checked || false;
            options.isGreen = document.getElementById('checkDbsGreen')?.checked || false;
            options.isForeign = document.getElementById('checkDbsForeign')?.checked || false;
        }
        else if (cardId === 'c1') {
            options.isBonus = document.getElementById('checkLegendBonus')?.checked || false;
        }
        
        return options;
    }

    // å›é¥‹é è¦½è¨ˆç®— (ä¿®å¾©ç‰ˆ)
    function updateRewardPreview() {
        const cardId = document.getElementById('cardIdInput').value;
        const amount = parseFloat(document.getElementById('amountInput').value) || 0;
        const liveCalc = document.getElementById('liveRewardCalc');
        
        if (amount <= 0) {
            liveCalc.style.display = 'none';
            if (cardId === 'j1') checkFubonJMinSpend();
            if (cardId === 'c5') checkLaiDianMinSpend();
            return;
        }
        
        let rate = getCurrentRate();
        if (editingTxId) {
            const txs = getTransactions(cardId);
            const editTx = txs.find(t => t.id === editingTxId);
            if (editTx && editTx.exchangeRate) rate = editTx.exchangeRate;
        }
        const amountTWD = Math.round(amount * rate);
        
        if (cardId === 'j1') checkFubonJMinSpend();
        if (cardId === 'c5') checkLaiDianMinSpend();
        
        // å–å¾—é¸é …
        const options = getTransactionOptions(cardId);
        
     // â˜… å°‡å°‡å¡ï¼šæª¢æŸ¥æ˜¯å¦é”ä½æ¶ˆ
        if (cardId === 'c4') {
            const isSelected = document.getElementById('checkJiangSelected')?.checked || false;
            const isTravel = document.getElementById('checkJiangTravel')?.checked || false;
            const hasBonus = isSelected || isTravel;
            const minSpend = isTravel ? 6000 : 3000;
            const txs = getCurrentCycleTransactions('c4');
            const totalSpent = txs.reduce((sum, tx) => sum + (tx.amountTWD || tx.amount || 0), 0);
            
            // æ›´æ–°è­¦èª
            updateJiangMinSpendWarning();
            
            // å°šæœªé”ä½æ¶ˆ
            if (hasBonus && totalSpent < minSpend) {
                const willReachMinSpend = (totalSpent + amountTWD) >= minSpend;
                
                if (!willReachMinSpend) {
                    // é€™ç­†åŠ ä¸Šå»é‚„æ˜¯ä¸å¤ ä½æ¶ˆï¼Œåªæœ‰åŸºæœ¬ 0.5%
                    const baseReward = Math.floor(amountTWD * 0.005);
                    liveCalc.style.display = 'block';
                    liveCalc.innerHTML = `é ä¼°ç²å¾— <b>$${baseReward}</b> å›é¥‹ (0.5%) <span style="color:#e65100; font-size:11px;"><br>âš ï¸ éœ€ç´¯ç©æ»¿$${minSpend.toLocaleString()}æ‰äº«åŠ ç¢¼</span>`;
                    updateTWDPreview();
                    return;
                }
            }
        }
        
       // â˜… æ¨‚å®¶å¡ï¼šæª¢æŸ¥æ˜¯å¦é”ä½æ¶ˆ $3,000ï¼ˆåœ‹å¤–æ¶ˆè²»ä¸éœ€è¦ä½æ¶ˆï¼‰
        if (cardId === 'c8') {
            const isForeign = document.getElementById('checkHappyForeign')?.checked || false;
            
            // åœ‹å¤–æ¶ˆè²»ä¸éœ€è¦ä½æ¶ˆï¼Œè·³éæª¢æŸ¥
            if (!isForeign) {
                const txs = getCurrentCycleTransactions('c8');
                const totalSpent = txs.reduce((sum, tx) => sum + (tx.amountTWD || tx.amount || 0), 0);
                const minSpend = 3000;
                const warning = document.getElementById('happyMinSpendWarning');
                
                if (totalSpent < minSpend) {
                    warning.style.display = 'block';
                    const willReachMinSpend = (totalSpent + amountTWD) >= minSpend;
                    
                    if (!willReachMinSpend) {
                        const baseReward = Math.floor(amountTWD * 0.005);
                        liveCalc.style.display = 'block';
                        liveCalc.innerHTML = `é ä¼°ç²å¾— <b>$${baseReward}</b> å›é¥‹ (0.5%) <span style="color:#e65100; font-size:11px;"><br>âš ï¸ éœ€ç´¯ç©æ»¿$3,000æ‰äº«åŠ ç¢¼</span>`;
                        updateTWDPreview();
                        return;
                    }
                } else {
                    warning.style.display = 'none';
                }
            } else {
                // åœ‹å¤–æ¶ˆè²»æ™‚éš±è—ä½æ¶ˆè­¦å‘Š
                const warning = document.getElementById('happyMinSpendWarning');
                if (warning) warning.style.display = 'none';
            }
        }
        
        // â˜… å‰é¶´å¡ Apple Pay ä½æ¶ˆæª¢æŸ¥
        if (cardId === 'j2') {
            const isApple = document.getElementById('checkJiheApple')?.checked || false;
            const isJapan = document.getElementById('checkJiheJapan')?.checked || false;
            
            if (isJapan && isApple && amountTWD < 100) {
                const baseReward = Math.floor(amountTWD * 0.025);
                liveCalc.style.display = 'block';
                liveCalc.innerHTML = `é ä¼°ç²å¾— <b>$${baseReward}</b> å›é¥‹ (2.5%) <span style="color:#e65100; font-size:11px;"><br>âš ï¸ æœªé”ä½æ¶ˆ $100ï¼Œç„¡æ³•äº«æœ‰ Apple Pay +1.5%</span>`;
                updateTWDPreview();
                return;
            }
        }
        
        // â˜… å‚³å…¥åŸå§‹é‡‘é¡ä¾›ä½æ¶ˆåˆ¤æ–·ä½¿ç”¨
        options.originalAmount = amount;
        const result = calculateSingleReward(cardId, amountTWD, options);

        
        liveCalc.style.display = 'block';
        
        if (cardId === 'c9') {
            liveCalc.innerHTML = `é ä¼°ç²å¾— <b>${result.reward}</b> å“©`;
        } else {
            liveCalc.innerHTML = `é ä¼°ç²å¾— <b>$${result.reward}</b> å›é¥‹ (${(result.rate * 100).toFixed(1)}%)`;
        }
        
        updateTWDPreview();
    }

    // æ–°å¢äº¤æ˜“ (ä¿®å¾©ï¼šåŠ å…¥ cardId æ¬„ä½)
   function addTransaction(closeAfter = true) {
        const cardId = document.getElementById('cardIdInput').value;
        const amountRaw = parseFloat(document.getElementById('amountInput').value);
        const note = document.getElementById('noteInput').value.trim();
        const dateVal = document.getElementById('dateInput').value;
        
        if (!amountRaw || amountRaw <= 0) {
            alert('è«‹è¼¸å…¥æœ‰æ•ˆé‡‘é¡');
            return;
        }
        
        const rate = getCurrentRate();
        const amountTWD = Math.round(amountRaw * rate);
        
        // â˜… ç·¨è¼¯æ¨¡å¼ï¼šä¿ç•™åŸ IDï¼›æ–°å¢æ¨¡å¼ï¼šç”¢ç”Ÿæ–° ID
        const txId = editingTxId || Date.now();
        
        const tx = {
            id: txId,
            cardId: cardId, // â˜… ä¿®å¾©ï¼šåŠ å…¥ cardId æ¬„ä½ï¼Œç¢ºä¿å‚™ä»½é‚„åŸä¸éºå¤±
            amount: amountRaw,
            amountTWD: amountTWD,
            currency: LOCATION_CONFIG[currentLocation].currency,
            location: currentLocation,
            exchangeRate: rate,
            note: note,
            date: dateVal,
            timestamp: new Date().toISOString(),
            // ä»¥ä¸‹ç‚ºå„å¡ç‰‡å°ˆå±¬é¸é …
            isBonus10: document.getElementById('checkBonus10')?.checked || false,
            isBonus25: document.getElementById('checkBonus25')?.checked || false,
            isBill: document.getElementById('checkIsBill')?.checked || false,
            isLaiDianNew: document.getElementById('checkLaiDianNew')?.checked || false,
            laiDianMode: document.querySelector('input[name="laiDianMode"]:checked')?.value || 'general',
            isGreenChannel: document.getElementById('checkGreenChannel')?.checked || false,
            isForeign: document.getElementById('checkForeign')?.checked || false,
            isUniUp: document.getElementById('checkUniUp')?.checked || false,
            isUniBonus: document.getElementById('checkUniBonus')?.checked || false,
            isHappyPet: document.getElementById('checkHappyPet')?.checked || false,
            isHappyLife: document.getElementById('checkHappyLife')?.checked || false,
            isHappyPeace: document.getElementById('checkHappyPeace')?.checked || false,
            isHappyForeign: document.getElementById('checkHappyForeign')?.checked || false,
            happyMode: (function() {
                if (document.getElementById('checkHappyPet')?.checked) return 'pet';
                if (document.getElementById('checkHappyLife')?.checked) return 'life';
                if (document.getElementById('checkHappyPeace')?.checked) return 'peace';
                if (document.getElementById('checkHappyForeign')?.checked) return 'foreign';
                return 'general';
            })(),
            isHsbcForeign: document.getElementById('checkHsbcForeign')?.checked || false,
            hsbcTier: document.querySelector('input[name="hsbcTier"]:checked')?.value || 'infinite',
            isUniGroup: document.getElementById('checkUniGroup')?.checked || false,
            isUniIcash: document.getElementById('checkUniIcash')?.checked || false,
            isUniOverseas: document.getElementById('checkUniOverseas')?.checked || false,
            uniBrandCount: getUniBrandCount(),
            richartMode: document.querySelector('input[name="richartMode"]:checked')?.value || 'general',
            richartPlan33: document.getElementById('selRichartPlan33')?.value || 'tianti',
            isFubonJJpkr: document.getElementById('checkFubonJJpkr')?.checked || false,
            isFubonJTh: document.getElementById('checkFubonJTh')?.checked || false,
            isFubonJJpkrBonus: document.getElementById('checkFubonJJpkrBonus')?.checked || false,
            isFubonJSuica: document.getElementById('checkFubonJSuica')?.checked || false,
            isFubonJThBonus: document.getElementById('checkFubonJThBonus')?.checked || false,
            isJiheJapan: document.getElementById('checkJiheJapan')?.checked || false,
            isJiheApple: document.getElementById('checkJiheApple')?.checked || false,
            isJiheDomesticJapanese: document.getElementById('checkJiheDomesticJapanese')?.checked || false,
            isKumamonJapan: document.getElementById('checkKumamonJapan')?.checked || false,
            isKumamonDesignated: document.getElementById('checkKumamonDesignated')?.checked || false,
            isKumamonPayPay: document.getElementById('checkKumamonPayPay')?.checked || false,
            currencyLevel: document.querySelector('input[name="currencyLevel"]:checked')?.value || 'low',
            isCurrencySelected: document.querySelector('input[name="currencyType"]:checked')?.value === 'selected',
            isSinopacMitsuiSelected: document.getElementById('checkSinopacMitsuiSelected')?.checked || false,
            isSinopacMitsuiTarget: document.getElementById('checkSinopacMitsuiTarget')?.checked || false,
            isSinopacJcbForeign: document.getElementById('checkSinopacJcbForeign')?.checked || false,
            isSinopacJcbBonus: document.getElementById('checkSinopacJcbBonus')?.checked || false,
            isSinopacJcbQuarterly: document.getElementById('checkSinopacJcbQuarterly')?.checked || false,
           isJiangSelected: document.getElementById('checkJiangSelected')?.checked || false,
            isJiangTravel: document.getElementById('checkJiangTravel')?.checked || false,
            isDbsLinePay: document.getElementById('checkDbsLinePay')?.checked || false,
            isDbsGreen: document.getElementById('checkDbsGreen')?.checked || false,
            isDbsForeign: document.getElementById('checkDbsForeign')?.checked || false,
            isLegendBonus: document.getElementById('checkLegendBonus')?.checked || false
        };
        
        let txs = getTransactions(cardId);
        
        // â˜… ç·¨è¼¯æ¨¡å¼ï¼šç§»é™¤èˆŠäº¤æ˜“å¾ŒåŠ å…¥æ›´æ–°å¾Œçš„äº¤æ˜“
        if (editingTxId) {
            txs = txs.filter(t => t.id !== editingTxId);
        }
        
        txs.push(tx);
        saveTransactions(cardId, txs);
        
        // â˜… é‡ç½®ç·¨è¼¯ç‹€æ…‹
        editingTxId = null;
        document.getElementById('btn-confirm').innerText = 'ç¢ºèª';
        
        if (cardId === 'c8') updateHappyUsed(tx);
        
        renderGrid();
        renderModalHistory(cardId);
        
        document.getElementById('amountInput').value = '';
        document.getElementById('noteInput').value = '';
        document.getElementById('liveRewardCalc').style.display = 'none';
        document.getElementById('twdConversionDisplay').style.display = 'none';
        
        if (closeAfter) {
            document.getElementById('transactionModal').style.display = 'none';
        } else {
            document.getElementById('amountInput').focus();
        }
    }

    function updateHappyUsed(tx) {
        const used = JSON.parse(localStorage.getItem('happy_used') || '{}');
        const cycleKey = getCycleKey('c8');
        if (!used[cycleKey]) used[cycleKey] = { pet: 0, life: 0, peace: 0 };
        
        const amount = tx.amountTWD || tx.amount;
        if (tx.isHappyPet || tx.happyMode === 'pet') {
            used[cycleKey].pet += Math.floor(amount * 0.095);
        } else if (tx.isHappyLife || tx.happyMode === 'life') {
            used[cycleKey].life += Math.floor(amount * 0.035);
        } else if (tx.isHappyPeace || tx.happyMode === 'peace') {
            used[cycleKey].peace += Math.floor(amount * 0.035);
        }
        localStorage.setItem('happy_used', JSON.stringify(used));
    }

    function shiftHistoryMonth(dir) {
        const newOffset = historyMonthOffset + dir;
        if (newOffset > 0) return;
        historyMonthOffset = newOffset;
        const cardId = document.getElementById('cardIdInput').value;
        renderModalHistory(cardId);
    }

    function getOffsetCycleTransactions(cardId, offset) {
        const txs = getTransactions(cardId);
        const settings = cardSettings[cardId] || {};
        const cycleDay = parseInt(settings.cycleDay) || 0;
        const target = new Date();
        target.setMonth(target.getMonth() + offset);
        const targetKey = getCycleKey(cardId, target);
        return txs.filter(tx => getCycleKey(cardId, tx.date) === targetKey);
    }

    function renderModalHistory(cardId) {
        const container = document.getElementById('modalHistoryList');
        const txs = (historyMonthOffset === 0) ? getCurrentCycleTransactions(cardId) : getOffsetCycleTransactions(cardId, historyMonthOffset);

        // æ›´æ–°æ¨™é¡Œ
        const label = document.getElementById('historyMonthLabel');
        const nextBtn = document.getElementById('historyNextBtn');
        if (historyMonthOffset === 0) {
            label.innerText = 'ğŸ“… æœ¬æœŸæ¶ˆè²»ç´€éŒ„';
            nextBtn.style.visibility = 'hidden';
        } else {
            const d = new Date();
            d.setMonth(d.getMonth() + historyMonthOffset);
            label.innerText = `ğŸ“… ${d.getFullYear()}/${d.getMonth() + 1} æ¶ˆè²»ç´€éŒ„`;
            nextBtn.style.visibility = 'visible';
        }

        if (txs.length === 0) {
            container.innerHTML = '<div style="text-align:center; color:#aaa; padding:20px; font-size:12px;">æœ¬æœŸå°šç„¡æ¶ˆè²»ç´€éŒ„</div>';
            return;
        }
        
        txs.sort((a, b) => {
            const dateA = parseFlexibleDate(a.date || a.timestamp);
            const dateB = parseFlexibleDate(b.date || b.timestamp);
            if (dateB - dateA !== 0) return dateB - dateA;
            const timeA = a.timestamp ? new Date(a.timestamp).getTime() : (a.id || 0);
            const timeB = b.timestamp ? new Date(b.timestamp).getTime() : (b.id || 0);
            return timeB - timeA;
        });
        
        container.innerHTML = '';
        const showCount = parseInt(container.dataset.showCount || '5');
        const displayTxs = txs.slice(0, showCount);
        displayTxs.forEach(tx => {
            const div = document.createElement('div');
            div.className = 'history-item';
            
            const txDate = parseFlexibleDate(tx.date);
            const txTime = tx.timestamp ? new Date(tx.timestamp) : (tx.id ? new Date(tx.id) : null);
            const timeStr = txTime ? txTime.toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit', hour12: false }) : '';
            const dateStr = txDate ?
                txDate.toLocaleDateString('zh-TW', { month: 'short', day: 'numeric' }) + (timeStr ? ' ' + timeStr : '') : '';
            const amount = tx.amountTWD || tx.amount || 0;
            const txLoc = tx.location || tx.loc || 'TW';
            const currency = tx.currency || LOCATION_CONFIG[txLoc]?.currency || 'TWD';
            
            let displayAmount;
            if (txLoc === 'TW' || currency === 'TWD') {
                displayAmount = `${amount.toLocaleString()} å…ƒ`;
            } else {
                displayAmount = `${(tx.amount || amount).toLocaleString()} ${currency}`;
            }
            
            div.innerHTML = `
                <div style="flex:1;" onclick="editTransaction('${cardId}', ${tx.id})">
                    <div class="h-name">${tx.note || '(ç„¡å‚™è¨»)'}</div>
                    <div class="h-date">${dateStr}</div>
                </div>
                <div class="h-amount">${displayAmount}</div>
                <button class="btn-delete-single" onclick="event.stopPropagation(); deleteTransaction('${cardId}', ${tx.id})">âœ•</button>
            `;
            container.appendChild(div);
       });
        if (txs.length > showCount) {
            const moreBtn = document.createElement('div');
            moreBtn.style.cssText = 'text-align:center; padding:10px; color:#007AFF; font-size:13px; cursor:pointer; border-top:1px solid #eee;';
            moreBtn.innerText = `è¼‰å…¥æ›´å¤š (é‚„æœ‰ ${txs.length - showCount} ç­†)`;
            moreBtn.onclick = () => { container.dataset.showCount = showCount + 10; renderModalHistory(cardId); };
            container.insertBefore(moreBtn, container.firstChild);
        }
    }

    function parseFlexibleDate(dateStr) {
        if (!dateStr) return null;
        if (dateStr instanceof Date) return dateStr;
        
        let d = new Date(dateStr);
        if (!isNaN(d.getTime())) return d;
        
        if (typeof dateStr === 'string' && dateStr.includes('/')) {
            d = new Date(dateStr.replace(/\//g, '-'));
            if (!isNaN(d.getTime())) return d;
        }
        return null;
    }

    function editTransaction(cardId, txId) {
        const txs = getTransactions(cardId);
        const tx = txs.find(t => t.id === txId);
        if (!tx) return;
        
        // æ¨™è¨˜ç‚ºç·¨è¼¯æ¨¡å¼ï¼ˆä¸ç«‹å³åˆªé™¤ï¼‰
        editingTxId = txId;
        
        // é‚„åŸåŸºæœ¬æ¬„ä½
        document.getElementById('amountInput').value = tx.amount;
        document.getElementById('noteInput').value = tx.note || '';
        
        if (tx.date) document.getElementById('dateInput').value = tx.date;
        
        
        // â˜… æ ¹æ“šå¡ç‰‡é¡å‹é‚„åŸæ‰€æœ‰å°ˆå±¬é¸é …
        if (cardId === 'c6') {
            document.getElementById('checkBonus10').checked = tx.isBonus10 || false;
            document.getElementById('checkBonus25').checked = tx.isBonus25 || false;
            document.getElementById('checkIsBill').checked = tx.isBill || false;
            if (tx.isBill) {
                document.getElementById('labelBaseRate').innerText = "ğŸ”° åŸºæœ¬å›é¥‹ 0.15% (ç„¡ä¸Šé™)";
            }
        }
        else if (cardId === 'c5') {
            document.getElementById('checkLaiDianNew').checked = tx.isLaiDianNew || false;
            const mode = tx.laiDianMode || 'general';
            document.querySelector(`input[name="laiDianMode"][value="${mode}"]`).checked = true;
        }
        else if (cardId === 'c2') {
            document.getElementById('checkGreenChannel').checked = tx.isGreenChannel || false;
            document.getElementById('checkForeign').checked = tx.isForeign || false;
        }
        else if (cardId === 'c7') {
            document.getElementById('checkUniUp').checked = tx.isUniUp || false;
            document.getElementById('checkUniBonus').checked = tx.isUniBonus || false;
        }
        else if (cardId === 'c8') {
            document.getElementById('checkHappyPet').checked = tx.isHappyPet || (tx.happyMode === 'pet') || false;
            document.getElementById('checkHappyLife').checked = tx.isHappyLife || (tx.happyMode === 'life') || false;
            document.getElementById('checkHappyPeace').checked = tx.isHappyPeace || (tx.happyMode === 'peace') || false;
            document.getElementById('checkHappyForeign').checked = tx.isHappyForeign || (tx.happyMode === 'foreign') || false;
        }
        else if (cardId === 'c9') {
            document.getElementById('checkHsbcForeign').checked = tx.isHsbcForeign || false;
            const tier = tx.hsbcTier || 'infinite';
            const tierRadio = document.querySelector(`input[name="hsbcTier"][value="${tier}"]`);
            if (tierRadio) tierRadio.checked = true;
        }
        else if (cardId === 'c10') {
            document.getElementById('checkUniGroup').checked = tx.isUniGroup || false;
            document.getElementById('checkUniIcash').checked = tx.isUniIcash || false;
            document.getElementById('checkUniOverseas').checked = tx.isUniOverseas || false;
        }
        else if (cardId === 'c11') {
            let mode = tx.richartMode || 'general';
            // ç›¸å®¹èˆŠç‰ˆï¼špayâ†’taishinpay, online/overseasâ†’plan33, lineâ†’linepay
            if (mode === 'pay') mode = 'taishinpay';
            else if (mode === 'online' || mode === 'overseas') mode = 'plan33';
            else if (mode === 'line') mode = 'linepay';
            const modeRadio = document.querySelector(`input[name="richartMode"][value="${mode}"]`);
            if (modeRadio) modeRadio.checked = true;
            if (mode === 'plan33' && tx.richartPlan33) {
                const sel = document.getElementById('selRichartPlan33');
                if (sel) sel.value = tx.richartPlan33;
            }
            toggleRichartLogic();
        }
        else if (cardId === 'j1') {
            // ç›¸å®¹èˆŠæ ¼å¼
            const oldRegion = tx.fubonJRegion || '';
            const oldBonus = tx.fubonJBonus || '';
            
            // é‚„åŸæ—¥éŸ“/æ³°åœ‹æ¶ˆè²»
            if (tx.isFubonJJpkr || oldRegion === 'jpkr') {
                document.getElementById('checkFubonJJpkr').checked = true;
                toggleFubonJJpkr();
            } else if (tx.isFubonJTh || oldRegion === 'th') {
                document.getElementById('checkFubonJTh').checked = true;
                toggleFubonJTh();
            }
            
            // é‚„åŸåŠ ç¢¼é¸é …
            if (tx.isFubonJJpkrBonus || oldBonus === 'jpkr_physical') {
                document.getElementById('checkFubonJJpkrBonus').checked = true;
            }
            if (tx.isFubonJSuica || oldBonus === 'suica') {
                document.getElementById('checkFubonJSuica').checked = true;
            }
            if (tx.isFubonJThBonus || oldBonus === 'th_physical') {
                document.getElementById('checkFubonJThBonus').checked = true;
            }
        }
        else if (cardId === 'j2') {
            document.getElementById('checkJiheJapan').checked = tx.isJiheJapan || false;
            document.getElementById('checkJiheApple').checked = tx.isJiheApple || false;
            document.getElementById('checkJiheDomesticJapanese').checked = tx.isJiheDomesticJapanese || false;
            if (tx.isJiheJapan) toggleJiheLogic();
        }
        else if (cardId === 'j3') {
            document.getElementById('checkKumamonJapan').checked = tx.isKumamonJapan || false;
            document.getElementById('checkKumamonDesignated').checked = tx.isKumamonDesignated || false;
            document.getElementById('checkKumamonPayPay').checked = tx.isKumamonPayPay || false;
            if (tx.isKumamonJapan) toggleKumamonLogic();
        }
        else if (cardId === 'j4') {
            const level = tx.currencyLevel || 'low';
            const levelRadio = document.querySelector(`input[name="currencyLevel"][value="${level}"]`);
            if (levelRadio) levelRadio.checked = true;
            const isSelected = tx.isCurrencySelected || false;
            document.querySelector(`input[name="currencyType"][value="${isSelected ? 'selected' : 'domestic'}"]`).checked = true;
        }
        else if (cardId === 'j5') {
            document.getElementById('checkSinopacMitsuiSelected').checked = tx.isSinopacMitsuiSelected || false;
            document.getElementById('checkSinopacMitsuiTarget').checked = tx.isSinopacMitsuiTarget || false;
        }
        else if (cardId === 'c12') {
            document.getElementById('checkSinopacJcbForeign').checked = tx.isSinopacJcbForeign || false;
            document.getElementById('checkSinopacJcbBonus').checked = tx.isSinopacJcbBonus || false;
            document.getElementById('checkSinopacJcbQuarterly').checked = tx.isSinopacJcbQuarterly || false;
        }
        else if (cardId === 'c4') {
            document.getElementById('checkJiangSelected').checked = tx.isJiangSelected || false;
            document.getElementById('checkJiangTravel').checked = tx.isJiangTravel || false;
            updateJiangMinSpendWarning();
        }
        else if (cardId === 'dbs1') {
            document.getElementById('checkDbsLinePay').checked = tx.isDbsLinePay || false;
            document.getElementById('checkDbsGreen').checked = tx.isDbsGreen || false;
            document.getElementById('checkDbsForeign').checked = tx.isDbsForeign || false;
        }
        else if (cardId === 'c1') {
            document.getElementById('checkLegendBonus').checked = tx.isLegendBonus || false;
        }
        
        // æ›´æ–°ç¢ºèªæŒ‰éˆ•æ–‡å­—
        document.getElementById('btn-confirm').innerText = 'æ›´æ–°';
        document.querySelector('.modal-content').scrollTop = 0;
        
        updateRewardPreview();
    }

  function deleteTransaction(cardId, txId, shouldRender = true, skipConfirm = false) {
        // â˜… è‹¥éè·³éç¢ºèªæ¨¡å¼ï¼Œé¡¯ç¤ºç¢ºèªå½ˆçª—
        if (!skipConfirm) {
            if (!confirm('ç¢ºå®šè¦åˆªé™¤é€™ç­†æ¶ˆè²»ç´€éŒ„å—ï¼Ÿ')) {
                return;
            }
        }
        
        let txs = getTransactions(cardId);
        txs = txs.filter(t => t.id !== txId);
        saveTransactions(cardId, txs);
        
        if (shouldRender) {
            renderGrid();
            renderModalHistory(cardId);
        }
    }

    function formatAmountWithCurrency(amountTWD) {
        if (currentLocation === 'TW') {
            return `${amountTWD.toLocaleString()} å…ƒ`;
        } else {
            const rate = getCurrentRate();
            const foreignAmount = Math.round(amountTWD / rate);
            return `${foreignAmount.toLocaleString()} ${LOCATION_CONFIG[currentLocation].currency}`;
        }
    }

    function getCardBonusSpent(cardId, filterFn) {
        const txs = getCurrentCycleTransactions(cardId);
        let total = 0;
        txs.forEach(tx => {
            if (filterFn(tx)) {
                total += (tx.amountTWD || tx.amount || 0);
            }
        });
        return total;
    }

    function getFubonJQuotaUsed() {
        const txs = getCurrentCycleTransactions('j1');
        let physicalSpent = 0, suicaSpent = 0;
        
       txs.forEach(tx => {
        const amount = tx.amountTWD || tx.amount || 0;
        const bonus = tx.fubonJBonus || 'none';
        const isPhysical = (bonus === 'jpkr_physical') || (bonus === 'th_physical') || tx.isFubonJJpkrBonus || tx.isFubonJThBonus;
        const isSuica = (bonus === 'suica') || tx.isFubonJSuica;
        
        if (isPhysical && amount >= 1000) {
            physicalSpent += amount;
        } else if (isSuica && amount >= 2000) {
            suicaSpent += amount;
        }
    });
        
        // å°é ‚é‡‘é¡ (æ¶ˆè²»é‡‘é¡)
        const physicalLimit = 33333; // æ—¥éŸ“å¯¦é«”åˆ· 33,333 å¯æ‹¿ 1,000 å›é¥‹
        const suicaLimit = 2857;     // äº¤é€šå¡åˆ· 2,857 å¯æ‹¿ 200 å›é¥‹
        
        return {
            physicalSpent,
            physicalLimit,
            physicalRemain: Math.max(0, physicalLimit - physicalSpent),
            suicaSpent,
            suicaLimit,
            suicaRemain: Math.max(0, suicaLimit - suicaSpent)
        };
    }
// â˜…â˜…â˜… è±¬å¯Œå¡å°é ‚é¡åº¦è¨ˆç®— (æ–°å¢) â˜…â˜…â˜…
    function getPigRichQuotaUsed() {
        const txs = getCurrentCycleTransactions('c6');
        let bonus10Spent = 0, bonus25Spent = 0;
        
        txs.forEach(tx => {
            const amount = tx.amountTWD || tx.amount || 0;
            if (tx.isBill) return;
            if (tx.isBonus10) bonus10Spent += amount;
            if (tx.isBonus25) bonus25Spent += amount;
        });
        
        return {
            bonus10Spent,
            bonus10Limit: 8000,
            bonus10Remain: Math.max(0, 8000 - bonus10Spent),
            bonus25Spent,
            bonus25Limit: 400000,
            bonus25Remain: Math.max(0, 400000 - bonus25Spent)
        };
    }

    // â˜…â˜…â˜… UniOpen å°é ‚é¡åº¦è¨ˆç®— (æ–°å¢) â˜…â˜…â˜…
    function getUniOpenQuotaUsed() {
        const txs = getCurrentCycleTransactions('c10');
        let groupSpent = 0, icashSpent = 0, overseasSpent = 0, brandSpent = 0;
        
        txs.forEach(tx => {
            const amount = tx.amountTWD || tx.amount || 0;
            if (tx.isUniOverseas) {
                overseasSpent += amount;
            } else {
                if (tx.isUniGroup) groupSpent += amount;
                if (tx.isUniIcash) icashSpent += amount;
                if (tx.isUniGroup && (tx.uniBrandCount || 0) >= 5) brandSpent += amount;
            }
        });
        
        return {
            groupSpent, groupLimit: 25000, groupRemain: Math.max(0, 25000 - groupSpent),
            icashSpent, icashLimit: 3750, icashRemain: Math.max(0, 3750 - icashSpent),
            overseasSpent, overseasLimit: 6250, overseasRemain: Math.max(0, 6250 - overseasSpent),
            brandSpent, brandLimit: 12500, brandRemain: Math.max(0, 12500 - brandSpent)
        };
    }
    // JCB å¡å°é ‚é¡åº¦è¨ˆç®—
    function getJcbQuotaUsed() {
        const txs = getCurrentCycleTransactions('c12');
        let bonusSpent = 0;
        
        txs.forEach(tx => {
            const amount = tx.amountTWD || tx.amount || 0;
            // æœ‰å‹¾é¸åŠ ç¢¼ (æ—¥æœ¬æˆ–ç‰¹é¸) çš„äº¤æ˜“æ‰è¨ˆå…¥
            if (tx.isSinopacJcbBonus) {
                bonusSpent += amount;
            }
        });
        
        // åŠ ç¢¼ä¸Šé™ $300/æœˆ (ç´„åˆ· $10,000)
        const bonusLimit = 10000;
        
        return {
            bonusSpent,
            bonusLimit,
            bonusRemain: Math.max(0, bonusLimit - bonusSpent)
        };
    }
      // å–®ç­†å›é¥‹è¨ˆç®—
    function calculateSingleReward(cardId, amount, options) {
        let reward = 0;
        let rate = 0;
        
        const card = cards.find(c => c.id === cardId);
        if (!card) return { reward: 0, rate: 0 };

       // C6 è±¬å¯Œå¡ (ä¿®å¾©ï¼šåŠ å…¥å°é ‚è¨ˆç®—)
        if (cardId === 'c6') {
            const quota = getPigRichQuotaUsed();
            
            if (options.isBill) {
                reward = Math.floor(amount * 0.0015);
                rate = 0.0015;
                if (options.isBonus10) {
                    if (quota.bonus10Spent < quota.bonus10Limit) {
                        const available10 = quota.bonus10Limit - quota.bonus10Spent;
                        const validFor10 = Math.min(amount, available10);
                        reward += Math.floor(validFor10 * 0.10);
                        rate = (amount > 0) ? (reward / amount) : 0.0015;
                    }
                }
            } else {
                let baseReward = Math.floor(amount * 0.01);
                reward = baseReward;
                rate = 0.01;
                
                if (options.isBonus10) {
                    if (quota.bonus10Spent >= quota.bonus10Limit) {
                        // å·²å°é ‚ï¼Œä¸åŠ ç¢¼
                    } else {
                        const available10 = quota.bonus10Limit - quota.bonus10Spent;
                        const validFor10 = Math.min(amount, available10);
                        reward += Math.floor(validFor10 * 0.10);
                    }
                }
                
                if (options.isBonus25) {
                    if (quota.bonus25Spent >= quota.bonus25Limit) {
                        // å·²å°é ‚ï¼Œä¸åŠ ç¢¼
                    } else {
                        const available25 = quota.bonus25Limit - quota.bonus25Spent;
                        const validFor25 = Math.min(amount, available25);
                        if (currentLocation === 'JP') {
                            reward += Math.floor(validFor25 * 0.01);
                        } else {
                            reward += Math.floor(validFor25 * 0.025);
                        }
                    }
                }
                
                rate = (amount > 0) ? (reward / amount) : 0.01;
            }
            return { reward, rate };
        }
        // C5 è³´é»å¡
        else if (cardId === 'c5') {
            let totalReward = Math.floor(amount * 0.01); // åŸºæœ¬ 1%
            
            // åœ‹å¤–åªæœ‰åŸºæœ¬ 1% (ä¸”éä¸€èˆ¬æ¶ˆè²»é¸é …æ™‚)
            if (currentLocation !== 'TW' && options.mode !== 'general') {
                return { reward: totalReward, rate: 0.01 };
            }

            // LP èˆ‡ å¶æ•¸æ—¥ æ¨¡å¼çš†éœ€å–®ç­†æ»¿ 100 æ‰äº«åŠ ç¢¼
            if (amount >= 100) {
                // 1. LINE Pay åŠ ç¢¼ (+1%)
                // åªè¦æ¨¡å¼æ˜¯ 'lp' æˆ– 'even' (å¶æ•¸æ—¥å¿…ç‚ºLP)ï¼Œéƒ½ç¬¦åˆæ­¤æ¢ä»¶
                if (options.mode === 'lp' || options.mode === 'even') {
                    // è¨ˆç®—å·²ä½¿ç”¨çš„ LP é¡åº¦ (åŒ…å« lp å’Œ even çš„äº¤æ˜“)
                    const lpSpent = getCardBonusSpent(cardId, t => (t.laiDianMode === 'lp' || t.laiDianMode === 'even') && (t.amountTWD || t.amount) >= 100);
                    
                    // LP +1% (é™åˆ·2è¬)
                    if (lpSpent < 20000) {
                        totalReward += Math.floor(Math.min(amount, 20000 - lpSpent) * 0.01);
                    }
                    
                    // æ–°æˆ¶ +4% (é™åˆ·7500ï¼Œéœ€ç¶å®š LP)
                    if (options.isNew) {
                        const newSpent = getCardBonusSpent(cardId, t => (t.laiDianMode === 'lp' || t.laiDianMode === 'even') && t.isLaiDianNew && (t.amountTWD || t.amount) >= 100);
                        if (newSpent < 7500) {
                            totalReward += Math.floor(Math.min(amount, 7500 - newSpent) * 0.04);
                        }
                    }
                }

                // 2. å¶æ•¸æ—¥åŠ ç¢¼ (+5%)
                if (options.mode === 'even') {
                    const evenSpent = getCardBonusSpent(cardId, t => t.laiDianMode === 'even' && (t.amountTWD || t.amount) >= 100);
                    // å¶æ•¸æ—¥ +5% (é™åˆ·3000)
                    if (evenSpent < 3000) {
                        totalReward += Math.floor(Math.min(amount, 3000 - evenSpent) * 0.05);
                    }
                }
            }
            
            rate = (amount > 0) ? (totalReward / amount) : 0.01;
            return { reward: totalReward, rate: rate };
        }
       // C2 ç¶ å¡ (ä¿®å¾©ï¼šç¶ è‰²é€šè·¯å°é ‚)
        else if (cardId === 'c2') {
            if (options.isForeign) {
                rate = 0.02;
                reward = Math.floor(amount * rate);
            } else if (options.isGreen) {
                const greenSpent = getCardBonusSpent(cardId, t => t.isGreenChannel);
                const greenLimit = 3000;
                const baseReward = Math.floor(amount * 0.01);
                
                if (greenSpent >= greenLimit) {
                    reward = baseReward;
                    rate = 0.01;
                } else {
                    const available = greenLimit - greenSpent;
                    const validForGreen = Math.min(amount, available);
                    reward = baseReward + Math.floor(validForGreen * 0.05);
                    rate = (amount > 0) ? (reward / amount) : 0.06;
                }
            } else {
                rate = 0.01;
                reward = Math.floor(amount * rate);
            }
            return { reward, rate };
        }
    // C7 UNIå¡ (ä¿®å¾©ï¼šåŠ å…¥å°é ‚è¨ˆç®—)
        else if (cardId === 'c7') {
            if (currentLocation !== 'TW') {
                rate = 0.01;
                reward = Math.floor(amount * rate);
            } else {
                const baseReward = Math.floor(amount * 0.01);
                reward = baseReward;
                
                // ä»»æ„é¸/UPé¸ åŠ ç¢¼
                const isUp = options.isUp;
                const bonusRate = isUp ? 0.035 : 0.025; // UPé¸+3.5%, ä»»æ„é¸+2.5%
                const bonusLimit = isUp ? 140000 : 40000;
               const bonusSpent = getCardBonusSpent(cardId, t => !editingTxId || t.id < editingTxId);
                
                if (bonusSpent < bonusLimit) {
                    const available = bonusLimit - bonusSpent;
                    const validForBonus = Math.min(amount, available);
                    reward += Math.floor(validForBonus * bonusRate);
                }
                
               // çµ±ä¸€æ™‚ä»£ä»»å‹™ +3%
                if (options.isBonus) {
                    const timeLimit = 16000;
                    const timeSpent = getCardBonusSpent(cardId, t => t.isUniBonus && (!editingTxId || t.id < editingTxId));
                    if (timeSpent < timeLimit) {
                        const available = timeLimit - timeSpent;
                        const validForTime = Math.min(amount, available);
                        reward += Math.floor(validForTime * 0.03);
                    }
                }
                
                rate = (amount > 0) ? (reward / amount) : 0.01;
            }
            return { reward, rate };
        }
   // C8 æ¨‚å®¶+å¡ (ä¿®å¾©ï¼šåœ‹å¤–æ¶ˆè²»ä¸éœ€ä½æ¶ˆï¼Œå…¶ä»–éœ€$3,000æ‰äº«åŠ ç¢¼)
        else if (cardId === 'c8') {
            const baseReward = Math.floor(amount * 0.005);
            reward = baseReward;
            
            // åœ‹å¤–æ¶ˆè²» +2% ç„¡ä¸Šé™ï¼Œä¸éœ€è¦ä½æ¶ˆ
            if (options.isForeign) {
                reward += Math.floor(amount * 0.02);
                rate = (amount > 0) ? (reward / amount) : 0.025;
                return { reward, rate };
            }
            
            // å…¶ä»–åŠ ç¢¼éœ€æª¢æŸ¥æ˜¯å¦é”ä½æ¶ˆ $3,000
            const txs = getCurrentCycleTransactions(cardId);
            const totalSpent = txs.reduce((sum, tx) => sum + (tx.amountTWD || tx.amount || 0), 0);
            const minSpend = 3000;
            const reachedMinSpend = (totalSpent + amount) >= minSpend;
            
            if (!reachedMinSpend) {
                // æœªé”ä½æ¶ˆï¼Œåªæœ‰åŸºæœ¬ 0.5%
                rate = 0.005;
                return { reward, rate };
            }
            
            if (options.isPet) {
                // å¯µç‰© +9.5%ï¼Œå›é¥‹ä¸Šé™ $500
                const petUsed = getCardBonusSpent(cardId, t => t.isHappyPet || t.happyMode === 'pet');
                const petRewardUsed = Math.floor(petUsed * 0.095);
                const petRewardRemain = Math.max(0, 500 - petRewardUsed);
                const thisPetReward = Math.min(Math.floor(amount * 0.095), petRewardRemain);
                reward += thisPetReward;
            } else if (options.isLife) {
                // ç”Ÿæ´» +3.5%ï¼Œå›é¥‹ä¸Šé™ $200
                const lifeUsed = getCardBonusSpent(cardId, t => t.isHappyLife || t.happyMode === 'life');
                const lifeRewardUsed = Math.floor(lifeUsed * 0.035);
                const lifeRewardRemain = Math.max(0, 200 - lifeRewardUsed);
                const thisLifeReward = Math.min(Math.floor(amount * 0.035), lifeRewardRemain);
                reward += thisLifeReward;
            } else if (options.isPeace) {
                // å®‰å¿ƒ +3.5%ï¼Œå›é¥‹ä¸Šé™ $200
                const peaceUsed = getCardBonusSpent(cardId, t => t.isHappyPeace || t.happyMode === 'peace');
                const peaceRewardUsed = Math.floor(peaceUsed * 0.035);
                const peaceRewardRemain = Math.max(0, 200 - peaceRewardUsed);
                const thisPeaceReward = Math.min(Math.floor(amount * 0.035), peaceRewardRemain);
                reward += thisPeaceReward;
            }
            
            rate = (amount > 0) ? (reward / amount) : 0.005;
            return { reward, rate };
        }
        // C9 æ—…äººå¡ (å“©ç¨‹)
        else if (cardId === 'c9') {
            const tier = options.tier || 'infinite';
            let milesPerDollar;
            if (options.isForeign) {
                milesPerDollar = (tier === 'infinite') ? 10 : 15;
            } else {
                milesPerDollar = 18;
            }
            reward = Math.floor(amount / milesPerDollar);
            rate = 1 / milesPerDollar;
            return { reward, rate };
        }
        
        // é è¨­
        // C10 UniOpenå¡ (ä¿®å¾©ï¼šå…ˆåŠ ç¸½å›é¥‹ç‡å†è¨ˆç®—)
        else if (cardId === 'c10') {
            const txs = getCurrentCycleTransactions('c10');
            let overseasSpent = 0, groupSpent = 0, icashSpent = 0, brandSpent = 0;
            txs.forEach(t => {
                if (editingTxId && t.id === editingTxId) return;
                const a = t.amountTWD || t.amount || 0;
                if (t.isUniOverseas) overseasSpent += a;
                else {
                    if (t.isUniGroup) groupSpent += a;
                    if (t.isUniIcash) icashSpent += a;
                    if (t.isUniGroup && (t.uniBrandCount || 0) >= 5) brandSpent += a;
                }
            });
            const quota = {
                overseasSpent, overseasLimit: 6250, overseasRemain: Math.max(0, 6250 - overseasSpent),
                groupSpent, groupLimit: 25000, groupRemain: Math.max(0, 25000 - groupSpent),
                icashSpent, icashLimit: 3750, icashRemain: Math.max(0, 3750 - icashSpent),
                brandSpent, brandLimit: 12500, brandRemain: Math.max(0, 12500 - brandSpent)
            };
            
            if (options.isOverseas) {
                // æµ·å¤–å¯¦é«” 11%
                const availableOverseas = Math.max(0, quota.overseasLimit - quota.overseasSpent);
                if (availableOverseas <= 0) {
                    // å·²å°é ‚ï¼Œåªæœ‰åŸºæœ¬ 1%
                    return { reward: Math.floor(amount * 0.01), rate: 0.01 };
                }
                const validForOverseas = Math.min(amount, availableOverseas);
                const overseasReward = Math.floor(validForOverseas * 0.11);
                const baseReward = Math.floor((amount - validForOverseas) * 0.01);
                reward = overseasReward + baseReward;
                rate = (availableOverseas >= amount) ? 0.11 : (amount > 0 ? (reward / amount) : 0.11);
            } else {
                // åœ‹å…§æ¶ˆè²»ï¼šåŸºæœ¬ + å„é …åŠ ç¢¼åˆ†é–‹ç®—å°é ‚
                reward = Math.floor(amount * 0.01);
                
                // çµ±ä¸€é›†åœ˜ +2%
                if (options.isGroup) {
                    const available = Math.max(0, quota.groupLimit - quota.groupSpent);
                    if (available > 0) {
                        reward += Math.floor(Math.min(amount, available) * 0.02);
                    }
                }
                
                // icash Pay +4%
                if (options.isIcash) {
                    const available = Math.max(0, quota.icashLimit - quota.icashSpent);
                    if (available > 0) {
                        reward += Math.floor(Math.min(amount, available) * 0.04);
                    }
                }
                
                // è¸©é»ä»»å‹™ +1%~4%
                const brandCount = options.brandCount || 0;
                if (brandCount >= 2 && options.isGroup) {
                    const available = Math.max(0, quota.brandLimit - quota.brandSpent);
                    if (available > 0) {
                        let brandRate = 0;
                        if (brandCount >= 5) brandRate = 0.04;
                        else if (brandCount >= 4) brandRate = 0.03;
                        else if (brandCount >= 3) brandRate = 0.02;
                        else brandRate = 0.01;
                        reward += Math.floor(Math.min(amount, available) * brandRate);
                    }
                }
                
                rate = (amount > 0) ? (reward / amount) : 0.01;
            }
            return { reward, rate };
        }
        // C11 Richartå¡
        else if (cardId === 'c11') {
            const mode = options.mode || 'general';
            if (mode === 'general') rate = 0.003;
            else if (mode === 'taishinpay') rate = 0.038;
            else if (mode === 'linepay') rate = 0.023;
            else if (mode === 'plan33') rate = 0.033;
            else if (mode === 'holiday') rate = 0.02;
            else if (mode === 'jpPaypay') rate = 0.053;
            // ç›¸å®¹èˆŠç‰ˆ mode å€¼
            else if (mode === 'pay') rate = 0.038;
            else if (mode === 'online' || mode === 'overseas') rate = 0.033;
            else if (mode === 'line') rate = 0.023;
            reward = Math.floor(amount * rate);
            return { reward, rate };
        }
        // è‡ªå»ºå¡ç‰‡
        else if (cardId.startsWith('custom_')) {
            rate = card.tier1Rate || 0;
            reward = Math.floor(amount * rate);
            return { reward, rate };
        }
       // J1 å¯Œé‚¦Jå¡ (å«å°é ‚åˆ¤æ–·)
        else if (cardId === 'j1') {
            const isJpkr = options.isJpkr || options.region === 'jpkr' || false;
            const isTh = options.isTh || options.region === 'th' || false;
            const isJpkrBonus = options.isJpkrBonus || options.bonus === 'jpkr_physical' || options.isFubonJJpkrBonus || false;
            const isSuica = options.isSuica || options.bonus === 'suica' || options.isFubonJSuica || false;
            const isThBonus = options.isThBonus || options.bonus === 'th_physical' || options.isFubonJThBonus || false;
            const quota = getFubonJQuotaUsed();
            
            // åŸºç¤å›é¥‹ (ç„¡ä¸Šé™)
            let baseRate = 0.01; // åœ‹å…§
            if (isJpkr) baseRate = 0.03;
            else if (isTh) baseRate = 0.01;
            
            reward = Math.floor(amount * baseRate);
            
            // åŠ ç¢¼å›é¥‹ (æª¢æŸ¥å‰©é¤˜é¡åº¦ï¼Œç”¨ TWD é‡‘é¡åˆ¤æ–·ä½æ¶ˆ)
            let bonusRate = 0;
            let cap = 0;
            let spent = 0;

            if (isJpkrBonus && amount >= 1000) {
                bonusRate = 0.03;
                cap = quota.physicalLimit;
                spent = quota.physicalSpent;
            } else if (isThBonus && amount >= 1000) {
                bonusRate = 0.05;
                cap = quota.physicalLimit;
                spent = quota.physicalSpent;
            } else if (isSuica && amount >= 2000) {
                bonusRate = 0.07;
                cap = quota.suicaLimit;
                spent = quota.suicaSpent;
            }

            if (bonusRate > 0) {
                const available = Math.max(0, cap - spent);
                const validForBonus = Math.min(amount, available);
                reward += Math.floor(validForBonus * bonusRate);
            }

            rate = (amount > 0) ? (reward / amount) : baseRate;
            return { reward, rate };
        }
       // J2 å‰é¶´å¡
        else if (cardId === 'j2') {
            if (options.isJapan) {
                let totalReward = Math.floor(amount * 0.025);
                let totalRate = 0.025;
                // Apple Pay ä½æ¶ˆé–€æª»ï¼šç­‰å€¼å°å¹£ $100
                if (options.isApple && amount >= 100) {
                    const appleSpent = getCardBonusSpent(cardId, t => t.isJiheJapan && t.isJiheApple);
                    if (appleSpent < 40000) {
                        totalReward += Math.floor(Math.min(amount, 40000 - appleSpent) * 0.015);
                        totalRate = 0.04; // 2.5% + 1.5% = 4%
                    }
                }
                return { reward: totalReward, rate: totalRate };
            } else {
                let totalReward = Math.floor(amount * 0.01);
                let totalRate = 0.01;
                // åœ‹å…§æ—¥ç³»ååº—ï¼ˆç„¡ä½æ¶ˆé–€æª»ï¼‰
                if (options.isDomesticJapanese) {
                    const djSpent = getCardBonusSpent(cardId, t => t.isJiheDomesticJapanese);
                    if (djSpent < 12500) {
                        totalReward += Math.floor(Math.min(amount, 12500 - djSpent) * 0.04);
                        totalRate = 0.05; // 1% + 4% = 5%
                    }
                }
                return { reward: totalReward, rate: totalRate };
            }
        }
       // J3 ç†Šæœ¬ç†Šå¡
        else if (cardId === 'j3') {
            // PayPay ç¨ç«‹è¨ˆç®—ï¼ˆä¸èˆ‡å…¶ä»–å›é¥‹ç–ŠåŠ ï¼‰
            if (options.isPayPay) {
                const paypayLimit = 2857;
                const paypaySpent = getCardBonusSpent(cardId, t => t.isKumamonPayPay);
                
                if (paypaySpent >= paypayLimit) {
                    // å·²å°é ‚ï¼Œå›é¥‹ 0%
                    return { reward: 0, rate: 0 };
                }
                
                const available = paypayLimit - paypaySpent;
                const validForPayPay = Math.min(amount, available);
                const payPayReward = Math.floor(validForPayPay * 0.05);
                // è¶…å‡ºå°é ‚çš„éƒ¨åˆ†ä¹Ÿæ˜¯ 0%
                
                return { reward: payPayReward, rate: (amount > 0) ? (payPayReward / amount) : 0.05 };
            }
            // æ—¥æœ¬æ¶ˆè²»
            if (options.isJapan) {
                let totalReward = Math.floor(amount * 0.025);
                if (options.isDesignated) {
                    const designatedSpent = getCardBonusSpent(cardId, t => t.isKumamonJapan && t.isKumamonDesignated);
                    if (designatedSpent < 8333) totalReward += Math.floor(Math.min(amount, 8333 - designatedSpent) * 0.06);
                }
                return { reward: totalReward, rate: totalReward / amount };
            }
            // åœ‹å…§ä¸€èˆ¬æ¶ˆè²»
            return { reward: Math.floor(amount * 0.005), rate: 0.005 };
        }
        // J4 å¹£å€å¡ (ä¿®å¾©ï¼šåŠ å…¥å°é ‚è¨ˆç®—)
        else if (cardId === 'j4') {
            const baseReward = Math.floor(amount * 0.01);
            reward = baseReward;
            
            if (options.isSelected) {
                const level = options.level || localStorage.getItem('currency_level') || 'low';
                const bonusLimit = (level === 'high') ? 20000 : 7500;
                const bonusSpent = getCardBonusSpent(cardId, t => t.isCurrencySelected);
                
                if (bonusSpent < bonusLimit) {
                    const available = bonusLimit - bonusSpent;
                    const validForBonus = Math.min(amount, available);
                    reward += Math.floor(validForBonus * 0.05);
                }
            }
            
            rate = (amount > 0) ? (reward / amount) : 0.01;
            return { reward, rate };
        }
        // J5 ä¸‰äº•å¡ (ä¿®å¾©ï¼šç‰¹é¸é¤é£²å›é¥‹ä¸Šé™)
        else if (cardId === 'j5') {
            const baseReward = Math.floor(amount * 0.003);
            reward = baseReward;
            
            if (options.isSelected) {
                // ç‰¹é¸é¤é£² +7%ï¼Œå›é¥‹ä¸Šé™ $100
                const selectedSpent = getCardBonusSpent(cardId, t => t.isSinopacMitsuiSelected);
                const selectedRewardUsed = Math.floor(selectedSpent * 0.07);
                const selectedRewardRemain = Math.max(0, 100 - selectedRewardUsed);
                const thisSelectedReward = Math.min(Math.floor(amount * 0.07), selectedRewardRemain);
                reward += thisSelectedReward;
            }
            
            rate = (amount > 0) ? (reward / amount) : 0.003;
            return { reward, rate };
        }
        // C12 JCBå¡ (ä¿®å¾©ï¼šåŠ å…¥å°é ‚è¨ˆç®—)
        else if (cardId === 'c12') {
            const quota = getJcbQuotaUsed();
            
            // åŸºç¤å›é¥‹
            let baseRate = 0.01; // åœ‹å…§ 1%
            if (options.isForeign) {
                baseRate = 0.02; // åœ‹å¤– 2%
            }
            
            let totalReward = Math.floor(amount * baseRate);
            
            // åŠ ç¢¼å›é¥‹ (+3%ï¼Œéœ€æª¢æŸ¥å°é ‚)
            if (options.isBonus) {
                const available = Math.max(0, quota.bonusLimit - quota.bonusSpent);
                if (available > 0) {
                    const validForBonus = Math.min(amount, available);
                    totalReward += Math.floor(validForBonus * 0.03);
                }
            }
            
            rate = (amount > 0) ? (totalReward / amount) : baseRate;
            return { reward: totalReward, rate };
        }
    // C4 å°‡å°‡å¡ (ä¿®å¾©ï¼šé”ä½æ¶ˆå¾Œå…¨éƒ¨å›æº¯äº«åŠ ç¢¼)
        else if (cardId === 'c4') {
            const isSelected = options.isJiangSelected || false;
            const isTravel = options.isJiangTravel || false;
            const txs = getCurrentCycleTransactions(cardId);
            const totalCycleSpent = txs.reduce((sum, tx) => sum + (tx.amountTWD || tx.amount || 0), 0);
            
            if (isSelected) {
                const minSpend = 3000;
                const selectedLimit = 6666;
                if ((totalCycleSpent + amount) < minSpend) {
                    return { reward: Math.floor(amount * 0.005), rate: 0.005 };
                }
                const selectedSpent = getCardBonusSpent(cardId, t => t.isJiangSelected && (!editingTxId || t.id !== editingTxId));
                if (selectedSpent >= selectedLimit) {
                    return { reward: Math.floor(amount * 0.005), rate: 0.005 };
                }
                const available = Math.min(amount, selectedLimit - selectedSpent);
                const bonusReward = Math.floor(available * 0.05);
                const baseReward = Math.floor((amount - available) * 0.005);
                return { reward: bonusReward + baseReward, rate: (bonusReward + baseReward) / amount };
           } else if (isTravel) {
                const minSpend = 6000;
                const travelLimit = 11111;
                if ((totalCycleSpent + amount) < minSpend) {
                    return { reward: Math.floor(amount * 0.005), rate: 0.005 };
                }
                const travelSpent = getCardBonusSpent(cardId, t => t.isJiangTravel && (!editingTxId || t.id !== editingTxId));
                if (travelSpent >= travelLimit) {
                    return { reward: Math.floor(amount * 0.005), rate: 0.005 };
                }
                const available = Math.min(amount, travelLimit - travelSpent);
                const bonusReward = Math.floor(available * 0.05);
                const baseReward = Math.floor((amount - available) * 0.005);
                return { reward: bonusReward + baseReward, rate: (bonusReward + baseReward) / amount };
            }
            return { reward: Math.floor(amount * 0.005), rate: 0.005 };
        }
       // DBS1 ecoå¡ (ä¿®å¾©ï¼šåŸºæœ¬å›é¥‹ + åŠ ç¢¼åˆ†é–‹è¨ˆç®—)
        else if (cardId === 'dbs1') {
            // åŸºæœ¬å›é¥‹ 1%ï¼ˆç„¡ä¸Šé™ï¼‰
            let baseReward = Math.floor(amount * 0.01);
            let bonusReward = 0;
            
            if (options.isLinePay) {
                // æ–°æˆ¶ LINE Pay +9%ï¼ˆåŠ ç¢¼ä¸Šé™ 1000 é»ï¼‰
                const lpSpent = getCardBonusSpent(cardId, t => t.isDbsLinePay);
                const lpBonusUsed = Math.floor(lpSpent * 0.09); // å·²ç”¨æ‰çš„åŠ ç¢¼é»æ•¸
                const lpBonusRemain = Math.max(0, 1000 - lpBonusUsed); // å‰©é¤˜å¯ç”¨åŠ ç¢¼é»æ•¸
                if (lpBonusRemain > 0) {
                    bonusReward = Math.min(Math.floor(amount * 0.09), lpBonusRemain);
                }
            } else if (options.isGreen) {
                // ç¶ è‰²/ç‰¹æ–¯æ‹‰ +9%ï¼ˆåŠ ç¢¼ä¸Šé™ 300 é»ï¼‰
                const greenSpent = getCardBonusSpent(cardId, t => t.isDbsGreen);
                const greenBonusUsed = Math.floor(greenSpent * 0.09);
                const greenBonusRemain = Math.max(0, 300 - greenBonusUsed);
                if (greenBonusRemain > 0) {
                    bonusReward = Math.min(Math.floor(amount * 0.09), greenBonusRemain);
                }
            } else if (options.isForeign) {
                // åœ‹å¤–å¯¦é«” +4%ï¼ˆæœˆåˆ· $15,000 å°é ‚ï¼‰
                const foreignSpent = getCardBonusSpent(cardId, t => t.isDbsForeign);
                const foreignRemain = Math.max(0, 15000 - foreignSpent);
                if (foreignRemain > 0) {
                    const validAmount = Math.min(amount, foreignRemain);
                    bonusReward = Math.floor(validAmount * 0.04);
                }
            }
            
            const totalReward = baseReward + bonusReward;
            const rate = (amount > 0) ? (totalReward / amount) : 0.01;
            return { reward: totalReward, rate: rate };
        }
        // C1 å‚³èªªå°æ±ºå¡
        else if (cardId === 'c1') {
            const baseReward = Math.floor(amount * 0.012);
            if (options.isBonus && currentLocation === 'TW') {
               const bonusSpent = getCardBonusSpent(cardId, t => t.isLegendBonus && (t.location || 'TW') === 'TW' && (!editingTxId || t.id < editingTxId));
                const limit = 11363;
                if (bonusSpent < limit) {
                    const available = Math.min(amount, limit - bonusSpent);
                    const totalReward = baseReward + Math.floor(available * 0.088);
            return { reward: totalReward, rate: (available >= amount) ? 0.10 : (amount > 0 ? (totalReward / amount) : 0.10) };
                }
            }
            return { reward: baseReward, rate: 0.012 };
        }
        
        // é è¨­
        rate = card.tier1Rate || 0.01;
        return { reward: Math.floor(amount * rate), rate };
    }

    function calculateStats(cardId) {
        const card = cards.find(c => c.id === cardId);
        if (!card || card.type === 'placeholder') return { spent: 0, reward: 0, progress: 0, msg: '' };
        
        if (cardId === 'j1') return calculateFubonJStats();
        if (cardId === 'c12') return calculateJcbStats();
        if (cardId === 'j3') return calculateKumamonStats();
        
        const txs = getCurrentCycleTransactions(cardId);
        let totalSpent = 0, totalReward = 0;
        
       let totalSpentForeign = 0;
       txs.forEach(tx => {
            const amount = tx.amountTWD || tx.amount || 0;
            totalSpent += amount;
            if (tx.location && tx.location !== 'TW' && tx.amount) totalSpentForeign += tx.amount;
        });
        
        const jiangMinSpend = 3000;
        const happyMinSpend = 3000;
       const jiangReachedMin = (cardId === 'c4') ? (totalSpent >= jiangMinSpend) : true;
        const happyReachedMin = (cardId === 'c8') ? (totalSpent >= happyMinSpend) : true;
        let legendBonusCumulative = 0;
        let uniBonusCumulative = 0;
        let uniTimeCumulative = 0;
        let jiangSelectedCumulative = 0;
        let jiangTravelCumulative = 0;
        let uniOpenGroupCumulative = 0;
        let uniOpenIcashCumulative = 0;
        let uniOpenOverseasCumulative = 0;
        
        txs.forEach(tx => {
            const amount = tx.amountTWD || tx.amount || 0;
            
            if (cardId === 'c4') {
            if (!jiangReachedMin) {
                totalReward += Math.floor(amount * 0.005);
            } else {
                let txReward = Math.floor(amount * 0.005);
                if (tx.isJiangSelected) {
                    const selectedLimit = 6666;
                    if (jiangSelectedCumulative < selectedLimit) {
                        const available = Math.min(amount, selectedLimit - jiangSelectedCumulative);
                        txReward = Math.floor(available * 0.05) + Math.floor((amount - available) * 0.005);
                    }
                    jiangSelectedCumulative += amount;
                } else if (tx.isJiangTravel) {
                    const travelLimit = 11111;
                    if (jiangTravelCumulative < travelLimit) {
                        const available = Math.min(amount, travelLimit - jiangTravelCumulative);
                        txReward = Math.floor(available * 0.05) + Math.floor((amount - available) * 0.005);
                    }
                    jiangTravelCumulative += amount;
                }
                totalReward += txReward;
            }
            } else if (cardId === 'c8') {
                if (!happyReachedMin) {
                    totalReward += Math.floor(amount * 0.005);
                } else {
                    const result = calculateTxRewardWithCap(cardId, tx);
                    totalReward += result.reward;
                }
            } else if (cardId === 'c1') {
                const baseReward = Math.floor(amount * 0.012);
                if (tx.isLegendBonus && (tx.location || 'TW') === 'TW') {
                    const limit = 11363;
                    if (legendBonusCumulative < limit) {
                        const available = Math.min(amount, limit - legendBonusCumulative);
                        totalReward += baseReward + Math.floor(available * 0.088);
                    } else {
                        totalReward += baseReward;
                    }
                    legendBonusCumulative += amount;
                } else {
                    totalReward += baseReward;
                }
            } else if (cardId === 'c7') {
        if (currentLocation !== 'TW') {
            totalReward += Math.floor(amount * 0.01);
        } else {
            const uniSettings = JSON.parse(localStorage.getItem('uni_settings') || '{}');
            const isUp = tx.isUniUp || uniSettings.isUp;
            const bonusRate = isUp ? 0.035 : 0.025;
            const bonusLimit = isUp ? 140000 : 40000;
            let txReward = Math.floor(amount * 0.01);
            if (uniBonusCumulative < bonusLimit) {
                const available = Math.min(amount, bonusLimit - uniBonusCumulative);
                txReward += Math.floor(available * bonusRate);
            }
            uniBonusCumulative += amount;
            if (tx.isUniBonus) {
                const timeLimit = 16000;
                if (uniTimeCumulative < timeLimit) {
                    const available = Math.min(amount, timeLimit - uniTimeCumulative);
                    txReward += Math.floor(available * 0.03);
                }
                uniTimeCumulative += amount;
            }
            totalReward += txReward;
        }
    } else if (cardId === 'c10') {
                let txReward = Math.floor(amount * 0.01);
                if (tx.isUniOverseas) {
                    const overseasLimit = 6250;
                    if (uniOpenOverseasCumulative < overseasLimit) {
                        const available = Math.min(amount, overseasLimit - uniOpenOverseasCumulative);
                        txReward = Math.floor(available * 0.11) + Math.floor((amount - available) * 0.01);
                    }
                    uniOpenOverseasCumulative += amount;
                } else {
                    let bonusRate = 0;
                    if (tx.isUniGroup) {
                        const groupLimit = 25000;
                        if (uniOpenGroupCumulative < groupLimit) bonusRate += 0.02;
                    }
                    if (tx.isUniIcash) {
                        const icashLimit = 3750;
                        if (uniOpenIcashCumulative < icashLimit) bonusRate += 0.04;
                    }
                    if (tx.isUniGroup && (tx.uniBrandCount || 0) >= 2) {
                        const bc = tx.uniBrandCount;
                        if (bc >= 5) bonusRate += 0.04;
                        else if (bc >= 4) bonusRate += 0.03;
                        else if (bc >= 3) bonusRate += 0.02;
                        else bonusRate += 0.01;
                    }
                    txReward = Math.floor(amount * (0.01 + bonusRate));
                    if (tx.isUniGroup) uniOpenGroupCumulative += amount;
                    if (tx.isUniIcash) uniOpenIcashCumulative += amount;
                }
                totalReward += txReward;
    } else {
        const result = calculateTxRewardWithCap(cardId, tx);
        totalReward += result.reward;
    }
        });
        
        let progress = 0, msg = '';
        let limit = card.limit || 99999999;
        
        // UNIå¡ï¼šæ ¹æ“šæ˜¯å¦ UP é¸èª¿æ•´å°é ‚
        if (cardId === 'c7') {
            const uniSettings = JSON.parse(localStorage.getItem('uni_settings') || '{}');
            limit = uniSettings.isUp ? 140000 : 40000;
        }
        const isOverseas = currentLocation !== 'TW';

        // ç‰¹æ®Šè™•ç†ï¼šRichartå¡ (c11) - ç„¡å°é ‚ï¼Œé¡¯ç¤ºæ–¹æ¡ˆå
        if (cardId === 'c11') {
            const rm = localStorage.getItem('richart_mode') || 'general';
            const rp = localStorage.getItem('richart_plan33') || 'tianti';
            const plan = getRichartPlanDisplay(rm, rp);
            msg = `${plan.name} ${plan.rate}`;
            progress = 0;
            return { spent: totalSpent, spentForeign: totalSpentForeign, reward: totalReward, progress, msg };
        }

        // ç‰¹æ®Šè™•ç†ï¼šUniOpen å¡ (c10)
        if (cardId === 'c10') {
            let groupSpent = 0, icashSpent = 0, overseasSpent = 0;
            txs.forEach(t => {
                const a = t.amountTWD || t.amount || 0;
                if (t.isUniOverseas) overseasSpent += a;
                if (t.isUniGroup) groupSpent += a;
                if (t.isUniIcash) icashSpent += a;
            });
            const groupLimit = 25000, icashLimit = 3750, overseasLimit = 6250;
            
           let parts = [];
            if (isOverseas) {
                if (overseasSpent >= overseasLimit) parts.push('æµ·å¤–å·²å°é ‚');
                else parts.push(`æµ·å¤–å¯å†åˆ· ${formatAmountWithCurrency(overseasLimit - overseasSpent)}`);
            } else {
                if (groupSpent >= groupLimit) parts.push('é›†åœ˜âš¡');
                else parts.push(`é›†åœ˜$${(groupLimit - groupSpent).toLocaleString()}`);
                
                if (icashSpent >= icashLimit) parts.push('icpâš¡');
                else parts.push(`icp$${(icashLimit - icashSpent).toLocaleString()}`);
            }
            
            msg = parts.join('/');
            const mainSpent = isOverseas ? overseasSpent : groupSpent;
            const mainLimit = isOverseas ? overseasLimit : groupLimit;
            progress = Math.min(100, (mainSpent / mainLimit) * 100);
            
            return { spent: totalSpent, spentForeign: totalSpentForeign, reward: totalReward, progress, msg };
        }

        // å…¨åŸŸåœ‹å¤–æ¨¡å¼å¼·åˆ¶å€’æ•¸ (é‡å°æœ‰æµ·å¤–ä¸Šé™çš„å¡ç‰‡)
        if (isOverseas) {
             // DBS eco (dbs1) - æµ·å¤–å¯¦é«”ä¸Šé™ 15000
             if (cardId === 'dbs1') {
                 const overseasLimit = 15000;
                 const overseasSpent = txs.reduce((sum, t) => (t.location !== 'TW' || t.isDbsForeign) ? sum + (t.amountTWD || t.amount) : sum, 0);
                 const remain = Math.max(0, overseasLimit - overseasSpent);
                 msg = (overseasSpent >= overseasLimit) ? 'æµ·å¤–åŠ ç¢¼å·²å°é ‚' : `æµ·å¤–å¯å†åˆ· ${formatAmountWithCurrency(remain)}`;
                 progress = Math.min(100, (overseasSpent / overseasLimit) * 100);
                 return { spent: totalSpent, spentForeign: totalSpentForeign, reward: totalReward, progress, msg };
             }
             // å¹£å€å¡ (j4) - æµ·å¤–ä¸Šé™ä¾ç­‰ç´š
             if (cardId === 'j4') {
                 const level = localStorage.getItem('currency_level') || 'low';
                 const currencyLimit = (level === 'high') ? 20000 : 7500;
                 const qualSpent = txs.reduce((sum, t) => (t.isCurrencySelected || t.isSinopacCurrencySelected) ? sum + (t.amountTWD || t.amount) : sum, 0);
                 const remain = Math.max(0, currencyLimit - qualSpent);
                 msg = (qualSpent >= currencyLimit) ? 'æµ·å¤–åŠ ç¢¼å·²å°é ‚' : `æµ·å¤–å¯å†åˆ· ${formatAmountWithCurrency(remain)}`;
                 progress = Math.min(100, (qualSpent / currencyLimit) * 100);
                 return { spent: totalSpent, spentForeign: totalSpentForeign, reward: totalReward, progress, msg };
             }
        }
        // ç‰¹æ®Šè™•ç†ï¼šæ¨‚å®¶å¡é¡¯ç¤ºå„é¡åˆ¥å°é ‚ç‹€æ…‹
        if (cardId === 'c8') {
            const txs = getCurrentCycleTransactions('c8');
            let petSpent = 0, lifeSpent = 0, peaceSpent = 0;
            
            txs.forEach(tx => {
                const amount = tx.amountTWD || tx.amount || 0;
                if (tx.isHappyPet) petSpent += amount;
                if (tx.isHappyLife) lifeSpent += amount;
                if (tx.isHappyPeace) peaceSpent += amount;
            });
            
            const petLimit = 5263;
            const lifeLimit = 5714;
            const peaceLimit = 5714;
            
            let statusParts = [];
            if (petSpent >= petLimit) {
                statusParts.push('å¯µç‰©å°é ‚');
            } else {
                statusParts.push(`å¯µç‰©$${(petLimit - petSpent).toLocaleString()}`);
            }
            if (lifeSpent >= lifeLimit) {
                statusParts.push('ç”Ÿæ´»å°é ‚');
            } else {
                statusParts.push(`ç”Ÿæ´»$${(lifeLimit - lifeSpent).toLocaleString()}`);
            }
            if (peaceSpent >= peaceLimit) {
                statusParts.push('å®‰å¿ƒå°é ‚');
            } else {
                statusParts.push(`å®‰å¿ƒ$${(peaceLimit - peaceSpent).toLocaleString()}`);
            }
            
            msg = statusParts.join('/');
            progress = Math.min(100, (totalSpent / 26000) * 100);
            
            return { spent: totalSpent, spentForeign: totalSpentForeign, reward: totalReward, progress, msg };
        }

        // ç‰¹æ®Šè™•ç†ï¼šæ—…äººå¡é¡¯ç¤ºç´¯ç©å“©ç¨‹
        if (cardId === 'c9') {
            const initial = parseInt(localStorage.getItem('hsbc_initial') || '0');
            const redeemed = parseInt(localStorage.getItem('hsbc_redeemed') || '0');
            
            // è¨ˆç®—æ­·å²ç¸½å›é¥‹ (ä¸åƒ…æ˜¯ç•¶æœŸ)
            const allTxs = getTransactions(cardId);
            let allTimeReward = 0;
            allTxs.forEach(tx => {
                 const res = calculateTxRewardWithCap(cardId, tx);
                 allTimeReward += res.reward;
            });
            
            const currentBalance = initial + allTimeReward - redeemed;
            msg = `ç›®å‰ç´¯ç© ${currentBalance.toLocaleString()} å“©`;
            progress = 50; // å›ºå®šé€²åº¦
            
            return { spent: totalSpent, spentForeign: totalSpentForeign, reward: totalReward, progress, msg };
        }

        // å„ªå…ˆç´š 1: ä½æ¶ˆä»»å‹™ (Min Spend Task)
        if (card.minSpend && totalSpent < card.minSpend) {
            const diff = card.minSpend - totalSpent;
            msg = `å·® ${formatAmountWithCurrency(diff)} é”ä½æ¶ˆ`;
            progress = Math.min(100, (totalSpent / card.minSpend) * 100);
        }
        // å„ªå…ˆç´š 2: é”æ¨™ä»»å‹™ (Target Task, e.g. ç¶ å¡åœè»Š)
        else if (card.type === 'floor' && totalSpent < (card.target || 0)) {
            const diff = (card.target || 0) - totalSpent;
            msg = `å·® ${formatAmountWithCurrency(diff)} é”æ¨™`;
            progress = Math.min(100, (totalSpent / card.target) * 100);
        }
        // å„ªå…ˆç´š 3: é¡åº¦å€’æ•¸ (Quota Countdown)
        else if (['ceiling', 'custom_happy', 'custom_legend', 'mixed', 'custom_j', 'uniopen_special', 'custom_mitsui', 'floor', 'custom_laidian'].includes(card.type)) {
            // æ³¨æ„ï¼šfloor é¡å‹é”æ¨™å¾Œï¼Œè‹¥ç„¡å…¶ä»– limit å®šç¾©ï¼Œé¡¯ç¤ºå·²é”æ¨™
            if (card.type === 'floor') {
                 msg = card.msgSuccess || 'å·²é”æ¨™';
                 progress = 100;
            }
            else if (card.type === 'uniopen_special' || card.type === 'custom_mitsui') {
                 msg = `æœ¬æœŸå·²åˆ· ${formatAmountWithCurrency(totalSpent)}`;
                 progress = (card.target && card.target > 0) ? Math.min(100, (totalSpent / card.target) * 100) : 0;
            }
            else if (card.type === 'custom_laidian') {
                 // è³´é»å¡å„ªå…ˆé¡¯ç¤ºå¶æ•¸æ—¥é¡åº¦
                 const evenSpent = getCardBonusSpent(cardId, t => t.laiDianMode === 'even' && (t.amountTWD || t.amount) >= 100);
                 const evenLimit = 3000;
                 if (evenSpent < evenLimit) {
                     const remain = evenLimit - evenSpent;
                     msg = `å¶æ•¸æ—¥å¯å†åˆ· ${formatAmountWithCurrency(remain)}`;
                     progress = (evenSpent / evenLimit) * 100;
                 } else {
                     const lpSpent = getCardBonusSpent(cardId, t => t.laiDianMode === 'lp' && (t.amountTWD || t.amount) >= 100);
                     const lpLimit = 20000;
                     const remain = Math.max(0, lpLimit - lpSpent);
                     msg = `LPå¯å†åˆ· ${formatAmountWithCurrency(remain)}`;
                     progress = (lpSpent / lpLimit) * 100;
                 }
            }
            else {
                // ä¸€èˆ¬å°é ‚è¨ˆç®—
                progress = Math.min(100, (totalSpent / limit) * 100);
                if (totalSpent >= limit) {
                    msg = card.msgDanger || 'å·²å°é ‚';
                } else {
                    const remainTWD = limit - totalSpent;
                    msg = `å¯å†åˆ· ${formatAmountWithCurrency(remainTWD)}`;
                }
            }
        } else if (card.type === 'miles') {
            // Fallback for generic miles if not c9
            msg = 'ç´¯ç©ä¸­';
            progress = 50;
        }
        
        return { spent: totalSpent, spentForeign: totalSpentForeign, reward: totalReward, progress, msg };
    }

    function calculateKumamonStats() {
        const txs = getCurrentCycleTransactions('j3');
        let totalSpent = 0, totalReward = 0, totalSpentForeign = 0;
        let designatedCumulative = 0, paypayCumulative = 0;
        
        const designatedLimit = 8333;
        const paypayLimit = 2857;
        
        txs.forEach(tx => {
            const amount = tx.amountTWD || tx.amount || 0;
            totalSpent += amount;
            if (tx.location && tx.location !== 'TW' && tx.amount) totalSpentForeign += tx.amount;
            
            if (tx.isKumamonPayPay) {
                if (paypayCumulative < paypayLimit) {
                    const available = Math.min(amount, paypayLimit - paypayCumulative);
                    totalReward += Math.floor(available * 0.05);
                }
                paypayCumulative += amount;
            } else if (tx.isKumamonJapan) {
                let txReward = Math.floor(amount * 0.025);
                if (tx.isKumamonDesignated) {
                    if (designatedCumulative < designatedLimit) {
                        const available = Math.min(amount, designatedLimit - designatedCumulative);
                        txReward += Math.floor(available * 0.06);
                    }
                    designatedCumulative += amount;
                }
                totalReward += txReward;
            } else {
                totalReward += Math.floor(amount * 0.005);
            }
        });
        
        let parts = [];
        if (currentLocation === 'JP') {
            if (designatedCumulative >= designatedLimit) parts.push('æŒ‡å®šâš¡');
            else parts.push(`æŒ‡å®š${formatAmountWithCurrency(designatedLimit - designatedCumulative)}`);
            
            if (paypayCumulative >= paypayLimit) parts.push('PPâš¡');
            else parts.push(`PP${formatAmountWithCurrency(paypayLimit - paypayCumulative)}`);
       } else {
            if (totalSpent > 0) parts.push(`åœ‹å…§ 0.5%`);
            else parts.push(`å¯åˆ·åœ‹å…§/æ—¥æœ¬`);
        }
        
        const msg = parts.join('/');
        const mainSpent = (currentLocation === 'JP') ? designatedCumulative : totalSpent;
        const mainLimit = (currentLocation === 'JP') ? designatedLimit : 99999;
        const progress = Math.min(100, (mainSpent / mainLimit) * 100);
        
        return { spent: totalSpent, spentForeign: totalSpentForeign, reward: totalReward, progress, msg };
    }

    function calculateFubonJStats() {
        const txs = getCurrentCycleTransactions('j1');
        const quota = getFubonJQuotaUsed();
        
        let totalSpent = 0, totalReward = 0;
        
       let totalSpentForeign = 0;
       txs.forEach(tx => {
        const amount = tx.amountTWD || tx.amount || 0;
        totalSpent += amount;
        if (tx.location && tx.location !== 'TW' && tx.amount) totalSpentForeign += tx.amount;
        const isJpkr = tx.isFubonJJpkr || (tx.fubonJRegion === 'jpkr');
        const isTh = tx.isFubonJTh || (tx.fubonJRegion === 'th');
        const baseRate = isJpkr ? 0.03 : isTh ? 0.01 : 0.01;
        totalReward += Math.floor(amount * baseRate);
        
        const bonus = tx.fubonJBonus || 'none';
        const isPhysicalJpkr = tx.isFubonJJpkrBonus || (bonus === 'jpkr_physical');
        const isPhysicalTh = tx.isFubonJThBonus || (bonus === 'th_physical');
        const isSuica = tx.isFubonJSuica || (bonus === 'suica');
        
        if (isPhysicalJpkr && amount >= 1000) {
            totalReward += Math.floor(Math.min(amount, Math.max(0, quota.physicalLimit - (quota.physicalSpent - amount))) * 0.03);
        } else if (isPhysicalTh && amount >= 1000) {
            totalReward += Math.floor(Math.min(amount, Math.max(0, quota.physicalLimit - (quota.physicalSpent - amount))) * 0.05);
        } else if (isSuica && amount >= 2000) {
            totalReward += Math.floor(Math.min(amount, Math.max(0, quota.suicaLimit - (quota.suicaSpent - amount))) * 0.07);
        }
    });
        
        const progress = Math.min(100, (quota.physicalSpent / quota.physicalLimit) * 100);
        
        // è¨Šæ¯é¡¯ç¤º (ç”¨æ¶ˆè²»é‡‘é¡)
        let msg = '';
        const physicalCapped = quota.physicalRemain <= 0;
        const suicaCapped = quota.suicaRemain <= 0;
        
        if (physicalCapped && suicaCapped) {
            msg = 'åŠ ç¢¼çš†å·²å°é ‚';
        } else if (physicalCapped) {
            msg = `å¯¦é«”å°é ‚ï½œäº¤é€šå¯å†åˆ· ${formatAmountWithCurrency(quota.suicaRemain)}`;
        } else if (suicaCapped) {
            msg = `å¯å†åˆ· ${formatAmountWithCurrency(quota.physicalRemain)}ï½œäº¤é€šå°é ‚`;
        } else {
            msg = `å¯å†åˆ· ${formatAmountWithCurrency(quota.physicalRemain)}ï½œäº¤é€š ${formatAmountWithCurrency(quota.suicaRemain)}`;
        }
        
        return { spent: totalSpent, spentForeign: totalSpentForeign, reward: totalReward, progress, msg };
    }

    // JCB å¡çµ±è¨ˆ (æ–°å¢)
    function calculateJcbStats() {
        const txs = getCurrentCycleTransactions('c12');
        const quota = getJcbQuotaUsed();
        
        let totalSpent = 0, totalReward = 0, totalSpentForeign = 0;
        
        txs.forEach(tx => {
            const amount = tx.amountTWD || tx.amount || 0;
            totalSpent += amount;
            if (tx.location && tx.location !== 'TW' && tx.amount) totalSpentForeign += tx.amount;
            
            // åŸºç¤å›é¥‹
            const baseRate = tx.isSinopacJcbForeign ? 0.02 : 0.01;
            totalReward += Math.floor(amount * baseRate);
        });
        
        // åŠ ç¢¼å›é¥‹ (å°é ‚ $300ï¼Œå³åˆ· $10,000)
        const bonusReward = Math.min(Math.floor(quota.bonusSpent * 0.03), 300);
        totalReward += bonusReward;
        
        const progress = Math.min(100, (quota.bonusSpent / quota.bonusLimit) * 100);
        
        let msg = '';
        if (quota.bonusRemain <= 0) {
            msg = 'åŠ ç¢¼å·²å°é ‚ (è®Š1%/2%)';
        } else {
            msg = `åŠ ç¢¼å¯å†åˆ· ${formatAmountWithCurrency(quota.bonusRemain)}`;
        }
        
        return { spent: totalSpent, spentForeign: totalSpentForeign, reward: totalReward, progress, msg };
    }

    function calculateStatsAllLocations(cardId) {
        return calculateStats(cardId);
    }

    function calculateTxRewardWithCap(cardId, tx) {
        const options = {
            ...tx,
           mode: tx.jiangMode || tx.laiDianMode || tx.richartMode || 'general',
            tier: tx.hsbcTier,
            brandCount: tx.uniBrandCount,
            region: tx.fubonJRegion,
            bonus: tx.fubonJBonus,
            level: tx.currencyLevel,
            isSelected: tx.isCurrencySelected || tx.isSinopacMitsuiSelected,
            isTarget: tx.isSinopacMitsuiTarget,
            isQuarterly: tx.isSinopacJcbQuarterly,
            isBonus: tx.isUniBonus || tx.isSinopacJcbBonus || tx.isLegendBonus,
            isNew: tx.isLaiDianNew,
            isJapan: tx.isJiheJapan || tx.isKumamonJapan,
            isApple: tx.isJiheApple,
            isDomesticJapanese: tx.isJiheDomesticJapanese,
            isDesignated: tx.isKumamonDesignated,
            isPayPay: tx.isKumamonPayPay,
            isPet: tx.isHappyPet,
            isLife: tx.isHappyLife,
            isPeace: tx.isHappyPeace,
            isForeign: tx.isForeign || tx.isHappyForeign || tx.isHsbcForeign || tx.isSinopacJcbForeign || tx.isDbsForeign,
            isGreen: tx.isGreenChannel || tx.isDbsGreen,
            isLinePay: tx.isDbsLinePay,
            isGroup: tx.isUniGroup,
            isIcash: tx.isUniIcash,
            isOverseas: tx.isUniOverseas,
            isUp: tx.isUniUp,
            isBonus10: tx.isBonus10,
            isBonus25: tx.isBonus25,
            isBill: tx.isBill
        };
        
        const result = calculateSingleReward(cardId, tx.amountTWD || tx.amount || 0, options);
        return result;
    }
function getCardDisplayName(card) {
        if (card.id === 'c9') {
            const tier = localStorage.getItem('hsbc_tier') || 'infinite';
            return tier === 'infinite' ? 'æ»™è±æ—…äººç„¡é™å¡' : 'æ»™è±æ—…äººå¾¡ç’½å¡';
        }
        if (card.id === 'c7') {
            const settings = JSON.parse(localStorage.getItem('uni_settings') || '{}');
            return settings.isUp ? 'ç‰å±± UNI å¡ï¼ˆUPé¸ï¼‰' : 'ç‰å±± UNI å¡';
        }
        return card.name;
    }
    function getRichartPlanDisplay(mode, plan33) {
        const plan33Names = { tianti: 'å¤©å¤©åˆ·', dabi: 'å¤§ç­†åˆ·', haoxiang: 'å¥½é¥—åˆ·', shuqu: 'æ•¸è¶£åˆ·', wanlv: 'ç©æ—…åˆ·' };
        switch (mode) {
            case 'taishinpay': return { name: 'Payè‘—åˆ·(å°æ–°Pay)', rate: '3.8%' };
            case 'linepay': return { name: 'Payè‘—åˆ·(LINE Pay)', rate: '2.3%' };
            case 'plan33': return { name: plan33Names[plan33] || 'å¤©å¤©åˆ·', rate: '3.3%' };
            case 'holiday': return { name: 'å‡æ—¥åˆ·', rate: '2%' };
            case 'jpPaypay': return { name: 'PayPay', rate: '5.3%' };
            // ç›¸å®¹èˆŠç‰ˆ
            case 'pay': return { name: 'Payè‘—åˆ·(å°æ–°Pay)', rate: '3.8%' };
            case 'online': return { name: 'æ•¸è¶£åˆ·', rate: '3.3%' };
            case 'overseas': return { name: 'ç©æ—…åˆ·', rate: '3.3%' };
            case 'line': return { name: 'Payè‘—åˆ·(LINE Pay)', rate: '2.3%' };
            default: return { name: 'ä¸€èˆ¬æ¶ˆè²»', rate: '0.3%' };
        }
    }

    function getCardMaxRate(card) {
        switch (card.id) {
            case 'c9': return '';
            case 'c7':
                const uniSettings = JSON.parse(localStorage.getItem('uni_settings') || '{}');
                return uniSettings.isUp ? '4.5%' : '3.5%';
            case 'c10': return '11%';
            case 'c6': return '13.5%';
            case 'c1': return '10%';
            case 'c5': return '11%';
            case 'c3': return '5%';
            case 'c4': return '5%';
            case 'c2': return '6%';
            case 'c8': return '10%';
            case 'c11': {
                const rm = localStorage.getItem('richart_mode') || 'general';
                const rp = localStorage.getItem('richart_plan33') || 'tianti';
                return getRichartPlanDisplay(rm, rp).rate;
            }
            case 'j1': return '10%';
            case 'j2': return '5%';
            case 'j3': return '8.5%';
            case 'j4': return '6%';
            case 'j5': return '7.3%';
            case 'c12': return '5%';
            case 'dbs1': return '10%';
          default:
                if (card.isCustom) {
                    return `${(card.tier1Rate * 100)}%`;
                }
                return '';
        }
    }
    function getCardDisplayNote(card) {
        // Richartå¡ï¼šé¡¯ç¤ºç•¶å‰æ–¹æ¡ˆ
        if (card.id === 'c11') {
            const rm = localStorage.getItem('richart_mode') || 'general';
            const rp = localStorage.getItem('richart_plan33') || 'tianti';
            const plan = getRichartPlanDisplay(rm, rp);
            return `${plan.name} ${plan.rate} (ç„¡ä¸Šé™)`;
        }
        // æ—…äººå¡ï¼šæ ¹æ“šç­‰ç´šé¡¯ç¤ºä¸åŒå…ƒ/å“©
        if (card.id === 'c9') {
            const tier = localStorage.getItem('hsbc_tier') || 'infinite';
            if (tier === 'infinite') {
                return 'åœ‹å…§ 18å…ƒ/å“© | åœ‹å¤– 10å…ƒ/å“©';
            } else {
                return 'åœ‹å…§ 18å…ƒ/å“© | åœ‹å¤– 15å…ƒ/å“©';
            }
        }
        // UNIå¡ï¼šæ ¹æ“šæ˜¯å¦è¨‚é–± UP é¡¯ç¤ºä¸åŒå›é¥‹ç‡å’Œå°é ‚
        if (card.id === 'c7') {
            const settings = JSON.parse(localStorage.getItem('uni_settings') || '{}');
            if (settings.isUp) {
                return 'UPé¸ 4.5% (åˆ·$14è¬å°é ‚)';
            } else {
                return 'ä»»æ„é¸ 3.5% (åˆ·$4è¬å°é ‚)';
            }
        }
        return card.note || '';
    }
    function renderGrid() {
        const grid = document.getElementById('card-grid');
        grid.innerHTML = '';
        
        const displayCards = getSortedCards();
        
        displayCards.forEach(card => {
            const tile = document.createElement('div');
            tile.className = 'card-tile';
            tile.style.background = card.gradient;
            tile.style.color = card.textColor;
            tile.setAttribute('data-card-id', card.id);
            tile.onclick = () => openCardModal(card.id);
            
            if (card.type === 'placeholder') {
                tile.innerHTML = `
                    <div class="tile-header">
                        <div class="tile-name">${getCardDisplayName(card)}</div>
                    <div class="tile-body">
                        <div class="tile-stat-group">
                            <div class="tile-stat-main">ï¼‹</div>
                            <div class="tile-stat-sub">${card.note}</div>
                        </div>
                    </div>
                `;
            } else {
                const stats = calculateStats(card.id);
                const nickname = cardSettings[card.id]?.nickname || card.nickname || '';
                const isMiles = card.type === 'miles';
                const rewardUnit = isMiles ? 'å“©' : 'å…ƒ';
                
                // æ¶ˆè²»é‡‘é¡é¡¯ç¤º
                let spentDisplay;
                if (currentLocation !== 'TW' && stats.spentForeign > 0) {
                    spentDisplay = `${stats.spentForeign.toLocaleString()} ${LOCATION_CONFIG[currentLocation].currency}`;
                } else {
                    spentDisplay = formatAmountWithCurrency(stats.spent);
                }
                
               let cycleHint = '';
const settings = cardSettings[card.id] || {};
const cycleDay = parseInt(settings.cycleDay);

if (cycleDay && cycleDay > 0) {
    const now = new Date();
    const today = now.getDate();
    const thisMonth = now.getMonth();
    const thisYear = now.getFullYear();
    
    // å–å¾—æœ¬æœˆå’Œä¸Šæœˆçš„å¯¦éš›çµå¸³æ—¥
    const actualCycleDayThisMonth = getActualCycleDay(thisYear, thisMonth, cycleDay);
    const actualCycleDayLastMonth = getActualCycleDay(thisYear, thisMonth - 1, cycleDay);
    
    let startDate, endDate;
    
    if (today > actualCycleDayThisMonth) {
        // æœ¬æœŸï¼šé€™å€‹æœˆ çµå¸³æ—¥+1 åˆ° ä¸‹å€‹æœˆ çµå¸³æ—¥
        const actualCycleDayNextMonth = getActualCycleDay(thisYear, thisMonth + 1, cycleDay);
        startDate = new Date(thisYear, thisMonth, actualCycleDayThisMonth + 1);
        endDate = new Date(thisYear, thisMonth + 1, actualCycleDayNextMonth);
    } else {
        // æœ¬æœŸï¼šä¸Šå€‹æœˆ çµå¸³æ—¥+1 åˆ° é€™å€‹æœˆ çµå¸³æ—¥
        startDate = new Date(thisYear, thisMonth - 1, actualCycleDayLastMonth + 1);
        endDate = new Date(thisYear, thisMonth, actualCycleDayThisMonth);
    }
    
    const sM = startDate.getMonth() + 1;
    const sD = startDate.getDate();
    const eM = endDate.getMonth() + 1;
    const eD = endDate.getDate();
    
    cycleHint = `${sM}/${sD} - ${eM}/${eD}`;
} else {
    const month = new Date().getMonth() + 1;
    cycleHint = `${month}æœˆ`;
}
                
                let overseasWarning = '';
                if (currentLocation !== 'TW') {
                    if (['c5', 'c1', 'c7'].includes(card.id)) {
                        overseasWarning = '<div class="tile-overseas-warning" style="display:block;">âš ï¸ åœ‹å¤–ç„¡åŠ ç¢¼</div>';
                    } else if (card.id === 'c8') {
                        overseasWarning = '<div class="tile-overseas-warning" style="display:block;">âš ï¸ åƒ…é™åœ‹å¤–+2%</div>';
                    }
                }
                
               tile.innerHTML = `
                    <div class="tile-nickname-badge ${nickname ? '' : 'placeholder'}">${nickname || ''}</div>
                    <div class="tile-header">
                        <div class="tile-name">${getCardDisplayName(card)}</div>
                      ${getCardMaxRate(card) ? `<span class="rate-badge">${getCardMaxRate(card)}</span>` : ''}
                    </div>
                    <span class="tile-note">${getCardDisplayNote(card)}</span>
                    <div class="tile-body">
                        <div class="tile-stat-group">
                            <div class="tile-stat-sub" style="margin-bottom:2px;">æœ¬æœŸå·²åˆ·</div>
                            <div class="tile-stat-main">${spentDisplay}</div>
                        </div>
                        <div class="tile-earned">+${stats.reward.toLocaleString()} ${rewardUnit}</div>
                    </div>
                    <div class="tile-footer">
                        <div class="progress-track"><div class="progress-fill" style="width:${stats.progress}%"></div></div>
                        <div class="tile-msg">${stats.msg}</div>
                        ${overseasWarning}
                        <div class="tile-cycle-hint ${card.textColor === '#333' ? 'dark-text' : ''}">${cycleHint}</div>
                    </div>
                `;
            }
            
            grid.appendChild(tile);
        });
        
        initSortable();
        updateTotalReward();
        updateDateDisplay();
        checkUrgentAlerts();
    }

    function updateTotalReward() {
        let totalCash = 0, totalMiles = 0;
        cards.forEach(card => {
            if (card.type === 'placeholder') return;
            const stats = calculateStats(card.id);
            if (card.type === 'miles') totalMiles += stats.reward;
            else totalCash += stats.reward;
        });
       let rewardHtml = '';
        if (totalCash > 0 && totalMiles > 0) {
            rewardHtml = `$${totalCash.toLocaleString()}<div style="font-size:60%; opacity:0.7; margin-top:2px;">âœˆï¸ ${totalMiles.toLocaleString()} å“©</div>`;
        } else if (totalMiles > 0) {
            rewardHtml = `${totalMiles.toLocaleString()} å“©`;
        } else {
            rewardHtml = `$${totalCash.toLocaleString()}`;
        }
        document.getElementById('totalRewardDisplay').innerHTML = rewardHtml;
        
        const breakdownEl = document.getElementById('totalRewardBreakdown');
        if (breakdownEl) breakdownEl.style.display = 'none';
    }

    function updateDateDisplay() {
        const dateStr = new Date().toLocaleDateString('zh-TW', { month: 'long', day: 'numeric', weekday: 'short' });
        document.getElementById('dateDisplay').innerText = dateStr;
    }

    function checkUrgentAlerts() {
        document.getElementById('urgent-alert-area').style.display = 'none';
    }

    function openManageModal() {
        renderManageList();
        renderScenes();
        document.getElementById('manageModal').style.display = 'flex';
        history.pushState({ modal: true }, '');
    }

    function renderManageList() {
        const container = document.getElementById('manageCardList');
        container.innerHTML = '';
        
        cards.forEach(card => {
            if (card.id === 'add1') return;
            
            const isActive = visibleCards.includes(card.id);
            const nickname = cardSettings[card.id]?.nickname || '';
            
            const btn = document.createElement('div');
            btn.className = 'manage-card-btn' + (isActive ? ' active' : '');
            btn.setAttribute('data-card-id', card.id);
            
            const settingHtml = `<div class="m-setting-btn" onclick="event.stopPropagation(); ${card.isCustom ? `openCustomCardModal('${card.id}')` : `openCardSetting('${card.id}')`}">âš™ï¸</div>`;
            
            btn.innerHTML = `
                <div class="m-check-mark">âœ“</div>
                <div class="m-card-name">${card.isCustom ? 'â­ ' : ''}${card.name}</div>
                <div class="m-card-nick">${nickname || card.nickname || ''}</div>
                ${settingHtml}
            `;
            
            btn.onclick = (e) => {
                if (e.target.closest('.m-setting-btn')) return;
                toggleCardVisibility(card.id);
            };
            
            container.appendChild(btn);
        });

        // æ›´æ–°è‡ªå»ºå¡æ•¸é‡
        const customs = JSON.parse(localStorage.getItem('custom_cards') || '[]');
        const countEl = document.getElementById('customCardCount');
        if (countEl) countEl.innerText = customs.length;
        const addBtn = document.getElementById('btnAddCustomCard');
        if (addBtn) addBtn.style.display = customs.length >= 2 ? 'none' : '';
    }

    function toggleCardVisibility(cardId) {
        const realCardIds = cards.map(c => c.id).filter(id => id !== 'add1');
        let currentReal = visibleCards.filter(id => realCardIds.includes(id));
        
        if (currentReal.includes(cardId)) {
            currentReal = currentReal.filter(id => id !== cardId);
        } else {
            if (currentReal.length >= 8) {
                alert('æœ€å¤šåªèƒ½é¡¯ç¤º 8 å¼µå¡ç‰‡');
                return;
            }
            currentReal.push(cardId);
        }
        
        visibleCards = currentReal.length < 8 ? [...currentReal, 'add1'] : currentReal;
        localStorage.setItem('visibleCards', JSON.stringify(visibleCards));
        renderManageList();
        renderGrid();
    }

    // æ–°ç‰ˆå¡ç‰‡è¨­å®šå½ˆçª—
    function openCardSetting(cardId) {
        const card = cards.find(c => c.id === cardId);
        if (!card) return;
        
        document.getElementById('settingsModalTitle').innerText = `${card.name} è¨­å®š`;
        document.getElementById('settingCardId').value = cardId;
        
        // è¼‰å…¥æš±ç¨±
        const nickname = cardSettings[cardId]?.nickname || '';
        document.getElementById('settingNicknameInput').value = nickname;
        
        // è¼‰å…¥çµå¸³æ—¥
        const cycleDay = cardSettings[cardId]?.cycleDay || '';
        document.getElementById('settingCycleDayInput').value = cycleDay;
        
        document.getElementById('cardSettingsModal').style.display = 'flex';
    }

    function saveCardSetting() {
        const cardId = document.getElementById('settingCardId').value;
        const newNickname = document.getElementById('settingNicknameInput').value.trim();
        const newCycleDay = document.getElementById('settingCycleDayInput').value;
        
        if (!cardSettings[cardId]) cardSettings[cardId] = {};
        
        cardSettings[cardId].nickname = newNickname;
        cardSettings[cardId].cycleDay = newCycleDay;
        
        localStorage.setItem('cardSettings', JSON.stringify(cardSettings));
        
        document.getElementById('cardSettingsModal').style.display = 'none';
        
        // é‡æ–°æ¸²æŸ“ç•«é¢ä»¥å¥—ç”¨æ–°è¨­å®š
        renderManageList();
        renderGrid();
    }

    function filterManageCards() {
        const keyword = document.getElementById('cardSearchInput').value.trim().toLowerCase();
        const clearBtn = document.getElementById('btnSearchClear');
        clearBtn.style.display = keyword ? 'flex' : 'none';
        
        document.querySelectorAll('.manage-card-btn').forEach(btn => {
            const cardId = btn.getAttribute('data-card-id');
            const card = cards.find(c => c.id === cardId);
            if (!card) return;
            
            const searchText = (card.name + ' ' + card.nickname + ' ' + (card.note || '')).toLowerCase();
            btn.style.display = (!keyword || searchText.includes(keyword)) ? 'flex' : 'none';
        });
    }

    function clearCardSearch() {
        document.getElementById('cardSearchInput').value = '';
        document.getElementById('btnSearchClear').style.display = 'none';
        filterManageCards();
    }

    // åŒ¯å‡ºè³‡æ–™ (ä¿®å¾©ï¼šç¢ºä¿ cardId æ¬„ä½å­˜åœ¨)
    function exportData() {
        const data = {
            version: 'V126.1',
            exportTime: new Date().toISOString(),
            visibleCards: visibleCards,
            cardOrder: savedOrder,
            cardSettings: cardSettings,
            transactions: {},
            settings: {
                current_location: currentLocation,
                exchange_rates: exchangeRates,
                uni_settings: localStorage.getItem('uni_settings'),
                happy_used: localStorage.getItem('happy_used'),
                hsbc_tier: localStorage.getItem('hsbc_tier'),
                hsbc_initial: localStorage.getItem('hsbc_initial'),
                hsbc_redeemed: localStorage.getItem('hsbc_redeemed'),
                currency_level: localStorage.getItem('currency_level'),
                scene_snapshots: localStorage.getItem('scene_snapshots')
            }
        };
        
        // åŒ¯å‡ºæ‰€æœ‰å¡ç‰‡çš„äº¤æ˜“ç´€éŒ„
        cards.forEach(card => {
            const txs = getTransactions(card.id);
            if (txs.length > 0) {
                // ç¢ºä¿æ¯ç­†äº¤æ˜“éƒ½æœ‰ cardId æ¬„ä½
                data.transactions[card.id] = txs.map(tx => ({
                    ...tx,
                    cardId: card.id
                }));
            }
        });
        
        // åŒ¯å‡º UniOpen å„é€±æœŸçš„è¸©é»è¨˜éŒ„
        data.uniBrandsByPeriod = {};
        for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            if (key && key.startsWith('uni_brands_')) {
                data.uniBrandsByPeriod[key] = localStorage.getItem(key);
            }
        }
        
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
       const now = new Date();
        const dateStr = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')}`;
        a.download = `åˆ·å¡å›é¥‹ç®¡å®¶_å‚™ä»½_${dateStr}.json`;
        a.click();
        URL.revokeObjectURL(url);
    }

    function triggerImport() {
        document.getElementById('fileInput').click();
    }

    // åŒ¯å…¥è³‡æ–™ (ä¿®å¾©ï¼šæ”¹å–„åŒ¯å…¥é‚è¼¯ï¼Œè™•ç† cardId éºå¤±å•é¡Œ)
    function importFile(input) {
        const file = input.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const data = JSON.parse(e.target.result);
                
                if (!confirm('ç¢ºå®šè¦åŒ¯å…¥å‚™ä»½æª”ï¼Ÿé€™æœƒè¦†è“‹ç›®å‰çš„è³‡æ–™ã€‚')) {
                    input.value = '';
                    return;
                }
                
                // åŒ¯å…¥åŸºæœ¬è¨­å®š
                if (data.visibleCards) {
                    localStorage.setItem('visibleCards', JSON.stringify(data.visibleCards));
                }
                if (data.cardOrder) {
                    localStorage.setItem('cardOrder', JSON.stringify(data.cardOrder));
                }
               if (data.cardSettings) {
                    // ç›¸å®¹èˆŠç‰ˆ billingDay â†’ cycleDay
                    const newSettings = {};
                    Object.keys(data.cardSettings).forEach(cardId => {
                        const old = data.cardSettings[cardId];
                        newSettings[cardId] = {
                            nickname: old.nickname || '',
                            cycleDay: old.cycleDay || old.billingDay || ''
                        };
                    });
                    localStorage.setItem('cardSettings', JSON.stringify(newSettings));
                }
                // åŒ¯å…¥äº¤æ˜“ç´€éŒ„ (ä¿®å¾©ç‰ˆ)
                if (data.transactions) {
                    // æƒ…æ³ Aï¼šæ–°æ ¼å¼ (ç‰©ä»¶ï¼Œkey ç‚º cardId)
                    if (typeof data.transactions === 'object' && !Array.isArray(data.transactions)) {
                        Object.keys(data.transactions).forEach(cardId => {
                            const txs = data.transactions[cardId];
                            if (Array.isArray(txs)) {
                                const normalizedTxs = txs.map(tx => normalizeTx(tx, cardId));
                                saveTransactions(cardId, normalizedTxs);
                            }
                        });
                    }
                    // æƒ…æ³ Bï¼šèˆŠæ ¼å¼ (é™£åˆ—ï¼Œä¾è³´ tx.cardId)
                    else if (Array.isArray(data.transactions)) {
                        const txsByCard = {};
                        data.transactions.forEach(tx => {
                            const cardId = tx.cardId;
                            if (!cardId) {
                                console.warn('è·³éç„¡ cardId çš„äº¤æ˜“:', tx);
                                return;
                            }
                            if (!txsByCard[cardId]) txsByCard[cardId] = [];
                            txsByCard[cardId].push(normalizeTx(tx, cardId));
                        });
                        Object.keys(txsByCard).forEach(cardId => {
                            saveTransactions(cardId, txsByCard[cardId]);
                        });
                    }
                }
                
                // åŒ¯å…¥è¨­å®š
                if (data.settings) {
                    const s = data.settings;
                    if (s.current_location) localStorage.setItem('current_location', s.current_location);
                    if (s.exchange_rates) localStorage.setItem('exchange_rates', JSON.stringify(s.exchange_rates));
                    if (s.uni_settings) localStorage.setItem('uni_settings', s.uni_settings);
                    if (s.happy_used) localStorage.setItem('happy_used', s.happy_used);
                    if (s.hsbc_tier) localStorage.setItem('hsbc_tier', s.hsbc_tier);
                    if (s.hsbc_initial) localStorage.setItem('hsbc_initial', s.hsbc_initial);
                    if (s.hsbc_redeemed) localStorage.setItem('hsbc_redeemed', s.hsbc_redeemed);
                    if (s.currency_level) localStorage.setItem('currency_level', s.currency_level);
                    if (s.scene_snapshots) localStorage.setItem('scene_snapshots', s.scene_snapshots);
                }
                
                // åŒ¯å…¥ UniOpen è¸©é»è¨˜éŒ„ (æŒ‰é€±æœŸ)
                if (data.uniBrandsByPeriod) {
                    Object.keys(data.uniBrandsByPeriod).forEach(key => {
                        localStorage.setItem(key, data.uniBrandsByPeriod[key]);
                    });
                }
                // ç›¸å®¹èˆŠç‰ˆ uni_brands (ç„¡é€±æœŸ)
                if (data.settings && data.settings.uni_brands && !data.uniBrandsByPeriod) {
                    const cycleKey = getUniBrandCycleKey();
                    localStorage.setItem(cycleKey, data.settings.uni_brands);
                }
                // ========== ç›¸å®¹èˆŠæ ¼å¼ï¼ˆè¨­å®šåœ¨æ ¹å±¤ç´šï¼‰==========
                // currentLocation
                if (!data.settings && data.currentLocation) {
                    localStorage.setItem('current_location', data.currentLocation);
                }
                // currencyLevel
                if (!data.settings && data.currencyLevel) {
                    localStorage.setItem('currency_level', data.currencyLevel);
                }
                // hsbcTier / hsbcInitial / hsbcRedeemed
                if (!data.settings && data.hsbcTier) {
                    localStorage.setItem('hsbc_tier', data.hsbcTier);
                }
                if (!data.settings && data.hsbcInitial) {
                    localStorage.setItem('hsbc_initial', data.hsbcInitial);
                }
                if (!data.settings && data.hsbcRedeemed) {
                    localStorage.setItem('hsbc_redeemed', data.hsbcRedeemed);
                }
                // sceneSnapshots
                if (!data.settings && data.sceneSnapshots) {
                    localStorage.setItem('scene_snapshots', JSON.stringify(data.sceneSnapshots));
                }
                // uniOpenState
                if (!data.settings && data.uniOpenState) {
                    if (data.uniOpenState.brands) {
                        const cycleKey = getUniBrandCycleKey();
                        localStorage.setItem(cycleKey, JSON.stringify(data.uniOpenState.brands));
                    }
                }
                alert('åŒ¯å…¥æˆåŠŸï¼é é¢å°‡é‡æ–°è¼‰å…¥ã€‚');
                location.reload();
                
            } catch (err) {
                console.error('Import error:', err);
                alert('åŒ¯å…¥å¤±æ•—ï¼š' + err.message);
            }
        };
        reader.readAsText(file);
        input.value = '';
    }

    // æ­£è¦åŒ–äº¤æ˜“è³‡æ–™ (ä¿®å¾©ï¼šç¢ºä¿ cardId å­˜åœ¨)
    function normalizeTx(tx, fallbackCardId) {
        const normalized = { ...tx };
        
        // ç¢ºä¿ cardId å­˜åœ¨
        if (!normalized.cardId && fallbackCardId) {
            normalized.cardId = fallbackCardId;
        }
        
        if (!normalized.id) normalized.id = Date.now() + Math.random();
        if (!normalized.amountTWD && normalized.amount) normalized.amountTWD = normalized.amount;
        if (!normalized.location && normalized.loc) normalized.location = normalized.loc;
        if (!normalized.location) normalized.location = 'TW';
        if (!normalized.currency) normalized.currency = 'TWD';
        
        if (normalized.date) {
            const d = parseFlexibleDate(normalized.date);
            if (d) normalized.date = d.toISOString().split('T')[0];
        }
        
        return normalized;
    }

    function resetAllData() {
        if (!confirm('âš ï¸ ç¢ºå®šè¦é‡ç½®æ‰€æœ‰è³‡æ–™ï¼Ÿ\n\né€™å°‡æ¸…é™¤ï¼š\nâ€¢ æ‰€æœ‰æ¶ˆè²»è¨˜éŒ„\nâ€¢ å¡ç‰‡è¨­å®š\nâ€¢ æƒ…å¢ƒå¿«ç…§\n\næ­¤æ“ä½œç„¡æ³•å¾©åŸï¼')) return;
        if (!confirm('å†æ¬¡ç¢ºèªï¼šçœŸçš„è¦åˆªé™¤æ‰€æœ‰è³‡æ–™å—ï¼Ÿ')) return;
        
        const keysToRemove = [];
        for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            if (key && (
                key.startsWith('transactions_') || 
                key.startsWith('uni_brands_') ||
                ['visibleCards', 'cardOrder', 'cardSettings', 'user_setup_done', 'scene_snapshots',
                 'uni_settings', 'happy_used', 'hsbc_tier', 'hsbc_initial', 'hsbc_redeemed',
                 'currency_level', 'uni_brands', 'current_location', 'exchange_rates', 'last_rate_update'].includes(key)
            )) {
                keysToRemove.push(key);
            }
        }
        keysToRemove.forEach(key => localStorage.removeItem(key));
        
        alert('è³‡æ–™å·²é‡ç½®ï¼');
        location.reload();
    }

    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('sw.js').catch(() => {});
        });
    }
</script>
</body>
</html>
