<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-FMD1PV6QZV"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-FMD1PV6QZV');
    </script>

    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="åˆ·å¡å›é¥‹ç®¡å®¶">
    <meta name="theme-color" content="#F0F2F5">
     
    <meta property="og:title" content="åˆ·å¡å›é¥‹ç®¡å®¶ - æ‚¨çš„ä¿¡ç”¨å¡æœ€ä½³å¹«æ‰‹">
    <meta property="og:description" content="è‡ªå‹•è¨ˆç®—å›é¥‹ã€å³æ™‚é¡¯ç¤ºä¸Šé™ã€æ”¯æ´æˆ°ç¸¾åœ–åˆ†äº«ã€‚å¿«ä¾†çœ‹çœ‹ä½ æœ¬æœˆè³ºäº†å¤šå°‘å›é¥‹ï¼">
    <meta property="og:image" content="https://shawn2026-oss.github.io/shawn-2026-creditcard/icon-192.png">
    <meta property="og:url" content="https://shawn2026-oss.github.io/shawn-2026-creditcard/">
    <meta property="og:type" content="website">

    <title>åˆ·å¡å›é¥‹ç®¡å®¶</title>
       
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" sizes="192x192" href="icon-192.png">
    <link rel="icon" type="image/png" sizes="48x48" href="icon-48.png">
    <link rel="shortcut icon" href="icon-48.png">

    <style>
        :root { --bg-color: #F0F2F5; --text-primary: #1C1C1E; --text-secondary: #8E8E93; }
        body { font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif; background-color: #E0E5EC; color: var(--text-primary); margin: 0; display: flex; justify-content: center; min-height: 100vh; -webkit-font-smoothing: antialiased; }
        .app-container { width: 100%; max-width: 480px; background-color: var(--bg-color); min-height: 100vh; padding: 16px 12px; padding-top: env(safe-area-inset-top, 20px); padding-bottom: env(safe-area-inset-bottom, 20px); box-shadow: 0 0 40px rgba(0,0,0,0.05); display: flex; flex-direction: column; box-sizing: border-box; }
        @media (max-width: 480px) { body { background-color: var(--bg-color); } .app-container { box-shadow: none; width: 100%; max-width: 100%; } }
        .header-top-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2px; width: 100%; }
        .author-top { font-size: 12px; font-weight: 800; color: #007AFF; letter-spacing: 0.5px; }
        .version-tag { font-size: 10px; color: #888; font-weight: 600; background: rgba(0,0,0,0.05); padding: 2px 8px; border-radius: 4px; white-space: nowrap; flex-shrink: 0; display: inline-block; min-width: 36px; text-align: center; }
        .header-section { margin-bottom: 12px; display: flex; justify-content: space-between; align-items: flex-end; }
        h1 { font-size: 22px; font-weight: 800; margin: 0; color: #333; letter-spacing: -0.5px; line-height: 1.2;}
        .subtitle { font-size: 11px; color: var(--text-secondary); font-weight: 500; }
        .today-date { background: rgba(0,0,0,0.05); padding: 2px 6px; border-radius: 4px; font-size: 11px; font-weight: 600; color: #555; margin-left: 5px;}
        .news-ticker { background: #FFF9C4; color: #856404; border-radius: 8px; margin-bottom: 12px; height: 36px; display: block; overflow: hidden; white-space: nowrap; position: relative; box-shadow: 0 2px 5px rgba(0,0,0,0.05); width: 100%; transform: translate3d(0,0,0); }
        .ticker-content { display: inline-block; height: 36px; line-height: 36px; padding-left: 100%; min-width: 100%; box-sizing: content-box; animation: scroll-left 15s linear infinite; will-change: transform; transform: translate3d(0, 0, 0); }
        @keyframes scroll-left { 0% { transform: translate3d(0, 0, 0); } 100% { transform: translate3d(-100%, 0, 0); } }
        .total-reward-card { background: #2c3e50; color: white; border-radius: 16px; padding: 16px 20px; margin-bottom: 16px; display: flex; justify-content: space-between; align-items: center; position: relative; overflow: hidden; box-shadow: 0 4px 10px rgba(44, 62, 80, 0.2); }
        .total-reward-card::after { content: ''; position: absolute; top: -50%; right: -50%; width: 150px; height: 150px; background: rgba(255,255,255,0.1); border-radius: 50%; pointer-events: none; }
        .total-info { display: flex; flex-direction: column; gap: 2px; }
        .total-reward-label { font-size: 13px; font-weight: 600; opacity: 0.9; }
        .total-reward-amount { font-size: 32px; font-weight: 800; letter-spacing: -0.5px; }
        .btn-share-result { background: rgba(255,255,255,0.2); backdrop-filter: blur(5px); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 8px 16px; border-radius: 20px; font-size: 13px; font-weight: 700; cursor: pointer; display: flex; align-items: center; gap: 6px; transition: all 0.2s; z-index: 2; }
        .btn-share-result:active { transform: scale(0.95); background: rgba(255,255,255,0.3); }
        #urgent-alert-area { display: none; margin-bottom: 12px; }
        .urgent-card { background: linear-gradient(135deg, #FF3B30, #FF2D55); color: white; border-radius: 12px; padding: 10px 14px; box-shadow: 0 4px 10px rgba(255, 59, 48, 0.25); animation: pulse 2s infinite; }
        .urgent-title { font-size: 13px; font-weight: 800; display: flex; align-items: center; gap: 6px; }
        .urgent-item { background: rgba(255,255,255,0.25); border-radius: 8px; padding: 6px 10px; margin-top: 6px; font-size: 12px; font-weight: 600; line-height: 1.3; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.01); } 100% { transform: scale(1); } }
        #card-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 20px; flex: 1; align-content: start;}
        .card-tile { border-radius: 16px; padding: 12px; min-height: 135px; display: flex; flex-direction: column; justify-content: space-between; box-shadow: 0 4px 12px rgba(0,0,0,0.1); position: relative; transition: transform 0.1s; cursor: pointer; color: white; overflow: hidden; user-select: none; -webkit-user-select: none; touch-action: pan-y; }
        .card-tile:active { transform: scale(0.97); }
        .sortable-ghost { opacity: 0.4; transform: scale(0.95); }
        .sortable-drag { cursor: grabbing; }
        .tile-header { display: flex; justify-content: space-between; align-items: flex-start; z-index: 2; margin-bottom: 2px;}
        .tile-name { font-size: 15px; font-weight: 800; line-height: 1.2; text-shadow: 0 1px 2px rgba(0,0,0,0.15); }
        .tile-nickname-badge { display: inline-block; font-size: 10px; font-weight: 800; background: rgba(0,0,0,0.2); color: #FFD700; padding: 2px 6px; border-radius: 4px; margin-bottom: 4px; z-index: 2; width: fit-content; }
        .tile-nickname-badge.placeholder { background: rgba(0,0,0,0.1); color: #aaa; }
        .tile-note { font-size: 10px; font-weight: 500; opacity: 0.9; margin-bottom: 4px; display: block; line-height: 1.2; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; z-index: 2; letter-spacing: -0.2px; }
        .tile-rule { font-size: 10px; font-weight: 700; background: rgba(0,0,0,0.25); padding: 2px 6px; border-radius: 4px; display: inline-block; margin-bottom: 6px; color: #FFD700; z-index: 2; }
        .rate-badge { background: rgba(255,255,255,0.3); font-size: 10px; font-weight: 800; padding: 2px 5px; border-radius: 5px; white-space: nowrap; backdrop-filter: blur(4px); margin-left: 2px; flex-shrink: 0; }
        .tile-body { z-index: 2; flex:1; display:flex; flex-direction:column; justify-content:center; }
        .tile-stat { font-size: 20px; font-weight: 700; letter-spacing: -0.5px; margin-bottom: 2px;}
        .tile-earned { font-size: 11px; font-weight: 600; color: rgba(255,255,255,0.95); display: flex; align-items: center; gap: 3px;}
        .tile-earned::before { content: 'è³º'; font-size: 9px; opacity: 0.8; border: 1px solid rgba(255,255,255,0.7); padding: 0 2px; border-radius: 3px;}
        .tile-footer { z-index: 2; margin-top: 6px; position: relative; }
        .progress-track { background: rgba(0,0,0,0.2); height: 4px; border-radius: 2px; overflow: hidden; margin-bottom: 4px; }
        .progress-fill { height: 100%; background: rgba(255,255,255,0.95); transition: width 0.5s ease; }
        .tile-msg { font-size: 11px; font-weight: 700; opacity: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; line-height: 1.2; }
        .tile-cycle-hint { font-size: 9px; color: #fff; opacity: 0.95; margin-top: 3px; text-align: right; text-shadow: 0 1px 2px rgba(0,0,0,0.5); font-weight: 700; letter-spacing: 0.3px; }
        .tile-cycle-hint.dark-text { color: rgba(0,0,0,0.6); text-shadow: none; }
        .history-section { flex: 1; display: flex; flex-direction: column; }
        .history-title { font-size: 14px; font-weight: 700; margin-bottom: 8px; color: #555; }
        .settings-area { margin-top: auto; display: flex; gap: 8px; flex-direction: column; padding-top: 20px;}
        .settings-row { display: flex; gap: 8px; }
        .btn-tool { flex: 1; padding: 10px; border-radius: 10px; font-size: 12px; font-weight: 600; border: 1px solid #eee; background: white; color: #555; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 4px; box-shadow: 0 1px 3px rgba(0,0,0,0.05);}
        .btn-manage { background: #333; color: white; border: none; box-shadow: 0 2px 8px rgba(0,0,0,0.2); }
        .btn-reset-visible { width: 100%; padding: 12px; background-color: #fff5f5; border: 1px solid #ffdede; color: #FF3B30; border-radius: 12px; font-weight: 600; font-size: 12px; cursor: pointer; margin-top: 10px;}
        .btn-ig { width: 100%; padding: 12px; background: linear-gradient(45deg, #f09433 0%, #e6683c 25%, #dc2743 50%, #cc2366 75%, #bc1888 100%); color: white; border: none; border-radius: 12px; font-weight: 600; font-size: 14px; cursor: pointer; margin-top: 10px; box-shadow: 0 4px 12px rgba(220, 39, 67, 0.3); display: flex; align-items: center; justify-content: center; gap: 6px; }
        .btn-ig:active { transform: scale(0.98); }
        .details-content { display: none; background: #fff; border: 1px solid #eee; border-radius: 8px; padding: 10px; margin-top: 6px; font-size: 11px; color: #666; line-height: 1.6; }
        .modal { display: none; position: fixed !important; top: 0 !important; left: 0 !important; width: 100%; height: 100%; background: rgba(0,0,0,0.5); backdrop-filter: blur(3px); z-index: 10000; align-items: center; justify-content: center; }
        .modal-content { background: white; width: 85%; max-width: 320px; border-radius: 20px; padding: 20px; box-shadow: 0 25px 50px rgba(0,0,0,0.25); animation: modalPop 0.2s; display: flex; flex-direction: column; max-height: 85vh; overflow-y: auto; position: relative; z-index: 10001; }
        .modal-body-input { flex-shrink: 0; }
        .welcome-overlay { position: fixed !important; top: 0 !important; left: 0 !important; width: 100vw; height: 100vh; background: rgba(0,0,0,0.85); z-index: 20000; display: none; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        .welcome-content { background: white; width: 85%; max-width: 340px; border-radius: 24px; padding: 24px; text-align: center; box-shadow: 0 10px 40px rgba(0,0,0,0.5); animation: modalPop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .welcome-title { font-size: 22px; font-weight: 800; color: #333; margin-bottom: 10px; }
        .welcome-desc { font-size: 14px; color: #666; margin-bottom: 20px; line-height: 1.5; }
        .welcome-list { text-align: left; max-height: 300px; overflow-y: auto; margin-bottom: 20px; border: 1px solid #eee; border-radius: 12px; padding: 10px; }
        .welcome-item { display: flex; align-items: center; padding: 10px; border-bottom: 1px solid #f9f9f9; }
        .welcome-item:last-child { border-bottom: none; }
        .welcome-item input { width: 20px; height: 20px; margin-right: 12px; margin-bottom: 0; padding: 0;}
        .welcome-item label { margin: 0; font-size: 15px; font-weight: 600; color: #333; flex: 1; }
        .welcome-btn { background: #007AFF; color: white; border: none; padding: 14px; width: 100%; border-radius: 12px; font-size: 16px; font-weight: 700; cursor: pointer; box-shadow: 0 4px 12px rgba(0,122,255,0.3); }
        .welcome-btn:active { transform: scale(0.98); }
        #captureArea { position: fixed; top: -9999px; left: -9999px; z-index: -1; }
        .share-card-node { width: 320px; height: auto; background: linear-gradient(135deg, #1C1C1E, #2c3e50); color: white; border-radius: 20px; padding: 24px; box-sizing: border-box; font-family: -apple-system, sans-serif; text-align: center; box-shadow: 0 20px 40px rgba(0,0,0,0.3); margin-bottom: 20px; }
        .share-header { font-size: 14px; opacity: 0.8; letter-spacing: 1px; margin-bottom: 4px; text-transform: uppercase; }
        .share-month { font-size: 18px; font-weight: 700; margin-bottom: 20px; }
        .share-amount { font-size: 48px; font-weight: 800; margin-bottom: 20px; text-shadow: 0 2px 10px rgba(0,0,0,0.2); }
        .share-divider { height: 1px; background: rgba(255,255,255,0.1); margin: 15px 0; }
        .share-footer { font-size: 11px; opacity: 0.8; margin-top: 15px; background: rgba(255,255,255,0.1); padding: 8px; border-radius: 8px; font-weight: 600; }
        .share-list { text-align: left; margin-top: 10px; }
        .share-item { display: flex; justify-content: space-between; font-size: 13px; margin-bottom: 8px; font-weight: 500; }
        .share-item span:last-child { font-weight: 700; color: #FFD700; }
        .social-btn-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; width: 100%; margin-top: 10px; }
        .social-btn { display: flex; align-items: center; justify-content: center; gap: 6px; padding: 12px; border-radius: 12px; border: none; font-size: 13px; font-weight: 700; color: white; cursor: pointer; transition: transform 0.1s; }
        .social-btn:active { transform: scale(0.97); }
        .social-btn.instagram { background: linear-gradient(45deg, #f09433 0%, #e6683c 25%, #dc2743 50%, #cc2366 75%, #bc1888 100%); }
        .social-btn.threads { background: #000000; border: 1px solid #333; }
        .social-btn.facebook { background: #1877F2; }
        .social-btn.line { background: #06C755; }
        .social-btn.download { background: #555; grid-column: span 2; }
        .input-group label { display: block; font-size: 12px; font-weight: 600; color: #888; margin-bottom: 6px; margin-top: 10px; }
        input { width: 100%; padding: 10px; border: 2px solid #f0f0f0; background: #fff; border-radius: 12px; font-size: 18px; box-sizing: border-box; outline: none; font-weight: 600; color: #333; }
        .btn-group { display: flex; gap: 8px; margin-top: 20px; flex-shrink: 0; }
        .btn { flex: 1; padding: 10px; border: none; border-radius: 12px; font-size: 15px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center;}
        .btn-cancel { background: #f5f5f5; color: #333; }
        .btn-confirm { background: #007AFF; color: white; flex: 2; }
        .btn-again { background: #E3F2FD; color: #007AFF; border: 1px solid #b3e5fc; }
        #liveRewardCalc { text-align: center; font-size: 16px; color: #0056b3; font-weight: 700; margin-top: 12px; min-height: 20px; background: #E3F2FD; padding: 8px; border-radius: 8px; display: none; }
        .modal-history-section { margin-top: 15px; border-top: 2px solid #f0f0f0; padding-top: 10px; height: auto; overflow: visible; }
        .modal-history-title { font-size: 12px; font-weight: 700; color: #555; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; }
        .history-item { padding: 10px 0; border-bottom: 1px solid #f9f9f9; display: flex; justify-content: space-between; align-items: center; font-size: 12px; cursor: pointer; }
        .history-item:active { background: #f5f5f5; }
        .history-item:last-child { border-bottom: none; }
        .h-name { font-weight: 600; color: #555; min-height: 15px; }
        .h-date { font-size: 10px; color: #aaa; margin-top: 2px;}
        .h-amount { font-weight: 700; color: #333; font-size: 13px; }
        .btn-delete-single { background: none; border: none; color: #ccc; font-size: 14px; padding: 0 5px; cursor: pointer; margin-left: 8px;}
        .btn-delete-single:hover { color: #FF3B30; }
        #pigRichOptions, #greenCardOptions, #uniOptions, #happyOptions, #hsbcOptions, #uniOpenOptions, #richartOptions, #fubonJOptions, #jiheOptions, #kumamonOptions, #sinopacCurrencyOptions, #sinopacMitsuiOptions, #jiangOptions, #dbsEcoOptions, #sinopacJcbOptions { display: none; background: #f9f9f9; padding: 10px; border-radius: 10px; margin-top: 10px; border: 1px dashed #ddd; }
        .option-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 6px; font-size: 13px; font-weight: 600; color: #555; }
        .option-row input[type="checkbox"], .option-row input[type="radio"], .option-row input[type="number"] { margin: 0; }
        .option-row input[type="checkbox"], .option-row input[type="radio"] { width: 20px; height: 20px; }
        .option-row.read-only { opacity: 0.8; pointer-events: none; }
        .option-row.read-only input { opacity: 0.6; }
        .option-row.expired { opacity: 0.5; pointer-events: none; background: #eee; padding: 4px; border-radius: 4px; }
        .brand-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px; margin-top: 6px; }
        .brand-btn { border: 1px solid #ddd; background: white; border-radius: 6px; padding: 6px 2px; font-size: 11px; color: #666; text-align: center; cursor: pointer; transition: 0.2s; font-weight: 600; display: flex; align-items: center; justify-content: center; }
        .brand-btn.active { background: #FF9800; color: white; border-color: #F57C00; box-shadow: 0 2px 4px rgba(255, 152, 0, 0.3); }
        .manage-item { display: flex; align-items: center; justify-content: space-between; padding: 16px 12px; border-bottom: 1px solid #f0f0f0; background: #fff; cursor: pointer; transition: background 0.2s; }
        .manage-item:active { background: #f9f9f9; }
        .manage-info { display: flex; flex-direction: column; gap: 4px; }
        .manage-name { font-size: 15px; font-weight: 700; color: #333; }
        .manage-desc { font-size: 12px; color: #999; }
        .switch { position: relative; display: inline-block; width: 44px; height: 24px; flex-shrink: 0; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 2px; bottom: 2px; background-color: white; transition: .4s; border-radius: 50%; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        input:checked + .slider { background-color: #34C759; }
        input:checked + .slider:before { transform: translateX(20px); }
        .btn-card-setting { background: #f0f0f0; border: none; border-radius: 50%; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; font-size: 16px; cursor: pointer; margin-right: 12px; color: #555; }
        .btn-card-setting:hover { background: #e0e0e0; }
        .happy-dashboard { background: transparent; border: none; padding: 0; margin-top: 10px; display: none; }
        .dash-row { margin-bottom: 8px; }
        .dash-label { font-size: 12px; font-weight: 700; color: #555; display: flex; justify-content: space-between; margin-bottom: 2px;}
        .dash-bar-bg { background: #eee; height: 6px; border-radius: 3px; overflow: hidden; }
        .dash-bar-fill { height: 100%; background: #4cd964; transition: width 0.3s; }
        .dash-bar-fill.danger { background: #ff3b30; }
        .manage-tools { margin-bottom: 12px; padding-bottom: 12px; border-bottom: 1px solid #eee; }
        .tools-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .btn-tool-small { background: #f0f0f0; border: 1px solid #e0e0e0; padding: 6px 12px; border-radius: 8px; font-size: 12px; font-weight: 600; color: #555; cursor: pointer; }
        .btn-tool-small:active { background: #ddd; }
        .scene-container { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 4px; white-space: nowrap; -webkit-overflow-scrolling: touch; }
        .btn-scene { padding: 6px 12px; background: #e8f5e9; color: #2e7d32; border: 1px solid #c8e6c9; border-radius: 20px; font-size: 12px; font-weight: 700; cursor: pointer; display: flex; align-items: center; gap: 4px; flex-shrink: 0;}
        .btn-scene:active { transform: scale(0.95); }
        .btn-scene-del { width: 16px; height: 16px; background: rgba(0,0,0,0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 10px; margin-left: 4px; color: #2e7d32; }
        
        /* é›™æ¬„ç¶²æ ¼ + æœå°‹ CSS */
        .manage-search-container { position: sticky; top: 0; background: white; z-index: 10; padding-bottom: 12px; margin-bottom: 8px; border-bottom: 1px solid #f0f0f0; }
        .manage-search-wrapper { position: relative; width: 100%; }
        .manage-search-input { width: 100%; padding: 12px 40px 12px 12px; border-radius: 12px; border: 1px solid #e0e0e0; background: #f9f9f9; font-size: 15px; font-weight: 600; color: #333; transition: all 0.2s; box-sizing: border-box; outline: none; }
        .manage-search-input:focus { background: white; border-color: #007AFF; box-shadow: 0 0 0 3px rgba(0,122,255,0.1); }
        .btn-search-clear { position: absolute; right: 10px; top: 50%; transform: translateY(-50%); width: 24px; height: 24px; background: #ccc; color: white; border-radius: 50%; border: none; font-size: 14px; display: none; align-items: center; justify-content: center; cursor: pointer; }
        .manage-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; padding-bottom: 20px; }
        .manage-card-btn { position: relative; border-radius: 16px; padding: 12px; background: #f5f5f5; border: 2px solid transparent; text-align: left; transition: all 0.2s cubic-bezier(0.25, 0.8, 0.25, 1); cursor: pointer; display: flex; flex-direction: column; justify-content: space-between; min-height: 80px; user-select: none; -webkit-tap-highlight-color: transparent; opacity: 0.7; filter: grayscale(100%); }
        .manage-card-btn.active { opacity: 1; filter: grayscale(0%); background: white; border-color: #007AFF; box-shadow: 0 4px 12px rgba(0,0,0,0.08); transform: translateY(-1px); }
        .manage-card-btn:active { transform: scale(0.96); }
        .m-card-name { font-size: 14px; font-weight: 800; color: #333; line-height: 1.3; margin-bottom: 4px; padding-right: 20px; }
        .m-card-nick { font-size: 11px; color: #888; font-weight: 500; }
        .m-check-mark { position: absolute; top: 10px; right: 10px; width: 18px; height: 18px; background: #007AFF; color: white; border-radius: 50%; font-size: 12px; display: none; align-items: center; justify-content: center; font-weight: bold; box-shadow: 0 2px 4px rgba(0,0,0,0.2); z-index: 2; }
        .manage-card-btn.active .m-check-mark { display: flex; }
        .m-setting-btn { position: absolute; bottom: 8px; right: 8px; width: 28px; height: 28px; border-radius: 50%; background: rgba(0,0,0,0.05); color: #666; border: 1px solid rgba(0,0,0,0.05); display: flex; align-items: center; justify-content: center; font-size: 14px; z-index: 3; transition: all 0.2s; }
        .manage-card-btn.active .m-setting-btn { background: rgba(0,0,0,0.03); color: #333; }
        .m-setting-btn:active { background: #e0e0e0; transform: scale(0.9); }
    </style>
</head>
  <body>
    <div id="line-tip-bar">
        <span id="line-tip-text">âš ï¸ åµæ¸¬ä¸­...</span>
        <button onclick="this.parentElement.style.display='none'">âœ•</button>
    </div>

    <div id="safari-install-bubble" onclick="closeBubble()">
        <div class="bubble-content">
            <span class="bubble-text">è«‹é»æ“Šå³ä¸‹è§’ã€Œ...ã€å¾Œé»ã€Œåˆ†äº«ã€å†ä¸‹æ»‘åŠ å…¥ã€Œä¸»ç•«é¢ã€ğŸ‘‡</span>
            <div class="bubble-arrow"></div>
        </div>
        <button class="bubble-close">âœ•</button>
    </div>

    <div id="android-install-bar">
        <div class="install-info">
            <div class="install-icon">ğŸ’³</div>
            <div class="install-text">
                <div style="font-weight:800; font-size:14px;">å®‰è£ã€Œåˆ·å¡å›é¥‹ç®¡å®¶ã€</div>
                <div style="font-size:11px; opacity:0.8;">å…¨è¢å¹•åŸ·è¡Œï¼Œè³‡æ–™ä¸éºå¤±</div>
            </div>
        </div>
        <div style="display:flex; align-items:center; gap:10px;">
            <button class="btn-install-trigger" onclick="triggerAndroidInstall()">ğŸ“² å®‰è£</button>
            <button class="btn-close-install" onclick="closeAndroidBar()">âœ•</button>
        </div>
    </div>

    <style>
        /* å…±ç”¨ï¼šéš±è—é è¨­ */
        #line-tip-bar, #safari-install-bubble, #android-install-bar { display: none; }

        /* LINE/FB/Threads æç¤ºæ¢ */
        #line-tip-bar {
            background: #FFF9C4; color: #856404;
            padding: 12px 15px; font-size: 13px; font-weight: 600;
            position: fixed; top: 0; left: 0; width: 100%;
            z-index: 99999; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            justify-content: space-between; align-items: center; box-sizing: border-box;
            line-height: 1.4;
        }
        #line-tip-bar strong { color: #d32f2f; text-decoration: underline; }
        #line-tip-bar button { background: none; border: none; font-size: 18px; color: #856404; cursor: pointer; padding: 0 0 0 10px; flex-shrink: 0; }

        /* Safari å®‰è£æ°£æ³¡ (æ¥µå³ä¸‹è§’ç‰ˆ) */
        #safari-install-bubble {
            position: fixed; 
            /* ç·Šè²¼åº•éƒ¨å®‰å…¨å€ï¼Œåƒ…ç•™ 5px é–“éš™ */
            bottom: calc(5px + env(safe-area-inset-bottom)); 
            right: 10px; /* é å³ */
            left: auto; 
            transform: none; 
            z-index: 10000; animation: bounce 2s infinite;
            cursor: pointer;
        }
        .bubble-content {
            background: #007AFF; color: white; padding: 10px 16px; border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,122,255,0.4); position: relative; text-align: center; 
            min-width: 260px; /* åŠ å¯¬ä»¥å®¹ç´é•·æ–‡æ¡ˆ */
        }
        .bubble-text { font-size: 13px; line-height: 1.4; display: block; pointer-events: none; font-weight: 600; } 
        
        /* ç®­é ­ */
        .bubble-arrow {
            position: absolute; bottom: -8px; 
            right: 20px; /* ç®­é ­é å³å°é½ŠæŒ‰éˆ• */
            left: auto;
            transform: none;
            width: 0; height: 0; border-left: 8px solid transparent; border-right: 8px solid transparent; border-top: 8px solid #007AFF;
        }
        .bubble-close {
            position: absolute; top: -8px; right: -8px; background: #ccc; color: white; border: 2px solid white;
            border-radius: 50%; width: 20px; height: 20px; font-size: 12px; cursor: pointer; display: flex; align-items: center; justify-content: center;
            pointer-events: none;
        }

        /* Android å®‰è£æ¢ */
        #android-install-bar {
            position: fixed; bottom: 20px; left: 5%; width: 90%;
            background: #222; color: white; border-radius: 16px;
            padding: 12px 16px; box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            z-index: 10000; display: none; justify-content: space-between; align-items: center;
            box-sizing: border-box; animation: slideUp 0.5s ease-out;
        }
        .install-info { display: flex; align-items: center; gap: 12px; }
        .install-icon { width: 40px; height: 40px; background: linear-gradient(135deg, #00C9FF, #92FE9D); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 20px; }
        .btn-install-trigger {
            background: #007AFF; color: white; border: none; padding: 8px 16px; border-radius: 20px;
            font-weight: 700; font-size: 13px; cursor: pointer; white-space: nowrap;
        }
        .btn-close-install { background: rgba(255,255,255,0.2); border: none; width: 24px; height: 24px; border-radius: 50%; color: #aaa; font-size: 12px; cursor: pointer; display: flex; align-items: center; justify-content: center; }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% {transform: translateY(0);}
            40% {transform: translateY(-10px);}
            60% {transform: translateY(-5px);}
        }
        @keyframes slideUp { from { transform: translateY(100px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    </style>

    <script>
        let deferredPrompt;

        (function() {
            var ua = navigator.userAgent.toLowerCase();
            var isIOS = /iphone|ipad|ipod/.test(ua);
            
            // --- çµ‚æ¥µä¿®æ­£ï¼šiOS è² é¢è¡¨åˆ—åµæ¸¬ ---
            var isChromeIOS = ua.indexOf('crios') > -1;
            var isFirefoxIOS = ua.indexOf('fxios') > -1;
            var isInAppKeywords = ua.indexOf('line') > -1 || 
                                  ua.indexOf('fban') > -1 || 
                                  ua.indexOf('fbav') > -1 || 
                                  ua.indexOf('instagram') > -1 || 
                                  ua.indexOf('threads') > -1;

            // çœŸæ­£çš„ Safariï¼šå¿…é ˆæ˜¯ iOSï¼Œæœ‰ safariï¼Œæ²’æœ‰å…¶ä»–å¹²æ“¾å­—ä¸²
            var isRealSafari = isIOS && ua.indexOf('safari') > -1 && !isChromeIOS && !isFirefoxIOS && !isInAppKeywords;
            var isStandalone = window.navigator.standalone === true || window.matchMedia('(display-mode: standalone)').matches;

            // 1. iOS é Safari ç’°å¢ƒ (å« Chrome, Edge, In-App) -> å¼·åˆ¶é¡¯ç¤ºé»ƒæ¢
            if (isIOS && !isStandalone && !isRealSafari) {
                var tipBar = document.getElementById('line-tip-bar');
                var tipText = document.getElementById('line-tip-text');
                
                if(tipBar && tipText) {
                      // [ä¿®æ­£] æ–‡æ¡ˆå„ªåŒ–ï¼šè§’è½é¸å–®ã€Œ...ã€ æˆ– è¤‡è£½ç¶²å€
                      tipText.innerHTML = 'âš ï¸ è«‹å‹™å¿…é»æ“Š<strong>è§’è½é¸å–®ã€Œ...ã€</strong>æˆ–<strong>è¤‡è£½ç¶²å€</strong>åˆ° Safari é–‹å•Ÿæ‰æœ‰å­˜æª”åŠŸèƒ½';
                      tipBar.style.display = 'flex';
                      
                      // è®“æ¨™é¡Œå¾€ä¸‹æ¨ï¼Œé¿å…è¢«æ“‹ä½
                      var appContainer = document.querySelector('.app-container');
                      if(appContainer) appContainer.style.marginTop = '45px';
                }
            } 
            // 2. iOS Safari ç’°å¢ƒ -> é¡¯ç¤ºè—è‰²æ°£æ³¡
            else if (isIOS && !isStandalone && isRealSafari) {
                setTimeout(function() {
                    var bubble = document.getElementById('safari-install-bubble');
                    if(bubble) bubble.style.display = 'block';
                }, 1000);
            }
            
            // Android é‚è¼¯ (ç¶­æŒä¸è®Š)
            if (!isIOS && isInAppKeywords) {
                 var tipBar = document.getElementById('line-tip-bar');
                 var tipText = document.getElementById('line-tip-text');
                 if(tipBar && tipText) {
                      tipText.innerHTML = 'âš ï¸ å…§å»ºç€è¦½å™¨ç„¡æ³•å­˜æª”ï¼Œè«‹é»æ“Š<strong>è§’è½é¸å–®ã€Œ...ã€</strong>ï¼Œé¸æ“‡<strong>ã€Œåœ¨ Chrome é–‹å•Ÿã€</strong>';
                      tipBar.style.display = 'flex';
                      var appContainer = document.querySelector('.app-container');
                      if(appContainer) appContainer.style.marginTop = '45px';
                 }
            }
        })();

        // 3. Android Chrome å®‰è£äº‹ä»¶
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            document.getElementById('android-install-bar').style.display = 'flex';
        });

        async function triggerAndroidInstall() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                deferredPrompt = null;
                document.getElementById('android-install-bar').style.display = 'none';
            }
        }

        function closeBubble() { 
            document.getElementById('safari-install-bubble').style.display = 'none'; 
        }
        function closeAndroidBar() { 
            document.getElementById('android-install-bar').style.display = 'none'; 
        }
    </script>
    <div id="welcomeModal" class="welcome-overlay">
        <div class="welcome-content">
            <div class="welcome-title">ğŸ‘‹ æ­¡è¿ä½¿ç”¨å›é¥‹ç®¡å®¶</div>
            <div class="welcome-desc">ç‚ºäº†æä¾›æœ€ç²¾æº–çš„æœå‹™<br>è«‹å‹¾é¸æ‚¨<b>ç›®å‰æŒæœ‰</b>çš„å¡ç‰‡ï¼š</div>
            <div class="welcome-list" id="welcomeList"></div>
            <button class="welcome-btn" onclick="saveWelcomeSettings()">é–‹å§‹ä½¿ç”¨ ğŸš€</button>
        </div>
    </div>

    <div class="app-container">
        <div class="header-top-row">
            <div class="author-top">Designed by Pocket Lab</div>
            <div class="version-tag">V124.30(DBS)</div>
        </div>
        <div class="header-section">
            <h1>åˆ·å¡å›é¥‹ç®¡å®¶</h1>
            <div class="subtitle"><span class="today-date" id="dateDisplay"></span></div>
        </div>
        
        <div class="news-ticker">
            <div class="ticker-content" id="news-text">ğŸ‰ æ­¡è¿ä½¿ç”¨åˆ·å¡å›é¥‹ç®¡å®¶ï¼æ–°å¢æ˜Ÿå±• Eco å¡åœ‹å¤–å¯¦é«” 5% åŠ ç¢¼é¸é …ã€‚</div>
        </div>
        <div id="urgent-alert-area"><div class="urgent-card"><div class="urgent-title">ğŸš¨ ä»»å‹™åˆ°æœŸè­¦å ±</div><div id="urgent-list"></div></div></div>
        <div class="total-reward-card">
            <div class="total-info">
                <span class="total-reward-label">ç•¶æœŸç´¯ç©å›é¥‹é ä¼°</span>
                <span class="total-reward-amount" id="totalRewardDisplay">$0</span>
            </div>
             <button class="btn-share-result" onclick="openShareModal()">ğŸ“© æ›¬æˆ°ç¸¾</button>
        </div>
        <div id="card-grid"></div>
        <div style="flex:1;"></div>
        <div class="settings-area">
            <div class="settings-row">
                <button class="btn-tool btn-manage" onclick="openManageModal()">ğŸ’³ ç®¡ç†æˆ‘çš„å¡ç‰‡</button>
            </div>
             <div class="settings-row">
                <button class="btn-tool" onclick="exportData()">ğŸ’¾ å‚™ä»½æª”æ¡ˆ</button>
                <button class="btn-tool" onclick="triggerImport()">ğŸ“¥ è®€æª”é‚„åŸ</button>
                <input type="file" id="fileInput" style="display:none" accept=".json, .txt" onchange="importFile(this)">
            </div>
      
            <button class="btn-ig" onclick="window.open('https://www.instagram.com/pocket_lab_tw', '_blank')">
              ğŸ“¸ æ­¡è¿è¿½è¹¤å£è¢‹å¯¦é©—å®¤
            </button>
            <button class="btn-reset-visible" onclick="resetAllData()">ğŸ—‘ï¸ é‡ç½®æ‰€æœ‰è³‡æ–™</button>
        </div>
    
        <div style="text-align:center; font-size:11px; color:#555; background:#ebebeb; padding:10px; border-radius:8px; margin-top:15px; margin-bottom:10px; line-height:1.4; font-weight:600;">
            âš ï¸ æœ¬å·¥å…·åƒ…å”åŠ©ç”¨æˆ¶ç›£æ§åˆ·å¡é€²åº¦<br>å¯¦éš›å…¥å¸³éœ€ä»¥å„å®¶éŠ€è¡Œåˆ¤å®šç‚ºä¸»
        </div>
        <div style="height:20px;"></div>
    </div>

    <div id="sharePreviewModal" class="modal" onclick="if(event.target===this) document.getElementById('sharePreviewModal').style.display='none'">
        <div class="modal-content" style="background:transparent; box-shadow:none; align-items:center; padding:0; width:100%; max-width:340px;">
            <div id="captureNode" class="share-card-node">
                <div class="share-header">Monthly Rewards</div>
                <div class="share-month" id="shareCardMonth">æˆ°ç¸¾å ±å‘Š</div>
                <div class="share-amount" id="shareCardAmount">$0</div>
                <div class="share-divider"></div>
                <div class="share-list" id="shareCardList"></div> <div class="share-footer">
                    <div>Generated by åˆ·å¡å›é¥‹ç®¡å®¶</div>
                </div>
            </div>

            <div style="background:white; border-radius:20px; padding:15px; width:100%; box-sizing:border-box; box-shadow: 0 10px 30px rgba(0,0,0,0.3); margin-top:10px;">
                <div style="text-align:center; font-size:12px; color:#333; margin-bottom:12px; font-weight:700;">âœ¨ è«‹é¸æ“‡åˆ†äº«æ–¹å¼</div>
                <div class="social-btn-grid">
                    <button class="social-btn instagram" onclick="shareToIG()">ğŸ“¸ Instagram</button>
                    <button class="social-btn facebook" onclick="shareToFB()">ğŸ“˜ Facebook</button>
                    <button class="social-btn threads" onclick="shareToThreads()">ğŸ§µ Threads</button>
                    <button class="social-btn line" onclick="shareToLine()">ğŸŸ¢ LINE</button>
                    <button class="social-btn download" onclick="downloadShareImage()">ğŸ“¥ åƒ…ä¿å­˜åœ–ç‰‡</button>
                </div>
                <div style="text-align:center; font-size:10px; color:#999; margin-top:10px; line-height:1.4;">
                    (FB/IG ç‚ºå‚³åœ–æ¨¡å¼ï¼›LINE/Threads ç‚ºé€£çµæ¨¡å¼)
                </div>
            </div>
            <button style="margin-top:15px; background:none; border:none; color:white; font-size:14px; text-decoration:underline; cursor:pointer;" onclick="document.getElementById('sharePreviewModal').style.display='none'">é—œé–‰è¦–çª—</button>
        </div>
    </div>

    <div id="transactionModal" class="modal" onclick="if(event.target===this) closeModal()">
        <div class="modal-content">
            <div class="modal-body-input">
                <h2 id="modalTitle" style="margin: 0 0 4px 0; font-size: 18px; font-weight: 800; color:#333;"></h2>
                <div style="font-size:12px; color:#888; margin-bottom:10px; font-weight: 500;" id="modalSubtitle"></div>
                <div id="modalParkingInfo" style="background:#FFF9C4; color:#856404; padding:10px; border-radius:10px; font-size:12px; margin-bottom:12px; border-left:4px solid #FFC107; display:none; line-height:1.5;"></div>
                <input type="hidden" id="cardIdInput"> 
                
                <div id="pigRichOptions">
                    <div class="option-row read-only"><label id="labelBaseRate">ğŸ”° åŸºæœ¬å›é¥‹ 1% (ç„¡ä¸Šé™)</label><input type="checkbox" checked disabled></div>
                    <div class="option-row" style="flex-direction:column; align-items:flex-start; gap:0;">
                         <div style="display:flex; justify-content:space-between; width:100%; align-items:center;">
                            <label for="checkBonus10">âš¡ æ–°æˆ¶åŠ ç¢¼ +10% (åˆ·$8,000å°é ‚)</label>
                            <input type="checkbox" id="checkBonus10" checked onchange="updateRewardPreview()">
                        </div>
                        <button onclick="togglePigRichNewUser()" style="border:none; background:none; color:#007AFF; font-size:11px; cursor:pointer; padding:2px 0 6px 0;">ğŸ”½ é»æ“ŠæŸ¥çœ‹ 10% å®šç¾©</button>
                        <div id="pigRichNewUserDetails" class="details-content">
                            <b>â˜… è¡Œå‹•æ”¯ä»˜ï¼š</b><br>LINE Payã€è¡—å£æ”¯ä»˜ã€icash Pay (å«APPå…§ç¹³è²»)<br>
                            <b>â˜… æµ·å¤–æ¶ˆè²»ï¼š</b><br>å«å¯¦é«”åŠç·šä¸Šäº¤æ˜“ (éœ€éå°å¹£/éå°ç£)<br>
                            <b>â˜… æ©Ÿç¥¨ï¼š</b><br>åœ‹å…§å¤–èˆªç©ºå…¬å¸ (é™é€éèˆªç©ºå…¬å¸å®˜ç¶²è³¼è²·)
                        </div>
                    </div>

                    <div class="option-row" style="flex-direction:column; align-items:flex-start; gap:0; border-top:1px dashed #ddd; padding-top:6px;">
                        <div style="display:flex; justify-content:space-between; width:100%; align-items:center;">
                            <label for="checkBonus25">ğŸŒŸ ç²¾é¸é€šè·¯ +2.5% (åˆ·$40è¬å°é ‚)</label>
                            <input type="checkbox" id="checkBonus25" checked onchange="toggleSelectedLogic()">
                        </div>
                        <button onclick="togglePigRichSelected()" style="border:none; background:none; color:#007AFF; font-size:11px; cursor:pointer; padding:2px 0 6px 0;">ğŸ”½ é»æ“ŠæŸ¥çœ‹ç²¾é¸é€šè·¯</button>
                        <div id="pigRichSelectedDetails" class="details-content">
                            <b>(1) æ—…éŠäº¤é€šï¼š</b><br>æ—¥æœ¬PayPay(é™è¡—å£)ã€éŸ“åœ‹ã€Klookã€KKdayã€æ˜“éŠç¶²ã€Agodaã€Airbnbã€DJBã€é…·éŠå¡ã€é«˜éµã€Uberã€å«è»Šå§ã€å°ç£å¿«ç¶«ã€è¯é€šã€USPACEã€ä¿¥äº­åœè»Š<br>
                            <b>(2) ç”Ÿæ´»è³¼ç‰©ï¼š</b><br>æ–°å…‰ä¸‰è¶Šã€é æ±ç™¾è²¨ã€é æ±å·¨åŸã€LaLaportã€ä¸‰äº•Outletã€åº·æ˜¯ç¾ã€ç¾å»‰ç¤¾ã€è–å¾·ç§‘æ–¯<br>
                            <b>(3) å¤–é€ç¾é£Ÿï¼š</b><br>Uber Eatsã€foodpandaã€Foodomoã€EZTABLEã€85åº¦Cã€æ¸…å¿ƒç¦å…¨ã€ä¸‰å•†é¤é£²<br>
                            <b>(4) å½±åŸKæ­Œï¼š</b><br>å¨ç§€ã€åœ‹è³“ã€æ–°å…‰ã€å–œæ¨‚æ™‚ä»£ã€ç§€æ³°ã€éŒ¢æ«ƒã€å¥½æ¨‚è¿ªã€äº«æº«é¦¨ã€å‡±æ‚…ã€æ˜Ÿèšé»ã€Sing Goã€ONCOR
                        </div>
                    </div>

                    <div class="option-row" style="margin-bottom:0; border-top:1px dashed #ddd; padding-top:6px;"><label for="checkIsBill">ğŸ§¾ APPç¹³è²» (åº•1%â†’0.15%)</label><input type="checkbox" id="checkIsBill" onchange="toggleBillLogic()"></div>
                </div>

                <div id="greenCardOptions">
                    <div class="option-row read-only"><label>ğŸ”° åœ‹å…§ 1% / åœ‹å¤– 2%</label><input type="checkbox" checked disabled></div>
                    
                    <div class="option-row" style="flex-direction:column; align-items:flex-start; gap:0;">
                        <div style="display:flex; justify-content:space-between; width:100%; align-items:center;">
                            <label for="checkGreenChannel">ğŸŒ¿ ç¶ è‰²é€šè·¯ 6% (åˆ·$3,000å°é ‚)</label>
                            <input type="checkbox" id="checkGreenChannel" onchange="toggleGreenLogic()">
                        </div>
                        <button onclick="toggleGreenDetails()" style="border:none; background:none; color:#007AFF; font-size:11px; cursor:pointer; padding:2px 0 6px 0;">ğŸ”½ é»æ“ŠæŸ¥çœ‹ç¶ è‰²é€šè·¯</button>
                        <div id="greenDetails" class="details-content">
                            <b>(1) ç¶ è‰²äº¤é€šï¼š</b><br>ç‰¹æ–¯æ‹‰ã€Gogoroã€WeMoã€iRentã€GoShareã€USPACEã€Ubike<br>
                            <b>(2) ç¶ è‰²é£²é£Ÿï¼š</b><br>å¯¬å¿ƒåœ’ã€é™½æ˜æ˜¥å¤©ã€å°å°æ¨¹é£Ÿã€é¤Šå¿ƒèŒ¶æ¨“ã€è‰è”¬å®´ã€ä¸Šå–„è±†å®¶<br>
                            <b>(3) ç¶ è‰²è³¼/æï¼š</b><br>ä¸­è¯é›»ä¿¡(é›»å­å¸³å–®)ã€å°ç£å¤§å“¥å¤§(é›»å­å¸³å–®)ã€é å‚³(é›»å­å¸³å–®)ã€Teslaå……é›»ã€æ…ˆæ¿Ÿã€ä¸–ç•Œå±•æœ›æœƒ
                        </div>
                    </div>
                    
                   <div class="option-row" style="flex-direction:column; align-items:flex-start; gap:0; border-top:1px dashed #ddd; padding-top:6px; margin-top:6px;">
                         <button onclick="toggleParkingDetails()" style="border:none; background:none; color:#007AFF; font-size:11px; cursor:pointer; padding:2px 0 6px 0; font-weight:700;">ğŸ…¿ï¸ æŸ¥çœ‹å…è²»åœè»Šé©ç”¨åå–® (éœ€ä¸Šæœˆæ»¿é¡)</button>
                         <div id="greenParkingDetails" class="details-content">
                            <b>å°ç£è¯é€šã€è©®ç‡Ÿã€ViVi PARKã€å˜Ÿå˜Ÿæˆ¿ã€è»Šéº»å‰</b><br>
                            <span style="font-size:10px; color:#555;">(æ¯æ—¥1æ¬¡ã€æ¯æ¬¡2å°æ™‚ã€æ¯æœˆæœ€é«˜5æ¬¡)</span>
                         </div>
                    </div>

                    <div class="option-row" style="margin-top:6px; border-top:1px dashed #ddd; padding-top:6px; margin-bottom:0;"><label for="checkForeign">âœˆï¸ åœ‹å¤–æ¶ˆè²» 2% (ç„¡ä¸Šé™)</label><input type="checkbox" id="checkForeign" onchange="toggleForeignLogic()"></div>
                </div>
                
                <div id="uniOptions">
                    <div class="option-row read-only"><label id="labelUniBase">ğŸ”° ä»»æ„é¸ 3.5% (åˆ·$4è¬å°é ‚)</label><input type="checkbox" checked disabled></div>
                    <div class="option-row"><label for="checkUniUp">ğŸ†™ è¨‚é–± UP é¸ 4.5% (åˆ·$14è¬å°é ‚)</label><input type="checkbox" id="checkUniUp" onchange="toggleUniUpLogic()"></div>
                    <div class="option-row" style="margin-top:6px; border-top:1px dashed #ddd; padding-top:6px; margin-bottom:0;"><label for="checkUniBonus">ğŸ”¥ çµ±ä¸€æ™‚ä»£ä»»å‹™ +3% (åˆ·$1.6è¬å°é ‚)</label><input type="checkbox" id="checkUniBonus" onchange="updateRewardPreview()"></div>
                </div>
                
                <div id="uniOpenOptions">
                    <div class="option-row read-only"><label>ğŸ”° åŸºæœ¬å›é¥‹ 1% (ç„¡ä¸Šé™)</label><input type="checkbox" checked disabled></div>
                    <div class="option-row"><label for="checkUniGroup">ğŸª çµ±ä¸€é›†åœ˜ +2% (åˆ·$2.5è¬å°é ‚)</label><input type="checkbox" id="checkUniGroup" onchange="toggleUniGroup()"></div>
                    <div class="option-row"><label for="checkUniIcash">ğŸ“± icash Pay +4% (åˆ·$3,750å°é ‚)</label><input type="checkbox" id="checkUniIcash" onchange="toggleUniIcash()"></div>
                    
                    <div class="option-row" style="border-top:1px dashed #ddd; padding-top:6px; margin-top:6px; flex-direction:column; align-items:flex-start;">
                        <label style="margin-bottom:4px;">ğŸƒ è¸©é»ä»»å‹™ (2å®¶èµ·è·³ï¼Œæœ€é«˜+4%)</label>
                        <div class="brand-grid" id="uniBrandGrid"></div>
                        <div style="font-size:10px; color:#FF9800; margin-top:6px; font-weight:700;" id="taskBonusDisplay">ç›®å‰ 0 å®¶ (åŠ ç¢¼ 0%)</div>
                    </div>
                    <div class="option-row" style="margin-top:6px; border-top:1px dashed #ddd; padding-top:6px;">
                        <label for="checkUniOverseas">âœˆï¸ æµ·å¤–å¯¦é«” 11% (åˆ·$6,250å°é ‚)</label>
                        <input type="checkbox" id="checkUniOverseas" onchange="toggleUniOverseas()">
                    </div>
                </div>
                
                <div id="jiangOptions">
                    <div class="option-row read-only" style="background:#eee; padding:8px; border-radius:6px; margin-bottom:8px;"><label>ğŸ”° åŸºæœ¬å›é¥‹ 0.5% (ç„¡ä¸Šé™)</label><input type="radio" name="jiangMode" value="base" checked onchange="updateRewardPreview()"></div>
                    
                    <div class="option-row" style="flex-direction:column; align-items:flex-start; gap:0px; border-top:1px dashed #ddd; padding-top:8px;">
                        <div style="display:flex; justify-content:space-between; width:100%; align-items:center; margin-bottom:4px;">
                            <label for="rbJiangSelected">ğŸ›ï¸ ç”Ÿæ´»å‡ç´š +4.5% (åˆ·$6,666å°é ‚)</label>
                            <input type="radio" name="jiangMode" id="rbJiangSelected" value="selected" onchange="updateRewardPreview()">
                        </div>
                        <button onclick="toggleJiangDetails()" style="border:none; background:none; color:#007AFF; font-size:11px; cursor:pointer; padding:0 0 6px 0;">ğŸ”½ é»æ“ŠæŸ¥çœ‹æŒ‡å®šé€šè·¯æ¸…å–®</button>
                        <div id="jiangDetails" class="details-content">
                            <b>(1) Aiå·¥å…·åŠæ•¸ä½å·¥å…·ï¼š</b><br>ChatGPTã€Canvaã€Claudeã€Cursorã€Duolingoã€Gammaã€Geminiã€Notionã€Perplexityã€Speakã€Apple åª’é«”æœå‹™ã€Google Play<br>
                            <b>(2) å­¸ç¿’å¹³å°ï¼š</b><br>Hahowã€Udemyã€VoiceTubeã€PressPlayã€AmazingTalkerã€Readmooã€æ™ºåŸºç§‘æŠ€(å­¸æ€é…·)<br>
                            <b>(3) åœ‹å…§å¤–é€å¹³å°(ä¸å«æœƒå“¡è²»ç”¨)ï¼š</b><br>Uber Eatsã€foodpanda<br>
                            <b>(4) ç”Ÿæ´»å®¶å±…ï¼š</b><br>IKEAå®œå®¶å®¶å±…ã€ç‰¹åŠ›å±‹ã€HOLA<br>
                            <b>(5) æŒ‡å®šè¶…å•†è¶…å¸‚ï¼š</b><br>7-ELEVEN å¯¦é«”é–€å¸‚(icash payã€è¡—å£æ”¯ä»˜ã€æ©˜å­æ”¯ä»˜)ã€å…¨å®¶ä¾¿åˆ©å•†åº—(è¡—å£æ”¯ä»˜)ã€å®¶æ¨‚ç¦<br>
                            <b>(6) é‹å‹•å¥èº«ï¼š</b><br>World Gymã€BEING Fitã€Curvesã€å¥èº«å·¥å» <br>
                            <b>(7) åœ‹å…§é¤å»³ï¼š</b><br>åœ‹å…§é¤å»³(MCC 5811/5812/5814/5462)ã€é€£é–é€Ÿé£Ÿï¼éº¥ç•¶å‹<br>
                            <b>(8) è¡Œå‹•æ”¯ä»˜ï¼š</b><br>LINE Payã€è¡—å£æ”¯ä»˜ã€icash Payã€æ©˜å­æ”¯ä»˜ã€æ‚ éŠä»˜ã€Hami Payã€PiéŒ¢åŒ…ã€TWQR<br>
                            <b>(9) äº¤é€šï¼š</b><br>ä¸€å¡é€šè‡ªå‹•åŠ å€¼ã€é«˜éµ(å«é«˜éµappç·šä¸Šåˆ·å¡)
                        </div>
                    </div>
                    
                    <div class="option-row" id="jiangTravelRow" style="border-top:1px dashed #ddd; padding-top:8px; margin-top:4px; flex-direction:column; align-items:flex-start;">
                         <div style="display:flex; justify-content:space-between; width:100%; align-items:center;">
                            <label for="rbJiangTravel">âœˆï¸ æ—…éŠåŠ ç¢¼ +4.5% (åˆ·$1.1è¬å°é ‚)</label>
                            <input type="radio" name="jiangMode" id="rbJiangTravel" value="travel" onchange="updateRewardPreview()">
                        </div>
                        <button onclick="toggleJiangTravelDetails()" style="border:none; background:none; color:#007AFF; font-size:11px; cursor:pointer; padding:2px 0 6px 0;">ğŸ”½ é»æ“ŠæŸ¥çœ‹æ—…éŠ/èˆªç©º/æ—…è¡Œç¤¾</button>
                        <div id="jiangTravelDetails" class="details-content">
                            <b>(1) æµ·å¤–åŠèˆªç©ºï¼š</b><br>æ¶ˆè²»åœ‹åˆ¥éå°ç£æˆ–å¹£åˆ¥éå°å¹£ã€èˆªç©º MCC 3000~3350/4511/4723<br>(æ˜Ÿå®‡ã€è¯èˆªã€é•·æ¦®ã€åœ‹æ³°ã€è™èˆªã€é˜¿è¯é…‹ã€é…·èˆªã€æ¨‚æ¡ƒã€æ·æ˜Ÿã€æ—¥èˆªã€ANAã€äºèˆªã€è¯åˆã€è¶Šæ·ã€å¤§éŸ“ã€é”ç¾ã€åœŸè€³å…¶ã€å¡é”ã€æ³•èˆª)<br>
                            <b>(2) æ—…è¡Œç¤¾ï¼š</b><br>æ˜“éŠç¶²ã€é›„ç…ã€å¯æ¨‚ã€æ±å—ã€äº”ç¦ã€ç‡¦æ˜Ÿã€å±±å¯Œã€é•·æ±ã€é³³å‡°ã€æ˜“é£›ç¶²ã€ç†æƒ³ã€æ°¸åˆ©ã€ä¸‰è³€
                        </div>
                    </div>
                    <div id="jiangTravelExpMsg" style="font-size:10px; color:#d32f2f; margin-top:2px; display:none;">âš ï¸ æ´»å‹•å·²æ–¼ 3/31 çµæŸ</div>
                </div>

                <div id="dbsEcoOptions">
                      <div class="option-row read-only"><label>ğŸ”° åœ‹å…§å¤–ä¸€èˆ¬ 1% (ç„¡ä¸Šé™)</label><input type="checkbox" checked disabled></div>
                      
                      <div class="option-row" style="background:#fff3e0; padding:8px; border-radius:6px; margin-top:6px; flex-direction:column; align-items:flex-start;">
                         <div style="display:flex; justify-content:space-between; width:100%; align-items:center;">
                            <label for="checkDbsLinePay">âš¡ æ–°æˆ¶ LINE Pay +9% (åˆ·$11,111å°é ‚)</label>
                            <input type="checkbox" id="checkDbsLinePay" onchange="toggleDbsLogic('linepay')">
                        </div>
                        <div style="font-size:10px; color:#d32f2f; margin-top:4px;">*ä¸Šé™ 1000 é»</div>
                      </div>
                      
                      <div class="option-row" style="margin-top:6px; border-top:1px dashed #ddd; padding-top:6px; flex-direction:column; align-items:flex-start;">
                         <div style="display:flex; justify-content:space-between; width:100%; align-items:center;">
                            <label for="checkDbsGreen">ğŸŒ¿ ç¶ è‰²/ç‰¹æ–¯æ‹‰ +9% (åˆ·$3,333å°é ‚)</label>
                            <input type="checkbox" id="checkDbsGreen" onchange="toggleDbsLogic('green')">
                        </div>
                        <button onclick="toggleDbsDetails()" style="border:none; background:none; color:#007AFF; font-size:11px; cursor:pointer; padding:2px 0 6px 0;">ğŸ”½ é»æ“ŠæŸ¥çœ‹åŠ ç¢¼è©³æƒ…</button>
                        <div id="dbsDetails" class="details-content">
                            <b>ç¶ è‰²æ¶ˆè²» (å«ç‰¹æ–¯æ‹‰/Gogoro)ï¼š</b><br>åŠ ç¢¼ 9% (ä¸Šé™ 300 é»)ã€‚<br>é€šè·¯ï¼šTeslaå……é›»/é…ä»¶ã€Gogoroé›»æ± è³‡è²»ã€æ˜Ÿå·´å…‹(éš¨è¡Œå¡å„²å€¼ä¸é©ç”¨)ã€é®®ä¹³åŠã€èŒ¶ç±½å ‚ã€å°ç£å¤§è»ŠéšŠã€iRentã€WeMoã€GoShare
                        </div>
                      </div>

                      <div class="option-row" style="margin-top:6px; border-top:1px dashed #ddd; padding-top:6px;">
                         <label for="checkDbsForeign">âœˆï¸ åœ‹å¤–å¯¦é«” +4% (åˆ·$1.5è¬å°é ‚)</label>
                         <input type="checkbox" id="checkDbsForeign" onchange="toggleDbsLogic('foreign')">
                      </div>
                </div>
              <div id="happyOptions">
                      <div class="option-row read-only"><label>ğŸ”° ä¸€èˆ¬æ¶ˆè²» 0.5% (ç„¡ä¸Šé™)</label><input type="checkbox" checked disabled></div>
                      
                      <div class="option-row" style="flex-direction:column; align-items:flex-start; gap:0;">
                        <div style="display:flex; justify-content:space-between; width:100%; align-items:center;">
                            <label for="checkHappyPet">ğŸ¶ å¯µç‰©é€šè·¯ +9.5% (åˆ·$5,263å°é ‚)</label>
                            <input type="checkbox" id="checkHappyPet" onchange="toggleHappyPet()">
                        </div>
                        <button onclick="toggleHappyPetDetails()" style="border:none; background:none; color:#007AFF; font-size:11px; cursor:pointer; padding:2px 0 6px 0;">ğŸ”½ é»æ“ŠæŸ¥çœ‹å¯µç‰©é€šè·¯</button>
                        <div id="happyPetDetails" class="details-content">
                            <b>(1) æŒ‡å®šå¯µç‰©é€£é–ï¼š</b><br>å¯µç‰©å…¬åœ’ã€æ±æ£®å¯µç‰©ã€é­šä¸­é­šã€è²“ç‹—éšŠé•·ã€æ¯›å­©å¸‚é›†ã€é‡‘å‰åˆ©ã€å¥½ç‹—å‘½ã€å¥½ç‹—é‹ã€é‡‘ç‹å­ã€æ„›è²“åœ’ã€ç¦å£½å¯µç‰©æ——è‰¦é¤¨<br>
                            <b>(2) 2026 æ–°å¢å“ç‰Œï¼š</b><br>æ±ªå–µæ˜Ÿçƒã€æ€ªç¸éƒ¨è½ã€è¶…å‡å°å§ã€Hero Mama<br>
                            <b>(3) é†«ç™‚èˆ‡ç¾å®¹ï¼š</b><br>ç¸é†«è¨ºæ‰€ã€å‹•ç‰©é†«é™¢ã€å¯µç‰©æ—…é¤¨ã€å¯µç‰©ç¾å®¹ (MCC 0742, 5995)
                        </div>
                      </div>

                      <div class="option-row" style="flex-direction:column; align-items:flex-start; gap:0; border-top:1px dashed #ddd; padding-top:6px;">
                        <div style="display:flex; justify-content:space-between; width:100%; align-items:center;">
                            <label for="checkHappyPeace">ğŸ½ï¸ å¤§å°å®‰å¿ƒåˆ· +3.5% (åˆ·$5,714å°é ‚)</label>
                            <input type="checkbox" id="checkHappyPeace" onchange="toggleHappyPeace()">
                        </div>
                        <button onclick="toggleHappyPeaceDetails()" style="border:none; background:none; color:#007AFF; font-size:11px; cursor:pointer; padding:2px 0 6px 0;">ğŸ”½ é»æ“ŠæŸ¥çœ‹é¤å»³/è—¥å±€/å±…å®¶</button>
                        <div id="happyPeaceDetails" class="details-content">
                            <b>(1) åœ‹å…§é¤å»³ï¼š</b><br>åœ‹å…§å„å¤§æŒ‡å®šé¤å»³ (MCC 5811, 5812, 5813, 5814)<br>
                            <b>(2) å©¦å¹¼è—¥å±€/å±…å®¶ï¼š</b><br>å¤§æ¨¹ã€æä¸€ã€ç¶­åº·ã€èºç…ã€å¡å¤šæ‘©ã€å®œå…’æ¨‚ã€ç‡Ÿé¤ŠéŠ€è¡Œã€éº—å…’é‡‡å®¶ã€åª½å’ªæ¨‚å±…å®¶æœå‹™ã€æ½”å®¢å¹«<br>
                            <b>(3) é‹å‹•å¥èº«ï¼š</b><br>ä½ç™»å¦®çµ²ã€å¥èº«å·¥å» ã€World Gymã€BEING spaã€BEING sportã€Curveså¯çˆ¾å§¿
                        </div>
                      </div>

                      <div class="option-row" style="flex-direction:column; align-items:flex-start; gap:0; border-top:1px dashed #ddd; padding-top:6px;">
                        <div style="display:flex; justify-content:space-between; width:100%; align-items:center;">
                            <label for="checkHappyLife">ğŸ›’ ç”Ÿæ´»ç¦®é‡ +3.5% (åˆ·$5,714å°é ‚)</label>
                            <input type="checkbox" id="checkHappyLife" onchange="toggleHappyLife()">
                        </div>
                        <button onclick="toggleHappyLifeDetails()" style="border:none; background:none; color:#007AFF; font-size:11px; cursor:pointer; padding:2px 0 6px 0;">ğŸ”½ é»æ“ŠæŸ¥çœ‹ç™¾è²¨/é‡è²©/äº¤é€š</button>
                        <div id="happyLifeDetails" class="details-content">
                            <b>(1) ç™¾è²¨/Outletï¼š</b><br>é æ±ç™¾è²¨ã€SOGOã€å·¨åŸã€å¤§é ç™¾ã€å—ç´¡ã€å¤¢æ™‚ä»£ã€skmparkã€å°šé †ã€å¤§é­¯é–£(æ¹³é›…)ã€æ¡ƒçŸ¥é“ã€å¤§æ±Ÿã€å°èŒ‚ã€æ–°æœˆã€é é›„ã€å®åŒ¯ã€CITYLINKã€ç¾éº—è¯ã€å¤§è‘‰é«˜å³¶å±‹ã€çµ±ä¸€æ™‚ä»£ã€æ•…å®®ã€ç§€æ³°ã€ç’°çƒã€IKEAã€éº—å¯¶ã€LaLaport<br>
                            <b>(2) è¶…å¸‚é‡è²©/ç”Ÿæ©Ÿï¼š</b><br>æ„›è²·ã€å®¶æ¨‚ç¦ã€ç¾å»‰ç¤¾ã€å°åŒ—ã€å¤§è²·å®¶ã€å–œäº’æƒ ã€æ£‰èŠ±ç”°ã€è–å¾·ç§‘æ–¯ã€æ°¸è±é¤˜ç”ŸæŠ€ã€é‡Œä»ã€å°ç£ä¸»å©¦è¯ç›Ÿã€å¥åº·é£Ÿå½©ã€å®‰éº—ã€è‘¡çœ¾ã€ç¾æ¨‚å®¶<br>
                            <b>(3) äº¤é€šé›»ä¿¡ï¼š</b><br>åœ‹å…§åŠ æ²¹(ä¸­æ²¹/å°äº/å°å¡‘)ã€gogoroã€Teslaã€å°ç£å¤§è»ŠéšŠã€yoxiã€Uber(å°ç£)ã€GoShareã€iRentã€WeMoã€é å‚³/å°å“¥å¤§å¸³å–®<br>
                            <b>(4) æ•™è‚²/æ›¸åº—ï¼š</b><br>å°ç£è”¦å±‹ã€èª å“ã€åšå®¢ä¾†ã€é‡‘çŸ³å ‚ã€å·¨åŒ ã€è¯æˆã€æœ±å®—æ…¶ã€é›²é–€
                        </div>
                      </div>

                      <div class="option-row" style="margin-top:6px; border-top:1px dashed #ddd; padding-top:6px; margin-bottom:0;"><label for="checkHappyForeign">âœˆï¸ åœ‹å¤–æ¶ˆè²» +2% (ç„¡ä¸Šé™)</label><input type="checkbox" id="checkHappyForeign" onchange="toggleHappyForeign()"></div>
                    <div id="happyDashboard" class="happy-dashboard"></div>
                </div>

                <div id="hsbcOptions">
                      <div class="option-row" style="border-bottom:1px solid #eee; padding-bottom:10px; margin-bottom:10px;">
                        <span style="font-weight:700; color:#333;">ğŸ’³ é¸æ“‡æ‚¨çš„å¡ç‰‡ç­‰ç´š (è‡ªå‹•è¨˜æ†¶)ï¼š</span>
                        <div style="display:flex; gap:15px; margin-top:8px;">
                            <label style="display:flex; align-items:center; font-weight:normal; font-size:13px;"><input type="radio" name="hsbcTier" value="infinite" onchange="saveHsbcTier()"> ç„¡é™å¡</label>
                            <label style="display:flex; align-items:center; font-weight:normal; font-size:13px;"><input type="radio" name="hsbcTier" value="signature" onchange="saveHsbcTier()"> å¾¡ç’½å¡</label>
                        </div>
                    </div>
                    <div class="option-row"><label for="hsbcInitialMiles">ğŸ å·²æœ‰å“©ç¨‹ (èµ·å§‹å€¼)</label><input type="number" id="hsbcInitialMiles" onchange="saveHsbcInitial()" style="text-align:right; width: 100px; border:1px solid #ccc; border-radius:4px; padding:4px;" placeholder="0"></div>
                    <div class="option-row"><label for="hsbcRedeemedMiles" style="color:#d32f2f;">â– å·²å…Œæ›å“©ç¨‹</label><input type="number" id="hsbcRedeemedMiles" onchange="saveHsbcSettings()" style="text-align:right; width: 100px; border:1px solid #ffcdd2; color:#d32f2f; border-radius:4px; padding:4px;" placeholder="0"></div>
                      <div class="option-row" style="margin-top:10px; border-top:1px dashed #ddd; padding-top:6px;"><label for="checkHsbcForeign">âœˆï¸ åœ‹å¤–æ¶ˆè²»</label><input type="checkbox" id="checkHsbcForeign" onchange="updateRewardPreview()"></div>
                </div>
                
                <div id="richartOptions">
                    <div style="font-size:12px; color:#D32F2F; background:#FFEBEE; padding:8px; border-radius:6px; margin-bottom:10px; font-weight:700; border:1px solid #FFCDD2;">
                        âš ï¸ éœ€ç¶å®š Richart å¸³æˆ¶è‡ªå‹•æ‰£ç¹³ (æœªç¶åƒ…0.3%)
                    </div>
                    <div class="option-row"><label for="rbRichartGeneral">ğŸ”° ä¸€èˆ¬æ¶ˆè²» (0.3%)</label><input type="radio" name="richartMode" id="rbRichartGeneral" value="general" checked onchange="toggleRichartLogic()"></div>
                    <div class="option-row"><label for="rbRichartPay">ğŸ“± å°æ–°Pay/Pay+ (3.8%)</label><input type="radio" name="richartMode" id="rbRichartPay" value="pay" onchange="toggleRichartLogic()"></div>
                    <div class="option-row"><label for="rbRichartOnline">ğŸ›ï¸ æŒ‡å®šç¶²è³¼/å½±éŸ³ (3.3%)</label><input type="radio" name="richartMode" id="rbRichartOnline" value="online" onchange="toggleRichartLogic()"></div>
                    <div class="option-row"><label for="rbRichartLine">ğŸŸ¢ LINE Pay (2.3%)</label><input type="radio" name="richartMode" id="rbRichartLine" value="line" onchange="toggleRichartLogic()"></div>
                    <div class="option-row" style="border-top:1px dashed #ddd; margin-top:6px; padding-top:6px;"><label for="rbRichartOverseas">âœˆï¸ æµ·å¤–æ¶ˆè²» (3.3%)</label><input type="radio" name="richartMode" id="rbRichartOverseas" value="overseas" onchange="toggleRichartLogic()"></div>
                    <div style="font-size:10px; color:#555; margin-top:8px; opacity:0.8;">
                        ğŸ’¡ å°æ’‡æ­¥ï¼šè‹¥ç¶²è³¼ä½¿ç”¨å°æ–°Payï¼Œè«‹å‹¾é¸ã€Œå°æ–°Pay (3.8%)ã€
                    </div>
                </div>

                <div id="fubonJOptions">
                    <div class="option-row read-only"><label id="labelFubonBase">ğŸ”° åœ‹å…§æ¶ˆè²» 1% (ç„¡ä¸Šé™)</label><input type="checkbox" checked disabled></div>
                    
                    <div class="option-row"><label for="checkFubonJGeneral">ğŸ‡¯ğŸ‡µğŸ‡°ğŸ‡· æ—¥éŸ“ä¸€èˆ¬æ¶ˆè²» (3%)</label><input type="checkbox" id="checkFubonJGeneral" onchange="toggleFubonJGeneral()"></div>

                    <div class="option-row" style="border-top:1px dashed #ddd; padding-top:6px; flex-direction:column; align-items:flex-start;">
                        <div style="margin-bottom:4px; font-size:11px; color:#d32f2f;">âš ï¸ å¯¦é«”/äº¤é€šå¡åŠ ç¢¼ (å„è‡ªç¨ç«‹è¨ˆç®—)</div>
                        
                        <div style="display:flex; justify-content:space-between; width:100%; align-items:center; margin-bottom:6px;">
                            <label for="checkFubonJKorea">ğŸ›ï¸ æ—¥éŸ“ç•¶åœ°å¯¦é«” +3% (åˆ·$3.3è¬å°é ‚)</label>
                            <input type="checkbox" id="checkFubonJKorea" onchange="toggleFubonJPhysical()">
                        </div>
                        
                        <div style="display:flex; justify-content:space-between; width:100%; align-items:center; margin-bottom:6px;">
                             <label for="checkFubonJThai">ğŸ‡¹ğŸ‡­ æ³°åœ‹ç•¶åœ°å¯¦é«” +5% (åˆ·$2è¬å°é ‚)</label>
                             <input type="checkbox" id="checkFubonJThai" onchange="toggleFubonJThai()">
                        </div>
                        
                        <div style="display:flex; justify-content:space-between; width:100%; align-items:center;">
                             <label for="checkFubonJSuica">ğŸ æ—¥æœ¬äº¤é€šå¡ +7% (åˆ·$2,857å°é ‚)</label>
                             <input type="checkbox" id="checkFubonJSuica" onchange="toggleFubonJSuica()">
                        </div>
                    </div>
                </div>

                <div id="jiheOptions">
                    <div class="option-row read-only"><label id="labelJiheBase">ğŸ”° åœ‹å…§æ¶ˆè²» 1% (ç„¡ä¸Šé™)</label><input type="checkbox" checked disabled></div>
                    <div class="option-row"><label for="checkJiheJapan">ğŸ‡¯ğŸ‡µ åˆ‡æ›ç‚ºæ—¥æœ¬æ¶ˆè²» (2.5%)</label><input type="checkbox" id="checkJiheJapan" onchange="toggleJiheLogic()"></div>
                    <div class="option-row" id="rowJiheApple" style="border-top:1px dashed #ddd; padding-top:6px;"><label for="checkJiheApple">ğŸ Apple Pay +1.5% (åˆ·$4è¬å°é ‚)</label><input type="checkbox" id="checkJiheApple" onchange="updateRewardPreview()"></div>
                    
                    <div class="option-row" id="rowJiheDomesticJapanese" style="border-top:1px dashed #ddd; padding-top:6px; flex-direction:column; align-items:flex-start;">
                        <div style="display:flex; justify-content:space-between; width:100%; align-items:center;">
                             <label for="checkJiheDomesticJapanese">ğŸ‡¹ğŸ‡¼ åœ‹å…§æ—¥ç³»ååº— +4% (åˆ·$1.25è¬å°é ‚)</label>
                             <input type="checkbox" id="checkJiheDomesticJapanese" onchange="updateRewardPreview()">
                         </div>

                        <button onclick="toggleJiheDetails()" style="border:none; background:none; color:#007AFF; font-size:11px; cursor:pointer; padding:2px 0 6px 0;">ğŸ”½ é»æ“ŠæŸ¥çœ‹æŒ‡å®šé€šè·¯</button>
                        <div id="jiheDetails" class="details-content">
                            <b>(1) æœé£¾ï¼š</b><br>UNIQLOã€GUã€æ€å¤¢æ¨‚ã€GLOBAL WORKã€niko and â€¦ã€LOWRYS FARMã€LAKOLEã€studio CLIPã€repipi armarioã€HAREã€Heatherã€PAGEBOYã€RAGEBLUEã€LEPSIMã€JEANASIS<br>
                            <b>(2) ç”Ÿæ´»/è—¥å¦ï¼š</b><br>DAISOå¤§å‰µã€Standard Productsã€THREEPPYã€æ—¥è—¥æœ¬èˆ–ã€æ¾æœ¬æ¸…ã€Tomod'sã€æœ­å¹Œè—¥å¦ã€TSUTAYA BOOKSTOREã€HANDSå°éš†æ‰‹å‰µé¤¨ã€å®œå¾—åˆ©å®¶å±…
                        </div>
                    </div>
                </div>
                
                <div id="kumamonOptions">
                    <div class="option-row read-only"><label id="labelKumamonBase">ğŸ”° åœ‹å…§æ¶ˆè²» 0.5% (ç„¡ä¸Šé™)</label><input type="checkbox" checked disabled></div>
                    <div class="option-row" id="rowKumamonJapan"><label for="checkKumamonJapan">ğŸ‡¯ğŸ‡µ åˆ‡æ›ç‚ºæ—¥æœ¬æ¶ˆè²» (2.5%)</label><input type="checkbox" id="checkKumamonJapan" onchange="toggleKumamonLogic()"></div>
                    <div id="groupKumamonJapan" style="display:none;">
                        <div class="option-row" style="border-top:1px dashed #ddd; padding-top:6px; flex-direction:column; align-items:flex-start;">
                            <div style="display:flex; justify-content:space-between; width:100%; align-items:center;">
                                <label for="checkKumamonDesignated">ğŸ» æŒ‡å®šé€šè·¯ +6% (åˆ·$8,333å°é ‚)</label>
                                <input type="checkbox" id="checkKumamonDesignated" onchange="toggleKumamonSub('designated')">
                            </div>
                            <button onclick="toggleKumamonDetails()" style="border:none; background:none; color:#007AFF; font-size:11px; cursor:pointer; padding:2px 0 6px 0;">ğŸ”½ é»æ“ŠæŸ¥çœ‹æŒ‡å®šé€šè·¯ (ç†Šå¥½ç³»åˆ—)</button>
                            <div id="kumamonDetails" class="details-content">
                                <b>(1) ç†Šå¥½éŠ (äº¤é€š/ä½å®¿)ï¼š</b><br>
                                äº¤é€šICå¡ï¼šSUICAã€PASMOã€ICOCA<br>
                                è‡ªé§•ç§Ÿè»Šï¼šTOYOTA Rent a Carã€Times Car Rentalã€NIPPON RENT-A-CARã€OTSç§Ÿè»Šã€ORIXç§Ÿè»Š<br>
                                éµè·¯/èˆªç©ºï¼šJRéµè·¯å…¬å¸ã€æ—¥æœ¬èˆªç©º<br>
                                ä½å®¿ï¼šæ¨‚å¤©æ—…éŠã€æ±æ©«INNã€æ˜Ÿé‡é›†åœ˜<br><br>
                                
                                <b>(2) ç†Šå¥½ç© (æ¨‚åœ’)ï¼š</b><br>
                                æ±äº¬è¿ªå£«å°¼ã€è¯ç´å…„å¼Ÿå“ˆåˆ©æ³¢ç‰¹å½±åŸã€æ—¥æœ¬ç’°çƒå½±åŸã€è±ªæ–¯ç™»å ¡ã€ä¹å·éæ´²ç…æ¨‚åœ’ã€åå¤å±‹æ¨‚é«˜æ¨‚åœ’ã€å‰ä¼Šå¡å“‡æ¨‚åœ’<br><br>
                                
                                <b>(3) ç†Šå¥½åƒ (é¤é£²)ï¼š</b><br>
                                ç‡’è‚‰ï¼šå‹çƒˆäº­ã€æ•˜æ•˜è‹‘ã€ç‰›è§’ã€åŠ›ä¸¸ç‡’è‚‰ã€å…­æ­Œä»™<br>
                                æ¼¢å ¡/å’–å•¡ï¼šshake shackã€DOUTOR Coffeeã€Fuglen<br>
                                å…¶ä»–ï¼šé³¥è²´æ—ã€ä¸€è˜­æ‹‰éºµã€æ¾å±‹ã€SUKIYAã€å£½å¸éƒã€è—å£½å¸<br><br>
                                
                                <b>(4) ç†Šå¥½è²· (è³¼ç‰©)ï¼š</b><br>
                                å®¶é›»/è—¥å¦ï¼šBicCameraã€Yodobashiã€æ¾æœ¬æ¸…ã€å”å‰è»»å¾·ã€å¤§åœ‹è—¥å¦<br>
                                ç”Ÿæ´»/å•†åŸï¼šç„¡å°è‰¯å“ã€æ—¥æœ¬MITSUIè³¼ç‰©åœ’å€<br>
                                æœé£¾ï¼šUNIQLOã€GU
                            </div>
                        </div>
                    </div>
                    
                    <div class="option-row" style="border-top:1px dashed #ddd; padding-top:6px;"><label for="checkKumamonPayPay">ğŸ“± PayPay 5% (å­£åˆ·$2,857å°é ‚)</label><input type="checkbox" id="checkKumamonPayPay" onchange="toggleKumamonSub('paypay')"></div>
                </div>
                
                <div id="sinopacCurrencyOptions">
                    <div class="option-row" style="background:#eee; padding:8px; border-radius:6px; margin-bottom:8px; flex-direction:column; align-items:flex-start;">
                         <label style="margin-bottom:4px; color:#555;">ğŸ’° é¸æ“‡è³‡æ ¼ç­‰ç´š (è‡ªå‹•è¨˜æ†¶)</label>
                         <div style="display:flex; gap:10px; width:100%;">
                             <label style="font-weight:normal; font-size:12px; display:flex; align-items:center;"><input type="radio" name="currencyLevel" value="low" onchange="saveCurrencyLevel()" checked> Level 1 (é™åˆ·$7,500)</label>
                             <label style="font-weight:normal; font-size:12px; display:flex; align-items:center;"><input type="radio" name="currencyLevel" value="high" onchange="saveCurrencyLevel()"> Level 2 (é™åˆ·$20,000)</label>
                         </div>
                         <div style="font-size:10px; color:#999; margin-top:2px;">Level 1: è‡ªå‹•æ‰£ç¹³+é›»å­å¸³å–® | Level 2: å¾€ä¾†è³‡ç”¢â‰¥10è¬æˆ–å¤§æˆ¶</div>
                    </div>
                    
                    <div class="option-row read-only"><label id="labelCurrencyBase">ğŸ”° åœ‹å…§ä¸€èˆ¬ 1%</label><input type="checkbox" checked disabled></div>

                    <div class="option-row"><label>ğŸ‡¹ğŸ‡¼ åœ‹å…§æ¶ˆè²»</label><input type="radio" name="currencyType" value="domestic" checked onchange="toggleCurrencyLogic()"></div>

                    <div class="option-row" style="border-top:1px dashed #ddd; padding-top:6px; flex-direction:column; align-items:flex-start;">
                        <div style="display:flex; justify-content:space-between; width:100%; align-items:center;">
                            <label for="rbCurrencySelected">âœˆï¸ æµ·å¤–/ç²¾é¸ +4% (è¦‹ç­‰ç´šå°é ‚)</label>
                            <input type="radio" name="currencyType" id="rbCurrencySelected" value="selected" onchange="toggleCurrencyLogic()">
                        </div>

                        <button onclick="toggleCurrencyDetails()" style="border:none; background:none; color:#007AFF; font-size:11px; cursor:pointer; padding:0 0 6px 0;">ğŸ”½ é»æ“ŠæŸ¥çœ‹ç²¾é¸é€šè·¯</button>
                        <div id="currencyDetails" class="details-content">
                            <b>(1) åœ‹å¤–å¯¦é«”ï¼š</b><br>éå°ç£åœ°å€ä¸”éå°å¹£ä¹‹ä¸€èˆ¬äº¤æ˜“<br>
                            <b>(2) ç¶²è³¼æ¶ˆè²»ï¼š</b><br>Suica/PASMO/ICOCAå„²å€¼ã€Amazonã€Rakutenã€æ·˜å¯¶ã€eBayã€Gmarketã€iHerbã€Selfridgeã€Mercariã€å¤§åœ‹è—¥å¦ã€Sugiè—¥å¦ã€Olive Young<br>
                            <b>(3) æ—…éŠé€šè·¯ï¼š</b><br>èˆªç©ºå…¬å¸ã€æ—…è¡Œç¤¾ã€Booking.comã€Agodaã€Hotels.comã€Expediaã€Trip.comã€Airbnbã€Klookã€KKdayã€Trivagoã€AsiaYoã€æ­ç‰¹å„€æ¾å±±æ©Ÿå ´åœè»Š
                        </div>
                    </div>
                </div>

                <div id="sinopacMitsuiOptions">
                    <div class="option-row read-only"><label id="labelMitsuiBase">ğŸ”° ä¸€èˆ¬æ¶ˆè²» 0.3% (é¤¨å¤–/åœ‹å¤–)</label><input type="checkbox" checked disabled></div>
                    
                    <div class="option-row" style="border-top:1px dashed #ddd; padding-top:6px; display:flex; flex-direction:column; align-items:flex-start;">
                        <div style="display:flex; justify-content:space-between; width:100%; align-items:center;">
                            <label for="checkSinopacMitsuiSelected">ğŸ½ï¸ ç‰¹é¸é€šè·¯ 7% (åˆ·$1,428å°é ‚)</label>
                            <input type="checkbox" id="checkSinopacMitsuiSelected" onchange="toggleSinopacMitsui('selected')">
                        </div>

                        <div style="font-size:10px; color:#aaa; margin-top:2px; line-height:1.3;">
                            é€šè·¯ï¼šé¤¨å¤–é¤é£²(MCC 58xx) / å…¨ç›ˆ+PAY<br>
                            <span style="color:#d32f2f; font-weight:bold;">âš ï¸ ä¸Šé™åƒ… 100 å…ƒ (ç´„åˆ· $1,428)</span>
                        </div>
                    </div>
                    
                    <div class="option-row" style="background:#fff3e0; padding:8px; border-radius:6px; margin-top:6px;"><label for="checkSinopacMitsuiTarget">ğŸ‡¯ğŸ‡µ æ—¥éŸ“æ³°å¯¦é«” (æ»¿3è¬é€2000/éœ€ç™»éŒ„)</label><input type="checkbox" id="checkSinopacMitsuiTarget" onchange="toggleSinopacMitsui('target')"></div>
                </div>

                <div id="sinopacJcbOptions">
                    <div class="option-row read-only"><label id="labelJcbBase">ğŸ”° åœ‹å…§æ¶ˆè²» 1%</label><input type="checkbox" checked disabled></div>
                    
                    <div class="option-row"><label for="checkSinopacJcbForeign">âœˆï¸ åœ‹å¤–æ¶ˆè²» (1% â†’ 2%)</label><input type="checkbox" id="checkSinopacJcbForeign" onchange="updateRewardPreview()"></div>
                    
                    <div class="option-row" style="flex-direction:column; align-items:flex-start; gap:0; border-top:1px dashed #ddd; padding-top:6px;">
                        <div style="display:flex; justify-content:space-between; width:100%; align-items:center;">
                             <label for="checkSinopacJcbBonus">ğŸ‡¯ğŸ‡µ æ—¥æœ¬ / ğŸ›ï¸ ç‰¹é¸ +3% (åˆ·1è¬å°é ‚)</label>
                             <input type="checkbox" id="checkSinopacJcbBonus" onchange="updateRewardPreview()">
                        </div>
                        <button onclick="toggleSinopacJcbDetails()" style="border:none; background:none; color:#007AFF; font-size:11px; cursor:pointer; padding:2px 0 6px 0;">ğŸ”½ é»æ“ŠæŸ¥çœ‹é€šè·¯ (ç¶²è³¼/ç™¾è²¨/é¤å»³)</button>
                        <div id="sinopacJcbDetails" class="details-content">
                            <b>(1) ç¶²è³¼ï¼š</b><br>è¦çš®ã€momoã€PChomeã€Yahooã€æ±æ£®ã€åšå®¢ä¾†...<br>
                            <b>(2) ç™¾è²¨ï¼š</b><br>æ¼¢ç¥ã€é æ±ã€SOGOã€101...<br>
                            <b>(3) é¤å»³ï¼š</b><br>ç‹å“é›†åœ˜ã€é¼æ³°è±...
                        </div>
                    </div>
                    
                    <div class="option-row" style="background:#fff3e0; padding:8px; border-radius:6px; margin-top:6px; flex-direction:column; align-items:flex-start;">
                         <div style="display:flex; justify-content:space-between; width:100%; align-items:center;">
                             <label for="checkSinopacJcbQuarterly">ğŸ”¥ æ—¥éŸ“æ³°æ»¿é¡ +5% (å­£)</label>
                             <input type="checkbox" id="checkSinopacJcbQuarterly" onchange="updateRewardPreview()">
                         </div>
                         <div style="font-size:10px; color:#d32f2f; margin-top:2px;">éœ€ç™»éŒ„ï¼Œæ»¿2è¬é€1000 (ä¸Šé™1000)</div>
                    </div>
                </div>
                
                <div class="input-group" style="margin-top:15px; border-top:1px solid #eee; padding-top:15px;">
                    <label style="margin-bottom:4px;">ğŸ“… æ¶ˆè²»æ—¥æœŸ</label>
                    <input type="date" id="dateInput" style="font-size:16px; padding:8px; text-align:left;">
                </div>

                <div class="input-group" style="margin-top:10px;">
                    <input type="number" id="amountInput" placeholder="$ é‡‘é¡" inputmode="numeric" style="font-size:28px; text-align:center; border:none; border-bottom:2px solid #eee; border-radius:0;" oninput="updateRewardPreview()" onkeyup="updateRewardPreview()" onpaste="updateRewardPreview()">
                </div>
                
                <div id="liveRewardCalc"></div>
                <div class="input-group"><input type="text" id="noteInput" placeholder="å‚™è¨» (ä¾‹å¦‚: åˆé¤)"></div>
                <div class="btn-group">
                    <button class="btn btn-cancel" onclick="document.getElementById('transactionModal').style.display='none'">å–æ¶ˆ</button>
                    <button class="btn btn-again" onclick="addTransaction(false)">ğŸ”„ å†è¨˜ä¸€ç­†</button>
                    <button class="btn btn-confirm" id="btn-confirm" onclick="addTransaction(true)">ç¢ºèª</button>
                </div>
            </div>
            <div class="modal-history-section">
                <div class="modal-history-title" id="modalHistoryTitle"><span>ğŸ“… æœ¬æœˆæ¶ˆè²»ç´€éŒ„</span><span style="font-weight:normal; font-size:10px; color:#aaa;">(é»æ“Šæ–‡å­—ä¿®æ”¹ / âœ• åˆªé™¤)</span></div>
                <div id="modalHistoryList"></div>
            </div>
        </div>
    </div>
    
    <div id="manageModal" class="modal" onclick="if(event.target===this) document.getElementById('manageModal').style.display='none'">
        <div class="modal-content" style="max-height:80vh; overflow-y:auto; padding-top:15px;">
            <h2 style="margin: 0 0 4px 0; font-size: 18px; font-weight: 800; color:#333;">ç®¡ç†æˆ‘çš„å¡ç‰‡</h2>
            
            <div class="manage-tools">
                 <div class="tools-header">
                     <div style="font-size:12px; color:#888;">æƒ…å¢ƒå¿«ç…§èˆ‡å·¥å…·</div>
                     <div style="display:flex; gap:8px;">
                         <button class="btn-tool-small" onclick="clearVisibleCards()">ğŸ§¹ ä¸€éµæ¸…ç©º</button>
                         <button class="btn-tool-small" style="background:#007AFF; color:white; border:none;" onclick="saveCurrentScene()">ğŸ’¾ å­˜æˆæƒ…å¢ƒ</button>
                     </div>
                 </div>
                 <div id="sceneList" class="scene-container"></div>
            </div>
            
            <div class="manage-search-container">
                 <div class="manage-search-wrapper">
                     <input type="text" id="cardSearchInput" class="manage-search-input" placeholder="æœå°‹å¡ç‰‡ (å¦‚: å‰é¶´, æ—…äºº...)" oninput="filterManageCards()">
                     <button id="btnSearchClear" class="btn-search-clear" onclick="clearCardSearch()">âœ•</button>
                </div>
            </div>
        
            <div style="font-size:12px; color:#888; margin-bottom:12px;">é»æ“Šå¡ç‰‡å³å¯ å•Ÿç”¨ / éš±è—</div>
            
            <div id="manageCardList" class="manage-grid"></div>
            
            <button class="btn btn-confirm" style="width:100%; margin-top:10px;" onclick="document.getElementById('manageModal').style.display='none'">å®Œæˆ</button>
        </div>
    </div>
    <script>
    // è‡ªå‹•æ³¨å…¥è©³ç´°è³‡è¨Š (é˜²å‘†)
    function injectDetails() {
        const petDiv = document.getElementById('happyPetDetails');
        if(petDiv && petDiv.innerHTML.trim() === "") {
            petDiv.innerHTML = `
                <b>(1) æŒ‡å®šå¯µç‰©é€£é–ï¼š</b><br>å¯µç‰©å…¬åœ’ã€æ±æ£®å¯µç‰©ã€é­šä¸­é­šã€è²“ç‹—éšŠé•·ã€æ¯›å­©å¸‚é›†ã€é‡‘å‰åˆ©ã€å¥½ç‹—å‘½ã€å¥½ç‹—é‹ã€é‡‘ç‹å­ã€æ„›è²“åœ’ã€ç¦å£½å¯µç‰©æ——è‰¦é¤¨<br>
                <b>(2) 2026 æ–°å¢å“ç‰Œï¼š</b><br>æ±ªå–µæ˜Ÿçƒã€æ€ªç¸éƒ¨è½ã€è¶…å‡å°å§ã€Hero Mama<br>
                <b>(3) é†«ç™‚èˆ‡ç¾å®¹ï¼š</b><br>ç¸é†«è¨ºæ‰€ã€å‹•ç‰©é†«é™¢ã€å¯µç‰©æ—…é¤¨ã€å¯µç‰©ç¾å®¹ (MCC 0742, 5995)
            `;
        }
    }

    // å„å¡ç‰‡è©³æƒ…æŠ˜ç–Šåˆ‡æ›å‡½å¼
    function toggleGreenDetails() {
        const el = document.getElementById('greenDetails');
        el.style.display = (el.style.display === 'block') ? 'none' : 'block';
    }
    function toggleParkingDetails() {
        const el = document.getElementById('greenParkingDetails');
        el.style.display = (el.style.display === 'block') ? 'none' : 'block';
    }
    function toggleJiheDetails() {
        const el = document.getElementById('jiheDetails');
        el.style.display = (el.style.display === 'block') ? 'none' : 'block';
    }
    function toggleKumamonDetails() {
        const el = document.getElementById('kumamonDetails');
        el.style.display = (el.style.display === 'block') ? 'none' : 'block';
    }
    function toggleDbsDetails() {
        const el = document.getElementById('dbsDetails');
        el.style.display = (el.style.display === 'block') ? 'none' : 'block';
    }
    function toggleJiangDetails() { const el = document.getElementById('jiangDetails'); el.style.display = (el.style.display === 'block') ? 'none' : 'block'; }
    function toggleJiangTravelDetails() { const el = document.getElementById('jiangTravelDetails'); el.style.display = (el.style.display === 'block') ? 'none' : 'block'; }
    function toggleCurrencyDetails() { const el = document.getElementById('currencyDetails'); el.style.display = (el.style.display === 'block') ? 'none' : 'block'; }
    function togglePigRichNewUser() { const el = document.getElementById('pigRichNewUserDetails'); el.style.display = (el.style.display === 'block') ? 'none' : 'block'; }
    function togglePigRichSelected() { const el = document.getElementById('pigRichSelectedDetails'); el.style.display = (el.style.display === 'block') ? 'none' : 'block'; }
    function toggleHappyPetDetails() { const el = document.getElementById('happyPetDetails'); el.style.display = (el.style.display === 'block') ? 'none' : 'block'; }
    function toggleHappyPeaceDetails() { const el = document.getElementById('happyPeaceDetails'); el.style.display = (el.style.display === 'block') ? 'none' : 'block'; }
    function toggleHappyLifeDetails() { const el = document.getElementById('happyLifeDetails'); el.style.display = (el.style.display === 'block') ? 'none' : 'block'; }
    // æ–°å¢ï¼šæ°¸è±JCBè©³æƒ…åˆ‡æ›
    function toggleSinopacJcbDetails() { const el = document.getElementById('sinopacJcbDetails'); el.style.display = (el.style.display === 'block') ? 'none' : 'block'; }


    // --- æ›¬æˆ°ç¸¾åŠŸèƒ½æ ¸å¿ƒé‚è¼¯ ---
    function openShareModal() {
        const totalAmount = document.getElementById('totalRewardDisplay').innerText;
        const date = new Date();
        const month = date.getMonth() + 1;
        // 1. å¡«å…¥æ¨™é¡Œ
        document.getElementById('shareCardMonth').innerText = `${month} æœˆå›é¥‹æˆ°ç¸¾`;
        document.getElementById('shareCardAmount').innerText = totalAmount;
        // 2. æ‰¾å‡ºæ‰€æœ‰å›é¥‹ > 0 çš„å¡ç‰‡
        let cardRewards = [];
        cards.forEach(card => {
            if(card.type === 'placeholder') return;
            const stats = calculateStats(card.id);
            if(stats.reward > 0) {
                cardRewards.push({ name: card.name, reward: stats.reward });
            }
        });
        // æ’åº
        cardRewards.sort((a, b) => b.reward - a.reward);
        
        const listContainer = document.getElementById('shareCardList');
        listContainer.innerHTML = '';
        
        if(cardRewards.length === 0) {
             listContainer.innerHTML = '<div style="text-align:center; opacity:0.6; padding:10px;">æœ¬æœˆå°šç„¡å›é¥‹ç´€éŒ„</div>';
        } else {
            cardRewards.forEach(c => {
                let unit = (c.name.includes('æ—…äºº')) ? 'å“©' : 'å…ƒ';
                listContainer.innerHTML += `
                    <div class="share-item">
                        <span>${c.name}</span>
                        <span>+${c.reward.toLocaleString()} ${unit}</span>
                    </div>`;
            });
        }

        // 3. é¡¯ç¤ºè¦–çª—
        document.getElementById('sharePreviewModal').style.display = 'flex';
    }

    // åˆ†äº«åŠŸèƒ½çµ„
    function shareToIG() { shareImageNative(); }
    function shareToFB() { shareImageNative(); }
    function shareToLine() {
        const text = getShareText();
        window.open(`https://line.me/R/msg/text/?${encodeURIComponent(text)}`, '_blank');
    }
    function shareToThreads() {
        const text = getShareText();
        window.open(`https://www.threads.net/intent/post?text=${encodeURIComponent(text)}`, '_blank');
    }

    function shareImageNative() {
        const node = document.getElementById('captureNode');
        const originalTransform = node.style.transform;
        node.style.transform = 'none';

        const btns = document.querySelectorAll('.social-btn');
        btns.forEach(b => b.style.opacity = '0.5');
        html2canvas(node, { backgroundColor: null, scale: 2 }).then(canvas => {
            node.style.transform = originalTransform; 
            btns.forEach(b => b.style.opacity = '1'); 
            
            canvas.toBlob(async (blob) => {
                // [ä¿®æ­£] æª”åæ”¹ç‚ºå…¨è‹±æ–‡
                const file = new File([blob], `Reward_Report_${Date.now()}.png`, { type: "image/png" });
        
                if (navigator.share && navigator.canShare && navigator.canShare({ files: [file] })) {
                    try {
                        await navigator.share({ files: [file], title: 'My Credit Card Rewards', text: getShareText() });
                    } catch (err) { console.log('Share cancelled'); }
                } else {
                    alert("æ‚¨çš„è£ç½®ä¸æ”¯æ´ç›´æ¥åˆ†äº«ï¼Œç³»çµ±å°‡è‡ªå‹•ç‚ºæ‚¨ä¸‹è¼‰åœ–ç‰‡ã€‚");
                    downloadShareImage(); 
                }
            });
        });
    }

    function downloadShareImage(callback) {
        const node = document.getElementById('captureNode');
        const originalTransform = node.style.transform;
        node.style.transform = 'none'; 
        
        html2canvas(node, { backgroundColor: null, scale: 2 }).then(canvas => {
            node.style.transform = originalTransform; 
            const link = document.createElement('a');
            // [ä¿®æ­£] æª”åæ”¹ç‚ºå…¨è‹±æ–‡
            link.download = `Reward_Report_${new Date().getTime()}.png`;
            link.href = canvas.toDataURL();
            link.click();
            if(callback) callback();
        });
    }

    function getShareText() {
        const totalAmount = document.getElementById('totalRewardDisplay').innerText;
        return `ğŸ’° ç‹‚ï¼æœ¬æœˆå›é¥‹ ${totalAmount}ï¼\nå¿«ä¾†è©¦ç®— ğŸ‘‰ https://shawn2026-oss.github.io/shawn-2026-creditcard/`;
    }

    // --- è³‡æ–™è¼‰å…¥èˆ‡åˆå§‹åŒ– ---
    fetch('config.json?t=' + Date.now()).then(response => response.json()).then(data => { if(data.news) document.getElementById('news-text').innerHTML = data.news; }).catch(error => {});
    let cardSettings = JSON.parse(localStorage.getItem('cardSettings')) || {};

    window.addEventListener('load', () => {
        injectDetails(); 
        
        // [é˜²å´©æ½°ä¿®è£œ] å†æ¬¡æª¢æŸ¥é ‚éƒ¨æç¤ºæ¢
        const tipBar = document.getElementById('line-tip-bar');
        // é€™è£¡æœƒæª¢æŸ¥ CSS æ˜¯å¦çœŸçš„é¡¯ç¤ºäº† tipBar
        if (tipBar && window.getComputedStyle(tipBar).display !== 'none') {
             const container = document.querySelector('.app-container');
             if(container) container.style.marginTop = '45px'; // å¾€ä¸‹æ¨
        }

        setTimeout(() => { const ticker = document.querySelector('.ticker-content'); if(ticker) { ticker.style.animation = 'none'; void ticker.offsetWidth; ticker.style.animation = 'scroll-left 15s linear infinite'; } }, 100);
        
        const isSetupDone = localStorage.getItem('user_setup_done');
        const hasLegacyData = localStorage.getItem('visibleCards') !== null;

        if (!isSetupDone) {
            if (hasLegacyData) {
                // èˆŠç”¨æˆ¶ï¼šé»˜é»˜è£œä¸Šæ¨™è¨˜ï¼Œç›´æ¥é€²å…¥ App
                localStorage.setItem('user_setup_done', 'true');
                loadAndRenderApp();
            } else {
                // çœŸÂ·æ–°ç”¨æˆ¶ï¼šé¡¯ç¤ºæ­¡è¿è¦–çª—
                initWelcomeModal();
            }
        } else {
            loadAndRenderApp();
        }
    });
      function initWelcomeModal() {
        const modal = document.getElementById('welcomeModal');
        const list = document.getElementById('welcomeList');
        list.innerHTML = '';
        cards.forEach(card => {
            if (card.id === 'add1') return;
            const item = document.createElement('div');
            item.className = 'welcome-item';
            item.innerHTML = `<input type="checkbox" id="w_${card.id}" value="${card.id}"><label for="w_${card.id}">${card.name}</label>`;
            list.appendChild(item);
        });
        modal.style.display = 'flex';
    }

    function saveWelcomeSettings() {
        const checkboxes = document.querySelectorAll('.welcome-item input[type="checkbox"]:checked');
        let selectedCards = [];
        checkboxes.forEach(cb => selectedCards.push(cb.value));
        if (selectedCards.length === 0) { alert("ğŸ’¡ å°æé†’ï¼š\nå»ºè­°å…ˆé¸å¹¾å¼µå¡ç‰‡è©¦ç”¨çœ‹çœ‹å–”ï¼"); return; 
        }
        localStorage.setItem('visibleCards', JSON.stringify(selectedCards));
        localStorage.setItem('user_setup_done', 'true');
        document.getElementById('welcomeModal').style.display = 'none';
        location.reload();
    }
    
    // --- æ ¸å¿ƒï¼šæƒ…å¢ƒæ¨¡å¼ç®¡ç†å™¨ (Scene Manager) ---
    function getScenes() {
        return JSON.parse(localStorage.getItem('scene_snapshots') || '[]');
    }

    function saveCurrentScene() {
        if (!visibleCards || visibleCards.length === 0 || (visibleCards.length===1 && visibleCards[0]==='add1')) {
            alert("è«‹å…ˆé¸æ“‡è‡³å°‘ä¸€å¼µå¡ç‰‡æ‰èƒ½å„²å­˜æƒ…å¢ƒï¼");
            return;
        }
        const name = prompt("è«‹ç‚ºç›®å‰å¡ç‰‡çµ„åˆå‘½å (ä¾‹å¦‚: ğŸ‡¯ğŸ‡µ æ—¥æœ¬æ—…éŠ):");
        if (!name) return;
        const scenes = getScenes();
        scenes.push({ name: name, cards: [...visibleCards] });
        localStorage.setItem('scene_snapshots', JSON.stringify(scenes));
        renderScenes();
        // é‡æ–°æ¸²æŸ“åˆ—è¡¨
        alert(`æƒ…å¢ƒã€Œ${name}ã€å·²å„²å­˜ï¼`);
    }

    function renderScenes() {
        const container = document.getElementById('sceneList');
        if (!container) return;
        container.innerHTML = '';
        const scenes = getScenes();
        if (scenes.length === 0) {
            container.innerHTML = '<span style="font-size:11px; color:#aaa; padding:6px;">å°šç„¡å„²å­˜çš„æƒ…å¢ƒï¼Œè«‹å…ˆè¨­å®šå¡ç‰‡å¾Œé»æ“Šã€Œå­˜æˆæƒ…å¢ƒã€</span>';
            return;
        }

        scenes.forEach((scene, index) => {
            const btn = document.createElement('div');
            btn.className = 'btn-scene';
            btn.innerHTML = `${scene.name} <span class="btn-scene-del" data-index="${index}">âœ•</span>`;
            
            // é»æ“Šè¼‰å…¥
            btn.onclick = (e) => {
                 if(e.target.classList.contains('btn-scene-del')) return; 
                loadScene(index);
            };
            
            // é»æ“Šåˆªé™¤
            const delBtn = btn.querySelector('.btn-scene-del');
            delBtn.onclick = (e) => {
                e.stopPropagation();
                deleteScene(index);
            };
            
            container.appendChild(btn);
        });
    }

    function deleteScene(index) {
        if(!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤æƒ…å¢ƒå¿«ç…§å—ï¼Ÿ')) return;
        const scenes = getScenes();
        scenes.splice(index, 1);
        localStorage.setItem('scene_snapshots', JSON.stringify(scenes));
        renderScenes();
    }

    function loadScene(index) {
        const scenes = getScenes();
        if(!scenes[index]) return;
        
        if(!confirm(`ç¢ºå®šè¦åˆ‡æ›åˆ°ã€Œ${scenes[index].name}ã€æƒ…å¢ƒå—ï¼Ÿ\n(ç›®å‰çš„é¡¯ç¤ºè¨­å®šå°‡è¢«è¦†è“‹)`)) return;

        visibleCards = scenes[index].cards;
        localStorage.setItem('visibleCards', JSON.stringify(visibleCards));
        
        // é‡æ–°æ¸²æŸ“ App èˆ‡ ç®¡ç†è¦–çª—
        renderGrid();
        openManageModal(); // é‡æ–°æ•´ç†å‹¾é¸ç‹€æ…‹
    }

    function clearVisibleCards() {
        if(!confirm('ç¢ºå®šè¦ä¸€éµéš±è—æ‰€æœ‰å¡ç‰‡å—ï¼Ÿ\n(é€™æ–¹ä¾¿æ‚¨é‡æ–°å‹¾é¸æ–°çµ„åˆ)')) return;
        // è‡³å°‘ä¿ç•™ add1 ä»¥é˜²å‡ºéŒ¯ï¼Œæˆ–å®Œå…¨æ¸…ç©ºè¦–é‚è¼¯è€Œå®šã€‚é€™è£¡ä¿ç•™ add1 è®“ä½¿ç”¨è€…èƒ½æŒ‰åŠ è™Ÿ
        visibleCards = ['add1'];
        localStorage.setItem('visibleCards', JSON.stringify(visibleCards));
        
        renderGrid();
        openManageModal();
        // é‡æ–°æ•´ç†å‹¾é¸ç‹€æ…‹
    }

    function loadAndRenderApp() {
        let currentCards = JSON.parse(localStorage.getItem('visibleCards')) || [];
        const realCardIds = cards.map(c => c.id).filter(id => id !== 'add1');
        let realCards = currentCards.filter(id => realCardIds.includes(id));
        if (realCards.length > 8) { 
            realCards = realCards.slice(0, 8);
            localStorage.setItem('visibleCards', JSON.stringify(realCards)); 
        }
        if (realCards.length < 8) { 
            if (!currentCards.includes('add1')) { 
                realCards.push('add1');
                localStorage.setItem('visibleCards', JSON.stringify(realCards)); 
            } 
        } else { 
            if (currentCards.includes('add1')) { 
                localStorage.setItem('visibleCards', JSON.stringify(realCards));
            } 
        }
        visibleCards = JSON.parse(localStorage.getItem('visibleCards'));
        renderGrid();
    }

    function closeModal() {
        document.getElementById('transactionModal').style.display = 'none';
        document.getElementById('manageModal').style.display = 'none';
        document.getElementById('sharePreviewModal').style.display = 'none';
    }

    window.addEventListener('popstate', function(event) { closeModal(); });
    
    // --- æ ¸å¿ƒè³‡æ–™åº« (V124.30 - DBS Eco æ›´æ–°) ---
    const defaultCards = [
        { 
            id: 'c10', name: 'ä¸­ä¿¡ UniOpen å¡', nickname: '2026 çµ±ä¸€é›†åœ˜ç¥å¡', 
            note: 'icashPay/æµ·å¤– 11% ($3,750/$6,250 å°é ‚)', 
            type: 'uniopen_special', gradient: 'linear-gradient(135deg, #FF512F 0%, #F09819 100%)', textColor: 'white', msgDanger: '', 
            parking: `ğŸª <b>çµ±ä¸€é›†åœ˜ 2026 æ–°æ¬Šç›Š</b><br>1. <b>åŸºæœ¬å›é¥‹</b>ï¼š1% (ç„¡ä¸Šé™)<br>2. <b>é›†åœ˜åŠ ç¢¼</b>ï¼š+2% (é™åˆ·$2.5è¬)<br>3. <b>è¸©é»ä»»å‹™</b>ï¼šæ»¿ 5 å®¶ +4% (é™åˆ·$1.25è¬)<br>4. <b>icash Pay</b>ï¼šåŠ ç¢¼ +4% (é™åˆ·$3,750)`
        },
        { 
            id: 'dbs1', name: 'æ˜Ÿå±• eco æ°¸çºŒå¡', nickname: 'ç¶ èƒ½/æ–°æˆ¶lpç¥å¡', 
            note: 'åœ‹å¤–å¯¦é«” +4% (åˆ·$1.5è¬å°é ‚)', 
            type: 'ceiling', limit: 15000, 
            tier1Rate: 0.05, tier2Rate: 0.01, // åŸºæœ¬ä¿®æ­£ç‚º 1%
            gradient: 'linear-gradient(135deg, #FF0000 0%, #000000 100%)', textColor: 'white', 
            msgDanger: 'åŠ ç¢¼å·²å°é ‚ (è®Š1%)', 
            parking: `âš¡ <b>æ–°æˆ¶ Line Pay 10%</b><br>åŸºæœ¬ 1% + åŠ ç¢¼ 9%<br>âš ï¸ åŠ ç¢¼ä¸Šé™ 1000 é» (ç´„åˆ· $11,111)<br>âœˆï¸ <b>åœ‹å¤–å¯¦é«” +4%</b><br>åŸºæœ¬ 1% + åŠ ç¢¼ 4% (å…±5%)<br>âš ï¸ åŠ ç¢¼é©ç”¨æœˆåˆ· $15,000 å°é ‚`
        },
        { 
            id: 'c6', name: 'å°æ–°è¡—å£è±¬å¯Œå¡', nickname: 'è¡Œæ”¯/ç¹³è²»ç¥å¡', 
            note: 'æ–°æˆ¶ 10% (åˆ· 8åƒå°é ‚) | ç²¾é¸ 2.5% (åˆ· 40è¬å°é ‚)', 
            rule: '', type: 'ceiling', limit: 8000, tier1Rate: 0.135, tier2Rate: 0.035, 
            gradient: 'linear-gradient(135deg, #e60012 0%, #FFD700 100%)', 
            textColor: 'white', msgDanger: 'æ–°æˆ¶10%å·²å°é ‚',
            parking: `ğŸ· <b>æ–°æˆ¶é™å®šç¥å¡</b><br>æ–°æˆ¶ +10% (é™åˆ·$8,000)<br>ğŸŒŸ <b>ç²¾é¸é€šè·¯ +2.5%</b><br>ä¸Šé™ $40 è¬`
        },
        { id: 'c1', name: 'æ˜Ÿå±•å‚³èªªå°æ±ºå¡', nickname: 'Line Payç¥å¡', note: 'LinePay / è¦çš® / å¤–é€ (åˆ· $11,363 å°é ‚)', rule: '', type: 'ceiling', limit: 11363, tier1Rate: 0.10, tier2Rate: 0.012, gradient: 'linear-gradient(135deg, #43cea2 0%, #185a9d 100%)', textColor: 'white', msgDanger: 'å·²å°é ‚ (è®Š1.2%)' },
        { id: 'c5', name: 'è¯é‚¦è³´é»å¡', nickname: 'Line Payå„ªç­‰ç”Ÿ', note: 'Line Pay 6% (åˆ· 3åƒå°é ‚)', rule: 'âš ï¸ å–®ç­†éœ€æ»¿$100', type: 'ceiling', limit: 3000, tier1Rate: 0.06, tier2Rate: 0.01, threshold: 100, gradient: 'linear-gradient(135deg, #00B900 0%, #33CC33 100%)', textColor: 'white', msgDanger: 'å·²å°é ‚ (è®Š1%)', parking: `âš ï¸ <b>å–®ç­†éœ€æ»¿ $100</b> (å›é¥‹ 6%)`},
        { id: 'c3', name: 'æ°¸è± Sport å¡', nickname: 'Apple Payå„ªç­‰ç”Ÿ', note: 'Apple Pay 5% (åˆ· 5åƒå°é ‚)', rule: '', type: 'ceiling', limit: 5000, tier1Rate: 0.05, tier2Rate: 0.02, gradient: 'linear-gradient(135deg, #00B4DB 0%, #0083B0 100%)', textColor: 'white', msgDanger: 'å·²å°é ‚ (è®Š1%)' },
        { 
            id: 'c4', name: 'å°‡ä¾†å°‡å°‡å¡', nickname: 'è¡Œæ”¯/é¤å»³/å¤–é€', 
            note: 'ç”Ÿæ´» 5% (åˆ· 6åƒ6å°é ‚)', 
            rule: '', type: 'mixed', limit: 6666, minSpend: 3000, tier1Rate: 0.05, tier2Rate: 0.005, 
            gradient: 'linear-gradient(135deg, #ffe259 0%, #ffa751 100%)', textColor: '#333', msgDanger: 'å·²å°é ‚ (è®Š0.5%)', 
            parking: `ğŸ¯ <b>ä½æ¶ˆä»»å‹™</b>ï¼šç•¶æœˆç´¯ç©æ»¿ <b>$3,000</b> æ‰äº«åŠ ç¢¼<br><br>ğŸ›ï¸ <b>ç”Ÿæ´»å‡ç´š 5%</b> (é™åˆ·$6,666)<br>è¡Œå‹•æ”¯ä»˜/å¤–é€/é¤å»³/è³¼ç‰©<br><br>âœˆï¸ <b>æ—…éŠåŠ ç¢¼ 5%</b> (é™åˆ·$11,111)<br>æµ·å¤–/èˆªç©º/æ—…è¡Œç¤¾/é«˜éµ`
        },
        { 
            id: 'c2', name: 'è¯é‚¦ç¶ å¡', nickname: 'ç¶ è‰²/å¸‚å€åœè»Šç¥å¡', 
            note: 'ç¶ è‰² 6% (åˆ· 3åƒå°é ‚) | åœè»Š (åˆ· 1.2è¬é”æ¨™)', 
            rule: '', type: 'floor', target: 12000, tier1Rate: 0.02, tier2Rate: 0.02, 
            gradient: 'linear-gradient(135deg, #20B2AA 0%, #008B8B 100%)', textColor: 'white', msgSuccess: 'å·²é”æ¨™ (ä¸‹æœˆå…åœ)', 
            parking: `ğŸ…¿ï¸ <b>å…è²»åœè»Šï¼š</b>éœ€ä¸Šæœˆåˆ·æ»¿1.2è¬<br>ğŸŒ¿ <b>ç¶ è‰²é€šè·¯ 6%</b><br>åŸºæœ¬ 1% + åŠ ç¢¼ 5%<br>âš ï¸ åŠ ç¢¼é©ç”¨æœˆåˆ· $3,000 å°é ‚ (å›é¥‹ $150)`
        },
        { id: 'c7', name: 'ç‰å±± UNI å¡', nickname: 'è¡Œæ”¯/ç™¾è²¨å„ªç­‰ç”Ÿ', note: 'UP 4.5% (åˆ· 14è¬å°é ‚)', type: 'ceiling', limit: 40000, tier1Rate: 0.035, tier2Rate: 0.01, gradient: 'linear-gradient(135deg, #a18cd1 0%, #fbc2eb 100%)', textColor: 'white', msgDanger: 'å·²å°é ‚ (è®Š1%)', 
          parking: `ğŸ”¥ <b>ä»»æ„é¸ 3.5%</b> (é™åˆ·$4è¬)<br>ğŸ†™ <b>UP é¸ 4.5%</b> (é™åˆ·$14è¬)<br>ğŸ¬ <b>çµ±ä¸€æ™‚ä»£ +3%</b> (é™åˆ·$1.6è¬)`},
        { 
            id: 'c8', name: 'é æ±æ¨‚å®¶+å¡', nickname: 'ç”Ÿæ´»/å¯µç‰©ç¥å¡', 
            note: 'å¯µç‰©10% / ç”Ÿæ´»4% / åœ‹å¤–2.5% (éœ€ä¸€èˆ¬æ¶ˆè²»æ»¿3åƒ)', 
            type: 'ceiling', limit: 5263, tier1Rate: 0.1, tier2Rate: 0.005, 
            gradient: 'linear-gradient(135deg, #ff9a9e 0%, #fecfef 99%, #fecfef 100%)', 
            textColor: 'white', msgDanger: 'å·²å°é ‚ (è®Š0.5%)', 
            parking: `ğŸ¶ <b>å¯µç‰© 10%</b> (é™åˆ·$5,263)<br>ğŸ½ï¸ <b>å®‰å¿ƒ/ç”Ÿæ´» 4%</b> (é™åˆ·$5,714)<br>âœˆï¸ <b>åœ‹å¤– 2.5%</b> (ç„¡ä¸Šé™)`
        },
        { id: 'c9', name: 'æ»™è±æ—…äººå¡', nickname: 'å“©ç¨‹ç´¯ç©', note: 'ç„¡é™:åœ‹å…§18/åœ‹å¤–10 | å¾¡ç’½:åœ‹å…§18/åœ‹å¤–15', type: 'miles', gradient: 'linear-gradient(135deg, #1e3c72 0%, #2a5298 100%)', textColor: 'white', msgDanger: '', parking: `âœˆï¸ <b>å“©ç¨‹ç´¯ç©ç¥å¡</b>`},
        { id: 'c11', name: 'å°æ–° Richart å¡', nickname: 'æ¬Šç›Šè‡ªç”±é¸', note: 'å°æ–°Pay 3.8% (ç„¡ä¸Šé™)', type: 'ceiling', limit: 99999999, tier1Rate: 0.038, tier2Rate: 0.003, gradient: 'linear-gradient(135deg, #0F2027 0%, #203A43 50%, #2C5364 100%)', textColor: 'white', msgDanger: '', parking: `ğŸ¶ <b>æ¬Šç›Šè‡ªç”±é¸ (ç„¡ä¸Šé™å›é¥‹)</b>`},
        
        { 
            id: 'j1', name: 'å¯Œé‚¦ J å¡', 
            nickname: 'æ—¥éŸ“æ—…éŠå„ªç­‰ç”Ÿ', 
            note: 'æ—¥éŸ“å¯¦é«” 6% (å­£åˆ· 3.3è¬å°é ‚)', 
            type: 'custom_j', limit: 0, 
            gradient: 'linear-gradient(135deg, #FF7E5F 0%, #FEB47B 100%)', textColor: 'white', msgDanger: '', 
            parking: `ğŸ‡¯ğŸ‡µğŸ‡°ğŸ‡· <b>æ—¥éŸ“å¯¦é«” 6%</b> (3%+3%)<br>æ¯å­£ä¸Šé™$1,000ï¼Œéœ€å–®ç­†æ»¿åƒ<br>ğŸ <b>æ—¥æœ¬äº¤é€šå¡ 10%</b> (3%+7%)<br>æ¯å­£ä¸Šé™$200ï¼Œéœ€å–®ç­†æ»¿å…©åƒ<br>ğŸ‡¹ğŸ‡­ <b>æ³°åœ‹å¯¦é«” 6%</b> (1%+5%)<br>æ¯å­£ä¸Šé™$1,000ï¼Œéœ€å–®ç­†æ»¿åƒ`
        },
        
        { 
            id: 'j2', name: 'è¯é‚¦å‰é¶´å¡', nickname: 'æ—¥æœ¬/ApplePayé¦–é¸', 
            note: 'æ—¥æœ¬ AP 4% (åˆ· 4è¬å°é ‚) | åœ‹å…§æ—¥ç³» 5%', 
            type: 'ceiling', limit: 40000, tier1Rate: 0.04, tier2Rate: 0.025, 
            gradient: 'linear-gradient(135deg, #DC143C 0%, #FFFFFF 150%)', textColor: 'white', msgDanger: 'åŠ ç¢¼å·²å°é ‚ (è®Š2.5%)', 
            parking: `ğŸ <b>æ—¥æœ¬ QUICPay (Apple Pay)</b><br>æ—¥æœ¬ 2.5% + åŠ ç¢¼ 1.5% = 4%<br>âš ï¸ åŠ ç¢¼ä¸Šé™ $600/æœˆ (ç´„åˆ·$4è¬)<br>ğŸ‡¹ğŸ‡¼ <b>åœ‹å…§æ—¥ç³»ååº— 5%</b><br>åœ‹å…§ 1% + åŠ ç¢¼ 4% (åˆ·$1.25è¬å°é ‚)`
        },
        { 
            id: 'j3', name: 'ç‰å±±ç†Šæœ¬ç†Šå¡', nickname: 'æ—¥æœ¬å„ªç­‰ç”Ÿ', 
            note: 'PayPay 5% (å­£) | æŒ‡å®š 8.5%', 
            type: 'ceiling', limit: 8333, tier1Rate: 0.085, tier2Rate: 0.025, 
            gradient: 'linear-gradient(135deg, #BDC3C7 0%, #2C3E50 100%)', textColor: 'white', msgDanger: 'åŠ ç¢¼å·²å°é ‚', 
            parking: `ğŸ» <b>æŒ‡å®šé€šè·¯ 8.5%</b><br>(åŸºæœ¬2.5% + åŠ ç¢¼6%)<br>âš ï¸ åŠ ç¢¼ä¸Šé™ $500/æœŸ (ç´„åˆ·$8,333)<br>ğŸ“± <b>PayPay 5%</b> (3.5%+1.5%å…æ‰‹çºŒè²»)<br>âš ï¸ 3.5%åŠ ç¢¼ä¸Šé™ $100/å­£ (ç´„åˆ·$2,857)<br>ğŸ”° <b>åœ‹å…§ä¸€èˆ¬ 0.5%</b> (ç„¡ä¸Šé™)`
        },
        { 
            id: 'j4', name: 'æ°¸è±å¹£å€å¡', nickname: 'æµ·å¤–é›™å¹£ç¥å¡', 
            note: 'æµ·å¤–ç²¾é¸ 6% (åˆ· 2è¬å°é ‚)', 
            type: 'ceiling', limit: 80000, tier1Rate: 0.06, tier2Rate: 0.02, 
            gradient: 'linear-gradient(135deg, #FDC830 0%, #F37335 100%)', textColor: 'white', msgDanger: 'åŠ ç¢¼å·²å°é ‚',
            parking: `ğŸ’° <b>å¹£å€å¡ 2026</b><br><b>Level 1 (é™åˆ·$7,500)</b>ï¼šè‡ªå‹•æ‰£ç¹³+é›»å­å¸³å–®<br><b>Level 2 (é™åˆ·$20,000)</b>ï¼šè³‡ç”¢â‰¥10è¬ æˆ– å¤§æˆ¶`
        },
        { 
            id: 'j5', name: 'æ°¸è±ä¸‰äº•è¯åå¡', nickname: 'é¤é£²å„ªç­‰ç”Ÿ/æ—¥éŸ“æ³°é™„åŠ ', 
            note: 'é¤é£² 7.3% | æ—¥éŸ“æ³°æ»¿é¡ç¦®', 
            type: 'floor', target: 30000, tier1Rate: 0.073, tier2Rate: 0.003, 
            gradient: 'linear-gradient(135deg, #00C9FF 0%, #92FE9D 100%)', textColor: '#333', msgSuccess: 'å·²é”æ¨™ (é ˜$2000)',
            parking: `ğŸ½ï¸ <b>ç‰¹é¸é€šè·¯ 7% (ä¸Šé™100å…ƒ)</b><br>é€šè·¯ï¼šé¤¨å¤–é¤é£²(MCC 58xx) / å…¨ç›ˆ+PAY<br>âš ï¸ åŠ ç¢¼ä¸Šé™åƒ… 100 å…ƒ (ç´„åˆ· $1,428)<br><br>ğŸ‡¯ğŸ‡µ <b>æ—¥éŸ“æ³°æ»¿é¡ç¦® (éœ€ç™»éŒ„)</b><br>æ¯å­£ç´¯ç©æ»¿ 30,000 é€ 2,000 (å›é¥‹ç´„6.9%)`
        },
        // [New] æ°¸è± JCB ç¾é‡‘å›é¥‹
        { 
            id: 'c12', name: 'æ°¸è±ç¾é‡‘å›é¥‹ JCB', nickname: 'æ—…æ—¥ç¥å¡', 
            note: 'åœ‹å…§ç‰¹é¸ 4% | æ—¥æœ¬ 5% (å¦æœ‰å­£å›é¥‹)', 
            type: 'ceiling', limit: 10000, // 300 / 0.03
            tier1Rate: 0.04, // 1% + 3% 
            tier2Rate: 0.01, 
            gradient: 'linear-gradient(135deg, #8E0E00 0%, #1F1C18 100%)', textColor: 'white', 
            msgDanger: 'ç‰¹é¸å·²å°é ‚ (è®Š1%)',
            parking: `ğŸ‡¯ğŸ‡µ <b>æ—¥æœ¬æ¶ˆè²»</b><br>æœ€é«˜ 5% (åœ‹å¤–2% + åŠ ç¢¼3%)<br>ğŸ›ï¸ <b>ç‰¹é¸é€šè·¯</b><br>æœ€é«˜ 5% (åœ‹å¤–2% + åŠ ç¢¼3%) æˆ– 4% (åœ‹å…§1% + åŠ ç¢¼3%)<br>âš ï¸ åŠ ç¢¼ä¸Šé™ $300/æœˆ (ç´„åˆ· $10,000)<br>ğŸ”¥ <b>æ—¥éŸ“æ³°æ»¿é¡</b> (éœ€ç™»éŒ„)<br>æ¯å­£ç´¯ç©æ»¿ 2 è¬é€ $1,000`
        },
        { id: 'add1', name: 'æ–°å¢å¡ç‰‡', nickname: 'é»æ“Šé¸å¡', note: 'å‰å¾€è³‡æ–™åº«æŒ‘é¸', type: 'placeholder', 
          gradient: 'linear-gradient(135deg, #e0e0e0 0%, #f5f5f5 100%)', textColor: '#999', msgDanger: '' }
    ];
    let visibleCards = JSON.parse(localStorage.getItem('visibleCards'));
    let savedOrder = JSON.parse(localStorage.getItem('cardOrder'));
    let cards = [...defaultCards];
    let sortableInstance = null;
    function getSortedCards() {
        if (!visibleCards) return [];
        let displayCards = cards.filter(c => visibleCards.includes(c.id));
        const realCardCount = displayCards.filter(c => c.type !== 'placeholder').length;
        if (realCardCount < 8 && !visibleCards.includes('add1')) { const placeholder = cards.find(c => c.id === 'add1');
        if(placeholder && !displayCards.includes(placeholder)) displayCards.push(placeholder); }
        if (savedOrder && Array.isArray(savedOrder)) { displayCards.sort((a, b) => { let indexA = savedOrder.indexOf(a.id); let indexB = savedOrder.indexOf(b.id); if (indexA === -1) indexA = 999; if (indexB === -1) indexB = 999; return indexA - indexB; });
        }
        return displayCards;
    }

    function initSortable() {
        var el = document.getElementById('card-grid');
        if (sortableInstance) { sortableInstance.destroy(); }
        sortableInstance = new Sortable(el, { animation: 150, ghostClass: 'sortable-ghost', dragClass: 'sortable-drag', delay: 200, delayOnTouchOnly: true, forceFallback: true, onEnd: function (evt) { const visibleOrder = Array.from(evt.to.children).map(el => el.getAttribute('data-card-id')); const allCardIds = cards.map(c => c.id); const hiddenCards = allCardIds.filter(id => !visibleOrder.includes(id)); const finalOrder = [...visibleOrder, ...hiddenCards]; localStorage.setItem('cardOrder', JSON.stringify(finalOrder)); savedOrder = finalOrder; } });
    }

    let transactions = JSON.parse(localStorage.getItem('transactions')) || [];
    let editingId = null;

    function updateDate() { const now = new Date();
    document.getElementById('dateDisplay').innerText = `${now.getMonth()+1}/${now.getDate()}`; }
    function saveHsbcTier() { const tier = document.querySelector('input[name="hsbcTier"]:checked').value; localStorage.setItem('hsbc_tier', tier); renderGrid(); updateRewardPreview();
    }
    function saveHsbcInitial() { const initial = document.getElementById('hsbcInitialMiles').value; localStorage.setItem('hsbc_initial_miles', initial); renderGrid();
    }
    function saveHsbcSettings() { const redeemed = document.getElementById('hsbcRedeemedMiles').value; localStorage.setItem('hsbc_redeemed_miles', redeemed); renderGrid();
    }

    const uniBrands = ["7-11", "æ˜Ÿå·´å…‹", "åº·æ˜¯ç¾", "å®¶æ¨‚ç¦", "Mia C'bon", "åšå®¢ä¾†", "Yahooè³¼ç‰©", "é€Ÿé‚æ¨‚", "21ä¸–ç´€", "é…·è–çŸ³", "è–å¾·ç§‘æ–¯", "çµ±ä¸€æ™‚ä»£", "å¤¢æ™‚ä»£", "å…¶ä»–"];
    function initUniBrandGrid() {
        const grid = document.getElementById('uniBrandGrid');
        grid.innerHTML = '';
        uniBrands.forEach(brand => {
            const btn = document.createElement('div');
            btn.className = 'brand-btn';
            btn.innerText = brand;
            btn.onclick = () => toggleUniBrand(brand, btn);
            grid.appendChild(btn);
        });
    }

    function saveUniOpenState() {
        const state = {
            group: document.getElementById('checkUniGroup').checked,
            icash: document.getElementById('checkUniIcash').checked,
            overseas: document.getElementById('checkUniOverseas').checked,
            brands: getCheckedBrands()
        };
        localStorage.setItem('uniOpenState', JSON.stringify(state));
        const count = state.brands.length;
        updateTaskBonusDisplay(count);
        renderGrid(); 
        updateRewardPreview();
    }
    
    function toggleUniBrand(brand, btn) {
        if (document.getElementById('checkUniOverseas').checked) { document.getElementById('checkUniOverseas').checked = false;
        }
        if(!btn.classList.contains('active')) { document.getElementById('checkUniGroup').checked = true;
        }
        btn.classList.toggle('active');
        saveUniOpenState();
    }
    
    function toggleUniGroup() {
        if(document.getElementById('checkUniGroup').checked) { document.getElementById('checkUniOverseas').checked = false;
        }
        saveUniOpenState();
    }
    
    function toggleUniIcash() {
        if(document.getElementById('checkUniIcash').checked) { document.getElementById('checkUniOverseas').checked = false;
        }
        saveUniOpenState();
    }
    
    function getCheckedBrands() {
        const activeBtns = document.querySelectorAll('.brand-btn.active');
        const brands = [];
        activeBtns.forEach(btn => brands.push(btn.innerText));
        return brands;
    }
    
    function updateTaskBonusDisplay(count) {
        const display = document.getElementById('taskBonusDisplay');
        let rate = 0;
        if(count >= 5) rate = 4;
        else if(count === 4) rate = 3;
        else if(count === 3) rate = 2;
        else if(count === 2) rate = 1;
        display.innerText = `ç›®å‰è¸©é» ${count} å®¶ (åŠ ç¢¼ +${rate}%)`;
    }
    
    function toggleUniOverseas() {
        const isOverseas = document.getElementById('checkUniOverseas').checked;
        if (isOverseas) {
            document.getElementById('checkUniGroup').checked = false;
            document.getElementById('checkUniIcash').checked = false;
            const btns = document.querySelectorAll('.brand-btn');
            btns.forEach(btn => btn.classList.remove('active'));
        }
        saveUniOpenState();
    }

    function toggleUniUpLogic() {
        const isUp = document.getElementById('checkUniUp').checked;
        const label = document.getElementById('labelUniBase');
        if (isUp) {
            label.innerHTML = "ğŸ†™ <b>UP é¸ 4.5%</b> (åˆ·$14è¬å°é ‚)";
            label.parentNode.style.background = "#fff3e0"; 
        } else {
            label.innerHTML = "ğŸ”° <b>ä»»æ„é¸ 3.5%</b> (åˆ·$4è¬å°é ‚)";
            label.parentNode.style.background = "transparent";
        }
        updateRewardPreview();
    }

    function toggleFubonJGeneral() {
        const isGeneral = document.getElementById('checkFubonJGeneral').checked;
        const labelBase = document.getElementById('labelFubonBase');
        if (isGeneral) {
            labelBase.innerHTML = "ğŸ‡¯ğŸ‡µğŸ‡°ğŸ‡· <b>æ—¥éŸ“åŸºæœ¬ 3%</b> (ç„¡ä¸Šé™)";
            document.getElementById('checkFubonJThai').checked = false;
        } else {
            labelBase.innerHTML = "ğŸ”° <b>åœ‹å…§æ¶ˆè²» 1%</b> (ç„¡ä¸Šé™)";
            document.getElementById('checkFubonJKorea').checked = false;
            document.getElementById('checkFubonJSuica').checked = false;
        }
        updateRewardPreview();
    }

    function toggleFubonJPhysical() {
        if(document.getElementById('checkFubonJKorea').checked) {
            document.getElementById('checkFubonJGeneral').checked = true;
            document.getElementById('checkFubonJSuica').checked = false; // å¯¦é«”èˆ‡äº¤é€šäº’æ–¥
            toggleFubonJGeneral();
        }
        updateRewardPreview();
    }

    function toggleFubonJSuica() {
        if(document.getElementById('checkFubonJSuica').checked) {
            document.getElementById('checkFubonJGeneral').checked = true;
            document.getElementById('checkFubonJKorea').checked = false; // å¯¦é«”èˆ‡äº¤é€šäº’æ–¥
            toggleFubonJGeneral();
        }
        updateRewardPreview();
    }

    function toggleFubonJThai() {
        if(document.getElementById('checkFubonJThai').checked) {
            document.getElementById('checkFubonJGeneral').checked = false;
            toggleFubonJGeneral();
        }
        updateRewardPreview();
    }

    function toggleJiheLogic() {
        const isJapan = document.getElementById('checkJiheJapan').checked;
        const labelBase = document.getElementById('labelJiheBase');
        const appleRow = document.getElementById('rowJiheApple');
        const domesticRow = document.getElementById('rowJiheDomesticJapanese');
        if (isJapan) {
            labelBase.innerHTML = "âœˆï¸ <b>æ—¥æœ¬æ¶ˆè²» 2.5%</b> (ç„¡ä¸Šé™)";
            appleRow.style.display = 'flex';
            domesticRow.style.display = 'none';
            document.getElementById('checkJiheDomesticJapanese').checked = false;
        } else {
            labelBase.innerHTML = "ğŸ”° <b>åœ‹å…§æ¶ˆè²» 1%</b> (ç„¡ä¸Šé™)";
            document.getElementById('checkJiheApple').checked = false;
            appleRow.style.display = 'none';
            domesticRow.style.display = 'flex';
        }
        updateRewardPreview();
    }

    // ç†Šæœ¬ç†Šå¡é‚è¼¯ä¿®æ­£
    function toggleKumamonLogic() {
        const isJapan = document.getElementById('checkKumamonJapan').checked;
        const labelBase = document.getElementById('labelKumamonBase');
        const groupJapan = document.getElementById('groupKumamonJapan');
        const groupDomestic = document.getElementById('groupKumamonDomestic');
        if (isJapan) {
            labelBase.innerHTML = "âœˆï¸ <b>æ—¥æœ¬æ¶ˆè²» 2.5%</b> (å«å…æ‰‹çºŒè²»)";
            groupJapan.style.display = 'block';
            if (groupDomestic) groupDomestic.style.display = 'none';
        } else {
            labelBase.innerHTML = "ğŸ”° <b>åœ‹å…§ä¸€èˆ¬ 0.5%</b> (ç„¡ä¸Šé™)";
            document.getElementById('checkKumamonDesignated').checked = false;
            document.getElementById('checkKumamonPayPay').checked = false;
            groupJapan.style.display = 'none';
            document.getElementById('rowKumamonJapan').style.display = 'flex';
        }
        updateRewardPreview();
    }
    
    function toggleKumamonSub(mode) {
        const isPayPay = document.getElementById('checkKumamonPayPay').checked;
        const isDesignated = document.getElementById('checkKumamonDesignated').checked;
        const labelBase = document.getElementById('labelKumamonBase');
        const japanRow = document.getElementById('rowKumamonJapan');
        if (mode === 'designated' && isDesignated) { document.getElementById('checkKumamonPayPay').checked = false;
        }
        if (mode === 'paypay' && isPayPay) { document.getElementById('checkKumamonDesignated').checked = false;
        }
        
        if (document.getElementById('checkKumamonPayPay').checked) {
             document.getElementById('checkKumamonJapan').checked = true;
             japanRow.style.display = 'none'; 
             labelBase.innerHTML = "ğŸ“± <b>PayPay 5%</b> (3.5%+1.5%å…æ‰‹çºŒè²»)";
             document.getElementById('groupKumamonJapan').style.display = 'block';
        } else if (document.getElementById('checkKumamonDesignated').checked) {
             document.getElementById('checkKumamonJapan').checked = true;
             japanRow.style.display = 'flex'; 
             labelBase.innerHTML = "ğŸ» <b>æŒ‡å®šé€šè·¯ 8.5%</b> (åˆ·$8,333å°é ‚)";
             document.getElementById('groupKumamonJapan').style.display = 'block';
        } else {
             japanRow.style.display = 'flex';
             toggleKumamonLogic();
        }
        updateRewardPreview();
    }

    function toggleCurrencyLogic() { 
        const currencyType = document.querySelector('input[name="currencyType"]:checked').value;
        const labelBase = document.getElementById('labelCurrencyBase');
        if (currencyType === 'selected') {
            labelBase.innerHTML = "âœˆï¸ <b>æµ·å¤–/ç²¾é¸ 2%</b>";
        } else {
            labelBase.innerHTML = "ğŸ”° <b>åœ‹å…§ä¸€èˆ¬ 1%</b>";
        }
        updateRewardPreview(); 
    }
    
    function toggleSinopacMitsui(mode) {
        if (mode === 'selected' && document.getElementById('checkSinopacMitsuiSelected').checked) {
            document.getElementById('checkSinopacMitsuiTarget').checked = false;
        }
        if (mode === 'target' && document.getElementById('checkSinopacMitsuiTarget').checked) {
            document.getElementById('checkSinopacMitsuiSelected').checked = false;
        }
        updateRewardPreview();
    }
    
    // æ˜Ÿå±• eco é‚è¼¯
    function toggleDbsLogic(mode) {
        const isLine = document.getElementById('checkDbsLinePay').checked;
        const isGreen = document.getElementById('checkDbsGreen').checked;
        const isForeign = document.getElementById('checkDbsForeign').checked;
        
        if (mode === 'linepay' && isLine) {
            document.getElementById('checkDbsGreen').checked = false;
            document.getElementById('checkDbsForeign').checked = false;
        }
        if (mode === 'green' && isGreen) {
            document.getElementById('checkDbsLinePay').checked = false;
            document.getElementById('checkDbsForeign').checked = false;
        }
        if (mode === 'foreign' && isForeign) {
            document.getElementById('checkDbsLinePay').checked = false;
            document.getElementById('checkDbsGreen').checked = false;
        }
        updateRewardPreview();
    }
    
    function saveCurrencyLevel() {
        const level = document.querySelector('input[name="currencyLevel"]:checked').value;
        localStorage.setItem('currency_level', level);
        renderGrid();
        updateRewardPreview();
    }
    
    function getQuarterRange(dateObj) {
        const year = dateObj.getFullYear();
        const month = dateObj.getMonth();
        const q = Math.floor(month / 3);
        const start = new Date(year, q * 3, 1);
        const end = new Date(year, (q + 1) * 3, 0, 23, 59, 59, 999);
        return { start, end };
    }

    function getBillingCycle(cardId, dateObj = new Date()) {
        const settings = cardSettings[cardId] || {};
        const statementDate = parseInt(settings.billingDay);

        if (!statementDate || statementDate >= 31 || statementDate === 1) {
            return {
                start: new Date(dateObj.getFullYear(), dateObj.getMonth(), 1),
                end: new Date(dateObj.getFullYear(), dateObj.getMonth() + 1, 0, 23, 59, 59),
                isCustom: false
            
            };
        }

        let start, end;
        const currentDay = dateObj.getDate();
        if (currentDay <= statementDate) {
            end = new Date(dateObj.getFullYear(), dateObj.getMonth(), statementDate, 23, 59, 59);
            start = new Date(dateObj.getFullYear(), dateObj.getMonth() - 1, statementDate + 1);
        } else {
            end = new Date(dateObj.getFullYear(), dateObj.getMonth() + 1, statementDate, 23, 59, 59);
            start = new Date(dateObj.getFullYear(), dateObj.getMonth(), statementDate + 1);
        }
        
        return { start, end, isCustom: true };
    }

    // [New] è¼‰å…¥äº¤æ˜“é€²è¡Œç·¨è¼¯ (User Request)
    function loadTransaction(id) {
        const t = transactions.find(tx => tx.id === id);
        if (!t) return;

        editingId = id;
        openQuickAdd(t.cardId); // é€™æœƒé‡ç½®è¡¨å–®ï¼Œæ‰€ä»¥è¦åœ¨å¾Œé¢è£œä¸Šå€¼

        document.getElementById('amountInput').value = t.amount;
        document.getElementById('dateInput').value = t.date;
        document.getElementById('noteInput').value = t.note || '';
        document.getElementById('btn-confirm').innerText = "æ›´æ–°";

        // æ¢å¾© Checkbox ç‹€æ…‹
        const setCheck = (id, val) => { const el = document.getElementById(id); if (el) el.checked = !!val; };
        
        // C6
        setCheck('checkBonus10', t.isBonus10);
        setCheck('checkBonus25', t.isBonus25);
        setCheck('checkIsBill', t.isBill);
        if(t.isBill) toggleBillLogic();
        if(t.isBonus25) toggleSelectedLogic();

        // C2
        setCheck('checkGreenChannel', t.isGreen);
        setCheck('checkForeign', t.isForeign);
        if(t.isGreen) toggleGreenLogic();
        if(t.isForeign) toggleForeignLogic();

        // C7
        setCheck('checkUniUp', t.isUniUp);
        setCheck('checkUniBonus', t.isUniBonus);
        if(t.isUniUp) toggleUniUpLogic();

        // C8
        setCheck('checkHappyPet', t.isHappyPet);
        setCheck('checkHappyPeace', t.isHappyPeace);
        setCheck('checkHappyLife', t.isHappyLife);
        setCheck('checkHappyForeign', t.isHappyForeign);
        if(t.isHappyPet) toggleHappyPet();
        if(t.isHappyPeace) toggleHappyPeace();
        if(t.isHappyLife) toggleHappyLife();
        if(t.isHappyForeign) toggleHappyForeign();

        // C9
        setCheck('checkHsbcForeign', t.isHsbcForeign);

        // C10
        setCheck('checkUniGroup', t.isUniGroup);
        setCheck('checkUniIcash', t.isUniIcash);
        setCheck('checkUniOverseas', t.isUniOverseas);
        // C10 å“ç‰Œ Grid æ¢å¾© (ç•¥è¤‡é›œï¼Œé€™è£¡ç°¡åŒ–è™•ç†ï¼Œå› ç‚ºå­˜çš„æ˜¯ boolean)
        
        // C11 (Radio)
        if(t.cardId === 'c11') {
            if(t.isRichartPay) document.getElementById('rbRichartPay').checked = true;
            else if(t.isRichartOnline) document.getElementById('rbRichartOnline').checked = true;
            else if(t.isRichartLine) document.getElementById('rbRichartLine').checked = true;
            else if(t.isRichartOverseas) document.getElementById('rbRichartOverseas').checked = true;
            else document.getElementById('rbRichartGeneral').checked = true;
        }

        // J1
        setCheck('checkFubonJGeneral', t.isFubonJGeneral);
        setCheck('checkFubonJKorea', t.isFubonJKorea);
        setCheck('checkFubonJThai', t.isFubonJThai);
        setCheck('checkFubonJSuica', t.isFubonJSuica);
        if(t.isFubonJKorea) toggleFubonJPhysical();
        if(t.isFubonJThai) toggleFubonJThai();
        if(t.isFubonJSuica) toggleFubonJSuica();

        // J2
        setCheck('checkJiheJapan', t.isJiheJapan);
        setCheck('checkJiheApple', t.isJiheApple);
        setCheck('checkJiheDomesticJapanese', t.isJiheDomesticJapanese);
        if(t.isJiheJapan) toggleJiheLogic();

        // J3
        setCheck('checkKumamonJapan', t.isKumamonJapan);
        setCheck('checkKumamonDesignated', t.isKumamonDesignated);
        setCheck('checkKumamonPayPay', t.isKumamonPayPay);
        if(t.isKumamonJapan) toggleKumamonLogic();
        // éœ€å†æ¬¡è§¸ç™¼ Sub Logic ç¢ºä¿ UI æ­£ç¢º
        if(t.isKumamonDesignated) toggleKumamonSub('designated');
        if(t.isKumamonPayPay) toggleKumamonSub('paypay');

        // J4
        if(t.cardId === 'j4') {
            if(t.isSinopacCurrencySelected) {
                document.getElementById('rbCurrencySelected').checked = true;
                toggleCurrencyLogic();
            }
        }

        // J5
        setCheck('checkSinopacMitsuiSelected', t.isSinopacMitsuiSelected);
        setCheck('checkSinopacMitsuiTarget', t.isSinopacMitsuiTarget);
        if(t.isSinopacMitsuiSelected) toggleSinopacMitsui('selected');
        if(t.isSinopacMitsuiTarget) toggleSinopacMitsui('target');

        // C4 (Jiang)
        if(t.cardId === 'c4') {
            if(t.isJiangSelected) document.getElementById('rbJiangSelected').checked = true;
            else if(t.isJiangTravel) document.getElementById('rbJiangTravel').checked = true;
        }

        // DBS
        setCheck('checkDbsLinePay', t.isDbsLinePay);
        setCheck('checkDbsGreen', t.isDbsGreen);
        setCheck('checkDbsForeign', t.isDbsForeign); // æ–°å¢
        if(t.isDbsLinePay) toggleDbsLogic('linepay');
        if(t.isDbsGreen) toggleDbsLogic('green');
        if(t.isDbsForeign) toggleDbsLogic('foreign');

        // C12 (JCB)
        setCheck('checkSinopacJcbForeign', t.isSinopacJcbForeign);
        setCheck('checkSinopacJcbBonus', t.isSinopacJcbBonus);
        setCheck('checkSinopacJcbQuarterly', t.isSinopacJcbQuarterly);

        updateRewardPreview();
    }

    function addTransaction(isConfirm) {
        const amount = parseFloat(document.getElementById('amountInput').value);
        const date = document.getElementById('dateInput').value;
        const note = document.getElementById('noteInput').value;
        const cardId = document.getElementById('cardIdInput').value;
        
        if (!amount || amount <= 0) { alert('è«‹è¼¸å…¥æœ‰æ•ˆé‡‘é¡'); 
        return; }
        if (!date) { alert('è«‹é¸æ“‡æ—¥æœŸ'); return; 
        }

        const isCard = (id) => cardId === id;
        // C6
        let isBonus10 = isCard('c6') && document.getElementById('checkBonus10').checked;
        let isBonus25 = isCard('c6') && document.getElementById('checkBonus25').checked;
        let isBill = isCard('c6') && document.getElementById('checkIsBill').checked;
        // C2
        let isGreen = isCard('c2') && document.getElementById('checkGreenChannel').checked;
        let isForeign = (isCard('c2') && document.getElementById('checkForeign').checked) || (isCard('hsbc') && document.getElementById('checkHsbcForeign').checked);
        // C7
        let isUniUp = isCard('c7') && document.getElementById('checkUniUp').checked;
        let isUniBonus = isCard('c7') && document.getElementById('checkUniBonus').checked;

        // C8
        let isHappyPet = isCard('c8') && document.getElementById('checkHappyPet').checked;
        let isHappyPeace = isCard('c8') && document.getElementById('checkHappyPeace').checked;
        let isHappyLife = isCard('c8') && document.getElementById('checkHappyLife').checked;
        let isHappyForeign = isCard('c8') && document.getElementById('checkHappyForeign').checked;
        // C9
        let isHsbcForeign = isCard('c9') && document.getElementById('checkHsbcForeign').checked;
        // C10
        let isUniGroup = isCard('c10') && document.getElementById('checkUniGroup').checked;
        let isUniIcash = isCard('c10') && document.getElementById('checkUniIcash').checked;
        let isUniOverseas = isCard('c10') && document.getElementById('checkUniOverseas').checked;
        // C11
        let richartMode = 'general';
        if (isCard('c11')) {
             richartMode = document.querySelector('input[name="richartMode"]:checked') ? 
             document.querySelector('input[name="richartMode"]:checked').value : 'general';
        }
        let isRichartPay = (richartMode === 'pay');
        let isRichartOnline = (richartMode === 'online');
        let isRichartLine = (richartMode === 'line');
        let isRichartOverseas = (richartMode === 'overseas');
        // J1
        let isFubonJGeneral = isCard('j1') && document.getElementById('checkFubonJGeneral').checked;
        let isFubonJKorea = isCard('j1') && document.getElementById('checkFubonJKorea').checked;
        let isFubonJThai = isCard('j1') && document.getElementById('checkFubonJThai').checked;
        let isFubonJSuica = isCard('j1') && document.getElementById('checkFubonJSuica').checked;
        // J2
        let isJiheJapan = isCard('j2') && document.getElementById('checkJiheJapan').checked;
        let isJiheApple = isCard('j2') && document.getElementById('checkJiheApple').checked;
        let isJiheDomesticJapanese = isCard('j2') && document.getElementById('checkJiheDomesticJapanese').checked;
        // J3
        let isKumamonJapan = isCard('j3') && document.getElementById('checkKumamonJapan').checked;
        let isKumamonDesignated = isCard('j3') && document.getElementById('checkKumamonDesignated').checked;
        let isKumamonPayPay = isCard('j3') && document.getElementById('checkKumamonPayPay').checked;
        // J4
        let isSinopacCurrencySelectedFinal = false;
        if (isCard('j4')) {
            let cType = document.querySelector('input[name="currencyType"]:checked') ? 
            document.querySelector('input[name="currencyType"]:checked').value : 'domestic';
            isSinopacCurrencySelectedFinal = (cType === 'selected');
        }
        // J5
        let isSinopacMitsuiSelected = isCard('j5') && document.getElementById('checkSinopacMitsuiSelected').checked;
        let isSinopacMitsuiTarget = isCard('j5') && document.getElementById('checkSinopacMitsuiTarget').checked;
        // C4
        let isJiangSelected = false;
        let isJiangTravel = false;
        if (isCard('c4')) {
            let jMode = document.querySelector('input[name="jiangMode"]:checked') ? 
            document.querySelector('input[name="jiangMode"]:checked').value : 'base';
            isJiangSelected = (jMode === 'selected');
            isJiangTravel = (jMode === 'travel');
        }
        // DBS Eco (æ–°å¢ isDbsForeign)
        let isDbsLinePay = isCard('dbs1') && document.getElementById('checkDbsLinePay').checked;
        let isDbsGreen = isCard('dbs1') && document.getElementById('checkDbsGreen').checked;
        let isDbsForeign = isCard('dbs1') && document.getElementById('checkDbsForeign').checked;

        // [New] C12 - æ°¸è± JCB
        let isSinopacJcbForeign = isCard('c12') && document.getElementById('checkSinopacJcbForeign').checked;
        let isSinopacJcbJapan = isCard('c12') && document.getElementById('checkSinopacJcbBonus').checked; // æ—¥æœ¬/ç‰¹é¸å…±ç”¨æŒ‰éˆ•
        let isSinopacJcbBonus = isCard('c12') && document.getElementById('checkSinopacJcbBonus').checked;
        let isSinopacJcbQuarterly = isCard('c12') && document.getElementById('checkSinopacJcbQuarterly').checked;

        const newTx = {
            id: editingId || Date.now(),
            cardId, amount, date, note,
            isGreen, isForeign, isUniUp, isUniBonus, isHappyPet, isHappyPeace, isHappyLife, isHappyForeign, isHsbcForeign,
            isUniGroup, isUniIcash, isUniOverseas,
            isRichartPay, isRichartOnline, isRichartLine, isRichartOverseas,
            isBonus10, isBonus25, isBill,
            isFubonJGeneral, isFubonJKorea, isFubonJThai, isFubonJSuica,
            isJiheJapan, isJiheApple, isJiheDomesticJapanese,
            isKumamonJapan, isKumamonDesignated, isKumamonPayPay,
            isSinopacCurrencySelected: isSinopacCurrencySelectedFinal,
            isSinopacMitsuiSelected, isSinopacMitsuiTarget,
            isJiangSelected, isJiangTravel,
            isDbsLinePay, isDbsGreen, isDbsForeign,
            isSinopacJcbForeign, isSinopacJcbJapan, isSinopacJcbBonus, isSinopacJcbQuarterly
        };
        if (editingId) {
            const index = transactions.findIndex(t => t.id === editingId);
            if (index !== -1) transactions[index] = newTx;
            editingId = null;
        } else {
            transactions.push(newTx);
        }

        localStorage.setItem('transactions', JSON.stringify(transactions));
        
        document.getElementById('amountInput').value = '';
        document.getElementById('noteInput').value = '';
        document.getElementById('btn-confirm').innerText = "ç¢ºèª";
        
        renderGrid();
        renderModalHistory(cardId);
        updateRewardPreview();

        if (isConfirm) {
            document.getElementById('transactionModal').style.display = 'none';
        } else {
            document.getElementById('amountInput').focus();
        }
    }
      function calculateStats(cardId, addedAmount = 0, addedIsGreen = false, addedIsForeign = false, addedIsUniBonus = false, addedIsUniUp = false, addedIsHappyPet = false, addedIsHappyLife = false, addedIsHappyForeign = false, addedIsHappyPeace = false, addedIsHsbcForeign = false, addedIsUniGroup = false, addedIsUniIcash = false, addedIsUniOverseas = false, addedIsRichartPay = false, addedIsRichartOnline = false, addedIsRichartLine = false, addedIsRichartOverseas = false, addedIsBonus10 = false, addedIsBonus25 = false, addedIsBill = false, 
        addedIsFubonJGeneral = false, addedIsFubonJKorea = false, addedIsFubonJThai = false, addedIsFubonJSuica = false,
        addedIsJiheJapan = false, 
        addedIsJiheApple = false, addedIsJiheDomesticJapanese = false,
        addedIsKumamonJapan = false, addedIsKumamonDesignated = false, addedIsKumamonPayPay = false,
        addedIsSinopacCurrencySelected = false, 
        addedIsSinopacMitsuiSelected = false, addedIsSinopacMitsuiTarget = false,
        addedIsJiangSelected = false, addedIsJiangTravel = false,
        addedIsDbsLinePay = false, addedIsDbsGreen = false, addedIsDbsForeign = false,
        addedIsSinopacJcbForeign = false, addedIsSinopacJcbJapan = false, addedIsSinopacJcbBonus = false, addedIsSinopacJcbQuarterly = false) {
        
        const card = cards.find(c => c.id === cardId);
        if (card.type === 'placeholder') return { spend: 0, validSpend: 0, reward: 0, rate: '0.0' };
        
        const dateInputVal = document.getElementById('dateInput') ? 
        document.getElementById('dateInput').value : null;
        const refDate = (addedAmount > 0 && dateInputVal) ? new Date(dateInputVal) : new Date();
        const { start: cycleStart, end: cycleEnd, isCustom } = getBillingCycle(cardId, refDate);
        const { start: quarterStart, end: quarterEnd } = getQuarterRange(refDate);
        
        // --- é—œéµä¿®æ­£ï¼šç·¨è¼¯æ¨¡å¼ä¸‹ï¼Œæš«æ™‚æ’é™¤è©²ç­†èˆŠäº¤æ˜“ï¼Œé¿å…é¡åº¦èª¤åˆ¤ ---
        const txToExclude = (typeof editingId !== 'undefined') ? editingId : null;

        const relevantTx = transactions.filter(t => {
            if (txToExclude && t.id === txToExclude) return false;
            const tDate = new Date(t.date);
            return t.cardId === cardId && tDate >= cycleStart && tDate <= cycleEnd;
        });
        const quarterTx = transactions.filter(t => {
            if (txToExclude && t.id === txToExclude) return false;
            const tDate = new Date(t.date);
            return t.cardId === cardId && tDate >= quarterStart && tDate <= quarterEnd;
        });

        let totalSpend = relevantTx.reduce((sum, t) => sum + parseFloat(t.amount), 0);
        totalSpend += addedAmount;
        let reward = 0;
        
        // --- C12 æ°¸è± JCB ---
        if (cardId === 'c12') {
            const txList = [...relevantTx];
            const qTxList = [...quarterTx];
            if (addedAmount > 0) {
                txList.push({ amount: addedAmount, isSinopacJcbForeign: addedIsSinopacJcbForeign, isSinopacJcbJapan: addedIsSinopacJcbJapan, isSinopacJcbBonus: addedIsSinopacJcbBonus });
                qTxList.push({ amount: addedAmount, isSinopacJcbQuarterly: addedIsSinopacJcbQuarterly });
            }

            let baseReward = 0;
            let monthlyBonusSpend = 0;
            txList.forEach(t => {
                let rate = t.isSinopacJcbForeign ? 0.02 : 0.01;
                baseReward += t.amount * rate;
                if (t.isSinopacJcbBonus || t.isSinopacJcbJapan) monthlyBonusSpend += t.amount;
            });
            const monthlyBonus = Math.min(monthlyBonusSpend * 0.03, 300);
            const quarterlySpend = qTxList.filter(t => t.isSinopacJcbQuarterly).reduce((sum, t) => sum + t.amount, 0);
            let quarterlyBonus = 0;
            if (quarterlySpend >= 20000) quarterlyBonus = 1000;

            reward = baseReward + monthlyBonus + quarterlyBonus;
            
            // ç‹€æ…‹æ–‡å­— (ç”¨æ–¼é€²åº¦æ¢ä¸‹æ–¹)
            let statusText = "";
            let msgStyle = "";
            let limit = 10000;
            if (addedIsSinopacJcbQuarterly) {
                 if (quarterlySpend >= 20000) { statusText = "ğŸ‰ å­£æ»¿é¡é”æ¨™ (+$1000)"; msgStyle = "color: #38ef7d;"; } 
                 else { statusText = `å­£ç´¯ç© $${quarterlySpend.toLocaleString()} (å·® $${(20000-quarterlySpend).toLocaleString()})`; }
            } else if (addedIsSinopacJcbBonus) { 
                const remain = Math.max(0, limit - monthlyBonusSpend);
                if (monthlyBonusSpend > limit) { statusText = "ç‰¹é¸/æ—¥æœ¬åŠ ç¢¼å·²å°é ‚"; msgStyle = "color: #ffcccc;"; } 
                else { statusText = `åŠ ç¢¼å‰© $${remain.toLocaleString()} (3%)`; }
            } else { statusText = `æœ¬æœˆç´¯ç© $${totalSpend.toLocaleString()}`; }
            
            return { spend: totalSpend, validSpend: monthlyBonusSpend, reward: Math.round(reward), rate: "0.0", isCustom, cycleStart, cycleEnd, msgDanger: statusText, customLimit: limit, msgStyle };
        }

        // --- æ˜Ÿå±• eco æ°¸çºŒå¡ (DBS) ---
        if (cardId === 'dbs1') {
             const txList = [...relevantTx];
             if (addedAmount > 0) txList.push({ amount: addedAmount, isDbsLinePay: addedIsDbsLinePay, isDbsGreen: addedIsDbsGreen, isDbsForeign: addedIsDbsForeign });
             
             let baseReward = 0;
             let linePayBonusSpend = 0;
             let greenBonusSpend = 0;
             let foreignBonusSpend = 0;
             
             txList.forEach(t => {
                 baseReward += t.amount * 0.01; // ä¿®æ­£ç‚º 1%
                 if (t.isDbsGreen) greenBonusSpend += t.amount;
                 if (t.isDbsLinePay) linePayBonusSpend += t.amount;
                 if (t.isDbsForeign) foreignBonusSpend += t.amount;
             });

             const linePayBonus = Math.min(linePayBonusSpend * 0.09, 1000);
             const greenBonus = Math.min(greenBonusSpend * 0.09, 300);
             const foreignBonus = Math.min(foreignBonusSpend, 15000) * 0.04; // åœ‹å¤–åŠ ç¢¼ 4%

             reward = baseReward + linePayBonus + greenBonus + foreignBonus;
             
             let statusText = '';
             let msgStyle = '';
             let validSpend = 0;
             let limit = 0;
             
             if (addedIsDbsLinePay) {
                 validSpend = linePayBonusSpend; limit = 11111;
                 if (validSpend > limit) { statusText = 'LinePayåŠ ç¢¼å·²å°é ‚'; msgStyle = 'color: #ffcccc;'; } 
                 else { statusText = `LinePay å‰© $${Math.floor(limit - validSpend).toLocaleString()} (10%)`; }
             } else if (addedIsDbsGreen) {
                 validSpend = greenBonusSpend; limit = 3333;
                 if (validSpend > limit) { statusText = 'ç¶ è‰²åŠ ç¢¼å·²å°é ‚'; msgStyle = 'color: #ffcccc;'; } 
                 else { statusText = `ç¶ è‰² å‰© $${Math.floor(limit - validSpend).toLocaleString()} (10%)`; }
             } else if (addedIsDbsForeign) {
                 validSpend = foreignBonusSpend; limit = 15000;
                 if (validSpend > limit) { statusText = 'åœ‹å¤–åŠ ç¢¼å·²å°é ‚ (è®Š1%)'; msgStyle = 'color: #ffcccc;'; } 
                 else { statusText = `åœ‹å¤–å¯¦é«”å‰© $${Math.floor(limit - validSpend).toLocaleString()} (+4%)`; }
             } else { statusText = `æœ¬æœˆç´¯ç© $${totalSpend.toLocaleString()}`; }
             
             return { spend: totalSpend, validSpend: validSpend, reward: Math.round(reward), rate: "0.0", isCustom, cycleStart, cycleEnd, msgDanger: statusText, customLimit: limit, msgStyle: msgStyle };
        }

        // J1: å¯Œé‚¦ J å¡
        if (cardId === 'j1') {
            const txList = [...relevantTx];
            const qTxList = [...quarterTx];
            if (addedAmount > 0) {
                txList.push({ amount: addedAmount, isFubonJGeneral: addedIsFubonJGeneral });
                qTxList.push({ amount: addedAmount, isFubonJKorea: addedIsFubonJKorea, isFubonJThai: addedIsFubonJThai, isFubonJSuica: addedIsFubonJSuica });
            }
            let baseReward = 0;
            txList.forEach(t => {
                if(t.isFubonJGeneral) baseReward += t.amount * 0.03;
                else baseReward += t.amount * 0.01;
            });
            let jkBonusTotal = 0, thaiBonusTotal = 0, suicaBonusTotal = 0;
            qTxList.forEach(t => { 
                if(t.isFubonJKorea && t.amount >= 1000) jkBonusTotal += t.amount * 0.03; 
                if(t.isFubonJThai && t.amount >= 1000) thaiBonusTotal += t.amount * 0.05; 
                if(t.isFubonJSuica && t.amount >= 2000) suicaBonusTotal += t.amount * 0.07; 
            });
            jkBonusTotal = Math.min(jkBonusTotal, 1000);
            thaiBonusTotal = Math.min(thaiBonusTotal, 1000);
            suicaBonusTotal = Math.min(suicaBonusTotal, 200);
            reward = baseReward + jkBonusTotal + thaiBonusTotal + suicaBonusTotal;
            
            let statusText = `æœ¬æœˆç´¯ç© $${totalSpend.toLocaleString()}`;
            let msgStyle = '';
            if(addedIsFubonJKorea) {
                const used = Math.min(qTxList.filter(t=>t.isFubonJKorea).reduce((a,b)=>a+b.amount,0) * 0.03, 1000);
                const remain = Math.floor((1000 - used) / 0.03);
                statusText = (used >= 1000) ? "å­£åŠ ç¢¼å·²å°é ‚ (è®Š3%)" : `æ—¥éŸ“å¯¦é«”å‰© $${remain.toLocaleString()} (å­£)`;
                if(used >= 1000) msgStyle = 'color: #ffcccc;';
            } else if(addedIsFubonJThai) {
                const used = Math.min(qTxList.filter(t=>t.isFubonJThai).reduce((a,b)=>a+b.amount,0) * 0.05, 1000);
                const remain = Math.floor((1000 - used) / 0.05);
                statusText = (used >= 1000) ? "æ³°åœ‹åŠ ç¢¼å·²å°é ‚ (è®Š1%)" : `æ³°åœ‹å¯¦é«”å‰© $${remain.toLocaleString()} (å­£)`;
                if(used >= 1000) msgStyle = 'color: #ffcccc;';
            } else if(addedIsFubonJSuica) {
                const used = Math.min(qTxList.filter(t=>t.isFubonJSuica).reduce((a,b)=>a+b.amount,0) * 0.07, 200);
                const remain = Math.floor((200 - used) / 0.07);
                statusText = (used >= 200) ? "äº¤é€šå¡åŠ ç¢¼å·²å°é ‚ (è®Š3%)" : `äº¤é€šå¡å‰© $${remain.toLocaleString()} (å­£)`;
                if(used >= 200) msgStyle = 'color: #ffcccc;';
            }
            return { spend: totalSpend, validSpend: totalSpend, reward: Math.round(reward), rate: "0.0", isCustom, cycleStart, cycleEnd, msgDanger: statusText, customLimit: 0, msgStyle: msgStyle };
        }

        // J2
        if (cardId === 'j2') {
            const txList = [...relevantTx];
            if (addedAmount > 0) txList.push({ amount: addedAmount, isJiheJapan: addedIsJiheJapan, isJiheApple: addedIsJiheApple, isJiheDomesticJapanese: addedIsJiheDomesticJapanese });
            let baseReward = 0;
            txList.forEach(t => {
                if (t.isJiheJapan) baseReward += t.amount * 0.025;
                else baseReward += t.amount * 0.01;
            });
            const appleSpend = relevantTx.filter(t => t.isJiheApple).reduce((sum, t) => sum + t.amount, 0) + (addedIsJiheApple ? addedAmount : 0);
            const bonusApple = Math.min(appleSpend, 40000) * 0.015;
            const domesticJpSpend = relevantTx.filter(t => t.isJiheDomesticJapanese).reduce((sum, t) => sum + t.amount, 0) + (addedIsJiheDomesticJapanese ? addedAmount : 0);
            const bonusDom = Math.min(domesticJpSpend, 12500) * 0.04;
            reward = baseReward + bonusApple + bonusDom;
            return { spend: totalSpend, validSpend: totalSpend, reward: Math.round(reward), rate: "0.0", isCustom, cycleStart, cycleEnd };
        }

        // J3
        if (cardId === 'j3') {
            const txList = [...relevantTx];
            const qTxList = [...quarterTx];
            if (addedAmount > 0) {
                txList.push({ amount: addedAmount, isKumamonJapan: addedIsKumamonJapan, isKumamonDesignated: addedIsKumamonDesignated });
                qTxList.push({ amount: addedAmount, isKumamonPayPay: addedIsKumamonPayPay });
            }
            let baseAndDesignatedReward = 0;
            let designatedSpend = 0;
            txList.forEach(t => {
                 let rate = 0.005; 
                 if (t.isKumamonJapan || t.isKumamonDesignated) rate = 0.025; 
                 baseAndDesignatedReward += t.amount * rate;
                 if (t.isKumamonDesignated) designatedSpend += t.amount;
            });
            const designatedBonus = Math.min(designatedSpend, 8333) * 0.06;
            const paypayBonusRate = 0.035;
            const paypayFeeWaiver = 0.015;
            const monthlyPayPaySpend = txList.filter(t => t.isKumamonPayPay).reduce((sum,t) => sum + t.amount, 0) + (addedIsKumamonPayPay ? addedAmount : 0);
            const feeWaiverReward = monthlyPayPaySpend * paypayFeeWaiver;
            const quarterlyPayPaySpend = qTxList.filter(t => t.isKumamonPayPay).reduce((sum,t) => sum + t.amount, 0);
            const paypayBonus = Math.min(quarterlyPayPaySpend * paypayBonusRate, 100);
            reward = baseAndDesignatedReward + designatedBonus + feeWaiverReward + paypayBonus;

            let validSpend = designatedSpend;
            let limit = 8333;
            let msg = '';
            if (addedIsKumamonPayPay || (quarterlyPayPaySpend > 0 && !addedIsKumamonDesignated && !addedIsKumamonJapan)) {
                validSpend = quarterlyPayPaySpend; limit = 2857;
                if (validSpend >= limit) msg = 'PayPayåŠ ç¢¼å·²å°é ‚';
                else msg = `PayPay å‰© $${Math.floor(limit - validSpend).toLocaleString()} (å­£)`;
            } else if (addedIsKumamonDesignated || designatedSpend > 0) {
                if (validSpend >= limit) msg = 'æŒ‡å®šåŠ ç¢¼å·²å°é ‚';
                else msg = `æŒ‡å®šé€šè·¯å‰© $${Math.floor(limit - validSpend).toLocaleString()}`;
            } else { msg = 'æœ¬æœˆç´¯ç©æ¶ˆè²»'; limit = 0; }
            return { spend: totalSpend, validSpend: validSpend, reward: Math.round(reward), rate: "0.0", isCustom, cycleStart, cycleEnd, msgDanger: msg, customLimit: limit };
        }

        // J4
        if (cardId === 'j4') {
            const level = localStorage.getItem('currency_level') || 'low';
            const bonusCap = (level === 'high') ? 800 : 300; 
            const spendingCap = bonusCap / 0.04;
            const txList = [...relevantTx];
            if (addedAmount > 0) txList.push({ amount: addedAmount, isSinopacCurrencySelected: addedIsSinopacCurrencySelected });
            let baseReward = 0;
            txList.forEach(t => {
                if(t.isSinopacCurrencySelected) baseReward += t.amount * 0.02; 
                else baseReward += t.amount * 0.01;
            });
            const bonusTx = txList.filter(t => t.isSinopacCurrencySelected);
            const totalBonusSpend = bonusTx.reduce((sum, t) => sum + t.amount, 0);
            const actualBonus = Math.min(totalBonusSpend * 0.04, bonusCap);
            reward = baseReward + actualBonus;
            let statusText = '';
            if (totalBonusSpend >= spendingCap) { statusText = 'åŠ ç¢¼å·²å°é ‚ (è®Š2%)'; } 
            else { statusText = `å‰© $${Math.floor(spendingCap - totalBonusSpend).toLocaleString()} (ç²¾é¸)`; }
            return { spend: totalSpend, validSpend: totalBonusSpend, reward: Math.round(reward), rate: "0.0", isCustom, cycleStart, cycleEnd, msgDanger: statusText, customLimit: spendingCap };
        }

        // J5
        if (cardId === 'j5') {
            const baseReward = totalSpend * 0.003;
            const txList = [...relevantTx]; 
            if (addedAmount > 0) txList.push({ amount: addedAmount, isSinopacMitsuiSelected: addedIsSinopacMitsuiSelected });
            const selectedSpend = txList.filter(t => t.isSinopacMitsuiSelected).reduce((sum, t) => sum + t.amount, 0);
            const selectedBonus = Math.min(selectedSpend * 0.07, 100);
            const spendingCap = 1428;
            const quarterHistory = quarterTx.filter(t => t.isSinopacMitsuiTarget).reduce((sum, t) => sum + t.amount, 0);
            let currentQuarterSpend = quarterHistory;
            if (addedIsSinopacMitsuiTarget) currentQuarterSpend += addedAmount;
            let targetBonus = 0;
            if (currentQuarterSpend >= 30000 && quarterHistory < 30000) targetBonus = 2000;
            reward = baseReward + selectedBonus + targetBonus;
            let statusText = '';
            let validSpend = selectedSpend; 
            let limit = spendingCap;
            if (addedIsSinopacMitsuiTarget || (quarterHistory > 0 && !addedIsSinopacMitsuiSelected)) {
                validSpend = currentQuarterSpend; limit = 30000;
                if (currentQuarterSpend >= 30000) statusText = 'ğŸ‰ æœ¬å­£å·²é”æ¨™ (é ˜$2000)';
                else statusText = `å·® $${(30000 - currentQuarterSpend).toLocaleString()} é ˜$2000 (å­£)`;
            } else {
                if (selectedSpend >= spendingCap) statusText = 'ç‰¹é¸å·²å°é ‚';
                else statusText = `å‰© $${Math.floor(spendingCap - selectedSpend).toLocaleString()} (ç‰¹é¸)`;
            }
            return { spend: totalSpend, validSpend: validSpend, reward: Math.round(reward), rate: "0.0", isCustom, cycleStart, cycleEnd, msgDanger: statusText, customLimit: limit };
        }
        
        // C4
        if (cardId === 'c4') {
            const baseReward = totalSpend * 0.005;
            let bonusReward = 0;
            if (totalSpend >= 3000) {
                const txList = [...relevantTx];
                if(addedAmount > 0) txList.push({ amount: addedAmount, isJiangSelected: addedIsJiangSelected, isJiangTravel: addedIsJiangTravel });
                const selectedSpend = txList.filter(t => t.isJiangSelected).reduce((sum, t) => sum + t.amount, 0);
                const selectedBonus = Math.min(selectedSpend, 6666) * 0.045;
                const travelTx = txList.filter(t => t.isJiangTravel);
                let qualifiedTravelSpend = 0;
                const travelExpiry = new Date('2026-03-31T23:59:59');
                travelTx.forEach(t => {
                    const tDate = new Date(t.date || new Date());
                    if (tDate <= travelExpiry) qualifiedTravelSpend += t.amount;
                });
                const travelBonus = Math.min(qualifiedTravelSpend, 11111) * 0.045;
                bonusReward = selectedBonus + travelBonus;
            }
            reward = baseReward + bonusReward;
            return { spend: totalSpend, validSpend: totalSpend, reward: Math.round(reward), rate: "0.0", isCustom, cycleStart, cycleEnd };
        }

        // C8
        if (cardId === 'c8') {
            if (totalSpend < 3000) {
                reward = totalSpend * 0.005;
                return { spend: totalSpend, validSpend: totalSpend, reward: Math.round(reward), rate: "0.0", isCustom, cycleStart, cycleEnd };
            } else {
                let baseReward = totalSpend * 0.005;
                const petSpend = relevantTx.filter(t => t.isHappyPet).reduce((sum, t) => sum + t.amount, 0) + (addedIsHappyPet ? addedAmount : 0);
                const lifeSpend = relevantTx.filter(t => t.isHappyLife).reduce((sum, t) => sum + t.amount, 0) + (addedIsHappyLife ? addedAmount : 0);
                const peaceSpend = relevantTx.filter(t => t.isHappyPeace).reduce((sum, t) => sum + t.amount, 0) + (addedIsHappyPeace ? addedAmount : 0);
                const foreignSpend = relevantTx.filter(t => t.isHappyForeign).reduce((sum, t) => sum + t.amount, 0) + (addedIsHappyForeign ? addedAmount : 0);
                const bonusPet = Math.min(petSpend, 5263) * 0.095;
                const bonusLife = Math.min(lifeSpend, 5714) * 0.035;
                const bonusPeace = Math.min(peaceSpend, 5714) * 0.035;
                const bonusForeign = foreignSpend * 0.02;
                reward = baseReward + bonusPet + bonusLife + bonusPeace + bonusForeign;
                if(totalSpend >= 26000) reward += 400;
                return { spend: totalSpend, validSpend: totalSpend, reward: Math.round(reward), rate: "0.0", isCustom, cycleStart, cycleEnd };
            }
        }
        
        // C2
        if (cardId === 'c2') {
            let baseReward = totalSpend * 0.01;
            const greenSpend = relevantTx.filter(t => t.isGreen).reduce((sum, t) => sum + t.amount, 0) + (addedIsGreen ? addedAmount : 0);
            const bonusGreen = Math.min(greenSpend, 3000) * 0.05;
            const foreignSpend = relevantTx.filter(t => t.isForeign).reduce((sum, t) => sum + t.amount, 0) + (addedIsForeign ? addedAmount : 0);
            const bonusForeign = foreignSpend * 0.01;
            reward = baseReward + bonusGreen + bonusForeign;
            return { spend: totalSpend, validSpend: totalSpend, reward: Math.round(reward), rate: "0.0", isCustom, cycleStart, cycleEnd };
        }
        
        // C7
        if (cardId === 'c7') {
            const isUpMode = addedIsUniUp || relevantTx.some(t => t.isUniUp);
            let currentRate = 0.035; 
            let currentCap = 40000;
            if (isUpMode) { currentRate = 0.045; currentCap = 142857;
            }
            let baseReward = 0;
            if (totalSpend <= currentCap) { baseReward = totalSpend * currentRate;
            } else { baseReward = (currentCap * currentRate) + ((totalSpend - currentCap) * 0.01);
            }
            const bonusSpend = relevantTx.filter(t => t.isUniBonus).reduce((sum, t) => sum + t.amount, 0) + (addedIsUniBonus ? addedAmount : 0);
            const bonusReward = Math.min(bonusSpend, 16666) * 0.03;
            reward = baseReward + bonusReward;
            return { spend: totalSpend, validSpend: totalSpend, reward: Math.round(reward), rate: "0.0", isCustom, cycleStart, cycleEnd };
        }
        
        // C6
        if (cardId === 'c6') {
            const bonus10TxSpend = relevantTx.filter(t => t.isBonus10).reduce((sum, t) => sum + t.amount, 0) + (addedIsBonus10 ? addedAmount : 0);
            const bonus10Reward = Math.min(bonus10TxSpend, 8000) * 0.10;
            const bonus25TxSpend = relevantTx.filter(t => t.isBonus25).reduce((sum, t) => sum + t.amount, 0) + (addedIsBonus25 ? addedAmount : 0);
            const selectedReward = Math.min(bonus25TxSpend, 400000) * 0.025;
            let baseReward = relevantTx.reduce((sum, t) => sum + (t.amount * (t.isBill ? 0.0015 : 0.01)), 0);
            if (addedAmount > 0) baseReward += addedAmount * (addedIsBill ? 0.0015 : 0.01);
            reward = baseReward + selectedReward + bonus10Reward;
            return { spend: totalSpend, validSpend: totalSpend, reward: Math.round(reward), rate: "0.0", isCustom, cycleStart, cycleEnd };
        }

        // C10
        if (cardId === 'c10') {
            const currentOverseasSpend = relevantTx.filter(t => t.isUniOverseas).reduce((sum, t) => sum + t.amount, 0) + (addedIsUniOverseas ? addedAmount : 0);
            const overseasReward = (currentOverseasSpend * 0.03) + Math.min(currentOverseasSpend, 6250) * 0.08;
            const icashSpend = relevantTx.filter(t => t.isUniIcash && !t.isUniOverseas).reduce((sum, t) => sum + t.amount, 0) + (addedIsUniIcash && !addedIsUniOverseas ? addedAmount : 0);
            const icashReward = Math.min(icashSpend, 3750) * 0.04;
            
            const groupTx = relevantTx.filter(t => t.isUniGroup && !t.isUniOverseas);
            let currentGroupSpend = groupTx.reduce((sum, t) => sum + t.amount, 0);
            if (addedIsUniGroup && !addedIsUniOverseas) currentGroupSpend += addedAmount;
            const groupBonus = Math.min(currentGroupSpend, 25000) * 0.02;
            
            const savedState = JSON.parse(localStorage.getItem('uniOpenState') || '{"brands":[]}');
            const count = savedState.brands ? 
            savedState.brands.length : 0;
            let taskRate = 0;
            if (count >= 5) taskRate = 0.04;
            else if (count === 4) taskRate = 0.03;
            else if (count === 3) taskRate = 0.02;
            else if (count === 2) taskRate = 0.01;
            const taskBonus = Math.min(currentGroupSpend, 12500) * taskRate;
            const domesticSpend = totalSpend - currentOverseasSpend;
            const baseDomesticReward = domesticSpend * 0.01;
            reward = overseasReward + baseDomesticReward + groupBonus + taskBonus + icashReward;
            return { spend: totalSpend, validSpend: totalSpend, reward: Math.round(reward), rate: "0.0", isCustom, cycleStart, cycleEnd };
        }

        // C11
        if (cardId === 'c11') {
            const richartPaySpend = relevantTx.filter(t => t.isRichartPay).reduce((sum, t) => sum + t.amount, 0) + (addedIsRichartPay ? addedAmount : 0);
            const richartOnlineSpend = relevantTx.filter(t => t.isRichartOnline).reduce((sum, t) => sum + t.amount, 0) + (addedIsRichartOnline ? addedAmount : 0);
            const richartLineSpend = relevantTx.filter(t => t.isRichartLine).reduce((sum, t) => sum + t.amount, 0) + (addedIsRichartLine ? addedAmount : 0);
            const richartOverseasSpend = relevantTx.filter(t => t.isRichartOverseas).reduce((sum, t) => sum + t.amount, 0) + (addedIsRichartOverseas ? addedAmount : 0);
            const normalSpend = Math.max(0, totalSpend - richartPaySpend - richartOnlineSpend - richartLineSpend - richartOverseasSpend);
            reward = (richartPaySpend * 0.038) + (richartOnlineSpend * 0.033) + (richartLineSpend * 0.023) + (richartOverseasSpend * 0.033) + (normalSpend * 0.003);
            return { spend: totalSpend, validSpend: totalSpend, reward: Math.round(reward), rate: "0.0", isCustom, cycleStart, cycleEnd };
        }

        // C9
        if (cardId === 'c9') {
            const tier = localStorage.getItem('hsbc_tier') || 'infinite';
            let rateDomestic = 18; let rateForeign = 10; if (tier === 'signature') { rateDomestic = 18; rateForeign = 15; 
            }
            let totalMiles = parseInt(localStorage.getItem('hsbc_initial_miles') || 0);
            let redeemedMiles = parseInt(localStorage.getItem('hsbc_redeemed_miles') || 0);
            const allHistoryTx = transactions.filter(t => t.cardId === 'c9');
            allHistoryTx.forEach(tx => { const rate = tx.isHsbcForeign ? rateForeign : rateDomestic; totalMiles += Math.floor(tx.amount / rate); });
            if (addedAmount > 0) { const currentRate = addedIsHsbcForeign ? rateForeign : rateDomestic; totalMiles += Math.floor(addedAmount / currentRate); 
            }
            reward = totalMiles - redeemedMiles;
            let cycleReward = 0;
            const { start, end } = getBillingCycle(cardId);
            const cycleTx = transactions.filter(t => { const tDate = new Date(t.date); return t.cardId === 'c9' && tDate >= start && tDate <= end; });
            cycleTx.forEach(tx => { const rate = tx.isHsbcForeign ? rateForeign : rateDomestic; cycleReward += Math.floor(tx.amount / rate); });
            if(addedAmount > 0) { const currentRate = addedIsHsbcForeign ? rateForeign : rateDomestic; cycleReward += Math.floor(addedAmount / currentRate); 
            }
            return { spend: totalSpend, validSpend: totalSpend, reward: cycleReward, rate: (totalSpend>0?(totalSpend/totalMiles).toFixed(1):0), isCustom, cycleStart, cycleEnd };
        }
        
        // å…¶ä»–
        let validSpend = totalSpend;
        if (card.type === 'mixed') { if (validSpend < card.minSpend) reward = validSpend * card.tier2Rate;
        else if (validSpend <= card.limit) reward = validSpend * card.tier1Rate;
        else reward = (card.limit * card.tier1Rate) + ((validSpend - card.limit) * card.tier2Rate);
        } 
        else if (card.type === 'ceiling') { if (validSpend <= card.limit) reward = validSpend * card.tier1Rate;
        else reward = (card.limit * card.tier1Rate) + ((validSpend - card.limit) * card.tier2Rate);
        } 
        else { reward = validSpend * (card.tier1Rate || 0);
        }
        let currentRate = (card.tier1Rate || 0)*100;
        if(totalSpend>0) currentRate = (reward/totalSpend)*100;
        return { spend: totalSpend, validSpend: validSpend, reward: Math.round(reward), rate: "0.0", isCustom, cycleStart, cycleEnd };
    }

    function toggleBillLogic() { const isBill = document.getElementById('checkIsBill').checked; document.getElementById('labelBaseRate').innerText = isBill ? 
    "ğŸ”° åŸºæœ¬å›é¥‹ 0.15% (ç„¡ä¸Šé™)" : "ğŸ”° åŸºæœ¬å›é¥‹ 1% (ç„¡ä¸Šé™)"; if(isBill) document.getElementById('checkBonus25').checked = false; updateRewardPreview();
    }
    function toggleSelectedLogic() { const isSelected = document.getElementById('checkBonus25').checked; document.getElementById('labelBaseRate').innerText = isSelected ? 
    "ğŸ”° åŸºæœ¬å›é¥‹ 1% (ç„¡ä¸Šé™)" : "ğŸ”° åŸºæœ¬å›é¥‹ 1% (ç„¡ä¸Šé™)"; if(isSelected) document.getElementById('checkIsBill').checked = false; updateRewardPreview();
    }
    function toggleGreenLogic() { if(document.getElementById('checkGreenChannel').checked) document.getElementById('checkForeign').checked = false; updateRewardPreview();
    }
    function toggleForeignLogic() { if(document.getElementById('checkForeign').checked) document.getElementById('checkGreenChannel').checked = false; updateRewardPreview();
    }
    function toggleHappyPet() { if(document.getElementById('checkHappyPet').checked) { document.getElementById('checkHappyPeace').checked = false; document.getElementById('checkHappyLife').checked = false; document.getElementById('checkHappyForeign').checked = false; } updateRewardPreview();
    }
    function toggleHappyPeace() { if(document.getElementById('checkHappyPeace').checked) { document.getElementById('checkHappyPet').checked = false; document.getElementById('checkHappyLife').checked = false; document.getElementById('checkHappyForeign').checked = false; } updateRewardPreview();
    }
    function toggleHappyLife() { if(document.getElementById('checkHappyLife').checked) { document.getElementById('checkHappyPet').checked = false; document.getElementById('checkHappyPeace').checked = false; document.getElementById('checkHappyForeign').checked = false; } updateRewardPreview();
    }
    function toggleHappyForeign() { if(document.getElementById('checkHappyForeign').checked) { document.getElementById('checkHappyPet').checked = false; document.getElementById('checkHappyPeace').checked = false; document.getElementById('checkHappyLife').checked = false; } updateRewardPreview();
    }
    function toggleRichartLogic() { updateRewardPreview(); }

    function updateRewardPreview() {
        const inputVal = document.getElementById('amountInput').value;
        const amount = parseFloat(inputVal);
        const previewDiv = document.getElementById('liveRewardCalc');
        const cardId = document.getElementById('cardIdInput').value;
        if (!amount || amount <= 0) { previewDiv.style.display = 'none'; return; 
        }
        previewDiv.style.display = 'block'; 
        
        let isGreen = document.getElementById('checkGreenChannel') ? document.getElementById('checkGreenChannel').checked : false;
        let isForeign = document.getElementById('checkForeign') ? document.getElementById('checkForeign').checked : false;
        let isUniUp = document.getElementById('checkUniUp') ? document.getElementById('checkUniUp').checked : false;
        let isUniBonus = document.getElementById('checkUniBonus') ? document.getElementById('checkUniBonus').checked : false;
        let isHappyPet = document.getElementById('checkHappyPet') ? document.getElementById('checkHappyPet').checked : false;
        let isHappyPeace = document.getElementById('checkHappyPeace') ? document.getElementById('checkHappyPeace').checked : false;
        let isHappyLife = document.getElementById('checkHappyLife') ? document.getElementById('checkHappyLife').checked : false;
        let isHappyForeign = document.getElementById('checkHappyForeign') ? document.getElementById('checkHappyForeign').checked : false;
        let isHsbcForeign = document.getElementById('checkHsbcForeign') ? document.getElementById('checkHsbcForeign').checked : false;
        let isUniGroup = document.getElementById('checkUniGroup') ? document.getElementById('checkUniGroup').checked : false;
        let isUniIcash = document.getElementById('checkUniIcash') ? document.getElementById('checkUniIcash').checked : false;
        let isUniOverseas = document.getElementById('checkUniOverseas') ? document.getElementById('checkUniOverseas').checked : false;
        let richartMode = document.querySelector('input[name="richartMode"]:checked') ? document.querySelector('input[name="richartMode"]:checked').value : 'general';
        let isRichartPay = richartMode === 'pay';
        let isRichartOnline = richartMode === 'online';
        let isRichartLine = richartMode === 'line';
        let isRichartOverseas = richartMode === 'overseas';
        
        let isBonus10 = document.getElementById('checkBonus10') ? document.getElementById('checkBonus10').checked : false;
        let isBonus25 = document.getElementById('checkBonus25') ? 
        document.getElementById('checkBonus25').checked : false;
        let isBill = document.getElementById('checkIsBill') ? document.getElementById('checkIsBill').checked : false;
        // J1
        let isFubonJGeneral = document.getElementById('checkFubonJGeneral') ? document.getElementById('checkFubonJGeneral').checked : false;
        let isFubonJKorea = document.getElementById('checkFubonJKorea') ? document.getElementById('checkFubonJKorea').checked : false;
        let isFubonJThai = document.getElementById('checkFubonJThai') ? document.getElementById('checkFubonJThai').checked : false;
        let isFubonJSuica = document.getElementById('checkFubonJSuica') ? document.getElementById('checkFubonJSuica').checked : false;
        
        let isJiheJapan = document.getElementById('checkJiheJapan') ? document.getElementById('checkJiheJapan').checked : false;
        let isJiheApple = document.getElementById('checkJiheApple') ? document.getElementById('checkJiheApple').checked : false;
        let isJiheDomesticJapanese = document.getElementById('checkJiheDomesticJapanese') ? document.getElementById('checkJiheDomesticJapanese').checked : false;
        let isKumamonJapan = document.getElementById('checkKumamonJapan') ? document.getElementById('checkKumamonJapan').checked : false;
        let isKumamonDesignated = document.getElementById('checkKumamonDesignated') ? document.getElementById('checkKumamonDesignated').checked : false;
        let isKumamonPayPay = document.getElementById('checkKumamonPayPay') ? document.getElementById('checkKumamonPayPay').checked : false;
        
        let isSinopacCurrencySelected = document.getElementById('checkSinopacCurrencySelected') ? document.getElementById('checkSinopacCurrencySelected').checked : false;
        let isSinopacMitsuiSelected = document.getElementById('checkSinopacMitsuiSelected') ? document.getElementById('checkSinopacMitsuiSelected').checked : false;
        let isSinopacMitsuiTarget = document.getElementById('checkSinopacMitsuiTarget') ? document.getElementById('checkSinopacMitsuiTarget').checked : false;
        let jiangMode = document.querySelector('input[name="jiangMode"]:checked') ? document.querySelector('input[name="jiangMode"]:checked').value : 'base';
        let isJiangSelected = jiangMode === 'selected';
        let isJiangTravel = jiangMode === 'travel';
        let currencyType = document.querySelector('input[name="currencyType"]:checked') ? document.querySelector('input[name="currencyType"]:checked').value : 'domestic';
        let isSinopacCurrencySelectedFinal = (currencyType === 'selected');
        // DBS
        let isDbsLinePay = document.getElementById('checkDbsLinePay') ? document.getElementById('checkDbsLinePay').checked : false;
        let isDbsGreen = document.getElementById('checkDbsGreen') ? document.getElementById('checkDbsGreen').checked : false;
        let isDbsForeign = document.getElementById('checkDbsForeign') ? document.getElementById('checkDbsForeign').checked : false;

        // [New] C12 - æ°¸è± JCB
        let isSinopacJcbForeign = document.getElementById('checkSinopacJcbForeign') ? document.getElementById('checkSinopacJcbForeign').checked : false;
        let isSinopacJcbJapan = document.getElementById('checkSinopacJcbBonus') ? document.getElementById('checkSinopacJcbBonus').checked : false; // æ—¥æœ¬/ç‰¹é¸å…±ç”¨æŒ‰éˆ•
        let isSinopacJcbBonus = document.getElementById('checkSinopacJcbBonus') ? document.getElementById('checkSinopacJcbBonus').checked : false;
        let isSinopacJcbQuarterly = document.getElementById('checkSinopacJcbQuarterly') ? document.getElementById('checkSinopacJcbQuarterly').checked : false;

        const currentStats = calculateStats(cardId, 0);
        const newStats = calculateStats(cardId, amount, isGreen, isForeign, isUniBonus, isUniUp, isHappyPet, isHappyLife, isHappyForeign, isHappyPeace, isHsbcForeign, isUniGroup, isUniIcash, isUniOverseas, isRichartPay, isRichartOnline, isRichartLine, isRichartOverseas, isBonus10, isBonus25, isBill, 
            isFubonJGeneral, isFubonJKorea, isFubonJThai, isFubonJSuica,
            isJiheJapan, isJiheApple, isJiheDomesticJapanese,
            isKumamonJapan, isKumamonDesignated, isKumamonPayPay, 
            isSinopacCurrencySelectedFinal, 
            isSinopacMitsuiSelected, isSinopacMitsuiTarget,
            isJiangSelected, isJiangTravel,
            isDbsLinePay, isDbsGreen, isDbsForeign,
            isSinopacJcbForeign, isSinopacJcbJapan, isSinopacJcbBonus, isSinopacJcbQuarterly);
        
        const thisTransactionReward = newStats.reward - currentStats.reward;
        if (cardId === 'c9') { 
            previewDiv.innerHTML = `âœ¨ é è¨ˆå›é¥‹ï¼š${thisTransactionReward} å“©`;
        } else { 
            const effectiveRate = (thisTransactionReward / amount) * 100;
            if (effectiveRate > 20) {
                previewDiv.innerHTML = `âœ¨ é è¨ˆå›é¥‹ï¼š$${thisTransactionReward} (å«é”æ¨™å›æº¯)`;
            } else {
                previewDiv.innerHTML = `âœ¨ é è¨ˆå›é¥‹ï¼š$${thisTransactionReward} (${effectiveRate.toFixed(1)}%)`;
            }
        }
    }

    function renderGrid() {
        const container = document.getElementById('card-grid');
        let monthTotalReward = 0; container.innerHTML = '';
        cards.forEach(card => { if (card.type === 'placeholder') return; const stats = calculateStats(card.id); if (card.id !== 'c9') monthTotalReward += (Number(stats.reward) || 0); });
        document.getElementById('totalRewardDisplay').innerText = `$${monthTotalReward.toLocaleString()}`;
        const displayCards = getSortedCards();

        displayCards.forEach(card => {
            const stats = calculateStats(card.id); 
            let percent = 0, statusText = '', msgStyle = '';
            let displayRate = `${stats.rate}%`; // é è¨­å€¼

            // --- æ ¸å¿ƒä¿®æ”¹ï¼šå¼·åˆ¶æŒ‡å®šéœæ…‹é¡¯ç¤ºè²»ç‡ (Static Badge Rate) ---
            if (card.id === 'c6') displayRate = '13.5%';
            if (card.id === 'c1') displayRate = '10.0%';
            if (card.id === 'c5') displayRate = '6.0%';
            if (card.id === 'c3') displayRate = '5.0%';
            if (card.id === 'c4') displayRate = '5.0%'; // å³ä½¿æœªæ»¿é¡æˆ–å°é ‚ï¼Œé¦–é ä»é¡¯ç¤º 5%
            if (card.id === 'c2') displayRate = '6.0%';
            if (card.id === 'c7') displayRate = '4.5%';
            if (card.id === 'c8') displayRate = '10.0%';
            if (card.id === 'c9') displayRate = 'å“©ç¨‹';
            if (card.id === 'c10') displayRate = '11.0%';
            if (card.id === 'c11') displayRate = '3.8%';
            if (card.id === 'j1') displayRate = '10.0%';
            if (card.id === 'j2') displayRate = '4.0%';
            if (card.id === 'j3') displayRate = '8.5%';
            if (card.id === 'j4') displayRate = '6.0%';
            if (card.id === 'j5') displayRate = '7.3%';
            if (card.id === 'dbs1') displayRate = '5.0%'; // æ˜Ÿå±• Eco å›ºå®šé¡¯ç¤º 5%
            if (card.id === 'c12') displayRate = '5.0%';
            if (card.type === 'placeholder') displayRate = '--%';

            if (card.id === 'c10') {
                statusText = `æœ¬æœˆå·²è³º ${stats.reward} é»`;
                 const savedState = JSON.parse(localStorage.getItem('uniOpenState') || '{}');
                if (savedState.icash) {
                    const icashSpend = transactions.filter(t => t.cardId === 'c10' && t.isUniIcash).reduce((sum, t) => sum + t.amount, 0);
                    if (icashSpend >= 3750) { msgStyle = 'color:#d32f2f;'; statusText 
                    = 'icashå›é¥‹å·²æ»¿'; }
                }
            } else if (card.id === 'c9') {
                const tier = localStorage.getItem('hsbc_tier') || 'infinite';
                card.name = (tier === 'infinite') ? 'æ»™è±æ—…äººç„¡é™å¡' : 'æ»™è±æ—…äººå¾¡ç’½å¡';
                card.note = (tier 
                === 'infinite') ? 'åœ‹å…§18/åœ‹å¤–10 (å“©)' : 'åœ‹å…§18/åœ‹å¤–15 (å“©)';
                let totalMiles = parseInt(localStorage.getItem('hsbc_initial_miles') || 
                0);
                let redeemedMiles = parseInt(localStorage.getItem('hsbc_redeemed_miles') || 0);
                const allHistoryTx = transactions.filter(t => t.cardId === 'c9');
                const rateDomestic = (tier === 'infinite') ? 18 : 18;
                const rateForeign = (tier === 'infinite') ? 10 : 15;
                allHistoryTx.forEach(tx => { const rate = tx.isHsbcForeign ? rateForeign : rateDomestic; totalMiles += Math.floor(tx.amount / rate); });
                const finalTotal = Math.max(0, totalMiles - redeemedMiles);
                statusText = `ç¸½å“©ç¨‹ ${finalTotal.toLocaleString()} å“©`;
                msgStyle = 'color: #007AFF; font-weight:bold;';
            } else if (card.id === 'c8') { 
                if (stats.spend < 3000) { 
                    percent = (stats.spend / 3000) * 100;
                    statusText = `å·® $${(3000 - stats.spend).toLocaleString()} å‡ç´šå›é¥‹`;
                    msgStyle = 'color: #FFD700;';
                } else if (stats.spend < 26000) { percent = (stats.spend / 26000) * 100;
                statusText = `å·® $${(26000 - stats.spend).toLocaleString()} é ˜æ»¿é¡ç¦®`; } 
                else { percent = 100;
                statusText = 'ğŸ‰ æ»¿é¡é”æ¨™ (è¨˜å¾—ç™»éŒ„!)'; msgStyle = 'color: #38ef7d;'; }
            } else if (card.type === 'mixed') { 
                if (stats.validSpend < card.minSpend) { 
                    percent = (stats.validSpend / card.minSpend) * 100;
                    statusText = `âš ï¸ å·® $${(card.minSpend - stats.validSpend).toLocaleString()} å•Ÿå‹•åŠ ç¢¼`;
                    msgStyle = 'color: #FFD700; font-weight: bold;';
                }
                else if (stats.validSpend <= card.limit) { 
                    percent = (stats.validSpend / card.limit) * 100;
                    const remain = card.limit - stats.validSpend; 
                    statusText = `å‰© $${remain.toLocaleString()} (5%)`;
                }
                else { percent = 100;
                statusText = 'å·²å°é ‚ (è®Š0.5%)'; msgStyle = 'color: #ffcccc;'; }
            } else if (card.type === 'ceiling' || card.type === 'custom_j' || card.id === 'j2' || card.id === 'j3' || card.id === 'j4' || card.id === 'j5' || card.id === 'dbs1' || card.id === 'c12') {
                if(card.id === 'j1') {
                    if (stats.msgDanger) {
                       statusText = stats.msgDanger;
                        if(stats.msgDanger.includes('å·²å°é ‚')) msgStyle = stats.msgStyle || 'color: #ffcccc;';
                        percent = 100;
                    } else {
                        statusText = `æœ¬æœˆç´¯ç© $${stats.spend.toLocaleString()}`;
                        percent = 0; 
                    }
                } else {
                    const limit = stats.customLimit || 
                    card.limit;
                    if(limit > 0) percent = (stats.validSpend / limit) * 100;
                    else percent = 0;
                    if (stats.msgDanger) {
                        statusText = stats.msgDanger;
                        if(stats.msgDanger.includes('å·²å°é ‚')) msgStyle = stats.msgStyle || 'color: #ffcccc;';
                    } else if (stats.validSpend <= limit) { 
                        const remain = limit - stats.validSpend;
                        statusText = `å‰© $${remain.toLocaleString()}`;
                        if(remain < 1000) {statusText = `âš ï¸ å‰© $${remain.toLocaleString()}`;
                        msgStyle='color:#FFD700;';} 
                    } else { 
                        percent = 100;
                        statusText = card.msgDanger; msgStyle = 'color: #ffcccc;'; 
                    }
                }
            } else if (card.id === 'c2') {
                percent = (stats.validSpend / 12000) * 100;
                if (stats.validSpend >= 12000) {
                    statusText = 'å·²é”æ¨™ (ä¸‹æœˆå…åœ)';
                    msgStyle = 'color: #38ef7d; font-weight:bold;';
                    percent = 100;
                } else {
                    statusText = `å·® $${(12000 - stats.validSpend).toLocaleString()} äº«å…è²»åœè»Š`;
                    msgStyle = 'color: #FFD700;';
                }
            } else { 
                percent = (stats.validSpend / card.target) * 100;
                statusText = stats.validSpend >= card.target ? 'ä»»å‹™é”æˆ' : `å·® $${(card.target - stats.validSpend).toLocaleString()}`;
            }
            
            let tileClass = 'card-tile';
            let nickClass = 'tile-nickname-badge';
            if (card.type === 'placeholder') nickClass += ' placeholder';
            const tile = document.createElement('div'); tile.className = tileClass;
            tile.setAttribute('data-card-id', card.id);
            tile.style.background = card.gradient;
            tile.style.color = card.textColor; 
            tile.onclick = () => card.type === 'placeholder' ? openManageModal() : openQuickAdd(card.id);
            let earnedText = `+$${stats.reward.toLocaleString()}`;
            if (card.id === 'c9') { earnedText = `+${stats.reward.toLocaleString()} å“©`;
            }
            let cycleHint = '';
            if (stats.isCustom) {
                cycleHint = `<div class="tile-cycle-hint">é€±æœŸ: ${stats.cycleStart.getMonth()+1}/${stats.cycleStart.getDate()}-${stats.cycleEnd.getMonth()+1}/${stats.cycleEnd.getDate()}</div>`;
            }

            tile.innerHTML = `<div class="tile-header"><span class="tile-name">${card.name}</span><span class="rate-badge" style="color:black">${displayRate}</span></div><div class="${nickClass}">${card.nickname}</div><span class="tile-note" style="color:${card.textColor==='white'?'rgba(255,255,255,0.8)':'rgba(0,0,0,0.6)'}">${card.note}</span><div class="tile-body"><div class="tile-stat">$${stats.spend.toLocaleString()}</div><div class="tile-earned">${earnedText}</div></div><div class="tile-footer"><div class="progress-track"><div class="progress-fill" style="width:${Math.min(percent, 100)}%"></div></div><div class="tile-msg" style="${msgStyle}">${statusText}</div>${cycleHint}</div>`;
            container.appendChild(tile);
        });
        checkUrgentTasks(); initSortable();
    }
    
    // [å°ˆå®¶å„ªåŒ–] é›™æ¬„ç¶²æ ¼ + æœå°‹åŠŸèƒ½ç‰ˆ
    function openManageModal() {
        const list = document.getElementById('manageCardList');
        list.innerHTML = '';
        
        // ä¿ç•™åŸæœ‰çš„é‚è¼¯ï¼šåˆ¤æ–·çœŸå¯¦å¡ç‰‡æ•¸é‡
        const realCardIds = ['c6', 'c1', 'c5', 'c3', 'c4', 'c2', 'c7', 'c8', 'c9', 'c10', 'c11', 'j1', 'j2', 'j3', 'j4', 'j5', 'dbs1', 'c12'];
        const currentRealCardsCount = visibleCards.filter(id => realCardIds.includes(id)).length;
        
        // æœå°‹åŠŸèƒ½åˆå§‹åŒ–
        clearCardSearch();
        cards.forEach(card => {
            if (card.id === 'add1') return; // è·³éä½”ä½ç¬¦
            const isVisible = visibleCards.includes(card.id);
            
            // å»ºç«‹å¡ç‰‡æŒ‰éˆ• (Div)
            const btn = document.createElement('div');
            btn.className = `manage-card-btn ${isVisible ? 'active' : ''}`;
        
            
            // é»æ“Šäº‹ä»¶ï¼šåˆ‡æ›é¡¯ç¤º/éš±è—
            btn.onclick = function(e) {
                if (e.target.classList.contains('m-setting-btn')) return; // é»åˆ°è¨­å®šä¸è§¸ç™¼
                
                // æª¢æŸ¥æ˜¯å¦è¶…é8å¼µé™åˆ¶
            
                if (!isVisible && currentRealCardsCount >= 8) { 
                    alert('âš ï¸ æœ€å¤šåªèƒ½é¡¯ç¤º 8 å¼µå¡ç‰‡ï¼Œè«‹å…ˆéš±è—ä¸€å¼µï¼'); 
                    return; 
                }
                toggleCardVisibility(card.id); 
            
            };
            
            // å…§éƒ¨ HTML çµæ§‹
            btn.innerHTML = `
                <div class="m-check-mark">âœ“</div>
                <div class="m-card-name">${card.name}</div>
                <div class="m-card-nick">${card.nickname}</div>
        
              `;
            
            // è¨­å®šæŒ‰éˆ• (é½’è¼ª)
            const settingBtn = document.createElement('div');
            settingBtn.className = 'm-setting-btn';
            settingBtn.innerHTML = 'âš™ï¸';
            settingBtn.onclick = (e) => { 
                e.stopPropagation();
                editCardSettings(card.id); 
            };
            
            btn.appendChild(settingBtn);
            list.appendChild(btn);
        });
        
        document.getElementById('manageModal').style.display = 'flex';
        renderScenes();
    }
    
    // [æ–°å¢] æœå°‹éæ¿¾åŠŸèƒ½
    function filterManageCards() {
        const input = document.getElementById('cardSearchInput');
        const filter = input.value.toLowerCase();
        const btnClear = document.getElementById('btnSearchClear');
        
        // æ§åˆ¶æ¸…é™¤æŒ‰éˆ•é¡¯ç¤º
        btnClear.style.display = filter.length > 0 ? 
        'flex' : 'none';
        
        const cards = document.querySelectorAll('.manage-card-btn');
        cards.forEach(card => {
            const name = card.querySelector('.m-card-name').innerText.toLowerCase();
            const nick = card.querySelector('.m-card-nick').innerText.toLowerCase();
            if (name.includes(filter) || nick.includes(filter)) {
                card.style.display = 'flex';
            } else {
              
               card.style.display = 'none';
            }
        });
    }

    // [æ–°å¢] æ¸…é™¤æœå°‹
    function clearCardSearch() {
        const input = document.getElementById('cardSearchInput');
        if(input) {
            input.value = '';
            filterManageCards();
        }
    }

    function editCardSettings(cardId) {
        const current = cardSettings[cardId] || {};
        const bDay = prompt(
            'è«‹è¼¸å…¥å¸³å–®çµå¸³æ—¥ï¼Œç³»çµ±æœƒè‡ªå‹•ç‚ºæ‚¨è¨ˆç®—å¸³å–®é€±æœŸ \n\n' +
            'ä¾‹å¦‚ï¼šæ¯æœˆ 17 è™Ÿçµå¸³ï¼Œè«‹è¼¸å…¥ 17ã€‚\n' + 
            '(è‹¥ä¸è¼¸å…¥æˆ–è¼¸å…¥ 1ï¼Œé è¨­ç‚ºæ¯æœˆ 1 è™Ÿè‡³æœˆåº•)', 
            current.billingDay || ''
        );
        if (bDay !== null) {
            const dayNum = parseInt(bDay);
            if (!isNaN(dayNum) && dayNum >= 1 && dayNum <= 31) {
                cardSettings[cardId] = { billingDay: dayNum };
            } else {
                delete cardSettings[cardId];
            }
            localStorage.setItem('cardSettings', JSON.stringify(cardSettings));
            renderGrid();
        }
    }
    
    function toggleCardVisibility(cardId) {
        if (visibleCards.includes(cardId)) { visibleCards = visibleCards.filter(id => id !== cardId);
        const realCardsCount = visibleCards.filter(id => id !== 'add1').length; if (realCardsCount < 8 && !visibleCards.includes('add1')) { visibleCards.push('add1');
        } } 
        else { visibleCards.push(cardId);
        if (visibleCards.includes('add1')) { visibleCards = visibleCards.filter(id => id !== 'add1');
        } }
        localStorage.setItem('visibleCards', JSON.stringify(visibleCards)); openManageModal(); renderGrid();
    }

    function openQuickAdd(cardId) {
        const card = cards.find(c => c.id === cardId);
        document.getElementById('modalTitle').innerText = card.name; 
        document.getElementById('modalSubtitle').innerText = card.note;
        
        if (cardId === 'c10') { document.getElementById('modalSubtitle').style.display = 'none'; } else { document.getElementById('modalSubtitle').style.display = 'block';
        }

        document.getElementById('cardIdInput').value = cardId;
        const now = new Date();
        const day = String(now.getDate()).padStart(2, '0');
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const year = now.getFullYear();
        const today = `${year}-${month}-${day}`;
        document.getElementById('dateInput').value = today;
        
        editingId = null;
        document.getElementById('btn-confirm').innerText = "ç¢ºèª";
        document.getElementById('transactionModal').style.display = 'flex';
        const allOptionIds = ['pigRichOptions', 'greenCardOptions', 'uniOptions', 'happyOptions', 'hsbcOptions', 'uniOpenOptions', 'richartOptions', 'fubonJOptions', 'jiheOptions', 'kumamonOptions', 'sinopacCurrencyOptions', 'sinopacMitsuiOptions', 'jiangOptions', 'dbsEcoOptions', 'sinopacJcbOptions'];
        allOptionIds.forEach(id => { document.getElementById(id).style.display = 'none'; });

        if (cardId === 'c6') document.getElementById('pigRichOptions').style.display = 'block';
        if (cardId === 'c2') document.getElementById('greenCardOptions').style.display = 'block';
        if (cardId === 'c7') {
             document.getElementById('uniOptions').style.display = 'block';
            toggleUniUpLogic(); 
        }
        if (cardId === 'c8') document.getElementById('happyOptions').style.display = 'block';
        if (cardId === 'c9') document.getElementById('hsbcOptions').style.display = 'block';
        if (cardId === 'c10') {
            document.getElementById('uniOpenOptions').style.display = 'block';
            const savedState = JSON.parse(localStorage.getItem('uniOpenState') || '{}');
            document.getElementById('checkUniGroup').checked = !!savedState.group;
            document.getElementById('checkUniIcash').checked = !!savedState.icash;
            document.getElementById('checkUniOverseas').checked = !!savedState.overseas;
            initUniBrandGrid();
            if(savedState.brands) {
                const btns = document.querySelectorAll('.brand-btn');
                btns.forEach(btn => { if(savedState.brands.includes(btn.innerText)) btn.classList.add('active'); });
            }
            const count = savedState.brands ? 
            savedState.brands.length : 0;
            updateTaskBonusDisplay(count);
        }
        
        if (cardId === 'c11') {
            document.getElementById('richartOptions').style.display = 'block';
            document.getElementById('rbRichartGeneral').checked = true;
        }

        if (cardId === 'j1') { document.getElementById('fubonJOptions').style.display = 'block'; toggleFubonJGeneral();
        }
        if (cardId === 'j2') { document.getElementById('jiheOptions').style.display = 'block'; toggleJiheLogic();
        }
        if (cardId === 'j3') { document.getElementById('kumamonOptions').style.display = 'block'; toggleKumamonLogic();
        }
        if (cardId === 'j4') { 
            document.getElementById('sinopacCurrencyOptions').style.display = 'block';
            document.querySelector('input[name="currencyType"][value="domestic"]').checked = true;
            const savedLevel = localStorage.getItem('currency_level') || 'low';
            const levelRadio = document.querySelector(`input[name="currencyLevel"][value="${savedLevel}"]`);
            if (levelRadio) levelRadio.checked = true;
            toggleCurrencyLogic();
        }
        if (cardId === 'j5') { document.getElementById('sinopacMitsuiOptions').style.display = 'block';
        }
        
        if (cardId === 'c4') {
            document.getElementById('jiangOptions').style.display = 'block';
            document.querySelector('input[name="jiangMode"][value="base"]').checked = true;
            const today = new Date();
            const expiry = new Date('2026-03-31T23:59:59');
            const travelRow = document.getElementById('jiangTravelRow');
            const travelMsg = document.getElementById('jiangTravelExpMsg');
            const travelCheck = document.getElementById('rbJiangTravel');
            
            if (today > expiry) {
                travelRow.classList.add('expired');
                travelCheck.disabled = true;
                travelCheck.checked = false;
                travelMsg.style.display = 'block';
            } else {
                travelRow.classList.remove('expired');
                travelCheck.disabled = false;
                travelMsg.style.display = 'none';
            }
        }
        
        if (cardId === 'dbs1') {
            document.getElementById('dbsEcoOptions').style.display = 'block';
            // é è¨­å…¨é—œ
            document.getElementById('checkDbsLinePay').checked = false;
            document.getElementById('checkDbsGreen').checked = false;
            document.getElementById('checkDbsForeign').checked = false;
        }

        if (cardId === 'c12') {
            document.getElementById('sinopacJcbOptions').style.display = 'block';
        }

        if (card.parking) { document.getElementById('modalParkingInfo').innerHTML = card.parking;
        document.getElementById('modalParkingInfo').style.display = 'block';
        } else { document.getElementById('modalParkingInfo').style.display = 'none'; }
        
        if (cardId === 'c8') document.getElementById('happyDashboard').style.display = 'block';
        else document.getElementById('happyDashboard').style.display = 'none';

        if (cardId === 'c9') { 
            const savedTier = localStorage.getItem('hsbc_tier') || 'infinite'; 
            document.querySelector(`input[name="hsbcTier"][value="${savedTier}"]`).checked = true; 
            document.getElementById('checkHsbcForeign').checked = false; 
            document.getElementById('hsbcInitialMiles').value = localStorage.getItem('hsbc_initial_miles') || '';
            document.getElementById('hsbcRedeemedMiles').value = localStorage.getItem('hsbc_redeemed_miles') || '';
        }

        document.getElementById('liveRewardCalc').style.display = 'none'; document.getElementById('liveRewardCalc').innerHTML = '';
        
        document.getElementById('amountInput').value = '';
        document.getElementById('noteInput').value = '';
        if (cardId === 'c6') { 
             const isBill = document.getElementById('checkIsBill').checked;
             document.getElementById('labelBaseRate').innerText = isBill ? "ğŸ”° åŸºæœ¬å›é¥‹ 0.15% (ç„¡ä¸Šé™)" : "ğŸ”° åŸºæœ¬å›é¥‹ 1% (ç„¡ä¸Šé™)";
        }
        
        renderModalHistory(cardId);
        if(cardId === 'c8') injectDetails();
        
        setTimeout(() => document.getElementById('amountInput').focus(), 100);
    }
    
    function renderModalHistory(cardId) {
        const list = document.getElementById('modalHistoryList');
        const title = document.getElementById('modalHistoryTitle');
        list.innerHTML = '';
        
        const { start, end } = getBillingCycle(cardId);
        const history = transactions.filter(t => {
            const tDate = new Date(t.date);
            return t.cardId === cardId && tDate >= start && tDate <= end;
        });
        title.innerHTML = `<span>ğŸ“… ${start.getMonth()+1}/${start.getDate()} - ${end.getMonth()+1}/${end.getDate()} æ¶ˆè²»ç´€éŒ„</span><span style="font-weight:normal; font-size:10px; color:#aaa;">(é»æ“Šæ–‡å­—ä¿®æ”¹ / âœ• åˆªé™¤)</span>`;
        history.sort((a, b) => new Date(b.date) - new Date(a.date));

        if (history.length === 0) {
            list.innerHTML = '<div style="text-align:center; color:#ccc; padding:20px; font-size:12px;">æœ¬æœŸå°šç„¡ç´€éŒ„</div>';
            return;
        }

        history.forEach(t => {
            const item = document.createElement('div');
            item.className = 'history-item';
            
            // å„ªåŒ–é»ï¼šå¦‚æœæ²’æœ‰ noteï¼Œå°±çµ¦ç©ºå­—ä¸² (CSS h-name å·²è¨­å®š min-height é˜²æ­¢å¡Œé™·)
            let displayText = t.note || ''; 
            
            let tags = [];
            const isCard = (id) => t.cardId === id;

            if(isCard('c2') && t.isGreen) tags.push('ğŸŒ¿');
            if(isCard('c2') && t.isForeign) tags.push('âœˆï¸');
            
            if(isCard('c7') && t.isUniUp) tags.push('ğŸ†™');
        
            if(isCard('c7') && t.isUniBonus) tags.push('ğŸ”¥');
            
            if(isCard('c8') && t.isHappyPet) tags.push('ğŸ¶');
            if(isCard('c8') && t.isHappyPeace) tags.push('ğŸ½ï¸');
            if(isCard('c8') && t.isHappyLife) tags.push('ğŸ›’');
            if(isCard('c8') && t.isHappyForeign) tags.push('âœˆï¸');
            
          
           if(isCard('c9') && t.isHsbcForeign) tags.push('âœˆï¸');
            
            if(isCard('c10') && t.isUniGroup) tags.push('ğŸª');
            if(isCard('c10') && t.isUniIcash) tags.push('ğŸ“±');
            if(isCard('c10') && t.isUniOverseas) tags.push('âœˆï¸');
            
            if(isCard('c11') && t.isRichartPay) tags.push('ğŸ“±');
            if(isCard('c11') && t.isRichartOnline) tags.push('ğŸ›ï¸');
            if(isCard('c11') && t.isRichartLine) tags.push('ğŸŸ¢');
            if(isCard('c11') && t.isRichartOverseas) tags.push('âœˆï¸');
            
            if(isCard('c6') && t.isBonus10) tags.push('âš¡');
            if(isCard('c6') && t.isBonus25) tags.push('ğŸŒŸ');
            if(isCard('c6') && t.isBill) tags.push('ğŸ§¾');
            // Jå¡ç³»åˆ—
            if(isCard('j1') && t.isFubonJGeneral) tags.push('ğŸ‡¯ğŸ‡µ');
            if(isCard('j1') && t.isFubonJKorea) tags.push('ğŸ›ï¸');
            if(isCard('j1') && t.isFubonJThai) tags.push('ğŸ‡¹ğŸ‡­');
            if(isCard('j1') && t.isFubonJSuica) tags.push('ğŸ');
            // å‰é¶´
            if(isCard('j2') && t.isJiheJapan) tags.push('ğŸ‡¯ğŸ‡µ');
            if(isCard('j2') && t.isJiheApple) tags.push('ğŸ');
            if(isCard('j2') && t.isJiheDomesticJapanese) tags.push('ğŸ‡¹ğŸ‡¼');
            
            // ç†Šæœ¬ç†Š
            if(isCard('j3') && t.isKumamonJapan) tags.push('ğŸ‡¯ğŸ‡µ');
            if(isCard('j3') && t.isKumamonDesignated) tags.push('ğŸ»');
            if(isCard('j3') && t.isKumamonPayPay) tags.push('ğŸ“±');
            
            // å¹£å€
            if(isCard('j4') && t.isSinopacCurrencySelected) tags.push('âœˆï¸');
            // ä¸‰äº•
            if(isCard('j5') && t.isSinopacMitsuiSelected) tags.push('ğŸ½ï¸');
            if(isCard('j5') && t.isSinopacMitsuiTarget) tags.push('ğŸ‡¯ğŸ‡µ');
            
            // å°‡å°‡
            if(isCard('c4') && t.isJiangSelected) tags.push('ğŸ›ï¸');
            if(isCard('c4') && t.isJiangTravel) tags.push('âœˆï¸');
            
            // DBS
            if(isCard('dbs1') && t.isDbsLinePay) tags.push('âš¡');
            if(isCard('dbs1') && t.isDbsGreen) tags.push('ğŸŒ¿');
            if(isCard('dbs1') && t.isDbsForeign) tags.push('âœˆï¸');

            // C12 JCB
            if(isCard('c12') && t.isSinopacJcbForeign) tags.push('âœˆï¸');
            if(isCard('c12') && t.isSinopacJcbJapan) tags.push('ğŸ‡¯ğŸ‡µ'); // æ—¥æœ¬/ç‰¹é¸å…±ç”¨
            if(isCard('c12') && t.isSinopacJcbBonus) tags.push('ğŸ›ï¸'); // å…±ç”¨
            if(isCard('c12') && t.isSinopacJcbQuarterly) tags.push('ğŸ”¥');

            const tagStr = tags.length > 0 ? tags.join('') + ' ' : '';
            item.innerHTML = `
                <div style="flex:1" onclick="loadTransaction(${t.id})">
                    <div class="h-name">${tagStr}${displayText}</div>
                    <div class="h-date">${t.date}</div>
                </div>
                <div style="display:flex; align-items:center;">
   
                    <div class="h-amount" onclick="loadTransaction(${t.id})">$${t.amount.toLocaleString()}</div>
                    <button class="btn-delete-single" onclick="deleteTransaction(${t.id}, event)">âœ•</button>
                </div>
            `;
            list.appendChild(item);
        });
    }

    function deleteTransaction(id, event) {
        event.stopPropagation();
        if(!confirm('ç¢ºå®šè¦åˆªé™¤é€™ç­†ç´€éŒ„å—ï¼Ÿ')) return;
        transactions = transactions.filter(t => t.id !== id);
        localStorage.setItem('transactions', JSON.stringify(transactions));
        
        const cardId = document.getElementById('cardIdInput').value;
        renderGrid();
        renderModalHistory(cardId);
        updateRewardPreview();
    }

    function resetAllData() {
        if(!confirm("âš ï¸ è­¦å‘Šï¼šé€™å°‡åˆªé™¤æ‰€æœ‰è¨˜å¸³è³‡æ–™ä¸”ç„¡æ³•å¾©åŸï¼\nç¢ºå®šè¦é‡ç½®å—ï¼Ÿ")) return;
        localStorage.clear();
        location.reload();
    }
    
    function exportData() {
        const data = {
            transactions: transactions,
            cardSettings: cardSettings,
            visibleCards: visibleCards,
            cardOrder: savedOrder,
            uniOpenState: JSON.parse(localStorage.getItem('uniOpenState') || '{}'),
            
            currencyLevel: localStorage.getItem('currency_level'),
            hsbcTier: localStorage.getItem('hsbc_tier'),
            hsbcInitial: localStorage.getItem('hsbc_initial_miles'),
            hsbcRedeemed: localStorage.getItem('hsbc_redeemed_miles'),
            sceneSnapshots: getScenes() // å‚™ä»½æƒ…å¢ƒå¿«ç…§
        };
        const blob = new Blob([JSON.stringify(data)], {type: "application/json"});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        // æª”åè¨­å®šï¼šå…¨è‹±æ–‡
        a.download = `Backup_Data_${new Date().toISOString().slice(0,10)}.json`;
        a.click();
    }

    function triggerImport() { document.getElementById('fileInput').click(); 
    }
    function importFile(input) {
        const file = input.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const data = JSON.parse(e.target.result);
                if(data.transactions) localStorage.setItem('transactions', JSON.stringify(data.transactions));
                if(data.cardSettings) localStorage.setItem('cardSettings', JSON.stringify(data.cardSettings));
                if(data.visibleCards) localStorage.setItem('visibleCards', JSON.stringify(data.visibleCards));
                if(data.cardOrder) localStorage.setItem('cardOrder', JSON.stringify(data.cardOrder));
                if(data.uniOpenState) localStorage.setItem('uniOpenState', JSON.stringify(data.uniOpenState));
                if(data.currencyLevel) localStorage.setItem('currency_level', data.currencyLevel);
                if(data.hsbcTier) localStorage.setItem('hsbc_tier', data.hsbcTier);
                if(data.hsbcInitial) localStorage.setItem('hsbc_initial_miles', data.hsbcInitial);
                if(data.hsbcRedeemed) localStorage.setItem('hsbc_redeemed_miles', data.hsbcRedeemed);
                if(data.sceneSnapshots) localStorage.setItem('scene_snapshots', JSON.stringify(data.sceneSnapshots));
                
                alert("åŒ¯å…¥æˆåŠŸï¼å³å°‡é‡æ–°æ•´ç†...");
                location.reload();
            } catch(err) {
                alert("æª”æ¡ˆæ ¼å¼éŒ¯èª¤æˆ–ææ¯€");
            }
        };
        reader.readAsText(file);
    }

    function checkUrgentTasks() {
        const alertArea = document.getElementById('urgent-alert-area'), alertList = document.getElementById('urgent-list');
        alertList.innerHTML = ''; let hasUrgent = false;
        cards.forEach(card => {
            if (card.type === 'placeholder') return;
            const stats = calculateStats(card.id); let target = card.type === 'floor' ? card.target : (card.type === 'mixed' ? card.minSpend : 0);
            if (target > 0 && stats.spend < target) {
                const end = new Date(new Date().getFullYear(), new Date().getMonth() 
                + 1, 0), diff = Math.ceil((end - new Date()) / 86400000);
                if (diff <= 3 && diff >= 0) { hasUrgent = true; alertList.innerHTML += `<div class="urgent-item">${card.name} ç¼º $${(target - stats.spend).toLocaleString()} (å‰© ${diff} å¤©)</div>`; }
            }
        });
        alertArea.style.display = hasUrgent ? 'block' : 'none';
    }
    updateDate(); 
  </script>
</body>
</html>

