<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-FMD1PV6QZV"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-FMD1PV6QZV');
    </script>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="åˆ·å¡å›é¥‹ç®¡å®¶">
    <meta name="theme-color" content="#F0F2F5">
    <title>åˆ·å¡å›é¥‹ç®¡å®¶</title>
    
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" sizes="192x192" href="icon-192.png">
    <link rel="icon" type="image/png" sizes="48x48" href="icon-48.png">
    <link rel="shortcut icon" href="icon-48.png">

    <style>
        :root { --bg-color: #F0F2F5; --text-primary: #1C1C1E; --text-secondary: #8E8E93; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif; 
            background-color: #E0E5EC; color: var(--text-primary); margin: 0; 
            display: flex; justify-content: center; 
            min-height: 100vh; 
            -webkit-font-smoothing: antialiased; 
        }
        
        .app-container { 
            width: 100%; 
            max-width: 480px; 
            background-color: var(--bg-color); 
            min-height: 100vh; 
            padding: 16px 12px; 
            padding-top: env(safe-area-inset-top, 20px); 
            padding-bottom: env(safe-area-inset-bottom, 20px); 
            box-shadow: 0 0 40px rgba(0,0,0,0.05); 
            display: flex; flex-direction: column; box-sizing: border-box; 
        }
        @media (max-width: 480px) { body { background-color: var(--bg-color); } .app-container { box-shadow: none; width: 100%; max-width: 100%; } }
        
        .header-top-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2px; width: 100%; }
        .author-top { font-size: 12px; font-weight: 800; color: #007AFF; letter-spacing: 0.5px; }
        
        .version-tag { 
            font-size: 10px; color: #888; font-weight: 600; 
            background: rgba(0,0,0,0.05); padding: 2px 8px; border-radius: 4px; 
            white-space: nowrap; flex-shrink: 0; 
            display: inline-block; min-width: 36px; text-align: center;
        }
        
        .header-section { margin-bottom: 12px; display: flex; justify-content: space-between; align-items: flex-end; }
        h1 { font-size: 22px; font-weight: 800; margin: 0; color: #333; letter-spacing: -0.5px; line-height: 1.2;}
        .subtitle { font-size: 11px; color: var(--text-secondary); font-weight: 500; }
        .today-date { background: rgba(0,0,0,0.05); padding: 2px 6px; border-radius: 4px; font-size: 11px; font-weight: 600; color: #555; margin-left: 5px;}
        
        /* è·‘é¦¬ç‡ˆ */
        .news-ticker {
            background: #FFF9C4; color: #856404; 
            border-radius: 8px; margin-bottom: 12px; 
            height: 36px;
            display: block;
            overflow: hidden; 
            white-space: nowrap; 
            position: relative;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            width: 100%;
            transform: translate3d(0,0,0);
        }
        
        .ticker-content {
            display: inline-block;
            height: 36px;
            line-height: 36px;
            padding-left: 100%; 
            min-width: 100%;
            box-sizing: content-box;
            animation: scroll-left 15s linear infinite;
            will-change: transform;
            transform: translate3d(0, 0, 0);
        }

        @keyframes scroll-left {
            0% { transform: translate3d(0, 0, 0); }
            100% { transform: translate3d(-100%, 0, 0); }
        }

        .total-reward-card { background: #2c3e50; color: white; border-radius: 16px; padding: 14px 20px; margin-bottom: 16px; display: flex; justify-content: space-between; align-items: center; position: relative; overflow: hidden; box-shadow: 0 4px 10px rgba(44, 62, 80, 0.2); }
        .total-reward-card::after { content: ''; position: absolute; top: -50%; right: -50%; width: 150px; height: 150px; background: rgba(255,255,255,0.1); border-radius: 50%; pointer-events: none; }
        .total-reward-label { font-size: 13px; font-weight: 600; opacity: 0.9; }
        .total-reward-amount { font-size: 28px; font-weight: 700; letter-spacing: -0.5px; }

        #urgent-alert-area { display: none; margin-bottom: 12px; }
        .urgent-card { background: linear-gradient(135deg, #FF3B30, #FF2D55); color: white; border-radius: 12px; padding: 10px 14px; box-shadow: 0 4px 10px rgba(255, 59, 48, 0.25); animation: pulse 2s infinite; }
        .urgent-title { font-size: 13px; font-weight: 800; display: flex; align-items: center; gap: 6px; }
        .urgent-item { background: rgba(255,255,255,0.25); border-radius: 8px; padding: 6px 10px; margin-top: 6px; font-size: 12px; font-weight: 600; line-height: 1.3; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.01); } 100% { transform: scale(1); } }

        #card-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 20px; flex: 1; align-content: start;}

        /* å¡ç‰‡æ¨£å¼ */
        .card-tile { 
            border-radius: 16px; padding: 12px; min-height: 135px; 
            display: flex; flex-direction: column; justify-content: space-between; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.1); position: relative; 
            transition: transform 0.1s; cursor: pointer; color: white; overflow: hidden; 
            user-select: none; -webkit-user-select: none;
            touch-action: pan-y; 
        }
        .card-tile:active { transform: scale(0.97); }
        .sortable-ghost { opacity: 0.4; transform: scale(0.95); }
        .sortable-drag { cursor: grabbing; }

        .tile-header { display: flex; justify-content: space-between; align-items: flex-start; z-index: 2; margin-bottom: 2px;}
        .tile-name { font-size: 15px; font-weight: 800; line-height: 1.2; text-shadow: 0 1px 2px rgba(0,0,0,0.15); }
        
        .tile-nickname-badge {
            display: inline-block;
            font-size: 10px;
            font-weight: 800;
            background: rgba(0,0,0,0.2); 
            color: #FFD700; 
            padding: 2px 6px;
            border-radius: 4px;
            margin-bottom: 4px;
            z-index: 2;
            width: fit-content;
        }
        
        .tile-nickname-badge.placeholder { background: rgba(0,0,0,0.1); color: #aaa; }

        .tile-note { font-size: 10px; font-weight: 500; opacity: 0.9; margin-bottom: 4px; display: block; line-height: 1.2; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; z-index: 2; letter-spacing: -0.2px; }
        .tile-rule { font-size: 10px; font-weight: 700; background: rgba(0,0,0,0.25); padding: 2px 6px; border-radius: 4px; display: inline-block; margin-bottom: 6px; color: #FFD700; z-index: 2; }
        .rate-badge { background: rgba(255,255,255,0.3); font-size: 10px; font-weight: 800; padding: 2px 5px; border-radius: 5px; white-space: nowrap; backdrop-filter: blur(4px); margin-left: 2px; flex-shrink: 0; }
        .tile-body { z-index: 2; flex:1; display:flex; flex-direction:column; justify-content:center; }
        .tile-stat { font-size: 20px; font-weight: 700; letter-spacing: -0.5px; margin-bottom: 2px;}
        .tile-earned { font-size: 11px; font-weight: 600; color: rgba(255,255,255,0.95); display: flex; align-items: center; gap: 3px;}
        .tile-earned::before { content: 'è³º'; font-size: 9px; opacity: 0.8; border: 1px solid rgba(255,255,255,0.7); padding: 0 2px; border-radius: 3px;}
        .tile-footer { z-index: 2; margin-top: 6px; position: relative; }
        .progress-track { background: rgba(0,0,0,0.2); height: 4px; border-radius: 2px; overflow: hidden; margin-bottom: 4px; }
        .progress-fill { height: 100%; background: rgba(255,255,255,0.95); transition: width 0.5s ease; }
        .tile-msg { font-size: 11px; font-weight: 700; opacity: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; line-height: 1.2; }

        .history-section { flex: 1; display: flex; flex-direction: column; }
        .history-title { font-size: 14px; font-weight: 700; margin-bottom: 8px; color: #555; }
        
        .settings-area { margin-top: auto; display: flex; gap: 8px; flex-direction: column; padding-top: 20px;}
        .settings-row { display: flex; gap: 8px; }
        .btn-tool { flex: 1; padding: 10px; border-radius: 10px; font-size: 12px; font-weight: 600; border: 1px solid #eee; background: white; color: #555; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 4px; box-shadow: 0 1px 3px rgba(0,0,0,0.05);}
        .btn-donate { background: linear-gradient(135deg, #E30000, #FF5050); color: #fff; border: none; box-shadow: 0 4px 10px rgba(227, 0, 0, 0.3); font-size: 14px; }
        .btn-reset-visible { width: 100%; padding: 12px; background-color: #fff5f5; border: 1px solid #ffdede; color: #FF3B30; border-radius: 12px; font-weight: 600; font-size: 12px; cursor: pointer; margin-top: 10px;}
        
        /* ç®¡ç†å¡ç‰‡æŒ‰éˆ• - å•Ÿç”¨ */
        .btn-manage { background: #333; color: white; border: none; box-shadow: 0 2px 8px rgba(0,0,0,0.2); }

        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); backdrop-filter: blur(3px); z-index: 1000; align-items: center; justify-content: center; }
        .modal-content { 
            background: white; width: 85%; max-width: 320px; border-radius: 20px; padding: 20px; 
            box-shadow: 0 25px 50px rgba(0,0,0,0.25); animation: modalPop 0.2s; 
            display: flex; flex-direction: column;
            max-height: 85vh; /* é™åˆ¶é«˜åº¦ */
            overflow-y: auto; /* å…è¨±æ•´å€‹å½ˆçª—æ²å‹• */
        }
        
        /* å½ˆçª—å…§å®¹å€å¡Šï¼šè¼¸å…¥èˆ‡é¸é … */
        .modal-body-input {
            flex-shrink: 0; /* ä¸å£“ç¸®é€™å€ */
        }

        .input-group label { display: block; font-size: 12px; font-weight: 600; color: #888; margin-bottom: 6px; margin-top: 10px; }
        input { width: 100%; padding: 10px; border: 2px solid #f0f0f0; background: #fff; border-radius: 12px; font-size: 18px; box-sizing: border-box; outline: none; font-weight: 600; color: #333; }
        
        /* æ–°å¢ï¼šæ—¥æœŸé¸æ“‡å™¨æ¨£å¼ */
        input[type="date"] { font-family: inherit; font-size: 14px; padding: 8px; color:#555;}

        .btn-group { display: flex; gap: 8px; margin-top: 20px; flex-shrink: 0; }
        .btn { flex: 1; padding: 10px; border: none; border-radius: 12px; font-size: 15px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center;}
        .btn-cancel { background: #f5f5f5; color: #333; }
        .btn-confirm { background: #007AFF; color: white; flex: 2; } /* ç¢ºèªæŒ‰éˆ•å¤§ä¸€é» */
        .btn-again { background: #E3F2FD; color: #007AFF; border: 1px solid #b3e5fc; } /* å†è¨˜ä¸€ç­†æŒ‰éˆ• */
        
        /* å³æ™‚è©¦ç®—é¡¯ç¤º (é¡¯çœ¼è—è‰²æ–¹å¡Š) */
        #liveRewardCalc { 
            text-align: center; font-size: 16px; color: #0056b3; font-weight: 700; margin-top: 12px; min-height: 20px; background: #E3F2FD; padding: 8px; border-radius: 8px; display: none; 
        }
        
        /* å½ˆçª—å…§çš„æ­·å²æ˜ç´° (è‡ªå‹•é•·é«˜ï¼Œå¯æ²å‹•) */
        .modal-history-section {
            margin-top: 15px;
            border-top: 2px solid #f0f0f0;
            padding-top: 10px;
            height: auto; overflow: visible;
        }
        .modal-history-title { 
            font-size: 12px; font-weight: 700; color: #555; margin-bottom: 8px; 
            display: flex; justify-content: space-between; align-items: center;
        }
        
        /* æ­·å²é …ç›®æ¨£å¼ */
        .history-item { 
            padding: 10px 0; 
            border-bottom: 1px solid #f9f9f9; 
            display: flex; justify-content: space-between; align-items: center; font-size: 12px; 
        }
        .history-item:last-child { border-bottom: none; }
        .h-name { font-weight: 600; color: #555; }
        .h-date { font-size: 10px; color: #aaa; margin-top: 2px;}
        .h-amount { font-weight: 700; color: #333; font-size: 13px; }
        
        /* æŒ‰éˆ•å€ */
        .item-actions { display: flex; gap: 4px; }
        .btn-icon { background: none; border: none; font-size: 14px; padding: 4px; cursor: pointer; display: flex; align-items: center; justify-content: center; width: 24px; height: 24px; border-radius: 50%; }
        .btn-edit { color: #007AFF; background-color: #E3F2FD; }
        .btn-delete { color: #FF3B30; background-color: #FFF0F0; }

        /* é¸é …é–‹é—œå€ */
        #pigRichOptions, #greenCardOptions, #uniOptions, #happyOptions, #hsbcOptions, #ctbcOptions {
            display: none; background: #f9f9f9; padding: 10px; border-radius: 10px; margin-top: 10px; border: 1px dashed #ddd;
        }
        .option-row {
            display: flex; align-items: center; justify-content: space-between; margin-bottom: 6px; font-size: 13px; font-weight: 600; color: #555;
        }
        .option-row input[type="checkbox"], .option-row input[type="radio"], .option-row input[type="number"] { margin: 0; }
        .option-row input[type="checkbox"], .option-row input[type="radio"] { width: 20px; height: 20px; }
        .option-row.read-only { opacity: 0.8; pointer-events: none; }
        .option-row.read-only input { opacity: 0.6; }
        
        /* å“ç‰Œé¸æ“‡æ¸…å–® (CTBC Uniopen) */
        .brand-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 8px; }
        .brand-item {
            display: flex; align-items: center; gap: 6px; font-size: 12px; color: #555;
            background: white; padding: 6px; border-radius: 6px; border: 1px solid #eee;
        }
        /* å·²è¸©é»çš„æ¨£å¼ (ç°è‰²+ç©¿é€) */
        .brand-item.visited {
            background: #f0f0f0; color: #999; border-color: #ddd;
        }
        
        /* ç®¡ç†å¡ç‰‡åˆ—è¡¨æ¨£å¼ (iOS é¢¨æ ¼å„ªåŒ–) */
        .manage-item {
            display: flex; align-items: center; justify-content: space-between;
            padding: 16px 12px; /* å¢åŠ é»æ“Šå€åŸŸ */
            border-bottom: 1px solid #f0f0f0;
            background: #fff;
            cursor: pointer;
            transition: background 0.2s;
        }
        .manage-item:active { background: #f9f9f9; }
        .manage-info { display: flex; flex-direction: column; gap: 4px; }
        .manage-name { font-size: 15px; font-weight: 700; color: #333; }
        .manage-desc { font-size: 12px; color: #999; }
        
        /* iOS é¢¨æ ¼ Toggle Switch */
        .switch {
            position: relative;
            display: inline-block;
            width: 44px;
            height: 24px;
            flex-shrink: 0;
        }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 2px;
            bottom: 2px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        input:checked + .slider {
            background-color: #34C759; /* iOS Green */
        }
        input:checked + .slider:before {
            transform: translateX(20px);
        }

        .happy-dashboard {
            background: #fff0f5; border: 1px solid #ffd1dc; border-radius: 10px; padding: 10px; margin-top: 10px; display: none;
        }
        .dash-row { margin-bottom: 8px; }
        .dash-label { font-size: 12px; font-weight: 700; color: #555; display: flex; justify-content: space-between; margin-bottom: 2px;}
        .dash-bar-bg { background: #eee; height: 6px; border-radius: 3px; overflow: hidden; }
        .dash-bar-fill { height: 100%; background: #4cd964; transition: width 0.3s; }
        .dash-bar-fill.danger { background: #ff3b30; }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="header-top-row">
            <div class="author-top">Designed by Shawn</div>
            <div class="version-tag" id="top-version-tag">V125.0</div>
        </div>

        <div class="header-section">
            <h1>åˆ·å¡å›é¥‹ç®¡å®¶</h1>
            <div class="subtitle"><span class="today-date" id="dateDisplay"></span></div>
        </div>

        <div class="news-ticker">
            <div class="ticker-content" id="news-text">ğŸ‰ æ­¡è¿ä½¿ç”¨åˆ·å¡å›é¥‹ç®¡å®¶ï¼ç³»çµ±å°‡è‡ªå‹•è¨ˆç®—æ‚¨çš„æœ€ä½³åˆ·å¡çµ„åˆã€‚</div>
        </div>

        <div id="urgent-alert-area"><div class="urgent-card"><div class="urgent-title">ğŸš¨ ä»»å‹™åˆ°æœŸè­¦å ±</div><div id="urgent-list"></div></div></div>
        
        <div class="total-reward-card">
            <span class="total-reward-label">æœ¬æœˆç¸½å›é¥‹é ä¼°</span>
            <span class="total-reward-amount" id="totalRewardDisplay">$0</span>
        </div>
        
        <div id="card-grid"></div>

        <div style="flex:1;"></div>
        
        <div class="settings-area">
            <div class="settings-row">
                <button class="btn-tool btn-manage" onclick="openManageModal()">ğŸ’³ ç®¡ç†æˆ‘çš„å¡ç‰‡</button>
            </div>
            
            <div class="settings-row">
                <button class="btn-tool" style="background: linear-gradient(45deg, #f09433 0%, #e6683c 25%, #dc2743 50%, #cc2366 75%, #bc1888 100%); color: white; border: none; font-weight: bold; box-shadow: 0 4px 10px rgba(220, 39, 67, 0.3);" onclick="window.open('https://www.instagram.com/pocket_lab_tw/', '_blank')">
                    ğŸ“¸ è¿½è¹¤å£è¢‹å¯¦é©—å®¤ (IG)
                </button>
            </div>
            
            <div class="settings-row">
                <button class="btn-tool" onclick="exportData()">ğŸ’¾ å‚™ä»½æª”æ¡ˆ</button>
                <button class="btn-tool" onclick="triggerImport()">ğŸ“¥ è®€æª”é‚„åŸ</button>
                <input type="file" id="fileInput" style="display:none" accept=".json, .txt" onchange="importFile(this)">
            </div>
            <button class="btn-reset-visible" onclick="resetAllData()">ğŸ—‘ï¸ é‡ç½®æ‰€æœ‰è³‡æ–™</button>
            </div>
        
        <div style="height:20px;"></div> </div>

    <div id="transactionModal" class="modal" onclick="if(event.target===this) closeModal()">
        <div class="modal-content">
            <div class="modal-body-input">
                <h2 id="modalTitle" style="margin: 0 0 4px 0; font-size: 18px; font-weight: 800; color:#333;"></h2>
                <div style="font-size:12px; color:#888; margin-bottom:10px; font-weight: 500;" id="modalSubtitle"></div>
                
                <div id="modalParkingInfo" style="background:#FFF9C4; color:#856404; padding:10px; border-radius:10px; font-size:12px; margin-bottom:12px; border-left:4px solid #FFC107; display:none; line-height:1.5;"></div>
                
                <input type="hidden" id="cardIdInput"> 
                
                <div class="input-group" style="margin-bottom:8px;">
                    <input type="date" id="customDateInput">
                </div>
                
                <div class="input-group" style="margin-top:0;">
                    <input type="number" id="amountInput" placeholder="$ é‡‘é¡" inputmode="numeric" style="font-size:28px; text-align:center; border:none; border-bottom:2px solid #eee; border-radius:0;" 
                           oninput="updateRewardPreview()" onkeyup="updateRewardPreview()" onpaste="updateRewardPreview()">
                </div>
                
                <div id="pigRichOptions">
                    <div class="option-row read-only">
                        <label id="labelBaseRate">ğŸ”° åŸºæœ¬å›é¥‹ 1% (ç„¡ä¸Šé™)</label>
                        <input type="checkbox" checked disabled>
                    </div>
                    <div class="option-row">
                        <label for="checkBonus10">âš¡ æ–°æˆ¶åŠ ç¢¼10% (é™åˆ·$8000)</label>
                        <input type="checkbox" id="checkBonus10" checked onchange="updateRewardPreview()">
                    </div>
                    <div class="option-row">
                        <label for="checkBonus25">ğŸŒŸ ç²¾é¸é€šè·¯2.5% (è¶…å•†/ç™¾è²¨)</label>
                        <input type="checkbox" id="checkBonus25" checked onchange="toggleSelectedLogic()">
                    </div>
                    <div class="option-row" style="margin-bottom:0; border-top:1px dashed #ddd; padding-top:6px;">
                        <label for="checkIsBill">ğŸ§¾ APPç¹³è²» (åº•1%â†’0.15%)</label>
                        <input type="checkbox" id="checkIsBill" onchange="toggleBillLogic()">
                    </div>
                </div>

                <div id="greenCardOptions">
                    <div class="option-row" style="margin-bottom:0;">
                        <label for="checkGreenChannel">ğŸŒ¿ ç¶ è‰²é€šè·¯ (6% é™åˆ·$2500)</label>
                        <input type="checkbox" id="checkGreenChannel" onchange="toggleGreenLogic()">
                    </div>
                    <div class="option-row" style="margin-top:6px; border-top:1px dashed #ddd; padding-top:6px; margin-bottom:0;">
                        <label for="checkForeign">âœˆï¸ åœ‹å¤–æ¶ˆè²» (2% ç„¡ä¸Šé™)</label>
                        <input type="checkbox" id="checkForeign" onchange="toggleForeignLogic()">
                    </div>
                </div>

                <div id="uniOptions">
                    <div class="option-row">
                        <label for="checkUniUp">ğŸ†™ è¨‚é–± UP é¸ (4.5% é™åˆ·14è¬)</label>
                        <input type="checkbox" id="checkUniUp" onchange="updateRewardPreview()">
                    </div>
                    <div class="option-row" style="margin-top:6px; border-top:1px dashed #ddd; padding-top:6px; margin-bottom:0;">
                        <label for="checkUniBonus">ğŸ”¥ çµ±ä¸€æ™‚ä»£ä»»å‹™ (+3% é™åˆ·1.6è¬)</label>
                        <input type="checkbox" id="checkUniBonus" onchange="updateRewardPreview()">
                    </div>
                </div>

                <div id="happyOptions">
                     <div class="option-row">
                        <label for="checkHappyPet">ğŸ¶ å¯µç‰©é€šè·¯ (10% åˆ·$5263)</label>
                        <input type="checkbox" id="checkHappyPet" onchange="toggleHappyPet()">
                    </div>
                    <div class="option-row">
                        <label for="checkHappyPeace">ğŸ½ï¸ å¤§å°å®‰å¿ƒåˆ· (4% åˆ·$5714)</label>
                        <input type="checkbox" id="checkHappyPeace" onchange="toggleHappyPeace()">
                    </div>
                    <div class="option-row">
                        <label for="checkHappyLife">ğŸ›’ ç”Ÿæ´»ç¦®é‡ (4% åˆ·$5714)</label>
                        <input type="checkbox" id="checkHappyLife" onchange="toggleHappyLife()">
                    </div>
                     <div class="option-row" style="margin-top:6px; border-top:1px dashed #ddd; padding-top:6px; margin-bottom:0;">
                        <label for="checkHappyForeign">âœˆï¸ åœ‹å¤–æ¶ˆè²» (2.5% ç„¡ä¸Šé™)</label>
                        <input type="checkbox" id="checkHappyForeign" onchange="toggleHappyForeign()">
                    </div>
                    
                    <div id="happyDashboard" class="happy-dashboard">
                        </div>
                </div>

                <div id="hsbcOptions">
                     <div class="option-row" style="border-bottom:1px solid #eee; padding-bottom:10px; margin-bottom:10px;">
                        <span style="font-weight:700; color:#333;">ğŸ’³ é¸æ“‡æ‚¨çš„å¡ç‰‡ç­‰ç´š (è‡ªå‹•è¨˜æ†¶)ï¼š</span>
                        <div style="display:flex; gap:15px; margin-top:8px;">
                            <label style="display:flex; align-items:center; font-weight:normal; font-size:13px;">
                                <input type="radio" name="hsbcTier" value="infinite" onchange="saveHsbcTier()"> ç„¡é™å¡
                            </label>
                            <label style="display:flex; align-items:center; font-weight:normal; font-size:13px;">
                                <input type="radio" name="hsbcTier" value="signature" onchange="saveHsbcTier()"> å¾¡ç’½å¡
                            </label>
                        </div>
                    </div>
                    <div class="option-row">
                        <label for="hsbcInitialMiles">ğŸ å·²æœ‰å“©ç¨‹ (èµ·å§‹å€¼)</label>
                        <input type="number" id="hsbcInitialMiles" onchange="saveHsbcInitial()" style="text-align:right; width: 100px; border:1px solid #ccc; border-radius:4px; padding:4px;" placeholder="0">
                    </div>
                     <div class="option-row">
                        <label for="checkHsbcForeign">âœˆï¸ åœ‹å¤–æ¶ˆè²»</label>
                        <input type="checkbox" id="checkHsbcForeign" onchange="updateRewardPreview()">
                    </div>
                </div>
                
                <div id="ctbcOptions">
                    <div class="option-row" style="border-bottom:1px solid #eee; padding-bottom:10px; margin-bottom:10px;">
                        <span style="font-weight:700; color:#333;">ğŸ“ æ¶ˆè²»å ´æ™¯ (äºŒé¸ä¸€)ï¼š</span>
                        <div style="display:flex; flex-direction:column; gap:8px; margin-top:8px;">
                            <label style="display:flex; align-items:center; font-weight:normal; font-size:13px;">
                                <input type="radio" name="ctbcScene" value="normal" onchange="toggleCtbcScene()"> ä¸€èˆ¬ / å…¶ä»– (1%)
                            </label>
                            <label style="display:flex; align-items:center; font-weight:normal; font-size:13px;">
                                <input type="radio" name="ctbcScene" value="foreign" onchange="toggleCtbcScene()"> âœˆï¸ åœ‹å¤–å¯¦é«” (11%)
                            </label>
                            <label style="display:flex; align-items:center; font-weight:normal; font-size:13px;">
                                <input type="radio" name="ctbcScene" value="unified" onchange="toggleCtbcScene()"> ğŸª çµ±ä¸€é›†åœ˜ (å«å®¶æ¨‚ç¦)
                            </label>
                        </div>
                    </div>
                    
                    <div id="ctbcUnifiedZone" style="display:none;">
                        <div class="option-row">
                            <label for="checkCtbcIcash">ğŸ“± ä½¿ç”¨ icash Pay (+4%)</label>
                            <input type="checkbox" id="checkCtbcIcash" onchange="updateRewardPreview()">
                        </div>
                        
                        <div style="margin-top:10px;">
                            <label style="font-size:12px; font-weight:600; color:#555;">
                                ğŸ”¢ æœ¬æœˆå·²è¸©é»å“ç‰Œ <span id="ctbcBrandStatus" style="color:#007AFF; font-weight:bold; margin-left:5px;">(0å®¶ / +0%)</span>ï¼š
                            </label>
                            <div class="brand-grid">
                                <label class="brand-item"><input type="checkbox" class="ctbc-brand" value="711" onchange="updateRewardPreview()"> 7-ELEVEN</label>
                                <label class="brand-item"><input type="checkbox" class="ctbc-brand" value="starbucks" onchange="updateRewardPreview()"> æ˜Ÿå·´å…‹</label>
                                <label class="brand-item"><input type="checkbox" class="ctbc-brand" value="cosmed" onchange="updateRewardPreview()"> åº·æ˜¯ç¾</label>
                                <label class="brand-item"><input type="checkbox" class="ctbc-brand" value="gas" onchange="updateRewardPreview()"> é€Ÿé‚æ¨‚åŠ æ²¹</label>
                                <label class="brand-item"><input type="checkbox" class="ctbc-brand" value="dept" onchange="updateRewardPreview()"> çµ±ä¸€/å¤¢æ™‚ä»£</label>
                                <label class="brand-item"><input type="checkbox" class="ctbc-brand" value="organic" onchange="updateRewardPreview()"> è–å¾·ç§‘æ–¯</label>
                                <label class="brand-item"><input type="checkbox" class="ctbc-brand" value="books" onchange="updateRewardPreview()"> åšå®¢ä¾†</label>
                                <label class="brand-item"><input type="checkbox" class="ctbc-brand" value="carrefour" onchange="updateRewardPreview()"> å®¶æ¨‚ç¦</label>
                                <label class="brand-item"><input type="checkbox" class="ctbc-brand" value="other" onchange="updateRewardPreview()"> å…¶ä»–å“ç‰Œ</label>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="liveRewardCalc"></div>

                <div class="input-group"><input type="text" id="noteInput" placeholder="å‚™è¨» (ä¾‹å¦‚: åˆé¤)"></div>
                <div class="btn-group">
                    <button class="btn btn-cancel" onclick="closeModal()">å–æ¶ˆ</button>
                    <button class="btn btn-again" onclick="addTransaction(false)">ğŸ”„ å†è¨˜ä¸€ç­†</button>
                    <button class="btn btn-confirm" onclick="addTransaction(true)">ç¢ºèª</button>
                </div>
            </div>

            <div class="modal-history-section">
                <div class="modal-history-title" id="modalHistoryTitle">
                    <span>ğŸ“… æœ¬æœˆæ¶ˆè²»ç´€éŒ„</span>
                    <span style="font-weight:normal; font-size:10px; color:#aaa;">(ç·¨è¼¯/åˆªé™¤)</span>
                </div>
                <div id="modalHistoryList"></div>
            </div>
        </div>
    </div>

    <div id="manageModal" class="modal" onclick="if(event.target===this) document.getElementById('manageModal').style.display='none'">
        <div class="modal-content" style="max-height:80vh; overflow-y:auto;">
            <h2 style="margin: 0 0 4px 0; font-size: 18px; font-weight: 800; color:#333;">ç®¡ç†æˆ‘çš„å¡ç‰‡</h2>
            <div style="font-size:12px; color:#888; margin-bottom:12px;">é–‹å•Ÿ / éš±è—æ‚¨çš„å¡ç‰‡ (å³æ™‚ç”Ÿæ•ˆ)</div>
            <div id="manageCardList" style="border-top:1px solid #eee;"></div>
            <button class="btn btn-confirm" style="width:100%; margin-top:20px;" onclick="document.getElementById('manageModal').style.display='none'">å®Œæˆ</button>
        </div>
    </div>

    <script>
    // ç¨ç«‹è·‘é¦¬ç‡ˆæ§åˆ¶ (ä¿ç•™ fetch æ©Ÿåˆ¶)
    fetch('config.json?t=' + Date.now())
        .then(response => response.json())
        .then(data => {
            if(data.news) document.getElementById('news-text').innerHTML = data.news;
        })
        .catch(error => {
            // è®€å–å¤±æ•—æ™‚ä¿ç•™ HTML è£¡çš„é è¨­æ–‡å­—ï¼Œä¸éœ€åšä»»ä½•äº‹
        });

    window.addEventListener('load', () => {
        setTimeout(() => {
            const ticker = document.querySelector('.ticker-content');
            if(ticker) {
                ticker.style.animation = 'none';
                void ticker.offsetWidth; 
                ticker.style.animation = 'scroll-left 15s linear infinite';
            }
        }, 100);
        
        // ğŸš€ åˆå§‹åŒ–æ™‚ï¼Œå¼·åˆ¶åŸ·è¡Œ 8 å¼µå¡ç‰‡éµå¾‹
        let currentCards = JSON.parse(localStorage.getItem('visibleCards')) || [];
        const realCardIds = ['c6', 'c1', 'c5', 'c3', 'c4', 'c2', 'c7', 'c8', 'c9', 'c10'];
        let realCards = currentCards.filter(id => realCardIds.includes(id));
        
        if (realCards.length > 8) {
            realCards = realCards.slice(0, 8); 
            localStorage.setItem('visibleCards', JSON.stringify(realCards)); 
        }
        
        if (realCards.length < 8) {
            if (!currentCards.includes('add1')) {
                realCards.push('add1');
                localStorage.setItem('visibleCards', JSON.stringify(realCards));
            }
        } else {
             if (currentCards.includes('add1')) {
                 localStorage.setItem('visibleCards', JSON.stringify(realCards));
             }
        }
        
        visibleCards = JSON.parse(localStorage.getItem('visibleCards'));
        renderGrid();
    });

    window.addEventListener('popstate', function(event) {
        document.getElementById('transactionModal').style.display = 'none';
        document.getElementById('manageModal').style.display = 'none';
    });

    const defaultCards = [
        { 
            id: 'c6', name: 'å°æ–°è¡—å£è±¬å¯Œå¡', nickname: 'è¡Œæ”¯/ç¹³è²»ç¥å¡', note: 'ç™¾è²¨ / è¶…å•† / æµ·å¤– / è¡—å£ (åˆ· $8,000 å°é ‚)', rule: '', 
            type: 'ceiling', limit: 8000, tier1Rate: 0.135, tier2Rate: 0.035, 
            gradient: 'linear-gradient(135deg, #e60012 0%, #FFD700 100%)', 
            textColor: 'white', msgDanger: 'å·²å°é ‚ (è®Š3.5%)',
            parking: `... (ç•¥) ...`
        },
        { 
            id: 'c1', name: 'æ˜Ÿå±•å‚³èªªå°æ±ºå¡', nickname: 'Line Payç¥å¡', note: 'LinePay / è¦çš® / å¤–é€ (åˆ· $11,363 å°é ‚)', rule: '', 
            type: 'ceiling', limit: 11363, tier1Rate: 0.10, tier2Rate: 0.012, 
            gradient: 'linear-gradient(135deg, #FF416C 0%, #FF4B2B 100%)', textColor: 'white', msgDanger: 'å·²å°é ‚ (è®Š1.2%)' 
        },
        { 
            id: 'c5', name: 'è¯é‚¦è³´é»å¡', nickname: 'Line Payå„ªç­‰ç”Ÿ', note: 'Line Pay / å¶æ•¸æ—¥æŒ‡å®šé€šè·¯ (åˆ· $3,000 å°é ‚)', rule: 'âš ï¸ å–®ç­†éœ€æ»¿$100', 
            type: 'ceiling', limit: 3000, tier1Rate: 0.06, tier2Rate: 0.01, 
            threshold: 100,
            gradient: 'linear-gradient(135deg, #00B900 0%, #33CC33 100%)', textColor: 'white', msgDanger: 'å·²å°é ‚ (è®Š1%)',
            parking: `... (ç•¥) ...`
        },
        { 
            id: 'c3', name: 'æ°¸è± Sport å¡', nickname: 'Apple Payå„ªç­‰ç”Ÿ', note: 'Apple Pay 5% (åˆ· $5,000 å°é ‚)', rule: '', 
            type: 'ceiling', limit: 5000, tier1Rate: 0.05, tier2Rate: 0.02, 
            gradient: 'linear-gradient(135deg, #00B4DB 0%, #0083B0 100%)', textColor: 'white', msgDanger: 'å·²å°é ‚ (è®Š1%)' 
        },
        { 
            id: 'c4', name: 'å°‡ä¾†å°‡å°‡å¡', nickname: 'è¡Œæ”¯æ³›ç”¨', note: 'è¡Œå‹•æ”¯ä»˜ / å¤–é€ (åˆ· $6,666 å°é ‚)', rule: '', 
            type: 'mixed', limit: 6666, minSpend: 3000, tier1Rate: 0.05, tier2Rate: 0.005, 
            gradient: 'linear-gradient(135deg, #FDC830 0%, #F37335 100%)', textColor: '#333', msgDanger: 'å·²å°é ‚ (è®Š0.5%)',
            parking: `... (ç•¥) ...`
        },
        { 
            id: 'c2', name: 'è¯é‚¦ç¶ å¡', nickname: 'å…è²»å¸‚å€åœè»Š', note: 'åœ‹å…§1% / åœ‹å¤–2% / ç¶ è‰²6% (ä½æ¶ˆ$12000)', rule: '', 
            type: 'floor', target: 12000, tier1Rate: 0.02, tier2Rate: 0.02, 
            gradient: 'linear-gradient(135deg, #11998e 0%, #38ef7d 100%)', textColor: 'white', msgSuccess: 'å·²é”æ¨™ (å…åœ)',
            parking: `... (ç•¥) ...`
        },
        {
            id: 'c7', name: 'ç‰å±± UNI å¡', nickname: 'è¡Œæ”¯å„ªç­‰ç”Ÿ', note: 'ä»»æ„3.5% / UP 4.5% (åˆ· 4~14è¬ å°é ‚)',
            type: 'ceiling', limit: 40000, tier1Rate: 0.035, tier2Rate: 0.01,
            gradient: 'linear-gradient(135deg, #a18cd1 0%, #fbc2eb 100%)',
            textColor: 'white', msgDanger: 'å·²å°é ‚ (è®Š1%)',
            parking: `... (ç•¥) ...`
        },
        {
            id: 'c8', name: 'é æ±æ¨‚å®¶+å¡', nickname: 'ç”Ÿæ´»/å¯µç‰©ç¥å¡', note: 'å¯µç‰©10% / ç”Ÿæ´»4% / åœ‹å¤–2.5% (éœ€ä¸€èˆ¬æ¶ˆè²»æ»¿3åƒ)',
            type: 'ceiling', limit: 5263, tier1Rate: 0.1, tier2Rate: 0.005,
            gradient: 'linear-gradient(135deg, #ff9a9e 0%, #fecfef 99%, #fecfef 100%)',
            textColor: 'white', msgDanger: 'å·²å°é ‚ (è®Š0.5%)',
            parking: `... (ç•¥) ...`
        },
        { 
            id: 'c9', name: 'åŒ¯è±æ—…äººå¡', nickname: 'å“©ç¨‹ç´¯ç©', note: 'ç„¡é™:åœ‹å…§18/åœ‹å¤–10 | å¾¡ç’½:åœ‹å…§18/åœ‹å¤–15', 
            type: 'miles',
            gradient: 'linear-gradient(135deg, #1e3c72 0%, #2a5298 100%)', 
            textColor: 'white', msgDanger: '',
            parking: `... (ç•¥) ...`
        },
        // æ–°å¢ï¼šä¸­ä¿¡ Uniopen å¡
        {
            id: 'c10', name: 'ä¸­ä¿¡ Uniopen å¡', nickname: 'çµ±ä¸€é›†åœ˜ç¥å¡', note: 'çµ±ä¸€é›†åœ˜ 7%~11% / åœ‹å¤–å¯¦é«” 11%',
            type: 'ceiling', limit: 12500, tier1Rate: 0.07, tier2Rate: 0.03, // é è¨­é¡¯ç¤º7%æ¨¡å¼
            gradient: 'linear-gradient(135deg, #ff7e5f 0%, #feb47b 100%)',
            textColor: 'white', msgDanger: 'è¸©é»å·²æ»¿ (è®Š3%)',
            parking: `
                ğŸ”¥ <b>åœ‹å¤–å¯¦é«” 11% (åˆ· $6,250)</b><br>
                éœ€åœ‹å¤–å¯¦é«”åº—é¢æ¶ˆè²» (ä¸Šé™ 500 é»)<br>
                <hr style="opacity:0.3; margin:8px 0;">
                ğŸª <b>çµ±ä¸€é›†åœ˜ 7% ~ 11%</b><br>
                1. ç¶å®š icash Pay: <b>+4%</b> (åˆ·$3,750)<br>
                2. è¸©é»ä»»å‹™: <b>æœ€é«˜ +4%</b> (åˆ·$12,500)<br>
                3. é›†åœ˜åŠ ç¢¼: <b>+2%</b> (åˆ·$25,000)<br>
                4. åŸºæœ¬å›é¥‹: <b>1%</b> (ç„¡ä¸Šé™)
            `
        },
        // é ç•™å¡ç‰‡ (åƒ…1å¼µï¼Œè£œè¶³8æ ¼) - é è¨­éš±è—
        { 
            id: 'add1', name: 'æ–°å¢å¡ç‰‡', nickname: 'é»æ“Šé¸å¡', note: 'å‰å¾€è³‡æ–™åº«æŒ‘é¸', 
            type: 'placeholder', 
            gradient: 'linear-gradient(135deg, #e0e0e0 0%, #f5f5f5 100%)', 
            textColor: '#999', msgDanger: '' 
        }
    ];

    // åˆå§‹åŒ–é¡¯ç¤ºç‹€æ…‹ (ç¢ºä¿ 8 æ ¼)
    let visibleCards = JSON.parse(localStorage.getItem('visibleCards'));
    const realCardIds = ['c6', 'c1', 'c5', 'c3', 'c4', 'c2', 'c7', 'c8', 'c9', 'c10'];
    
    if (!visibleCards) {
        // æ–°ç”¨æˆ¶: é¡¯ç¤º 8 å¼µå¯¦é«”å¡
        visibleCards = ['c6', 'c1', 'c5', 'c3', 'c4', 'c2', 'c7', 'c8']; 
        localStorage.setItem('visibleCards', JSON.stringify(visibleCards));
    } else {
        // èˆŠç”¨æˆ¶è‡ªå‹•è£œä¸Šæ–°å¡ç‰‡ c10 (å¦‚æœä¸å¤ ä½ç½®å°±è—åœ¨å¾Œé¢)
        if (!visibleCards.includes('c10')) {
             // ç°¡å–®é‚è¼¯ï¼šç›´æ¥åŠ é€²å»ï¼Œåæ­£å¾Œé¢æœƒåˆ‡æˆ 8 å¼µ
             visibleCards.push('c10');
        }
        
        let currentRealCards = visibleCards.filter(id => realCardIds.includes(id));
        
        if (currentRealCards.length > 8) {
            // è¶…é 8 å¼µï¼Œå¼·åˆ¶åˆ‡é™¤
            visibleCards = currentRealCards.slice(0, 8);
        } else if (currentRealCards.length === 8) {
            visibleCards = currentRealCards; 
        } else {
            if (!visibleCards.includes('add1')) visibleCards.push('add1');
            visibleCards = visibleCards.filter(id => id !== 'add2');
        }
        localStorage.setItem('visibleCards', JSON.stringify(visibleCards));
    }

    let savedOrder = JSON.parse(localStorage.getItem('cardOrder'));
    let cards = [...defaultCards];
    let sortableInstance = null;

    function getSortedCards() {
        let displayCards = cards.filter(c => visibleCards.includes(c.id));
        const realCardCount = displayCards.filter(c => c.type !== 'placeholder').length;
        if (realCardCount < 8 && !visibleCards.includes('add1')) {
             const placeholder = cards.find(c => c.id === 'add1');
             if(placeholder && !displayCards.includes(placeholder)) {
                 displayCards.push(placeholder);
             }
        }
        if (savedOrder && Array.isArray(savedOrder)) {
            displayCards.sort((a, b) => {
                let indexA = savedOrder.indexOf(a.id);
                let indexB = savedOrder.indexOf(b.id);
                if (indexA === -1) indexA = 999;
                if (indexB === -1) indexB = 999;
                return indexA - indexB;
            });
        }
        return displayCards;
    }

    function initSortable() {
        var el = document.getElementById('card-grid');
        if (sortableInstance) { sortableInstance.destroy(); }
        sortableInstance = new Sortable(el, {
            animation: 150, ghostClass: 'sortable-ghost', dragClass: 'sortable-drag',
            delay: 200, delayOnTouchOnly: true, forceFallback: true, 
            onEnd: function (evt) {
                const visibleOrder = Array.from(evt.to.children).map(el => el.getAttribute('data-card-id'));
                const allCardIds = cards.map(c => c.id);
                const hiddenCards = allCardIds.filter(id => !visibleOrder.includes(id));
                const finalOrder = [...visibleOrder, ...hiddenCards];
                localStorage.setItem('cardOrder', JSON.stringify(finalOrder));
                savedOrder = finalOrder;
            }
        });
    }

    let transactions = JSON.parse(localStorage.getItem('transactions')) || [];

    function updateDate() { const now = new Date(); document.getElementById('dateDisplay').innerText = `${now.getMonth()+1}/${now.getDate()}`; }

    // å„²å­˜åŒ¯è±æ—…äººå¡è¨­å®š
    function saveHsbcTier() {
        const tier = document.querySelector('input[name="hsbcTier"]:checked').value;
        localStorage.setItem('hsbc_tier', tier);
        renderGrid(); 
        updateRewardPreview();
    }
    function saveHsbcInitial() {
        const initial = document.getElementById('hsbcInitialMiles').value;
        localStorage.setItem('hsbc_initial_miles', initial);
        renderGrid();
    }
    
    // ä¸­ä¿¡ Uniopen åˆ‡æ›å ´æ™¯
    function toggleCtbcScene() {
        const scene = document.querySelector('input[name="ctbcScene"]:checked').value;
        const unifiedZone = document.getElementById('ctbcUnifiedZone');
        if (scene === 'unified') {
            unifiedZone.style.display = 'block';
        } else {
            unifiedZone.style.display = 'none';
            // æ¸…ç©ºé¸æ“‡
            document.getElementById('checkCtbcIcash').checked = false;
            // ä¿®æ­£ï¼šä¸è¦æ¸…ç©º brandï¼Œå› ç‚º toggle å¯èƒ½åªæ˜¯èª¤æŒ‰ï¼Œä¿ç•™ brand é¸æ“‡æ¯”è¼ƒå¥½
            // document.querySelectorAll('.ctbc-brand').forEach(cb => cb.checked = false);
        }
        updateRewardPreview();
    }

    // --- æ ¸å¿ƒè¨ˆç®—é‚è¼¯ ---
    function calculateStats(cardId, addedAmount = 0, options = {}) {
        // options åŒ…å«é è¦½æ™‚çš„æ‰€æœ‰å‹¾é¸ç‹€æ…‹
        
        const card = cards.find(c => c.id === cardId);
        if (card.type === 'placeholder') return { spend: 0, validSpend: 0, reward: 0, rate: '0.0' };

        const startDate = new Date(new Date().getFullYear(), new Date().getMonth(), 1); 
        const relevantTx = transactions.filter(t => t.cardId === cardId && new Date(t.date) >= startDate);
        let totalSpend = relevantTx.reduce((sum, t) => sum + parseFloat(t.amount), 0);
        totalSpend += addedAmount;

        const threshold = card.threshold || 0;
        const validSpend = relevantTx.filter(t => t.amount >= threshold).reduce((sum, t) => sum + t.amount, 0) + (addedAmount >= threshold ? addedAmount : 0);

        let reward = 0;

        // --- ä¸­ä¿¡ Uniopen (c10) è¤‡é›œé‚è¼¯ ---
        if (cardId === 'c10') {
            // 1. åœ‹å¤–å¯¦é«” (11% ä¸Šé™ $6250)
            const foreignTxs = relevantTx.filter(t => t.ctbcScene === 'foreign');
            let foreignSpend = foreignTxs.reduce((sum, t) => sum + t.amount, 0);
            if (addedAmount > 0 && options.ctbcScene === 'foreign') foreignSpend += addedAmount;
            
            const foreignBonusEligible = Math.min(foreignSpend, 6250);
            const foreignBonus = foreignBonusEligible * 0.08; // 8% åŠ ç¢¼
            const foreignBase = foreignSpend * 0.03; // 2%åŸºæœ¬ + 1%å¯¦é«” = 3%
            const foreignTotalReward = foreignBase + foreignBonus;

            // 2. çµ±ä¸€é›†åœ˜ (å«å®¶æ¨‚ç¦) - ä¸‰å±¤ç–ŠåŠ 
            // å…ˆè¨ˆç®—æ­·å²çš„æ‰€æœ‰ã€Œå“ç‰Œæ•¸ã€ (åŒ…å«ç•¶æ¬¡é è¦½)
            let uniqueBrands = new Set();
            relevantTx.forEach(t => {
                if (t.ctbcBrands && Array.isArray(t.ctbcBrands)) {
                    t.ctbcBrands.forEach(b => uniqueBrands.add(b));
                }
            });
            // åŠ ä¸Šé è¦½çš„å“ç‰Œ
            if (options.ctbcBrands && Array.isArray(options.ctbcBrands)) {
                options.ctbcBrands.forEach(b => uniqueBrands.add(b));
            }
            const brandCount = Math.min(uniqueBrands.size, 5);
            // è¸©é»è²»ç‡è¡¨ (1å®¶0%, 2å®¶1%, 3å®¶2%, 4å®¶3%, 5å®¶4%)
            const taskRates = [0, 0, 0.01, 0.02, 0.03, 0.04];
            const currentTaskRate = taskRates[brandCount];

            // çµ±ä¸€é›†åœ˜æ¶ˆè²»æ± 
            const unifiedTxs = relevantTx.filter(t => t.ctbcScene === 'unified');
            let unifiedSpend = unifiedTxs.reduce((sum, t) => sum + t.amount, 0);
            if (addedAmount > 0 && options.ctbcScene === 'unified') unifiedSpend += addedAmount;

            // icash Pay æ¶ˆè²»æ± 
            const icashTxs = relevantTx.filter(t => t.ctbcScene === 'unified' && t.isCtbcIcash);
            let icashSpend = icashTxs.reduce((sum, t) => sum + t.amount, 0);
            if (addedAmount > 0 && options.ctbcScene === 'unified' && options.isCtbcIcash) icashSpend += addedAmount;

            // è¨ˆç®—å„å±¤å›é¥‹
            // L4: åŸºæœ¬ 1%
            const unifiedBase = unifiedSpend * 0.01;
            
            // L3: é›†åœ˜åŠ ç¢¼ 2% (ä¸Šé™ 500é» -> $25000)
            const groupEligible = Math.min(unifiedSpend, 25000);
            const groupBonus = groupEligible * 0.02;

            // L2: è¸©é»ä»»å‹™ 0~4% (ä¸Šé™ 500é» -> $12500)
            // æ³¨æ„ï¼šé€™æ˜¯å›æº¯çš„ï¼Œåªè¦é”æ¨™ï¼Œæ•´å€‹æœˆéƒ½åœ¨é€™å€‹è²»ç‡ä¸‹ (ç›´åˆ°ä¸Šé™)
            const taskEligible = Math.min(unifiedSpend, 12500);
            const taskBonus = taskEligible * currentTaskRate;

            // L1: icash Pay åŠ ç¢¼ 4% (ä¸Šé™ 150é» -> $3750)
            const icashEligible = Math.min(icashSpend, 3750);
            const icashBonus = icashEligible * 0.04;

            const unifiedTotalReward = unifiedBase + groupBonus + taskBonus + icashBonus;

            // 3. ä¸€èˆ¬æ¶ˆè²» (1%)
            const normalTxs = relevantTx.filter(t => t.ctbcScene === 'normal' || !t.ctbcScene); // ç›¸å®¹èˆŠè³‡æ–™
            let normalSpend = normalTxs.reduce((sum, t) => sum + t.amount, 0);
            if (addedAmount > 0 && (options.ctbcScene === 'normal' || !options.ctbcScene)) normalSpend += addedAmount;
            const normalReward = normalSpend * 0.01;

            reward = foreignTotalReward + unifiedTotalReward + normalReward;
            
            let actualRate = 7.0;
            if (totalSpend > 0) actualRate = (reward / totalSpend) * 100;
            
            return { spend: totalSpend, validSpend: validSpend, reward: Math.round(reward), rate: actualRate.toFixed(1) };
        }

        // ... (å…¶ä»–èˆŠå¡ç‰‡é‚è¼¯ä¿æŒä¸è®Š: c9, c8, c7, c2, mixed, ceiling) ...
        // åŒ¯è±æ—…äºº (c9)
        if (cardId === 'c9') {
            const tier = localStorage.getItem('hsbc_tier') || 'infinite';
            let rateDomestic = 18; let rateForeign = 10;
            if (tier === 'signature') { rateDomestic = 18; rateForeign = 15; }
            let totalMiles = parseInt(localStorage.getItem('hsbc_initial_miles') || 0);
            const allHistoryTx = transactions.filter(t => t.cardId === 'c9');
            allHistoryTx.forEach(tx => {
                const rate = tx.isHsbcForeign ? rateForeign : rateDomestic;
                totalMiles += Math.floor(tx.amount / rate);
            });
            if (addedAmount > 0) {
                const currentRate = options.isHsbcForeign ? rateForeign : rateDomestic;
                totalMiles += Math.floor(addedAmount / currentRate);
            }
            reward = totalMiles;
            let actualRate = (totalSpend > 0) ? (totalSpend / totalMiles).toFixed(1) : 0;
            return { spend: totalSpend, validSpend: validSpend, reward: reward, rate: actualRate };
        }
        // é æ± (c8)
        if (cardId === 'c8') {
            const petSpend = relevantTx.filter(t => t.isHappyPet).reduce((sum, t) => sum + t.amount, 0) + (options.isHappyPet ? addedAmount : 0);
            const petReward = Math.min(petSpend, 5263) * 0.10;
            const petOverflow = Math.max(0, petSpend - 5263);
            const lifeSpend = relevantTx.filter(t => t.isHappyLife).reduce((sum, t) => sum + t.amount, 0) + (options.isHappyLife ? addedAmount : 0);
            const lifeReward = Math.min(lifeSpend, 5714) * 0.04;
            const lifeOverflow = Math.max(0, lifeSpend - 5714);
            const peaceSpend = relevantTx.filter(t => t.isHappyPeace).reduce((sum, t) => sum + t.amount, 0) + (options.isHappyPeace ? addedAmount : 0);
            const peaceReward = Math.min(peaceSpend, 5714) * 0.04;
            const peaceOverflow = Math.max(0, peaceSpend - 5714);
            const foreignSpend = relevantTx.filter(t => t.isHappyForeign).reduce((sum, t) => sum + t.amount, 0) + (options.isHappyForeign ? addedAmount : 0);
            const foreignReward = foreignSpend * 0.025;
            const normalSpend = relevantTx.filter(t => !t.isHappyPet && !t.isHappyLife && !t.isHappyPeace && !t.isHappyForeign).reduce((sum, t) => sum + t.amount, 0) 
                              + (!options.isHappyPet && !options.isHappyLife && !options.isHappyPeace && !options.isHappyForeign ? addedAmount : 0);
            const totalNormalSpend = normalSpend + petOverflow + lifeOverflow + peaceOverflow;
            const normalReward = totalNormalSpend * 0.005;
            const thresholdBonus = totalSpend >= 26000 ? 400 : 0;
            const foreignThresholdBonus = foreignSpend >= 50000 ? 500 : 0;
            reward = petReward + lifeReward + peaceReward + foreignReward + normalReward + thresholdBonus + foreignThresholdBonus;
            let actualRate = (totalSpend > 0) ? (reward / totalSpend) * 100 : 10.0;
            return { spend: totalSpend, validSpend: validSpend, reward: Math.round(reward), rate: actualRate.toFixed(1) };
        }
        // UNI (c7)
        if (cardId === 'c7') {
            let baseRate = 0.035; let baseCap = 40000;
            const isUpMonth = options.isUniUp || relevantTx.some(t => t.isUniUp);
            if (isUpMonth) { baseRate = 0.045; baseCap = 142857; }
            const baseEligible = Math.min(totalSpend, baseCap);
            const baseReward = baseEligible * baseRate;
            const overflowReward = Math.max(0, totalSpend - baseCap) * 0.01;
            const currentBonusSpend = relevantTx.filter(t => t.isUniBonus).reduce((sum, t) => sum + t.amount, 0);
            const totalBonusSpend = currentBonusSpend + (options.isUniBonus ? addedAmount : 0);
            const bonusReward = Math.min(totalBonusSpend, 16666) * 0.03;
            reward = baseReward + overflowReward + bonusReward;
            let actualRate = (totalSpend > 0) ? (reward / totalSpend) * 100 : (baseRate * 100);
            return { spend: totalSpend, validSpend: validSpend, reward: Math.round(reward), rate: actualRate.toFixed(1) };
        }
        // Green (c2)
        if (cardId === 'c2') {
            const currentGreenSpend = relevantTx.filter(t => t.isGreen).reduce((sum, t) => sum + t.amount, 0);
            const totalGreenSpend = currentGreenSpend + (options.isGreen ? addedAmount : 0);
            const greenReward = Math.min(totalGreenSpend, 2500) * 0.06;
            const greenOverflow = Math.max(0, totalGreenSpend - 2500);
            const currentForeignSpend = relevantTx.filter(t => t.isForeign).reduce((sum, t) => sum + t.amount, 0);
            const totalForeignSpend = currentForeignSpend + (options.isForeign ? addedAmount : 0);
            const foreignReward = totalForeignSpend * 0.02;
            const currentNormalSpend = relevantTx.filter(t => !t.isGreen && !t.isForeign).reduce((sum, t) => sum + t.amount, 0);
            const totalNormalSpend = currentNormalSpend + (!options.isGreen && !options.isForeign ? addedAmount : 0);
            const normalReward = (greenOverflow + totalNormalSpend) * 0.01;
            reward = greenReward + foreignReward + normalReward;
            return { spend: totalSpend, validSpend: validSpend, reward: Math.round(reward), rate: 6.0.toFixed(1) };
        }
        // Others
        if (card.type === 'mixed') {
            if (validSpend < card.minSpend) reward = validSpend * card.tier2Rate; 
            else if (validSpend <= card.limit) reward = validSpend * card.tier1Rate;
            else reward = (card.limit * card.tier1Rate) + ((validSpend - card.limit) * card.tier2Rate);
        } else if (card.type === 'ceiling') {
            if (validSpend <= card.limit) reward = validSpend * card.tier1Rate;
            else reward = (card.limit * card.tier1Rate) + ((validSpend - card.limit) * card.tier2Rate);
        } else { 
            reward = validSpend * card.tier1Rate; 
        }
        let currentRate = (validSpend > 0) ? (reward / validSpend) * 100 : (card.tier1Rate || 0) * 100;
        return { spend: totalSpend, validSpend: validSpend, reward: Math.round(reward), rate: currentRate.toFixed(1) };
    }

    // Toggle Logics
    function toggleBillLogic() {
        const isBill = document.getElementById('checkIsBill').checked;
        const labelBase = document.getElementById('labelBaseRate');
        if (isBill) { document.getElementById('checkBonus25').checked = false; labelBase.innerText = "ğŸ”° åŸºæœ¬å›é¥‹ 0.15% (ç„¡ä¸Šé™)"; } 
        else { labelBase.innerText = "ğŸ”° åŸºæœ¬å›é¥‹ 1% (ç„¡ä¸Šé™)"; }
        updateRewardPreview();
    }
    function toggleSelectedLogic() {
        if (document.getElementById('checkBonus25').checked) { document.getElementById('checkIsBill').checked = false; document.getElementById('labelBaseRate').innerText = "ğŸ”° åŸºæœ¬å›é¥‹ 1% (ç„¡ä¸Šé™)"; }
        updateRewardPreview();
    }
    function toggleGreenLogic() { if(document.getElementById('checkGreenChannel').checked) document.getElementById('checkForeign').checked = false; updateRewardPreview(); }
    function toggleForeignLogic() { if(document.getElementById('checkForeign').checked) document.getElementById('checkGreenChannel').checked = false; updateRewardPreview(); }
    function toggleHappyPet() { if(document.getElementById('checkHappyPet').checked) { document.getElementById('checkHappyPeace').checked = false; document.getElementById('checkHappyLife').checked = false; document.getElementById('checkHappyForeign').checked = false; } updateRewardPreview(); }
    function toggleHappyPeace() { if(document.getElementById('checkHappyPeace').checked) { document.getElementById('checkHappyPet').checked = false; document.getElementById('checkHappyLife').checked = false; document.getElementById('checkHappyForeign').checked = false; } updateRewardPreview(); }
    function toggleHappyLife() { if(document.getElementById('checkHappyLife').checked) { document.getElementById('checkHappyPet').checked = false; document.getElementById('checkHappyPeace').checked = false; document.getElementById('checkHappyForeign').checked = false; } updateRewardPreview(); }
    function toggleHappyForeign() { if(document.getElementById('checkHappyForeign').checked) { document.getElementById('checkHappyPet').checked = false; document.getElementById('checkHappyPeace').checked = false; document.getElementById('checkHappyLife').checked = false; } updateRewardPreview(); }

    function updateRewardPreview() {
        const inputVal = document.getElementById('amountInput').value;
        const amount = parseFloat(inputVal);
        const previewDiv = document.getElementById('liveRewardCalc');
        const cardId = document.getElementById('cardIdInput').value;

        // ç¨ç«‹æ›´æ–°ä¸­ä¿¡å“ç‰Œç‹€æ…‹ (ä¸ç®¡æœ‰ç„¡é‡‘é¡)
        if (cardId === 'c10') {
            const statusEl = document.getElementById('ctbcBrandStatus');
            if (statusEl) {
                let uniqueBrands = new Set();
                transactions.filter(t => t.cardId === 'c10').forEach(t => { if(t.ctbcBrands) t.ctbcBrands.forEach(b => uniqueBrands.add(b)); });
                const currentChecked = Array.from(document.querySelectorAll('.ctbc-brand:checked')).map(cb => cb.value);
                // é€™è£¡æ”¹ç‚ºã€Œåˆä½µè¨ˆç®—ã€é‚è¼¯ï¼Œç¢ºä¿å–æ¶ˆå‹¾é¸æ™‚æ•¸å­—æœƒé™
                // ä¿®æ­£é‚è¼¯ï¼š
                // 1. å»ºç«‹ base set (æ­·å²)
                let baseBrands = new Set();
                transactions.filter(t => t.cardId === 'c10').forEach(t => { if(t.ctbcBrands) t.ctbcBrands.forEach(b => baseBrands.add(b)); });
                
                // 2. å»ºç«‹ current set (ç•¶å‰å‹¾é¸)
                let currentSet = new Set();
                document.querySelectorAll('.ctbc-brand:checked').forEach(cb => currentSet.add(cb.value));
                
                // 3. è¯é›† (ä½†è¦æ³¨æ„ï¼Œå¦‚æœæ˜¯ã€Œæ–°å¢æ¨¡å¼ã€ï¼Œæ­·å²çš„æ‡‰è©²éƒ½å·²ç¶“è¢«é å‹¾é¸äº†ã€‚å¦‚æœæ˜¯ä½¿ç”¨è€…æ‰‹å‹•å–æ¶ˆï¼Œè¡¨ç¤ºä»–æƒ³ç§»é™¤ï¼Ÿ)
                // å…¶å¯¦æœ€ç°¡å–®çš„é‚è¼¯æ˜¯ï¼šç›´æ¥ç®—ç•«é¢ä¸Šå‹¾äº†å¹¾å€‹ + ç•«é¢æ²’å‹¾ä½†æ­·å²æœ‰çš„(éš±è—çš„?)
                // åœ¨æˆ‘å€‘çš„ UI è¨­è¨ˆè£¡ï¼Œæ­·å²çš„æœƒè¢«è‡ªå‹•å‹¾é¸ã€‚æ‰€ä»¥ã€Œç•«é¢ä¸Šå‹¾é¸çš„ã€å°±ç­‰æ–¼ã€Œæ‰€æœ‰è¦è¨ˆç®—çš„ã€ã€‚
                
                let totalBrands = new Set();
                document.querySelectorAll('.ctbc-brand:checked').forEach(cb => totalBrands.add(cb.value));
                
                const brandCount = Math.min(totalBrands.size, 5);
                const taskRate = [0, 0, 1, 2, 3, 4][brandCount];
                statusEl.innerText = `(ç›®å‰ ${totalBrands.size} å®¶ / ä»»å‹™ +${taskRate}%)`;
                if (brandCount >= 5) statusEl.style.color = '#34C759'; 
                else statusEl.style.color = '#007AFF';
            }
        }

        if (!amount || amount <= 0) { previewDiv.style.display = 'none'; previewDiv.innerHTML = ''; return; }
        previewDiv.style.display = 'block'; 

        // æ”¶é›†æ‰€æœ‰å¯èƒ½çš„é¸é …ç‹€æ…‹
        const options = {
            // General
            isGreen: document.getElementById('checkGreenChannel').checked,
            isForeign: document.getElementById('checkForeign').checked,
            isUniBonus: document.getElementById('checkUniBonus').checked,
            isUniUp: document.getElementById('checkUniUp').checked,
            isHappyPet: document.getElementById('checkHappyPet').checked,
            isHappyPeace: document.getElementById('checkHappyPeace').checked,
            isHappyLife: document.getElementById('checkHappyLife').checked,
            isHappyForeign: document.getElementById('checkHappyForeign').checked,
            isHsbcForeign: document.getElementById('checkHsbcForeign').checked,
            // CTBC specific
            ctbcScene: document.querySelector('input[name="ctbcScene"]:checked') ? document.querySelector('input[name="ctbcScene"]:checked').value : null,
            isCtbcIcash: document.getElementById('checkCtbcIcash').checked,
            ctbcBrands: Array.from(document.querySelectorAll('.ctbc-brand:checked')).map(cb => cb.value)
        };

        const currentStats = calculateStats(cardId, 0);
        const newStats = calculateStats(cardId, amount, options);
        
        let totalDiff = newStats.reward - currentStats.reward;
        let effectiveRate = 0;
        let displayHtml = '';

        // é‡å°å–®ç­†å›é¥‹ç‡åšæ›´ç²¾ç¢ºçš„é¡¯ç¤º (é¿å…è¢«æ­·å²å¹³å‡ç¨€é‡‹)
        if (cardId === 'c10' && options.ctbcScene === 'unified') {
             // Uniopen ç‰¹æ®Šåˆ†é›¢é¡¯ç¤ºé‚è¼¯
             let baseRate = 0.03; // 1+2
             if (options.isCtbcIcash) baseRate += 0.04;
             
             // ä¿®æ­£ï¼šé€™è£¡ä¹Ÿè¦ç”¨å³æ™‚å‹¾é¸çš„æ•¸é‡ä¾†ç®— rate
             // ä½† calculateStats å…§éƒ¨æ˜¯ç”¨ Unionï¼Œæ‰€ä»¥é€™è£¡ä¹Ÿè¦ä¿æŒä¸€è‡´
             // å…¶å¯¦ calculateStats å·²ç¶“ç®—å¾—å¾ˆæº–äº†ï¼Œæˆ‘å€‘åªéœ€è¦æ­£ç¢ºé¡¯ç¤º
             // ç‚ºäº†é¡¯ç¤ºæ–¹ä¾¿ï¼Œæˆ‘å€‘é‡æ–°è¨ˆç®—ä¸€æ¬¡ brandCount
             let currentBrandCount = 0;
             let tempSet = new Set();
             if (options.ctbcBrands) options.ctbcBrands.forEach(b => tempSet.add(b));
             currentBrandCount = Math.min(tempSet.size, 5);
             
             const taskRate = [0, 0, 0.01, 0.02, 0.03, 0.04][currentBrandCount];
             
             const thisTxRate = baseRate + taskRate;
             
             // å‡è¨­é€™ç­†æ²’çˆ†æ‰ï¼Œæ‡‰è©²æ‹¿å¤šå°‘ (åšç‚ºé¡¯ç¤ºåŸºæº–)
             // æ³¨æ„ï¼šé€™åªæ˜¯é è¦½ï¼Œè‹¥å¯¦éš›çˆ†æ‰ calculateStats æœƒç®—æº– totalDiff
             let thisTxEarn = Math.round(amount * thisTxRate);
             
             // è£œç™¼ = ç¸½å·®ç•° - æœ¬ç­†æ‡‰å¾—
             let bonusEarn = totalDiff - thisTxEarn;
             
             if (bonusEarn > 5) {
                 displayHtml = `âœ¨ æœ¬ç­† $${thisTxEarn} (${(thisTxRate*100).toFixed(0)}%) + <span style="color:#d32f2f">ğŸ”¥è£œç™¼ $${bonusEarn}</span>`;
             } else {
                 // å¦‚æœ totalDiff æ¯”ç†è«–å€¼å°ï¼Œä»£è¡¨çˆ†äº†ï¼Œé¡¯ç¤ºå¯¦éš›å€¼
                 let effectiveRate = ((totalDiff / amount) * 100).toFixed(1);
                 displayHtml = `âœ¨ é è¨ˆå›é¥‹ï¼š$${totalDiff} (${effectiveRate}%)`;
             }

        } else if (cardId === 'c6') {
             // è±¬å¯Œå¡ç‰¹æ®Šé‚è¼¯ä¿ç•™
             let baseRate = document.getElementById('checkIsBill').checked ? 0.0015 : 0.01;
             let reward = amount * baseRate;
             if (document.getElementById('checkBonus25').checked) reward += amount * 0.025;
             if (document.getElementById('checkBonus10').checked) {
                 const currentMonthSpend = transactions.filter(t => t.cardId === 'c6' && new Date(t.date) >= new Date(new Date().getFullYear(), new Date().getMonth(), 1)).reduce((sum, t) => sum + t.amount, 0);
                 const eligible = Math.min(amount, Math.max(0, 8000 - currentMonthSpend));
                 reward += eligible * 0.10;
             }
             let thisTransactionReward = Math.round(reward);
             effectiveRate = ((thisTransactionReward / amount) * 100).toFixed(2);
             displayHtml = `âœ¨ é è¨ˆå›é¥‹ï¼š$${thisTransactionReward} (${effectiveRate}%)`;

        } else if (cardId === 'c9') {
             const tier = localStorage.getItem('hsbc_tier') || 'infinite';
             let rate = 18;
             if (tier === 'infinite' && options.isHsbcForeign) rate = 10;
             else if (tier === 'signature' && options.isHsbcForeign) rate = 15;
             displayHtml = `âœ¨ é è¨ˆå›é¥‹ï¼š${totalDiff} å“© (${rate}å…ƒ/å“©)`;
        } else {
             effectiveRate = ((totalDiff / amount) * 100).toFixed(1);
             displayHtml = `âœ¨ é è¨ˆå›é¥‹ï¼š$${totalDiff} (${effectiveRate}%)`;
        }

        previewDiv.innerHTML = displayHtml;
    }

    function renderGrid() {
        const container = document.getElementById('card-grid');
        let monthTotalReward = 0; container.innerHTML = '';
        cards.forEach(card => {
             if (card.type === 'placeholder') return;
             const stats = calculateStats(card.id);
             if (card.id !== 'c9') monthTotalReward += stats.reward;
        });
        document.getElementById('totalRewardDisplay').innerText = `$${monthTotalReward.toLocaleString()}`;
        const displayCards = getSortedCards();
        
        displayCards.forEach(card => {
            const stats = calculateStats(card.id); 
            let percent = 0, statusText = '', msgStyle = '';
            
            if (card.id === 'c9') {
                const tier = localStorage.getItem('hsbc_tier') || 'infinite';
                card.name = (tier === 'infinite') ? 'åŒ¯è±æ—…äººç„¡é™å¡' : 'åŒ¯è±æ—…äººå¾¡ç’½å¡';
                card.note = (tier === 'infinite') ? 'åœ‹å…§18/åœ‹å¤–10 (å“©)' : 'åœ‹å…§18/åœ‹å¤–15 (å“©)';
            }
            
            if (card.type === 'placeholder') {
                percent = 0; statusText = 'å°šæœªå•Ÿç”¨';
            } else if (card.id === 'c9') { 
                percent = 0; statusText = `ç¸½å“©ç¨‹ ${stats.reward.toLocaleString()} å“©`; msgStyle = 'color: #007AFF; font-weight:bold;';
            } else if (card.id === 'c10') {
                // ä¸­ä¿¡ç‰¹æ®Šé€²åº¦æ¢ (ç”¨çµ±ä¸€é›†åœ˜è¸©é»ä¸Šé™ç•¶åŸºæº–)
                percent = (stats.validSpend / 12500) * 100;
                if (stats.validSpend < 3750) statusText = `icash 4% å‰© $${(3750-stats.validSpend).toLocaleString()}`;
                else if (stats.validSpend < 12500) statusText = `è¸©é» 4% å‰© $${(12500-stats.validSpend).toLocaleString()}`;
                else if (stats.validSpend < 25000) statusText = `é›†åœ˜ 2% å‰© $${(25000-stats.validSpend).toLocaleString()}`;
                else { percent = 100; statusText = 'åƒ…å‰© 1% å›é¥‹'; msgStyle = 'color: #aaa;'; }
            } else if (card.id === 'c2') { 
                percent = (stats.validSpend / card.target) * 100;
                statusText = stats.validSpend >= card.target ? 'ä»»å‹™é”æˆ (å…åœ)' : `å·® $${(card.target - stats.validSpend).toLocaleString()}`;
            } else if (card.id === 'c8') { 
                if (stats.spend < 3000) { percent = (stats.spend / 3000) * 100; statusText = `å·® $${(3000 - stats.spend).toLocaleString()} å•Ÿå‹•é«˜å›é¥‹`; msgStyle = 'color: #FFD700;'; } 
                else if (stats.spend < 26000) { percent = (stats.spend / 26000) * 100; statusText = `å·® $${(26000 - stats.spend).toLocaleString()} é ˜æ»¿é¡ç¦®`; } 
                else { percent = 100; statusText = 'ğŸ‰ æ»¿é¡é”æ¨™ (è¨˜å¾—ç™»éŒ„!)'; msgStyle = 'color: #38ef7d;'; }
            } else if (card.type === 'mixed') {
                if (stats.validSpend < card.minSpend) { percent = (stats.validSpend / card.minSpend) * 100; statusText = `å·® $${(card.minSpend - stats.validSpend).toLocaleString()} å‡ç´š`; msgStyle = 'color: #FFD700;'; }
                else if (stats.validSpend <= card.limit) { percent = (stats.validSpend / card.limit) * 100; const remain = card.limit - stats.validSpend; statusText = `å‰© $${remain.toLocaleString()} (5%)`; }
                else { percent = 100; statusText = 'å·²å°é ‚ (è®Š0.5%)'; msgStyle = 'color: #ffcccc;'; }
            } else if (card.type === 'ceiling') {
                percent = (stats.validSpend / card.limit) * 100;
                if (stats.validSpend <= card.limit) { const remain = card.limit - stats.validSpend; statusText = `å‰© $${remain.toLocaleString()}`; if(remain < 1000) {statusText = `âš ï¸ å‰© $${remain.toLocaleString()}`; msgStyle='color:#FFD700;';} }
                else { percent = 100; statusText = card.msgDanger; msgStyle = 'color: #ffcccc;'; }
            } else { 
                percent = (stats.validSpend / card.target) * 100; 
                statusText = stats.validSpend >= card.target ? 'ä»»å‹™é”æˆ' : `å·® $${(card.target - stats.validSpend).toLocaleString()}`; 
            }

            const ruleHtml = card.rule ? `<div class="tile-rule">${card.rule}</div>` : '';
            let displayRate = `${stats.rate}%`;
            if (card.id === 'c8') displayRate = '10.0%'; if (card.id === 'c2') displayRate = '6.0%'; if (card.id === 'c9') displayRate = 'å“©ç¨‹'; if (card.id === 'c10') displayRate = 'æœ€é«˜11%'; if (card.type === 'placeholder') displayRate = '--%';

            let tileClass = 'card-tile';
            let nickClass = 'tile-nickname-badge';
            if (card.type === 'placeholder') nickClass += ' placeholder';

            const tile = document.createElement('div'); 
            tile.className = tileClass; 
            tile.setAttribute('data-card-id', card.id);
            tile.style.background = card.gradient; 
            tile.style.color = card.textColor; 
            if (card.type === 'placeholder') { tile.onclick = () => openManageModal(); } else { tile.onclick = () => openQuickAdd(card.id); }
            
            let earnedText = `+$${stats.reward.toLocaleString()}`;
            if (card.id === 'c9') {
                const tier = localStorage.getItem('hsbc_tier') || 'infinite';
                let rateDomestic = 18; let rateForeign = 10;
                if (tier === 'signature') { rateDomestic = 18; rateForeign = 15; }
                let txMiles = 0;
                const allHistoryTx = transactions.filter(t => t.cardId === 'c9');
                allHistoryTx.forEach(tx => { const rate = tx.isHsbcForeign ? rateForeign : rateDomestic; txMiles += Math.floor(tx.amount / rate); });
                earnedText = `+${txMiles.toLocaleString()} å“©`;
            }

            tile.innerHTML = `
                <div class="tile-header"><span class="tile-name">${card.name}</span><span class="rate-badge" style="color:black">${displayRate}</span></div>
                <div class="${nickClass}">${card.nickname}</div>
                <span class="tile-note" style="color:${card.textColor==='white'?'rgba(255,255,255,0.8)':'rgba(0,0,0,0.6)'}">${card.note}</span>
                <div class="tile-body"><div class="tile-stat">$${stats.spend.toLocaleString()}</div>${ruleHtml}<div class="tile-earned">${earnedText}</div></div>
                <div class="tile-footer"><div class="progress-track"><div class="progress-fill" style="width:${Math.min(percent, 100)}%"></div></div><div class="tile-msg" style="${msgStyle}">${statusText}</div></div>`;
            container.appendChild(tile);
        });
        checkUrgentTasks();
        initSortable();
    }
    
    function openManageModal() {
        const list = document.getElementById('manageCardList');
        list.innerHTML = '';
        const realCardIds = ['c6', 'c1', 'c5', 'c3', 'c4', 'c2', 'c7', 'c8', 'c9', 'c10'];
        const currentRealCardsCount = visibleCards.filter(id => realCardIds.includes(id)).length;
        cards.forEach(card => {
            if (card.id === 'add1') return; 
            const isVisible = visibleCards.includes(card.id);
            const item = document.createElement('div');
            item.className = 'manage-item';
            item.onclick = function(e) {
                if (e.target.tagName === 'INPUT') return;
                const checkbox = this.querySelector('input[type="checkbox"]');
                if (!checkbox.checked && currentRealCardsCount >= 8) { alert('âš ï¸ æœ€å¤šåªèƒ½é¡¯ç¤º 8 å¼µå¡ç‰‡ï¼Œè«‹å…ˆéš±è—ä¸€å¼µï¼'); return; }
                checkbox.checked = !checkbox.checked;
                toggleCardVisibility(card.id);
            };
            const label = document.createElement('label'); label.className = 'switch'; label.onclick = function(e) { e.stopPropagation(); }; 
            const input = document.createElement('input'); input.type = 'checkbox'; input.checked = isVisible;
            input.onchange = function() { if (this.checked && currentRealCardsCount >= 8) { alert('âš ï¸ æœ€å¤šåªèƒ½é¡¯ç¤º 8 å¼µå¡ç‰‡ï¼Œè«‹å…ˆéš±è—ä¸€å¼µï¼'); this.checked = false; return; } toggleCardVisibility(card.id); };
            const slider = document.createElement('span'); slider.className = 'slider';
            label.appendChild(input); label.appendChild(slider);
            item.innerHTML = `<div class="manage-info"><div class="manage-name">${card.name}</div><div class="manage-desc">${card.nickname}</div></div>`;
            item.appendChild(label); list.appendChild(item);
        });
        document.getElementById('manageModal').style.display = 'flex';
    }
    function toggleCardVisibility(cardId) {
        if (visibleCards.includes(cardId)) {
            visibleCards = visibleCards.filter(id => id !== cardId);
            const realCardsCount = visibleCards.filter(id => id !== 'add1').length;
            if (realCardsCount < 8 && !visibleCards.includes('add1')) visibleCards.push('add1');
        } else {
            visibleCards.push(cardId);
            if (visibleCards.includes('add1')) visibleCards = visibleCards.filter(id => id !== 'add1');
        }
        localStorage.setItem('visibleCards', JSON.stringify(visibleCards));
        openManageModal(); renderGrid(); 
    }

    function openQuickAdd(cardId) {
        const card = cards.find(c => c.id === cardId); 
        document.getElementById('modalTitle').innerText = card.name; 
        document.getElementById('modalSubtitle').innerText = card.note; 
        document.getElementById('cardIdInput').value = cardId; 
        history.pushState({modalOpen: true}, "", "#modal");
        
        // Hide all option blocks first
        ['pigRichOptions', 'greenCardOptions', 'uniOptions', 'happyOptions', 'hsbcOptions', 'ctbcOptions'].forEach(id => document.getElementById(id).style.display = 'none');
        
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('customDateInput').value = today;

        if (cardId === 'c6') { document.getElementById('pigRichOptions').style.display = 'block'; document.getElementById('checkBonus10').checked = true; document.getElementById('checkBonus25').checked = true; document.getElementById('checkIsBill').checked = false; document.getElementById('labelBaseRate').innerText = "ğŸ”° åŸºæœ¬å›é¥‹ 1% (ç„¡ä¸Šé™)"; }
        if (cardId === 'c2') { document.getElementById('greenCardOptions').style.display = 'block'; document.getElementById('checkGreenChannel').checked = false; document.getElementById('checkForeign').checked = false; }
        if (cardId === 'c7') { document.getElementById('uniOptions').style.display = 'block'; const now = new Date(); const hasUpTx = transactions.some(t => t.cardId === 'c7' && t.isUniUp && new Date(t.date) >= new Date(now.getFullYear(), now.getMonth(), 1)); document.getElementById('checkUniUp').checked = hasUpTx; document.getElementById('checkUniBonus').checked = false; }
        if (cardId === 'c8') { document.getElementById('happyOptions').style.display = 'block'; document.getElementById('checkHappyPet').checked = false; document.getElementById('checkHappyLife').checked = false; document.getElementById('checkHappyForeign').checked = false; document.getElementById('happyDashboard').style.display = 'block'; renderHappyDashboard(); } else { document.getElementById('happyDashboard').style.display = 'none'; }
        if (cardId === 'c9') { document.getElementById('hsbcOptions').style.display = 'block'; const savedTier = localStorage.getItem('hsbc_tier') || 'infinite'; document.querySelector(`input[name="hsbcTier"][value="${savedTier}"]`).checked = true; document.getElementById('checkHsbcForeign').checked = false; document.getElementById('hsbcInitialMiles').value = localStorage.getItem('hsbc_initial_miles') || ''; }
        
        // ä¸­ä¿¡ Uniopen åˆå§‹åŒ–
        if (cardId === 'c10') {
            document.getElementById('ctbcOptions').style.display = 'block';
            document.querySelector('input[name="ctbcScene"][value="normal"]').checked = true;
            toggleCtbcScene(); // é‡ç½®é¡¯ç¤º
            
            // è‡ªå‹•æƒææ­·å²ç´€éŒ„ä¸¦å‹¾é¸
            const now = new Date();
            const start = new Date(now.getFullYear(), now.getMonth(), 1);
            const historyBrands = new Set();
            transactions.filter(t => t.cardId === 'c10' && new Date(t.date) >= start)
                        .forEach(t => {
                            if (t.ctbcBrands && Array.isArray(t.ctbcBrands)) {
                                t.ctbcBrands.forEach(b => historyBrands.add(b));
                            }
                        });
            
            // æ›´æ–° UI
            document.querySelectorAll('.ctbc-brand').forEach(cb => {
                if (historyBrands.has(cb.value)) {
                    cb.checked = true;
                    // Visual cues for visited
                    cb.parentElement.classList.add('visited');
                } else {
                    cb.checked = false;
                    cb.parentElement.classList.remove('visited');
                }
            });
        }

        document.getElementById('liveRewardCalc').style.display = 'none';
        document.getElementById('liveRewardCalc').innerHTML = '';
        const parkingInfoDiv = document.getElementById('modalParkingInfo');
        if (card.parking) { parkingInfoDiv.innerHTML = card.parking; parkingInfoDiv.style.display = 'block'; } else { parkingInfoDiv.style.display = 'none'; }
        document.getElementById('transactionModal').style.display = 'flex'; 
        document.getElementById('amountInput').value = ''; 
        document.getElementById('noteInput').value = ''; 
        renderModalHistory(cardId);
        setTimeout(() => document.getElementById('amountInput').focus(), 100);
    }
    
    // æ¸²æŸ“æ­·å² (åŒ…å«æ–°å¡ç‰‡çš„ç‰¹æ®Šæ¨™ç±¤)
    function renderModalHistory(cardId) {
        const container = document.getElementById('modalHistoryList');
        container.innerHTML = '';
        const now = new Date();
        const cardTx = transactions.filter(t => t.cardId === cardId && new Date(t.date) >= new Date(now.getFullYear(), now.getMonth(), 1)).sort((a, b) => new Date(b.date) - new Date(a.date));
        if (cardTx.length === 0) { container.innerHTML = '<div style="text-align:center; color:#ccc; font-size:12px; margin-top:10px;">æœ¬æœˆå°šç„¡æ¶ˆè²»ç´€éŒ„</div>'; return; }
        
        cardTx.forEach(tx => {
            const item = document.createElement('div');
            item.className = 'history-item'; 
            item.style.background = 'white'; 
            item.style.borderBottom = '1px solid #f0f0f0';
            let noteText = tx.note || 'ä¸€èˆ¬æ¶ˆè²»';
            if (tx.isGreen) noteText = 'ğŸŒ¿ ' + noteText;
            if (tx.isForeign) noteText = 'âœˆï¸ ' + noteText;
            if (tx.isUniBonus) noteText = 'ğŸ”¥ ' + noteText;
            if (tx.isHappyPet) noteText = 'ğŸ¶ ' + noteText;
            if (tx.isHappyPeace) noteText = 'ğŸ½ï¸ ' + noteText;
            if (tx.isHappyLife) noteText = 'ğŸ›’ ' + noteText;
            if (tx.isHappyForeign) noteText = 'âœˆï¸ ' + noteText;
            if (tx.isHsbcForeign) noteText = 'âœˆï¸ ' + noteText;
            
            // ä¸­ä¿¡æ¨™ç±¤ (ä¿®æ­£åœ‹æ——)
            if (tx.cardId === 'c10') {
                if (tx.ctbcScene === 'foreign') noteText = 'âœˆï¸ ' + noteText;
                if (tx.ctbcScene === 'unified') noteText = 'ğŸª ' + noteText;
            }

            let amountDisplay = `$${tx.amount.toLocaleString()}`;
            if (cardId === 'c9') {
                const tier = localStorage.getItem('hsbc_tier') || 'infinite';
                let rate = 18; if (tier === 'infinite' && tx.isHsbcForeign) rate = 10; else if (tier === 'signature' && tx.isHsbcForeign) rate = 15;
                const miles = Math.floor(tx.amount / rate); amountDisplay = `${miles} å“©`;
            }
            const txDate = new Date(tx.date);
            const dateStr = `${txDate.getMonth()+1}/${txDate.getDate()}`;
            item.innerHTML = `<div><div class="h-name">${noteText}</div><div class="h-date">${dateStr}</div></div><div style="display:flex;align-items:center;"><span class="h-amount" style="margin-right:10px;">${amountDisplay}</span><div class="item-actions"><button class="btn-icon btn-edit" onclick="editTransaction(${tx.id})">âœ</button><button class="btn-icon btn-delete" onclick="deleteTransaction(${tx.id}, true)">âœ•</button></div></div>`;
            container.appendChild(item);
        });
    }

    function addTransaction(close = true) {
        const cardId = document.getElementById('cardIdInput').value;
        const amount = document.getElementById('amountInput').value;
        const note = document.getElementById('noteInput').value;
        const customDate = document.getElementById('customDateInput').value;
        if (!amount || amount <= 0) return alert('è«‹è¼¸å…¥é‡‘é¡');
        if (!customDate) return alert('è«‹é¸æ“‡æ—¥æœŸ');

        // æ”¶é›†æ‰€æœ‰é¸é …
        let options = {
            isGreen: document.getElementById('checkGreenChannel').checked,
            isForeign: document.getElementById('checkForeign').checked,
            isUniBonus: document.getElementById('checkUniBonus').checked,
            isUniUp: document.getElementById('checkUniUp').checked,
            isHappyPet: document.getElementById('checkHappyPet').checked,
            isHappyPeace: document.getElementById('checkHappyPeace').checked,
            isHappyLife: document.getElementById('checkHappyLife').checked,
            isHappyForeign: document.getElementById('checkHappyForeign').checked,
            isHsbcForeign: document.getElementById('checkHsbcForeign').checked,
            ctbcScene: document.querySelector('input[name="ctbcScene"]:checked') ? document.querySelector('input[name="ctbcScene"]:checked').value : null,
            isCtbcIcash: document.getElementById('checkCtbcIcash').checked,
            ctbcBrands: Array.from(document.querySelectorAll('.ctbc-brand:checked')).map(cb => cb.value)
        };

        const recordDate = new Date(customDate);
        const todayStr = new Date().toISOString().split('T')[0];
        if (customDate === todayStr) { const now = new Date(); recordDate.setHours(now.getHours(), now.getMinutes(), now.getSeconds()); } 
        else { recordDate.setHours(12, 0, 0); }

        transactions.push({ id: Date.now(), cardId: cardId, amount: parseFloat(amount), note: note, date: recordDate.toISOString(), ...options }); 
        localStorage.setItem('transactions', JSON.stringify(transactions)); 
        document.getElementById('amountInput').value = ''; document.getElementById('noteInput').value = ''; document.getElementById('liveRewardCalc').style.display = 'none';
        renderModalHistory(cardId); if(cardId === 'c8') renderHappyDashboard(); renderGrid(); if(close) closeModal();
    }
    
    function editTransaction(id) {
        const tx = transactions.find(t => t.id === id);
        if (!tx) return;
        document.getElementById('amountInput').value = tx.amount;
        document.getElementById('noteInput').value = tx.note;
        document.getElementById('customDateInput').value = new Date(tx.date).toISOString().split('T')[0];
        
        const cardId = tx.cardId;
        if (cardId === 'c2') { document.getElementById('checkGreenChannel').checked = tx.isGreen || false; document.getElementById('checkForeign').checked = tx.isForeign || false; }
        else if (cardId === 'c7') { document.getElementById('checkUniBonus').checked = tx.isUniBonus || false; }
        else if (cardId === 'c8') { document.getElementById('checkHappyPet').checked = tx.isHappyPet || false; document.getElementById('checkHappyPeace').checked = tx.isHappyPeace || false; document.getElementById('checkHappyLife').checked = tx.isHappyLife || false; document.getElementById('checkHappyForeign').checked = tx.isHappyForeign || false; }
        else if (cardId === 'c9') { document.getElementById('checkHsbcForeign').checked = tx.isHsbcForeign || false; }
        else if (cardId === 'c10') {
            if (tx.ctbcScene) {
                document.querySelector(`input[name="ctbcScene"][value="${tx.ctbcScene}"]`).checked = true;
                toggleCtbcScene(); // è§¸ç™¼ UI æ›´æ–°
            }
            document.getElementById('checkCtbcIcash').checked = tx.isCtbcIcash || false;
            // å›å¡«å“ç‰Œå‹¾é¸
            // å…ˆæ¸…é™¤æ‰€æœ‰ (å·²è¸©) æ¨™è¨˜
            document.querySelectorAll('.ctbc-brand').forEach(cb => {
                cb.checked = false;
                cb.parentElement.classList.remove('visited');
            });
            
            // é‡æ–°è®€å–æ­·å² (æ’é™¤é€™ä¸€ç­†ï¼Œå› ç‚ºè¦ç·¨è¼¯)
            const now = new Date();
            const start = new Date(now.getFullYear(), now.getMonth(), 1);
            const historyBrands = new Set();
            transactions.filter(t => t.id !== id && t.cardId === 'c10' && new Date(t.date) >= start)
                        .forEach(t => {
                            if (t.ctbcBrands && Array.isArray(t.ctbcBrands)) {
                                t.ctbcBrands.forEach(b => historyBrands.add(b));
                            }
                        });
            
            // æ¨™è¨˜æ­·å²
            document.querySelectorAll('.ctbc-brand').forEach(cb => {
                if (historyBrands.has(cb.value)) {
                    cb.checked = true;
                    cb.parentElement.classList.add('visited');
                }
            });

            // å‹¾é¸ç•¶å‰ç·¨è¼¯çš„å“ç‰Œ
            if (tx.ctbcBrands && Array.isArray(tx.ctbcBrands)) {
                tx.ctbcBrands.forEach(b => {
                    const el = document.querySelector(`.ctbc-brand[value="${b}"]`);
                    if(el) el.checked = true;
                });
            }
        }
        deleteTransaction(id, true);
        updateRewardPreview();
    }

    function deleteTransaction(id, fromModal = false) {
        if(fromModal || confirm('åˆªé™¤æ­¤ç­†ç´€éŒ„ï¼Ÿ')) {
            transactions = transactions.filter(t => t.id !== id);
            localStorage.setItem('transactions', JSON.stringify(transactions));
            renderGrid(); 
            if (fromModal) { const cardId = document.getElementById('cardIdInput').value; renderModalHistory(cardId); if(cardId === 'c8') renderHappyDashboard(); }
        }
    }
    // ... (å…¶é¤˜å‡½å¼ï¼šresetAllData, exportData, importFile... ä¿æŒä¸è®Š) ...
    function resetAllData() { if(confirm('âš ï¸ ç¢ºå®šæ¸…ç©ºï¼Ÿ')) { localStorage.clear(); transactions = []; renderGrid(); } }
    async function exportData() {
        const dataStr = JSON.stringify(transactions);
        const now = new Date();
        const fileName = `backup_${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}.json`;
        const file = new File([dataStr], fileName, { type: "application/json" });
        if (navigator.share && navigator.canShare({ files: [file] })) { try { await navigator.share({ files: [file] }); return; } catch (error) { if (error.name === 'AbortError') return; } }
        const blob = new Blob([dataStr], {type: "application/json"}); const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = fileName; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
    }
    function triggerImport() { document.getElementById('fileInput').click(); }
    function importFile(input) {
        const file = input.files[0]; if (!file) return; const reader = new FileReader();
        reader.onload = function(e) { try { const json = JSON.parse(e.target.result); if (Array.isArray(json)) { transactions = json; localStorage.setItem('transactions', JSON.stringify(transactions)); alert('âœ… å‚™ä»½é‚„åŸæˆåŠŸï¼(é é¢å°‡è‡ªå‹•é‡æ•´)'); location.reload(); } else { alert('âŒ æª”æ¡ˆå…§å®¹æ ¼å¼éŒ¯èª¤'); } } catch (err) { alert('âŒ ç„¡æ³•è®€å–æª”æ¡ˆï¼Œè«‹ç¢ºèªæ˜¯å¦ç‚ºæ­£ç¢ºçš„å‚™ä»½æª”'); } }; reader.readAsText(file); input.value = '';
    }
    function showDonateModal() { document.getElementById('donateModal').style.display = 'flex'; }
    function copyBankInfo() { navigator.clipboard.writeText("396901798704").then(() => { alert("âœ… å¸³è™Ÿå·²è¤‡è£½ï¼(éŠ€è¡Œä»£ç¢¼ 396)"); }); }
    function checkUrgentTasks() {
        const alertArea = document.getElementById('urgent-alert-area'), alertList = document.getElementById('urgent-list'); alertList.innerHTML = ''; let hasUrgent = false;
        cards.forEach(card => {
            if (card.type === 'placeholder') return;
            const stats = calculateStats(card.id); let target = card.type === 'floor' ? card.target : (card.type === 'mixed' ? card.minSpend : 0);
            if (target > 0 && stats.spend < target) {
                const end = new Date(new Date().getFullYear(), new Date().getMonth() + 1, 0), diff = Math.ceil((end - new Date()) / 86400000);
                if (diff <= 3 && diff >= 0) { hasUrgent = true; alertList.innerHTML += `<div class="urgent-item">${card.name} ç¼º $${(target - stats.spend).toLocaleString()} (å‰© ${diff} å¤©)</div>`; }
            }
        });
        alertArea.style.display = hasUrgent ? 'block' : 'none';
    }
    // ... (å…¶é¤˜è¼”åŠ©å‡½å¼) ...
    function closeModal() { history.back(); }
    function renderHappyDashboard() {
        const dashboard = document.getElementById('happyDashboard');
        const startDate = new Date(new Date().getFullYear(), new Date().getMonth(), 1); 
        const txs = transactions.filter(t => t.cardId === 'c8' && new Date(t.date) >= startDate);
        const petSpend = txs.filter(t => t.isHappyPet).reduce((sum, t) => sum + t.amount, 0);
        const peaceSpend = txs.filter(t => t.isHappyPeace).reduce((sum, t) => sum + t.amount, 0);
        const lifeSpend = txs.filter(t => t.isHappyLife).reduce((sum, t) => sum + t.amount, 0);
        const totalSpend = txs.reduce((sum, t) => sum + t.amount, 0);
        const createBar = (label, current, max) => {
            const percent = Math.min((current / max) * 100, 100);
            const isDanger = percent >= 100;
            return `<div class="dash-row"><div class="dash-label"><span>${label}</span><span style="color:${isDanger ? 'red' : '#555'}">$${current.toLocaleString()} / ${max.toLocaleString()}</span></div><div class="dash-bar-bg"><div class="dash-bar-fill ${isDanger ? 'danger' : ''}" style="width: ${percent}%"></div></div></div>`;
        };
        dashboard.innerHTML = createBar('ğŸ¶ å¯µç‰©é¡åº¦', petSpend, 5263) + createBar('ğŸ½ï¸ å®‰å¿ƒåˆ·é¡åº¦', peaceSpend, 5714) + createBar('ğŸ›’ ç”Ÿæ´»é¡åº¦', lifeSpend, 5714) + createBar('ğŸ’° æ»¿é¡é–€æª»', totalSpend, 26000);
    }

    updateDate(); renderGrid();
</script>
</body>
</html>
